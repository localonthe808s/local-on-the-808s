<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BLUISH</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,100;1,6..96,400&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,100;1,6..96,400&display=swap" rel="stylesheet"></noscript>
<style>
@font-face {
  font-family: "QelliaRegular";
  src: url('data:font/woff2;base64,d09GMk9UVE8AAHkwAAwAAAAAvTgAAHjfAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADYKIWRpYG8JWHJEUBmAAhzwBNgIkA44YBAYFhBIHIBtgvAdUL2XOUT0AAKT7PYxI0erhiNSkH2aqqh4Swk1VA/7w0y+//fHXP//53z9Ch895/w+e+ZW0TjKw74xuBw9Wxw6m75fLP6VfxA+XNTlGyJpWdN6ETBK6LPQTqP082ea/6zozOJNMIpshMJs7g1hjQewF1Ig9SJEuKEURZNkFaUtpS+kLCMgCglJFEZZqrdixYEtEY0zXnOFf8p8PT9vqfRCQGcVEpCWtACNzKxMEe9mIjPGOjZ/ndfOhkPfo+Tb95RrrT/5N2I6FbsSBE60bHKu4WYqLkIijhjVEVp4tYwuCC+dDfAqujdit4Ci2uEY9N71Y70WnfyfJhugIWdOY8hp+56RrriHznPz679Nmr2P3bNj8JZCW5sG6O1uVwSqqq64Dofl+fc309S5rSTCLlmTJzEGWHLyb6Jaac+jUATpnAniiMfLfPYWgA2T6gR8wdUC11fAPz6+tc98fakiJnBlHjMJCLMCIwqgAMasxsmbLZaPy/71Ns3270t0ASQ4QFx1UVKZoMn2mj/+Xaf/amllJzuTLPlgFVwqtrEuyJtog0EqyJysr8CXrJpKO9nRBqACpIijq9BVin+qKqsn04aIMPN/b9G33aK2fF6QOsCkBmzJN6dz3djW08kTkiaSQif7/goDt8XAIUemS1SeAOlACQJ9UlVPXKdOljn2p+rY4nQLwHWE65x9S0cgaTm8XtZuG3DuABB4eIVCSv6kTf8x0igBIzYCkY+7d5cDOMXZW0bloKpfuCx+ymU1FX32roDWCFHkSiN9tm8z0lTEXcSjvqsQh/gnbgMbVb/6+d8/k9tq+XWSRIrIESSWEEIYwDEMIsljvV8uKIASIqFX2eL2tGkdX8bTo6m3c6ecv5LE//sGP/3b4CfQT+Uce+W3Y2QXs+vfaJY9dXF5xuRppLp+RxiZX9wrZ4DkBghk0yAF5wQcCIQyiwQ1JkA6FoQSUg8pQA+pCI/BAa2gPnaEXDIQRMA6mwCxYAMtgDWyCHbAfjsEFuAUP4Bm8gU/wEwFN6MQ86IshGIVuTMFCWALLYRWshQ2xOXqxE/bEATgWZ+ECXIZrcQvuwgN4DM/gJbyB9/EZvsYP+JespFMu8qMIiqdkyqISVJFqUTNqT52pNw2goTSaptFCWk1baTcdpDN0nR7Sa/rGyArb2OA8nI9dHMpuzuQiXILLcRWuzy3Zy524B/fjITyeZ/ECXsZreBPv5iN8nm/xA37O7/gr/xEQkzgll/hIsERJAUmVTCksxaSklJHyUkmqSg2pL42kqbSUttJBOks36Sl9pL8MkqEyQkbLOJkoU2S6zJK5skAWyzJZKWtkvWySrbJDdss+OShH5LickrNyQS7LNbkpd+S+PJKn8kJeyzv5KF/ku/ySvwoorKhKHp55L7033nvvk/fV++H99v55Fe/cE552StRqtZpTolarRX4FpQ0rKG1UQWlZBaWNKyN+wA/5ET/mp+7Fk1RfTYQTwiPPeeJ3vJaZMzqeWM0g9PfIjVZ4He4nhm4Jx0sMkTtLvDwkAaMVJ7bIlorMj0irLbJUW+ScFCm7JcwLoWcyiJLkBMVdU280Vt7miIiCuEcB8SZvszP0dKfHQeTS9VMMVp5wGjWRSzLfplMevK32i6czJzYlLuIR9fBxLAqncjRuL9FZ/YWso9CZiLztzsjTXRObIZttpHwm2z+IJeJh2KJbqQ6NULmbbuUw/K24L+QsOHl8dp/RYKuP1Khp1Hsv9r7dzyGg0oo9WkollSX9dyhzQ2jJfIbhzY3R9+O6UhhU2pKgVnmZFbPHxo1GG3JhuNtnku750h3G7uZLwlKR0LNusJsu/3APRu58qRtu0hWraMMEzcgKmZJ4xmdzYs3uaCyuxx5016PUdrkhUhJVKvg01Vam2i4Og+hn3WY3XTkKbRM0h6HjkXhYDDHRHe+iu/sIP84N3tLdkBxnCLkjPRynggyVorxb6E596B6uSZqgDXyda0U7fLEzOwnFabtGohg23nBKhZRYTsTDv1W6Jcp73k6DWN20CRoOCYeCg+Kw52AJEoKCQDkl6rVGN4PrDLIMMhBTjRSQCCjE9YXtNHAN2gCagcMAQQoaygt5sPBQQlGCHQyyW4MQWAgxA5/NYQZzWMPRhR/HwGKIhxAMIRoAgxiGMIEZLBe9nsJoCtNFH84gmEEEDGIYwgSmMIPlhaznMF9AuIDBYNE8VKzWsHi1hiUmV7UaDevUaVi4hqdT51bt2/m5Y+Li4uqFNa0X7o5zu/3KN+7UpVU7v7KNB2k3aRXjV9jr9avSqkXLLp39qng6ezp18zSL+aUd4Of6JsHvxnM6VibID34QAtGQBMWgIrSG7jAQhsM4WAV74CichWtwF57Ca0Q00IUhmIqFsSSWxxbYDrvgCtyC5/AB/iAgG2UnFwVRDCVRISpNlak2NSQPdaFBdIb+sz9HcFFuwE24Bw/gSTyH1/BePsk3+SG/EBCr5BZfKSgZUlnqSTPxShfpL2NkuiySHfJUfitmJVRpqLRT+itDlXHKImW1sl45o1xSbivvlX+qWc2lBqnpaim1utpEbaN2V4eqE9TZ6mJ1s7pXPayeUa+qD9W36lf1r8lsijP1ML02p5o95rHmGeZbFpMlpyXZMsgyx3Le6rSWtra3jrCett603rX52ErZOto22HbZ7tge2P7Zg+2F7VXtbewL7Uft3x2Kw+0o6+joGOXY4jjruOX46fR1FnXWdzZyDnKOd25wnnK+dn7Wsmt+WqhWQmumddKGaAu03dph7Yz2WPul2/UAPVQvqBfVy+q1dK8+QJ+iL9c36of1s/o9/aX+wzAbeYwwI8ZINooYlY3qRlOj4+7hY2LHZI4pGXN0zKkx58bcHvNszLsx/4z5nylj+q3pONMZpotN15puNXU29THdb3rQNMk0x7TUtNb0hGmP6RXTe6bP1EO2GhnDFSRdvZ+TqytMzLVIzIlLTU4wYdVSkIY5Vb41QGS4u+07EcFywKBovbZEZLlovbYEGCR8OjAB5YBDMhkQsdVbYBKKihPKlYbyYoOYqaViddqEaGVMbF6eVmSKMguLSpT6gqREvcgMf0O5p9m4qgTGoB6y1TD52ti8aCXDJWbkOV5QXsg/k5chasnEtMR97kqPhLo8ncj+ibrCMpe488MKyi3NxlUlMG5pNq4/oE6eoTozB7uqBAbb4nF4NnZmDGq4AzOZruy794RukiELYR/BAAF/cSCQ49AkhAVwI2cja8RcvZ+bqytMzLVIyIlLTUlgKOs4oic0fUYAz1DuaTauP6AOnuGu3s/J1RUm5lok5sSlJie4LzRn/91zHNYbGSNojHKmAFusEpm4sPDAEH5fVWhd8+GGhpOBJ6OOCRAsuRCM0QN0ij+ZsIiDapGV34xDczeI8bGJsSmxJvAxhlsWutR+aSbqJH8KXtY3VYlHTxuLzbDZh7EwerD/+s/1InMJ7XywaJvzbm8/gXGtShvs5IGjmjeh3JOnRexHuaXZuKoEhuwKy1ziHouGFZRbmo2rSmCB5fTh1XtVfFRcbKQ6tuJwaenR/DKB4WCxHi8m2SMGNezXS9uLupgt6cXSDn0nE1YeXlVVfriSScgoljw1txiVAFaka1XaIIPHY1MQYD1z+HjdOb4p/BDz4TOYgdm0z8z5lqwLyns3GPWQrca0z8hUCdiKZDR1alkdA8ExxUOrimUVnVJXKGIOphdJDnpZYQf81IoYvbxiyJbrUmXauPP4LIW/uoZp+A6s7sFIMBfgDNWZ8ba7SsAyskuVOdONx2cpPPpHLMPmeNS2Z/8K8I7qyBzsqhKYd7CKU9drTxn5D9f7+5vqo0OrhVn4MufhX35MJYIzZBG1e8s8nPlp9suWCe7DX3KM/CBa8d9Czrr00/ECsftoX905ZU97es8Rsckf4U3/2RJMD8q+e09wR8wGFCXCvKhB8IItShgPpljA62EMYsw80Y1jCx1EvICagWAB9Xjng0XbnHd7+wlMzE3E3PXMLdh6mchNTsxMUiYmpiUli1u3MBJP+qD5JKM6HFFZVV5eVRlRrgoLjwgTmG4SvlqCcuYgpic0fbEbj60pt6LuZV2znDGQqmi6fOa8zoShOjMGu6oEPJbsYDZAh7k99fFxRUGmwJBgjjArMC/wVT6Y5XZW6QY7eImkajMqM8sFyBv2JhjgzAIlYBzwkWKINA7q4aOeyfe/OVYJLB5B7NbX4K9WKsGcxH5DtoQLybisTf5Budk3hSniZi8dBDpO/C2+B6yAUf70hAlKL4ILeuCLuhlTvT75cHg7w8PIBe2TBIZqqrh8+rySEeDN8AUiOzE/moGk9OKhmXmyoW9qEHN/KpJBqVF+HDEdcvjHzAlpXRCzf31eV2FmSYFePNFDhNS3RhmVZxHzDOEDv3GJ6KrLy/4O47EqwTunObBNWUi6VqUNdvKwmvpnebP1GjfP0HCBkfUtRjDPbCV6Oh/hGZRbmo2rSmDIrrDMJe78sIJ6gpitK8rvP3l+uiBHPNaV16m8einGHrN4VMBc8QBUckzYkeNRdco7DWcaS0TwkHSGM8dfn6+0wDKyOirVce/iCTjXfCIkEsE3Ek5U8aVZhSUFArYiGXgNJzjXiL0J7spcRDCPP/z9ednrKTnihZrms9eCEKOR/f47YpTYRIvHrxQZyjqO6AlNX+zGY2vKLc3GVSUwT1FXWOYSd57hfkMMLOSSy1MO6w6b/B7fA5bAKPsvrVt3RByPWR8G5Gg+yXAwFlUrO44yLZknei8rX7S6zBb9qYhIG+AQg798FHD8It/fd7V/4PQWhurKvndNePoRMZxdzoWFA0r44tDnP0XmrTHrdSHvQboFT3cUGBGPG27EMpBewwMCR5IwevjrJbiHWa4FWyouzSYyC7HKtDSdTidq1YROx4g5fWR+Wn5ynjCwhclHxl+vgZWSmchje8o9zcZVJTAbUKQI86IHwQu2KBkIzlc3qYc2a2TMxu1Rbh4ifCflMAuMkwTsSDJKu83nnuwXdcX5hw8dNrnEACFd4rqy711lhhXwFWIyMjIz+UxdJpOvblIPbdaYMjASiIvA/LK+fDVjrDTBVmRDZHagjoGP8IZ7RTLKbc67vf1EhoRNQ7YEpsn3TPu+JsXQWQekGDaEI8X/nVUhxbAhOPxHVzt+0c9hN4qR4O2R5K9kQESmfXrpS73CdTdS7L2GFGWdmYNdVQKWkR3q7IWe/PA3VEBaSKpGwG+lK0RqblJhPq8vzi3MEbCM7FBnL/TkpyCGKywrKmxRnmnTHGgUw+prtQ3Ka5dbzxSKERovvx1Kf1VJaaio6NtfvvfwzkyT6Chdaoyozy8qLNabwBKYDHPBEZzxOJiNbWcivB2+wzNheYJ4MDo8XJ0QnRyZEZdhEp+YEB+fl1iQlZWemSWyZtXDaz6dOmPo+em28mIuRt4iphYgoChdE3G2smuwT3ktY82H63okKGfZus3fGiKciw/7aY1ynduy7SEi8PMRk145NENjClcXIQ/QKfrh4xqEA32R4v1SlBucuT+Yb6Rb7NbGfPXZmuxgPya9rNAIaUZ5GGLABFUM2XFdqnwfiR1ctD147fJzCyJIsPsEG2AezLUCe2wn2v63mNuYcuajCGvBRo9tYE8yYtvl8FKq5ZrjNDD6hvJ66mT/BNETzyGiJnE/4zaipwwdtPJLSEODqIdkmhBOluyJpMK4Mj3PyCuwlotAZ9XHlxucgcOXzSN9iEV7HbCwQqnaX1IRITJUY+aRLEMwSuTjYpLikgWQkUl7OpJIG4RlxeDzijmNTh8uL0GBul3aBdbudgH2i0JWmsBRqpPBMRw28Z8/EZsrsxFQf8/Bio4MNPPsBOVMhJ1gHJ4Dtv/+cuntZTE7NzM/n79CsZVyabLZ1d6nv310frppk9OSKd+ffoVwKbzgrvY++/jR+emmTc5LpkzpXXxVzB3lsqv/l19a+3t6WpdNn75rmYvIyPqMEmOUw1o9LRtJE5IR1gwtzoKyTGon+fVMRn63moEkwgZhKzJXV3swiNclJUfrdNhv+AdzRnasFfxOySvuclfQgm1Oa1c8DL0YIv6BGJDMXKrT33byQFAfoeA8TOosBIR2Yn4KLjDHBCSvhUnHC3OzLLAVWZDamXAdK2EMrjTHJpSbbvbOUIFZbFBLnsWyPiN4GRHTijYwFDhFEQqDvqCgqCiuIFYnKs7iHVGHwInQxxfExsbHxWYICsMhvAPvOEQozsZmxMXH8rEF8XpBYQCnQwTTIYfIQDQD04Xi9wUueCxmlPGxHNAbEabx6GljsRluoQmip106YPbXrSvw+2FjpFVcqaG3rEn5qQ+PxNMWqK3wiEU73rRFij3DiPM0JD3q4eEApSnsnvq3Er4+8dcr2DDtH2yywzk0IV5sxlAaVc8zaw+8JfYjY+0uT9HYQLSqfKvdStHTGMTIOxEjTYdp3H20pneR8pjoYP91hjI5NSmOeItKM4nmgPRl+/jhKVlb5R3qc3abso4jGNhq5o0gloxLs4mcyGP7BYjF6B8I1DikeD8JKf7EAriRXYwcbvuNlA7dQcOHyJLt+jOzM1Tp6+sv33SaVK2Gr73wLN4jbZYrc/kavOvgwRJb3wq+LdxrarlQ9FjPGDYjeLMMnedJcVTzJpTT2ub9ffvnwMCfl/ef9WwUXw/sq/rhe6IiaI/eVzlx4cKJDlU7WwJEH2ciOiIxaj+vc60N7k0xYSan6yVHvaxBD6euIwYPuqjvDsj0L+S1tlxdeUvdOb4pvFSliohQqcojqgoLs3PzhATfII0mxoTlwBtbEyUUdoDx4ADjiRIKe2NrgqHc02xcVQKsx9u4OnsUpoqICFOVR/jl1C0ya883ji1sMabGyCvwGm5bl9f5fwrhm3eCTqqxjmsJXAvu/PC31IJEPHKdg/Zma5nA/IvePrNtWH9M3Fy7rewK33uy7eKFBiAQE4fmbRDjYxJ5ikPJSCRVP/2ooxi93GAGD2Gklly58kCogGeQoJe8CXwRj9STjx5WVwsgkAznFHX2V/EP6haMuHChtyPE66hwcV4cRjO2mIT6BmamKPEShgNb+AJhW7wGj8ezsTN2gvF4DqwRmT7EwhxuYZJ7mFZIiIpM9VNiK08YC1++MHyCEc/PzvEqFZlzFHyVjy1WibkvEMPti9i9z4H3PxxVVVVeXlkVUa6Ki0tJShTyTxyrqCg2Ybi6wy115/jG8FIVWKGsvDwhwTdIo4k2YeqlPk5VHlFVVV5eVRVRrlJFRKgE+Ha4j3OtShvs4JnloUs3LH2OmPoLNl9/X8KIf2DDK9+/8Nfjd07VxImSnGJeo8yCKDFMn9QxwDPPkW3vQiXja78pXNgS4Xwg0MWkB5/jMrAwf1AXn3d1FwnM2tadwC4XQZzb7LaSt5rhs2bt1EtgmZuem5HbRU1RJbiijSkfOkWGxzaURwAKdBBBU0N+q2DgzFvOzd99r4NyvVvbzUeXjpw7JHYUnS9uLDdhlDNXvoPRcaIWvr717/v8h3l9W+rmNNWYP9rD+CO84b9FBDMHDW8jQYaY5tyqY818e9BxD3f/PR5CJVlX0tEuMEuuirmjXHY9/vBL6+Oentbl06ftWu4iMvAtghEGqwX4S088Flv5RTJcPoW9wZqIpsABj8cOeDwRTTFw+x1i9gKN9oeHBe2PNNQwKxJmrrbn16Hr+qv9+QLzDwK//2wJhrKOJ4oqixsIiOH0ZAmwRFFGfKFWGVvLpigyFXE7fx2vxF/7TpiHN8CIcfClyDRolyjm9pH5qfnJecLAVpuzDMcR2asQm24GpghPxeNFJjT8cHX14cdZw0NDwwWxEkw/9TMH3yDmatCV/Zv4jZt8Hba5GtvjBAY6UfXw/0hGiUdPrfq4Xz0imx43qGRBxsE+IolcxeDZUglxXBsCXz1UYnOS4bY27bx55eTpi6cDWlyKBWYeB3LEeDedC7qqvP26mbE+z/7xTCHeR+SQDwrAAr4SzjEwGrEh0gRswXddv2Z4PB4DAqyPFGEe4xySJzQeJSqi951crGQEbEV2qTJt3PgAKpoxWCGo1pg2DHgYmUGDeshOI2uMPx0YCo+Knb94YcS7K2UCw++tCT7eXFPbJGhJplivLynW6mOitdoYBsbDHHACZzweZjPk5sptr/zPzm0PMzJvmvtmjLrnZKVd83sDzes6p/PeY6uP7Z+joItXlS04LTmwbdeJ4/R8pT1qbpi9k71ESjMU42BX2Svt+QF08LJ28ZIOpoha1sIBU4b16CPtWn1kpZIe2m6CY8rwkk4Fklx62ahFQ4eOHDlUIRDunH/k2QMpff4wHSZPI5pndz1r5zMys4LOiS7LTTN6N9fzaGbY+DnMMxvzdg5dz1RO6z1K0lQjthNu/cxNk2mJPZQHZaFvV98vGd7840H1CPq/TM54rv1Vbku43nJ0/lbFvFnzZtFDR40aOqye/d81aF7nUSc3KKdzBYTMICCAGsQEaAgxAzqQakAPYgF8QayAH0gN4A9SCwSA1AGBIPVAECENQAiLNBKEEzILMHCJDYgjSAOZDaQTMgfIJGQukM0h84BCNpkPlFJw44MFdAR8gDEAl0AFdAdmgSwAOgNdASdAAfAJ5IASaAu0BxKAJMAFcAaSgZ4AGxhLQAMdgGnAeGAosBSYAvQh6A2MBGYAU4FJwExgMlAPOAATAFcgEWgHpADrgJXAaqAHMBtkIWACBgACgAN0AiYCa4AFwCpASpAKOAK9gBHAMILRQBegFrABK4C1wHxgEbAcGAVUA4sJBhMMBJYBC4HpwCZgPQubCXYC21jYC+xiYR9wCNhPcBg4CBwBTgBHWTgFnAROA+eBMwQXgXPABeAacJmFW8B1Fm4D94E7BA+Ae8BD4CnwiIVnLLIoG4NAXgViLmAGtgLzAAvQAFiBRqAGqAMugeUONIHl4YV+YAUA/cEKTCKnWCBggws+nJCAjfhAnElHYiIPSDMridWOtYn1lZ3HLmMvYC9mX2E/cPByMDikO3RzMDnYHJY5POLIOD04/TmbOGe5hEtxs7gtuWbuB14EL5KXwMvhbee95X13lDrqHPMdJzsu5HP4XvxIfn/+dP55/nX+R/53iqJyqY7UAeoEdYF6S32l5XQyvYU+Rr93inaqcprl9NNZ6zzN+a1AK6gVfHJRuBS71Lncd/niOtAt2u2Mu9h9lYeLxyyP9R4nPYlnomdHz8meL4XZws7C8UKLsEa4UbhNeEB4QXjbq8qrk1eT11Kv416MiCcSimJEHUVDRCtEZ0Q3Rc9EX0Tfvdt7D/We7j3Xe4P3XnGkhC0pkOyTXJWGS1OlJdKO0j+yEFm8rL/MKlsoOyt7LPsss8sj5BnyLHlbuUW+QH5F/keRqhiieKhMVG5QnvEx+gzzqfNZ5nNN5aBSqvqqpqosqibVAtUm1WXVX7VanaJurx6jnqGuUc9Sr1f/03A1zhpPTYymQFOu6aDprRmmWaDZodmvOa65onmoeal11UZph2nHaadprdql2o3aHdr92qs6rs5Z56mT6hJ0RbpKXSddP90o3WLdat1e3VHdDd1z3U+9Su+vD9fH6lP1Zfou+mn6efpD+qv6z/rfvq6+0b6rfHf7nvK96fvWr8Rvqd9Wv4N+f/0N/rn+Lf07+vf2fxrgHiAJ0AYYAnICigOqAoYHjA94HagNLAgsD2wT2DlwZOCBwCuBL4MygqYHzQ3aGLQjaH/QjaB3wW2Dz4e4hVSGHAh5E+oeWhH6KkwblhS2LGxH2K6wQ2GnwprDBeGB4cnhReEDwxvCV4TvCD8VkRzRKmJQxOSI9RG/DHyDwhBjKDL0MUww1BnmGBYbjhvlxnbGAcb5xmXGtcYtxt3GQ8aTxofG78b/I1mRV6NCouZHLYy6G+0ZbY3+E9M75mdsu9hFcVRcedzF+OD4xvgj8S8SxAkTE34lFiWaEl8nJSf1T1qbdCfZMbky+WqKa0pqyrBUz9S+qU/SgtOGpD1Kr0ivS9+efjUjKONUZtvM1ZkPsnyyBmaty3qeLcsemxOfczTnaa4oNzd3XO61PE2eKe96/uT8UwX6grCCxIIRBesK7hZyCyMK+xYeKnIsGlg0t+hmcUrx5OJfJewSQYmxZFzJ2lLf0nGl38o6lf0tP1gxoMJcsariakVzZeRWwe/OAntPgb2nYIWaYp4yW4VtR/Wd0l5aL+ek/IkVhsz/sblJuX/1lbVHpX212Gs+13ewmTPNbGH9iLqRIyQ9RvXqXFp5bO9gxUvmld+74yJGsGWWcjcTs6pwX+8zg8XrJqybvHL86rGN4xv6OvZtWJCQJmVE3MnL+zD84SsGru9q6zrLceeCRXt2ShbPWDxtkSKIOc1pxbUX/snkCLaqqSu7mal72Ey27by8eZ9wX+3Vs3tWm6ctUhwZvSanpaSoW37RKAXbmHlIs7dQS/328KGY9dyfY+QCJnYi1fyR6dfJ37kYqjPfqY2Tyb6ZYQst5upqi9k23NtksZqtUqvVYrUobS2pJTaOxSY3j6QG99dkMVXLq81m6Q1KrIKPA/HyOxlPCVFQp18UsB99bZDPsv8Vmi3VFrPCNpwTvs0Cs2ExWE1MFsUIG8dstliUE5Zw9gRm683masnwiRyT2WwySUwWk9WsEPRdYqQ8nrSjGAVXI/e44iv3eGJXHKPs/0bIBX2TMchuDhlCMcn9Psuba2Wctyg+3qT8ud1NjH+4MSXiNWo2go4CbtOlNJ52paLTseLFgnSsiBYcLGl2a+QwTdzKl5ZcF5OeZyNrxG4xqIdsQ+hzIZ8I2Va2NUBkProkHv92yq09FJ+FsHx1lbpBPbRZI+tdzPOfU07bErO3pGjFuXsW2lstoH952XH/slhqdSs+X2cigo/WQnVkvOuuEvBj0n8hGtVDWzQy6X67/BD6dNxpW5aY6UAsyMImM7FcicdjUxCZRzl6ELyVD3tP/T273YyEQsZLaPj2zqPXT8UPNPv7iQZ0NPt7DmV6s5E+R13IfNopQDzZmblku+hgnQiFTgfFjHfpoCgRuqj2zOddlUCiNMy6CTiedEsDtkRsnEw3RR7ymHuGXkOziccOeVRH5ruuLagjLHuRB48rLOnz+XSaLj2b+fRoBi2RkaHTiez0inbsgSDPQH+Oa5SDPp/WFQtdhtfccPywKgWBD9UZRXerMmzceOwDI1G/wZWGWwIPuQ5lDu7VJV4rVxAvG5hvYPp6Lj/Q33+Pf1HP9VTn9XfzEuGFdhw/yu1vlLCcZiGjCoEVOZaWiMl0L9XUidGlVdGdYVlL3PkpiH1ssES7kUQeQ1MQm4PgvQvSF3NOnyWyif3zIPxS8jQ5CD7EcLCmuzxmDbY9SBhsRW0xh7fYgBfMKxFhfSlI2CZgvBK2DGIvPC9KxOujsCkW8Hgl62GwRHWNREh94PiGS+Qj/Rt9N3Kpc/wYFOye1lj6D+r6u84LJcJTw6X2n4MQdiQrn9zYUhqPml2BSukgeMZl6DLSdbxenZmam56ZZXHk5lmZ6bmpmRb/0mlZSelpqRbanv0UdDpBrU1NS0/KSrPYOLysAmVUEKymfUbQGnd1KN4XoI6jaUkVwi6a9dHn6AeiXiOrPgm9bfJztOwhZaxMFnLJYphP1Ho6HnJSzpqyZXI/SiIr8KdZiLEXsW8K1UNbJtDyCuXgnmLpmXLB+GF0lcDWWNEQZdZDivfPhV6ahSSDJeoRPnnWwxbcE2jrFZbYzp2v9YlmSdm7C/pgwn2YZn4fT7mLJ/rEJaVYwCQyLtutYC1Mmg5u5k9haR9MMhYAQpsxvwQvNV8NM+xgUkuhuNI2Ea6Z/YmDzZfiBbZ4gkdcfIrFaQb6jFBcKh+EjKfAAZexZLswna8zvb+nCnS5Yw5zOmBLhMbJtFGds9DzDH0AsWcNliiAZrcYrJAAXXT/5E1jnfA1Kv7sl77gWjLlQY2cbH0c/cfvF3m3lhI0Z1Ng+3OoeD+WbqJCNZpQMVoXib/CJv0SCRR/XiwFsvExPzinavka5ZqXTeFbNbK7c2kg4ZVYYaWyihbClMyspTNcjyrd3uU4ze41qKW9GlkneseCSiyiQSKPtN7TT/P6vdvmFuSZP9qzpndREM1G7+O0yabZoFlIpkIXgzw0vgFPub6Kszf71WQ1zXjVbalYpXlqY2ZD3jET+M/Px9Rp+nFFQVYcHQ4r/u6k/bfROpuDE3m8wZJmHXC2ukkNqg53mC4t0piWtUNj+74mxQsHpD7cG8VvV2fbsF+JGan4/SwKDv9RwWSloPitGIneHkn+SjbeoB7y17QjeDEfDU+xpFnDOPrJgGn9gIdR8ec9JJRdL55QvO9tyZLF3jhXXace0mieDMhgu1EO02/S2OK/OG5bl7c40aaIAyPQ8LfUwkQsFyTGYhMm0VBdRgOPRI2DZqiVeZY0G7/O0hD6FHXh1h3L93iiX1xyigVYkXHZroXTYeIc+M4cdoMdsYrEQbiAkLL7iQ07NNkrvPjhNZRb2rKGsXAG9VCApplmwdeglpwqMibQ4GoEV+M338E8A8Iz/FD8JFqN2INZXyY+39xMWiwoov8Godzo0aMx3X9dUFqML+Iw4wJjfysQgS588u4nJTA92Or7eBHTcUttZivZaHxQDUesUJ5s3oYa/qCHp/ihIaf/x8AbsOK8InfMWaTEI9SfXsC0Phj5qan3YKRBfP/f0lm0NIXqzHjeVSXMKCQCqfx45+odSmwybRzeMO/EBPj67+5fKwpFfIBySVrhqRbYxZNoWZ8RsfgLwzi6GbF4S3qbtEYDc6IQfPhXj12ptzCCdhS0TwsRm2BQS0G5NFtqsEIyOGjWSH6E26Vnjr2m5+Gj5tZQS4RfSDpew5dlHirXC3hCAm3CgqvBCsngH3jMGRJ3wJjzyt4AK+9YcTZ+zN2H6Bya9TGMo2XAmSVnJWaX8YaSllOPhdruSjeifl2+TxgflRofkyDAJHJ7pder0LO7fjY/fvPYud4XlystsIzM1BWmhPPhcXt2rxP2/BB6mth3J/5EJX8oq6A4X8CTyLPq1hWVzj14hLn/5qAdTvO3hFmwKbSsAkvL5Bs0Ozn+zoqWKXuykGmC1bftOiN8NsohS8sB+zvYgAM4TAYbzOIvJ2Mb7IAdfsc28KWoHzVlCUyFzbD5KUz9+NtTPBVvxpuX4KnfiywusqKfGuWwwmwsLdVQ1gFEIXlIV50wjm/qkk83WKL2DvA7Ia83AyOMjD0oGDMdrxhpF1FUnVNt4J9svrNk8raVy4UO8kb1ozdnu33s9ycFxRwQ2PAK9dAPGtM6Y6oRfNsz2xUf68CTw8SNGfANmDz8DUb+YX9v+hHhdlHHxTv8ix/vzhUUz2evs50nGslLtW9ePDEsXrE+yHGloKU+R7ctnMpb7xmHRwqKj5gNfvuPyDqnwxKpXCODYqMciqUP3PAq7EeBn5ZzS5v9I/1TJ9+vXyaVx5L40PAxgs07rJY8IMqz3bTOCA+Nio468OIw9WoGfAmm/X/BGGA2wNf4u03bQn/cJzRCIQHzyNPdcVtEPYzCDaQ7HtLrCEX/Y/2V3ldK+K4Cj8ayCX74C/y15Y9vP4tsqkEtuUO8aX2v8xk4367ohxg9Z+UGwuufukD5z4s7k/BX+Ou1kxaIYCPd4c7FeVxZpMRrduJD2BzPuIAnwaR/33wCM+DmfLIUFe83/ujnsEeEkU3gCJb9TS5bSwR2kUE9ZGGUAWOUw3wzCD4JeuBgi5Cdqz+UnWmCH2CS1OuIa90FpwVYQOIReOk6XB2HvUzYWIMlqjPqjbDdqDfKQaXnFq79GeQgu/n29cCdmViG5WtnLRAzJGvO0ePSvXvtF8+ead+2Zs2urT+KXsncHPX6+ZN4PPrN9H9hxJtfYPQf61/OMQgXy0+dvc73219bvsx+4zL7UzsuRghsqg7iJXeNrN4IF07LQT20gvvcidHcWa5YabVg7R/wNXx1548XIrYZvsM5FBo3P1fCmm44BOZgsx0m4kmWs60wh81+svr32oXmc80iHhmAd+Cxy/y7L0ULLL6R/kL6WyNreiG/B7O5QrJVCiNqMtVVIcpgtSokS8wa/pULOxxeVVV+uBLMEL6Od6ilv17Iml7I6/EiLjjNEFajrDFU1qaJuyQVEUfuBppTHQ6vqio/XAVmyDp9QPqkkf0+AKRRDuOB52A9OF6Eefy/y3tWY3r3jAVJQkclcSa0/e2vyof1O2aKeDGetw3b8f7WnD3NzsCOaunzgKzOCNRzOYTBLxxejx234fn82MfOD2B0y/uBXME9jHCq9rSZqly59+xbEZbAvItgxze95yojylXxdFV5eZXAvjRYorpKsKtsrQK7BuSNP3AfaRibXjM0VSOrO3azFXYekYOnJHCX5lyZfXWuydqIxT72yqnrfn5zu6UbRvSL9c3c3rZdV8/xV87Un+nt8Nvu6OdpvVHYHcJhxSzvHcv4aS9m/Vr7OR2+6hY2dHdvf63MoaYcxw5wd9clExj55Hj7af76pmb7NXbeize2OTS4CKzkj9fDHrW6QS2Fga8p1Bohzagok6585tz83fc5KNe7dV7tquu6VS4ai+6XNB42gW+Gx3He65eFLlDiaLwdtkEMxMB22AbREAPb8DZ8UFREjfXG07HF+OR3rwSwpf5e3Gzj6KoN9RPqdhPtmZfLjyt/6nSeI/pREZHzNR5xJjPCnHbZ8+uuObzo7+g4WiX4ZjfYw5dKsOiEmUBCLHYER5yIE7EjdsSJoqIMJ4IjdoTEV8+OtN0WWDzRim6ogZ1H5TAXyrhFvWHVJ/hTdc0ni4Rz/o+9V/Oe4cH7ogVsh9dyB/T1QY+Uj66feHh6X7PvMbG17GhjD/9wQ+vmFmFRb9iRFv5M56kz55t2zUwVssl8kBHlQf6F/srNP+z6YUdrYEeQ6Bbjs8eJ33TO/3yA8G5r9V4Xfs2WA87Om0/8kp2enZEtpJBskUE9tHoCDYlNlUb5NFpaQD26YTj56ozD3Dnr/fEIrQA0jLLH32Iem6+xTRZh1X1gBn+d/xbL8sW7hostj/jfVp35fr69i6UwTFnSLETlq5vU0P4JLmpk/R3yoQkiET7AaiVG+Av4ChaHiDBLj2eTutz0XF1umiG9MrPSBObp8VwSxh36GSbDHCWQKqdvf50ZyObsRCWeiy2wOV6hEl203aQuRhcdzUdnRGdECy7a0yReXgkW2BzmKv/95dLPl8TsvKy8fP4qxerSjx1Udx+XXmhk9zor6+Vn6fDQiCAn/86NSpUqKV4tVjcWnmrle2J7YrsEEPR4LKl+llzXxN/qhpH9Z86FOBQLLRVEt7dLlb0Sy35YMG5P3p7K1aKt9gFZ6lixzYG39XHdsUtg76eDg/aDZKMxhVKjIhjGwg8csCpS0eKum7kzVAAr0qU6/W0HrwiuAppStOgx/QBoShGsx6OpXyGn4kzz6/OVFlhGlsZnxhzkw5ICwh2FKbhAp0IhAu/En2zcB+cXOazIc9fz8moX+AofNsdfaIElFS2rMEuxK2CRGp5pZHVwYYCGWVo8C88i2WkwD6bJKuACB8/0+BmJp416u0lZvGSbeqhOI6swyqF2OYfpwzNgCXjx4PUOlgJ9WMhITMhIVOJvxmFbHISD/sFr4Ju8/IyMPDHYvHDQKK+4FnR5+bo8JXzzD6yBIAgaB7b4m8QEnS5RBDr8HV6KvXjsNQMvwXS4wNo9UktjDnH8Ezh4jTcSRRS+D3ZwH+yIYgq/xpuIzXf3cxy8ho1EIYVfwyYihoL72A7fx3YEi50wrx4Cjemf7epWxStIw+O5rbmet87zir6uw8Yu/rnT6ZVHhEc1vaef84pXXeHGLv5c+61LeYKeWrxh2kpR0edW6enGr3UK2hEsaKmzwaeD1vKKV25hnm78yhvTngksdgp/cvzdGtau6KvAM7jn1z88FBWvOtXtnfyd3mNnagU95VjrfOzO4Drs6zS0d/IP7T8sErTUpcT29Q684pVrhIcrv6jX6WGIsPKAs9MiXtHnWu7hyv/ouX5rksBi42T1UD/1L60Cf8GBmX7u0PnXemxG/n3g5//iHurHZtrX/52fS7L4fcaArHBAXtjGuSH2PMJR0h01WGpkdVIXV0zeB9P72JQoJheDJRFHsvg/I83ik0b6Z8y+Ryz+Uzqhlr2Syrj83Km0CYv/kE6oZQapaizCAdJmtRG+Nmpk8IVUxkUvJ7Q52uLiHL1eiH58xZlIzcrWZSsLC/IL85PzErPEVTUPaoi8rJy8fL4wPj8uJUWXmipsdi55TOiT9TExyVqtULJ8cy+RlZqSkaLUJiTEJeQk5qWKD0JWhRCJqcmJCXxcQUJhdnZGVpbA7oL1atkp2F5Os7gD02pYoJEBVyE3LOUCc8vn0acaQ44F5oiFLYSWjHYlGivC9+7VhO7fG3OkJklksUE6oX6skdVKZeMRrocu+EpWD1/JwRqAawo+6u+/f7+//9Hgpqba2iaBxcslD4iU1UGkvE66x9mfcbxx/cyZ6zccz9hvcHTcIOjNLnV1XbrY5bp1m6vrtq2uXRcFFndIZT2yip76HnmF1DYRYae/1NCnkdVB7AXEYqe/1NCnkdU958AbrIl8Nf2OWXuvhwbMEzgtlVIvEyWNgtg36CFYv0EsPo3lapiokVVUyMF8DafmfwzNR2uPlgpJhURwhGeQt9T5hcziW1IZjJBVwAj5Q6nsHq0fJZW/BBZ3SmWVLRpZhfR4Okq8675CejmRHjaRynpkFT3yDqlsArKl2T8MaggHV4jRyCBImsvBXNIL2xF4LrkdJ3DnIJyAOeQOHE7oyS+5TNHjyWQb2BFgpceW5HmIIbTkjziGwHMG9th1xmlhbCgBpRbMfatZXC2dUHccRI6VnJ78Hk1G09ByhNMqLVFdBqcnYeGQLaEl2T8kWD0ZgC92WInz1P8XpZHV4aOc/v+iBlmuit6KDnAwoMcDJAuJMTAbj1FLLTDbVOEJ/8n9F2MKCH6IUqIGF9FgMu5E+Ic7HUyCak5hWKfZuXWFcsHqp//Ei+8TzgANI5Q3LzuvqhGzWslsXU5qttAV4Fi3RTlxoQ0mMDFg8+e1c42nG8XM7MycbL6ZwnNxy03EQmK+ukktdcBUU9Afge+OqGpCIFvxCf4z24CiRJgXt33CdXJIxHMP2WBvvFW5VFJxRzNbj9eU6lL0Ql18mU8Q7xe2x08r+McFRUXsN7mNP3KKv8HOrKDIGZwUbIdtsZ1FjRN2NkH8Vin6wHIuuER3poa/RDV01h7NExRSz47iYDc+ROcUHCMMkMHFaWdr+Cs7jwfWCYpPXfrjR87x13ce2SbgUWRtTIZ7CI+DqRCdY3C0wB40qIfMNDKILKKjpT7u2p7LdvWrTE75Oh7ZppxJA/3hM5iBhTXMw/RNsaY1PjfYW12oLlDlWaTGGRIM8YfjLEK8CpIItgvs1RKvkUEe/MjZrHj47t2jh4PvHq2cMWPFyhki9gniHrwgfBp6DpxTnu85crJBfLCgtHT+A6Kyrvh4K38ypiXsmPDyYWTpqgXEyUCXIz8qHVwO+ASKq15ERr5cSYQFRe/24XeV7KncJ8xfRbDFkKAG88vv14N3nDQZf6kH8+HZJKvF29UQPY6W3V6MbmN77kj8UW11gonqnvbxQ76GUlXVxzYoL/Yeb2sWfRoCT+RmZ2QUCzsrdX2dPDyzprpVGdYePN5PeYdu9t6pHKuH2FsizLGhLgbHYVNHngUDxG1FoOaGZur/m0myv0LcVgRqTkrSDyeRLJ4GGVsRxHGQpcdZJBu+S/1APaTRmDad9AEHGNem+AgaeMgBsbLOfS0/bbn3ukRBK1lwik941N29x8/zj29ffZwh4I3D/+Ns699obyt3UYqP+lPkX7kvLv7Dg3zalZnnBbhM9ad0b07GZia5ZDHM965xKXHJtGjV7qJmp03fMoVf27oT2OVCXkpeSm6KCX5L6VJT01OVa6degrE56bkZuWIyyRao1dJZjQwOenH6NvLtUxPF7GPJ+8i2d4GyTetF4VGJs8djUx6b/jQBRiUILM6TjtqYGFZIZbYIz4eDakigfp/7uPwEkMMoGIVH5efjUZ+zJuTjURyWEhLWagh2xQcIgVmee784QMNsLZ6NZ5E4mIWpnE3XeSFZj5MljM0EUwLfAZl+QK6HV5w9XTo8kWsqb3CGEUp1/mSVKoI28xuNcbons1OcPQ3GUfY0i+9Jxwfq6MxeyD8O2d1C+J50Xn1vQFbfQLPYe/3D59gLOfgO2fUhPLqAM4hDflz+1yRxG2gYHb+WPo+wt/NP5YW8a03r3060lWbhH0Pnq9fKjiqwbUBSLf7AGQxzztCbcPhOEveRXmOwRBVmxSQMat38QTaLsyUniJfVwRT5J8mJO9V09tZN/3Pe3v4OP6xv2nFKzBoVEHzmxvXaM42NtY72G4IdA0QWDwBWwz8a2flK+d8wyB0o0nVW8VBFuUbm6Ij8opQdInaiVDq30FiBxWmA1fCPRtYCU+T1MMjB5AtJpK9vbKywgQQGYonc4qyiQr51X7O3c5Cvj1BFNuqKTxiVtUc0gdEpUUkxIos94KfndEalorFe2vgJKQpeIkVjq97bxz8q2FdU7E2mziVUernwO8MdtttHd54T2ByDJTpfCb4wRd5uBoNgiSQrs4tJlK9vTKywgQQGYom84swiPd+6r8nbOcjXV6giG4tOGI9Wq/dGp0YmxgpYgXMIbAeDXOi53ZFC019Lf2hkF6ugvFIOv8EVDofgERSMSOJUOvfQWOEBeaAovaOKb83dBRWJJLbANQT+Cgq5A/r0rioeqqmdB4kcMq84Ocw8XUO1QiF+y8E7sETs2fTXkPmczqyEHVWKx9Li0A1kFF43l4N3Q3aGU6fOu//sCDj/LDaevy+18N8npGh4iRSPE4038lUDNVH3ZDyXFQ7cHbg78E0ws1gL08yevvhY7Ce5QbSsvhK+qJTDSimNCzsYFhmiDAgzNLQcLarNFytza3NLC0ywrJsrzyg/ckx5qiLUQ4y8e5gYGxdkiUpwCo5Za1qjDa+OPHqorPQHq96cUbClRJcpGKXUujLtQ/H0qoKgkCjT9li92g/n3RuOXSyo8bnnjH1ayJ4avKnB3wUyX+K/i6j+VUO+n0T1ZM8c4MMdjYXRZWU2V4ON0eh3HbL4+VA5iA1VIXGU2BAm4IfNjzi/xb66xaEaYzST6BxQu/SiztXYz/KeNOHYLuSBZBve+nG4QJok2/A6ifcUyAPfKd/4GkiT77Vv7urVz4CUYCrvqSGN0jsBP6++k5GjT86JuIOfa1E8TLko8s8jxiXH6TPiqsdz0Krz+WYTVrhRtJjt7w4G/O8xiumv4ONnoTQoDZdhM/raN8kYf9wBVaxYowioPT94bI9h03lXw0ZB4cs0rrBfFh9h70PY9b3H9Z6GYUJ9xqMTpXruJsimzBGLtB3OLqDmlax5A01OwhDqtMfndbnqYMAo22YfmG++zehDr3iwrbgnTKSKffHx90qNMpdid9sOLzqRSg8l++LjKAwscdhMC29rXtC+H7eXA4bYjM2gnkjzv893Lj7eJmFnieBmZztLyoF8QndbtKYHJdidkk+9aVT0ZpMhRVSvSZPwTwmbJXli0hxrgZWwwZR0eAN+ze51KDq2/djdYI9c6RbTfeyeB50FinOTfEipUf6Y98dmN5iSTxZvOMT+9qLj4ZXNGEPW4+GAbbMrHQ87bEYP2oveVJwrlXg5QSHtfYC8zz5xGQ305pnJTRIKk4SokshCv2BKwv2uUFLc6Ba0k/tgAeIxghI6rCfFsbZo5lNLFjV2p2SJX2/PuY+mAbTWluQDAXS9LcaHBtB0276eMA/yv8+3Lz6Bi+OouziSTrUlahjXUqrReaBs1QYrNQqGZIPfwcVdBh9YqxeMBXStP6d6Y+FtoyY3Yd2H72q9Wy8dCUpuEux8Bv8zm168Y9/byrAUu/mSOzQwwVBlh7xVIe0HKXmfsg+6kR5LKMY84OvxKy9YDrgY/6PpBZfHdVUvV9TKKs06sJmtvxxwGHr3BP8CUWSV7xiVyeRJFCWfXiIUBu7V8j4+JfypYm+VW5UaZV8QvET9URH/IpiaVW6XHkqy7HCX9sAsC+X/5f00NoJeBdSUluNQVGmqy8urqyPLIyIiIyMiyiOrDWo/4CMY+IAf8K3M0Yf6AV/K+vWENTFnUmfNvqvUKH6UlzLqRSfAfcbdGkyAUlbmSidAbKdwT93gRgHhJw1ix/yLoH4syYdOlDvcwhFRcCkFlV93Q0rPOgfyaTQNpLWszAcC6XpW4EMDaTq71BPm5gFqrfsrlKNrP0RZ6Q03dwKsdW+VGuXtUTqWVXvRVXCYbfOCMcD9TxzvRmOAJzcsNxoDvPrEZNBkuvZt+SRZA06NA17RnGU64CZbhCtNghuKPaYqNUoVxbk2ixc9Q/nYjJcm0srAaC7FSzajRuK+luyLKKeYhqqvbBNpqX3x8dfSB2kuRQ/bwT7Un5am8AzSB2lf+mni7cCZVgI/wUpdaSjwRAaudCXw5wX8TRUKvJT5e8GfaZLNW9pHV53RTIH4WJX6tzSJzf0eR97bCWhkTf4wCyoGrqPyX1dcrHVUr4jdm0DXUCnLI/wo/4I5HrKr3pB/U7CzL+6fFXyCt9WeNLdI2Gl8KJcyR8/KSN5tM3gVttpI1ukos30MpfbFdRgufZBw+FL4hs3tQ0NofWkEvS99kG4qmY1tD+ZQ0tG0iZJ/HhjfL70YfmA3+lCM4iNMt1t88D/aSBfhjGdbSXkefX9kMFPmzMSdrweDoTQM5P4IePKg7s4FfYHbjdjsVCeHCaOnsKGj5i0Yo6I3WbI4SqVcyGEJXgAhtOFeBH2dh8MK6Qtb3xu1o5Fk3yQ79IHtNuOEywB/hUmIKcd1RuCmsliuOQvy+o7N6El/5SNMzS0XFgOKrSjKndXboFHMe3jt/qM6p7LxtkFCkOJrR3/JLkG2A5pTRUU/0PDUle5yM04InyZ1B00kXK/WGi+AzU3NAoiLA9zTrDDb35bvtDrg0PQBcERsvHLds517KrU1PYTppYEPwhrGvbfjZxcalHwn/plQYTZXl+JBLW429DxdnSbZhnsC7guDazWecYnJvkk+CgW2aFe6OgVQOySGdQa93EpaWd8utgDpkgNj40bDEGHhN0BaewCO4rPeQpSRpiPLrK4DRSpzS5xPtU6RyfttwK7Fg++32o5eYtBCqOMBmpqp1KgnLBakE9QaZsLqNIm1t1TerB55+EUY4DS2zx94cInJ9vW9A4CeOV4uohh6qKpFYKI4qsYSf4nJEheKm1odUJM+AJgg7t2xO6NYj390nFPtTMjZFqeN3RYfm+Q4JAzctM6J9D9P2rpiOrdBRiUZYU1fQanei4x6NPKARNhvzrOFqhsN5u+c1LFxxnaj9k3yndY7cmf1LVge2WcYRR/neVQ9RvM+T4so+tlkLzhqoYvwyD8PJCgBmg19cpp3LqwijtJ+LFODa2ASQKfYYnZDIP2GFewGE6VV9ZUknMrcyLUUtfSoSk98rNFEf239xSP5aGi1zsmdzZd9jGnYUu1PDKb/Qsm/D/qUfuubR83fgax9P/TK7EY9+dhSeEV+6vIO8p75PEHP0j/9AqTzqJngmyezdlZap8rk/S2Qq1YsNRyvUR2NWlW+WBewMHh5iOG3v2hmI2uyYuL7HcZtnQm89utJ+3FFGlYAzrFtrUtoLX2SVPIywG61Jfsq+IP5udKKEpNtuGRfYcXpMk6TTtFEyjJxknaM+UiovZdmdn4pY/88cs+uRrUuLqoGqlxFlAQ2MRHcrhCHW6Mnz+0tWjpgUfVIuODHQTab7qnPgp4nU8n+tozmccDlE3+RRkJT7WySPywHXSUHrLRt312zZ2l57RM61jflZDIj4LwtX4DLGjSxKgu9ERDyi2oijBDbraqF5Wl/7dNiP2/KV54IfHBj4XBji/joxgDf1/An5NHJ11ybvfy011xpY5pk6yfVK/atVhyk4ASrQzhwjwue1NpQqldm0QQFv7pKe17wpCvTn/pgJxO3wpmrzc7lhz+0oN0xct9SckezquDEUnTUocPT8+iADr0v9j9nSKD8/wZz/DDbD7U9XoDdWV/koOVXSBBwQEcvTXXRQSc53B8hRl12Pt4pPtMuVndw3nPkckvTUXK/uFlj1wRXojw40HZvYs3kasN0t8LFKEeOnztf81oNC5jn7/ez8dx6w5V1F9dN15KDU2cEzw5YLB+L0T/hR2IaYoxqWhhd+hd856SuuJBgggeDqrIQ3krXLLJBDOafFVENm3KyM1tpR75Qs6FSUkw8fGaF6jl0zIgGFUuVqZV0YMoYjLAnxV167sTrNOSf6qLa6kbtPnN+FLrRyl8Mttn0otma6hOUahSZO4oO6IlMg7PEZ+iy/8oV1K3uo+dzxKREVYdO2OrIsgWcy7viID6JT+Au3JvP4rPQhXvjmBdPTt+/qN8qjJ/de6GPbvT4qjPLDZa85JxsLS4T1RNLTMzfbF+NcRrZUw98hyM+lPhDQe2tYyqoqslXdAVmqS0g/8aS+mkO1Fbtqz6wJfyQPuLg3q1Vulr5SK3BIiR9tzRsmz45Li4lTrdxbV5VmOHw4tBd63Url4atMCgqtSFosvyC983O8sqTSV41gtk4WdaRo9rKpMrE3S+aLwXyi8S/EpMKkwoTC51QL5BXEncVZZirWaKqz4z8khmdFZ0Z7TRAIK8s7WJueHb4apmmpb2fmNqwd5vZvhiHaJAIoQNUu4QDbSqcKfEpwmnsosKuEu8sHGxTbd9gFZ9pwSnCfN5FxbsK6mEz4Jns8KyLjM+E54fK6mMgEf3aDoPYzXY2ovVTIDcjOyfVuhXndsW5W1WkZJc1d5cUm2sxkEY+f6vqivWnsvP6jZfiLl7TSoepRZwSN3PjDH1ZgNVvupbPz1ORRktsrGW7NXaXgZTg3LytfJ4qNisuN1mvPg17yxpjIB79/jwM/JwLqCvoSuBtLN+DhgKvYo4eFH2+A7yRahVWbt+nKA4a/LSc5bcRlV1s9q6TbUc1/l+po3zZ1D8LSjsNO/dB6qoqtq/70DUMM+qYzCB9kNIc3YeijtoX17GspTCB6TxoCI2g+onG7+zmUMIsmyj52874Xr8Y7rBTPeExHN9ZZSu4fCkwnSOzj5j/rA3qEFqvRFAEBVWF9EeW7UlflpjwroTvUgEDeeMdLQI9RQlH80F4q4KmGOz2CzXBj2RSxwLZEQ3vLy4Np+FzDJgoKh1HBgBqRPLrQXvud+iwYZTUsc61IvnVGiySuh1K9q0jxU7cTSC/HjdlTkj/1ok/EtbFCBZIXUxtT6ruxY8z5kvH5GNSZzVp6wPk3yRb9PfQDW5cbzlXUuQDEmmbNHVYWKmKL+fZphqzSTQ1uUjVSqpk8/WEU404mZU1Q3fsmUTxV7Eu/c+TM6lGOgRxv75X5lN4ZS4edocS868tzsePbZGvtiypI79bmil5ZvcHRe/rQO5ZTDCFPvtzmu2LjUsAnVmzB+XLeZX1iKIWH0NN3UV6zjbCg2oMRisA/2GBk8YO6ooSQypxXw34bNIkPNGC5zzhtxbsFAY4Gl/cBL6sxIQ/s4VMx1ocegO7mgwdvVwAdfjpJszjNYpOYPCiQiLpFJsizYXiVPGW0LeHqNxOXgYoFOq6q0Bhwz2oYTZy8M/LFXAbBko8ECtvUV7JAywYwLcJPUA9Erhd/uHxbQ/BF3rFL/rbB6/4X8sZnpisFxno7/LR+9whBTXpR6/4H24+HVS9lK6U9Rk/nuxLtdmPqPvzdLQeVcruGnv0/+p7VtO4+lOnk4agewIw6kHf6YjTEPRZPEY96L866TQEtbOQ1IM+ya2XoBopXT0yaBWnBFQ1KFdYpHJNPymt1fDNXDlNpzOFA/QASipBP40zaNgxtGc82iwFQaAMtoCdHGqlAi4rKT8+gU9JSUlJTMnNzckpyMoR8DxfLiov/VgJD/PKqBNZXmFiJpl1m8CWZPY6IoOszGo7IZTheWR0elBUogCiWVSe7lgJDxRVkJGbyz/D44mUxOS4BD4+L6FAn1tYWBRXlFwg9IEVkZGUmaDl8RdUtC4oKlHoIKPydMdKeKCoQxlHD+UJ7mRmfnKcTpesE9djtBwEQpeVkpPF5+RlZwp+5KHEjNBoHn9BReuCohIFFnKtaEiAg1wugi+GvyNcI/YmuCulrTFcMrkqfjm9gLSCQQJWP6SxHfk93CPgEAlfLUE5c9CwF4k3/WdLAE1al346XiB2H3X4inqFBkyysBAvgAWON5sMVciljzWs71slwhD3Vr1VCeQHNBE15YHaBBy2hoVRYpyfgn/849KIwLyyefSphpC6wBwxrxpGJf9x5ep7C0es6/wIijZYojdGeQX4ccXkuVcEFij3v1E8tsCsMI/cGXm5W4RMqg9GEjHk9lkEjKU60we7f6GximJxkkZ3SPaTUW4ICq+J2ElCEHMq8KX6QBYEZgs/m3bT3lAdDlQwnWIhGNnI1E5zTCODGb9xLhcCniS8MbEFyn8RffdWwI+nRbxo+AO3Zl3TeScR/l9K693WtDRvtgWed8idOxnOzeA6rhE7z93Z/0gJtnbiLHK339bcFM8+IKJJ1x+IToe1R1fSJ5rM+P299aKTHcFG6hr3QDzk9p5Qn06+ZALzNTGnTmoC6sXpw5acl09F014R/OF1g6/BMWerBc5JbDxdyx1pJUKaTkUZleraAos5VNqjgNtObQ095tFkiBdxxN/7kEckvaxx7WlPcZ8rwcJQEZLclqFbcJ87M6OW4/EHm8Ry/wznANedaN66FQEBQmKYKiUkdYNDeyZwSVbmmPqzbkr+0Gns3INy7t4TuklglyDXrfD/I/NUB7IOuEblWHcsJ79WlExIFkpmoUyNrNAoh6fAcl7BDuuWODl8KogZ93trrpZ1FF0ubSozSY3WRUXx3oU+pf7CsXYuubyRtl8bvW+L6K7a5nHQ2QTXw55n9MHIGcChay4v/7j0uvqwsL7ltscj5WD/9Z/rxQt0+8drMFbZRf4UvKxvqnKNvc9mX/HhwbW1i5Wr3TxDw0V2L7aGhZKXRgZFFXJpGkzlXCA2Wqa0Wfke+2EJtz+/K3iY299a84d7bE8viqQx984KqFRRu5torIjIxyuprvW0Nhq0MOUd/Snz4fW61xZsqEEtecEKPFsDM2CqN0KDUfEc3txG7/ErbqyG3lQsTj+UUSJ0613J7CZ9Q0OpdaH5jJXah7iMUvT8glj4PAvJIPIyDWPR3rK3wfQmGvbCdC65POVw2mGT3xN+p6vFCZj1mbdBjItJssx4yuAwvJB7+eDc0yZxSfN9h5c0ubD5qx2W+IlP/Vedm09uZFpkj2BzMB+y1cjgeoUc3sAJbmf4vkQ35cYfo9zcRUBSDrH8v4XcY7r6Cn2EDI0IOfAzaqg+cqRM+AmpzmUTKmzRbRGn28UE91YUGOV4G3wAt26B+6drrpVBgx8f+C0lQyr3WJPl1jFwbdDjzgJVClkHSsIqYkyCI3YF7ub3HtHQUYaapvq62jIhpbAotUhZSI6lceeGzlhtzgZicxhXOIcOqlCccqMB2Tw2OgbfIYUKI3fEZHCXPBAREhrIK07trQluQXXA+jdwUBEUqoYjp0POAVWokknFqVXxvUjCpv5GDRuELWBCgRrrsi9TWFehaLkJi7jkskZ6fOJjKJiQ1gQ+RlvVPLdNtKgI3k5nZ6VnZAkHIoJDAnlFC5hEC6OfeDW1ZcLj4uuXap+YOKK4gIdyckageahf+Y6yjjsaU+SX42/hru0ks1Tp6ljeSQXTWbFEJysKW05CX5bECA3k99Zo6EhDTdq4tpuppaMDsrqKw0Z5vdT3KwJqCc6if0JXMhHBjTiDwtW+ilof1AcvMMzxaOqcyS7RoeJlm9xwj1vVOJjQp9T6Fn5H0L7oomRRy5cPDq5rWHCU+Fjw9MJfPBe9IsIMTiWOUj+S72u+wDawWPLWIFX5J1Z0zs7Uu+lS0FWldtceVuVITXrHiBs5D1oG+Oe29evrBPga1TuH5IN9BPaeXKLkoR0PVRedV/df8dtv2o1TkjBeYN9gSxg/tGoCDeZ6WOzgmitF7mgN5d6A/6O5Oem5usjNkZFtdP/uit0FerQvO/MSRS02tAF0CGKZwOkgn/GuHBHzSijXq2O5g4m99QQcXnxUdkCZrdWcNKZPhPHihujQdSFZIu2riHLHrbmtp1TUFZyYcKQLxQ1yabEDThykOU84iusTuUR1UbBkRSBP1WfExloKFNBQ7Fn3Sa0/25En9IBmIXZNQ4up1kTNZ/BuOGsZR9/olVxfTJTWwdGTvbQMkq1ZxSqcEmbDHZD4IrEN7WC+3vJbBxFDpODaBH2UXFHVpszA9jbz4bt76BKqOC8FXLS5MZAzHuVqlwhB63s73ryBZ862nOU38EuqZr1mAIsaDKwUHzykGTlWanlp+U2R2y1dxL344NWAA8+hGlWywa8WmNclEc6MvpTdXsD9TCpPELljRDD/lk9dDTi2AQegeq+Bd3IBNfPqBt7I77ZSx8q0c8RKrVevzc5iCoWOCF4MYrdV80Vut2wB0lI8Xf8x7Zchq2lW9cAGgfMZ9PVTo89xwDnshI6yYazAmKpxSs/eNEAzX2N2ZuEyaWISe6WpMl3s5zaCf8Z17/SFEeG5oTr7KuQ/Djz+7WpbtWG7MMoZj7ZfBuwhFE+e31VtqogqdsLe3LX973bdpdx5RgOpDVo/dJ6eNB0yQDZaJLbJGT9btWqmb2KRa+B9Z6Ey7q0CFoi+P1HqGv4o+m74ho/g3XOo/GuQ71VAj5uofXLA4F8L7H8DKGaZ7VlIBbA47qMZQ2XGbaL3poV8Mx9VCTj0LPqhqtLAvxqT7k16GDNVAMv2iimd4YmojKHB2u6Rk3kwH1oJOPgm+qJq3MNnA6i5ON3szEzjddTkdLXv+K6AvcXGEuXRTR1pxUycX+gLKMQhp8+U1j9u0pFW3ETX2o4RjJH0uDem9QvXThOHRvhwb+6qmwhvKchgmWZXAd1/Q037YcM0F1An2P5pca7zMxn9L6/qQ0N4bJHNwomNaSODUHLgW2N0FQYC3uSp+8UDJmpcZXrCXm/zDjRbtxSXZueX7DCcDX7DHblzLPcYow9LpYE8x1RtwqMRvwbjLocdJx/Rj0/UBNYva8QvY3Bui55F8JTwHP++jnaYrFshd62z4VPFEBYAKVCgFN2EA/ORj7NEN8U5hTxs4MKoC/VFevUSh0A2+2cy+sgO6PIaxvnp+3IfUelYS2UyBVYuxQz9XX5O6EfZVXFwrCrT8l3GFh13gkgVwvdQ6orJipNL3KEV/fnI90B+P0kbJa7fLxxw2pzoG3ljx+qjzoiFUxQczL+4DeR5ApCnZ4TCKSdxMO8UVSgylaKVtsn5rPeA4y6Hy+Sp5SRtFurHJzKM4k2edvaZPLN7Hd0/wGzdUlKSm19ybvVrrpoE+LpyMW4mPWmxSwBy1+6MUDTlFA7i6m00HnH9wUpWc1J7mPV5sSQJ+nf+gnxk3V7D2EUnD++I0MDt5QmPcTsdci1U6QhK8Z4NPaiaNoGsXreBfEwAwveFwhfabrUwg6px0s/QzvP7gKfxwU+U6/ggOmtsvxR5CWO1CXhfF8BFtrma/evSZi89CF4xKvLhMVXjOBQpGmQ0By1+2eUCXfijr2LiI+qxtZ6Sl0tob9iqBBryZuSlA95PdqWekudLKI7/Gch7fNVFD8fSJ6mLt2+PtSX1gy/RoTLj2YevblWBPg04ogYeTYwj4MWKb+gv9xcIZeCEann4xHmWtJfZMUu4nqt96L/vJNgh76NPNB/cf0x08wz6YTW/vHFtr6egCt0b7asE4jIXeEJ9Nuly0t3DN5uM9b6VjjlbcrdGrd7tbIK/XMO1tZZUN4qhja3RbcrB/us/14ux5PLQpRuWKn39Smv3i53t9Td1D0xyKN3DwFvObSZVNY2HmpV917cuPCo21xCP9qzpXaT02hUdGiBWB+wq8foLgatBLe3VmIIGfNw7FK/66OaG6NCjorNn4Nrl/OLja855CRrVfq2f8t8z3J4TB84n3Ui+WtZ/qtdE0dfse2R77oacTZHLvZ1NYKQj5xdQXL1f7DU23dY9NsmhdE/29DmcMqmoOlbUrPzpiQ1mNtE4LJY72VJkaBDV9S2xrUoY/etnMBP/onftjlXvFQ2Bu4t8/kIQbLBCsrtGWI2yegvpEezcCfdP11wt2yTDs3E9102fb3YKKBcT0TWXFz30zj3hmgNCddjeEr/FNERPcnP9yPKLtFeGGOxz0MmBB5b0BNr96R8hZ7fwwD1io8rvsPdiGmJnoYwJtBwGriK8GC/kuun2Wh/vDDF410FnB3477fPsHXS2FD2pNjs8EBzdbDG/Fpvn0kPy22jYC7/iPFFb7W7vTDFmX3JAII8sJ/B+ujMzxZ706z1VgnUhMSynAOjm5Lg7IviAeFQVWOq7mIaMk2iSEgNRMlpv/DyRsdbHSwzeFelySIZ3TQh/HcxRAbvFprBeXotpWGQYR/dtLqZ76+4W8Dul+HiR9s4QFZ/SEnRx8TyyqSW8NwP3E1eQm09kSKhYq9p7aPdiGtpxzXHQq6UgjaxvIw2BVFPF5bPnlcX61OQC8XhgzY9lu27QgQFEBHJ09tnlLz5NpfEMS5qFSlxzHOLapDXuxIvyiWrbV2d/2BO+wVfMo3yJRYGDQQxY9d599Xiq083m8rpFVAqpuR7Qdz5oo+Fie6aaaV0rfA1RePypy5d84e+Ge5xX03ngu93xqvntc7v6dXXiltqtpVf43ta2CxcanA/kCY21CUUx5QeKLfYfj2o4x1/rvvRrrtDon748CFRU93Bo6PI9myoqKW/qji7cweOFa30WUo92Pli81WWPV6Ui2bwkir+dkmbvmco7le4pOyDkREZkqdrPhY9CL4SIit/VULmN/MZppL0F3QvI9DZpAYQzOBpmdlWeGhXPpa3SS84YenkylrvjkXj0DSE3UpN9IJLkuuXqLGmJu1GIMqsoMJj4F/3MviPGGgD71ixBH1MWWmwBhF0zyGGE8vRRZy9R0ePmt85DOMGYlhuzLul5ts3dexYa2e9G2PQ7gg+wqZ1mQPukIuzaRksm/aefDGxcjKRWZwRdw0EUhGBi+FCzJwx14YiqCStE/AtDsyYPitDQwmUIJNBzOWRj+aU2AQrwVrKEdgSnacIbcAH03TeWREJaPZI6itDQgmUIwPNjzkCwdYYu8gV2zn32Da3ktF8Z38bPuXEITcdP8idnlH46ni92HxPKqW5jQ7XYNAAyojViZgnOFCuZvKJhDf4e9LDHEhkpuqyN9e2ykvKvs2V9xIGUtPel6I+ShjQfpHU0GGMgfDof7gHSfKglMehObb540u/cJON8DOLu6I6bhg+qvbPlj6cdpWjWuP9HiiluBPKiL7WpV1DeGpMfLhBZIC8YAHgIA58Msgoq6Q+lP+w0aGj2AN5gtlCqZjtLBkFC1BnS3nGf549ZOEcg7QkbgbT1pbZO+JFG+JTmd89oUQInaQYCHtpDeUMoZeNLTM5N572ICbidj8cJQTIK6BtUt7yOXLawYzAuKqM5XqlZEF5AXLxRa01VfvKkhjTbuVNSYxd3otlu8hGu2vWlNtcVlL85M8tYqCG37VwhD5nUUq7eCt6YRneI3aV5N/jKnEY9OW9pKbpy/JkW7bMpznbkdD67TgeIJkH2nf3O5uZUPU4UcNXH4SpFwGnAKp2opnwAeGZgfWnHWjNVs7u5KDIEa6XGYqUcGGtYdo+O4BXLYcP0+RWPPebHVCcLKGTltaeEbIpT1R3gDbggF/DFDoDxKcFZucAG4RxpfJxPgZ2RiiA1ocjQCMO1KLyFn9GMpVgjfNhC+bxxlIWhC3U8klkn2desNOZtmVdAKtfdfU47Vlp2W6doAf2/A+5v4NFCvbEU1PiqgS6mU1JenzQUURcFealHCnvST+46qC+RCvP26YIo/zSO4o8N9CDHuGOGbTiJXo/kzsNwSJexwW6eAdCx6e4A45Niiw7bwUZKRQA2csQlSYqq6VaoM+EzjRSo3tbtIko+ksvPgR9sSS2PuVoTxhT6AlOJZemlGaUXSl/yTyW1FvyQuxO5VP6BQv12CgueV+MjeCKH+k/bznbH0clQcCKXSHIMD1HUOI6yL4GfHf2WyPtwCjToSst00GpPLzY0bK4ObWh2GmKAeXOE3c/9rnFOdEiuj74nZh/R1Ync4S474Jv+zyzWdk+spM/SclCMQX/TIcIiRKlemJL2jD32BG+Ktedi6UJRf+73ZdTgSbwqFpni/0oB0qzfX/v3pGqsT3vFHgW7Ga7o22GJqMD6OeDXBlzSBmuuben/NyGJv+bOvv44URODa1UJwpi40dDh7WEqEW8msXT9E0+Y9ZXJgPF15F4/wH+5QxGkfPfXvsX7VUeOJ5HQLR2fJ+xKzI0ZBTvi44YC+9cErJMc299RY96WdQWs5bq76SoSXnrf90dtjJrI4yHPY6IUcFxyeEM2F5qLplEQl2/aNBRYfOluVwqwsNIM7EgBmzD5dy04LsVXc3UIsH/fwgporTdpvGHwsFWUPFcg0HNA8jTtLTgCw/5fzFb4PsG6PXub047E9MTEocDiyij7nxBL128uLI8xxO5NOVylZV+IJ3e01c+kZt+aTZkMGD2ckrv9gF3oIonsvIqPBasoeSFzYKpscWHdIw6b/n7Kk9hUVaLVUiBp5yuXkqwx2ZKcxJ1vPlGpFTygJ1Uz8098DoX1iqND5zCBa4TMW+ljj9VYhvzghvlsymuAVZgAY+TldeT3JP01e9PPFtTq83PzrOW63mV6CrJyCgRfbYYfyYZZ3bTeR0LZ3JPvhvSHCzw1a5kKuxJyYkdBRtwUsyvdgGTNZSsfGKdNiI2Lj01yCjh8ZmX67p27Wcz1W8OE1tP2i0zKSrDmarNyc3Jydzo9gg2p65M2BN3/Y6nZHQuwcbjFAd/dgB9vhc5qMARMCR3YQ+t1uO+Vb/QLlswIG6XDIFRplp9d2xx/N/5ByTPlx2Ozq8Zn++YMieq1cKwTD+XOmt+aaxrOGeada17zm+7D0wuPLxh2Zu3IydFeShS5U9hQL95VN9b/wMV5hgvXDvzxXPtm5V/TrutPyZf2/6JD8Sn11I0cv2ZeoKEhcHzNSB2fQAN3N7Xtv6G7W4SNqwvCzYThuy476Y+3QmeeNgTmoVL73JkS/TuyX6joqd+sWodif+XhLU52q9l9UP6+mQId7Ft7nrw1iIfQmlmYW/6Rw5/rfYOX2Zw8elr1scOdedsFKvuSSpbdera+GfX79CXUx1zyHN133uVNEBGKakVKda5X2zxWq9TGIu1qLaY7KHVcfKySajBXv5Qwhp2a79iukU7ZiXxCx4NPdL2V+HwE7FK1MN9STtXG1mJKltt6pp55+vI29x15dO/5zb3SqwjbY1dYRFpt58ymBob+o9ZRu36zKq1S6LCtlL526SKlOtevbR7F6m+XHihVadOtfmY2IvPiPlWLGg9kYcO+7ChMv8q0Id2luvd2IpssNOvD2LQcvFcxDKLcWqgqpi505NlDrJGrlJanu7QCPmklxFpdWxn2St3yBwNa6vgjUlGmL8JhXVUKBjT1SHdbfp8MNlRiQXRqqlJ7SGMZHKeFq3y1ufmJYd/5svK/2iVuj2qop/rTApp76Pxg2dl2n0m6vWqZ44ncRyvWbr7rcq1YsVOlX+oKVZWirZYxO6Pgvsrf/yg0cEE4xEAypIOMkBVyQ34oClWhPnSALtATBsI4mAQzYT4shTWwBU7BRbgOd+EZvIMv8AsFujAe82BhLINdsQf2x1E4GzfgbjyAp/ESXsOH+ALf409MZYKFsliWzHwsI8vJ8rPCrCIbyg6yk0xxk2fkBXhxXpnX5z14Xz6Uj+Mz+Aq+ie/gx/gpfou/4l95muAiQniEX2QXeUVxUVHUEo1FG9FF9BFDxBgxRcwXZ8Sdeujxw8PBNeHacmu4Sm4vd5J347V8G34CP4Nfya/jA/hC/rrACfUEg9BHGCZMETYI24RwQRZsQrqQLRwSTgnXhPvCU+G18E74LPwSOfE/0UvUi23E7uI4cZa4UNwhBoo2MVc8IN4QH4tvxW+iXeKkBpJWaiv1lIZJo6XJ0kxpgbRKCpBipXSpXNojHZauSE+kD9IvcqX6xKgNdaCeNJym0AJaQxvJn6IpkXKpkGrpEJ2iq/SAXtM3csAD9aFDM3QUWhHm5svvDurQhrliu32dEYe2WfvO18HoemM/NGcncmOIU+U2ZujInI15zJtN0Mxh8aGcav7TqIQQW1ikV3iEKSQuAkp37dx8+d1BHdqSnWtJB7bH9Fqoq1M3JAgdGJQvQxnmsnFRnw4a4JTaNnJqndpPjRQJmi6EufnyuwM6TGALFBP2KxX73bF+r3dpZTZ0poioQHktHaLYG3yCnBAZr386sdMJNlJ3FJCRetLKJHGVes2c8Co43THIeA3xwaItAnz5IQUxZ/yF0aFLxdEnE80ouFhI/0fV7ycK7s98O0KjTnYkoXtszmuEVcaJM6d6j1n/9KRB6dmSaPd/JmdPYcCRwY/PHK3dU63HTaZqS8q1QHWjOApyjpuWWkBEbLwc7x0Xb42LNZw9F5E4bOGwfdg6orDiNMJ+97YEyRch0ssaXTEUITQSxDuknhVDnVkdJFDqoF0Rg05e/LB8XtVa5HIWi9li0WNdSKvhxo+Gyt54UAsohcIpPzXQUDKhRh2uOQ43M6I7M50R0/56sTQk2TEsuUFBQtgupTglea/6zUlSP4lgzJ3NX0n9phey7Bk5wQsKGCqzjfeZ+ke+gCY10Ux75Icn2ZdKoJJjS0EJnrz/rjkH+k3m4KzXr7q7mqEwV8hQjzxKIblCGEOfypdzTTpwgCGZIPZWkLM0Di1M++Ee60SQ8/NYXqPcZh7enWomH2nAhdtKkBEob+g2zqiqIS8GFmGna//ZoA1lUH26NrTRyu8s2HFQJ/zH9dm2bgMs+n/EQULmGtBY8aDpE8OQDJESeVp3S2eCMlMGh5UTXXW0rCv0bSRWZQrbBGoG5oE/ubWiW+YM+bkIWk6aDdsEiK0MwDdnUY1jjjGqpc98HSqwvAl+OPRQSu3DD/M/WO480iwHLyXTqK2Echtwpy/08eukiaVKHlE0kL+nhOEF1RYVfWhL9mZCoISuIZpwh+VTbUVYR3G7kqgpgc/RVZyxQk9TDgW6DKkXLv7I8MgZwDEwHpB+vIxuv7bOSrYtMeN46YsT+V7O+DDKHec52rmyPS9j2T/nVU8YRzmIGJRLFdwEB2lIsy3zgVarOZI8Cy+IxaLPTeasFrPVqrOarfIOskIls+wty2bZZGDa9TiBpc5XpaS+U//FcrdSrvVjdAX8/jxiKI8NqnrkGhLUqPLjCWGRfKPO+r/rIVNmYfRCh+uzJLt24IIPlI3O5rt2la27XhR9Tepa5c9VKnLpNOfclR6dO0eduHi5+Ud7Ba36fFDczhw7kilu3fgIXq+Ay8yeHsZAlJpOZXJ8Eog3cmjuBRJDs8Q9GxKqTtcbap9z2K8YSwia7mx+L8+nEbcNqiqasujMlxF+6UJXfikeVy4waKE41J4l0Sz4UZ1aX8UXz9wP2atuMkRlm9Qay75RoQEHxMFEaG0N9hB0dT3vMNxhquBH+wgHafWA4PuIJO0pMy7s6e8pQETYbgL8FFYliamS2G2C/fJ2panR9YB93wcGKzvEv94QRhVHx+dXWZNkqgqtFQ8HG4+ODWCQkWsw8EDppAbVLem+eKYbvNQvGym38cugXvZ5VSO2XTZFiRTo9e+ys62vwYmRMes37Fy65/SB1qeSDq9btW29OWqm1o+W3xy+YmlB1nku50mTavvKbtz0NDWoi2eqswxS+WKbG3vXtqGBTrd8KKVF70bmFh3S+dN7eYfmjjD7bp94fmuipTlUYDKUlPbWnJKUat8c30qybnwySAljyJuApBH8xUOk6tzNoH5s+EIanIO7b6+DRgV9kjRiqqaiDfXxLzHbGyL5BpVsUGfpvXr3UaP4tZIulFNukMqCCNjorK6fQyTNq9Qwt9nBQar9WJUlcuPKiSpLnxUUo3LZueaqXBR3yVykVujWXDeQ56VUSytqppJUAVpcvR3T9/Tq/N/wdiRIeDPS2xquRqP5XukgqSRjO2kcyvCbijM9o9t06dePNKhipDirad+/Gv2ROu22Y/pGblD9hqt+xBTiaGJdjWRK50aO7CO0g70nB5okkjUtpovej6Y7VPT4rD9tZ9LKJrttw3EalTjVVveMf0eqXEd5mrY3gzXb96iv3kDP8OW0b6paaYQEf/LggrMPIwMXMGgMCE2gCTBoimUAsSyWA4blsTkgtsAWwLAltgPE9tgBGHbEToDYGTsDwy44EBAH4RlggAAgoSksBl66bOXaEN2uZ5tO4O3condXyAICAODfP0C4GjzOHSEcWJVqlb0QX7NaFS943/PEbZD15aB1atOzK3h3bL+dxc6VKwCQ6KhAEqvOwAkMZGh/QLpvf3Eu4GJczHxsNVvN/dzP14t8t855Rhw/lshGtloreZ29rFc1OYl+Xb/uaNjH8Z77nT2d1vmK/h8yOWRmyP6Qp9Ipc8nGcqzcLh+SYD56D/O60tYbJ2LNhSF2htgQyLStfJ1s/yXx6L84r/MNZJmOfy/NsRwZfC7Is6bW9zsejCtmg6y5R5IWORcQE7kUfGIoSNIty9Knzxta3+/69FbeS1ESe6/W9+WVuFNuDcKm1htb398Y5j1317yWzZWgBFW0m0OfOWTNoWgOJXMoAxWqRz9vghOcxDF69Jg5/MV5Gta4oqyivKJlilbsSVdzLXXWspHNJLzIEY5GjtlZSLRbA33WQNYaKFoDJWugDFSocoKTOEYZ4y/O07DGFWUV5RUtU7RiT7qaa6mzlo1sJuFFjnA0fAw6K2hH9P96vHsWEYqIUEKE8gYVqpzgJI5RxviL8zSscUVZRXlFyxSt2JOu5lrqrGUjm0l4kSMcjR6zsXDtFtBnAVkLKFpAyQLKQIUqJziJY5Qx/uI8DWtcUVZRXtEyRSv2pKu5ljpr2chmEl7kCEfDx+CGTbZevhwRtpn4wzhGcsYm/S1Q3LDK/DGu5w1xAx6Px+Px+JN7PB6Px+PxeDwej8fj8Xg8Ho/H4/G2RxAEQRBErCMIgiAIgiAIgiAIgiAIgiAIYguKoiiKoiiKoiiKoiiKoiiKoiiKoiiKolHNiDH4wiAYxz4hc+vGYHQYo88YWWMUjVEyRtkYFWNUjXH9xL4BhmEYhmEYhmEYhmEYhmEYhmGbx4BiEIxjuGFVD40uX5aOYy/tILxgkj0K0VjWLLVg6XhfwxxIuH1zdKJmAXVzWGkBd5vgHlPca4r7THC/BTxgcOBd5mqhFnA4HA6HO9Ah0y2omRghMIIQopKUAEGS81KrBIIX4JRBNk9NBK6Zggun5SQldQo3jm56cWpIYGokwRg+9SSorhuHwXhtuhF0niYnsPKKCvLgsH342T6K2D6K2T6K2z5K2T5O2j5OTXbMadtHnu3jjO3jrO3joe3jke3jG9vHd7ZPLtunUrZPrW2fsmyfOto+dQalrkrdlXopDVMap7RR6ZrSdaUbEc0HqxtIXdvHJ7ZPSbZPJW2fWtk+jbF9Wmf7tN6ro7WuF/4eDvzwJwgnwYQQShgFiCQK/suJIZY44kkgkSRcuPFQEC+FSKYwRShKMYpTgpKUojRpVCaT6tSiEU1pRnNa0JJWtKYNbWlHN5azkWMc5ySnOE0eZzjLOc5zgYtc4jJXuMo1rnODm9ziNne4yz3u84CHPOIxH/AN3/ELv/EHf2FLMnLIX4FyKlghClWYwhWhSEUrVvFKlEseeZWsIiqmEiqlVKWpktJVS7VVR3XVQI3UVM3VUq3VRu2UpY7qrK7qrl7qo77qr4EaphEapdHKUa7GaZIma4qma4Zmaq4Wap02apM2a4u2apu2a4d2apd2a4/2ap/264AO6pAO64iO6piO64RO6pROK09ndFY87KcDdJAO0WE6RsfpBJ0kR6No6vq4olXQPanvbcyv3F2lZ3/ILFiwBJEJMhZbMDH353TciNw2IrL0mXOeQJTYHUEUlxXEYrtmdcLiV+cCGUE1+jNtbk6j6a1jep6FjejqXQffKM6ceF6IK6gHwR7x6QgJW4H1EsAceDXs56+2BLxTkc8vNTUFk9arB4ilOOXaOMN9NuJZo6nx9oGJrQ4kTqLFbLHVbLV1uTeonuksMd6IunfFZiR1XGj3w5FLlQLgA5boIedusUbM92JEpsiYZlJoxTI/QrnQS0mUxqp5h2c2Z2m8bZExDnhgEG0MWJ316SyaJrXzvKyrggYvRQv2YWQmMV6dbUti6jTlnKKLCCUlXgZovI2QtjkgkwvqpSkzz+ujyAcUBvOhnYo6ohbsVDLadRLhhx+KxMtlkRGxMY8okYobuZwy3Cki5akQOK8le7oxxl60A8FW0Dgfp8dRlY8aauuI04wg3Yete+fsVLk5oJC6zJCqIfjN1Xem9OWk5gPWt5jYZwx68KSXFzYkFNNhB5CxU44T0fa+FxqoYvr3WOPgG3EVPHd5GZFtTWvNx3WDll1fol3lpdWiLEKqYKngjElvqKrzW/X2dRs6y/CW+ECYryxfHbeOrWEpMtZPHHXQh9qpJVGqplMmUwweDsKG6nO0GwobammLrShuYKhkWvvaNLqgpncveoZMaj7fhlpuzYtcOElmnE1ZEwu6EKxH8Q3ZQ9ec2gy5PPmUdaPQh66th9R49I5iSB0Jm2qh2saQdGcVzMbdWC2MBgTFqzcfcmjoqmIcpJviFfClN027SV9XtHvrTS29ASVRnHkYSywtqjjeOxnXCkuX4gkmzFQ2x91kH26mwnyXDtDWxaHRpfn1Uy9vpOhTDvT6YUZ/6ElWyUwLIEbtfNf73pR1D5XeZ1mjsg5Yj27vKQwZbh0Ldl7y/ec9DyHUtyvTXZ6+wL63YN4+s7Qh1nomlNOIm10qmu6jMlAHzwoGaO37zPoHK6ad8sTfnwrf68pSWzlRulTjCSxtvep5WehsQg9acCdwXjT6NjyGx3A7nsSTuOMo9PvuxE5cRA2XqQNPU4aKeJXKNBu7aBEtuv0IWkJ34STVaRW+pTU0ij9PZv4CnUAb2jCCXvQigwya0IQJmICeRPouim47mnHAoz5Q6XH3MrowEd3oxMYVtKADhLxbRb87CQM43pkCcgOGoODEoD7qdQ5hDiLMxds8D8PI4u0/MYLb4FyMf8dg3KDkCMz6mGjyOfV5BOHArBF3MOhjYmAip7nT4CErqYCGnWlD/kepF/1o59uaMIBSD6a4Lcit3Y7paMaMq4BWFEp9GDyrjNkHujCEidjWjQg4RwS0v39O+TSZ4kwmOcmpwABEwcUJmRAS6kh+/Od3Yu5kOjBcEuSKvBGMuFpuKB0rxKZcFOxHXmYOqtIrFn4j9U+bgcnIYQaqmIoZmI5+DKJdH/nSgpMHSggXKdCG8SepduQRPZ4oUTfwmAAcrzfIumd8bA239iOMUMJxsCDC/5x0i24zdiieeFylFV13vPkLlKXR9uDZ4W9+XhQhRBJMMKE3I+IYJrf4KOxBgdqFUMh9R2HwHQyiAAnH8Dn88n4lkgjQWfkuEUsFJbPMcXACPXz/PQ83dlszWIy/z+Qqelwcpb1Yzne+muMEpBTejsYPFMCdicfxQxdRgesibMofUgeMi4T0/W6Q5/+G1EjtjhNAUeo45iQSP5TiSPT9mZ8U+KXoipNJLt0QBR4mhogE2sJ0JD/+84OxJiMCeNUM62CCJcgNpSNJ7M4X+5FXv9Mc9X16YIbb/gSQ0/DYeZ1iuIu6+oZ7oN+0+baDibtQccMT5mdZfqqZCDJ+OF/mv7YHL0Up5TeGALYeHIubZIqTcuFCluA6IWBodChRxFCQIpSkrA+mdiiQMCLqePskClOM0t5OEUQwBQi1oUL/Veaty/XqNTRHrocsIlNk2uqZfYcOGqB6solsJbNW79p/dK8+6i0HyuEyZ/UJAwdl52ianCMXyRWrrxs6aEAvbZG75AF5bPW8oSP6DNXF1a+PGN13uO7Kx/KlfLeZn50jfQ75rfxZ/rn6/9nZ5SsYh3TKCBm7uit7zMhskyxLyLIyjdJtVF9GWdYMVnv+Xr5f+cHlO6Wlc3jo/ig/oPzA8hxoFL+0CCmkkUk9mpFFd/oznFymsMKD8+OXa86fx3+elyPOnEJyPGyUpQnBJ2rVvCm/OW/S5nnHfd+Cnz/QJm+dTiJ+BKoawr99JNHEkvCBkL9WnopKI52aSmUnu9itEiqpUiqNSGywUAUaKxVQ08+Jx0sJUihHKmlUowZ1TxRGKkdjNE7jEWHMkDFa2Dy5uoqiI2rsCOzRi8pQhxqq2DsRTa48hZQJax6dSDJ7sJhNc/bO1HI9sb2CCshYJe/b4H0eCKLVjBZAT4jcmItk+MiMaUq7NXrKh5ey3XJRg2hCJ7MS5UmjKpnUoh6NaEYr2tGZ7vSmP4MZzmhyRQ1mINC2CGGKIxKg8xOxcQJzQSG6pCSizP7yiIqoC/cW6YiaqB/rUp/BrgFMsqnEysnkEkkpMsllHs/5VjXUSL01S0u0Ttf1qfE38aaN6ctdK0SbXCtYm92PCSWACGJxkUwJypKmLRw1tdV/N23DkKjtrpWkHbRxsnZiKKZdXDyO3C33HAoimsR/RPKLUkilKjWop70h99I+DEHaHzZ24Ct0EEMBHcIQp8MpxJHTCuqoZ+qtaB0jN0rH3XideF5RnJmOIJ1aNKCZTiaQp+RpmSfPyLN0LgKdTyMvyIuQJ13qM/2E4rIboCtuuK5WAHEqjuZ0LbK8Lm64RbSRKkcQN7Xc6ZbQ0Ly/LJJ4PBTRRAxlNSnsbpqCIVOT6bWrayqGerFpWoicLmeOzUhvygVyoVjsVtMizqiFWOKW09LBNeoqlpkULSexslVBK+CmapVbQ6vduloz0ZjWxaf12emncMMyp7XbEDcFSBQtVp9bUpH2C4HiY2m3rkNd6iGhUqBqw1gevoJSlNc8LNKoovnzxRmai/kKzcJQRbMxVNWcgiBuaMP488MS1TWXXRxgx8Q6fG+cQg0c+kbL7htoFpiOQNP51epOqo5c9W2wj9biJn/veTzNa7dpylV87j/+Vpv/vyTVaqN4hCv9O/SuOUHstXVpXRKCwzpmWlDroPIPg1DKUY0RTGAKhzil0qqjRppqkkwVc8d8YF2MKO6Z7Y32Jno93mRvMW95b7q3nneX91Ch5EJlkyOTGyX3TO73j+Mff9vm9ldD8VKedEYyke0cIU9lVVfNTLypYm4bX6zNp3mjvPFel9c7c7VS3384IPs3wPWwn9r2nXPtCDtsnX+f/9T1Y9/3zp+ZPzK/Vn63/EUfnsiv8eH/b2e//eLts7f3bgv+K6+tiiZBf2z4mJd8ze/KX2X8zzcDzeCPxgw3I02OGcc4Z/piZSzaM4KZrKATnRlOH/oyml4MZTlDmM061tPPbE0HunSBucYYxwkPJ+Y573h58lMGMYfBDGMeI0mhLOWoYKCjKlGZKlSlGhmn6X9fDQYwl4Fkk8VKerCInhyiK+OYzwEmspgFrGIsaxrqz2UURzhMDjvZwST2sod9dOS8/YOeJY8z6qXeZ+6PV59h72r1Z6jgf5zjdOMJT3nGc17wUoM0mFe85g0+3uFd3uN9FvIBb/mQfD7iYw5qAJ/yGZ/zBV9yjK/4hm/5ju81TMP5gR9VWVVUVdX4iZ/5hV9VSUP4jd+Vrgz+4E+N0Ej+4m9lqjr/8K9qqCb/8b9qqbbqaJTqqh620GhlS8xQAzVUIzWWkaUmcshP/gpQoILUVM3UV/0UoQJqrhaKVJQGaqiiFaNYxSleCUpUklqqlXI0hjt8onEaL5fcaq0JaqO28qig2qm9vCqkZBVWrsYqSx3UXT14qCIqqmIqzmO+VipjmMpUpjOFycziBMtYygY2soVNbGYrR1WRXM3VLM3RPM1HgKBlXKfDPcIzf8OyvgTIz894wHzvh1j/f+v42GomSDLCXBKYQeg4p2j/6PhE+rVxj27r1yX6+9d5+oIo69eTTPZ4yZN0VKyyVp5kjo5XOJEzJ2pkYpIQHYFjbovEqQNL0doxK7KeJNoL64vEFEXwJcSV6N9cHBNLVkoKmlr3iSYKwupXceo4QfWJWEPrcOqWI7beJnrtmK3BLSpdIoiuXpbqdGoKUcoCR4Zab+fMmnxUWZ+rIUTrN9w8wH3r9OgCbm1y4tV9H+DRZNy6viSshbXuahqFW6Mdk2x1sa2djjKDd12QR9YjlJRoJoIRjotNpfm4XSeRZ0RxcP8EgpiEz+Fz3PTDwzHURyMhGxf/iVt75jhwsezWUZzFo8JrEyVnnCW3lrqEXQhWQ+xHGHfm5eJU3FyZ5R1U3c1BNMSsZuNEc1lxdeA/3HoP9Rs4zryL25SFo8p3vYBHb3DzFLtUGnc5QTmYAThdfRmqaHkEKgg9JWD+DKsMbs0lihe3OWanbHlkufoLOMrDUj+A4/gbj2YC+dgsSdSHxB/i7eHtRHFRNt2nGY76Eq2CwkrOkWSNIEXIMEvDYpGLGY6nU41ZWellCIDs0uTrSjn+Ip03Q5eQfo2g0ZILJ9Lm0Zg5cx3OPZwhYNI6heMjmsnM0b/8gPIpOlCGD6Vh6CiXoGvOqgW31Hd0m9vsDCoMQXaPiOTjusAU7dGP0g00DynwRKvK46Wn8hWv8S3rEuEUaBeBTRxnYwV4eYxUbiav/BKiK9bR28yxNQ1WoPDAYm1dneMDO6xg/2WcVkUsmBcWZ+U9xipXe5ULalu8ZbtePsrRrbwORiqKGN5uY/UjyOo52Y5028x2rI6irdXbdmTO6i4crYEtBzOJn2jh4hlEm8mzGgHHTCmtIQjWDekE54g/sniRI34U71n/26bWrP6EbdWxHWGO9TM3WIsx4p6YIqpHMT7HKi6Gi51BSWCPOGitThy9IFzcuK2IG9avtsNKHFVp/HLiqEWitHXJdvyeWMch3gZbYIXajiaOo56VYlsFQpODyLF6LkGr1/WLTqZ0zKHj1RC1aatYSIMGunnujissujIUPT3fxTY/En3Cf+LTvYGkKN4VQSQqZSVCaKEG7CeV8qSSipfm9GI0OQxiOF6a0os+vzeDKIuX2gxlKI1qwyAGMJAcsn8c6kc2/Q75nf3oS1laA0FmEL02WgMYQ4hKWSGHshnEiOiHUilL+fuBDJpT271+U2rTjoz9g8oMnJHtYkUyDrUJVV1/heCZvD1Hoqwuut2P4SW3R+DN0Qyg1zs1yBSF9sgNmBidw0iySacc5Rh7v3VZetOPgTEu6UM/yr7xfuRQjtyExdz3OYvxxuxNpAIAAA==') format('woff2');
  font-display: swap;
}
</style>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
  @import url('https://api.fontshare.com/v2/css?f[]=neue-montreal@200,300,400,500,600,700&display=swap');

  :root{
  /* Core brand blue */
  --panel-blue:#2B22F4;

  /* Text */
  --ink:#2B22F4;
  --ink-dim:rgba(43,34,244,.68);

  /* MORE transparent heavenly whites */
  --paper-strong:rgba(255,255,255,.62);
  --paper:rgba(255,255,255,.48);
  --paper-soft:rgba(255,255,255,.38);

  /* Barely-there structure */
  --stroke:transparent;
  --stroke-2:transparent;


  /* Heavenly glow system */
  --glow-main:
  0 0 160px rgba(43,34,244,.05),
  0 0 300px rgba(43,34,244,.03),
  0 20px 80px rgba(15,23,42,.22);

--glow-mid:
  0 0 100px rgba(43,34,244,.04),
  0 14px 60px rgba(15,23,42,.20);

--glow-soft:
  0 0 70px rgba(43,34,244,.035),
  0 10px 40px rgba(15,23,42,.18);



  --radius-xl:30px;
  --radius-lg:22px;
  --radius-md:16px;
  --radius-sm:12px;

  /* Mobile-first spacing scale */
  --space-xs:4px;
  --space-sm:8px;
  --space-md:12px;
  --space-lg:16px;
  --space-xl:24px;
    
      /* ========= Fog / Haze tuning ========= */
  --fog-white-1: rgba(255,255,255,.18);
  --fog-white-2: rgba(255,255,255,.10);
  --fog-white-3: rgba(255,255,255,.06);

  --fog-blue-1: rgba(43,34,244,.10);
  --fog-blue-2: rgba(43,34,244,.06);
  --fog-blue-3: rgba(43,34,244,.03);

  --fog-blur-strong: blur(34px) saturate(125%);
  --fog-blur-mid:    blur(26px) saturate(120%);
  --fog-blur-soft:   blur(20px) saturate(115%);

}

  *{box-sizing:border-box}
  
  *::before,
  *::after{
    backdrop-filter:none !important;
    -webkit-backdrop-filter:none !important;
  }

  html,
  body{
    margin:0;
    padding:0;
    border:none;
    outline:none;
    box-shadow:none;
    background:transparent;
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
    overflow-x:hidden;
    transform:none !important;
    filter:none !important;
    perspective:none !important;
    contain:none !important;
    will-change:auto !important;
  }

  html{
    height:100%;
  }

  body{
    min-height:100%;
    font-family:'Neue Montreal',system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    color:var(--ink);
  }


  #cloud-soundscape-root{position:relative;min-height:100%;width:100%;transform:none !important;filter:none !important;will-change:auto !important;perspective:none !important;isolation:isolate;contain:layout style;}

  /* =========================
     Layout shell
     ========================= */
  #cloud-soundscape-root main{
    position:relative;
    min-height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:18px;
    z-index:1;
    background:transparent;
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
  }

  #cloud-soundscape-root main::before,
  #cloud-soundscape-root main::after{
    display:none !important;
    content:none !important;
  }

  .panel{
    width:100%;
    max-width:1160px;
    background:none;
    border:none;
    box-shadow:none;
    outline:none;
    display:flex;
    flex-direction:column;
    gap:10px;
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
  }

  .panel::before,
  .panel::after{
    display:none !important;
    content:none !important;
  }

  .content-stack{
    display:flex;
    flex-direction:column;
    gap:10px;
    width:100%;
    background:none;
    box-shadow:none;
  }

  /* =========================
     WEATHER CARD (primary)
     ========================= */
  .weather-card{
  position:relative;
  width:100%;
  background:transparent;
  border:none;
  box-shadow:none;
  overflow:visible;
}

.weather-card > *{ position:relative; z-index:1; }


  /* =========================
     Top grid
     ========================= */
  .top-grid{
    display:block;
    width:100%;
    background:none;
    box-shadow:none;
  }

  /* =========================
     Main Weather Card (Compact)
     ========================= */
  .left-now{
    position:relative;
    padding:14px;
    border-radius:20px;
    background: rgba(255,255,255,.06);
    border:none;
    box-shadow:none;
    backdrop-filter:blur(18px);
    -webkit-backdrop-filter:blur(18px);
  }

  .weather-top-row{
    position:relative;
    display:flex;
    justify-content:flex-start;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    padding-right:100px;
    min-height:120px;
  }

  .weather-main{
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    margin-top:6px;
  }

  .weather-temp-block{
    display:flex;
    flex-direction:column;
  }

  .weather-temp-block .temp{
    font-size:4rem;
    font-weight:740;
    letter-spacing:-.04em;
    line-height:1;
    transition: opacity 0.3s ease;
  }

  .weather-temp-block .feels{
    font-size:.95rem;
    color:var(--ink-dim);
    margin-top:4px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.06em;
  }

  .weather-cond-block{
    display:flex;
    align-items:center;
    gap:8px;
  }

  .weather-cond-block .cond-icon-img{
    width:120px;
    height:120px;
    object-fit:contain;
  }

  .weather-cond-block .cond-text{
    font-size:1rem;
    font-weight:700;
    color:var(--ink);
  }

  .weather-moon-block{
    position:absolute;
    top:-5px;
    right:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:0;
    padding:0;
    background:transparent;
    box-shadow:none;
    z-index:10;
  }

  .weather-moon-block .moon-img{
  width:250px;
  height:250px;
  border-radius:50%;
  object-fit:cover;
  transform:scale(1.15);
  clip-path:circle(42%) !important;
  -webkit-clip-path:circle(42%) !important;
  filter: drop-shadow(0 0 15px rgba(255,255,255,.45)) drop-shadow(0 0 35px rgba(200,210,255,.25));
}

  .weather-moon-block .moon-text{
    font-size:.82rem;
    font-weight:500;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:var(--ink-dim);
    text-align:center;
    margin-top:6px;
    position:relative;
    z-index:2;
    transform:scaleY(1.2);
  }

  .weather-moon-block .moon-illum{
    font-weight:700;
  }

  .weather-moon-block .moon-phase{
    font-weight:400;
  }

  .weather-details-row{
    margin-top:8px;
    padding-top:8px;
  }

  .weather-details-row:last-child{
    padding-bottom:4px;
  }

  .weather-hilo{
    font-size:.88rem;
    font-weight:700;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:var(--ink);
    margin-bottom:10px;
  }

  .feels-inline{
    color:var(--ink);
    opacity:.7;
  }

  .hilo-sep{
    opacity:.3;
    margin:0 2px;
  }

  .weather-stats-grid{
    display:flex;
    flex-wrap:wrap;
    gap:6px 14px;
  }

  .weather-stat{
    display:flex;
    align-items:baseline;
    gap:5px;
  }

  .weather-stat .k{
    font-size:.68rem;
    color:var(--ink-dim);
    font-weight:600;
    letter-spacing:.06em;
    text-transform:uppercase;
  }

  .weather-stat .v{
    font-size:.72rem;
    color:var(--ink);
    font-weight:700;
    letter-spacing:.06em;
    text-transform:uppercase;
  }

  .weather-stat .pollen-val{
    font-size:.74rem;
    font-weight:800;
    padding:2px 8px;
    border-radius:6px;
  }

  .weather-stat .pollen-val.none{
    background:rgba(150,150,150,.20);
    color:rgba(100,100,100,1);
  }

  .weather-stat .pollen-val.low{
    background:rgba(34,197,94,.18);
    color:rgba(22,163,74,1);
  }

  .weather-stat .pollen-val.moderate{
    background:rgba(234,179,8,.18);
    color:rgba(180,130,8,1);
  }

  .weather-stat .pollen-val.high{
    background:rgba(249,115,22,.18);
    color:rgba(220,90,15,1);
  }

  .weather-stat .pollen-val.very-high{
    background:rgba(239,68,68,.18);
    color:rgba(220,50,50,1);
  }

  .weather-stat .ap-val{
    font-size:.78rem;
    font-weight:850;
  }

  .weather-left-stack{
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .loc-cycler{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    z-index:100;
    position:relative;
  }

  .loc-arrow{
    display:none;
  }

  .loc-arrow:hover{
    opacity:.8;
  }

  .loc-arrow:active{
    transform:scale(0.85);
  }

  .loc-cycler-center{
    text-align:left;
    width:280px;
    display:flex;
    flex-direction:column;
    align-items:flex-start;
  }

  .loc-name-row{
    display:flex;
    align-items:center;
    gap:8px;
    position:relative;
  }

  .loc-dots-row{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    margin-top:3px;
    position:relative;
  }

  .loc-name{
    font-weight:820;
    font-size:1.4rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    transition:opacity .18s ease;
  }

  .loc-dots{
    display:none;
  }

  .loc-dot{
    width:4px;
    height:4px;
    border-radius:50%;
    background:rgba(43,34,244,.15);
    transition:all .25s ease;
  }

  .loc-dot.active{
    background:rgba(43,34,244,.5);
    width:14px;
    border-radius:2px;
  }

  .loc-gps-btn{
    width:16px;
    height:16px;
    border-radius:50%;
    border:1px solid rgba(43,34,244,.3);
    background:rgba(43,34,244,.06);
    font-size:.55rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    margin-left:4px;
    opacity:.5;
    transition:all .2s ease;
    flex-shrink:0;
    color:var(--ink);
  }

  .loc-gps-btn:hover{
    opacity:.9;
  }

  .loc-gps-btn.active{
    opacity:1;
    background:rgba(43,34,244,.12);
  }

  .loc-gps-btn.loading{
    animation:gps-pulse 1s ease infinite;
  }

  @keyframes gps-pulse{
    0%,100%{ opacity:.4; }
    50%{ opacity:1; }
  }

  /* Search toggle button - orange star with pulse glow */
  .loc-search-toggle{
    position:relative;
    width:auto;
    height:auto;
    border-radius:0;
    border:none;
    background:none;
    font-size:2.8rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    opacity:1;
    transition:all .25s ease;
    flex-shrink:0;
    color:#f59e0b;
    text-shadow:0 0 4px rgba(245,158,11,.6), 0 0 8px rgba(245,158,11,.3);
    line-height:1;
    animation:starPulse 2.4s ease-in-out infinite;
  }
  @keyframes starPulse{
    0%,100%{ text-shadow:0 0 3px rgba(245,158,11,.5), 0 0 8px rgba(245,158,11,.2); }
    50%{ text-shadow:0 0 8px rgba(255,170,20,1), 0 0 14px rgba(245,158,11,.6); }
  }
  @keyframes geoStatusPulse{
    0%,100%{ opacity:.5; }
    50%{ opacity:1; }
  }
  .loc-search-toggle:hover{
    opacity:1;
    transform:scale(1.12);
    color:#fbbf24;
    text-shadow:0 0 8px rgba(251,191,36,.8), 0 0 14px rgba(251,191,36,.4);
    animation:none;
  }
  .loc-search-toggle.active{
    opacity:1;
    animation:none;
  }

  /* Soft breathing on default NYC  draws eye without implying text input */
  .loc-name.pulse-hint{
    animation:locNamePulse 2.8s ease-in-out infinite;
  }
  @keyframes locNamePulse{
    0%,100%{ opacity:.45; }
    50%{ opacity:1; }
  }

  /* Search dropdown - opens to the right over location name */
  .loc-search-box{
    position:absolute;
    top:50%;
    left:42px;
    transform:translateY(-50%) scale(.92);
    transform-origin:left center;
    display:flex;
    align-items:center;
    gap:4px;
    background:rgba(255,255,255,.15);
    backdrop-filter:blur(20px) saturate(120%);
    -webkit-backdrop-filter:blur(20px) saturate(120%);
    border-radius:12px;
    padding:8px 10px 8px 14px;
    box-shadow:0 0 30px rgba(255,255,255,.12), inset 0 0 20px rgba(255,255,255,.22);
    z-index:200;
    opacity:0;
    pointer-events:none;
    transition:all .18s cubic-bezier(.4,0,.2,1);
    white-space:nowrap;
  }
  .loc-search-box.open{
    opacity:1;
    pointer-events:auto;
    transform:translateY(-50%) scale(1);
  }
  .loc-search-box.open ~ .loc-dots,
  .loc-search-box.open ~ .loc-arrow{
    opacity:0;
    pointer-events:none;
  }

  .loc-search-input{
    border:none;
    background:none;
    outline:none;
    font-size:.72rem;
    font-weight:600;
   color:rgba(255,255,255,.9);
    width:130px;
    font-family:inherit;
  }

  .loc-search-input::placeholder{
    color:rgba(255,255,255,.5);
    font-weight:500;
  }

  .loc-search-close{
    border:none;
    background:none;
    cursor:pointer;
    font-size:.65rem;
    color:rgba(255,255,255,.5);
    padding:2px 5px;
    line-height:1;
    border-radius:50%;
    transition:all .15s ease;
  }

  .loc-search-close:hover{
    color:rgba(255,255,255,.9);
    background:rgba(255,255,255,.15);
  }

  /*  UNIFIED HAZARD POPUP/TOOLTIP CARD STYLE  */
  .hz-popup .leaflet-popup-content-wrapper,
  .hz-tooltip {
    background: rgba(8,8,20,.94) !important;
    backdrop-filter: blur(16px) saturate(140%);
    -webkit-backdrop-filter: blur(16px) saturate(140%);
    border-radius: 10px !important;
    border: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 8px 32px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.04) !important;
    padding: 0 !important;
    color: #e2e8f0;
    font-family: system-ui, -apple-system, sans-serif;
  }
  .hz-popup .leaflet-popup-content {
    margin: 0 !important;
    padding: 10px 12px;
    font-size: 10px;
    line-height: 1.5;
    min-width: 160px;
  }
  .hz-popup .leaflet-popup-tip {
    background: rgba(8,8,20,.94) !important;
    border: none !important;
  }
  .hz-popup .leaflet-popup-close-button { display: none; }
  .hz-tooltip {
    padding: 10px 12px !important;
    font-size: 10px !important;
    line-height: 1.5 !important;
    min-width: 160px;
    max-width: 260px;
    opacity: 1 !important;
  }
  .hz-tooltip::before { border-top-color: rgba(8,8,20,.94) !important; }
  .hz-card-head {
    font-weight: 800;
    font-size: 11px;
    letter-spacing: .03em;
    padding-bottom: 6px;
    margin-bottom: 6px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .hz-card-head .hz-accent {
    width: 3px;
    height: 14px;
    border-radius: 2px;
    flex-shrink: 0;
  }
  .hz-card-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 2px 0;
    gap: 8px;
  }
  .hz-card-row .hz-label {
    color: rgba(255,255,255,.4);
    font-size: 9px;
    font-weight: 600;
    letter-spacing: .06em;
    text-transform: uppercase;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .hz-card-row .hz-val {
    font-weight: 700;
    font-size: 10px;
    text-align: right;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .hz-card-footer {
    margin-top: 6px;
    padding-top: 5px;
    border-top: 1px solid rgba(255,255,255,.06);
    font-size: 8.5px;
    color: rgba(255,255,255,.3);
    letter-spacing: .02em;
  }
  .hz-tag {
    display: inline-block;
    padding: 1px 5px;
    border-radius: 3px;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: .05em;
  }

  /* Leaflet control spacing for bottomleft stacking */
  #hazard-map .leaflet-bottom.leaflet-left .leaflet-control {
    margin-bottom: 4px;
  }
  #hazard-map .leaflet-bottom.leaflet-left {
    bottom: 6px;
    left: 6px;
  }

  /* Earthquake geology popup */
  .quake-geo-popup .leaflet-popup-content-wrapper {
    background: rgba(255,255,255,.95);
    backdrop-filter: blur(8px);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
    padding: 0;
  }
  .quake-geo-popup .leaflet-popup-content {
    margin: 8px 10px;
  }
  .quake-geo-popup .leaflet-popup-tip {
    background: rgba(255,255,255,.95);
  }

  /* Wildfire popup */
  .fire-popup .leaflet-popup-content-wrapper {
    background: rgba(20,20,25,.92);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    border: 1px solid rgba(255,100,50,.3);
    box-shadow: 0 4px 16px rgba(0,0,0,.4);
    padding: 0;
  }
  .fire-popup .leaflet-popup-content {
    margin: 6px 10px;
    font-size: 11px;
    line-height: 1.4;
    color: #eee;
    font-family: system-ui, sans-serif;
  }
  .fire-popup .leaflet-popup-content .fire-name {
    font-weight: 700;
    font-size: 12px;
    color: #ff8c42;
    margin-bottom: 2px;
  }
  .fire-popup .leaflet-popup-content .fire-stat {
    color: rgba(255,255,255,.7);
    font-size: 10px;
  }
  .fire-popup .leaflet-popup-tip {
    background: rgba(20,20,25,.92);
    border-top: 1px solid rgba(255,100,50,.3);
  }

  /* Dropdowns controlled by JS click */

  .fire-item:hover{
    background:rgba(255,255,255,.15);
  }

  .quake-option{
    padding:8px 10px;
    border-radius:8px;
    font-size:.72rem;
    font-weight:600;
    color:var(--ink);
    cursor:pointer;
    transition:background .15s ease;
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .quake-option:hover,
  .quake-item:hover{
    background:rgba(255,255,255,.15);
  }

  .quake-mag{
    font-weight:800;
    font-size:.78rem;
  }

  .quake-place{
    font-size:.68rem;
    color:var(--ink-dim);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .quake-time{
    font-size:.58rem;
    color:rgba(43,34,244,.5);
    text-transform:uppercase;
    letter-spacing:.04em;
  }

  .loc-meta{font-size:.82rem;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.06em}

  .weather-alerts-block{
    position:absolute;
    top:10px;
    left:200px;
    right:280px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    z-index:5;
    pointer-events:none;
    max-height:180px;
    overflow-y:auto;
    overflow-x:hidden;
    scrollbar-width:none;
    -ms-overflow-style:none;
  }
  .weather-alerts-block::-webkit-scrollbar{
    display:none;
  }
  /* Scroll indicator glow for many alerts */
  .weather-alerts-block.many-alerts{
    pointer-events:auto;
  }
  .weather-alerts-block.alerts-overflowing{
    -webkit-mask-image: linear-gradient(to bottom, black 0%, black 60%, transparent 100%);
    mask-image: linear-gradient(to bottom, black 0%, black 60%, transparent 100%);
  }
  .weather-alerts-block.alerts-overflowing.scrolled-bottom{
    -webkit-mask-image: none;
    mask-image: none;
  }
  .weather-alerts-block.many-alerts:hover{
  }
  
  .weather-alert{
    pointer-events:auto;
    position:relative;
    max-width:420px;
    width:100%;
    display:flex;
    align-items:flex-start;
    gap:8px;
    padding:6px 12px;
    padding-right:85px;
    border-radius:10px;
    font-size:.65rem;
    font-weight:600;
    letter-spacing:.04em;
    text-transform:uppercase;
    backdrop-filter:blur(12px);
    -webkit-backdrop-filter:blur(12px);
    flex-shrink:0;
  }

  /* Single alert  larger and more prominent */
  .weather-alerts-block.single-alert{
    max-height:none;
    -webkit-mask-image:none;
    mask-image:none;
  }
  .weather-alerts-block.single-alert .weather-alert{
    max-width:100%;
    padding:12px 16px;
    padding-right:95px;
    font-size:.72rem;
    border-radius:12px;
  }
  .weather-alerts-block.single-alert .weather-alert-title{
    font-size:.8rem;
  }
  .weather-alerts-block.single-alert .weather-alert-time{
    font-size:.66rem;
  }
  .weather-alerts-block.single-alert .weather-alert-summary{
    font-size:.68rem;
  }
  
  .weather-alert.warning{
    background:rgba(220,38,38,1);
    color:#fff;
    border-left:3px solid rgba(180,20,20,1);
    box-shadow:0 0 12px rgba(220,38,38,.4),0 0 24px rgba(220,38,38,.2);
  }
  
  .weather-alert.tornado{
    background:rgba(220,20,20,1);
    color:#fff;
    border-left:4px solid #ff0000;
    animation: tornado-alert-pulse 1.5s ease-in-out infinite;
  }
  @keyframes tornado-alert-pulse {
    0%, 100% { box-shadow: 0 0 12px rgba(255,0,0,.3), 0 0 30px rgba(255,0,0,.15); }
    50% { box-shadow: 0 0 20px rgba(255,0,0,.6), 0 0 40px rgba(255,0,0,.3); }
  }
  @keyframes fcast-spin {
    to { transform: rotate(360deg); }
  }
  
  .weather-alert.watch{
    background:rgba(234,88,12,1);
    color:#fff;
    border-left:3px solid rgba(194,65,12,1);
    box-shadow:0 0 10px rgba(234,88,12,.35),0 0 20px rgba(234,88,12,.15);
  }
  
  .weather-alert.advisory{
    background:rgba(202,138,4,1);
    color:#fff;
    border-left:3px solid rgba(161,98,7,1);
    box-shadow:0 0 8px rgba(202,138,4,.3),0 0 16px rgba(202,138,4,.12);
  }
  
  .weather-alert.statement{
    background:rgba(59,130,246,1);
    color:#fff;
    border-left:3px solid rgba(37,99,235,1);
    box-shadow:0 0 8px rgba(59,130,246,.25),0 0 16px rgba(59,130,246,.1);
  }
  
  .weather-alert-icon{
    flex-shrink:0;
    font-size:.9rem;
  }
  
  .weather-alert-text{
    flex:1;
    line-height:1.4;
  }
  
  .weather-alert-title{
    font-weight:800;
  }
  
  .weather-alert-expires{
    font-weight:500;
    opacity:.7;
    margin-left:6px;
  }
  
  .weather-alert-time{
    display:block;
    font-size:.6rem;
    font-weight:500;
    text-transform:none;
    opacity:.9;
    margin-top:3px;
    letter-spacing:0;
  }
  
  .weather-alert-severity{
    position:absolute;
    top:6px;
    right:8px;
    padding:2px 8px;
    border-radius:4px;
    font-size:.55rem;
    font-weight:700;
    text-transform:uppercase;
    background:rgba(255,255,255,.25);
    color:#fff;
  }
  
  .weather-alert-summary{
    display:block;
    font-size:.62rem;
    font-weight:500;
    text-transform:none;
    opacity:.9;
    margin-top:4px;
    line-height:1.3;
    letter-spacing:0;
    color:#fff;
  }
  
  .weather-alert-areas{
    display:block;
    font-size:.55rem;
    font-weight:500;
    text-transform:none;
    opacity:.6;
    margin-top:2px;
    letter-spacing:0;
  }

  .big-temp-row{
    margin-top:10px;
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
    padding-right:92px; /* reserves for moon mini */
  }

  .temp{font-size:4rem;font-weight:740;letter-spacing:-.04em;line-height:1;text-transform:uppercase}

  .cond{display:flex;gap:10px;align-items:center}
  .cond-icon{
    width:30px;height:30px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:rgba(43,34,244,.10);
    border:1px solid rgba(255,255,255,.1);
  }
  .cond-text{font-size:.92rem;color:var(--ink);font-weight:650}

  /* Moon mini */
  #moon-mini{
    position:absolute;
    top:12px;right:12px;
    width:92px;height:92px;
    border-radius:26px;
    background:rgba(255,255,255,.52);
  	border:none;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:4px;
  }
  #moon-mini-icon{font-size:3.1rem;line-height:1}
  #moon-mini-text{font-size:.68rem;font-weight:850;color:var(--ink);text-align:center;padding:0 8px}

  /* Today mini block */
  .today-mini{
    margin-top:12px;
    background:var(--paper-soft);
  	border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
  }
  /* =========================
   Main Weather micro tabs (Summary / Metrics)
   ========================= */
.now-tabs{
  margin-top:12px;
  display:flex;
  gap:8px;
}

.now-tab{
  appearance:none;
  border:none;
  cursor:pointer;

  padding:8px 12px;
  border-radius:999px;

  background: rgba(255,255,255,.06);
  box-shadow: var(--glow-soft);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);

  font-size:.60rem;
  letter-spacing:.16em;
  text-transform:uppercase;
  font-weight:900;
  color:rgba(43,34,244,.72);

  transition: transform .12s ease, box-shadow .18s ease, background .18s ease;
}

.now-tab:hover{
  transform: translateY(-1px);
  box-shadow: 0 0 70px rgba(255,255,255,.18), inset 0 0 34px rgba(255,255,255,.26);
}

.now-tab.is-active{
  background: rgba(255,255,255,.48);
  color: rgba(43,34,244,.92);
  box-shadow: var(--glow-mid);
}

.now-tabpanel{
  margin-top:10px;
}


  .today-mini-top{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
    padding-bottom:6px;
    border-bottom:1px solid rgba(43,34,244,.10);
  }
  .tlabel{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:750;
  }
  .tvalue{font-size:.86rem;font-weight:750;color:var(--ink)}
  .today-mini-sub{margin-top:8px;display:flex;flex-direction:column;gap:6px}
  .row{display:flex;justify-content:space-between;gap:10px}
  .row .k{font-size:.74rem;color:var(--ink-dim);font-weight:700}
  .row .v{font-size:.74rem;color:var(--ink);font-weight:750}

  /* =========================
     Middle stack / metrics
     ========================= */
    /* =========================
     Move metrics into LEFT card (compact grid)
     ========================= */
  .now-stats{
    margin-top:12px;
    display:grid;
    grid-template-columns:repeat(4, minmax(0,1fr));
    gap:10px;
  }
  @media (max-width:1100px){
    .now-stats{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  }

  .now-stat{
    background: rgba(255,255,255,.06);
    border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
    min-width:0;
  }
  .now-stat .k{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:800;
  }
  .now-stat .v{
    margin-top:6px;
    font-size:1.05rem;
    font-weight:820;
    color:var(--ink);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

    .mid-stack{
    display:flex;
    flex-direction:column;
    gap:12px;
    min-width:0;
    height:100%;
  }


  .metric-grid{
    display:grid;
    grid-template-columns:repeat(4, minmax(0,1fr));
    gap:10px;
  }
  @media (max-width:1100px){
    .metric-grid{grid-template-columns:repeat(2, minmax(0,1fr))}
  }

  .mcard{
  	background: rgba(255,255,255,.06);
  	border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
    min-width:0;
  }
  .mk{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:800;
  }
  .mv{
    margin-top:6px;
    font-size:1.05rem;
    font-weight:820;
    color:var(--ink);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
/* =========================
     Air & Pollen Section
     ========================= */
  .air-pollen-section{
    margin-top:12px;
    background:var(--paper-soft);
    border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
  }

  .air-pollen-top{
    padding-bottom:6px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:8px;
  }

  .ap-label{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:850;
  }

  .air-pollen-grid{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:10px;
  }

  .ap-item{
    display:flex;
    align-items:baseline;
    gap:6px;
  }

  .ap-key{
    font-size:.68rem;
    color:var(--ink-dim);
    font-weight:700;
  }

  .ap-val{
    font-size:.82rem;
    font-weight:850;
    color:var(--ink);
  }

  .ap-val.good{ color:rgba(34,197,94,1); }
  .ap-val.moderate{ color:rgba(234,179,8,1); }
  .ap-val.unhealthy-sensitive{ color:rgba(249,115,22,1); }
  .ap-val.unhealthy{ color:rgba(239,68,68,1); }
  .ap-val.very-unhealthy{ color:rgba(168,85,247,1); }
  .ap-val.hazardous{ color:rgba(127,29,29,1); }

  .pollen-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  .pollen-item{
    display:flex;
    align-items:center;
    gap:4px;
    padding:4px 8px;
    border-radius:10px;
    background:rgba(255,255,255,.06);
    box-shadow:0 0 20px rgba(255,255,255,.08), inset 0 0 12px rgba(255,255,255,.12);
  }

  .pollen-icon{
    font-size:.9rem;
  }

  .pollen-type{
    font-size:.64rem;
    font-weight:700;
    color:var(--ink-dim);
  }

  .pollen-val{
    font-size:.72rem;
    font-weight:850;
    padding:2px 6px;
    border-radius:6px;
  }

  .pollen-val.none{
    background:rgba(150,150,150,.20);
    color:rgba(100,100,100,1);
    padding:2px 8px;
    border-radius:6px;
  }

  .pollen-val.low{
    background:rgba(34,197,94,.15);
    color:rgba(22,163,74,1);
  }

  .pollen-val.moderate{
    background:rgba(234,179,8,.15);
    color:rgba(180,130,8,1);
  }

  .pollen-val.high{
    background:rgba(249,115,22,.15);
    color:rgba(220,90,15,1);
  }

  .pollen-val.very-high{
    background:rgba(239,68,68,.15);
    color:rgba(220,50,50,1);
  }
/* =========================
     TODAY Timeline Widget (v4/v5 integrated)
     ========================= */
  .today-timeline-card{
    position:relative;
    width:100%;
    background: rgba(255,255,255,.06);
    border:none;
    border-radius:20px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px) saturate(125%);
    -webkit-backdrop-filter:blur(18px) saturate(125%);
    padding:14px;
    margin-top:10px;
  }

  /* TODAY Timeline Header */
  .today-tl-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:16px;
    padding-bottom:10px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:8px;
  }

  .today-tl-title{
    font-size:.62rem;
    font-weight:900;
    letter-spacing:.16em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
  }

  .today-tl-meta{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:18px;
  }

  .today-tl-meta .meta-item{
    display:flex;
    align-items:center;
    gap:4px;
  }

  .today-tl-meta .meta-key{
    font-size:.50rem;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:rgba(43,34,244,.55);
    font-weight:700;
  }

  .today-tl-meta .meta-val{
    font-size:.70rem;
    font-weight:750;
    color:var(--ink);
  }

  .today-tl-meta .meta-val.orange{ color:#f97316; }
  .today-tl-meta .meta-val.green{ color:#22c55e; }

  .today-tl-stats{
    display:flex;
    gap:20px;
    align-items:center;
  }

  .today-tl-stat{
    text-align:center;
  }

  .today-tl-stat .stat-label{
    font-size:.48rem;
    font-weight:700;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:rgba(43,34,244,.50);
  }

  .today-tl-stat .stat-value{
    font-size:.68rem;
    font-weight:800;
    color:var(--ink);
  }

  /* TODAY Timeline Body */
  .today-tl-body{
    position:relative;
    padding-bottom:12px;
  }

  /* Top Bars: Kp and Cloud */
  .today-tl-top-bars{
    display:flex;
    flex-direction:column;
    gap:1px;
    margin-bottom:0;
    margin-left:0;
  }

  .today-tl-bar-row{
    display:flex;
    align-items:center;
    gap:0;
    height:18px;
    margin-left:0;
    position:relative;
  }

  .today-tl-bar-label{
    position:absolute;
    left:6px;
    font-size:.52rem;
    font-weight:700;
    letter-spacing:.02em;
    text-transform:uppercase;
    color:rgba(255,255,255,.95);
    text-shadow:0 1px 3px rgba(0,0,0,.55);
    z-index:2;
  }

  .today-tl-bar-track{
    width:100%;
    height:18px;
    background:rgba(43,34,244,.06);
    border-radius:14px 14px 0 0;
    display:flex;
    overflow:hidden;
  }

  .today-tl-bar-track.cloud{
    border-radius:0;
  }

  .today-tl-bar-segment{
    height:100%;
  }

  /* Sky Bar Container */
  .today-tl-sky-bar{
    position:relative;
    border-radius:0 0 14px 14px;
    overflow:hidden;
    min-height:180px;
    margin-left:0;
    margin-right:0;
  }

  /* Sky gradient bands */
  .today-tl-sky-bands{
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
    display:flex;
    z-index:0;
  }

  .today-tl-sky-band{
    height:100%;
  }

  .today-tl-sky-band.night{
    background:linear-gradient(180deg, 
      rgba(15,20,45,.88) 0%, 
      rgba(22,30,65,.80) 40%,
      rgba(30,45,85,.70) 100%);
  }

  .today-tl-sky-band.astro-twilight{
    background:linear-gradient(180deg, 
      rgba(25,35,75,.75) 0%, 
      rgba(40,55,110,.65) 50%,
      rgba(55,75,140,.55) 100%);
  }

  .today-tl-sky-band.blue-hour{
    background:linear-gradient(180deg, 
      rgba(55,80,150,.55) 0%, 
      rgba(75,110,175,.45) 50%,
      rgba(100,140,195,.35) 100%);
  }

  .today-tl-sky-band.golden{
    background:linear-gradient(180deg, 
      rgba(255,160,80,.65) 0%, 
      rgba(255,190,110,.45) 50%,
      rgba(255,220,150,.30) 100%);
  }

  .today-tl-sky-band.golden-am{
    background:linear-gradient(90deg, 
      rgba(200,140,100,.50) 0%,
      rgba(240,160,80,.58) 20%,
      rgba(255,170,70,.65) 40%,
      rgba(255,195,110,.48) 60%,
      rgba(255,215,150,.30) 80%,
      rgba(255,230,185,.15) 100%);
  }

  .today-tl-sky-band.golden-pm{
    background:linear-gradient(90deg, 
      rgba(255,230,185,.15) 0%,
      rgba(255,215,150,.30) 20%,
      rgba(255,195,110,.48) 40%,
      rgba(255,170,70,.65) 60%,
      rgba(240,160,80,.58) 80%,
      rgba(200,140,100,.50) 100%);
  }

  .today-tl-sky-band.golden-peak{
    background:linear-gradient(180deg, 
      rgba(255,100,30,.90) 0%, 
      rgba(255,130,50,.75) 50%,
      rgba(255,160,80,.60) 100%);
  }

  .today-tl-sky-band.day{
    background:linear-gradient(180deg, 
      rgba(135,195,250,.40) 0%, 
      rgba(175,215,255,.25) 50%,
      rgba(210,235,255,.15) 100%);
  }

  /* Planet Tracks */
  .today-tl-planet-tracks{
    position:relative;
    z-index:2;
    padding:10px 0 8px 0;
    margin-left:0;
  }

  .today-tl-planet-row{
    display:flex;
    align-items:center;
    height:10px;
    margin-bottom:3px;
    padding-left:6px;
  }

  .today-tl-planet-row:last-child{
    margin-bottom:0;
  }

  .today-tl-planet-indicator{
    width:8px;
    height:8px;
    border-radius:50%;
    flex-shrink:0;
    margin-right:6px;
    margin-left:2px;
  }

  .today-tl-planet-dir{
    width:18px;
    font-size:.48rem;
    font-weight:700;
    letter-spacing:.02em;
    color:rgba(255,255,255,.55);
    text-align:center;
    flex-shrink:0;
    text-shadow:0 1px 2px rgba(0,0,0,.40);
  }

  .today-tl-planet-bar{
    flex:1;
    height:5px;
    position:relative;
  }

  .today-tl-planet-vis{
    position:absolute;
    height:100%;
    border-radius:2px;
    box-shadow:0 0 6px currentColor;
  }

  .today-tl-planet-vis.solid{
    opacity:0.90;
  }

  .today-tl-planet-vis.dashed{
    opacity:0.40;
  }

  /* Weather Row */
  .today-tl-weather-row{
    position:relative;
    z-index:2;
    display:flex;
    padding:12px 0 16px 0;
    margin-left:0;
    border-top:1px solid rgba(255,255,255,.10);
  }

  .today-tl-weather-hour{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    min-width:0;
  }

  .today-tl-weather-time{
    font-size:.64rem;
    font-weight:700;
    color:rgba(255,255,255,.55);
    text-shadow:0 1px 2px rgba(0,0,0,.50);
    margin-bottom:2px;
  }

  .today-tl-weather-icon{
    font-size:26px;
    line-height:1;
    filter:drop-shadow(0 1px 2px rgba(0,0,0,.30));
    display:flex;
    align-items:center;
    justify-content:center;
    height:36px;
    flex-shrink:0;
    overflow:hidden;
    margin:3px 0;
  }

  .today-tl-weather-temp{
    font-size:.82rem;
    font-weight:800;
    color:#fff;
    text-shadow:0 1px 3px rgba(0,0,0,.50);
    margin-top:2px;
  }

  .today-tl-weather-precip{
    font-size:.62rem;
    font-weight:700;
    color:rgba(255,255,255,.5);
    text-shadow:0 1px 2px rgba(0,0,0,.30);
    margin-top:1px;
  }

  .today-tl-weather-precip.active{
    color:rgba(100,180,255,.95);
  }

  /* Day hours - white text on blue sky */
  .today-tl-weather-hour.day-hour .today-tl-weather-time{
    color:rgba(255,255,255,.7);
    text-shadow:0 1px 3px rgba(0,40,120,.3);
  }

  .today-tl-weather-hour.day-hour .today-tl-weather-temp{
    color:#fff;
    text-shadow:0 1px 4px rgba(0,40,120,.35);
  }

  .today-tl-weather-hour.day-hour .today-tl-weather-precip{
    color:rgba(255,255,255,.55);
    text-shadow:none;
  }

  /* Golden hour text - warm amber */
  .today-tl-weather-hour.golden-hour .today-tl-weather-time{
    color:rgba(255,180,80,.75);
    text-shadow:0 1px 2px rgba(0,0,0,.4);
  }
  .today-tl-weather-hour.golden-hour .today-tl-weather-temp{
    color:rgba(255,200,100,1);
    text-shadow:0 0 8px rgba(255,150,40,.2);
  }
  .today-tl-weather-hour.golden-hour .today-tl-weather-precip{
    color:rgba(255,180,80,.55);
    text-shadow:none;
  }

  /* Golden peak text - intense warm */
  .today-tl-weather-hour.golden-peak-hour .today-tl-weather-time{
    color:rgba(255,160,50,.85);
    text-shadow:0 1px 2px rgba(0,0,0,.4);
  }
  .today-tl-weather-hour.golden-peak-hour .today-tl-weather-temp{
    color:rgba(255,180,60,1);
    text-shadow:0 0 12px rgba(255,120,20,.3);
  }
  .today-tl-weather-hour.golden-peak-hour .today-tl-weather-precip{
    color:rgba(255,160,50,.6);
    text-shadow:none;
  }

  /* Golden peak icon glow */
  .today-tl-weather-hour.golden-peak-hour .today-tl-weather-icon{
    filter:drop-shadow(0 0 8px rgba(255,140,40,.35));
  }

  /* Golden hour cloud warm tint */
  .today-tl-weather-hour.golden-hour .today-tl-weather-icon{
    filter:sepia(.12) saturate(1.2) brightness(1.05) drop-shadow(0 2px 6px rgba(255,120,30,.2));
  }

  /* Blue hour text */
  .today-tl-weather-hour.blue-hour-col .today-tl-weather-time{
    color:rgba(150,180,240,.6);
    text-shadow:0 1px 2px rgba(0,0,0,.4);
  }
  .today-tl-weather-hour.blue-hour-col .today-tl-weather-temp{
    color:rgba(200,220,255,.95);
    text-shadow:0 1px 3px rgba(0,0,0,.4);
  }
  .today-tl-weather-hour.blue-hour-col .today-tl-weather-precip{
    color:rgba(150,180,255,.55);
    text-shadow:none;
  }

  /* Twilight text */
  .today-tl-weather-hour.twilight-hour .today-tl-weather-time{
    color:rgba(200,210,255,.5);
    text-shadow:0 1px 2px rgba(0,0,0,.5);
  }
  .today-tl-weather-hour.twilight-hour .today-tl-weather-temp{
    color:rgba(220,230,255,.9);
    text-shadow:0 1px 3px rgba(0,0,0,.5);
  }
  .today-tl-weather-hour.twilight-hour .today-tl-weather-precip{
    color:rgba(180,200,255,.45);
    text-shadow:none;
  }

  /* =============================================
     WEATHER ICON ANIMATIONS (Complete v5 set)
     ============================================= */

  /* SUN - gentle pulse/glow (code 0 day) */
  @keyframes today-sun-pulse {
    0%, 100% { 
      transform: scale(1); 
      filter: drop-shadow(0 0 3px rgba(255,200,0,0.6));
    }
    50% { 
      transform: scale(1.06); 
      filter: drop-shadow(0 0 8px rgba(255,200,0,0.90));
    }
  }

  .today-tl-weather-icon.sun {
    animation: today-sun-pulse 3s ease-in-out infinite;
  }

  /* MOON / CLEAR NIGHT - twinkle (code 0 night) */
  @keyframes today-night-twinkle {
    0%, 100% { 
      filter: drop-shadow(0 0 2px rgba(200,220,255,0.5)); 
    }
    50% { 
      filter: drop-shadow(0 0 6px rgba(200,220,255,0.90)); 
    }
  }

  .today-tl-weather-icon.night {
    animation: today-night-twinkle 2.5s ease-in-out infinite;
  }

  /* PARTLY CLOUDY - subtle wobble (codes 1, 2) */
  @keyframes today-partly-wobble {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    25% { transform: translateX(1px) rotate(1deg); }
    75% { transform: translateX(-1px) rotate(-1deg); }
  }

  .today-tl-weather-icon.partly {
    animation: today-partly-wobble 5s ease-in-out infinite;
  }

  /* OVERCAST / CLOUDY - gentle drift (code 3) */
  @keyframes today-cloud-drift {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(2px); }
  }

  .today-tl-weather-icon.cloud {
    animation: today-cloud-drift 4s ease-in-out infinite;
  }

  /* FOG / MIST - slow fade pulse (codes 45, 48) */
  @keyframes today-fog-fade {
    0%, 100% { opacity: 1; transform: scaleX(1); }
    50% { opacity: 0.65; transform: scaleX(1.02); }
  }

  .today-tl-weather-icon.fog {
    animation: today-fog-fade 4s ease-in-out infinite;
  }

  /* DRIZZLE - light bounce (codes 51, 53, 55) */
  @keyframes today-drizzle-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(1px); }
  }

  .today-tl-weather-icon.drizzle {
    animation: today-drizzle-bounce 2s ease-in-out infinite;
  }

  /* FREEZING DRIZZLE - bounce + shimmer (codes 56, 57) */
  @keyframes today-freezing-drizzle {
    0%, 100% { 
      transform: translateY(0); 
      filter: drop-shadow(0 0 2px rgba(150,200,255,0.4));
    }
    50% { 
      transform: translateY(1px); 
      filter: drop-shadow(0 0 5px rgba(150,200,255,0.75));
    }
  }

  .today-tl-weather-icon.freezing-drizzle {
    animation: today-freezing-drizzle 2s ease-in-out infinite;
  }

  /* RAIN - bounce like drops (codes 61, 63, 65, 80, 81, 82) */
  @keyframes today-rain-bounce {
    0%, 100% { transform: translateY(0); }
    25% { transform: translateY(-1px); }
    50% { transform: translateY(1px); }
    75% { transform: translateY(-0.5px); }
  }

  .today-tl-weather-icon.rain {
    animation: today-rain-bounce 1.5s ease-in-out infinite;
  }

  /* FREEZING RAIN - bounce + icy shimmer (codes 66, 67) */
  @keyframes today-freezing-rain {
    0%, 100% { 
      transform: translateY(0); 
      filter: drop-shadow(0 0 2px rgba(100,180,255,0.5));
    }
    25% { transform: translateY(-1px); }
    50% { 
      transform: translateY(1px); 
      filter: drop-shadow(0 0 6px rgba(100,180,255,0.85));
    }
    75% { transform: translateY(-0.5px); }
  }

  .today-tl-weather-icon.freezing-rain {
    animation: today-freezing-rain 1.8s ease-in-out infinite;
  }

  /* SNOW - gentle float (codes 71, 73, 75, 85, 86) */
  @keyframes today-snow-float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-1px) rotate(2deg); }
    50% { transform: translateY(1px) rotate(0deg); }
    75% { transform: translateY(-0.5px) rotate(-2deg); }
  }

  .today-tl-weather-icon.snow {
    animation: today-snow-float 3s ease-in-out infinite;
  }

  /* SLEET / ICE PELLETS - sharp bounce (code 77) */
  @keyframes today-sleet-bounce {
    0%, 100% { transform: translateY(0) scale(1); }
    15% { transform: translateY(-2px) scale(1); }
    30% { transform: translateY(2px) scale(0.96); }
    45% { transform: translateY(-1px) scale(1); }
    60% { transform: translateY(1px) scale(0.98); }
  }

  .today-tl-weather-icon.sleet {
    animation: today-sleet-bounce 1.2s ease-in-out infinite;
  }

  /* HAIL - aggressive bounce with shake (codes 96, 99 without thunder) */
  @keyframes today-hail-bounce {
    0%, 100% { transform: translateY(0) translateX(0); }
    10% { transform: translateY(-2px) translateX(1px); }
    20% { transform: translateY(2px) translateX(-1px); }
    30% { transform: translateY(-1px) translateX(0); }
    40% { transform: translateY(1px) translateX(1px); }
    50% { transform: translateY(-1px) translateX(-1px); }
  }

  .today-tl-weather-icon.hail {
    animation: today-hail-bounce 0.8s ease-in-out infinite;
  }

  /* THUNDERSTORM - flash effect (code 95) */
  @keyframes today-storm-flash {
    0%, 88%, 100% { 
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); 
    }
    90%, 94% { 
      filter: drop-shadow(0 0 12px rgba(255,255,150,1)) brightness(1.35); 
    }
  }

  .today-tl-weather-icon.storm {
    animation: today-storm-flash 3.5s ease-in-out infinite;
  }

  /* THUNDERSTORM WITH HAIL - flash + shake (codes 96, 99 with thunder) */
  @keyframes today-storm-hail {
    0%, 85%, 100% { 
      transform: translateY(0) translateX(0);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); 
    }
    88%, 92% { 
      transform: translateY(0) translateX(0);
      filter: drop-shadow(0 0 12px rgba(255,255,150,1)) brightness(1.35); 
    }
    10% { transform: translateY(-2px) translateX(1px); }
    20% { transform: translateY(2px) translateX(-1px); }
    30% { transform: translateY(-1px) translateX(0); }
  }

  .today-tl-weather-icon.storm-hail {
    animation: today-storm-hail 2s ease-in-out infinite;
  }

  /* WIND - sway motion */
  @keyframes today-wind-sway {
    0%, 100% { transform: rotate(-4deg) translateX(0); }
    50% { transform: rotate(4deg) translateX(2px); }
  }

  .today-tl-weather-icon.wind {
    animation: today-wind-sway 2s ease-in-out infinite;
  }

  /* MIXED RAIN/SNOW - alternating bounce (winter mix) */
  @keyframes today-mix-bounce {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    20% { transform: translateY(-1px) rotate(2deg); }
    40% { transform: translateY(1px) rotate(-1deg); }
    60% { transform: translateY(-0.5px) rotate(1deg); }
    80% { transform: translateY(1px) rotate(-2deg); }
  }

  .today-tl-weather-icon.mix {
    animation: today-mix-bounce 2s ease-in-out infinite;
  }

  /* Stagger animations */
  .today-tl-weather-hour:nth-child(2n) .today-tl-weather-icon { animation-delay: 0.3s; }
  .today-tl-weather-hour:nth-child(3n) .today-tl-weather-icon { animation-delay: 0.6s; }
  .today-tl-weather-hour:nth-child(4n) .today-tl-weather-icon { animation-delay: 0.9s; }
  .today-tl-weather-hour:nth-child(5n) .today-tl-weather-icon { animation-delay: 1.2s; }
  .today-tl-weather-hour:nth-child(6n) .today-tl-weather-icon { animation-delay: 0.15s; }
  .today-tl-weather-hour:nth-child(7n) .today-tl-weather-icon { animation-delay: 0.45s; }

  /* NOW Marker */
  .today-tl-now-marker{
    position:absolute;
    top:0;
    bottom:-40px;
    width:3px;
    background:rgba(255,140,0,.9);
    border-radius:2px;
    z-index:100;
    box-shadow:0 0 10px rgba(255,140,0,.6), 0 0 20px rgba(255,100,0,.3);
  }

  .today-tl-now-label{
    display:none;
  }

  .today-tl-now-bubble{
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,140,0,.95);
    color:#fff;
    padding:5px 8px;
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:1px;
    box-shadow:0 3px 10px rgba(255,100,0,.4);
  }

  .today-tl-now-temp{
    font-size:.80rem;
    font-weight:900;
  }

  .today-tl-now-time{
    font-size:.46rem;
    font-weight:700;
    opacity:0.70;
    letter-spacing:.06em;
  }

  /* TODAY Timeline Legend */
  .today-tl-legend{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
    gap:10px;
    padding-top:6px;
    margin-top:2px;
    border-top:1px solid rgba(43,34,244,.08);
  }

  .today-tl-legend-item{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:2px;
    padding:6px 10px;
    background:rgba(255,255,255,.06);
    border-radius:12px;
    font-size:.62rem;
    font-weight:700;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:rgba(43,34,244,.65);
    box-shadow:0 0 16px rgba(255,255,255,.08), inset 0 0 10px rgba(255,255,255,.12);
  }

  .today-tl-legend-top{
    display:flex;
    align-items:center;
    gap:6px;
  }

  .today-tl-legend-dir{
    font-size:.42rem;
    font-weight:700;
    color:rgba(43,34,244,.40);
    letter-spacing:.08em;
  }

  .today-tl-legend-dot{
    width:10px;
    height:10px;
    border-radius:50%;
  }

  .today-tl-legend-moon{
    width:14px;
    height:14px;
    border-radius:50%;
    background:linear-gradient(135deg, #f5f5f5 0%, #ccc 100%);
    box-shadow:inset -1px -1px 3px rgba(0,0,0,.12);
  }

  .today-tl-kp-scale{
    display:flex;
    align-items:center;
    gap:3px;
  }

  .today-tl-kp-scale span{
    font-size:.62rem;
    font-weight:700;
    color:rgba(43,34,244,.50);
    margin:0 4px;
  }

  .today-tl-kp-box{
    width:36px;
    height:6px;
    border-radius:3px;
  }

  /* Mobile responsive for TODAY Timeline */
  @media (max-width: 768px) {
    .today-timeline-card {
      padding: 10px;
      border-radius: 16px;
    }
    
    .today-tl-header {
      flex-direction: column;
      gap: 8px;
      padding-bottom: 8px;
      margin-bottom: 8px;
    }
    
    .today-tl-meta {
      gap: 8px 12px;
    }
    
    .today-tl-meta .meta-key {
      font-size: .44rem;
    }
    
    .today-tl-meta .meta-val {
      font-size: .62rem;
    }
    
    .today-tl-stats {
      gap: 12px;
    }
    
    .today-tl-stat .stat-label {
      font-size: .42rem;
    }
    
    .today-tl-stat .stat-value {
      font-size: .58rem;
    }
    
    .today-tl-sky-bar {
      min-height: 110px;
    }
    
    .today-tl-weather-time {
      font-size: .48rem;
    }
    
    .today-tl-weather-icon {
      font-size: 14px;
    }
    
    .today-tl-weather-temp {
      font-size: .58rem;
    }
    
    .today-tl-weather-precip {
      font-size: .38rem;
    }
    
    .today-tl-planet-tracks {
      margin-left: 20px;
    }
    
    .today-tl-weather-row {
      margin-left: 20px;
    }
    
    .today-tl-legend {
      gap: 5px;
    }
    
    .today-tl-legend-item {
      padding: 2px 5px;
      font-size: .46rem;
    }
  }

  @media (max-width: 480px) {
    .today-tl-sky-bar {
      min-height: 95px;
    }
  }

  /* =========================
     Sun Timeline (Combined hourly + sun events)
     ========================= */
  .sun-timeline{
    position:relative;
    margin-top:10px;
    background:var(--paper);
    border:none;
    border-radius:18px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px) saturate(125%);
    -webkit-backdrop-filter:blur(18px) saturate(125%);
    padding:14px;
    min-height:180px;
  }

  .sun-timeline-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:8px;
    padding-bottom:8px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:10px;
  }

  .sun-timeline-title{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .sun-timeline-title .sun-label-text{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.74);
    font-weight:900;
  }

  .sun-timeline-meta{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }

  .meta-item{
    display:flex;
    align-items:baseline;
    gap:6px;
  }

  .meta-key{
    font-size:.52rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:rgba(43,34,244,.60);
    font-weight:700;
  }

  .meta-val{
    font-size:.72rem;
    font-weight:750;
    color:var(--ink);
  }

  /* Main timeline bar container */
  .sun-timeline-bar{
    position:relative;
    height:90px;
    background:rgba(43,34,244,.04);
    border-radius:14px;
  }

  /* Colored bands (golden/blue hour) */
  .tl-bands{
    position:absolute;
    inset:0;
    border-radius:14px;
    overflow:hidden;
    pointer-events:none;
  }

  .tl-band{
    position:absolute;
    top:0;
    bottom:0;
    pointer-events:none;
  }

  .tl-band.night{
    background:linear-gradient(180deg, 
      rgba(10,10,35,.85) 0%, 
      rgba(15,20,50,.75) 50%,
      rgba(20,25,60,.65) 100%);
  }

  .tl-band.astro{
    background:linear-gradient(180deg, 
      rgba(25,30,80,.70) 0%, 
      rgba(40,50,120,.55) 50%,
      rgba(60,70,140,.40) 100%);
  }

  .tl-band.blue{
    background:linear-gradient(180deg, 
      rgba(80,100,180,.65) 0%, 
      rgba(100,130,200,.50) 50%,
      rgba(140,170,220,.35) 100%);
  }

  .tl-band.golden{
    background:linear-gradient(180deg, 
      rgba(255,140,50,.75) 0%, 
      rgba(255,170,80,.60) 50%,
      rgba(255,200,120,.45) 100%);
  }

  .tl-band.golden-peak{
    background:linear-gradient(180deg, 
      rgba(255,100,30,.85) 0%, 
      rgba(255,130,50,.75) 50%,
      rgba(255,160,80,.60) 100%);
  }

  .tl-band.day{
    background:linear-gradient(180deg, 
      rgba(135,206,250,.30) 0%, 
      rgba(176,224,255,.20) 50%,
      rgba(200,235,255,.15) 100%);
  }

  /* Hour markers */
  .tl-hours{
    position:absolute;
    inset:0;
    display:flex;
    pointer-events:none;
    overflow:hidden;
  }

  .tl-hour{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-end;
    padding-bottom:6px;
    border-left:1px solid rgba(43,34,244,.08);
    min-width:0;
  }

  .tl-hour:first-child{
    border-left:none;
  }

  .tl-hour-time{
    font-size:.58rem;
    font-weight:800;
    color:rgba(43,34,244,.50);
    letter-spacing:.02em;
    margin-bottom:2px;
    transition:color .2s ease;
  }

  .tl-hour-icon{
    max-width:36px;
    max-height:36px;
    object-fit:contain;
    margin:0;
  }

  .tl-hour-temp{
    font-size:.82rem;
    font-weight:850;
    color:var(--ink);
    transition:color .2s ease, text-shadow .2s ease;
  }

  .tl-hour-precip{
    font-size:.62rem;
    font-weight:700;
    margin-top:1px;
    transition:color .2s ease;
  }

  .tl-hour-precip.low{
    color:rgba(255,255,255,.5);
  }

  .tl-hour-precip.med{
    color:rgba(70,130,220,1);
    font-weight:800;
  }

  .tl-hour-precip.high{
    color:rgba(30,100,220,1);
    font-weight:900;
    text-shadow:0 0 6px rgba(50,120,240,.40);
  }

  /* Light text for dark backgrounds (night hours) */
  .tl-hour.night-hour .tl-hour-time{
    color:rgba(180,190,220,.70);
  }

  .tl-hour.night-hour .tl-hour-temp{
    color:rgba(230,235,255,.95);
    text-shadow:0 0 8px rgba(0,0,0,.50);
  }

  .tl-hour.night-hour .tl-hour-precip.low{
    color:rgba(150,170,210,.60);
  }

  .tl-hour.night-hour .tl-hour-precip.med{
    color:rgba(130,180,255,.90);
  }

  .tl-hour.night-hour .tl-hour-precip.high{
    color:rgba(100,170,255,1);
    text-shadow:0 0 6px rgba(80,150,255,.50);
  }

  /* Sun event ticks */
  .tl-events{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  .tl-event-tick{
    position:absolute;
    top:0;
    bottom:0;
    width:2px;
    transform:translateX(-50%);
    border-radius:2px;
  }

  .tl-event-tick.sunrise,
  .tl-event-tick.sunset{
    background:linear-gradient(180deg, rgba(255,120,30,1), rgba(255,180,60,1));
    box-shadow:0 0 16px rgba(255,140,40,.70), 0 0 30px rgba(255,100,20,.40);
  }

  .tl-event-tick.noon{
    background:linear-gradient(180deg, rgba(255,220,80,1), rgba(255,240,150,1));
    box-shadow:0 0 14px rgba(255,220,100,.60), 0 0 25px rgba(255,200,50,.35);
  }

  .tl-event-tick.golden{
    background:linear-gradient(180deg, rgba(255,140,30,1), rgba(255,180,70,1));
    box-shadow:0 0 12px rgba(255,150,50,.55), 0 0 20px rgba(255,120,30,.30);
  }

  .tl-event-tick.blue{
    background:linear-gradient(180deg, rgba(80,100,200,1), rgba(130,150,230,1));
    box-shadow:0 0 12px rgba(100,120,220,.55), 0 0 20px rgba(80,100,200,.30);
  }

  .tl-event-tick.astro{
    background:linear-gradient(180deg, rgba(40,50,100,1), rgba(70,80,140,1));
    box-shadow:0 0 10px rgba(50,60,120,.50), 0 0 18px rgba(30,40,90,.30);
  }

  /* NOW marker */
  .tl-now{
    position:absolute;
    top:-6px;
    bottom:-6px;
    width:3px;
    transform:translateX(-50%);
    z-index:10;
    pointer-events:none;
  }

  .tl-now-line{
    position:absolute;
    inset:0;
    background:var(--ink);
    border-radius:3px;
    box-shadow:0 0 14px rgba(43,34,244,.40);
  }

  .tl-now-bubble{
    position:absolute;
    bottom:-32px;
    left:50%;
    transform:translateX(-50%);
    background:var(--ink);
    color:#fff;
    padding:5px 9px;
    border-radius:10px;
    display:flex;
    flex-direction:column-reverse;
    align-items:center;
    gap:1px;
    box-shadow:0 -4px 16px rgba(43,34,244,.35);
  }

  .tl-now-temp{
    font-size:.78rem;
    font-weight:900;
  }

  .tl-now-label{
    font-size:.44rem;
    font-weight:800;
    letter-spacing:.12em;
    opacity:.75;
  }

  /* Event labels below bar */
  .tl-event-labels{
    display:none;
  }

  .tl-event-label{
    position:absolute;
    transform:translateX(-50%);
    font-size:.54rem;
    font-weight:500;
    letter-spacing:.08em;
    text-transform:uppercase;
    white-space:nowrap;
    color:var(--ink-dim);
  }

  .tl-event-label.level-1{ top:16px; }
  .tl-event-label.level-2{ top:12px; }
  .tl-event-label.level-3{ top:8px; }
  .tl-event-label.level-4{ top:4px; }
  .tl-event-label.level-5{ top:0px; }

  .tl-event-label.sunrise,
  .tl-event-label.sunset{
    color:rgba(230,100,20,1);
    text-shadow:0 0 8px rgba(255,140,50,.35);
  }

  .tl-event-label.golden{
    color:rgba(220,120,20,1);
    text-shadow:0 0 6px rgba(255,150,50,.30);
  }

  .tl-event-label.blue{
    color:rgba(70,90,180,1);
    text-shadow:0 0 6px rgba(100,130,220,.25);
  }

  .tl-event-label.astro{
    color:rgba(50,60,120,1);
    text-shadow:0 0 5px rgba(60,70,140,.20);
  }

  .tl-event-label.noon{
    color:rgba(210,160,30,1);
    text-shadow:0 0 8px rgba(255,200,50,.30);
  }

  /* Responsive */
  @media (max-width:900px){
    .sun-timeline-bar{
      height:80px;
    }
    .tl-hour-time{
      font-size:.44rem;
    }
    .tl-hour-icon{
      width:20px;
      height:20px;
    }
    .tl-hour-temp{
      font-size:.60rem;
    }
    .tl-hour-precip{
      font-size:.48rem;
    }
  }

  @media (max-width:600px){
    .sun-timeline-header{
      flex-direction:column;
      align-items:flex-start;
    }
    .tl-hour:nth-child(odd) .tl-hour-time{
      visibility:hidden;
    }
  }

  /* =========================
     7-day (horizontal chips inside main card)
     ========================= */
  .forecast7-section{
    margin-top:12px;
    background:var(--paper-soft);
    border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
  }

  .forecast7-top{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:10px;
    padding-bottom:6px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:10px;
  }

  .forecast7-label{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:850;
  }

  .forecast7-chips{
    display:flex;
    gap:8px;
    padding-bottom:4px;
    overflow-x:auto;
    overflow-y:hidden;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  .forecast7-chips::-webkit-scrollbar{
    display:none;
  }

  .forecast7-chip{
    flex:1 0 0%;
    min-width:80px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:2px;
    padding:4px 12px 8px 12px;
    border-radius:14px;
    background:rgba(255,255,255,.06);
    box-shadow:0 0 30px rgba(255,255,255,.10), inset 0 0 20px rgba(255,255,255,.18);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
  }

  .forecast7-chip .day{
    font-size:.74rem;
    font-weight:850;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:var(--ink-dim);
  }

  .forecast7-chip .forecast7-date{
    font-size:.64rem;
    font-weight:600;
    color:rgba(100,100,140,.8);
    margin-top:-2px;
  }

  .forecast7-chip .icon{
    width:52px;
    height:52px;
    object-fit:contain;
  }

  .forecast7-chip .temps{
    font-size:.85rem;
    font-weight:800;
    color:var(--ink);
    text-transform:uppercase;
  }

  .forecast7-bar-wrap{
    width:100%;
    height:7px;
    background:rgba(43,34,244,.08);
    border-radius:3px;
    position:relative;
    margin:2px 0;
  }

  .forecast7-bar{
    position:absolute;
    top:0;
    height:100%;
    border-radius:3px;
    transition:width .3s ease, left .3s ease;
    box-shadow:0 0 6px rgba(255,255,255,.15);
  }

  .forecast7-chip .forecast7-bar-block{
    width:100%;
    display:flex;
    flex-direction:column;
    overflow:visible;
  }
  .forecast7-chip .bar-hi{
    display:flex;
    align-items:baseline;
    justify-content:flex-end;
    gap:3px;
    white-space:nowrap;
    overflow:visible;
  }
  .forecast7-chip .bar-lo{
    display:flex;
    align-items:baseline;
    justify-content:flex-start;
    gap:3px;
    white-space:nowrap;
    overflow:visible;
  }
  .forecast7-chip .bar-lo .forecast7-lo{
    font-size:.85rem;
    font-weight:700;
    color:var(--ink);
  }
  .forecast7-chip .feels-hi,
  .forecast7-chip .feels-lo{
    font-size:.5rem;
    font-weight:400;
    color:var(--ink-dim);
    letter-spacing:.02em;
    white-space:nowrap;
  }
  .forecast7-chip .forecast7-lo{
    font-size:.68rem;
    font-weight:600;
    color:var(--ink-dim);
  }

  .forecast7-chip .precip{
    font-size:.65rem;
    font-weight:700;
    color:rgba(70,130,220,.90);
    text-transform:uppercase;
    text-align:center;
  }

  .forecast7-chip .forecast7-wind{
    font-size:.60rem;
    font-weight:600;
    color:var(--ink-dim);
    margin-top:2px;
    text-align:center;
  }

  .forecast7-chip .forecast7-accum{
    font-size:.60rem;
    font-weight:700;
    color:var(--ink);
    margin-top:2px;
    text-align:center;
  }
  .forecast7-chip .forecast7-precip{
    font-size:.60rem;
    font-weight:700;
    color:rgba(70,150,255,.95);
    margin-top:4px;
    text-align:center;
    letter-spacing:.02em;
  }
  .forecast7-chip .forecast7-uv{
    font-size:.55rem;
    font-weight:600;
    margin-top:2px;
    text-align:center;
  }
  .forecast7-chip .forecast7-uv.uv-low{ color:rgba(120,180,120,.95); }
  .forecast7-chip .forecast7-uv.uv-mod{ color:rgba(200,170,60,.95); }
  .forecast7-chip .forecast7-uv.uv-high{ color:rgba(240,130,40,.95); }
  .forecast7-chip .forecast7-uv.uv-vhigh{ color:rgba(230,60,60,.95); }
  .forecast7-chip .forecast7-uv.uv-extreme{ color:rgba(180,50,200,.95); }

  @media (max-width:600px){
    .forecast7-chips{
      gap:6px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x mandatory;
      padding-bottom:6px;
    }
    .forecast7-chip{
      min-width:72px;
      flex:0 0 auto;
      padding:8px 6px;
      scroll-snap-align:start;
    }
    .forecast7-chip .icon{
    width:90px;
    height:90px;
    margin:-10px 0 -10px 0;
    margin:0;
    padding:0;
    }
    .forecast7-chip .temps{
      font-size:.78rem;
    }
    .forecast7-chip .feels-hi{
    font-size:.55rem;
    font-weight:600;
    color:var(--ink-dim);
  }
  .forecast7-chip .forecast7-lo{
      font-size:.62rem;
    }
    .forecast7-chip .forecast7-wind{
      font-size:.55rem;
    }
    .forecast7-chip .forecast7-accum{
      font-size:.55rem;
    }
  }

  /* =========================
     Astro / Space events / Night sky
     ========================= */
  .astro-row{margin-top:12px}
  .astro-pill{
    background:var(--paper);
  	border:none;
    border-radius:18px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px);
    -webkit-backdrop-filter:blur(18px);
    padding:10px;
  }

  .moon-sky{display:block}
  .moon-sky-main{display:flex;flex-direction:column;gap:10px}

  .skygrid{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }

  .skcard{
  	background: rgba(255,255,255,.06);
  	border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    padding:10px;
  }
  .skk{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:850;
  }
  .skv{
    margin-top:8px;
    font-size:1.0rem;
    font-weight:900;
    color:var(--ink);
  }

  .bullets{margin-top:6px;display:flex;flex-direction:column;gap:5px}
  .bullet{
  background: rgba(255,255,255,.06);
  border: none;
  border-radius:12px;
  padding:6px 10px;

  box-shadow:
    0 0 56px rgba(255,255,255,.14),
    inset 0 0 34px rgba(255,255,255,.28);

  backdrop-filter: blur(26px) saturate(118%);
  -webkit-backdrop-filter: blur(26px) saturate(118%);
}

  .btop{
  display:flex;
  align-items:baseline;
  gap:10px;
}
.bname{
  flex:1 1 auto;
  min-width:0;

  font-size:.56rem;          /* smaller category titles */
  font-weight:520;           /* explicitly NOT bold */
  letter-spacing:.18em;
  text-transform:uppercase;

  color:var(--ink);
}



.btime{
  flex:0 0 auto;
  min-width:72px;
  text-align:right;
  font-weight:650;
  color:var(--ink-dim);
  white-space:nowrap;
  font-size:.74rem;
  text-transform:uppercase;
  letter-spacing:.06em;
}

  .bsub{margin-top:2px;color:var(--ink-dim);font-size:.74rem;font-weight:650;text-transform:uppercase;letter-spacing:.04em}

  /* Clean list style for space events bullets (no individual bubble cards) */
  #space-events-bullets{gap:0;}
  #space-events-bullets .bullet{
    background:none;
    box-shadow:none;
    backdrop-filter:none;
    -webkit-backdrop-filter:none;
    border-radius:0;
    padding:10px 4px;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  #space-events-bullets .bullet:last-child{border-bottom:none;}
  #space-events-bullets .bname{
    font-size:.7rem;
    font-weight:800;
    letter-spacing:.10em;
    color:var(--ink);
  }
  #space-events-bullets .btime{
    font-size:.6rem;
    font-weight:600;
    letter-spacing:.12em;
    opacity:.55;
  }
  #space-events-bullets .bsub{
    font-size:.62rem;
    font-weight:550;
    letter-spacing:.02em;
    opacity:.7;
    margin-top:3px;
  }

  .nightsky{
    margin-top:10px;
    background:var(--paper);
  	border:none;
    border-radius:18px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px) saturate(125%);
    -webkit-backdrop-filter:blur(18px) saturate(125%);
    padding:14px;
  }
  .nightsky-top{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:10px;
    padding-bottom:8px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:10px;
  }
  .nightsky-top .k{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:850;
  }
  .nightsky-top .v{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:850;
  }
  .nightsky-svgwrap{
    width:100%;
    height:170px;
    border-radius:14px;
    background:rgba(43,34,244,.06);
    border:none;
  }
  #night-sky-svg{width:100%;height:100%}

  .nightsky-legend{
    margin-top:10px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .nightsky-item{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;

  background: rgba(255,255,255,.06);
  border: none;
  box-shadow:
    0 0 46px rgba(255,255,255,.12),
    inset 0 0 26px rgba(255,255,255,.24);

  backdrop-filter: blur(22px) saturate(118%);
  -webkit-backdrop-filter: blur(22px) saturate(118%);

  color:var(--ink);
  font-weight:500;
  font-size:.68rem;
  letter-spacing:.12em;
  text-transform:uppercase;
}

  .nightsky-dot{
    width:10px;height:10px;border-radius:50%;
    box-shadow:0 0 14px rgba(255,255,255,.35);
  }

  /* =========================
     Widgets (cards)
     ========================= */
  .widgets-row,
  .widgets-row-two{
    margin-top:10px;
    display:grid;
    gap:10px;
  }
  .widgets-row{grid-template-columns:repeat(3,1fr)}
  .widgets-row-two{grid-template-columns:repeat(2,1fr)}

  @media (max-width:980px){
    .widgets-row,
    .widgets-row-two{grid-template-columns:1fr}
  }

  .widget{
  	background: rgba(255,255,255,.06);
  	border:none;
    border-radius:18px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    min-width:0;
  }

  .widget-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 12px;
  	background: rgba(255,255,255,.06);
    border-bottom:1px solid rgba(43,34,244,.12);
  }

  .widget-title{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.74);
    font-weight:850;
  }
  /* Small LIVE tag inside widget title */
.widget-title .live-tag{
  font-size:.56rem;
  letter-spacing:.16em;
  font-weight:850;
  color:rgba(43,34,244,.64);
  margin-left:6px;
  white-space:nowrap;
}


  .widget-sub{
    font-size:.72rem;
    color:var(--ink-dim);
    white-space:nowrap;
    text-align:right;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.06em;
    transition: opacity .15s ease;
    flex-shrink:1;
    min-width:0;
  }
  
  a.widget-sub:hover{
    opacity: 0.6;
  }

  .space-info-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:18px;
    height:18px;
    border-radius:50%;
    background:rgba(43,34,244,.08);
    color:rgba(43,34,244,.45);
    font-size:.6rem;
    font-weight:700;
    cursor:pointer;
    border:none;
    font-family:system-ui,sans-serif;
    margin-right:0;
    margin-left:0;
    flex-shrink:0;
    transition:all .2s;
    vertical-align:middle;
  }
  .space-info-btn:hover{
    background:rgba(43,34,244,.15);
    color:rgba(43,34,244,.7);
  }

  .space-info-popup{
    display:none;
    position:absolute;
    top:100%;
    right:0;
    z-index:100;
    width:360px;
    max-height:420px;
    overflow-y:auto;
    background:rgba(12,12,28,.94);
    backdrop-filter:blur(24px) saturate(130%);
    -webkit-backdrop-filter:blur(24px) saturate(130%);
    border-radius:12px;
    padding:14px 16px;
    font-size:.62rem;
    font-weight:500;
    color:rgba(255,255,255,.78);
    line-height:1.6;
    letter-spacing:.01em;
    text-transform:none;
    box-shadow:0 12px 48px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.06);
    scrollbar-width:thin;
    scrollbar-color: rgba(255,255,255,.15) transparent;
  }
  .space-info-popup::-webkit-scrollbar{ width:4px; }
  .space-info-popup::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.15); border-radius:4px; }
  .space-info-popup::-webkit-scrollbar-track{ background:transparent; }
  .space-info-popup.active{ display:block; }
  .space-info-popup .k{ color:rgba(120,160,255,.9); font-weight:600; }
  .space-info-popup b{ color:rgba(255,255,255,.95); }
  .space-info-popup a{ color:rgba(120,160,255,.8); }

  .radar-info-icon{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color:rgba(255,140,0,.6) !important;
    font-size:.65rem;
    font-weight:400;
    cursor:pointer;
    border:none;
    background:transparent;
    font-family:system-ui,sans-serif;
    margin-left:auto;
    padding-left:5px;
    flex-shrink:0;
    transition:all .2s;
    position:relative;
  }
  .radar-info-icon:hover{
    color:rgba(255,140,0,1) !important;
  }

  #radar-info-tooltip{
    display:none;
    position:fixed;
    z-index:200;
    width:340px;
    max-height:420px;
    overflow-y:auto;
    background:rgba(12,12,28,.88);
    backdrop-filter:blur(24px) saturate(130%);
    -webkit-backdrop-filter:blur(24px) saturate(130%);
    border-radius:10px;
    padding:12px 14px;
    font-size:.56rem;
    font-weight:500;
    color:rgba(255,255,255,.80);
    line-height:1.6;
    letter-spacing:.01em;
    text-transform:none;
    box-shadow:0 12px 48px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.06);
    scrollbar-width:thin;
    scrollbar-color: rgba(255,255,255,.15) transparent;
    pointer-events:auto;
  }
  #radar-info-tooltip::-webkit-scrollbar{ width:4px; }
  #radar-info-tooltip::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.15); border-radius:4px; }
  #radar-info-tooltip .k{ color:rgba(120,160,255,.9); font-weight:600; }
  #radar-info-tooltip b{ color:rgba(255,255,255,.95); }

  #hazard-info-tooltip .k{ color:rgba(120,160,255,.9); font-weight:600; }
  #hazard-info-tooltip b{ color:rgba(255,255,255,.95); }
  #hazard-info-tooltip::-webkit-scrollbar{ width:4px; }
  #hazard-info-tooltip::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.15); border-radius:4px; }

  /* Geospace tab switcher */
  .geo-tabs{
    display:flex;
    gap:2px;
    background:rgba(43,34,244,.08);
    border-radius:8px;
    padding:2px;
  }
  .geo-tab{
    border:none;
    background:transparent;
    color:rgba(43,34,244,.45);
    font-family:inherit;
    font-size:.48rem;
    font-weight:750;
    letter-spacing:.1em;
    text-transform:uppercase;
    padding:4px 10px;
    border-radius:6px;
    cursor:pointer;
    transition:all .2s ease;
    white-space:nowrap;
  }
  .geo-tab:hover{
    color:rgba(43,34,244,.7);
    background:rgba(43,34,244,.06);
  }
  .geo-tab.active{
    background:rgba(43,34,244,.14);
    color:rgba(43,34,244,.9);
  }

  /*  Hazard Center Tab Overrides  */
  #hazard-tabs{
    background:rgba(0,0,0,.5);
    border-radius:0;
    padding:0;
    gap:1px;
    backdrop-filter:blur(8px);
    border:none;
    display:flex;
    width:100%;
  }
  #hazard-tabs .geo-tab{
    color:rgba(255,255,255,.45);
    font-size:.58rem;
    padding:9px 14px;
    border-radius:0;
    border:none;
    position:relative;
    transition:all .25s ease;
    flex:1;
    text-align:center;
    white-space:nowrap;
    background:rgba(0,0,0,.3);
  }
  #hazard-tabs .geo-tab:hover{
    color:rgba(255,255,255,.7);
    background:rgba(255,255,255,.08);
  }
  #hazard-tabs .geo-tab.active{
    color:#fff;
    border-bottom: 2px solid rgba(255,255,255,.7);
  }
  #hazard-title {
    font-size: .75rem !important;
    letter-spacing: .16em;
  }

  @keyframes tab-alert-glow {
    0%, 100% { box-shadow: 0 0 4px 1px var(--glow-color, rgba(239,68,68,.3)); }
    50% { box-shadow: 0 0 14px 4px var(--glow-color, rgba(239,68,68,.6)); }
  }
  #hazard-tabs .geo-tab.tab-alert {
    animation: tab-alert-glow 2.5s ease-in-out infinite;
    background: var(--alert-bg, rgba(239,68,68,.2)) !important;
    color: var(--alert-color, #f87171) !important;
  }
  #hazard-tabs .geo-tab[data-hazard="fire"].tab-alert { --glow-color: rgba(249,115,22,.5); --alert-bg: rgba(249,115,22,.2); --alert-color: #fb923c; }
  #hazard-tabs .geo-tab[data-hazard="tornado"].tab-alert { --glow-color: rgba(239,68,68,.5); --alert-bg: rgba(239,68,68,.2); --alert-color: #f87171; }
  #hazard-tabs .geo-tab[data-hazard="quake"].tab-alert { --glow-color: rgba(239,68,68,.5); --alert-bg: rgba(239,68,68,.2); --alert-color: #f87171; }
  #hazard-tabs .geo-tab[data-hazard="alerts"].tab-alert { --glow-color: rgba(239,68,68,.5); --alert-bg: rgba(239,68,68,.2); --alert-color: #f87171; }
  #hazard-tabs .geo-tab[data-hazard="flood"].tab-alert { --glow-color: rgba(6,182,212,.5); --alert-bg: rgba(6,182,212,.2); --alert-color: #22d3ee; }
  #hazard-tabs .geo-tab[data-hazard="fire"].active{ background:rgba(249,115,22,.25); color:#fb923c; box-shadow:inset 0 0 12px rgba(249,115,22,.15); }
  #hazard-tabs .geo-tab[data-hazard="tornado"].active{ background:rgba(239,68,68,.25); color:#f87171; box-shadow:inset 0 0 12px rgba(239,68,68,.15); }
  #hazard-tabs .geo-tab[data-hazard="quake"].active{ background:rgba(59,130,246,.25); color:#60a5fa; box-shadow:inset 0 0 12px rgba(59,130,246,.15); }
  #hazard-tabs .geo-tab[data-hazard="alerts"].active{ background:rgba(239,68,68,.25); color:#f87171; box-shadow:inset 0 0 12px rgba(239,68,68,.15); }
  #hazard-tabs .geo-tab[data-hazard="flood"].active{ background:rgba(6,182,212,.25); color:#22d3ee; box-shadow:inset 0 0 12px rgba(6,182,212,.15); }

  /* Badge pills */
  .hazard-badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:20px;
    height:17px;
    padding:0 5px;
    border-radius:8px;
    font-size:.48rem;
    font-weight:800;
    letter-spacing:0;
    margin-left:4px;
    vertical-align:middle;
  }
  #hazard-tabs .geo-tab[data-hazard="fire"] .hazard-badge{ background:rgba(249,115,22,.2); color:#fb923c; }
  #hazard-tabs .geo-tab[data-hazard="tornado"] .hazard-badge{ background:rgba(239,68,68,.2); color:#f87171; }
  #hazard-tabs .geo-tab[data-hazard="quake"] .hazard-badge{ background:rgba(59,130,246,.2); color:#60a5fa; }
  #hazard-tabs .geo-tab[data-hazard="alerts"] .hazard-badge{ background:rgba(239,68,68,.2); color:#f87171; }
  #hazard-tabs .geo-tab[data-hazard="flood"] .hazard-badge{ background:rgba(6,182,212,.2); color:#22d3ee; }

  /*  Hazard info icon hover  */
  #hazard-tabs .hazard-info{
    color:rgba(255,255,255,.25);
    font-size:.55rem;
    padding:0 2px 0 4px;
    transition:color .2s;
  }
  #hazard-tabs .hazard-info:hover{
    color:rgba(255,200,100,.8);
  }

  /* Hazard accent line */
  #hazard-accent{
    display:none;
  }

  /* Status bar compact mode */
  #hazard-status-bar .fire-status-wrap,
  #hazard-status-bar .tornado-status-wrap,
  #hazard-status-bar .quake-status-wrap,
  #hazard-status-bar .alerts-status-wrap,
  #hazard-status-bar .flood-status-wrap{
    transition:opacity .3s ease, transform .3s ease;
  }

  /* Overlay crossfade */
  #hazard-fire-overlays, #hazard-tornado-overlays, #hazard-quake-overlays, #hazard-alerts-overlays, #hazard-flood-overlays{
    transition:opacity .3s ease;
    position:absolute;
    top:0;left:0;right:0;bottom:0;
    pointer-events:none;
  }
  #hazard-fire-overlays > *, #hazard-tornado-overlays > *, #hazard-quake-overlays > *, #hazard-alerts-overlays > *, #hazard-flood-overlays > * {
    pointer-events:auto;
  }

  /* Outlook day toggle buttons */
  .otlk-btn{
    transition:all .2s ease;
    user-select:none;
    text-transform:uppercase;
  }
  @keyframes spc-pulse {
    0%, 100% { fill-opacity: 0.08; stroke-opacity: 0.5; }
    50% { fill-opacity: 0.22; stroke-opacity: 0.9; }
  }
  .leaflet-overlay-pane .spc-pulse {
    animation: spc-pulse 3s ease-in-out infinite;
  }

  .otlk-btn:hover{
    background:rgba(255,255,255,.08) !important;
  }
  .otlk-active{
    background:rgba(255,255,255,.12) !important;
    border-color:rgba(255,255,255,.3) !important;
    color:rgba(255,255,255,.9) !important;
  }

  .widget-body{
    position:relative;
    aspect-ratio:16/10;
  	background: rgba(255,255,255,.06);
  }
  #fcast-info-text b {
    color: rgba(120,160,255,.95);
    font-weight: 700;
  }

  /* Allow popups to overflow map widget containers */
  .map-widget .widget-body {
    overflow: visible !important;
  }
  
  .map-widget {
    overflow: visible !important;
  }
  
  /* Ensure Leaflet popups appear on top and escape clipping */
  .leaflet-popup-pane {
    z-index: 9999 !important;
  }
  
  .leaflet-pane {
    z-index: 400 !important;
  }
  
  .leaflet-top,
  .leaflet-bottom {
    z-index: 1000 !important;
  }
  
  .quake-geo-popup {
    z-index: 650 !important;
  }
  
  .quake-geo-popup .leaflet-popup-content-wrapper {
    z-index: 650 !important;
  }
  
  /* Status pill should not block popup */
  .quake-status-wrap {
    z-index: 800 !important;
  }

  /* Clean earthquake markers */
  .quake-marker-pulse {
    filter: none;
  }

  .widget-body img,
  .widget-body iframe{
    width:100%;
    height:100%;
    object-fit:cover;
    border:none;
    display:block;
  }

  /* Fix Leaflet tile seams */
  .leaflet-tile-container img {
    outline: none !important;
    border: none !important;
  }
  .leaflet-container {
    background: #f5f5f5 !important;
  }
  .leaflet-tile {
    filter: none !important;
    image-rendering: auto !important;
  }

  .badge{
    display:none;
  }

  /* Mini solar pills (Aurora + GOES overlays) */
  .mini-solar{
    position:absolute;
    top:10px;left:10px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    z-index:3;
    pointer-events:none;
  }
  .mini-pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.46);
  	border:none;
    box-shadow:0 0 18px rgba(43,34,244,.10), inset 0 0 16px rgba(255,255,255,.28);
    backdrop-filter:blur(12px);
    -webkit-backdrop-filter:blur(12px);
    color:var(--ink);
    font-weight:900;
    font-size:.74rem;
  }
  .mini-key{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:950;
  }
  .mini-val{color:var(--ink);font-weight:950}

  /* Preserve true-black widget bodies */
  #aurora-body,
  #aurora-canvas,
  #aurora-img-fallback{
    background:#000 !important;
  }
  .widget-body[style*="background:#000"]{
    background:#000 !important;
  }

  /* Canvas + fallback sizing */
  #aurora-canvas,
  #aurora-img-fallback{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }

  /* =========================
     Audio section
     ========================= */
  .audio-section{
    background:var(--paper-strong);
  	border:none;
    border-radius:22px;
    padding:14px;
    box-shadow:var(--glow-main);
    backdrop-filter:blur(22px) saturate(130%);
    -webkit-backdrop-filter:blur(22px) saturate(130%);
  }

  .audio-header-title{
    font-size:.78rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.74);
    font-weight:900;
  }
  .audio-sub{
    margin-top:6px;
    font-size:.86rem;
    color:var(--ink-dim);
    font-weight:650;
    text-transform:uppercase;
    letter-spacing:.06em;
  }

  .play-all{
    margin-top:10px;
    padding:8px 14px;
    border-radius:999px;
  	border:none;
    background:rgba(255,255,255,.46);
    color:var(--ink);
    cursor:pointer;
    font-size:.74rem;
    font-weight:950;
    letter-spacing:.16em;
    text-transform:uppercase;
    box-shadow:0 0 26px rgba(43,34,244,.14), inset 0 0 18px rgba(255,255,255,.26);
  }
  .play-all:hover{
    box-shadow:0 0 34px rgba(43,34,244,.18), inset 0 0 22px rgba(255,255,255,.30);
  }

  /* Spectrum bars (so your audio block doesn't look broken) */
  .spectrum{
    margin-top:12px;
    height:22px;
    display:flex;
    align-items:flex-end;
    gap:6px;
  }
  .spectrum-bar{
    width:10px;
    height:8px;
    border-radius:6px;
    background:rgba(43,34,244,.22);
  	border:none;
    box-shadow:0 0 16px rgba(43,34,244,.10), inset 0 0 12px rgba(255,255,255,.22);
    transition:height .18s ease;
  }
  .spectrum.playing .spectrum-bar:nth-child(1){height:18px}
  .spectrum.playing .spectrum-bar:nth-child(2){height:12px}
  .spectrum.playing .spectrum-bar:nth-child(3){height:20px}
  .spectrum.playing .spectrum-bar:nth-child(4){height:14px}
  .spectrum.playing .spectrum-bar:nth-child(5){height:17px}

  .channels{margin-top:12px;display:flex;flex-direction:column;gap:10px}
  .channel{
    background:var(--paper-soft);
  	border:none;
    border-radius:16px;
    padding:10px;
    box-shadow:var(--glow-soft);
  }
  .channel-name{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:900;
  }
  #a-status{margin-top:6px;color:var(--ink-dim);font-weight:700;font-size:.86rem;text-transform:uppercase;letter-spacing:.06em}
  .slider-row{margin-top:10px}
  input[type="range"]{width:100%}

  #cloud-soundscape-root,
  #cloud-soundscape-root main,
  .panel,
  .content-stack,
  .weather-card{
    background:none !important;
    box-shadow:none !important;
    border:none !important;
    outline:none !important;
  }

  /* Removed transform properties that break position:fixed on modals */

  .sun-timeline,
  .nightsky,
  .widget,
  .forecast7-section,
  .audio-section,
  .bullet,
  .nightsky-item,
  .forecast7-chip{
    -webkit-mask-image: -webkit-radial-gradient(white, black);
    mask-image: radial-gradient(white, black);
    isolation: isolate;
  }

  /* =========================
     MOBILE RESPONSIVE STYLES
     ========================= */
  
  /* Tablet breakpoint */
  @media (max-width: 1024px) {
    .widgets-row {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .weather-alerts-block {
      position: relative;
      top: auto;
      left: auto;
      right: auto;
      margin-top: 12px;
      padding-right: 0;
    }
    
    .weather-top-row {
      padding-right: 120px;
    }
    
    .weather-moon-block .moon-img {
      width: 200px;
      height: 200px;
    }
  }

  /* Mobile breakpoint */
  @media (max-width: 768px) {
    #cloud-soundscape-root main {
      padding: 10px;
      overflow-x: hidden;
    }
    
    .panel {
      gap: 8px;
      overflow: visible;
    }
    
    .content-stack {
      gap: 8px;
      overflow: visible;
    }

    /* Main weather card mobile */
    .left-now {
      padding: 12px;
      border-radius: 16px;
    }
    
    .weather-top-row {
      flex-direction: column;
      align-items: center;
      padding-right: 0;
      min-height: auto;
      gap: 8px;
    }
    
    .weather-left-stack {
      width: 100%;
      align-items: center;
    }
    
    .weather-main {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
    }
    
    .weather-temp-block .temp {
      font-size: 2.6rem;
    }
    
    .weather-temp-block .feels {
      font-size: 0.82rem;
    }
    
    .weather-cond-block .cond-icon-img {
      width: 70px;
      height: 70px;
    }
    
    /* Moon repositioned for mobile */
    .weather-moon-block {
      position: relative;
      top: auto;
      right: auto;
      width: 100%;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      margin-top: 8px;
      border-top: 1px solid rgba(43,34,244,.10);
    }
    
    .weather-moon-block .moon-img {
      width: 80px;
      height: 80px;
      transform: scale(1.19);
    }
    
    .weather-moon-block .moon-text {
      margin-top: 0;
      text-align: left;
    }
    
    /* Alerts mobile */
    .weather-alerts-block {
      position: relative;
      top: auto;
      left: auto;
      right: auto;
      width: 100%;
      align-items: stretch;
      margin-top: 8px;
    }
    
    .weather-alert {
      max-width: 100%;
    }
    
    /* Details rows mobile */
    .weather-details-row {
      margin-top: 10px;
      padding-top: 10px;
    }
    
    .weather-hilo {
      font-size: 0.78rem;
      margin-bottom: 10px;
    }
    
    .weather-stats-grid {
      gap: 4px 10px;
    }
    
    .weather-stat .k {
      font-size: 0.58rem;
    }
    
    .weather-stat .v {
      font-size: 0.62rem;
    }
    
    /* 7-day forecast mobile */
    .forecast7-section {
      padding: 10px;
      border-radius: 14px;
    }
    
    .forecast7-chips {
      gap: 6px;
      padding-bottom: 6px;
      margin: 0;
      padding-left: 0;
      padding-right: 0;
      flex-wrap: nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
    }
    
    .forecast7-chip {
      min-width: 72px;
      flex: 0 0 auto;
      padding: 6px 4px;
      border-radius: 12px;
    }
    
    .forecast7-chip .day {
      font-size: 0.58rem;
    }
    
    .forecast7-chip .icon {
      width: 34px;
      height: 34px;
    }
    
    .forecast7-chip .temps {
      font-size: 0.66rem;
    }
    
    .forecast7-chip .precip {
      font-size: 0.54rem;
    }

    /* Timeline mobile */
    .sun-timeline {
      padding: 10px;
      border-radius: 14px;
      min-height: 140px;
    }
    
    .sun-timeline-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      padding-bottom: 6px;
      margin-bottom: 8px;
    }
    
    .sun-timeline-meta {
      flex-wrap: wrap;
      gap: 8px 12px;
    }
    
    .meta-item {
      gap: 4px;
    }
    
    .meta-key {
      font-size: 0.48rem;
    }
    
    .meta-val {
      font-size: 0.66rem;
    }
    
    .sun-timeline-bar {
      height: 75px;
      min-width: 0;
      width: 100%;
    }
    
    .tl-hour-time {
      font-size: 0.38rem;
    }
    
    .tl-hour-icon {
      width: 14px;
      height: 14px;
    }
    
    .tl-hour-temp {
      font-size: 0.48rem;
    }
    
    .tl-hour-precip {
      font-size: 0.38rem;
    }
    
    .tl-now-bubble {
      bottom: -28px;
      padding: 4px 7px;
      border-radius: 8px;
    }
    
    .tl-now-temp {
      font-size: 0.68rem;
    }
    
    .tl-now-label {
      font-size: 0.40rem;
    }

    /* Night sky mobile */
    .nightsky {
      padding: 10px;
      border-radius: 14px;
    }
    
    .nightsky-top {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      padding-bottom: 6px;
      margin-bottom: 8px;
    }
    
    .nightsky-top .k,
    .nightsky-top .v {
      font-size: 0.54rem;
    }
    
    .nightsky-svgwrap {
      height: 140px;
    }
    
    #night-sky-svg {
      min-width: 0;
      width: 100%;
    }
    
    .nightsky-legend {
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .nightsky-item {
      padding: 4px 8px;
      font-size: 0.60rem;
      gap: 6px;
    }
    
    .nightsky-dot {
      width: 8px;
      height: 8px;
    }
    
    /* Space events mobile */
    .skygrid {
      gap: 8px;
    }
    
    .skcard {
      padding: 8px;
      border-radius: 12px;
    }
    
    .skk {
      font-size: 0.54rem;
    }
    
    .skv {
      font-size: 0.88rem;
    }
    
    .bullets {
      gap: 4px;
    }
    
    .bullet {
      padding: 6px 8px;
      border-radius: 10px;
    }
    
    .bname {
      font-size: 0.52rem;
    }
    
    .btime {
      font-size: 0.66rem;
      min-width: 60px;
    }
    
    .bsub {
      font-size: 0.66rem;
      margin-top: 2px;
    }

    /* Widget grids mobile */
    .widgets-row,
    .widgets-row-two {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    .widget {
      border-radius: 14px;
    }
    
    .widget-head {
      padding: 8px 10px;
    }
    
    .widget-title {
      font-size: 0.54rem;
      letter-spacing: 0.10em;
    }
    
    .widget-title .live-tag {
      font-size: 0.50rem;
    }
    
    .widget-sub {
      font-size: 0.64rem;
      max-width: 50%;
    }
    
    .widget-body {
      aspect-ratio: 16/9;
      min-height: 200px;
      overflow: hidden;
    }
    
    /* Mini pills on widgets mobile */
    .mini-solar {
      top: 6px;
      left: 6px;
      gap: 4px;
    }
    
    .mini-pill {
      padding: 4px 8px;
      gap: 4px;
      font-size: 0.66rem;
    }
    
    .mini-key {
      font-size: 0.56rem;
    }

    /* Location dropdown mobile */
    .loc-name {
      font-size: 1.0rem;
    }
    
    .loc-meta {
      font-size: 0.74rem;
    }
    
    .loc-cycler {
      gap: 0;
    }

    .loc-arrow {
      width: 20px;
      height: 20px;
      opacity: .5;
      min-height: 32px;
    }

    .loc-cycler-center {
      width: 220px;
    }

    /* Hazard map status pills mobile */
    #lightning-status-pill,
    #fire-status-pill,
    #quake-status-pill {
      font-size: 0.60rem;
      padding: 5px 10px;
    }
    
    #glm-toggle-btn {
      font-size: 0.54rem;
      padding: 4px 8px;
    }

    /* Audio section mobile */
    .audio-section {
      padding: 12px;
      border-radius: 16px;
    }
    
    .audio-header-title {
      font-size: 0.70rem;
    }
    
    .audio-sub {
      font-size: 0.78rem;
    }
    
    .play-all {
      padding: 10px 16px;
      font-size: 0.68rem;
    }
    
    .channel {
      padding: 10px;
      border-radius: 12px;
    }
    
    .channel-name {
      font-size: 0.58rem;
    }
  }

  /* Small mobile breakpoint */
  @media (max-width: 480px) {
    #cloud-soundscape-root main {
      padding: 8px;
    }
    
    .left-now {
      padding: 10px;
    }
    
    .weather-temp-block .temp {
      font-size: 2.2rem;
    }
    
    .weather-cond-block .cond-icon-img {
      width: 56px;
      height: 56px;
    }
    
    .weather-moon-block .moon-img {
      width: 65px;
      height: 65px;
    }
    
    .weather-stats-grid {
      gap: 3px 8px;
    }
    
    .weather-stat .k {
      font-size: 0.52rem;
    }
    
    .weather-stat .v {
      font-size: 0.56rem;
    }
    
    .forecast7-chip {
      min-width: 0;
      flex: 1;
      padding: 4px 2px;
    }
    
    .forecast7-chip .icon {
      width: 28px;
      height: 28px;
    }
    
    .forecast7-chip .temps {
      font-size: 0.60rem;
    }
    
    .sun-timeline-bar {
      height: 68px;
    }
    
    .widget-body {
      aspect-ratio: 4/3;
      min-height: 180px;
      overflow: hidden;
    }
    
    .nightsky-svgwrap {
      height: 120px;
    }
    
    #night-sky-svg {
      min-width: 0;
      width: 100%;
    }
    
    .bsub {
      font-size: 0.60rem;
      line-height: 1.3;
    }
  }

  /* Touch-friendly tap targets */
  @media (hover: none) and (pointer: coarse) {
    .loc-arrow {
      min-height: 32px;
      min-width: 32px;
    }
    
    .forecast7-chip {
      min-width: 68px;
    }
    
    .nightsky-item {
      min-height: 36px;
    }
    
    .quake-item,
    .fire-item {
      min-height: 44px;
    }
    
    .play-all {
      min-height: 48px;
    }
    
    }

  /* Landscape mobile */
  @media (max-width: 900px) and (orientation: landscape) {
    .weather-top-row {
      flex-direction: row;
      flex-wrap: wrap;
      padding-right: 100px;
    }
    
    .weather-moon-block {
      position: absolute;
      top: 0;
      right: 10px;
      width: auto;
      flex-direction: column;
      border-top: none;
      padding: 0;
      margin-top: 0;
    }
    
    .weather-moon-block .moon-img {
      width: 90px;
      height: 90px;
    }
    
    .widgets-row,
    .widgets-row-two {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .widget-body {
      aspect-ratio: 16/10;
    }
  }

  /* Safe area insets for notched devices */
  @supports (padding: max(0px)) {
    #cloud-soundscape-root main {
      padding-left: max(10px, env(safe-area-inset-left));
      padding-right: max(10px, env(safe-area-inset-right));
      padding-bottom: max(18px, env(safe-area-inset-bottom));
    }
  }

  /* Fix mobile scroll */
  @media (max-width: 768px) {
    .left-now {
      overflow: hidden !important;
    }
    
    .forecast7-section {
      overflow: hidden !important;
    }
    
    .forecast7-chips {
      overflow: hidden !important;
    }
  }

/* =========================================================
     UNIFIED WIDGET POPUP MODAL SYSTEM
     ========================================================= */
  .alert-modal-overlay{position:absolute;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:99999;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;opacity:0;visibility:hidden;transition:opacity 0.3s ease,visibility 0.3s ease;overflow:auto;}
.alert-modal-overlay.active{opacity:1;visibility:visible;}
.alert-modal-content{position:relative;background:linear-gradient(145deg,rgba(30,30,35,0.98),rgba(20,20,25,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:16px;max-width:600px;width:90vw;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.7);transform:scale(0.92);transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1);}
.alert-modal-overlay.active .alert-modal-content{transform:scale(1);}
.alert-modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.2);}
.alert-modal-title-wrap{display:flex;align-items:center;gap:12px;}
.alert-modal-icon{font-size:24px;}
.alert-modal-title{font-size:18px;font-weight:600;color:#fff;letter-spacing:0.5px;}
.alert-modal-close{background:none;border:none;color:#888;font-size:28px;cursor:pointer;padding:0 8px;line-height:1;transition:color 0.2s;}
.alert-modal-close:hover{color:#fff;}
.alert-modal-body{padding:24px;overflow-y:auto;flex:1;color:#e0e0e0;font-size:14px;line-height:1.6;}
.alert-detail-section{margin-bottom:20px;}
.alert-detail-section:last-child{margin-bottom:0;}
.alert-detail-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;font-weight:500;}
.alert-detail-value{color:#fff;}
.alert-detail-value.warning{color:#f87171;}
.alert-detail-value.watch{color:#fb923c;}
.alert-detail-value.advisory{color:#facc15;}
.alert-timing{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:20px;}
.alert-timing-item{text-align:center;}
.alert-timing-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#666;margin-top:8px;margin-bottom:3px;}
.alert-timing-value{font-size:14px;color:#fff;font-weight:500;}
.alert-description{white-space:pre-wrap;font-family:inherit;background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;border-left:3px solid rgba(255,255,255,0.1);}
.alert-areas{font-size:13px;color:#aaa;line-height:1.5;}
.alert-severity-badge{display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-left:8px;}
.alert-severity-badge.extreme{background:rgba(220,38,38,0.3);color:#fca5a5;}
.alert-severity-badge.severe{background:rgba(239,68,68,0.25);color:#fca5a5;}
.alert-severity-badge.moderate{background:rgba(249,115,22,0.25);color:#fdba74;}
.alert-severity-badge.minor{background:rgba(234,179,8,0.25);color:#fde047;}

.widget-modal-overlay{
    position: absolute;
    inset: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.94);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    box-sizing: border-box;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    overflow: auto;
  }

  .widget-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .widget-modal-content {
    position: relative;
    background: rgba(255,255,255,0.98);
    border-radius: 20px;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255,255,255,0.1);
    overflow: hidden;
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    width: 90vw;
    max-width: 900px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    transform: scale(0.92);
  }

  .widget-modal-overlay.active .widget-modal-content {
    transform: scale(1);
  }

  .widget-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: rgba(43, 34, 244, 0.04);
    border-bottom: 1px solid rgba(43, 34, 244, 0.08);
    flex-shrink: 0;
  }

  .widget-modal-title {
    font-size: 0.72rem;
    font-weight: 850;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: rgba(43, 34, 244, 0.75);
  }

  .widget-modal-subtitle {
    font-size: 0.65rem;
    font-weight: 600;
    color: rgba(43, 34, 244, 0.5);
    margin-left: 12px;
  }

  .widget-modal-close {
    width: 32px;
    height: 32px;
    background: rgba(43, 34, 244, 0.08);
    border: none;
    border-radius: 50%;
    color: rgba(43, 34, 244, 0.6);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .widget-modal-close:hover {
    background: rgba(220, 50, 50, 0.12);
    color: rgba(220, 50, 50, 0.9);
    transform: rotate(90deg);
  }

  .widget-modal-body {
    flex: 1;
    overflow: auto;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
  }

  .widget-modal-body.content-image {
    padding: 16px;
    background: #000;
  }

  .widget-modal-body.content-image img {
    display: block;
    max-width: 100%;
    max-height: calc(85vh - 120px);
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 8px;
    margin: 0 auto;
  }

  .widget-modal-body.content-card {
    padding: 24px;
    background: rgba(255, 255, 255, 1);
    align-items: flex-start;
    justify-content: flex-start;
  }

  .widget-modal-body.content-card > * {
    width: 100%;
    max-width: 100%;
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
  }

  .widget-modal-body .forecast7-chips {
    gap: 12px;
  }

  .widget-modal-body .forecast7-chip {
    padding: 14px 12px;
    min-width: 85px;
  }

  .widget-modal-body .forecast7-chip .icon {
    width: 52px;
    height: 52px;
  }

  .widget-modal-body .forecast7-chip .day {
    font-size: 0.68rem;
  }

  .widget-modal-body .forecast7-chip .temps {
    font-size: 0.82rem;
  }

  .widget-modal-body .today-tl-sky-bar {
    min-height: 220px;
  }

  .widget-modal-body .today-tl-weather-icon {
    font-size: 30px;
  }

  .widget-modal-body .today-tl-weather-temp {
    font-size: 0.92rem;
  }

  .widget-modal-body .nightsky-svgwrap {
    height: 220px;
  }

  .widget-modal-body .nightsky-legend {
    gap: 10px;
  }

  .widget-modal-body .nightsky-item {
    padding: 6px 10px;
    font-size: 0.66rem;
  }

  .widget-modal-body.content-map {
    padding: 0;
    background: #f5f5f5;
  }

  .widget-modal-body.content-map .modal-map-container {
    width: 100%;
    height: calc(85vh - 80px);
    min-height: 400px;
  }

  .widget-modal-body.is-loading {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .widget-modal-body.is-loading::after {
    content: "";
    width: 40px;
    height: 40px;
    border: 3px solid rgba(43, 34, 244, 0.15);
    border-top-color: rgba(43, 34, 244, 0.7);
    border-radius: 50%;
    animation: modal-spin 0.8s linear infinite;
  }

  @keyframes modal-spin {
    to { transform: rotate(360deg); }
  }

  .widget.clickable-widget {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--glow-mid);
  }

  .clickable-card {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--glow-mid);
  }

  .widget.clickable-widget .widget-head {
    position: relative;
  }

  .widget.clickable-widget .widget-head::after {
    content: "";
    position: absolute;
    top: 50%;
    right: 40px;
    transform: translateY(-50%);
    font-size: 14px;
    color: rgba(43, 34, 244, 0.25);
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
  }

  .widget.clickable-widget:hover .widget-head::after {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .widget-modal-overlay {
      padding: 12px;
    }
    
    .widget-modal-content {
      width: 100%;
      max-width: 100%;
      max-height: 92vh;
      border-radius: 16px;
    }
    
    .widget-modal-header {
      padding: 12px 16px;
    }
    
    .widget-modal-title {
      font-size: 0.64rem;
    }
    
    .widget-modal-body {
      padding: 12px;
      min-height: 200px;
    }
    
    .widget-modal-body.content-image img {
      max-height: calc(92vh - 100px);
    }
    
    .widget-modal-body.content-map .modal-map-container {
      height: calc(92vh - 70px);
    }

    .widget.clickable-widget .widget-head::after {
      display: none;
    }
  }

  #widget-modal,
  #alert-modal,
  #dynamic-alert-modal {
    transform: none !important;
    contain: none !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    overflow: auto !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .tl-now-line,
    .spectrum-bar,
    * {
      transition: none !important;
      animation: none !important;
    }
  }

  /* Hide all scrollbars on mobile */
  @media (max-width: 768px) {
    * {
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }
    
    *::-webkit-scrollbar {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
      background: transparent !important;
    }
  }

  /* Force modals to viewport center */
  #alert-modal,
  #widget-modal {
    transform: none !important;
    contain: none !important;
    filter: none !important;
    perspective: none !important;
    will-change: auto !important;
    isolation: auto !important;
  }

  /* Ensure body doesn't create containing block */
  body.modal-open {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
body > #dynamic-alert-modal {
  transform: none !important;
  contain: none !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  overflow: auto !important;
}
  @keyframes goes-spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<!-- SITE LOADING SCREEN -->
<div id="site-loading-screen" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:999999;overflow:hidden;pointer-events:none;">
  <!-- BLUISH at top -->
  <div id="intro-bluish" style="position:absolute;top:6%;left:0;right:0;z-index:3;text-align:center;font-size:clamp(2rem, 10vw, 5rem);font-weight:400;letter-spacing:clamp(0.15em, 2vw, 0.4em);color:#4a9eff;font-family:'QelliaRegular','Bodoni Moda',Georgia,serif;text-shadow:0 0 60px rgba(74,158,255,.5),0 0 120px rgba(74,158,255,.25),0 0 180px rgba(74,158,255,.1);padding-left:clamp(0.15em, 2vw, 0.4em);text-transform:uppercase;">BLUISH</div>
  <!-- VOID stacks down right side -->
  <div id="intro-void-container" style="position:absolute;top:-5%;right:0;bottom:0;z-index:2;display:flex;flex-direction:column;align-items:flex-end;gap:0;overflow:hidden;pointer-events:none;padding-right:clamp(0.75rem, 2vw, 1.5rem);"></div>
</div>
<style>
  @keyframes void-in {
    from { opacity:0; transform:translateY(-4px); }
    to { opacity:1; transform:translateY(0); }
  }
  .void-line {
    font-family:'QelliaRegular','Bodoni Moda',Georgia,serif;
    font-size:0.7rem;
    font-weight:400;
    letter-spacing:.5em;
    color:rgba(74,158,255,0.25);
    animation: void-in 0.25s ease-out forwards;
    line-height:1.6;
    padding-left:.5em;
  }
</style>

<!-- Alert Detail Modal -->
<div id="dashboard-content" style="opacity:0;transition:opacity 0.4s ease;">
<div class="alert-modal-overlay" id="alert-modal">
  <div class="alert-modal-content">
    <div class="alert-modal-header">
      <div class="alert-modal-title-wrap">
        <span class="alert-modal-icon" id="alert-modal-icon"></span>
        <span class="alert-modal-title" id="alert-modal-title">Alert</span>
      </div>
      <button class="alert-modal-close" id="alert-modal-close">&times;</button>
    </div>
    <div class="alert-modal-body" id="alert-modal-body"></div>
  </div>
</div>

<!-- Widget Popup Modal (outside root to avoid backdrop-filter issues) -->
<div class="widget-modal-overlay" id="widget-modal">
  <div class="widget-modal-content">
    <div class="widget-modal-header">
      <div style="display:flex;align-items:baseline;">
        <span class="widget-modal-title" id="modal-title">--</span>
        <span class="widget-modal-subtitle" id="modal-subtitle"></span>
      </div>
      <button class="widget-modal-close" id="widget-modal-close">&times;</button>
    </div>
    <div class="widget-modal-body" id="widget-modal-body"></div>
  </div>
</div>

<div id="cloud-soundscape-root">

  <!-- Screen reader announcements -->
  <div id="sr-announcements" aria-live="polite" aria-atomic="true" style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;"></div>

  <main>
    <section class="panel">
      <div class="content-stack">

        <div class="weather-card">
          <div class="top-grid">

            <!-- Main Weather Section -->
<div class="left-now">
  
  <!-- Top Row: Location, Temp, Condition, Moon -->
  <div class="weather-top-row">
    <div class="weather-left-stack">
      <div class="loc-cycler" id="loc-cycler">
        <div class="loc-cycler-center">
          <div class="loc-name-row">
            <button class="loc-search-toggle" id="loc-search-toggle" aria-label="Search location" title="Search for a location"></button>
            <div class="loc-name pulse-hint" id="loc-name">NYC</div>
            <div class="loc-search-box" id="loc-search-box">
              <input type="text" class="loc-search-input" id="loc-search-input" placeholder="City, zip, park, place..." maxlength="60" autocomplete="off" />
              <button class="loc-search-close" id="loc-search-close" aria-label="Close search"></button>
              <div id="loc-suggestions" style="position:absolute; top:calc(100% + 4px); left:0; right:0; z-index:10000; background:rgba(255,255,255,.15); backdrop-filter:blur(20px) saturate(120%); -webkit-backdrop-filter:blur(20px) saturate(120%); border-radius:12px; max-height:220px; overflow-y:auto; display:none; box-shadow:0 0 30px rgba(255,255,255,.12), inset 0 0 20px rgba(255,255,255,.22);"></div>
            </div>
          </div>
          <div id="loc-meta" style="font-size:.52rem;opacity:.6;text-transform:uppercase;letter-spacing:.08em;color:rgba(255,255,255,.5);padding:0 0 0 4px;margin-top:1px;line-height:1;font-weight:600;">---</div>
          <div class="loc-dots-row">
            <button class="loc-arrow" id="loc-prev" aria-label="Previous location"></button>
            <div class="loc-dots" id="loc-dots"></div>
            <button class="loc-arrow" id="loc-next" aria-label="Next location"></button>
          </div>
        </div>
      </div>
    
      <div class="weather-main">
        <div class="weather-temp-block">
          <div class="temp" id="temp">--</div>
        </div>
        <div class="weather-cond-block">
          <img class="cond-icon-img" id="cond-icon" src="https://basmilius.github.io/weather-icons/production/fill/all/clear-day.svg" alt="Weather condition" />
        </div>
      </div>
    </div>
    
    <!-- Weather Alerts Area (center-right) -->
    <div class="weather-alerts-block" id="weather-alerts"></div>
    
    <div class="weather-moon-block">
      <img class="moon-img" id="moon-mini-img" src="" alt="Current moon phase" />
    </div>
  </div>

  <!-- Details Row -->
  <div class="weather-details-row">
    <div class="weather-hilo" id="today-hi-lo"><span class="feels-inline" id="feels-inline">Feels --</span> <span class="hilo-sep"></span> <span id="hilo-text">High -- | Low --</span></div>
    <div class="weather-stats-grid">
      <div class="weather-stat"><span class="k">Rain</span><span class="v" id="precip-amt">--</span></div>
      <div class="weather-stat"><span class="k">Next hrs</span><span class="v" id="forecast-row">--</span></div>
      <div class="weather-stat"><span class="k">Wind</span><span class="v" id="wind">--</span></div>
      <div class="weather-stat"><span class="k">Gusts</span><span class="v" id="gusts">--</span></div>
      <div class="weather-stat"><span class="k">Humidity</span><span class="v" id="humidity">--</span></div>
      <div class="weather-stat"><span class="k">Pressure</span><span class="v" id="pressure">--</span></div>
      <div class="weather-stat"><span class="k">UV</span><span class="v" id="uv">--</span></div>
    </div>
  </div>

  <!-- Air & Pollen Row -->
  <div class="weather-details-row">
    <div class="weather-stats-grid">
      <div class="weather-stat"><span class="k">AQI</span><span class="ap-val" id="aqi-val">--</span></div>
      <div class="weather-stat"><span class="k">PM2.5</span><span class="v" id="pm25-val">--</span></div>
      <div class="weather-stat"><span class="k">PM10</span><span class="v" id="pm10-val">--</span></div>
      <div class="weather-stat"><span class="k"> Tree</span><span class="pollen-val" id="pollen-tree">--</span></div>
      <div class="weather-stat"><span class="k"> Grass</span><span class="pollen-val" id="pollen-grass">--</span></div>
      <div class="weather-stat"><span class="k"> Weed</span><span class="pollen-val" id="pollen-weed">--</span></div>
      <div class="weather-stat"><span class="k"> Ragweed</span><span class="pollen-val" id="pollen-ragweed">--</span></div>
    </div>
  </div>
<!-- 7-Day Forecast -->
  <div class="forecast7-section">
    <div class="forecast7-top">
      <div class="forecast7-label" id="forecast-label">7 DAY FORECAST</div>
    </div>
    <div class="forecast7-chips" id="forecast7"></div>
  </div>
</div>
            
<!-- /Left -->

          </div>

          <!-- TODAY Timeline Widget (v4/v5 integrated) -->
          <div class="today-timeline-card" id="today-timeline-card">
            
            <!-- Main timeline body -->
            <div class="today-tl-body">
              
              <!-- Top bars: Kp and Cloud -->
              <div class="today-tl-top-bars">
                <div class="today-tl-bar-row">
                  <div class="today-tl-bar-label">Kp <span id="today-tl-kp-val" style="font-size:.52rem;font-weight:700;opacity:.85"></span></div>
                  <div class="today-tl-bar-track" id="today-tl-kp-track"></div>
                </div>
                <div class="today-tl-bar-row">
                  <div class="today-tl-bar-label"> <span id="today-tl-cloud-pct" style="font-size:.52rem;font-weight:700;opacity:.85"></span></div>
                  <div class="today-tl-bar-track cloud" id="today-tl-cloud-track"></div>
                </div>
              </div>
              
              <!-- Sky bar with planets + weather -->
              <div class="today-tl-sky-bar" id="today-tl-sky-bar">
                
                <!-- Sky gradient bands -->
                <div class="today-tl-sky-bands" id="today-tl-sky-bands"></div>
                
                <!-- Planet visibility tracks -->
                <div class="today-tl-planet-tracks" id="today-tl-planet-tracks"></div>
                
                <!-- Weather row with animated icons -->
                <div class="today-tl-weather-row" id="today-tl-weather-row"></div>
                
                <!-- NOW marker -->
                <div class="today-tl-now-marker" id="today-tl-now-marker" style="display:none;">
                  <div class="today-tl-now-label">NOW</div>
                  <div class="today-tl-now-bubble">
                    <span class="today-tl-now-temp" id="today-tl-now-temp">--</span>
                    <span class="today-tl-now-time" id="today-tl-now-time">--:--</span>
                  </div>
                </div>
                
              </div>
            </div>
            
            <!-- Legend -->
            <div class="today-tl-legend" id="today-tl-legend">
              <!-- Sun times: Sunrise/Sunset + Golden Hours -->
              <div class="today-tl-legend-item" style="gap:2px;">
                <div style="display:flex;align-items:center;gap:4px;font-size:.55rem;font-weight:700;color:var(--ink);">
                  <span id="today-tl-sunrise" style="color:#e8a954;">--:--</span>
                  <span style="color:rgba(var(--ink-rgb),.3);">|</span>
                  <span id="today-tl-sunset" style="color:#e8a954;">--:--</span>
                </div>
                <div style="font-size:.48rem;font-weight:600;color:rgba(var(--ink-rgb),.5);">AM <span id="today-tl-golden-am" style="color:#e8a954;">--</span></div>
                <div style="font-size:.48rem;font-weight:600;color:rgba(var(--ink-rgb),.5);">PM <span id="today-tl-golden-pm" style="color:#e8a954;">--</span></div>
              </div>
              <!-- Daylight -->
              <div class="today-tl-legend-item" style="gap:2px;">
                <div style="font-size:.55rem;font-weight:700;color:var(--ink);" id="today-tl-daylight">--</div>
                <div style="font-size:.48rem;font-weight:600;color:#4ecdc4;" id="today-tl-daylight-change">--</div>
              </div>
              <!-- Moon -->
              <div class="today-tl-legend-item" style="gap:1px;">
                <div style="font-size:.5rem;font-weight:700;color:var(--ink);" id="today-tl-moon-name">--</div>
                <div style="font-size:.48rem;font-weight:600;color:rgba(var(--ink-rgb),.5);" id="today-tl-moon-illum">--%</div>
              </div>
              <div class="today-tl-legend-item" id="today-tl-legend-moon-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-moon" id="today-tl-legend-moon"></div>Moon</div>
                <span class="today-tl-legend-dir" id="legend-dir-moon"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#9A9A9A;"></div>Mercury</div>
                <span class="today-tl-legend-dir" id="legend-dir-mercury"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#FFE5B4;"></div>Venus</div>
                <span class="today-tl-legend-dir" id="legend-dir-venus"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#C44D2A;"></div>Mars</div>
                <span class="today-tl-legend-dir" id="legend-dir-mars"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#E8A954;"></div>Jupiter</div>
                <span class="today-tl-legend-dir" id="legend-dir-jupiter"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#F0C75E;"></div>Saturn</div>
                <span class="today-tl-legend-dir" id="legend-dir-saturn"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#8ECAE6;"></div>Uranus</div>
                <span class="today-tl-legend-dir" id="legend-dir-uranus"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#4AA3DF;"></div>Neptune</div>
                <span class="today-tl-legend-dir" id="legend-dir-neptune"></span>
              </div>
              <!-- Kp scale -->
              <div class="today-tl-legend-item">
                <div class="today-tl-kp-scale">
                  <span>Kp 0</span>
                  <div class="today-tl-kp-box" style="background:#009933;"></div>
                  <div class="today-tl-kp-box" style="background:#33cc33;"></div>
                  <div class="today-tl-kp-box" style="background:#66cc33;"></div>
                  <div class="today-tl-kp-box" style="background:#99cc33;"></div>
                  <div class="today-tl-kp-box" style="background:#cccc33;"></div>
                  <div class="today-tl-kp-box" style="background:#ffff00;"></div>
                  <div class="today-tl-kp-box" style="background:#ffcc00;"></div>
                  <div class="today-tl-kp-box" style="background:#ff9900;"></div>
                  <div class="today-tl-kp-box" style="background:#ff3333;"></div>
                  <div class="today-tl-kp-box" style="background:#cc0033;"></div>
                  <span>9</span>
                </div>
              </div>
              <!-- Cloud scale -->
              <div class="today-tl-legend-item">
                <div class="today-tl-kp-scale">
                  <span></span>
                  <div class="today-tl-kp-box" style="background:#ffffff;border:1px solid rgba(0,0,0,0.1);"></div>
                  <div class="today-tl-kp-box" style="background:#c8c8c8;"></div>
                  <div class="today-tl-kp-box" style="background:#8c8c8c;"></div>
                  <div class="today-tl-kp-box" style="background:#5a5a5a;"></div>
                  <span></span>
                </div>
              </div>
            </div>
            
          </div>

          <!-- Full-width Timeline (existing - kept for compatibility) -->
          <div class="sun-timeline" id="sun-timeline" aria-label="daily sun and weather timeline" style="display:none;">
            
            <!-- Header row -->
            <div class="sun-timeline-header">
              <div class="sun-timeline-title">
                <span class="sun-label-text">TODAY'S TIMELINE</span>
              </div>
              <div class="sun-timeline-meta">
                <span class="meta-item"><span class="meta-key">Sunrise</span> <span class="meta-val" id="tl-sunrise">--:--</span></span>
                <span class="meta-item"><span class="meta-key">Sunset</span> <span class="meta-val" id="tl-sunset">--:--</span></span>
                <span class="meta-item"><span class="meta-key">Golden AM</span> <span class="meta-val" id="tl-golden-am">--</span></span>
                <span class="meta-item"><span class="meta-key">Golden PM</span> <span class="meta-val" id="tl-golden-pm">--</span></span>
                <span class="meta-item"><span class="meta-key">Daylight</span> <span class="meta-val" id="tl-daylight">--</span></span>
                <span class="meta-item"><span class="meta-val" id="tl-daylight-change">--</span></span>
              </div>
            </div>

            <!-- Main timeline bar -->
            <div class="sun-timeline-bar" id="sun-timeline-bar">
              
              <!-- Background bands (golden hour, blue hour shading) -->
              <div class="tl-bands" id="tl-bands"></div>
              
              <!-- Hour markers and weather data -->
              <div class="tl-hours" id="tl-hours"></div>
              
              <!-- Sun event ticks -->
              <div class="tl-events" id="tl-events"></div>
              
              <!-- NOW marker -->
              <div class="tl-now" id="tl-now">
                <div class="tl-now-line"></div>
                <div class="tl-now-bubble">
                  <span class="tl-now-temp" id="tl-now-temp">--</span>
                  <span class="tl-now-label">NOW</span>
                </div>
              </div>

            </div>

            <!-- Event labels below bar -->
            <div class="tl-event-labels" id="tl-event-labels"></div>

          </div>

          <!-- WIDGETS -->
          
          <!-- ROW 1B: RADAR -->
          <div class="widgets-row" style="grid-template-columns:1fr;margin-top:12px;margin-bottom:12px;">

            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">RADAR</div>
                <a id="fcast-source-link" href="https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=gfs&area=conus" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;display:none;">GFS NCEP</a>
              </div>
              <div class="widget-body" style="background:rgba(255,255,255,.06);position:relative;overflow:hidden;">
                <div id="fcast-img-container" style="position:absolute;top:28px;left:140px;right:130px;bottom:0;overflow:hidden;">
                  <img id="fcast-radar-img" alt="" style="width:100%;height:100%;object-fit:contain;object-position:center center;filter:invert(1) hue-rotate(180deg) contrast(1.2) saturate(1.5);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1;opacity:0;" />
                  <div id="fcast-loading" style="position:absolute;top:0;left:0;right:0;bottom:0;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;pointer-events:none;transition:opacity .3s;">
                    <div style="width:28px;height:28px;border:3px solid rgba(43,34,244,.15);border-top-color:rgba(43,34,244,.6);border-radius:50%;animation:fcast-spin 1s linear infinite;"></div>
                    <div style="font-size:.55rem;font-weight:700;color:rgba(43,34,244,.45);letter-spacing:.1em;text-transform:uppercase;font-family:system-ui,sans-serif;">Loading radar...</div>
                  </div>
                </div>

                <!-- Left panel controls -->
                <div id="fcast-left-panel" style="position:absolute;top:10px;left:0;bottom:60px;z-index:10;display:flex;flex-direction:column;align-items:flex-start;gap:2px;overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none;padding:4px 4px;-webkit-mask-image:linear-gradient(to bottom, black 0%, black 80%, transparent 100%);mask-image:linear-gradient(to bottom, black 0%, black 80%, transparent 100%);">
                  <!-- LIVE -->
                  <button onclick="switchFcastRange('live')" id="fcast-range-live" style="padding:8px 20px;border-radius:10px;border:none;background:rgba(220,38,38,.85);backdrop-filter:blur(8px);color:#fff;font-size:.78rem;font-weight:800;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.08em;box-shadow:0 0 16px rgba(220,38,38,.3);"> LIVE</button>
                  <div style="width:30px;border-top:1px solid rgba(255,255,255,.1);margin:2px 0;"></div>
                  <!-- FORECAST label -->
                  <div id="fcast-forecast-label" style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-left:1px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;">FORECAST</div>
                  <div id="fcast-range-area" style="display:flex;flex-direction:column;align-items:stretch;gap:3px;width:100%;">
                    <button onclick="switchFcastRange('tomorrow')" id="fcast-range-tomorrow" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:center;">Tomorrow</button>
                    <div style="display:flex;gap:3px;">
                      <button onclick="switchFcastRange('48h')" id="fcast-range-48h" style="flex:1;padding:5px 0;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:center;">48 HR</button>
                      <button onclick="switchFcastRange('72h')" id="fcast-range-72h" style="flex:1;padding:5px 0;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:center;">72 HR</button>
                    </div>
                    <div style="display:flex;gap:3px;">
                      <button onclick="switchFcastRange('7d')" id="fcast-range-7d" style="flex:1;padding:5px 0;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:center;">7 DAY</button>
                      <button onclick="switchFcastRange('16d')" id="fcast-range-16d" style="flex:1;padding:5px 0;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:center;">16 DAY</button>
                    </div>
                  </div>
                  <!-- MODELS -->
                  <div id="fcast-models-label" style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-left:1px;margin-top:10px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;">MODELS</div>
                  <button onclick="switchFcastModel('gfs')" id="fcast-model-gfs" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(255,140,0,.15);backdrop-filter:blur(12px);color:rgba(255,140,0,.95);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">GFS 16D</button>
                  <button onclick="switchFcastModel('nam')" id="fcast-model-nam" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">NAM 84H</button>
                  <button onclick="switchFcastModel('nam_hires')" id="fcast-model-nam_hires" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">NAM 3KM 60H</button>
                  <button onclick="switchFcastModel('hrrr')" id="fcast-model-hrrr" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">HRRR 3KM 48H</button>
                  <button onclick="switchFcastModel('href')" id="fcast-model-href" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">HREF ENS 48H</button>
                  <button onclick="switchFcastModel('nbm')" id="fcast-model-nbm" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">NBM BLEND</button>
                  <button onclick="switchFcastModel('gefs')" id="fcast-model-gefs" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">GEFS SPREAD</button>
                  <!-- AREAS label -->
                  <div style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-left:1px;margin-top:10px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;">AREAS</div>
                  <!-- Area selector -->
                  <div id="fcast-area-selector" style="display:flex;flex-direction:column;gap:3px;max-width:130px;">
                    <button onclick="switchFcastArea('conus')" id="fcast-area-conus" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">CONTINENTAL US</button>
                    <button onclick="switchFcastArea('namer')" id="fcast-area-namer" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">NORTH AMERICA</button>
                    <div id="fcast-area-sub-east" style="font-size:.55rem;font-weight:700;color:rgba(43,34,244,.45);font-family:system-ui,sans-serif;letter-spacing:.06em;text-transform:uppercase;padding-left:2px;margin-top:6px;">EAST</div>
                    <button onclick="switchFcastArea('us-ne')" id="fcast-area-us-ne" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">NORTHEAST</button>
                    <button onclick="switchFcastArea('us-se')" id="fcast-area-us-se" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTHEAST</button>
                    <div id="fcast-area-sub-central" style="font-size:.55rem;font-weight:700;color:rgba(43,34,244,.45);font-family:system-ui,sans-serif;letter-spacing:.06em;text-transform:uppercase;padding-left:2px;margin-top:6px;">CENTRAL</div>
                    <button onclick="switchFcastArea('us-nc')" id="fcast-area-us-nc" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">GREAT LAKES</button>
                    <button onclick="switchFcastArea('us-sc')" id="fcast-area-us-sc" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTH CENTRAL</button>
                    <button onclick="switchFcastArea('upper-ms')" id="fcast-area-upper-ms" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">UPPER MISS VALLEY</button>
                    <button onclick="switchFcastArea('south-ms')" id="fcast-area-south-ms" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTH MISS VALLEY</button>
                    <button onclick="switchFcastArea('s-plains')" id="fcast-area-s-plains" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTH PLAINS</button>
                    <div id="fcast-area-sub-west" style="font-size:.55rem;font-weight:700;color:rgba(43,34,244,.45);font-family:system-ui,sans-serif;letter-spacing:.06em;text-transform:uppercase;padding-left:2px;margin-top:6px;">WEST</div>
                    <button onclick="switchFcastArea('us-nw')" id="fcast-area-us-nw" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">PACIFIC NW</button>
                    <button onclick="switchFcastArea('us-sw')" id="fcast-area-us-sw" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">PACIFIC SW</button>
                    <button onclick="switchFcastArea('n-rockies')" id="fcast-area-n-rockies" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">NORTH ROCKIES</button>
                    <button onclick="switchFcastArea('s-rockies')" id="fcast-area-s-rockies" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTH ROCKIES</button>
                    <button onclick="switchFcastArea('north-pac')" id="fcast-area-north-pac" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">NORTH PACIFIC</button>
                    <button onclick="switchFcastArea('east-pac')" id="fcast-area-east-pac" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">EAST PACIFIC</button>
                    <button onclick="switchFcastArea('west-atl')" id="fcast-area-west-atl" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">WEST ATLANTIC</button>
                    <button onclick="switchFcastArea('atlantic')" id="fcast-area-atlantic" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">ATLANTIC</button>
                    <button onclick="switchFcastArea('arctic')" id="fcast-area-arctic" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">ARCTIC</button>
                    <button onclick="switchFcastArea('europe')" id="fcast-area-europe" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">EUROPE</button>
                    <button onclick="switchFcastArea('asia')" id="fcast-area-asia" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">ASIA</button>
                    <button onclick="switchFcastArea('africa')" id="fcast-area-africa" style="display:none;padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">AFRICA</button>
                  </div>
                </div>
                <div id="fcast-right-panel" style="position:absolute;top:10px;right:6px;bottom:60px;z-index:10;display:flex;flex-direction:column;align-items:flex-end;gap:3px;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;-ms-overflow-style:none;padding-right:2px;opacity:.25;pointer-events:none;transition:opacity .3s;-webkit-mask-image:linear-gradient(to bottom, black 0%, black 80%, transparent 100%);mask-image:linear-gradient(to bottom, black 0%, black 80%, transparent 100%);">
                  <!-- PRECIPITATION -->
                  <div style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;margin-top:8px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;text-align:right;">PRECIPITATION</div>
                  <button onclick="switchFcastProduct('sim_radar')" id="fcast-tab-sim" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Reflectivity</button>
                  <button onclick="switchFcastProduct('max_ref')" id="fcast-tab-maxref" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Max Refl</button>
                  <button onclick="switchFcastProduct('radar_1km')" id="fcast-tab-radar1km" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1km Refl</button>
                  <button onclick="switchFcastProduct('echo_top')" id="fcast-tab-echotop" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Echo Tops</button>
                  <button onclick="switchFcastProduct('precip_type')" id="fcast-tab-ptype" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Precip Type</button>
                  <button onclick="switchFcastProduct('precip_total')" id="fcast-tab-ptot" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(255,140,0,.15);backdrop-filter:blur(12px);color:rgba(255,140,0,.95);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Precip Totals</button>
                  <button onclick="switchFcastProduct('precip_1hr')" id="fcast-tab-precip1hr" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1hr Precip</button>
                  <button onclick="switchFcastProduct('precip_6hr')" id="fcast-tab-precip6hr" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">6hr Precip</button>
                  <button onclick="switchFcastProduct('precip_24hr')" id="fcast-tab-precip24hr" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">24hr Precip</button>
                  <button onclick="switchFcastProduct('snow_accum')" id="fcast-tab-snow" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Snow Accum</button>
                  <button onclick="switchFcastProduct('cape')" id="fcast-tab-cape" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Precip Water</button>
                  <div style="width:30px;border-top:1px solid rgba(255,255,255,.1);margin:2px 0;"></div>
                  <!-- TEMPERATURE & THICKNESS -->
                  <div style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;margin-top:8px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;text-align:right;">TEMPERATURE</div>
                  <button onclick="switchFcastProduct('temperature')" id="fcast-tab-temp" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Temp & Precip</button>
                  <button onclick="switchFcastProduct('wnd_temp')" id="fcast-tab-wndtemp" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Wind & 2m Temp</button>
                  <button onclick="switchFcastProduct('low_thick')" id="fcast-tab-lowthick" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1000-850 Thick</button>
                  <button onclick="switchFcastProduct('mid_thick')" id="fcast-tab-midthick" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">850-700 Thick</button>
                  <button onclick="switchFcastProduct('gfs_850temp')" id="fcast-tab-gfs850temp" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">850mb Temp</button>
                  <button onclick="switchFcastProduct('850temp')" id="fcast-tab-850temp" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">850mb Temp</button>
                  <div style="width:30px;border-top:1px solid rgba(255,255,255,.1);margin:2px 0;"></div>
                  <!-- WIND & DYNAMICS -->
                  <div style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;margin-top:8px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;text-align:right;">WIND & DYNAMICS</div>
                  <button onclick="switchFcastProduct('wind')" id="fcast-tab-wind" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Wind & MSLP</button>
                  <button onclick="switchFcastProduct('max_wind')" id="fcast-tab-maxwind" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Max Wind</button>
                  <button onclick="switchFcastProduct('jet_stream')" id="fcast-tab-jet" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Jet Stream</button>
                  <button onclick="switchFcastProduct('gfs_500wind')" id="fcast-tab-gfs500wind" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">500mb Wind</button>
                  <button onclick="switchFcastProduct('250wind')" id="fcast-tab-250wind" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">250mb Jets</button>
                  <button onclick="switchFcastProduct('gfs_fourpanel')" id="fcast-tab-gfs4panel" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">4-Panel</button>
                  <div style="width:30px;border-top:1px solid rgba(255,255,255,.1);margin:2px 0;"></div>
                  <!-- SEVERE WEATHER -->
                  <div id="fcast-severe-label" style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;margin-top:8px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;text-align:right;">SEVERE</div>
                  <button onclick="switchFcastProduct('best_cape')" id="fcast-tab-bestcape" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Best CAPE</button>
                  <button onclick="switchFcastProduct('helicity')" id="fcast-tab-helicity" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Helicity</button>
                  <button onclick="switchFcastProduct('updraft')" id="fcast-tab-updraft" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Updraft Hlcy</button>
                  <button onclick="switchFcastProduct('lightning')" id="fcast-tab-lightning" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Lightning</button>
                  <div id="fcast-hrrr-divider" style="width:30px;border-top:1px solid rgba(255,255,255,.1);margin:2px 0;"></div>
                  <!-- UPPER AIR -->
                  <div style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;margin-top:8px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;text-align:right;">UPPER AIR</div>
                  <button onclick="switchFcastProduct('humidity')" id="fcast-tab-rh" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">700mb Humidity</button>
                  <button onclick="switchFcastProduct('gfs_500rh')" id="fcast-tab-gfs500rh" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">500mb RH</button>
                  <button onclick="switchFcastProduct('gfs_850vort')" id="fcast-tab-gfs850vort" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">850mb Vort</button>
                  <button onclick="switchFcastProduct('500vort')" id="fcast-tab-500vort" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">500mb Vort</button>
                  <button onclick="switchFcastProduct('500mb')" id="fcast-tab-500mb" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">500mb Vort & Ht</button>
                  <div style="width:30px;border-top:1px solid rgba(255,255,255,.1);margin:2px 0;"></div>
                  <!-- AVIATION -->
                  <div id="fcast-aviation-label" style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;margin-top:8px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;text-align:right;">AVIATION</div>
                  <button onclick="switchFcastProduct('visibility')" id="fcast-tab-vis" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Visibility</button>
                  <button onclick="switchFcastProduct('ceiling')" id="fcast-tab-ceiling" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Ceiling</button>
                  <!-- STRATOSPHERE -->
                  <div style="font-size:.62rem;font-weight:700;color:rgba(43,34,244,.55);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;margin-top:8px;border-bottom:1px solid rgba(43,34,244,.15);padding-bottom:2px;margin-bottom:1px;align-self:stretch;text-align:right;">STRATOSPHERE</div>
                  <button onclick="switchFcastProduct('10mb')" id="fcast-tab-10mb" style="padding:5px 10px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.58rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">10mb Strato</button>
                </div>
                <!-- Forecast hour stepper -->
                <div id="fcast-playback-bar" style="position:absolute;top:0;left:140px;right:130px;z-index:11;display:flex;align-items:center;justify-content:center;pointer-events:none;">
                  <div style="display:flex;align-items:center;padding:4px 10px;background:rgba(200,200,210,.2);backdrop-filter:blur(12px);pointer-events:auto;width:100%;justify-content:center;border-bottom:1px solid rgba(43,34,244,.06);gap:0;">
                  <button onclick="fcastRadarTogglePlay()" id="fcast-radar-play-btn" style="background:none;border:none;color:rgba(43,34,244,.55);font-size:.9rem;cursor:pointer;padding:2px 10px 2px 2px;font-family:system-ui;border-right:1px solid rgba(43,34,244,.1);margin-right:10px;"></button>
                  <button onclick="fcastRadarStep(-1)" style="background:none;border:none;color:rgba(43,34,244,.55);font-size:.85rem;cursor:pointer;padding:2px 6px;font-family:system-ui;"></button>
                  <span id="fcast-radar-label" style="font-size:.58rem;font-weight:700;color:rgba(43,34,244,.65);font-family:system-ui,sans-serif;min-width:180px;text-align:center;letter-spacing:.03em;">F003  +3H</span>
                  <button onclick="fcastRadarStep(1)" style="background:none;border:none;color:rgba(43,34,244,.55);font-size:.85rem;cursor:pointer;padding:2px 6px;font-family:system-ui;"></button>
                  </div>
                </div>
                <div class="badge" id="fcast-badge">LIVE RADAR</div>
              </div>
              <!-- RADAR INFO PANEL - outside widget-body -->
              <div id="fcast-info-panel" style="border-radius:0 0 12px 12px;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);font-family:system-ui,sans-serif;overflow:hidden;">
                <div id="fcast-info-header" style="display:flex;justify-content:space-between;align-items:center;padding:8px 14px;">
                  <div id="fcast-info-title-bar" style="font-size:.65rem;font-weight:800;color:rgba(43,34,244,.85);letter-spacing:.05em;text-transform:uppercase;"></div>
                  <button id="fcast-info-toggle" onclick="toggleFcastInfo()" style="background:rgba(200,200,210,.4);border:none;border-radius:6px;color:rgba(43,34,244,.6);font-size:.45rem;font-weight:700;cursor:pointer;padding:3px 8px;font-family:system-ui,sans-serif;letter-spacing:.03em;flex-shrink:0;">HIDE </button>
                </div>
                <div id="fcast-info-body" style="padding:6px 14px 10px;max-height:300px;overflow-y:auto;scrollbar-width:thin;line-height:1.5;">
                  <style>#fcast-info-text b{color:rgba(43,34,244,.85);font-weight:700;text-transform:uppercase;}#fcast-info-text span{font-weight:700;}#fcast-info-text .info-section{margin-bottom:10px;}#fcast-info-text .info-heading{font-size:.66rem;font-weight:800;color:rgba(43,34,244,.75);text-transform:uppercase;letter-spacing:.05em;margin-top:12px;margin-bottom:2px;padding-bottom:3px;border-bottom:2px solid rgba(43,34,244,.25);display:block;}#fcast-info-text .k{color:rgba(43,34,244,.85);font-weight:800;}#fcast-info-text a{color:rgba(43,34,244,.75);text-decoration:underline;text-decoration-color:rgba(43,34,244,.3);text-underline-offset:2px;font-weight:600;}#fcast-info-text a:hover{color:rgba(255,140,0,.9);text-decoration-color:rgba(255,140,0,.5);}</style>
                  <div id="fcast-info-text" style="font-size:.6rem;color:rgba(43,34,244,.55);letter-spacing:.01em;"></div>
                </div>
              </div>
            </div>

          </div>

          <!-- ROW 2: CLOUDS -->
          <div class="widgets-row" style="grid-template-columns:1fr">

            <!-- GOES CLOUDS -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">CLOUDS <span class="live-tag" id="goes-live"> LIVE</span></div>
                <a href="https://www.star.nesdis.noaa.gov/goes/sector.php?sat=G16&sector=ne" data-fallback="https://www.star.nesdis.noaa.gov/goes/index.php" title="GOES-16 NE Sector  Fallback: star.nesdis.noaa.gov/goes" target="_blank" rel="noopener" class="widget-sub" id="goes-sub" style="text-decoration:none;color:inherit;">NESDIS/STAR GOES</a>
              </div>
              <div class="widget-body">
                <!-- Duration selector -->
                <div style="position:absolute;top:10px;right:10px;z-index:10;display:flex;gap:3px;">
                  <button onclick="switchGoesLength('1h')" id="goes-len-1h" style="padding:3px 7px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1h</button>
                  <button onclick="switchGoesLength('6h')" id="goes-len-6h" style="padding:3px 7px;border-radius:8px;border:none;background:rgba(255,140,0,.15);backdrop-filter:blur(12px);color:rgba(255,140,0,.95);font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">6h</button>
                  <button onclick="switchGoesLength('12h')" id="goes-len-12h" style="padding:3px 7px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">12h</button>
                  <button onclick="switchGoesLength('24h')" id="goes-len-24h" style="padding:3px 7px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">24h</button>
                  <button onclick="switchGoesLength('48h')" id="goes-len-48h" style="padding:3px 7px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">48 HOUR | 2 DAY</button>
                </div>
                <canvas id="goes-canvas" style="width:100%;height:100%;display:block;"></canvas>
                <div id="goes-loading-overlay" style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:5;transition:opacity .6s;">
                  <div style="width:28px;height:28px;border:3px solid rgba(255,255,255,.15);border-top-color:#4ecdc4;border-radius:50%;animation:goes-spin .8s linear infinite;"></div>
                  <div id="goes-loading-text" style="margin-top:8px;font-size:.55rem;font-weight:700;color:rgba(255,255,255,.7);font-family:system-ui,sans-serif;letter-spacing:.05em;">CHASING CLOUDS...</div>
                </div>
                <div class="badge">NESDIS/STAR</div>
              </div>
            </div>

          </div>

          <!-- ROW 3: HAZARD MAPS - Lightning / Wildfires / Earthquakes -->
          <div class="widgets-row">

            <!-- LIGHTNING -->
<div class="widget map-widget">
  <div class="widget-head">
    <div class="widget-title">LIGHTNING <span class="live-tag" id="lightning-live"> LIVE</span></div>
    <a href="https://www.blitzortung.org/en/live_lightning_maps.php" target="_blank" rel="noopener" class="widget-sub" id="lightning-sub" style="text-decoration:none;color:inherit;">Blitzortung</a>
  </div>
  <div class="widget-body" style="position:relative;overflow:hidden;border-radius:0 0 8px 8px;">
    <iframe id="lightning-iframe" src="" style="width:100%;height:100%;border:none;border-radius:8px;" loading="lazy" allow="geolocation" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>
</div>

            <!-- WILDFIRES / TORNADOES / EARTHQUAKES  UNIFIED HAZARD MAP -->
            <div class="widget map-widget" id="hazard-widget" style="grid-column:1/-1;">
              <div class="widget-head" style="position:relative;flex-direction:column;gap:0;padding-bottom:0;">
                <div style="display:flex;align-items:center;justify-content:space-between;width:100%;padding-bottom:6px;">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <div class="widget-title" id="hazard-title">NATURAL HAZARDS <span class="live-tag" id="hazard-live"> LIVE</span></div>
                    <span id="fire-live" style="display:none;"></span>
                    <span id="tornado-live" style="display:none;"></span>
                    <span id="quake-live" style="display:none;"></span>
                  </div>
                  <span class="widget-sub" id="hazard-sources" style="display:inline-flex;gap:0;flex-wrap:wrap;"><a href="https://www.nifc.gov/fire-information" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">NIFC</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://firms.modaps.eosdis.nasa.gov/map/" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">FIRMS</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://www.ospo.noaa.gov/products/land/hms.html" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">HMS</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://www.spc.noaa.gov" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">SPC</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://earthquake.usgs.gov" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">USGS</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://macrostrat.org" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">Macrostrat</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://api.weather.gov" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">NWS</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://water.noaa.gov" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">AHPS</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://www.wpc.ncep.noaa.gov" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">WPC</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://www.epa.gov/enviro" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">EPA</a><span style="opacity:.5;margin:0 3px;">+</span><a href="https://openaq.org" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">OpenAQ</a></span>
                </div>
                <div style="width:calc(100% + 24px);margin-left:-12px;margin-bottom:-1px;padding:0;">
                  <div class="geo-tabs" id="hazard-tabs" style="width:100%;border-radius:0;margin:0;">
                    <button class="geo-tab active" data-hazard="fire" onclick="switchHazardTab('fire')">WILDFIRE <span class="hazard-badge" id="hazard-badge-fire" style="font-size:.7rem;"></span><span class="radar-info-icon hazard-info" data-hazard-info="fire" onclick="event.stopPropagation();showHazardTooltip('fire',this)"></span></button>
                    <button class="geo-tab" data-hazard="quake" onclick="switchHazardTab('quake')">EARTHQUAKE <span class="hazard-badge" id="hazard-badge-quake" style="font-size:.7rem;"></span><span class="radar-info-icon hazard-info" data-hazard-info="quake" onclick="event.stopPropagation();showHazardTooltip('quake',this)"></span></button>
                    <button class="geo-tab" data-hazard="tornado" onclick="switchHazardTab('tornado')">TORNADO <span class="hazard-badge" id="hazard-badge-tornado" style="font-size:.7rem;"></span><span class="radar-info-icon hazard-info" data-hazard-info="tornado" onclick="event.stopPropagation();showHazardTooltip('tornado',this)"></span></button>
                    <button class="geo-tab" data-hazard="flood" onclick="switchHazardTab('flood')">FLOOD <span class="hazard-badge" id="hazard-badge-flood" style="font-size:.7rem;"></span><span class="radar-info-icon hazard-info" data-hazard-info="flood" onclick="event.stopPropagation();showHazardTooltip('flood',this)"></span></button>
                  </div>
                </div>
              </div>
              <div id="hazard-accent" style="background:linear-gradient(90deg,#f97316,#fb923c);"></div>
              <div class="widget-body" style="position:relative;min-height:600px;overflow:hidden;">
                <div id="hazard-map" style="width:100%;height:100%;background:#1a1a2e;position:absolute;top:0;left:0;right:0;bottom:0;"></div>

                <!-- UNIFIED STATUS PILL  always visible at top-left -->
                <div id="hazard-status-pill" style="position:absolute;top:10px;left:10px;z-index:600;pointer-events:auto;display:flex;gap:6px;flex-wrap:wrap;max-width:200px;font-family:system-ui,sans-serif;">
                  <div id="hz-pill-fire" class="hz-pill" style="display:none;background:rgba(0,0,0,.78);backdrop-filter:blur(10px);border-radius:8px;padding:6px 8px;font-size:.5rem;font-weight:700;color:#fb923c;max-width:200px;">
                    <div id="hz-pill-fire-head">FIRES: --</div>
                    <div id="hz-pill-fire-list" style="margin-top:4px;border-top:1px solid rgba(255,255,255,.06);padding-top:3px;"></div>
                  </div>
                  <div id="hz-pill-quake" class="hz-pill" style="display:none;background:rgba(0,0,0,.78);backdrop-filter:blur(10px);border-radius:8px;padding:6px 8px;font-size:.5rem;font-weight:700;color:#60a5fa;max-width:200px;">
                    <div id="hz-pill-quake-head">EARTHQUAKES: --</div>
                    <div id="hz-pill-quake-list" style="margin-top:4px;border-top:1px solid rgba(255,255,255,.06);padding-top:3px;"></div>
                  </div>
                  <div id="hz-pill-tornado" class="hz-pill" style="display:none;background:rgba(0,0,0,.78);backdrop-filter:blur(10px);border-radius:8px;padding:6px 8px;font-size:.5rem;font-weight:700;color:#f87171;max-width:200px;">
                    <div id="hz-pill-tornado-head">TORNADOES: --</div>
                    <div id="hz-pill-tornado-list" style="margin-top:4px;border-top:1px solid rgba(255,255,255,.06);padding-top:3px;"></div>
                  </div>
                  <div id="hz-pill-flood" class="hz-pill" style="display:none;background:rgba(0,0,0,.78);backdrop-filter:blur(10px);border-radius:8px;padding:6px 8px;font-size:.5rem;font-weight:700;color:#22d3ee;max-width:200px;">
                    <div id="hz-pill-flood-head">FLOOD: --</div>
                  </div>
                </div>
                <div id="hazard-info-tooltip" style="display:none;position:absolute;z-index:700;right:12px;top:8px;width:380px;max-width:calc(100% - 24px);max-height:calc(100% - 60px);overflow-y:auto;background:rgba(8,8,22,.95);backdrop-filter:blur(24px) saturate(140%);-webkit-backdrop-filter:blur(24px) saturate(140%);border-radius:12px;padding:14px 16px;font-size:.54rem;font-weight:500;color:rgba(255,255,255,.82);line-height:1.65;letter-spacing:.01em;text-transform:none;box-shadow:0 16px 56px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,.06);scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.15) transparent;pointer-events:auto;font-family:system-ui,sans-serif;"></div>

                <!-- INSIGHT PANEL  right-side overlay -->
                <div id="hazard-insight-panel" style="position:absolute;top:0;right:0;bottom:0;width:340px;z-index:500;pointer-events:none;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s ease;">
                  <div id="hazard-insight-body" style="pointer-events:auto;flex:1;background:rgba(4,4,16,.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-left:1px solid rgba(255,255,255,.06);overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,.15) transparent;padding:10px 12px 10px 12px;">
                    <div id="hazard-insight-content" style="font-size:.44rem;color:rgba(255,255,255,.82);line-height:1.5;font-family:system-ui,sans-serif;letter-spacing:.01em;"></div>
                  </div>
                </div>
                <div id="hazard-insight-toggle" onclick="toggleHazardInsight()" style="pointer-events:auto;position:absolute;bottom:10px;right:10px;z-index:550;padding:4px 10px;border-radius:6px;background:rgba(249,115,22,.15);backdrop-filter:blur(8px);font-size:.40rem;font-weight:700;color:#f97316;cursor:pointer;letter-spacing:.08em;font-family:system-ui,sans-serif;text-transform:uppercase;border:1px solid rgba(249,115,22,.3);"> INSIGHT</div>

                <!-- FIRE overlays (smoke layers, AQI, fire status, labels toggle) -->
                <div id="hazard-fire-overlays">
                  <div style="position:absolute; top:10px; right:10px; z-index:1000; display:flex; gap:4px;">
                    <div id="fire-epa-toggle" onclick="toggleEpaLayer('fire')" style="padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.5rem; font-weight:700; color:rgba(255,255,255,.4); cursor:pointer; user-select:none; font-family:system-ui,sans-serif; text-transform:uppercase; letter-spacing:.5px;"> OFF</div>
                    <div id="fire-labels-toggle" onclick="toggleFireLabels()" style="padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.5rem; font-weight:700; color:rgba(255,255,255,.5); cursor:pointer; user-select:none; font-family:system-ui,sans-serif; text-transform:uppercase; letter-spacing:.5px;"> OFF</div>
                  </div>
                  <div id="fire-outlook-toggle" style="position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1000; display:flex; gap:2px; font-family:system-ui,sans-serif;">
                    <div onclick="switchHazardOutlook('fire','off')" id="fire-otlk-off" class="otlk-btn otlk-active" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(255,255,255,.7);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(255,255,255,.1);">OFF</div>
                    <div onclick="switchHazardOutlook('fire','d1')" id="fire-otlk-d1" class="otlk-btn" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(249,115,22,.6);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(249,115,22,.2);">D1 </div>
                    <div onclick="switchHazardOutlook('fire','d2')" id="fire-otlk-d2" class="otlk-btn" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(249,115,22,.4);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(249,115,22,.15);">D2</div>
                    <div onclick="switchHazardOutlook('fire','d3')" id="fire-otlk-d3" class="otlk-btn" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(249,115,22,.3);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(249,115,22,.1);">D3-8</div>
                  </div>
                  <div id="fire-aqi-pill" style="position:absolute; bottom:40px; left:10px; z-index:1000; padding:4px 10px; border-radius:8px; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); font-size:.65rem; font-weight:700; color:#fff; box-shadow:0 2px 8px rgba(0,0,0,.3); display:none; pointer-events:none; font-family:system-ui,sans-serif;"><span id="fire-aqi-value">--</span> AQI</div>
                  <div id="fire-status-pill" style="display:none;position:absolute; top:10px; left:10px; z-index:500; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); border-radius:10px; padding:5px 10px; font-size:.55rem; font-weight:700; color:#f97316; font-family:system-ui,sans-serif;">FIRES: Loading...</div>
                </div>

                <!-- TORNADO overlays (time range tabs, status, legend) -->
                <div id="hazard-tornado-overlays" style="display:none;">
                  <div id="severe-outlook-toggle" style="position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1000; display:flex; gap:2px; font-family:system-ui,sans-serif;">
                    <div onclick="switchHazardOutlook('tornado','off')" id="tornado-otlk-off" class="otlk-btn otlk-active" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(255,255,255,.7);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(255,255,255,.1);">OFF</div>
                    <div onclick="switchHazardOutlook('tornado','d1')" id="tornado-otlk-d1" class="otlk-btn" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(168,85,247,.6);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(168,85,247,.2);">D1 CAT</div>
                    <div onclick="switchHazardOutlook('tornado','d2')" id="tornado-otlk-d2" class="otlk-btn" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(168,85,247,.4);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(168,85,247,.15);">D2 CAT</div>
                    <div onclick="switchHazardOutlook('tornado','d3')" id="tornado-otlk-d3" class="otlk-btn" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(168,85,247,.3);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(168,85,247,.1);">D3 CAT</div>
                  </div>
                  <div style="position:absolute; top:10px; right:10px; z-index:500; display:flex; gap:3px;">
                    <button onclick="switchTornadoRange('today')" id="torn-tab-today" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.4);background:rgba(0,0,0,.5);backdrop-filter:blur(8px);color:rgba(255,255,255,.9);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Today</button>
                    <button onclick="switchTornadoRange('48h')" id="torn-tab-48h" style="padding:4px 8px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">48H</button>
                    <button onclick="switchTornadoRange('7d')" id="torn-tab-7d" style="padding:4px 8px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">7D</button>
                    <button onclick="switchTornadoRange('1m')" id="torn-tab-1m" style="padding:4px 8px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1M</button>
                    <button onclick="switchTornadoRange('6m')" id="torn-tab-6m" style="padding:4px 8px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">6M</button>
                    <button onclick="switchTornadoRange('1y')" id="torn-tab-1y" style="padding:4px 8px;border-radius:8px;border:none;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);color:rgba(43,34,244,.65);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1Y</button>
                    <button onclick="switchTornadoRange('forecast')" id="torn-tab-forecast" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,165,0,.4);background:rgba(255,100,0,.15);backdrop-filter:blur(8px);color:rgba(255,180,80,.9);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;"> Forecast</button>
                  </div>
                  <div id="tornado-status-pill" style="display:none;position:absolute; top:10px; left:10px; z-index:500; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); border-radius:10px; padding:5px 10px; font-size:.55rem; font-weight:700; color:#fff; font-family:system-ui,sans-serif;">TORNADOES: Loading...</div>
                  <span id="tornado-year-count" style="display:none;"></span>
                  <div style="position:absolute; bottom:10px; right:10px; z-index:400; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); border-radius:8px; padding:5px 7px; font-size:.45rem; color:#ccc; line-height:1.6;">
                    <span style="color:#90caf9;"></span>UNK
                    <span style="color:#66bb6a;"></span>EF0
                    <span style="color:#fdd835;"></span>EF1
                    <span style="color:#ffa726;"></span>EF2
                    <span style="color:#ef5350;"></span>EF3
                    <span style="color:#ab47bc;"></span>EF4
                    <span style="color:#ec407a;"></span>EF5<br>
                    <span style="color:#00e5ff;"></span> Hail &nbsp;
                    <span style="color:#76ff03;"></span> Wind &nbsp;
                    <span style="border:1px dashed #ffd600;padding:0 3px;font-size:.4rem;"></span> SPC
                  </div>
                </div>

                <!-- QUAKE overlays (geology toggle, status) -->
                <div id="hazard-quake-overlays" style="display:none;">
                  <div style="position:absolute; top:10px; right:10px; z-index:1000; display:flex; gap:4px;">
                    <div id="quake-epa-toggle" onclick="toggleEpaLayer('quake')" style="padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.5rem; font-weight:700; color:rgba(255,255,255,.4); cursor:pointer; user-select:none; font-family:system-ui,sans-serif; text-transform:uppercase; letter-spacing:.5px;"> OFF</div>
                    <div id="quake-geo-toggle" onclick="toggleQuakeGeology()" style="padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.5rem; font-weight:700; color:rgba(255,255,255,.4); cursor:pointer; user-select:none; font-family:system-ui,sans-serif; text-transform:uppercase; letter-spacing:.5px;"> OFF</div>
                  </div>
                  <div id="quake-status-pill" style="display:none;position:absolute; top:10px; left:10px; z-index:500; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); border-radius:10px; padding:5px 10px; font-size:.55rem; font-weight:700; color:#4ade80; font-family:system-ui,sans-serif;">EARTHQUAKES: Loading...</div>
                </div>

                <!-- ALERTS overlays (filter toggles) -->
                <div id="hazard-alerts-overlays" style="display:none;">
                  <div style="position:absolute; top:10px; right:10px; z-index:1000; display:flex; gap:3px; font-family:system-ui,sans-serif; flex-wrap:wrap; max-width:340px;">
                    <div id="alert-filter-warning" onclick="toggleAlertFilter('warning')" style="padding:3px 6px; border-radius:6px; border:1px solid rgba(239,68,68,.5); background:rgba(239,68,68,.2); backdrop-filter:blur(8px); font-size:.42rem; font-weight:700; color:#ef4444; cursor:pointer; user-select:none; letter-spacing:.3px;"> WARNINGS</div>
                    <div id="alert-filter-watch" onclick="toggleAlertFilter('watch')" style="padding:3px 6px; border-radius:6px; border:1px solid rgba(249,115,22,.5); background:rgba(249,115,22,.2); backdrop-filter:blur(8px); font-size:.42rem; font-weight:700; color:#f97316; cursor:pointer; user-select:none; letter-spacing:.3px;"> WATCHES</div>
                    <div id="alert-filter-advisory" onclick="toggleAlertFilter('advisory')" style="padding:3px 6px; border-radius:6px; border:1px solid rgba(234,179,8,.5); background:rgba(234,179,8,.15); backdrop-filter:blur(8px); font-size:.42rem; font-weight:700; color:#eab308; cursor:pointer; user-select:none; letter-spacing:.3px;"> ADVISORIES</div>
                  </div>
                  <div style="position:absolute; bottom:10px; right:10px; z-index:400; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); border-radius:8px; padding:5px 7px; font-size:.45rem; color:#ccc; line-height:1.6;">
                    <span style="background:#ef4444;width:8px;height:8px;display:inline-block;border-radius:2px;opacity:.7;"></span> Warning
                    <span style="background:#f97316;width:8px;height:8px;display:inline-block;border-radius:2px;opacity:.7;margin-left:4px;"></span> Watch
                    <span style="background:#eab308;width:8px;height:8px;display:inline-block;border-radius:2px;opacity:.7;margin-left:4px;"></span> Advisory
                  </div>
                </div>

                <!-- FLOOD overlays (gauge legend) -->
                <div id="hazard-flood-overlays" style="display:none;">
                  <!-- Excessive Rainfall Outlook toggle (top center) -->
                  <div style="position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1000; display:flex; gap:2px; font-family:system-ui,sans-serif;">
                    <div onclick="switchHazardOutlook('flood','off')" id="flood-otlk-off" class="otlk-btn otlk-active" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(255,255,255,.7);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(255,255,255,.1);">OFF</div>
                    <div onclick="switchHazardOutlook('flood','d1')" id="flood-otlk-d1" class="otlk-btn" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(6,182,212,.6);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(6,182,212,.2);">D1 ERO</div>
                    <div onclick="switchHazardOutlook('flood','d2')" id="flood-otlk-d2" class="otlk-btn" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(6,182,212,.4);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(6,182,212,.15);">D2 ERO</div>
                    <div onclick="switchHazardOutlook('flood','d3')" id="flood-otlk-d3" class="otlk-btn" style="padding:3px 6px;border-radius:5px;background:rgba(0,0,0,.45);backdrop-filter:blur(8px);font-size:.38rem;font-weight:700;color:rgba(6,182,212,.3);cursor:pointer;letter-spacing:.05em;border:1px solid rgba(6,182,212,.1);">D3 ERO</div>
                  </div>
                  <!-- Scope + Forecast time controls (top right) -->
                  <div style="position:absolute; top:10px; right:10px; z-index:1000; display:flex; flex-direction:column; gap:4px; font-family:system-ui,sans-serif;">
                    <div style="display:flex; gap:3px;">
                      <div id="flood-scope-nearby" onclick="switchFloodScope('nearby')" style="padding:3px 6px; border-radius:6px; border:1px solid rgba(59,130,246,.5); background:rgba(59,130,246,.2); backdrop-filter:blur(8px); font-size:.42rem; font-weight:700; color:#3b82f6; cursor:pointer; user-select:none; letter-spacing:.3px;"> NEARBY</div>
                      <div id="flood-scope-state" onclick="switchFloodScope('state')" style="padding:3px 6px; border-radius:6px; border:1px solid rgba(139,92,246,.3); background:rgba(139,92,246,.1); backdrop-filter:blur(8px); font-size:.42rem; font-weight:700; color:#8b5cf6; cursor:pointer; user-select:none; letter-spacing:.3px;"> FLOODING</div>
                      <div id="flood-epa-toggle" onclick="toggleEpaLayer('flood')" style="padding:3px 6px; border-radius:6px; border:1px solid rgba(168,85,247,.3); background:rgba(168,85,247,.1); backdrop-filter:blur(8px); font-size:.42rem; font-weight:700; color:rgba(168,85,247,.6); cursor:pointer; user-select:none; letter-spacing:.3px;"> EPA</div>
                    </div>
                    <div style="display:flex; gap:2px;">
                      <div class="flood-fcst-btn" data-fhr="obs" onclick="switchFloodForecast('obs')" style="padding:2px 5px; border-radius:4px; border:1px solid rgba(6,182,212,.5); background:rgba(6,182,212,.25); backdrop-filter:blur(8px); font-size:.36rem; font-weight:700; color:#22d3ee; cursor:pointer; letter-spacing:.3px;">OBS</div>
                      <div class="flood-fcst-btn" data-fhr="24" onclick="switchFloodForecast('24')" style="padding:2px 5px; border-radius:4px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.36rem; font-weight:700; color:rgba(255,255,255,.5); cursor:pointer; letter-spacing:.3px;">24H</div>
                      <div class="flood-fcst-btn" data-fhr="48" onclick="switchFloodForecast('48')" style="padding:2px 5px; border-radius:4px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.36rem; font-weight:700; color:rgba(255,255,255,.5); cursor:pointer; letter-spacing:.3px;">48H</div>
                      <div class="flood-fcst-btn" data-fhr="72" onclick="switchFloodForecast('72')" style="padding:2px 5px; border-radius:4px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.36rem; font-weight:700; color:rgba(255,255,255,.5); cursor:pointer; letter-spacing:.3px;">72H</div>
                      <div class="flood-fcst-btn" data-fhr="96" onclick="switchFloodForecast('96')" style="padding:2px 5px; border-radius:4px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.36rem; font-weight:700; color:rgba(255,255,255,.5); cursor:pointer; letter-spacing:.3px;">96H</div>
                      <div class="flood-fcst-btn" data-fhr="full" onclick="switchFloodForecast('full')" style="padding:2px 5px; border-radius:4px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.36rem; font-weight:700; color:rgba(255,255,255,.5); cursor:pointer; letter-spacing:.3px;">MAX</div>
                    </div>
                  </div>
                  <!-- Legend (bottom left) -->
                  <div style="position:absolute; bottom:10px; left:10px; z-index:400; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); border-radius:6px; padding:5px 8px; font-size:8px; font-weight:600; color:#ccc; box-shadow:0 2px 8px rgba(0,0,0,.3); font-family:system-ui,sans-serif; pointer-events:auto;">
                    <div style="display:flex; flex-direction:column; gap:2px;">
                      <div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">Normal</span><span style="background:#22c55e;width:6px;height:6px;display:inline-block;border-radius:50%;"></span></div>
                      <div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">Action</span><span style="background:#eab308;width:6px;height:6px;display:inline-block;border-radius:50%;"></span></div>
                      <div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">Minor</span><span style="background:#f97316;width:6px;height:6px;display:inline-block;border-radius:50%;"></span></div>
                      <div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">Moderate</span><span style="background:#ef4444;width:6px;height:6px;display:inline-block;border-radius:50%;"></span></div>
                      <div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">Major</span><span style="background:#9333ea;width:6px;height:6px;display:inline-block;border-radius:50%;"></span></div>
                    </div>
                  </div>
                </div>

                <!-- Unified status bar (always visible) -->
                <!-- Status pills removed  info integrated into tab badges and insight panel -->
              </div>
            </div>

          </div>

          <!-- ROW: LASCO C3 / LASCO C2 -->
          <div class="widgets-row" style="grid-template-columns:1fr 1fr;">

            <!-- LASCO C3 -->
            <div class="widget">
              <div class="widget-head" style="position:relative;">
                <div class="widget-title">LASCO C3 <span style="font-weight:500;opacity:0.7;">OUTER</span> <span class="live-tag" id="lasco-c3-live"> LIVE</span></div>
                <span style="display:flex;align-items:center;gap:4px;"><button class="space-info-btn" onclick="toggleSpacePopup('lasco-c3-popup',event)"></button><a href="https://www.swpc.noaa.gov/products/lasco-coronagraph" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NASA/ESA SOHO</a></span>
                <div class="space-info-popup" id="lasco-c3-popup"></div>
              </div>
              <div class="widget-body" style="background:#000;position:relative;overflow:hidden;">
                <img id="lasco-c3-img" alt="LASCO C3 Coronagraph" style="width:115%;height:115%;object-fit:cover;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);" />
                <div class="badge">SOHO LASCO</div>
              </div>
            </div>

            <!-- LASCO C2 -->
            <div class="widget">
              <div class="widget-head" style="position:relative;">
                <div class="widget-title">LASCO C2 <span style="font-weight:500;opacity:0.7;">INNER</span> <span class="live-tag" id="lasco-c2-live"> LIVE</span></div>
                <span style="display:flex;align-items:center;gap:4px;"><button class="space-info-btn" onclick="toggleSpacePopup('lasco-c2-popup',event)"></button><a href="https://www.swpc.noaa.gov/products/lasco-coronagraph" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NASA/ESA SOHO</a></span>
                <div class="space-info-popup" id="lasco-c2-popup"></div>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="lasco-c2-img" alt="LASCO C2 Coronagraph" style="width:100%;height:100%;object-fit:cover;" />
                <div class="badge">SOHO LASCO</div>
                
              </div>
            </div>

          </div>

          <!-- SPACE EVENTS -->
          <div class="widgets-row" style="grid-template-columns:1fr;">
            <div class="widget" style="height:auto;">
              <div class="widget-head">
                <div class="widget-title">SPACE EVENTS</div>
                <span class="widget-sub">NASA  JPL  SWPC</span>
              </div>
              <div class="widget-body" style="height:auto;min-height:0;padding:12px;aspect-ratio:unset;">
                <div class="bullets" id="space-events-bullets"></div>
                <div id="space-events" style="display:none;">--</div>

                <!-- Space Context Info Panel -->
                <div id="space-info-panel" style="margin-top:10px;border-radius:12px;background:rgba(200,200,210,.25);backdrop-filter:blur(12px);font-family:system-ui,sans-serif;overflow:hidden;">
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 14px;">
                    <div style="font-size:.65rem;font-weight:800;color:rgba(43,34,244,.85);letter-spacing:.05em;text-transform:uppercase;"> Guide to Space Monitoring</div>
                    <button id="space-info-toggle" onclick="toggleSpaceInfo()" style="background:rgba(200,200,210,.4);border:none;border-radius:6px;color:rgba(43,34,244,.6);font-size:.45rem;font-weight:700;cursor:pointer;padding:3px 8px;font-family:system-ui,sans-serif;letter-spacing:.03em;flex-shrink:0;">HIDE </button>
                  </div>
                  <div id="space-info-body" style="padding:6px 14px 14px;max-height:400px;overflow-y:auto;scrollbar-width:thin;line-height:1.5;">
                    <style>
                      #space-info-text b{color:rgba(43,34,244,.85);font-weight:700;text-transform:uppercase;}
                      #space-info-text .info-heading{font-size:.66rem;font-weight:800;color:rgba(43,34,244,.75);text-transform:uppercase;letter-spacing:.05em;margin-top:14px;margin-bottom:2px;padding-bottom:3px;border-bottom:2px solid rgba(43,34,244,.25);display:block;}
                      #space-info-text .info-heading:first-child{margin-top:0;}
                      #space-info-text .k{color:rgba(43,34,244,.85);font-weight:800;}
                      #space-info-text a{color:rgba(43,34,244,.75);text-decoration:underline;text-decoration-color:rgba(43,34,244,.3);text-underline-offset:2px;font-weight:600;}
                      #space-info-text a:hover{color:rgba(255,140,0,.9);text-decoration-color:rgba(255,140,0,.5);}
                      #space-info-text .widget-block{margin-bottom:10px;}
                    </style>
                    <div id="space-info-text" style="font-size:.6rem;color:rgba(43,34,244,.55);letter-spacing:.01em;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ROW: SOLAR MAGNETIC FIELD / SUVI -->
          <div class="widgets-row" style="grid-template-columns:1fr 1fr;">

            <!-- SDO PFSS MAGNETIC FIELD -->
            <div class="widget">
              <div class="widget-head" style="position:relative;">
                <div class="widget-title">SOLAR MAGNETIC FIELD <span class="live-tag" id="pfss-live"> LIVE</span></div>
                <span style="display:flex;align-items:center;gap:4px;"><button class="space-info-btn" onclick="toggleSpacePopup('pfss-popup',event)"></button><a href="https://sdo.gsfc.nasa.gov/data/" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NASA SDO PFSS</a></span>
                <div class="space-info-popup" id="pfss-popup"></div>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="pfss-img" alt="SDO AIA 171 with PFSS magnetic field lines" style="width:100%;height:100%;object-fit:contain;background:#000;" />
                <div class="badge">NASA SDO</div>
              </div>
            </div>

            <!-- SUVI THEMATIC MAP -->
            <div class="widget">
              <div class="widget-head" style="position:relative;">
                <div class="widget-title">SUVI THEMATIC MAP <span class="live-tag" id="suvi-map-live"> LIVE</span></div>
                <span style="display:flex;align-items:center;gap:4px;"><button class="space-info-btn" onclick="toggleSpacePopup('suvi-popup',event)"></button><a href="https://www.swpc.noaa.gov/products/goes-solar-ultraviolet-imager-suvi" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NOAA GOES</a></span>
                <div class="space-info-popup" id="suvi-popup"></div>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="suvi-map-img" alt="SUVI Thematic Map" style="width:100%;height:100%;object-fit:cover;" />
                <div class="badge">GOES SUVI</div>
                
              </div>
            </div>

          </div>

          <!-- ROW: AURORA / ENLIL -->
          <div class="widgets-row" style="grid-template-columns:1fr 1fr;">

            <!-- AURORA -->
            <div class="widget">
              <div class="widget-head" style="position:relative;">
                <div class="widget-title">AURORA FORECAST <span class="live-tag" id="aurora-live"> LIVE</span></div>
                <span style="display:flex;align-items:center;gap:4px;"><button class="space-info-btn" onclick="toggleSpacePopup('aurora-popup',event)"></button><a href="https://www.swpc.noaa.gov/products/aurora-30-minute-forecast" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC OVATION</a></span>
                <div class="space-info-popup" id="aurora-popup"></div>
              </div>
              <div class="widget-body" id="aurora-body">
                <div class="mini-solar" aria-label="solar weather summary">
                  <span class="mini-pill"><span class="mini-key">Kp</span><span class="mini-val" id="sw-kp">--</span></span>
                  <span class="mini-pill"><span class="mini-key">G</span><span class="mini-val" id="sw-g">--</span></span>
                  <span class="mini-pill"><span class="mini-key">Bz</span><span class="mini-val" id="sw-bz">--</span></span>
                  <span class="mini-pill"><span class="mini-key">Wind</span><span class="mini-val" id="sw-wind">--</span></span>
                  <span class="mini-pill"><span class="mini-key">Vis</span><span class="mini-val" id="sw-vis">--</span></span>
                </div>

                <canvas id="aurora-canvas"></canvas>
                <img id="aurora-img-fallback" alt="Aurora 30-minute outlook fallback" />
                <div class="badge">SWPC Ovation</div>
              </div>
            </div>

            <!-- ENLIL -->
            <div class="widget">
              <div class="widget-head" style="position:relative;">
                <div class="widget-title">SOLAR WIND <span class="live-tag" id="enlil-live"> LIVE</span></div>
                <span style="display:flex;align-items:center;gap:4px;"><button class="space-info-btn" onclick="toggleSpacePopup('enlil-popup',event)"></button><a href="https://www.swpc.noaa.gov/products/wsa-enlil-solar-wind-prediction" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC WSA-ENLIL</a></span>
                <div class="space-info-popup" id="enlil-popup"></div>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="enlil-img" alt="WSA-ENLIL solar wind prediction" style="width:100%;height:100%;object-fit:cover;" />
                <div class="badge">SWPC WSA-ENLIL</div>
                
              </div>
            </div>

          </div>

          <!-- ROW 4: GEOSPACE MAGNETOSPHERE (tabbed) -->
          <div class="widgets-row" style="grid-template-columns:1fr;">

            <div class="widget" id="geo-widget">
              <div class="widget-head" style="position:relative;flex-wrap:wrap;gap:6px;">
                <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">
                  <div class="widget-title">GEOSPACE MAGNETOSPHERE <span class="live-tag" id="geo-vel-live"> LIVE</span></div>
                  <span id="geo-den-live" style="display:none;"></span>
                  <span id="geo-pre-live" style="display:none;"></span>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                  <div class="geo-tabs" id="geo-tabs">
                    <button class="geo-tab active" data-geo="velocity" onclick="switchGeoTab('velocity')">VELOCITY</button>
                    <button class="geo-tab" data-geo="density" onclick="switchGeoTab('density')">DENSITY</button>
                    <button class="geo-tab" data-geo="pressure" onclick="switchGeoTab('pressure')">PRESSURE</button>
                  </div>
                  <span style="display:flex;align-items:center;gap:4px;"><button class="space-info-btn" onclick="toggleSpacePopup('geo-popup',event)"></button><a href="https://www.swpc.noaa.gov/products/geospace-magnetosphere-movies" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC</a></span>
                </div>
                <div class="space-info-popup" id="geo-popup"></div>
              </div>
              <div class="widget-body" style="background:#000;aspect-ratio:16/9;position:relative;">
                <img id="geo-vel-img" alt="Geospace Magnetosphere - Velocity" style="width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;transition:opacity .3s ease;" />
                <img id="geo-den-img" alt="Geospace Magnetosphere - Density" style="width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;opacity:0;transition:opacity .3s ease;" />
                <img id="geo-pre-img" alt="Geospace Magnetosphere - Pressure" style="width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;opacity:0;transition:opacity .3s ease;" />
                <!-- Live insight overlay -->
                <div id="geo-insight" style="position:absolute;bottom:0;left:0;right:0;z-index:5;background:linear-gradient(transparent,rgba(0,0,0,.7) 20%,rgba(0,0,0,.88));padding:14px 16px 12px;font-family:inherit;pointer-events:none;"></div>
              </div>
            </div>

          </div>

          </div>

        <!-- AUDIO -->
        <div class="audio-section">
          <div class="audio-header-title">Ambient</div>
          <div class="audio-sub">Single channel  add your stream URL to play.</div>

          <button id="play-all" class="play-all"> Play</button>

          <div id="spectrum" class="spectrum">
            <div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div>
          </div>

          <div class="channels">
            <div class="channel">
              <div class="channel-name">Stream</div>
              <div id="a-status">No source set</div>
              <div class="slider-row">
                <input id="vol-a" type="range" min="0" max="1" step="0.01" value="0.8" />
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <audio id="audio-a" loop crossorigin="anonymous"></audio>
</div>

<div id="radar-info-tooltip"></div>
<!-- hazard tooltip moved inside hazard widget -->

<script>
(function () {
  "use strict";

  /* =========================================================
     CONFIG
     ========================================================= */
  var LOCATIONS = [
    { id: "nyc", name: "NYC", lat: 40.7411, lon: -73.9897, tz: "America/New_York", radar: "KOKX", radarName: "NWS Upton", radarRegion: "NORTHEAST", goes: { sat: "G19", sector: "ne" } },
    { id: "la", name: "LA", lat: 34.0195, lon: -118.4912, tz: "America/Los_Angeles", radar: "KVTX", radarName: "NWS Los Angeles", radarRegion: "PACSOUTHWEST", goes: { sat: "G18", sector: "wus" } },
    { id: "chicago", name: "Chicago", lat: 42.3175, lon: -89.0937, tz: "America/Chicago", radar: "KLOT", radarName: "NWS Chicago", radarRegion: "UPPERMISSVLY", goes: { sat: "G19", sector: "umv" } },
    { id: "sf", name: "SF", lat: 37.7559, lon: -122.5108, tz: "America/Los_Angeles", radar: "KMUX", radarName: "NWS San Francisco", radarRegion: "PACNORTHWEST", goes: { sat: "G18", sector: "wus" } },
    { id: "charleston", name: "Charleston", lat: 32.8141, lon: -79.9295, tz: "America/New_York", radar: "KCLX", radarName: "NWS Charleston", radarRegion: "SOUTHEAST", goes: { sat: "G19", sector: "se" } },
    { id: "pv", name: "Pleasant Valley", lat: 41.7340, lon: -73.8212, tz: "America/New_York", radar: "KENX", radarName: "NWS Albany", radarRegion: "NORTHEAST", goes: { sat: "G19", sector: "ne" } },
    { id: "stephenson", name: "Stephenson", lat: 39.2148, lon: -78.0594, tz: "America/New_York", radar: "KLWX", radarName: "NWS Sterling", radarRegion: "NORTHEAST", goes: { sat: "G19", sector: "ne" } }
  ];
  
  var LOCATION = LOCATIONS[0];
  var TZ = LOCATION.tz;

  // Derive US state code from coordinates for NWS alerts area query
  (function(){
    try {
      fetch('https://api.weather.gov/points/' + LOCATIONS[0].lat.toFixed(4) + ',' + LOCATIONS[0].lon.toFixed(4))
        .then(function(r){ return r.json(); })
        .then(function(d){
          if(d && d.properties && d.properties.relativeLocation && d.properties.relativeLocation.properties){
            window._userState = d.properties.relativeLocation.properties.state || 'NY';
          }
        }).catch(function(){});
    } catch(e){}
  })();

  /* =========================================================
     UTILITIES
     ========================================================= */
  function fetchWithTimeout(url, opts, ms){
    ms = ms || 12000;
    opts = opts || {};
    var ctrl = null;
    try{ ctrl = new AbortController(); opts.signal = ctrl.signal; } catch(e){}
    var t = null;
    if (ctrl){
      t = setTimeout(function(){ try{ ctrl.abort(); }catch(e){} }, ms);
    }
    return fetch(url, opts).then(function(r){
      if (t) clearTimeout(t);
      return r;
    }, function(err){
      if (t) clearTimeout(t);
      throw err;
    });
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function setText(el, txt){ if (el) el.textContent = (txt == null ? "" : String(txt)); }

  //  RESILIENT EXTERNAL LINKS 
  // Links with data-fallback attribute try the specific deep URL first.
  // If user right-clicks or middle-clicks they get the primary URL normally.
  // The data-fallback URL (stable parent page) is shown in a title tooltip
  // so the user always knows the backup path if a page has moved.
  // No JS interception needed  both URLs are accessible to the user.

  /* =========================================================
     TIME HELPERS (12-hour, no AM/PM)
     ========================================================= */
  function fmt12NoSuffixFromDate(d){
    if (!d || !isFinite(d.getTime())) return "--:--";
    var h = d.getHours();
    var m = d.getMinutes();
    var hh = h % 12; if (hh === 0) hh = 12;
    return String(hh) + ":" + (m < 10 ? "0"+m : m);
  }
  function fmt12NoSuffix(iso){ return fmt12NoSuffixFromDate(new Date(iso)); }
  
  function fmtMonthDay(d){
    if (!d || !isFinite(d.getTime())) return "--";
    var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return months[d.getMonth()] + " " + d.getDate();
  }

  /* =========================================================
     AUDIO
     ========================================================= */
  var CHANNEL_A_URL = ""; // Put your stream URL here (optional)
  var audioA   = document.getElementById("audio-a");
  var volA     = document.getElementById("vol-a");
  var aStatus  = document.getElementById("a-status");
  var playBtn  = document.getElementById("play-all");
  var spectrum = document.getElementById("spectrum");

  (function initAudio(){
    if (!audioA || !volA || !aStatus || !playBtn || !spectrum) return;

    if (CHANNEL_A_URL){
      audioA.src = CHANNEL_A_URL;
      aStatus.textContent = "Ready";
    } else {
      aStatus.textContent = "No source set";
    }

    audioA.volume = parseFloat(volA.value || "0.8");
    volA.addEventListener("input", function(){
      audioA.volume = parseFloat(volA.value || "0.8");
    });

    var playing = false;
    playBtn.onclick = function(){
      if (!playing){
        if (audioA.src){
          audioA.play().catch(function(){});
        }
        playBtn.textContent = " Pause";
        spectrum.classList.add("playing");
        playing = true;
      } else {
        audioA.pause();
        playBtn.textContent = " Play";
        spectrum.classList.remove("playing");
        playing = false;
      }
    };
  })();

  /* =========================================================
     DOM REFS
     ========================================================= */
  var tempEl        = document.getElementById("temp");
  var feelsInlineEl = document.getElementById("feels-inline");
  var condTextEl    = document.getElementById("cond-text");
  var condIconEl    = document.getElementById("cond-icon");
  var locNameEl     = document.getElementById("loc-name");
  var locMetaEl     = document.getElementById("loc-meta");

  var windEl      = document.getElementById("wind");
  var gustsEl     = document.getElementById("gusts");
  var humidityEl  = document.getElementById("humidity");
  var pressureEl  = document.getElementById("pressure");
  var uvEl        = document.getElementById("uv");

  var hiLoEl        = document.getElementById("today-hi-lo");
  var precipAmtEl   = document.getElementById("precip-amt");
  var forecastRowEl = document.getElementById("forecast-row");

  var forecast7El    = document.getElementById("forecast7");

  var moonMiniIconEl = document.getElementById("moon-mini-icon");
  var moonMiniTextEl = document.getElementById("moon-mini-text");

  var nightSkyTitleEl = document.getElementById("night-sky-title");

  var spaceEventsEl        = document.getElementById("space-events");
  var spaceEventsBulletsEl = document.getElementById("space-events-bullets");

  var nightSkySvg    = document.getElementById("night-sky-svg");
  var nightSkyLegend = document.getElementById("night-sky-legend");

  var radarImg    = document.getElementById("radar-img");
  var radarLiveEl = document.getElementById("radar-live");

  var auroraCanvas      = document.getElementById("aurora-canvas");
  var auroraLiveEl      = document.getElementById("aurora-live");
  var auroraFallbackImg = document.getElementById("aurora-img-fallback");
  var auroraBtn         = document.getElementById("aurora-btn");

  var goesCanvas   = document.getElementById("goes-canvas");
  var goesLiveEl   = document.getElementById("goes-live");
  var goesFrameEl  = document.getElementById("goes-frame");

  var enlilImg    = document.getElementById("enlil-img");
  var enlilLiveEl = document.getElementById("enlil-live");

  // sunliveImg removed - replaced by SUVI Thematic Map

  // SWPC Geospace images (animated)
  var swpcGeoVelImg = document.getElementById("swpc-geo-vel-img");
  var swpcGeoDenImg = document.getElementById("swpc-geo-den-img");
  var swpcGeoPreImg = document.getElementById("swpc-geo-pre-img");

  var geoVelLiveEl = document.getElementById("geo-vel-live");
  var geoDenLiveEl = document.getElementById("geo-den-live");
  var geoPreLiveEl = document.getElementById("geo-pre-live");

  // Solar mini pills
  var swKp   = document.getElementById("sw-kp");
  var swG    = document.getElementById("sw-g");
  var swBz   = document.getElementById("sw-bz");
  var swWind = document.getElementById("sw-wind");
  var swVis  = document.getElementById("sw-vis");

  /* =========================================================
     ICONS (Open-Meteo weathercode) - COMPLETE MAPPING
     ========================================================= */
  var METEO_BASE = "https://basmilius.github.io/weather-icons/production/fill/all/";

  var ICONS_URL = {
    clearDay: METEO_BASE + "clear-day.svg",
    clearNight: METEO_BASE + "clear-night.svg",
    partlyDay: METEO_BASE + "partly-cloudy-day.svg",
    partlyNight: METEO_BASE + "partly-cloudy-night.svg",
    overcast: METEO_BASE + "overcast.svg",
    fogDay: METEO_BASE + "fog-day.svg",
    fogNight: METEO_BASE + "fog-night.svg",
    fog: METEO_BASE + "fog.svg",
    drizzle: METEO_BASE + "drizzle.svg",
    rain: METEO_BASE + "rain.svg",
    partlyRainDay: METEO_BASE + "partly-cloudy-day-rain.svg",
    partlyRainNight: METEO_BASE + "partly-cloudy-night-rain.svg",
    sleet: METEO_BASE + "sleet.svg",
    snow: METEO_BASE + "snow.svg",
    partlySnowDay: METEO_BASE + "partly-cloudy-day-snow.svg",
    partlySnowNight: METEO_BASE + "partly-cloudy-night-snow.svg",
    thunderstormsDay: METEO_BASE + "thunderstorms-day.svg",
    thunderstormsNight: METEO_BASE + "thunderstorms-night.svg",
    thunderstormsRain: METEO_BASE + "thunderstorms-rain.svg",
    unknown: METEO_BASE + "not-available.svg"
  };

  function isNightTime(){
    var hour = new Date().getHours();
    return hour < 6 || hour >= 20;
  }

  /* =========================================================
     WEATHER CODE TO ANIMATION CLASS MAPPING (v5 complete)
     ========================================================= */
  function getWeatherAnimClass(code, isNight){
    // Returns: { emoji, animClass, label }
    if (code === 0) return { emoji: isNight ? "" : "", animClass: isNight ? "night" : "sun", label: "Clear" };
    if (code === 1) return { emoji: isNight ? "" : "", animClass: "partly", label: "Mainly Clear" };
    if (code === 2) return { emoji: "", animClass: "partly", label: "Partly Cloudy" };
    if (code === 3) return { emoji: "", animClass: "cloud", label: "Overcast" };
    if (code === 45) return { emoji: "", animClass: "fog", label: "Fog" };
    if (code === 48) return { emoji: "", animClass: "fog", label: "Rime Fog" };
    if (code === 51) return { emoji: "", animClass: "drizzle", label: "Light Drizzle" };
    if (code === 53) return { emoji: "", animClass: "drizzle", label: "Drizzle" };
    if (code === 55) return { emoji: "", animClass: "drizzle", label: "Dense Drizzle" };
    if (code === 56) return { emoji: "", animClass: "freezing-drizzle", label: "Freezing Drizzle" };
    if (code === 57) return { emoji: "", animClass: "freezing-drizzle", label: "Dense Freezing Drizzle" };
    if (code === 61) return { emoji: "", animClass: "rain", label: "Light Rain" };
    if (code === 63) return { emoji: "", animClass: "rain", label: "Rain" };
    if (code === 65) return { emoji: "", animClass: "rain", label: "Heavy Rain" };
    if (code === 66) return { emoji: "", animClass: "freezing-rain", label: "Light Freezing Rain" };
    if (code === 67) return { emoji: "", animClass: "freezing-rain", label: "Heavy Freezing Rain" };
    if (code === 71) return { emoji: "", animClass: "snow", label: "Light Snow" };
    if (code === 73) return { emoji: "", animClass: "snow", label: "Snow" };
    if (code === 75) return { emoji: "", animClass: "snow", label: "Heavy Snow" };
    if (code === 77) return { emoji: "", animClass: "sleet", label: "Sleet" };
    if (code === 80) return { emoji: "", animClass: "rain", label: "Rain Showers" };
    if (code === 81) return { emoji: "", animClass: "rain", label: "Moderate Showers" };
    if (code === 82) return { emoji: "", animClass: "rain", label: "Violent Showers" };
    if (code === 85) return { emoji: "", animClass: "snow", label: "Snow Showers" };
    if (code === 86) return { emoji: "", animClass: "snow", label: "Heavy Snow Showers" };
    if (code === 95) return { emoji: "", animClass: "storm", label: "Thunderstorm" };
    if (code === 96) return { emoji: "", animClass: "storm-hail", label: "T-Storm + Hail" };
    if (code === 99) return { emoji: "", animClass: "storm-hail", label: "T-Storm + Heavy Hail" };
    return { emoji: "", animClass: "", label: "Weather" };
  }

  function iconForCode(code){
  var night = isNightTime();
  if (code === 0) return {t:"Clear", i: night ? ICONS_URL.clearNight : ICONS_URL.clearDay};
  if (code === 1) return {t:"Mainly Clear", i: night ? ICONS_URL.partlyNight : ICONS_URL.partlyDay};
  if (code === 2) return {t:"Partly Cloudy", i: night ? ICONS_URL.partlyNight : ICONS_URL.partlyDay};
  if (code === 3) return {t:"Overcast", i: ICONS_URL.overcast};
  if (code === 45) return {t:"Fog", i: night ? ICONS_URL.fogNight : ICONS_URL.fogDay};
  if (code === 48) return {t:"Rime Fog", i: ICONS_URL.fog};
  if (code === 51) return {t:"Light Drizzle", i: ICONS_URL.drizzle};
  if (code === 53) return {t:"Drizzle", i: ICONS_URL.drizzle};
  if (code === 55) return {t:"Dense Drizzle", i: ICONS_URL.drizzle};
  if (code === 56) return {t:"Light Freezing Drizzle", i: ICONS_URL.sleet};
  if (code === 57) return {t:"Freezing Drizzle", i: ICONS_URL.sleet};
  if (code === 61) return {t:"Light Rain", i: ICONS_URL.rain};
  if (code === 63) return {t:"Rain", i: ICONS_URL.rain};
  if (code === 65) return {t:"Heavy Rain", i: ICONS_URL.rain};
  if (code === 66) return {t:"Light Freezing Rain", i: ICONS_URL.sleet};
  if (code === 67) return {t:"Freezing Rain", i: ICONS_URL.sleet};
  if (code === 71) return {t:"Light Snow", i: ICONS_URL.snow};
  if (code === 73) return {t:"Snow", i: ICONS_URL.snow};
  if (code === 75) return {t:"Heavy Snow", i: ICONS_URL.snow};
  if (code === 77) return {t:"Snow Grains", i: ICONS_URL.sleet};
  if (code === 80) return {t:"Light Showers", i: night ? ICONS_URL.partlyRainNight : ICONS_URL.partlyRainDay};
  if (code === 81) return {t:"Showers", i: night ? ICONS_URL.partlyRainNight : ICONS_URL.partlyRainDay};
  if (code === 82) return {t:"Heavy Showers", i: ICONS_URL.rain};
  if (code === 85) return {t:"Light Snow Showers", i: night ? ICONS_URL.partlySnowNight : ICONS_URL.partlySnowDay};
  if (code === 86) return {t:"Snow Showers", i: ICONS_URL.snow};
  if (code === 95) return {t:"Thunderstorm", i: night ? ICONS_URL.thunderstormsNight : ICONS_URL.thunderstormsDay};
  if (code === 96) return {t:"T-Storm + Hail", i: ICONS_URL.thunderstormsRain};
  if (code === 99) return {t:"T-Storm + Heavy Hail", i: ICONS_URL.thunderstormsRain};
  return {t:"Weather", i: ICONS_URL.unknown};
}

  /* =========================================================
     MOON (approx)
     ========================================================= */
  function moonInfo(phase){
    var icon, name;
    if (phase < 0.03 || phase > 0.97){ icon=""; name="New Moon"; }
    else if (phase < 0.22)          { icon=""; name="Waxing Crescent"; }
    else if (phase < 0.28)          { icon=""; name="First Quarter"; }
    else if (phase < 0.45)          { icon=""; name="Waxing Gibbous"; }
    else if (phase < 0.55)          { icon=""; name="Full Moon"; }
    else if (phase < 0.72)          { icon=""; name="Waning Gibbous"; }
    else if (phase < 0.78)          { icon=""; name="Last Quarter"; }
    else                            { icon=""; name="Waning Crescent"; }

    var illum = Math.round((1 - Math.cos(2 * Math.PI * phase)) / 2 * 100);
if (illum >= 98) illum = 100;
if (illum <= 2) illum = 0;
    return { icon:icon, name:name, illum:illum };
  }

  function approximateMoonPhase(date){
  var lp = 2551442.8; // lunar period in seconds (29.53059 days)
  var newMoon = new Date(Date.UTC(2026,0,18,19,52,0)); // Jan 18, 2026 new moon
  var phaseSec = ((date.getTime() - newMoon.getTime())/1000) % lp;
  if (phaseSec < 0) phaseSec += lp;
  return phaseSec / lp;
}

  function findNextMoonEvent(now, targetPhase, daysAhead){
    var best = null;
    var bestErr = Infinity;
    var start = now.getTime();
    var end = start + (daysAhead*86400000);
    var prevErr = null;
    for (var t=start; t<=end; t+=3600000){
      var d = new Date(t);
      var ph = approximateMoonPhase(d);
      var err = Math.abs(ph - targetPhase);
      err = Math.min(err, 1-err);
      if (err < bestErr){
        bestErr = err;
        best = d;
      }
      // If error was decreasing and now increasing, we passed a local minimum  stop
      if (prevErr !== null && bestErr < 0.02 && err > prevErr){
        break;
      }
      prevErr = err;
    }
    return best;
  }

  /* =========================================================
     NIGHT CLOUD SUMMARY (used for #night-sky-title)
     ========================================================= */
  function classifyCloud(avg){
    if (avg >= 85) return "Cloudy";
    if (avg >= 60) return "Mostly Cloudy";
    if (avg >= 35) return "Partly Cloudy";
    return "Clear";
  }

  function nightCloudLine(hourly, sunsetLocal, sunriseLocal){
    if (!hourly || !hourly.time || !hourly.cloudcover) return "--";
    var sum = 0, n = 0;

    for (var i=0; i<hourly.time.length; i++){
      var dt = new Date(hourly.time[i]);
      if (!isFinite(dt.getTime())) continue;
      if (dt >= sunsetLocal && dt <= sunriseLocal){
        var cc = hourly.cloudcover[i];
        if (typeof cc === "number" && isFinite(cc)){
          sum += cc; n++;
        }
      }
    }
    if (!n) return "--";
    var avg = Math.round(sum / n);
    var label = classifyCloud(avg);
    return label + "  Cloud Coverage : " + avg + "%";
  }

  /* =========================================================
     SPACE EVENTS (simple built-ins)
     ========================================================= */
  var METEOR_SHOWERS = [
    { name:"Quadrantids", peakStart:{m:1,d:3}, peakEnd:{m:1,d:4}, zhr:120, speed:91700, radiant:"Botes", direction:"NE", radiantRise:"1am", bestView:"Pre-dawn 4-6am", ra:230, dec:49 },
    { name:"Lyrids", peakStart:{m:4,d:22}, peakEnd:{m:4,d:22}, zhr:18, speed:109600, radiant:"Lyra", direction:"E", radiantRise:"9pm", bestView:"After midnight", ra:271, dec:34 },
    { name:"Eta Aquariids", peakStart:{m:5,d:5}, peakEnd:{m:5,d:6}, zhr:50, speed:147600, radiant:"Aquarius", direction:"SE", radiantRise:"2am", bestView:"Pre-dawn 3-5am", ra:338, dec:-1 },
    { name:"Delta Aquariids", peakStart:{m:7,d:29}, peakEnd:{m:7,d:30}, zhr:25, speed:91700, radiant:"Aquarius", direction:"S", radiantRise:"10pm", bestView:"After midnight 1-3am", ra:340, dec:-16 },
    { name:"Perseids", peakStart:{m:8,d:12}, peakEnd:{m:8,d:13}, zhr:100, speed:132000, radiant:"Perseus", direction:"NE", radiantRise:"10pm", bestView:"After midnight 2-4am", ra:48, dec:58 },
    { name:"Draconids", peakStart:{m:10,d:8}, peakEnd:{m:10,d:9}, zhr:10, speed:44700, radiant:"Draco", direction:"NW", radiantRise:"Circumpolar", bestView:"Evening 9pm-midnight", ra:262, dec:54 },
    { name:"Orionids", peakStart:{m:10,d:21}, peakEnd:{m:10,d:21}, zhr:20, speed:147600, radiant:"Orion", direction:"SE", radiantRise:"11pm", bestView:"After midnight 2-4am", ra:95, dec:16 },
    { name:"Leonids", peakStart:{m:11,d:17}, peakEnd:{m:11,d:18}, zhr:15, speed:158800, radiant:"Leo", direction:"E", radiantRise:"midnight", bestView:"Pre-dawn 4-6am", ra:152, dec:22 },
    { name:"Geminids", peakStart:{m:12,d:13}, peakEnd:{m:12,d:14}, zhr:150, speed:78300, radiant:"Gemini", direction:"E", radiantRise:"7pm", bestView:"All night, peak 2am", ra:112, dec:33 },
    { name:"Ursids", peakStart:{m:12,d:22}, peakEnd:{m:12,d:23}, zhr:10, speed:73800, radiant:"Ursa Minor", direction:"N", radiantRise:"Circumpolar", bestView:"After midnight", ra:217, dec:76 }
  ];

  function dateInYear(y, m, d){ return new Date(y, m-1, d, 12, 0, 0, 0); }
  function inDays(from, to){ return Math.round((to - from)/86400000); }

  function nextMeteorPeak(now){
    var y = now.getFullYear();
    var best = null;
    for (var i=0;i<METEOR_SHOWERS.length;i++){
      var s = METEOR_SHOWERS[i];
      var ps = dateInYear(y, s.peakStart.m, s.peakStart.d);
      var pe = dateInYear(y, s.peakEnd.m, s.peakEnd.d);
      if (pe < now){
        ps = dateInYear(y+1, s.peakStart.m, s.peakStart.d);
        pe = dateInYear(y+1, s.peakEnd.m, s.peakEnd.d);
      }
      var days = inDays(now, ps);
      if (!best || days < best.days){
        best = { name:s.name, start:ps, end:pe, days:days };
      }
    }
    return best;
  }

  // Lightweight static list (your original behavior)
  var ECLIPSES = [
    { date:"2026-02-17", type:"Solar (Annular)", note:"Path crosses Antarctica. Not visible from North America.", visible:false },
    { date:"2026-03-03", type:"Lunar (Total)", note:"Visible from Americas, Europe, Africa. Totality 00:58 UTC, duration 58 min.", visible:true },
    { date:"2026-08-12", type:"Solar (Total)", note:"Path crosses Arctic, Greenland, Iceland, Spain. Partial visible from NE USA at sunrise.", visible:"partial" },
    { date:"2026-08-28", type:"Lunar (Partial)", note:"Visible from Pacific, Americas, Europe, Africa. Max eclipse 04:13 UTC, 93% coverage.", visible:true }
  ];

  function nextEclipse(now){
    for (var i=0;i<ECLIPSES.length;i++){
      var d = new Date(ECLIPSES[i].date + "T00:00:00");
      if (isFinite(d.getTime()) && d >= now){
        return { d:d, type:ECLIPSES[i].type, note:ECLIPSES[i].note };
      }
    }
    return null;
  }

  // Planetary conjunctions 2026 (within 1 or notable)
  var CONJUNCTIONS = [
    { date:"2026-01-25", bodies:"Saturn + Mercury", separation:"0.5", direction:"SW", time:"Dusk", note:"Very low on horizon, challenging" },
    { date:"2026-02-13", bodies:"Venus + Saturn", separation:"0.8", direction:"SW", time:"Dusk", note:"Bright pair after sunset" },
    { date:"2026-02-28", bodies:"Venus + Mercury", separation:"1.2", direction:"W", time:"Dusk", note:"Mercury at max elongation" },
    { date:"2026-03-16", bodies:"Mars + Moon", separation:"0.5", direction:"E", time:"Evening", note:"Close pass, Mars bright at magnitude +0.8" },
    { date:"2026-06-04", bodies:"Jupiter + Mercury", separation:"0.9", direction:"E", time:"Dawn", note:"Low in morning twilight" },
    { date:"2026-07-12", bodies:"Venus + Mars", separation:"1.0", direction:"W", time:"Dusk", note:"Striking color contrast" },
    { date:"2026-08-20", bodies:"Moon + Saturn", separation:"0.3", direction:"SE", time:"Night", note:"Very close, possible occultation" },
    { date:"2026-10-26", bodies:"Venus + Saturn", separation:"0.6", direction:"SW", time:"Dusk", note:"Brilliant pair" },
    { date:"2026-11-17", bodies:"Jupiter + Moon", separation:"0.8", direction:"E", time:"Night", note:"Bright pair all night" },
    { date:"2026-12-08", bodies:"Mars + Jupiter", separation:"0.9", direction:"E", time:"Night", note:"Two bright planets, easy target" }
  ];

  function nextConjunction(now){
    for (var i=0;i<CONJUNCTIONS.length;i++){
      var d = new Date(CONJUNCTIONS[i].date + "T00:00:00");
      if (isFinite(d.getTime()) && d >= now){
        var c = CONJUNCTIONS[i];
        return { d:d, bodies:c.bodies, separation:c.separation, direction:c.direction, time:c.time, note:c.note };
      }
    }
    return null;
  }

  // Planetary oppositions 2026 (outer planets closest/brightest)
  var OPPOSITIONS = [
    { date:"2026-02-19", planet:"Mars", magnitude:"-1.2", constellation:"Leo", note:"Closest approach, 63 million mi (0.68 AU), visible all night" },
    { date:"2026-09-21", planet:"Saturn", magnitude:"+0.4", constellation:"Pisces", note:"Rings visible in small telescope, 8.9 AU (827 million mi)" },
    { date:"2026-10-03", planet:"Neptune", magnitude:"+7.8", constellation:"Pisces", note:"Requires binoculars or telescope, 28.9 AU" },
    { date:"2026-11-09", planet:"Uranus", magnitude:"+5.6", constellation:"Taurus", note:"Barely naked-eye from dark sites, 17.2 AU" },
    { date:"2026-12-12", planet:"Jupiter", magnitude:"-2.8", constellation:"Taurus", note:"Brightest object after Moon, 4.0 AU (372 million mi)" }
  ];

  function nextOpposition(now){
    for (var i=0;i<OPPOSITIONS.length;i++){
      var d = new Date(OPPOSITIONS[i].date + "T00:00:00");
      if (isFinite(d.getTime()) && d >= now){
        var o = OPPOSITIONS[i];
        return { d:d, planet:o.planet, magnitude:o.magnitude, constellation:o.constellation, note:o.note };
      }
    }
    return null;
  }

  function bulletHtml(title, time, sub){
    return (
      '<div class="bullet">' +
        '<div class="btop"><span class="bname">'+title+'</span><span class="btime">'+time+'</span></div>' +
        (sub ? ('<div class="bsub">'+sub+'</div>') : '') +
      '</div>'
    );
  }

function daysUntil(from, to){
  if (!from || !to || !isFinite(from.getTime()) || !isFinite(to.getTime())) return 0;
  return Math.max(0, Math.round((to.getTime() - from.getTime()) / 86400000));
}

function dayRangeAround(d, days){
  if (!d || !isFinite(d.getTime())) return days + " days";
  var now = new Date();
  var diff = Math.round((d.getTime() - now.getTime()) / 86400000);
  var start = diff - days;
  var end = diff + days;
  if (start < 0) start = 0;
  return start + "-" + end + " days";
}

  /* =========================================================
     SVG HELPERS (Night sky bar)
     ========================================================= */
  /* Planet colors for TODAY Timeline */
  var TODAY_TL_PLANET_COLORS = {
    Moon:    "rgba(255,255,255,0.90)",
    Mercury: "#9A9A9A",
    Venus:   "#FFE5B4",
    Mars:    "#C44D2A",
    Jupiter: "#E8A954",
    Saturn:  "#F0C75E",
    Uranus:  "#8ECAE6",
    Neptune: "#4AA3DF"
  };

  var SKY_COLORS = {
    Moon:    "rgba(255,255,255,0.95)",
    Mercury: "#9A9A9A",
    Venus:   "#FFE5B4",
    Mars:    "#C44D2A",
    Jupiter: "#E8A954",
    Saturn:  "#F0C75E",
    Uranus:  "#8ECAE6",
    Neptune: "#4AA3DF"
  };

  function svgEl(tag){
    return document.createElementNS("http://www.w3.org/2000/svg", tag);
  }
  function clearSvg(svg){
    while (svg && svg.firstChild) svg.removeChild(svg.firstChild);
  }

  // Kp index color scale (matches SWPC official colors exactly)
  function getKpColor(kp){
    // Round to nearest level for color selection
    var level = Math.round(kp);
    
    switch(level){
      case 0:  return "rgba(0,153,51,0.90)";
      case 1:  return "rgba(51,204,51,0.90)";
      case 2:  return "rgba(102,204,51,0.90)";
      case 3:  return "rgba(153,204,51,0.90)";
      case 4:  return "rgba(204,204,51,0.90)";
      case 5:  return "rgba(255,255,0,0.90)";
      case 6:  return "rgba(255,204,0,0.90)";
      case 7:  return "rgba(255,153,0,0.90)";
      case 8:  return "rgba(255,51,51,0.90)";
      case 9:  return "rgba(204,0,51,0.90)";
      default: return "rgba(102,204,51,0.90)";
    }
  }

  function drawNightSkyBar(svg, legendEl, sunsetLocal, sunriseLocal, windowsByBody, cloudSeries, kpSeries){
    if (!svg) return;

    clearSvg(svg);

    var W = 1000, H = 170;
    var padL = 22, padR = 22, padT = 28, padB = 38;
    var x0 = padL, x1 = W - padR;
    var y0 = padT, y1 = H - padB;

    var total = Math.max(1, sunriseLocal.getTime() - sunsetLocal.getTime());
    function xForTime(dt){
      var t = clamp(dt.getTime() - sunsetLocal.getTime(), 0, total);
      return x0 + (t / total) * (x1 - x0);
    }

    // Aurora/Kp bar (top bar)
    var kpBarH = 12;
    var kpBarY = 4;
    var kpBarX = x0;
    var kpBarW = (x1 - x0);

    function makeKpBarFrame(){
      var r = svgEl("rect");
      r.setAttribute("x", String(kpBarX));
      r.setAttribute("y", String(kpBarY));
      r.setAttribute("width", String(kpBarW));
      r.setAttribute("height", String(kpBarH));
      r.setAttribute("fill", "rgba(43,34,244,0.06)");
      r.setAttribute("fill-opacity", "1");
      r.setAttribute("stroke", "rgba(43,34,244,0.12)");
      r.setAttribute("stroke-opacity", "1");
      r.setAttribute("stroke-width", "1");
      r.setAttribute("rx", "5");
      return r;
    }

    svg.appendChild(makeKpBarFrame());

    // Draw Kp data segments
    if (kpSeries && kpSeries.length){
      kpSeries.sort(function(a,b){ return a.t - b.t; });

      for (var k=0; k<kpSeries.length; k++){
        var a = kpSeries[k];
        var b = (k < kpSeries.length-1) ? kpSeries[k+1] : null;

        var xa = xForTime(a.t);
        var xb = b ? xForTime(b.t) : x1;
        if (xa < x0) xa = x0;
        if (xb > x1) xb = x1;
        if (xb - xa < 1) continue;

        var kp = clamp(a.kp, 0, 9);

        var seg = svgEl("rect");
        seg.setAttribute("x", String(xa));
        seg.setAttribute("y", String(kpBarY));
        seg.setAttribute("width", String(xb - xa));
        seg.setAttribute("height", String(kpBarH));
        seg.setAttribute("fill", getKpColor(kp));
        seg.setAttribute("fill-opacity", "1");
        seg.setAttribute("shape-rendering", "crispEdges");
        svg.appendChild(seg);
      }

      // Re-draw frame on top
      svg.appendChild(makeKpBarFrame());
    }

    // Add Kp label
    var kpLabel = svgEl("text");
    kpLabel.textContent = "Kp";
    kpLabel.setAttribute("x", String(x0 - 6));
    kpLabel.setAttribute("y", String(kpBarY + kpBarH/2 + 3));
    kpLabel.setAttribute("fill", "rgba(43,34,244,0.50)");
    kpLabel.setAttribute("font-size", "9");
    kpLabel.setAttribute("font-weight", "700");
    kpLabel.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
    kpLabel.setAttribute("text-anchor", "end");
    svg.appendChild(kpLabel);

    // cloud bar frame (shifted down)
    var barH = 12;
    var barY = kpBarY + kpBarH + 4;
    var barX = x0;
    var barW = (x1 - x0);

    function makeBarFrame(){
      var r = svgEl("rect");
      r.setAttribute("x", String(barX));
      r.setAttribute("y", String(barY));
      r.setAttribute("width", String(barW));
      r.setAttribute("height", String(barH));
      r.setAttribute("fill", "rgba(43,34,244,0.06)");
      r.setAttribute("fill-opacity", "1");
      r.setAttribute("stroke", "rgba(43,34,244,0.12)");
      r.setAttribute("stroke-opacity", "1");
      r.setAttribute("stroke-width", "1");
      r.setAttribute("rx", "5");
      return r;
    }

    svg.appendChild(makeBarFrame());

    // Add Cloud label
    var cloudLabel = svgEl("text");
    cloudLabel.textContent = "";
    cloudLabel.setAttribute("x", String(x0 - 6));
    cloudLabel.setAttribute("y", String(barY + barH/2 + 4));
    cloudLabel.setAttribute("fill", "rgba(43,34,244,0.50)");
    cloudLabel.setAttribute("font-size", "10");
    cloudLabel.setAttribute("font-weight", "400");
    cloudLabel.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
    cloudLabel.setAttribute("text-anchor", "end");
    svg.appendChild(cloudLabel);

    if (cloudSeries && cloudSeries.length){
      cloudSeries.sort(function(a,b){ return a.t - b.t; });

      function cloudColor(cc){
        if (cc < 10) return "rgba(255,255,255,0.90)";   // White - clear skies
        if (cc < 30) return "rgba(200,200,200,0.70)";   // Light grey
        if (cc < 55) return "rgba(140,140,140,0.65)";   // Grey
        if (cc < 80) return "rgba(90,90,90,0.60)";      // Dark grey
        return "rgba(45,45,45,0.55)";                    // Dark dark grey
      }
    

      for (var c=0; c<cloudSeries.length; c++){
        var a = cloudSeries[c];
        var b = (c < cloudSeries.length-1) ? cloudSeries[c+1] : null;

        var xa = xForTime(a.t);
        var xb = b ? xForTime(b.t) : x1;
        if (xb - xa < 1) xb = xa + 1;

        var cc = clamp(a.cc, 0, 100);

        var seg = svgEl("rect");
        seg.setAttribute("x", String(xa));
        seg.setAttribute("y", String(barY));
        seg.setAttribute("width", String(xb - xa));
        seg.setAttribute("height", String(barH));
        seg.setAttribute("fill", cloudColor(cc));
        seg.setAttribute("shape-rendering", "crispEdges");
        svg.appendChild(seg);
      }

      svg.appendChild(makeBarFrame());
    }

    // Adjust body area to account for bars
    y0 = barY + barH + 8;

    // grid
    var steps = 8;
    for (var i=0;i<=steps;i++){
      var gx = x0 + (i/steps)*(x1-x0);
      var line = svgEl("line");
      line.setAttribute("x1", gx); line.setAttribute("x2", gx);
      line.setAttribute("y1", y0); line.setAttribute("y2", y1);
      line.setAttribute("stroke", "rgba(43,34,244,0.12)");
      line.setAttribute("stroke-opacity", "1");
      line.setAttribute("stroke-width", "1");
      svg.appendChild(line);
    }

    function addLabel(txt, x, anchor){
      var t = svgEl("text");
      t.textContent = txt;
      t.setAttribute("x", String(x));
      t.setAttribute("y", String(H-10));
      t.setAttribute("fill", "rgba(43,34,244,0.50)");
      t.setAttribute("fill-opacity", "1");
      t.setAttribute("font-size", "13");
      t.setAttribute("font-weight", "500");
      t.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
      t.setAttribute("text-anchor", anchor || "middle");
      svg.appendChild(t);
    }

    // Hourly labels
    var startHour = new Date(sunsetLocal);
    startHour.setMinutes(0, 0, 0);
    if (startHour < sunsetLocal) startHour.setHours(startHour.getHours() + 1);
    
    for (var labelTime = startHour.getTime(); labelTime <= sunriseLocal.getTime(); labelTime += 3600000) {
      var labelDate = new Date(labelTime);
      var labelX = xForTime(labelDate);
      if (labelX >= x0 && labelX <= x1) {
        var anchor = "middle";
        if (labelX < x0 + 30) anchor = "start";
        if (labelX > x1 - 30) anchor = "end";
        addLabel(fmt12NoSuffixFromDate(labelDate), labelX, anchor);
      }
    }

    // Bodies in fixed order
    var ORDER = ["Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune"];
    var bodies = [];
    for (var oi=0; oi<ORDER.length; oi++){
      var k = ORDER[oi];
      if (windowsByBody && windowsByBody[k]) bodies.push(k);
    }

    var rows = bodies.length;
    var rowH = (y1 - y0) / Math.max(1, rows);
    var arcAmp = Math.min(46, rowH * 0.85);

    for (var r=0;r<bodies.length;r++){
      var body = bodies[r];
      var w = windowsByBody[body];

      var baseY = y0 + (r + 0.5)*rowH;
      var color = SKY_COLORS[body] || "#d8dee9";

      if (!w || !w.any || !w.first || !w.last){
        // Not visible - thin dashed line
        var off = svgEl("line");
        off.setAttribute("x1", String(x0));
        off.setAttribute("x2", String(x1));
        off.setAttribute("y1", String(baseY));
        off.setAttribute("y2", String(baseY));
        off.setAttribute("stroke", color);
        off.setAttribute("stroke-width", "2");
        off.setAttribute("stroke-dasharray", "4 6");
        off.setAttribute("opacity", "0.15");
        svg.appendChild(off);
        continue;
      }

      // Draw segmented bar based on altitude thresholds
      var segments = w.segments || [];
      
      for (var s = 0; s < segments.length; s++){
        var seg = segments[s];
        var sx1 = xForTime(seg.start);
        var sx2 = xForTime(seg.end);
        if (sx2 - sx1 < 2) sx2 = sx1 + 2;
        
        var segLine = svgEl("line");
        segLine.setAttribute("x1", String(sx1));
        segLine.setAttribute("x2", String(sx2));
        segLine.setAttribute("y1", String(baseY));
        segLine.setAttribute("y2", String(baseY));
        segLine.setAttribute("stroke", color);
        segLine.setAttribute("stroke-width", "6");
        segLine.setAttribute("stroke-linecap", "round");
        
        if (seg.belowTreeline){
          // Below 15 - dashed/textured
          segLine.setAttribute("stroke-dasharray", "3 4");
          segLine.setAttribute("opacity", "0.45");
        } else {
          // Above 15 - solid
          segLine.setAttribute("opacity", "0.85");
        }
        
        svg.appendChild(segLine);
      }
    }

    // NOW marker
    var now = new Date();
    if (now >= sunsetLocal && now <= sunriseLocal){
      var nowX = xForTime(now);
      var nowLine = svgEl("line");
      nowLine.setAttribute("x1", String(nowX));
      nowLine.setAttribute("x2", String(nowX));
      nowLine.setAttribute("y1", String(kpBarY));
      nowLine.setAttribute("y2", String(y1));
      nowLine.setAttribute("stroke", "rgba(43,34,244,0.7)");
      nowLine.setAttribute("stroke-width", "2");
      nowLine.setAttribute("stroke-dasharray", "4 3");
      svg.appendChild(nowLine);
      
      // Small "NOW" label at top
      var nowLabel = svgEl("text");
      nowLabel.textContent = "NOW";
      nowLabel.setAttribute("x", String(nowX));
      nowLabel.setAttribute("y", String(barY - 2));
      nowLabel.setAttribute("fill", "rgba(43,34,244,0.7)");
      nowLabel.setAttribute("font-size", "9");
      nowLabel.setAttribute("font-weight", "700");
      nowLabel.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
      nowLabel.setAttribute("text-anchor", "middle");
      svg.appendChild(nowLabel);
    }

    // Legend
    if (legendEl){
      var legHtml = "";
      
      // Kp scale legend (all 10 levels with SWPC colors)
      legHtml += '<span class="nightsky-item" style="gap:2px;padding:4px 8px;">' +
        '<span style="font-size:.58rem;font-weight:800;color:rgba(43,34,244,.65);margin-right:3px;">Kp</span>' +
        '<span style="font-size:.5rem;font-weight:700;color:rgba(43,34,244,.45);margin-right:2px;">0</span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(0,153,51,0.90);" title="Kp 0"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(51,204,51,0.90);" title="Kp 1"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(102,204,51,0.90);" title="Kp 2"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(153,204,51,0.90);" title="Kp 3"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(204,204,51,0.90);" title="Kp 4"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,255,0,0.90);" title="Kp 5 (G1)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,204,0,0.90);" title="Kp 6 (G2)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,153,0,0.90);" title="Kp 7 (G3)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,51,51,0.90);" title="Kp 8 (G4)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(204,0,51,0.90);" title="Kp 9 (G5)"></span>' +
        '<span style="font-size:.5rem;font-weight:700;color:rgba(43,34,244,.45);margin-left:2px;">9</span>' +
        '</span>';
      
      // Get moon image URL for legend
      var now = new Date();
      var year = now.getFullYear();
      var startOfYear = new Date(year, 0, 1);
      var hourOfYear = Math.floor((now - startOfYear) / (1000 * 60 * 60)) + 1;
      var yearDiff = year - 2024;
      var offsetHours = Math.round(yearDiff * 264);
      var adjustedHour = ((hourOfYear - offsetHours) % 8760);
      if (adjustedHour <= 0) adjustedHour += 8760;
      var frameNum = String(Math.max(1, Math.min(8760, adjustedHour))).padStart(4, '0');
      var moonLegendUrl = "https://svs.gsfc.nasa.gov/vis/a000000/a005000/a005048/frames/730x730_1x1_30p/moon." + frameNum + ".jpg";
      
      for (var li=0; li<bodies.length; li++){
        var b2 = bodies[li];
        var c2 = SKY_COLORS[b2] || "#d8dee9";
        var w2 = windowsByBody[b2];
        var offClass = (!w2 || !w2.any) ? " is-off" : "";
        
        if (b2 === "Moon"){
          // Use moon image instead of dot with clip-path to remove black border
          // Wrap in container to prevent pill from growing
          legHtml +=
            '<span class="nightsky-item'+offClass+'">' +
              '<span style="width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;border-radius:50%;">' +
                '<img src="'+moonLegendUrl+'" style="width:34px;height:34px;border-radius:50%;object-fit:cover;transform:scale(1.19);clip-path:circle(42%);" alt="Moon" />' +
              '</span>' +
              '<span>'+b2+'</span>' +
            '</span>';
        } else {
          legHtml +=
            '<span class="nightsky-item'+offClass+'">' +
              '<span class="nightsky-dot" style="background:'+c2+'"></span>' +
              '<span>'+b2+'</span>' +
            '</span>';
        }
      }
      legendEl.innerHTML = legHtml;
    }
  }

  /* =========================================================
     PLANET / MOON ALT-AZ (minimal)
     ========================================================= */
  function rad(d){ return d*Math.PI/180; }
  function deg(r){ return r*180/Math.PI; }
  function fixAngle(a){ a = a % 360; if (a<0) a+=360; return a; }

  function julianDay(date){
    var y = date.getUTCFullYear();
    var m = date.getUTCMonth()+1;
    var D = date.getUTCDate() + (date.getUTCHours() + date.getUTCMinutes()/60 + date.getUTCSeconds()/3600)/24;
    if (m <= 2){ y -= 1; m += 12; }
    var A = Math.floor(y/100);
    var B = 2 - A + Math.floor(A/4);
    return Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + D + B - 1524.5;
  }
  function daysSinceJ2000(date){ return julianDay(date) - 2451545.0; }

  var ORB = {
    sun:     { w:[282.9404,4.70935E-5], a:[1,0],        e:[0.016709,-1.151E-9], M:[356.0470,0.9856002585] },
    mercury: { N:[48.3313,3.24587E-5], i:[7.0047,5.00E-8], w:[29.1241,1.01444E-5], a:[0.387098,0], e:[0.205635,5.59E-10], M:[168.6562,4.0923344368] },
    venus:   { N:[76.6799,2.46590E-5], i:[3.3946,2.75E-8], w:[54.8910,1.38374E-5], a:[0.723330,0], e:[0.006773,-1.302E-9], M:[48.0052,1.6021302244] },
    mars:    { N:[49.5574,2.11081E-5], i:[1.8497,-1.78E-8], w:[286.5016,2.92961E-5], a:[1.523688,0], e:[0.093405,2.516E-9], M:[18.6021,0.5240207766] },
    jupiter: { N:[100.4542,2.76854E-5], i:[1.3030,-1.557E-7], w:[273.8777,1.64505E-5], a:[5.20256,0],  e:[0.048498,4.469E-9], M:[19.8950,0.0830853001] },
    saturn:  { N:[113.6634,2.38980E-5], i:[2.4886,-1.081E-7], w:[339.3939,2.97661E-5], a:[9.55475,0],  e:[0.055546,-9.499E-9], M:[316.9670,0.0334442282] },
    uranus:  { N:[74.0005,1.3978E-5],  i:[0.7733,1.9E-8],    w:[96.6612,3.0565E-5],   a:[19.18171,-1.55E-8], e:[0.047318,7.45E-9],  M:[142.5905,0.011725806] },
    neptune: { N:[131.7806,3.0173E-5], i:[1.7700,-2.55E-7], w:[272.8461,-6.027E-6],  a:[30.05826,3.313E-8], e:[0.008606,2.15E-9],  M:[260.2471,0.005995147] }
  };

  function kepler(M, e){
    var E = M;
    for (var i=0;i<10;i++){
      var dE = (E - e*Math.sin(E) - M) / (1 - e*Math.cos(E));
      E -= dE;
      if (Math.abs(dE) < 1e-6) break;
    }
    return E;
  }

  function heliocentricEcliptic(body, d){
    var el = ORB[body];
    var N = rad(fixAngle(el.N[0] + el.N[1]*d));
    var i = rad(el.i[0] + el.i[1]*d);
    var w = rad(fixAngle(el.w[0] + el.w[1]*d));
    var a = el.a[0] + el.a[1]*d;
    var e = el.e[0] + el.e[1]*d;
    var M = rad(fixAngle(el.M[0] + el.M[1]*d));
    var E = kepler(M, e);

    var xv = a*(Math.cos(E) - e);
    var yv = a*(Math.sqrt(1 - e*e) * Math.sin(E));
    var v = Math.atan2(yv, xv);
    var r = Math.sqrt(xv*xv + yv*yv);

    var xh = r*(Math.cos(N)*Math.cos(v+w) - Math.sin(N)*Math.sin(v+w)*Math.cos(i));
    var yh = r*(Math.sin(N)*Math.cos(v+w) + Math.cos(N)*Math.sin(v+w)*Math.cos(i));
    var zh = r*(Math.sin(v+w)*Math.sin(i));
    return { x:xh, y:yh, z:zh, r:r };
  }

  function sunEcliptic(d){
    var el = ORB.sun;
    var w = rad(fixAngle(el.w[0] + el.w[1]*d));
    var e = el.e[0] + el.e[1]*d;
    var M = rad(fixAngle(el.M[0] + el.M[1]*d));
    var E = kepler(M, e);
    var xv = (Math.cos(E) - e);
    var yv = (Math.sqrt(1 - e*e) * Math.sin(E));
    var v = Math.atan2(yv, xv);
    var r = Math.sqrt(xv*xv + yv*yv);
    var lon = v + w;
    return { x:r*Math.cos(lon), y:r*Math.sin(lon), z:0, r:r, lon:lon };
  }

  function eclToEqu(x, y, z, d){
    var eps = rad(23.4393 - 3.563E-7*d);
    return {
      x:x,
      y:y*Math.cos(eps) - z*Math.sin(eps),
      z:y*Math.sin(eps) + z*Math.cos(eps)
    };
  }

  function raDecFromEqu(eq){
    var ra = Math.atan2(eq.y, eq.x);
    if (ra < 0) ra += 2*Math.PI;
    var dec = Math.atan2(eq.z, Math.sqrt(eq.x*eq.x + eq.y*eq.y));
    return { ra:ra, dec:dec };
  }

  function localSiderealTime(date, lonDeg){
    var JD = julianDay(date);
    var T = (JD - 2451545.0)/36525.0;
    var GMST = 280.46061837 + 360.98564736629*(JD - 2451545.0) + 0.000387933*T*T - (T*T*T)/38710000.0;
    GMST = fixAngle(GMST);
    return rad(fixAngle(GMST + lonDeg));
  }

  function altAz(ra, dec, date, latDeg, lonDeg){
    var lst = localSiderealTime(date, lonDeg);
    var H = lst - ra;
    while (H < -Math.PI) H += 2*Math.PI;
    while (H >  Math.PI) H -= 2*Math.PI;

    var lat = rad(latDeg);
    var sinAlt = Math.sin(dec)*Math.sin(lat) + Math.cos(dec)*Math.cos(lat)*Math.cos(H);
    var alt = Math.asin(sinAlt);

    var cosAz = (Math.sin(dec) - Math.sin(alt)*Math.sin(lat)) / (Math.cos(alt)*Math.cos(lat));
    cosAz = Math.max(-1, Math.min(1, cosAz));
    var az = Math.acos(cosAz);
    if (Math.sin(H) > 0) az = 2*Math.PI - az;

    return { alt:alt, az:az };
  }

  function planetRaDec(body, date){
    var d = daysSinceJ2000(date);
    var sun = sunEcliptic(d);
    var xe = -sun.x, ye = -sun.y, ze = -sun.z;
    var p = heliocentricEcliptic(body, d);
    var xg = p.x - xe;
    var yg = p.y - ye;
    var zg = p.z - ze;
    return raDecFromEqu(eclToEqu(xg, yg, zg, d));
  }

  function moonRaDec(date){
    var d = daysSinceJ2000(date);
    var N = rad(fixAngle(125.1228 - 0.0529538083 * d));
    var i = rad(5.1454);
    var w = rad(fixAngle(318.0634 + 0.1643573223 * d));
    var a = 60.2666, e = 0.054900;
    var M = rad(fixAngle(115.3654 + 13.0649929509 * d));
    var E = kepler(M, e);

    var xv = a * (Math.cos(E) - e);
    var yv = a * (Math.sqrt(1 - e*e) * Math.sin(E));
    var v  = Math.atan2(yv, xv);
    var r  = Math.sqrt(xv*xv + yv*yv);

    var xh = r * (Math.cos(N)*Math.cos(v+w) - Math.sin(N)*Math.sin(v+w)*Math.cos(i));
    var yh = r * (Math.sin(N)*Math.cos(v+w) + Math.cos(N)*Math.sin(v+w)*Math.cos(i));
    var zh = r * (Math.sin(v+w) * Math.sin(i));

    return raDecFromEqu(eclToEqu(xh, yh, zh, d));
  }

  function computeVisibilityWindows(dateStartLocal, dateEndLocal, bodies, lat, lon){
    var stepMs = 15*60*1000; // 15 min steps for smoother segments
    var minAltDeg = 5;
    var treelineAlt = 15;
    var windows = {};
    
    for (var b=0;b<bodies.length;b++){
      windows[bodies[b]] = { any:false, maxAlt:-999, first:null, last:null, segments:[], altData:[] };
    }

    // First pass: collect altitude data
    for (var t=dateStartLocal.getTime(); t<=dateEndLocal.getTime(); t+=stepMs){
      var dtLocal = new Date(t);
      for (var i=0;i<bodies.length;i++){
        var body = bodies[i];
        var rd = (body === "moon") ? moonRaDec(dtLocal) : planetRaDec(body, dtLocal);
        var aa = altAz(rd.ra, rd.dec, dtLocal, lat, lon);
        var altD = deg(aa.alt);
        var w = windows[body];
        
        if (altD > w.maxAlt) w.maxAlt = altD;
        
        if (altD >= minAltDeg){
          if (!w.any){ w.any = true; w.first = new Date(t); }
          w.last = new Date(t);
          w.altData.push({ time: new Date(t), alt: altD, belowTreeline: altD < treelineAlt });
        }
      }
    }

    // Second pass: build segments from altitude data
    for (var b=0;b<bodies.length;b++){
      var body = bodies[b];
      var w = windows[body];
      
      if (!w.altData.length) continue;
      
      var currentSeg = null;
      
      for (var d=0; d<w.altData.length; d++){
        var pt = w.altData[d];
        
        if (!currentSeg){
          currentSeg = { start: pt.time, end: pt.time, belowTreeline: pt.belowTreeline };
        } else if (pt.belowTreeline === currentSeg.belowTreeline){
          currentSeg.end = pt.time;
        } else {
          w.segments.push(currentSeg);
          currentSeg = { start: pt.time, end: pt.time, belowTreeline: pt.belowTreeline };
        }
      }
      
      if (currentSeg){
        w.segments.push(currentSeg);
      }
    }
    
    return windows;
  }

  /* =========================================================
     SOLAR MATH (NOAA-style approx) for sunbar
     ========================================================= */
  

  function _dayOfYearLocal(d){
    var start = new Date(d.getFullYear(), 0, 1);
    return Math.floor((d - start) / 86400000) + 1;
  }

  function _solarTerms(dLocal){
    var doy = _dayOfYearLocal(dLocal);
    var hr  = dLocal.getHours() + dLocal.getMinutes()/60 + dLocal.getSeconds()/3600;
    var gamma = 2 * Math.PI / 365 * (doy - 1 + (hr - 12) / 24);

    var eqtime =
      229.18 * (
        0.000075 +
        0.001868 * Math.cos(gamma) -
        0.032077 * Math.sin(gamma) -
        0.014615 * Math.cos(2 * gamma) -
        0.040849 * Math.sin(2 * gamma)
      );

    var decl =
      0.006918 -
      0.399912 * Math.cos(gamma) +
      0.070257 * Math.sin(gamma) -
      0.006758 * Math.cos(2 * gamma) +
      0.000907 * Math.sin(2 * gamma) -
      0.002697 * Math.cos(3 * gamma) +
      0.00148  * Math.sin(3 * gamma);

    return { eqtime:eqtime, decl:decl };
  }

  function _minsLocal(d){ return d.getHours()*60 + d.getMinutes() + d.getSeconds()/60; }
  function _tzOffsetMinutes(dLocal){ return dLocal.getTimezoneOffset(); }

  function solarNoonLocal(dayLocal, latDeg, lonDeg){
    var terms = _solarTerms(dayLocal);
    var tzMin = _tzOffsetMinutes(dayLocal);
    var tzHr  = -tzMin / 60;

    var timeOffset = terms.eqtime + 4*lonDeg - 60*tzHr;
    var solarNoonMin = 720 - timeOffset;

    var base = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0,0,0,0);
    return new Date(base.getTime() + solarNoonMin * 60000);
  }

  function solarEventTimeLocal(dayLocal, latDeg, lonDeg, altitudeDeg, isDawn){
    var terms = _solarTerms(dayLocal);
    var decl = terms.decl;

    var lat = rad(latDeg);
    var alt = rad(altitudeDeg);

    var cosH =
      (Math.sin(alt) - Math.sin(lat)*Math.sin(decl)) /
      (Math.cos(lat)*Math.cos(decl));

    if (!isFinite(cosH) || cosH < -1 || cosH > 1) return null;

    cosH = clamp(cosH, -1, 1);
    var H = Math.acos(cosH);

    var Hdeg = deg(H);
    var deltaMin = 4 * Hdeg;

    var noon = solarNoonLocal(dayLocal, latDeg, lonDeg);
    var noonMin = _minsLocal(noon);

    var eventMin = isDawn ? (noonMin - deltaMin) : (noonMin + deltaMin);

    var base = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0,0,0,0);
    return new Date(base.getTime() + eventMin * 60000);
  }

  /* =========================================================
     TODAY TIMELINE RENDER (v4/v5 integrated widget)
     ========================================================= */
  function renderTodayTimeline(hourly, daily, nearestIndex, kpData){
    // DOM refs
    var tlSunrise = document.getElementById("today-tl-sunrise");
    var tlSunset = document.getElementById("today-tl-sunset");
    var tlGoldenAm = document.getElementById("today-tl-golden-am");
    var tlGoldenPm = document.getElementById("today-tl-golden-pm");
    var tlDaylight = document.getElementById("today-tl-daylight");
    var tlDaylightChange = document.getElementById("today-tl-daylight-change");
    var tlSky = document.getElementById("today-tl-sky");
    var tlCloud = document.getElementById("today-tl-cloud-pct");
    var tlMoon = null; // replaced by today-tl-moon-name and today-tl-moon-illum
    var tlKpTrack = document.getElementById("today-tl-kp-track");
    var tlCloudTrack = document.getElementById("today-tl-cloud-track");
    var tlSkyBands = document.getElementById("today-tl-sky-bands");
    var tlPlanetTracks = document.getElementById("today-tl-planet-tracks");
    var tlWeatherRow = document.getElementById("today-tl-weather-row");
    var tlNowMarker = document.getElementById("today-tl-now-marker");
    var tlNowTemp = document.getElementById("today-tl-now-temp");
    var tlNowTime = document.getElementById("today-tl-now-time");

    if (!daily || !daily.sunrise || !daily.sunset) return;

    var srIso = daily.sunrise[0];
    var ssIso = daily.sunset[0];
    var srDate = new Date(srIso);
    var ssDate = new Date(ssIso);

    // Calculate solar events
    var dayLocal = new Date(srDate.getFullYear(), srDate.getMonth(), srDate.getDate(), 12, 0, 0, 0);
    
    var astroDawn = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, true);
    var astroDusk = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, false);
    var blueAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, true);
    var blueAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var bluePmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var bluePmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, false);
    var goldenAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var goldenAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, true);
    var goldenPmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, false);
    var goldenPmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var noon = solarNoonLocal(dayLocal, LOCATION.lat, LOCATION.lon);

    // Update header metadata
    if (tlSunrise) tlSunrise.textContent = fmt12NoSuffix(srIso);
    if (tlSunset) tlSunset.textContent = fmt12NoSuffix(ssIso);
    if (tlGoldenAm) {
      if (goldenAmStart && goldenAmEnd) {
        tlGoldenAm.textContent = fmt12NoSuffixFromDate(goldenAmStart) + "  " + fmt12NoSuffixFromDate(goldenAmEnd);
      } else {
        tlGoldenAm.textContent = "--";
      }
    }
    if (tlGoldenPm) {
      if (goldenPmStart && goldenPmEnd) {
        tlGoldenPm.textContent = fmt12NoSuffixFromDate(goldenPmStart) + "  " + fmt12NoSuffixFromDate(goldenPmEnd);
      } else {
        tlGoldenPm.textContent = "--";
      }
    }

    // Calculate daylight duration
    var daylightMs = ssDate.getTime() - srDate.getTime();
    var daylightHours = Math.floor(daylightMs / (1000 * 60 * 60));
    var daylightMins = Math.floor((daylightMs % (1000 * 60 * 60)) / (1000 * 60));
    if (tlDaylight) tlDaylight.textContent = daylightHours + "h " + daylightMins + "m";

    // Calculate daylight change from yesterday
    if (tlDaylightChange){
      var yesterdayLocal = new Date(dayLocal.getTime() - 86400000);
      var srYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, true);
      var ssYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, false);
      
      if (srYesterday && ssYesterday){
        var yesterdayMs = ssYesterday.getTime() - srYesterday.getTime();
        var diffMs = daylightMs - yesterdayMs;
        var diffSecs = Math.round(diffMs / 1000);
        var diffMins = Math.floor(Math.abs(diffSecs) / 60);
        var remainSecs = Math.abs(diffSecs) % 60;
        
        var sign = diffSecs >= 0 ? "+" : "-";
        var timeStr = diffMins > 0 ? (sign + diffMins + "m " + remainSecs + "s") : (sign + remainSecs + "s");
        
        if (diffSecs > 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(80,180,80,1)";
        } else if (diffSecs < 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(200,100,80,1)";
        } else {
          tlDaylightChange.textContent = "(+0s)";
          tlDaylightChange.style.color = "rgba(43,34,244,.60)";
        }
      }
    }

    // Sky condition and cloud %
    var weatherInfo = getWeatherAnimClass(daily.weathercode[0], false);
    if (tlSky) tlSky.textContent = weatherInfo.label;
    
    // Calculate average cloud cover for today
    if (tlCloud && hourly && hourly.cloudcover){
      var todayStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0, 0);
      var todayEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59, 999);
      var cloudSum = 0, cloudCount = 0;
      for (var ci = 0; ci < hourly.time.length; ci++){
        var dt = new Date(hourly.time[ci]);
        if (dt >= todayStart && dt <= todayEnd && typeof hourly.cloudcover[ci] === "number"){
          cloudSum += hourly.cloudcover[ci];
          cloudCount++;
        }
      }
      var avgCloud = cloudCount > 0 ? Math.round(cloudSum / cloudCount) : 0;
      tlCloud.textContent = avgCloud + "%";
    }

    // Moon info
    var phaseFrac = approximateMoonPhase(new Date());
    var mi = moonInfo(phaseFrac);
    if (document.getElementById("today-tl-moon-name")) document.getElementById("today-tl-moon-name").textContent = mi.name;
    if (document.getElementById("today-tl-moon-illum")) document.getElementById("today-tl-moon-illum").textContent = mi.illum + "%";

    // Timeline range: midnight to midnight
    var timelineStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0, 0).getTime();
    var timelineEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59, 999).getTime();
    var timelineSpan = timelineEnd - timelineStart;

    function pctForTime(d){
      if (!d || !d.getTime) return -1;
      var t = d.getTime();
      if (t < timelineStart || t > timelineEnd) return -1;
      return ((t - timelineStart) / timelineSpan) * 100;
    }

    // Render Kp track
    if (tlKpTrack){
      var kpHtml = "";
      if (kpData && kpData.length > 0){
        // Sort by time
        kpData.sort(function(a, b){ return a.t - b.t; });
        
        for (var ki = 0; ki < kpData.length; ki++){
          var kpPoint = kpData[ki];
          var nextPoint = kpData[ki + 1];
          
          var startPct = pctForTime(kpPoint.t);
          var endPct = nextPoint ? pctForTime(nextPoint.t) : 100;
          
          if (startPct < 0) startPct = 0;
          if (endPct < 0 || endPct > 100) endPct = 100;
          
          var widthPct = endPct - startPct;
          if (widthPct <= 0) continue;
          
          var kpColorVal = getKpColor(kpPoint.kp);
          kpHtml += '<div class="today-tl-bar-segment" style="width:' + widthPct + '%;background:' + kpColorVal + ';"></div>';
        }
      } else {
        // Default quiet Kp
        kpHtml = '<div class="today-tl-bar-segment" style="width:100%;background:#33cc33;"></div>';
      }
      tlKpTrack.innerHTML = kpHtml;
      // Show current Kp value in bar label
      var kpValEl = document.getElementById("today-tl-kp-val");
      if (kpValEl && kpData && kpData.length > 0) {
        var nowT = Date.now();
        var closestKp = kpData[0];
        for (var ck = 0; ck < kpData.length; ck++) {
          if (kpData[ck].t.getTime() <= nowT) closestKp = kpData[ck];
        }
        kpValEl.textContent = closestKp.kp.toFixed(1);
      }
    }

    // Render cloud track
    if (tlCloudTrack && hourly && hourly.cloudcover){
      var cloudHtml = "";
      var hoursPerSegment = 3;
      
      for (var h = 0; h < 24; h += hoursPerSegment){
        var segStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h, 0, 0, 0);
        var segEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h + hoursPerSegment, 0, 0, 0);
        
        // Average cloud cover for this segment
        var segSum = 0, segCount = 0;
        for (var chi = 0; chi < hourly.time.length; chi++){
          var dt = new Date(hourly.time[chi]);
          if (dt >= segStart && dt < segEnd && typeof hourly.cloudcover[chi] === "number"){
            segSum += hourly.cloudcover[chi];
            segCount++;
          }
        }
        
        var segCloud = segCount > 0 ? Math.round(segSum / segCount) : 0;
        var widthPct = (hoursPerSegment / 24) * 100;
        
        // Cloud color: white (clear) to dark grey (overcast)
        var cloudColor;
        if (segCloud < 10) cloudColor = "rgba(255,255,255,0.90)";
        else if (segCloud < 30) cloudColor = "rgba(220,220,220,0.85)";
        else if (segCloud < 50) cloudColor = "rgba(180,180,180,0.80)";
        else if (segCloud < 70) cloudColor = "rgba(140,140,140,0.75)";
        else if (segCloud < 85) cloudColor = "rgba(100,100,100,0.70)";
        else cloudColor = "rgba(70,70,70,0.65)";
        
        cloudHtml += '<div class="today-tl-bar-segment" style="width:' + widthPct + '%;background:' + cloudColor + ';"></div>';
      }
      tlCloudTrack.innerHTML = cloudHtml;
    }

    // Render sky gradient bands  continuous gradient based on sunrise/sunset position
    // Enhanced with: seasonal intensity, humidity tinting, cloud-aware golden hour
    if (tlSkyBands){
      var srPct = pctForTime(srDate);
      var ssPct = pctForTime(ssDate);
      
      if (srPct < 0) srPct = 25;
      if (ssPct < 0) ssPct = 75;
      
      // === SEASONAL SKY INTENSITY ===
      // Calculate solar noon max altitude to scale midday blue
      // Higher sun = deeper blue, lower sun = paler sky
      var terms = _solarTerms(dayLocal);
      var latRad = rad(LOCATION.lat);
      var noonAltRad = Math.asin(Math.sin(latRad) * Math.sin(terms.decl) + Math.cos(latRad) * Math.cos(terms.decl));
      var noonAltDeg = deg(noonAltRad);
      // Scale: 20 (winter)  0.65 intensity, 73 (summer)  1.0 intensity
      var seasonalFactor = clamp((noonAltDeg - 15) / (70 - 15), 0.55, 1.0);
      
      // === HUMIDITY / VISIBILITY TINTING ===
      // Average humidity during daylight hours  high humidity washes out colors
      var avgHumidity = 50;
      if (hourly && hourly.relativehumidity_2m){
        var humSum = 0, humCount = 0;
        for (var hi2 = 0; hi2 < hourly.time.length; hi2++){
          var dt2 = new Date(hourly.time[hi2]);
          if (dt2 >= srDate && dt2 <= ssDate && typeof hourly.relativehumidity_2m[hi2] === "number"){
            humSum += hourly.relativehumidity_2m[hi2];
            humCount++;
          }
        }
        if (humCount > 0) avgHumidity = humSum / humCount;
      }
      // Scale: <40% RH  1.0 (crisp), >85% RH  0.7 (washed out)
      var humidityFactor = clamp(1.0 - (avgHumidity - 40) / (85 - 40) * 0.3, 0.7, 1.0);
      
      // Combined sky clarity factor
      var skyClarity = seasonalFactor * humidityFactor;
      
      // Adjusted midday blue opacity based on sky clarity
      var midBlueOp = (0.38 + 0.24 * skyClarity).toFixed(2);
      var midBlueEdgeOp = (0.32 + 0.20 * skyClarity).toFixed(2);
      var dayEdgeOp = (0.30 + 0.15 * skyClarity).toFixed(2);
      
      // Midday blue RGB shifts slightly paler in winter/humid conditions
      var midBlueR = Math.round(65 + (1 - skyClarity) * 60);
      var midBlueG = Math.round(140 + (1 - skyClarity) * 40);
      var midBlueB = Math.round(230 + (1 - skyClarity) * 15);
      
      // === CLOUD-AWARE GOLDEN HOUR ===
      // Check if cloud cover during golden hours is in the "vivid" range (30-70%)
      var amGoldenCloud = 0, pmGoldenCloud = 0;
      if (hourly && hourly.cloudcover){
        var amCSum = 0, amCCnt = 0, pmCSum = 0, pmCCnt = 0;
        for (var ci2 = 0; ci2 < hourly.time.length; ci2++){
          var cdt = new Date(hourly.time[ci2]);
          if (goldenAmStart && goldenAmEnd && cdt >= goldenAmStart && cdt <= goldenAmEnd){
            amCSum += hourly.cloudcover[ci2]; amCCnt++;
          }
          if (goldenPmStart && goldenPmEnd && cdt >= goldenPmStart && cdt <= goldenPmEnd){
            pmCSum += hourly.cloudcover[ci2]; pmCCnt++;
          }
        }
        if (amCCnt > 0) amGoldenCloud = amCSum / amCCnt;
        if (pmCCnt > 0) pmGoldenCloud = pmCSum / pmCCnt;
      }
      // Vivid factor: peaks at 40-60% cloud cover, drops at 0% or 100%
      function vividFactor(cloud){
        if (cloud >= 30 && cloud <= 70) return 1.0 + (1.0 - Math.abs(cloud - 50) / 20) * 0.15;
        return 1.0;
      }
      var amVivid = vividFactor(amGoldenCloud);
      var pmVivid = vividFactor(pmGoldenCloud);
      
      // Apply vivid boost to golden hour opacity
      var amGoldenPeakOp = clamp(0.62 * amVivid, 0.55, 0.78).toFixed(2);
      var pmGoldenPeakOp = clamp(0.68 * pmVivid, 0.60, 0.82).toFixed(2);
      
      // Spread widths (in percentage points)
      var amGoldenInner = 3.5;
      var amGoldenOuter = 5.5;
      var amBlueW = 2.5;
      var amNautW = 3.0;
      var amAstroW = 4.0;
      var amDayEdgeW = 3.5;
      
      var pmGoldenInner = 4.0;
      var pmGoldenOuter = 6.0;
      var pmBlueW = 3.0;
      var pmNautW = 3.5;
      var pmAstroW = 4.5;
      var pmDayEdgeW = 3.5;
      
      // AM anchor points
      var amAstroStart = Math.max(0, srPct - amGoldenInner - amBlueW - amNautW - amAstroW);
      var amNautStart  = Math.max(0, srPct - amGoldenInner - amBlueW - amNautW);
      var amBlueStart  = Math.max(0, srPct - amGoldenInner - amBlueW);
      var amGoldenStart= Math.max(0, srPct - amGoldenInner);
      var amSunrise    = srPct;
      var amGoldenEnd  = srPct + amGoldenOuter;
      var amDayEdge    = srPct + amGoldenOuter + amDayEdgeW;
      
      // PM anchor points
      var pmDayEdge    = Math.min(100, ssPct - pmGoldenInner - pmDayEdgeW);
      var pmGoldenStart= Math.min(100, ssPct - pmGoldenInner);
      var pmSunset     = ssPct;
      var pmGoldenEnd  = Math.min(100, ssPct + pmGoldenOuter);
      var pmBlueEnd    = Math.min(100, ssPct + pmGoldenOuter + pmBlueW);
      var pmNautEnd    = Math.min(100, ssPct + pmGoldenOuter + pmBlueW + pmNautW);
      var pmAstroEnd   = Math.min(100, ssPct + pmGoldenOuter + pmBlueW + pmNautW + pmAstroW);
      
      var midday = (amDayEdge + pmDayEdge) / 2;
      
      var gradientStr = "linear-gradient(90deg, " +
        "rgba(15,20,45,.92) 0%, " +
        "rgba(15,20,45,.92) " + Math.max(0, amAstroStart - 2).toFixed(1) + "%, " +
        "rgba(20,28,60,.88) " + amAstroStart.toFixed(1) + "%, " +
        "rgba(28,38,80,.80) " + amNautStart.toFixed(1) + "%, " +
        "rgba(42,55,115,.65) " + ((amNautStart + amBlueStart) / 2).toFixed(1) + "%, " +
        "rgba(55,70,140,.55) " + amBlueStart.toFixed(1) + "%, " +
        "rgba(70,95,170,.48) " + amGoldenStart.toFixed(1) + "%, " +
        "rgba(160,120,75,.45) " + (amSunrise - 2.5).toFixed(1) + "%, " +
        "rgba(220,155,70,.52) " + (amSunrise - 1.2).toFixed(1) + "%, " +
        "rgba(255,145,55," + amGoldenPeakOp + ") " + amSunrise.toFixed(1) + "%, " +
        "rgba(255,185,95,.42) " + (amSunrise + 2).toFixed(1) + "%, " +
        "rgba(240,210,160,.35) " + (amSunrise + 3.5).toFixed(1) + "%, " +
        "rgba(210,220,240,.35) " + amGoldenEnd.toFixed(1) + "%, " +
        "rgba(170,205,248," + dayEdgeOp + ") " + amDayEdge.toFixed(1) + "%, " +
        "rgba(" + Math.round(midBlueR + 35) + "," + Math.round(midBlueG + 30) + "," + midBlueB + "," + midBlueEdgeOp + ") " + (midday - 8).toFixed(1) + "%, " +
        "rgba(" + midBlueR + "," + midBlueG + "," + midBlueB + "," + midBlueOp + ") " + (midday - 3).toFixed(1) + "%, " +
        "rgba(" + midBlueR + "," + midBlueG + "," + midBlueB + "," + midBlueOp + ") " + (midday + 3).toFixed(1) + "%, " +
        "rgba(" + Math.round(midBlueR + 35) + "," + Math.round(midBlueG + 30) + "," + midBlueB + "," + midBlueEdgeOp + ") " + (midday + 8).toFixed(1) + "%, " +
        "rgba(170,205,248," + dayEdgeOp + ") " + pmDayEdge.toFixed(1) + "%, " +
        "rgba(210,220,240,.35) " + pmGoldenStart.toFixed(1) + "%, " +
        "rgba(240,200,140,.38) " + (pmSunset - 3.5).toFixed(1) + "%, " +
        "rgba(255,180,80,.45) " + (pmSunset - 2).toFixed(1) + "%, " +
        "rgba(255,150,50,.58) " + (pmSunset - 0.8).toFixed(1) + "%, " +
        "rgba(240,105,30," + pmGoldenPeakOp + ") " + pmSunset.toFixed(1) + "%, " +
        "rgba(220,85,25,.64) " + (pmSunset + 1.5).toFixed(1) + "%, " +
        "rgba(190,65,30,.58) " + (pmSunset + 3).toFixed(1) + "%, " +
        "rgba(140,50,40,.52) " + (pmSunset + 4.5).toFixed(1) + "%, " +
        "rgba(100,45,50,.48) " + pmGoldenEnd.toFixed(1) + "%, " +
        "rgba(60,45,80,.55) " + ((pmGoldenEnd + pmBlueEnd) / 2).toFixed(1) + "%, " +
        "rgba(50,50,100,.60) " + pmBlueEnd.toFixed(1) + "%, " +
        "rgba(38,42,85,.72) " + pmNautEnd.toFixed(1) + "%, " +
        "rgba(25,32,65,.82) " + pmAstroEnd.toFixed(1) + "%, " +
        "rgba(15,20,45,.92) " + Math.min(100, pmAstroEnd + 3).toFixed(1) + "%, " +
        "rgba(15,20,45,.92) 100%" +
      ")";
      
      tlSkyBands.innerHTML = '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:' + gradientStr + ';"></div>';
    }

    // Render planet tracks
    if (tlPlanetTracks){
      // Compute visibility windows for today
      var bodies = ["moon", "mercury", "venus", "mars", "jupiter", "saturn", "uranus", "neptune"];
      var todayStartDate = new Date(timelineStart);
      var todayEndDate = new Date(timelineEnd);
      
      var windows = computeVisibilityWindows(todayStartDate, todayEndDate, bodies, LOCATION.lat, LOCATION.lon);
      
      var planetOrder = ["Moon", "Mercury", "Venus", "Mars", "Jupiter", "Saturn", "Uranus", "Neptune"];
      var nameMap = { moon: "Moon", mercury: "Mercury", venus: "Venus", mars: "Mars", jupiter: "Jupiter", saturn: "Saturn", uranus: "Uranus", neptune: "Neptune" };
      
      var planetsHtml = "";
      
      // Calculate average azimuth for each body to determine direction
      function getDirectionAbbrev(azDeg){
        if (azDeg >= 337.5 || azDeg < 22.5) return "NORTH";
        if (azDeg >= 22.5 && azDeg < 67.5) return "NORTHEAST";
        if (azDeg >= 67.5 && azDeg < 112.5) return "EAST";
        if (azDeg >= 112.5 && azDeg < 157.5) return "SOUTHEAST";
        if (azDeg >= 157.5 && azDeg < 202.5) return "SOUTH";
        if (azDeg >= 202.5 && azDeg < 247.5) return "SOUTHWEST";
        if (azDeg >= 247.5 && azDeg < 292.5) return "WEST";
        if (azDeg >= 292.5 && azDeg < 337.5) return "NORTHWEST";
        return "";
      }
      
      function getPlanetDirection(body, windows){
        // Calculate azimuth for RIGHT NOW (real-time position)
        var now = new Date();
        var rd = (body === "moon") ? moonRaDec(now) : planetRaDec(body, now);
        var aa = altAz(rd.ra, rd.dec, now, LOCATION.lat, LOCATION.lon);
        var altD = deg(aa.alt);
        var azDeg = deg(aa.az);
        
        // If below horizon, show "Below" instead of direction
        if (altD < 0) return "Below";
        
        return getDirectionAbbrev(azDeg);
      }
      
      // Store directions for legend
      window.planetDirections = {};
      
      for (var pi = 0; pi < bodies.length; pi++){
        var body = bodies[pi];
        var w = windows[body];
        var displayName = nameMap[body];
        var color = TODAY_TL_PLANET_COLORS[displayName] || "rgba(200,200,200,0.8)";
        var direction = getPlanetDirection(body, windows);
        
        // Store for legend
        window.planetDirections[displayName] = direction;
        
        planetsHtml += '<div class="today-tl-planet-row">';
        planetsHtml += '<div class="today-tl-planet-indicator" style="background:' + color + ';box-shadow:0 0 6px ' + color + ';"></div>';
        planetsHtml += '<div class="today-tl-planet-bar">';
        
        if (w && w.segments && w.segments.length > 0){
          for (var si = 0; si < w.segments.length; si++){
            var seg = w.segments[si];
            var startPct = pctForTime(seg.start);
            var endPct = pctForTime(seg.end);
            
            if (startPct < 0) startPct = 0;
            if (endPct < 0) endPct = 0;
            if (endPct > 100) endPct = 100;
            
            var widthPct = endPct - startPct;
            if (widthPct < 0.5) widthPct = 0.5;
            
            var visClass = seg.belowTreeline ? "dashed" : "solid";
            planetsHtml += '<div class="today-tl-planet-vis ' + visClass + '" style="left:' + startPct + '%;width:' + widthPct + '%;background:' + color + ';color:' + color + ';"></div>';
          }
        }
        
        planetsHtml += '</div></div>';
      }
      
      tlPlanetTracks.innerHTML = planetsHtml;
    }

    // Render weather row with animated icons (every 3 hours)
    if (tlWeatherRow && hourly && hourly.time){
      var weatherHtml = "";
      
      var isMobile = window.innerWidth <= 768;
      var hStep = isMobile ? 3 : 1;
      for (var h = 0; h < 24; h += hStep){
        var targetHour = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h, 0, 0, 0);
        
        // Find matching index in hourly data
        var matchIdx = -1;
        for (var hi = 0; hi < hourly.time.length; hi++){
          var dt = new Date(hourly.time[hi]);
          if (dt.getFullYear() === targetHour.getFullYear() &&
              dt.getMonth() === targetHour.getMonth() &&
              dt.getDate() === targetHour.getDate() &&
              dt.getHours() === targetHour.getHours()){
            matchIdx = hi;
            break;
          }
        }
        
        var timeLabel = h === 0 ? "12AM" : (h < 12 ? h + "AM" : (h === 12 ? "12PM" : (h - 12) + "PM"));
        var temp = "--";
        var precip = 0;
        var weatherCode = 0;
        
        // Determine sky state for this hour using actual sun altitude
        var isNightHour = (targetHour < srDate || targetHour > ssDate);
        var isDayHour = !isNightHour;
        
        // Calculate sun altitude at this hour for continuous classification
        var hourTerms = _solarTerms(targetHour);
        var hourLatRad = rad(LOCATION.lat);
        var hourNoon = solarNoonLocal(dayLocal, LOCATION.lat, LOCATION.lon);
        var hourAngle = (targetHour.getTime() - hourNoon.getTime()) / 3600000 * 15; // degrees
        var hourAngleRad = rad(hourAngle);
        var sinAlt = Math.sin(hourLatRad) * Math.sin(hourTerms.decl) + Math.cos(hourLatRad) * Math.cos(hourTerms.decl) * Math.cos(hourAngleRad);
        var sunAltDeg = deg(Math.asin(clamp(sinAlt, -1, 1)));
        
        // Classify sky state based on sun altitude (continuous)
        var skyState = "night";
        if (sunAltDeg > 6) {
          skyState = "day";
        } else if (sunAltDeg > 1) {
          skyState = "golden";
        } else if (sunAltDeg > -2) {
          skyState = "golden-peak";
        } else if (sunAltDeg > -4) {
          skyState = "golden";
        } else if (sunAltDeg > -6) {
          skyState = "blue-hour";
        } else if (sunAltDeg > -12) {
          skyState = "twilight";
        }
        
        if (matchIdx >= 0){
          temp = Math.round(hourly.temperature_2m[matchIdx]) + "";
          precip = hourly.precipitation_probability ? (hourly.precipitation_probability[matchIdx] || 0) : 0;
          weatherCode = hourly.weathercode ? (hourly.weathercode[matchIdx] || 0) : 0;
        }
        
        // Get precip amounts for this hour
        var hPrecipAmt = (matchIdx >= 0 && hourly.precipitation) ? (hourly.precipitation[matchIdx] || 0) : 0;
        var hSnowAmt = (matchIdx >= 0 && hourly.snowfall) ? (hourly.snowfall[matchIdx] || 0) : 0;
        var hRainAmt = (matchIdx >= 0 && hourly.rain) ? (hourly.rain[matchIdx] || 0) : 0;
        
        var weatherInfo = getWeatherAnimClass(weatherCode, isNightHour);
        var precipClass = precip >= 50 ? "active" : "";
        
        // Build class list based on sky state
        var hourClass = "today-tl-weather-hour";
        if (skyState === "golden-peak") hourClass += " golden-peak-hour";
        else if (skyState === "golden") hourClass += " golden-hour";
        else if (skyState === "blue-hour") hourClass += " blue-hour-col";
        else if (skyState === "twilight") hourClass += " twilight-hour";
        else if (skyState === "day") hourClass += " day-hour";
        // night hours get no extra class (default white-on-dark)
        
        var feelsLike = (matchIdx >= 0 && hourly.apparent_temperature) ? Math.round(hourly.apparent_temperature[matchIdx]) + "" : "";
        var windSpd = (matchIdx >= 0 && hourly.windspeed_10m) ? Math.round(hourly.windspeed_10m[matchIdx]) : "";
        var gustSpd = (matchIdx >= 0 && hourly.windgusts_10m) ? Math.round(hourly.windgusts_10m[matchIdx]) : "";
        var windStr = windSpd !== "" ? "" + windSpd + (gustSpd && gustSpd > windSpd ? " " + gustSpd : "") : "";
        var windDeg = (matchIdx >= 0 && hourly.wind_direction_10m) ? (hourly.wind_direction_10m[matchIdx] || 0) : 0;
        var wDirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
        var windDirStr = windSpd !== "" ? wDirs[Math.round(windDeg / 22.5) % 16] : "";
        
        // Inline color styles for feels-like, wind, wind-dir based on sky state
        var feelsColor = "rgba(255,255,255,.45)";
        var windColor = "rgba(255,255,255,.35)";
        var windDirColor = "rgba(255,255,255,.3)";
        if (skyState === "golden-peak"){
          feelsColor = "rgba(255,160,50,.55)";
          windColor = "rgba(255,160,50,.45)";
          windDirColor = "rgba(255,160,50,.4)";
        } else if (skyState === "golden"){
          feelsColor = "rgba(255,180,80,.5)";
          windColor = "rgba(255,180,80,.4)";
          windDirColor = "rgba(255,180,80,.35)";
        } else if (skyState === "blue-hour"){
          feelsColor = "rgba(150,180,240,.5)";
          windColor = "rgba(150,180,240,.4)";
          windDirColor = "rgba(150,180,240,.35)";
        } else if (skyState === "twilight"){
          feelsColor = "rgba(180,195,240,.45)";
          windColor = "rgba(180,195,240,.35)";
          windDirColor = "rgba(180,195,240,.3)";
        } else if (skyState === "day"){
          feelsColor = "rgba(255,255,255,.55)";
          windColor = "rgba(255,255,255,.45)";
          windDirColor = "rgba(255,255,255,.4)";
        }
        
        // Format hourly precip amount with climate-aware intensity color
        // Uses same regional thresholds computed for top timeline
        if (!window._precipThresholds) {
          window._precipThresholds = { drizzle:0.03, light:0.08, moderate:0.15, heavy:0.30, extreme:0.50 };
        }
        var pt2 = window._precipThresholds;
        
        var hPrecipStr = "";
        var hPrecipColor = "rgba(80,190,100,.7)";
        if (hSnowAmt > 0){
          hPrecipStr = hSnowAmt >= 0.1 ? hSnowAmt.toFixed(1) + '"' : 'MIN';
          if (hSnowAmt >= 1.0) hPrecipColor = "rgba(255,60,60,.9)";
          else if (hSnowAmt >= 0.5) hPrecipColor = "rgba(255,140,50,.85)";
          else if (hSnowAmt >= 0.2) hPrecipColor = "rgba(255,200,50,.8)";
          else hPrecipColor = "rgba(200,220,255,.7)";
        } else if (hPrecipAmt >= 0.01){
          hPrecipStr = hPrecipAmt.toFixed(2) + '"';
          if (hPrecipAmt >= pt2.extreme) hPrecipColor = "rgba(255,50,50,.95)";
          else if (hPrecipAmt >= pt2.heavy) hPrecipColor = "rgba(255,100,40,.9)";
          else if (hPrecipAmt >= pt2.moderate) hPrecipColor = "rgba(255,160,40,.85)";
          else if (hPrecipAmt >= pt2.light) hPrecipColor = "rgba(255,210,50,.8)";
          else if (hPrecipAmt >= pt2.drizzle) hPrecipColor = "rgba(100,210,120,.8)";
          else hPrecipColor = "rgba(80,190,100,.7)";
        } else if (hPrecipAmt > 0){
          hPrecipStr = 'MIN';
        }
        
        weatherHtml += '<div class="' + hourClass + '">' +
          '<span class="today-tl-weather-time">' + timeLabel + '</span>' +
          '<span class="today-tl-weather-icon ' + weatherInfo.animClass + '">' + weatherInfo.emoji + '</span>' +
          '<span class="today-tl-weather-temp">' + temp + '</span>' +
          '<span style="font-size:1rem;font-weight:400;color:' + feelsColor + ';">' + feelsLike + '</span>' +
          '<span style="font-size:.55rem;font-weight:600;color:' + windColor + ';display:block;text-align:center;width:100%;text-transform:uppercase;letter-spacing:.3px;">' + windStr + '</span>' +
          '<span style="font-size:.5rem;font-weight:600;color:' + windDirColor + ';display:block;text-align:center;width:100%;letter-spacing:.3px;">' + windDirStr + '</span>' +
          '<span class="today-tl-weather-precip ' + precipClass + '">' + precip + '%</span>' +
          (hPrecipStr ? '<span style="font-size:.6rem;font-weight:800;color:' + hPrecipColor + ';display:block;text-align:center;width:100%;letter-spacing:.03em;text-shadow:0 0 8px ' + hPrecipColor + ',0 0 16px ' + hPrecipColor + ';">' + hPrecipStr + '</span>' : '') +
        '</div>';
      }
      
      tlWeatherRow.innerHTML = weatherHtml;

      //  FRONTAL PASSAGE MARKERS 
      // Scan hourly wind direction, pressure, temp for frontal signatures
      // and inject visual markers between the corresponding hour columns
      (function(){
        if (!hourly.wind_direction_10m || !hourly.pressure_msl || !hourly.temperature_2m) return;
        var hourCols = tlWeatherRow.querySelectorAll('.today-tl-weather-hour');
        if (!hourCols || hourCols.length < 3) return;

        // Walk through today's hours looking for frontal signatures
        var todayStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0);
        var todayEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59);

        for (var fi = 3; fi < hourly.time.length; fi++) {
          var fdt = new Date(hourly.time[fi]);
          if (fdt < todayStart || fdt > todayEnd) continue;

          var wd0 = hourly.wind_direction_10m[fi - 3];
          var wd1 = hourly.wind_direction_10m[fi];
          var p0 = hourly.pressure_msl[fi - 3];
          var p1 = hourly.pressure_msl[fi];
          var t0 = hourly.temperature_2m[fi - 3];
          var t1 = hourly.temperature_2m[fi];
          if ([wd0,wd1,p0,p1,t0,t1].some(function(v){ return typeof v !== 'number'; })) continue;

          var wdShift = wd1 - wd0;
          if (wdShift > 180) wdShift -= 360;
          if (wdShift < -180) wdShift += 360;
          var pChg = p1 - p0;
          var tChg = t1 - t0;

          var frontType = null;
          var frontLabel = '';
          var frontColor = '';
          var frontIcon = '';

          // Cold front: wind veers >30, pressure rising after drop, temp drops >3F
          if (wdShift > 30 && pChg > 0.5 && tChg < -3) {
            frontType = 'cold';
            frontLabel = 'COLD FRONT';
            frontColor = '#4af';
            frontIcon = '';
          }
          // Warm front: temp rises >3, pressure change small or falling
          else if (tChg > 3 && Math.abs(pChg) < 1.5 && wdShift > -20) {
            frontType = 'warm';
            frontLabel = 'WARM FRONT';
            frontColor = '#f44';
            frontIcon = '';
          }
          // Dryline: dewpoint shift >10F in 3 hours
          else if (hourly.dewpoint_2m) {
            var td0 = hourly.dewpoint_2m[fi - 3];
            var td1 = hourly.dewpoint_2m[fi];
            if (typeof td0 === 'number' && typeof td1 === 'number' && Math.abs(td1 - td0) > 10 && Math.abs(tChg) < 3) {
              frontType = 'dryline';
              frontLabel = 'DRYLINE';
              frontColor = '#f90';
              frontIcon = '';
            }
          }

          if (!frontType) continue;

          // Find which column this hour corresponds to
          var fHour = fdt.getHours();
          var colIdx = isMobile ? Math.round(fHour / hStep) : fHour;
          if (colIdx < 0 || colIdx >= hourCols.length) continue;

          // Check we haven't already added a marker near this column
          var existing = hourCols[colIdx].querySelector('.frontal-marker');
          if (existing) continue;

          // Create the frontal marker element
          var marker = document.createElement('div');
          marker.className = 'frontal-marker';
          marker.style.cssText = 'position:absolute;top:0;left:50%;transform:translateX(-50%);width:2px;height:100%;z-index:5;pointer-events:none;';

          // Vertical dashed line
          var line = document.createElement('div');
          line.style.cssText = 'position:absolute;top:0;left:0;width:2px;height:100%;' +
            (frontType === 'cold' ? 'background:repeating-linear-gradient(180deg,' + frontColor + ' 0px,' + frontColor + ' 4px,transparent 4px,transparent 8px);' :
             frontType === 'warm' ? 'background:repeating-linear-gradient(180deg,' + frontColor + ' 0px,' + frontColor + ' 3px,transparent 3px,transparent 6px);' :
             'background:repeating-linear-gradient(180deg,' + frontColor + ' 0px,' + frontColor + ' 2px,transparent 2px,transparent 5px);') +
            'opacity:0.7;';
          marker.appendChild(line);

          // Label badge at top
          var badge = document.createElement('div');
          badge.style.cssText = 'position:absolute;top:-2px;left:50%;transform:translateX(-50%);' +
            'background:' + frontColor + ';color:#000;font-size:5px;font-weight:800;' +
            'padding:1px 3px;border-radius:2px;white-space:nowrap;letter-spacing:.3px;' +
            'box-shadow:0 0 6px ' + frontColor + '66;z-index:6;';
          badge.textContent = frontIcon + ' ' + frontLabel;
          marker.appendChild(badge);

          // Make the hour column position:relative so the absolute marker works
          hourCols[colIdx].style.position = 'relative';
          hourCols[colIdx].style.overflow = 'visible';
          hourCols[colIdx].appendChild(marker);
        }
      })();
    }

    // Position NOW marker
    if (tlNowMarker){
      var now = new Date();
      var nowPct = pctForTime(now);
      
      if (nowPct >= 0 && nowPct <= 100){
        tlNowMarker.style.left = nowPct + "%";
        tlNowMarker.style.display = "block";
        
        // Update NOW temp and time
        if (tlNowTemp && hourly && hourly.temperature_2m){
          var nowTemp = Math.round(hourly.temperature_2m[nearestIndex]);
          tlNowTemp.textContent = nowTemp + "";
        }
        if (tlNowTime){
          tlNowTime.textContent = fmt12NoSuffixFromDate(now);
        }
      } else {
        tlNowMarker.style.display = "none";
      }
    }

    // Update planet directions in legend
    if (window.planetDirections){
      var dirIds = ['moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune'];
      var dirNames = ['Moon', 'Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn', 'Uranus', 'Neptune'];
      for (var di = 0; di < dirIds.length; di++){
        var dirEl = document.getElementById('legend-dir-' + dirIds[di]);
        if (dirEl && window.planetDirections[dirNames[di]]){
          dirEl.textContent = window.planetDirections[dirNames[di]];
        }
      }
    }

    // Update moon image in legend (same logic as large moon)
    var legendMoonEl = document.getElementById("today-tl-legend-moon");
    if (legendMoonEl){
      var legendPhaseFrac = approximateMoonPhase(new Date());
      var legendMi = moonInfo(legendPhaseFrac);
      var legendNewMoonFrame = 946;
      var legendLunarCycleFrames = 709;
      var legendFrameOffset = Math.round(legendPhaseFrac * legendLunarCycleFrames);
      var legendFrame = legendNewMoonFrame + legendFrameOffset;
      if (legendFrame > 8760) legendFrame -= 8760;
      var legendFrameStr = String(legendFrame).padStart(4, '0');
      var legendMoonUrl = "https://svs.gsfc.nasa.gov/vis/a000000/a005100/a005187/frames/730x730_1x1_30p/moon." + legendFrameStr + ".jpg";
      
      legendMoonEl.style.background = "url('" + legendMoonUrl + "') center/cover";
      legendMoonEl.style.boxShadow = "inset -1px -1px 3px rgba(0,0,0,.15)";
    }
  }

  /* =========================================================
     TIMELINE RENDER (Combined sun events + hourly weather)
     ========================================================= */
  function renderTimeline(hourly, daily, nearestIndex){
    var tlSunrise = document.getElementById("tl-sunrise");
    var tlSunset = document.getElementById("tl-sunset");
    var tlGolden = document.getElementById("tl-golden");
    var tlBands = document.getElementById("tl-bands");
    var tlHours = document.getElementById("tl-hours");
    var tlEvents = document.getElementById("tl-events");
    var tlNow = document.getElementById("tl-now");
    var tlNowTemp = document.getElementById("tl-now-temp");
    var tlEventLabels = document.getElementById("tl-event-labels");

    if (!tlHours || !daily || !daily.sunrise || !daily.sunset) return;

    var srIso = daily.sunrise[0];
    var ssIso = daily.sunset[0];
    var srDate = new Date(srIso);
    var ssDate = new Date(ssIso);

    // Detect mobile
    var isMobile = window.innerWidth <= 768;

    // Calculate solar events (must be before golden hour calculations)
    var dayLocal = new Date(srDate.getFullYear(), srDate.getMonth(), srDate.getDate(), 12, 0, 0, 0);

    // Update header
    if (tlSunrise) tlSunrise.textContent = fmt12NoSuffix(srIso);
    if (tlSunset) tlSunset.textContent = fmt12NoSuffix(ssIso);
    
    var tlGoldenAm = document.getElementById("tl-golden-am");
    var tlGoldenPm = document.getElementById("tl-golden-pm");
    
    var goldenAmStartTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var goldenAmEndTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, true);
    var goldenPmStartTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, false);
    var goldenPmEndTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    
    if (tlGoldenAm) {
      if (goldenAmStartTime && goldenAmEndTime) {
        tlGoldenAm.textContent = fmt12NoSuffixFromDate(goldenAmStartTime) + "  " + fmt12NoSuffixFromDate(goldenAmEndTime);
      } else {
        tlGoldenAm.textContent = "--";
      }
    }
    if (tlGoldenPm) {
      if (goldenPmStartTime && goldenPmEndTime) {
        tlGoldenPm.textContent = fmt12NoSuffixFromDate(goldenPmStartTime) + "  " + fmt12NoSuffixFromDate(goldenPmEndTime);
      } else {
        tlGoldenPm.textContent = "--";
      }
    }

    // Calculate daylight length
    var tlDaylight = document.getElementById("tl-daylight");
    var tlDaylightChange = document.getElementById("tl-daylight-change");
    
    var daylightMs = ssDate.getTime() - srDate.getTime();
    var daylightHours = Math.floor(daylightMs / (1000 * 60 * 60));
    var daylightMins = Math.floor((daylightMs % (1000 * 60 * 60)) / (1000 * 60));
    
    if (tlDaylight) tlDaylight.textContent = daylightHours + "h " + daylightMins + "m";
    
    // Calculate yesterday's daylight for comparison
    if (tlDaylightChange){
      var yesterdayLocal = new Date(dayLocal.getTime() - 86400000);
      var srYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, true);
      var ssYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, false);
      
      if (srYesterday && ssYesterday){
        var yesterdayMs = ssYesterday.getTime() - srYesterday.getTime();
        var diffMs = daylightMs - yesterdayMs;
        var diffSecs = Math.round(diffMs / 1000);
        var diffMins = Math.floor(Math.abs(diffSecs) / 60);
        var remainSecs = Math.abs(diffSecs) % 60;
        
        var sign = diffSecs >= 0 ? "+" : "-";
        var timeStr;
        if (diffMins > 0){
          timeStr = sign + diffMins + "m " + remainSecs + "s";
        } else {
          timeStr = sign + remainSecs + "s";
        }
        
        if (diffSecs > 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(80,180,80,1)";
        } else if (diffSecs < 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(200,100,80,1)";
        } else {
          tlDaylightChange.textContent = "(+0s)";
          tlDaylightChange.style.color = "rgba(43,34,244,.60)";
        }
      }
    }
    
    var astroDawn = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, true);
    var astroDusk = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, false);
    var blueAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, true);
    var blueAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var bluePmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var bluePmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, false);
    var goldenAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var goldenAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, true);
    var goldenPmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, false);
    var goldenPmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var noon = solarNoonLocal(dayLocal, LOCATION.lat, LOCATION.lon);

    // Timeline range: full 24 hours on desktop, golden hour to golden hour on mobile
    var todayStart, todayEnd;
    
    // Always use full 24 hours  hourStep handles density
    todayStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0, 0);
    todayEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59, 999);
    
    var timelineStart = todayStart.getTime();
    var timelineEnd = todayEnd.getTime();
    var timelineSpan = timelineEnd - timelineStart;

    function pctForTime(d){
      if (!d || !d.getTime) return -1;
      var t = d.getTime();
      if (t < timelineStart || t > timelineEnd) return -1;
      return ((t - timelineStart) / timelineSpan) * 100;
    }

    // Render bands  continuous gradient matching today timeline
    if (tlBands){
      var srPctTl = pctForTime(srDate);
      var ssPctTl = pctForTime(ssDate);
      if (srPctTl < 0) srPctTl = 25;
      if (ssPctTl < 0) ssPctTl = 75;
      
      // Seasonal + humidity factors (same logic as today timeline)
      var termsTl = _solarTerms(dayLocal);
      var latRadTl = rad(LOCATION.lat);
      var noonAltRadTl = Math.asin(Math.sin(latRadTl) * Math.sin(termsTl.decl) + Math.cos(latRadTl) * Math.cos(termsTl.decl));
      var noonAltDegTl = deg(noonAltRadTl);
      var seasonalTl = clamp((noonAltDegTl - 15) / (70 - 15), 0.55, 1.0);
      
      var avgHumTl = 50;
      if (hourly && hourly.relativehumidity_2m){
        var hS = 0, hC = 0;
        for (var hhi = 0; hhi < hourly.time.length; hhi++){
          var hdt = new Date(hourly.time[hhi]);
          if (hdt >= srDate && hdt <= ssDate && typeof hourly.relativehumidity_2m[hhi] === "number"){
            hS += hourly.relativehumidity_2m[hhi]; hC++;
          }
        }
        if (hC > 0) avgHumTl = hS / hC;
      }
      var humTl = clamp(1.0 - (avgHumTl - 40) / (85 - 40) * 0.3, 0.7, 1.0);
      var skyClarityTl = seasonalTl * humTl;
      
      var mbOp = (0.38 + 0.24 * skyClarityTl).toFixed(2);
      var mbEOp = (0.32 + 0.20 * skyClarityTl).toFixed(2);
      var deOp = (0.30 + 0.15 * skyClarityTl).toFixed(2);
      var mbR = Math.round(65 + (1 - skyClarityTl) * 60);
      var mbG = Math.round(140 + (1 - skyClarityTl) * 40);
      var mbB = Math.round(230 + (1 - skyClarityTl) * 15);
      
      // Spreads
      var s = srPctTl, e = ssPctTl;
      var aAS = Math.max(0, s - 13), aNS = Math.max(0, s - 9), aBS = Math.max(0, s - 6), aGS = Math.max(0, s - 3.5);
      var aGE = s + 5.5, aDE = s + 9;
      var pDE = Math.min(100, e - 7.5), pGS = Math.min(100, e - 4);
      var pGE = Math.min(100, e + 6), pBE = Math.min(100, e + 9), pNE = Math.min(100, e + 12.5), pAE = Math.min(100, e + 17);
      var mid = (aDE + pDE) / 2;
      
      var gStr = "linear-gradient(90deg, " +
        "rgba(15,20,45,.92) 0%, rgba(15,20,45,.92) " + Math.max(0, aAS - 2).toFixed(1) + "%, " +
        "rgba(20,28,60,.88) " + aAS.toFixed(1) + "%, rgba(28,38,80,.80) " + aNS.toFixed(1) + "%, " +
        "rgba(42,55,115,.65) " + ((aNS + aBS) / 2).toFixed(1) + "%, rgba(55,70,140,.55) " + aBS.toFixed(1) + "%, " +
        "rgba(70,95,170,.48) " + aGS.toFixed(1) + "%, " +
        "rgba(160,120,75,.45) " + (s - 2.5).toFixed(1) + "%, rgba(220,155,70,.52) " + (s - 1.2).toFixed(1) + "%, " +
        "rgba(255,145,55,.62) " + s.toFixed(1) + "%, " +
        "rgba(255,185,95,.42) " + (s + 2).toFixed(1) + "%, rgba(240,210,160,.35) " + (s + 3.5).toFixed(1) + "%, " +
        "rgba(210,220,240,.35) " + aGE.toFixed(1) + "%, " +
        "rgba(170,205,248," + deOp + ") " + aDE.toFixed(1) + "%, " +
        "rgba(" + (mbR + 35) + "," + (mbG + 30) + "," + mbB + "," + mbEOp + ") " + (mid - 8).toFixed(1) + "%, " +
        "rgba(" + mbR + "," + mbG + "," + mbB + "," + mbOp + ") " + (mid - 3).toFixed(1) + "%, " +
        "rgba(" + mbR + "," + mbG + "," + mbB + "," + mbOp + ") " + (mid + 3).toFixed(1) + "%, " +
        "rgba(" + (mbR + 35) + "," + (mbG + 30) + "," + mbB + "," + mbEOp + ") " + (mid + 8).toFixed(1) + "%, " +
        "rgba(170,205,248," + deOp + ") " + pDE.toFixed(1) + "%, " +
        "rgba(210,220,240,.35) " + pGS.toFixed(1) + "%, " +
        "rgba(240,200,140,.38) " + (e - 3.5).toFixed(1) + "%, rgba(255,180,80,.45) " + (e - 2).toFixed(1) + "%, " +
        "rgba(255,150,50,.58) " + (e - 0.8).toFixed(1) + "%, rgba(240,105,30,.68) " + e.toFixed(1) + "%, " +
        "rgba(220,85,25,.64) " + (e + 1.5).toFixed(1) + "%, rgba(190,65,30,.58) " + (e + 3).toFixed(1) + "%, " +
        "rgba(140,50,40,.52) " + (e + 4.5).toFixed(1) + "%, rgba(100,45,50,.48) " + pGE.toFixed(1) + "%, " +
        "rgba(60,45,80,.55) " + ((pGE + pBE) / 2).toFixed(1) + "%, rgba(50,50,100,.60) " + pBE.toFixed(1) + "%, " +
        "rgba(38,42,85,.72) " + pNE.toFixed(1) + "%, rgba(25,32,65,.82) " + pAE.toFixed(1) + "%, " +
        "rgba(15,20,45,.92) " + Math.min(100, pAE + 3).toFixed(1) + "%, rgba(15,20,45,.92) 100%)";
      
      tlBands.innerHTML = '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:' + gStr + ';"></div>';
    }

    // Render hourly weather
    if (tlHours && hourly && hourly.time){
      var hoursHtml = "";
      
      // Find hours within timeline range
      var startHour = todayStart.getHours();
      var endHour = todayEnd.getHours();
      
      // Show every 3 hours for cleaner display
      var hourStep = 3;
      console.log('[TL] hourStep=' + hourStep + ', startHour=' + startHour + ', endHour=' + endHour + ', items=' + Math.floor((endHour - startHour) / hourStep + 1));
      
      for (var h = startHour; h <= endHour; h += hourStep){
        var targetHour = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h, 0, 0, 0);
        
        // Find matching index in hourly data
        var matchIdx = -1;
        for (var i = 0; i < hourly.time.length; i++){
          var dt = new Date(hourly.time[i]);
          if (dt.getFullYear() === targetHour.getFullYear() &&
              dt.getMonth() === targetHour.getMonth() &&
              dt.getDate() === targetHour.getDate() &&
              dt.getHours() === targetHour.getHours()){
            matchIdx = i;
            break;
          }
        }
        
        var timeLabel = h === 0 ? "12AM" : (h < 12 ? h + "AM" : (h === 12 ? "12PM" : (h - 12) + "PM"));
        var temp = "--";
        var precip = 0;
        var precipAmt = 0;
        var snowAmt = 0;
        var rainAmt = 0;
        var wcode = 0;
        var icon = "";
        
        // Determine if this hour is during night/twilight
        var isNight = (targetHour < srDate || targetHour > ssDate);
        var isDeepNight = (astroDawn && targetHour < astroDawn) || (astroDusk && targetHour > astroDusk);
        var isTwilight = isNight && !isDeepNight;
        
        if (matchIdx >= 0){
          temp = Math.round(hourly.temperature_2m[matchIdx]) + "";
          precip = hourly.precipitation_probability[matchIdx] || 0;
          precipAmt = hourly.precipitation ? (hourly.precipitation[matchIdx] || 0) : 0;
          snowAmt = hourly.snowfall ? (hourly.snowfall[matchIdx] || 0) : 0;
          rainAmt = hourly.rain ? (hourly.rain[matchIdx] || 0) : 0;
          wcode = hourly.weathercode ? (hourly.weathercode[matchIdx] || 0) : 0;
          
          // Determine icon based on weather code for precise precip type
          var cc = hourly.cloudcover ? hourly.cloudcover[matchIdx] : 0;
          var isThunder = (wcode === 95 || wcode === 96 || wcode === 99);
          var isFreezingRain = (wcode === 66 || wcode === 67);
          var isSleet = (wcode === 68 || wcode === 69 || wcode === 83 || wcode === 84 || wcode === 85 || wcode === 86);
          var isSnow = (wcode >= 70 && wcode <= 77) || wcode === 85 || wcode === 86 || snowAmt > 0.1;
          var isRain = (wcode >= 51 && wcode <= 65) || (wcode >= 80 && wcode <= 82) || rainAmt > 0;
          
          if (isThunder){
            icon = METEO_BASE + "thunderstorms-rain.svg";
          } else if (isFreezingRain){
            icon = METEO_BASE + "sleet.svg";
          } else if (isSnow && rainAmt > 0){
            icon = METEO_BASE + "sleet.svg";
          } else if (isSnow){
            icon = METEO_BASE + "snow.svg";
          } else if (isSleet){
            icon = METEO_BASE + "sleet.svg";
          } else if (precipAmt > 0 || precip >= 60){
            icon = METEO_BASE + "rain.svg";
          } else if (precip >= 30){
            icon = METEO_BASE + "drizzle.svg";
          } else if (cc >= 70){
            icon = METEO_BASE + "overcast.svg";
          } else if (cc >= 30){
            icon = isNight ? METEO_BASE + "partly-cloudy-night.svg" : METEO_BASE + "partly-cloudy-day.svg";
          } else if (isDeepNight || isTwilight){
            icon = METEO_BASE + "clear-night.svg";
          } else {
            icon = METEO_BASE + "clear-day.svg";
          }
        }
        
        var precipClass = "low";
        if (precip >= 60) precipClass = "high";
        else if (precip >= 30) precipClass = "med";
        
        // Format precip amount string (API already returns inches with precipitation_unit=inch)
        // Climate-aware intensity thresholds based on region
        // Arid/semi-arid areas flash flood at lower rates than tropical areas
        if (!window._precipThresholds) {
          var lat = LOCATION.lat, lon = LOCATION.lon;
          // Classify climate zone by location
          // Arid West: low thresholds (desert flash flood risk)
          // Gulf/Southeast: high thresholds (used to heavy rain)
          // Pacific NW: moderate-low (persistent light rain, heavy is rare)
          // Northeast/Midwest: moderate
          // Tropical (Hawaii, PR, Guam): highest thresholds
          var t = { drizzle:0.03, light:0.08, moderate:0.15, heavy:0.30, extreme:0.50 };
          
          if (lat > 19 && lat < 22 && lon > -161 && lon < -154) {
            // Hawaii  tropical, used to heavy bursts
            t = { drizzle:0.05, light:0.15, moderate:0.30, heavy:0.60, extreme:1.00 };
          } else if (lat > 17 && lat < 19 && lon > -68 && lon < -65) {
            // Puerto Rico  tropical
            t = { drizzle:0.05, light:0.15, moderate:0.30, heavy:0.60, extreme:1.00 };
          } else if (lat > 12 && lat < 15 && lon > 144 && lon < 146) {
            // Guam  tropical
            t = { drizzle:0.05, light:0.15, moderate:0.30, heavy:0.60, extreme:1.00 };
          } else if (lat < 35 && lon > -105 && lon < -80) {
            // Gulf Coast / Deep South  subtropical, heavy rain common
            t = { drizzle:0.04, light:0.12, moderate:0.25, heavy:0.50, extreme:0.80 };
          } else if (lat > 25 && lat < 35 && lon > -125 && lon < -105) {
            // Desert Southwest (AZ, NM, SoCal inland, W TX)  flash flood at low rates
            t = { drizzle:0.02, light:0.05, moderate:0.10, heavy:0.20, extreme:0.35 };
          } else if (lat > 35 && lat < 49 && lon > -125 && lon < -118) {
            // Pacific NW  persistent drizzle, heavy rare
            t = { drizzle:0.02, light:0.06, moderate:0.12, heavy:0.25, extreme:0.40 };
          } else if (lat > 32 && lat < 42 && lon > -122 && lon < -115) {
            // CA/NV  Mediterranean/arid, atmospheric rivers hit hard
            t = { drizzle:0.02, light:0.06, moderate:0.12, heavy:0.25, extreme:0.40 };
          } else if (lat > 35 && lat < 49 && lon > -105 && lon < -80) {
            // Midwest/Plains  moderate, but severe storms bring heavy
            t = { drizzle:0.03, light:0.08, moderate:0.18, heavy:0.35, extreme:0.55 };
          } else {
            // Northeast / default  moderate
            t = { drizzle:0.03, light:0.08, moderate:0.15, heavy:0.30, extreme:0.50 };
          }
          window._precipThresholds = t;
        }
        var pt = window._precipThresholds;
        
        var precipAmtStr = "";
        var precipAmtColor = "rgba(80,190,100,.8)";
        if (snowAmt > 0){
          precipAmtStr = snowAmt >= 0.1 ? snowAmt.toFixed(1) + '"' : 'MIN';
          if (snowAmt >= 1.0) precipAmtColor = "rgba(255,60,60,.9)";
          else if (snowAmt >= 0.5) precipAmtColor = "rgba(255,140,50,.85)";
          else if (snowAmt >= 0.2) precipAmtColor = "rgba(255,200,50,.8)";
          else precipAmtColor = "rgba(200,220,255,.7)";
        } else if (precipAmt >= 0.01){
          precipAmtStr = precipAmt.toFixed(2) + '"';
          if (precipAmt >= pt.extreme) precipAmtColor = "rgba(255,50,50,.95)";
          else if (precipAmt >= pt.heavy) precipAmtColor = "rgba(255,100,40,.9)";
          else if (precipAmt >= pt.moderate) precipAmtColor = "rgba(255,160,40,.85)";
          else if (precipAmt >= pt.light) precipAmtColor = "rgba(255,210,50,.8)";
          else if (precipAmt >= pt.drizzle) precipAmtColor = "rgba(100,210,120,.8)";
          else precipAmtColor = "rgba(80,190,100,.7)";
        } else if (precipAmt > 0){
          precipAmtStr = 'MIN';
        }
        
        // Add night-hour class for dark background styling
        var hourClass = "tl-hour";
        if (isDeepNight || isTwilight) hourClass += " night-hour";
        
        hoursHtml += '<div class="' + hourClass + '">' +
          '<span class="tl-hour-time">' + timeLabel + '</span>' +
          '<div style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><img class="tl-hour-icon" src="' + icon + '" alt="" /></div>' +
          '<span class="tl-hour-temp">' + temp + '</span>' +
          (precip > 0 ? '<span class="tl-hour-precip ' + precipClass + '">' + precip + '%</span>' : '') +
          (precipAmtStr ? '<span style="font-size:.45rem;font-weight:700;color:rgba(80,190,100,.8);letter-spacing:.02em;">' + precipAmtStr + '</span>' : '') +
        '</div>';;
      }
      
      tlHours.innerHTML = hoursHtml;
    }

    // Render sun event ticks
    if (tlEvents){
      var eventsHtml = "";
      
      var events = [
        { time: astroDawn, cls: "astro" },
        { time: blueAmStart, cls: "blue" },
        { time: srDate, cls: "sunrise" },
        { time: goldenAmEnd, cls: "golden" },
        { time: noon, cls: "noon" },
        { time: goldenPmStart, cls: "golden" },
        { time: ssDate, cls: "sunset" },
        { time: bluePmEnd, cls: "blue" },
        { time: astroDusk, cls: "astro" }
      ];
      
      for (var e = 0; e < events.length; e++){
        var ev = events[e];
        var p = pctForTime(ev.time);
        if (p >= 0 && p <= 100){
          eventsHtml += '<div class="tl-event-tick ' + ev.cls + '" style="left:' + p + '%"></div>';
        }
      }
      
      tlEvents.innerHTML = eventsHtml;
    }

    // Render event labels with hill pattern
    if (tlEventLabels){
      var labelsHtml = "";
      
      // Labels with assigned levels (1=lowest, 5=highest like a hill)
      var labels = [
        { time: astroDawn, text: "AST DAWN", cls: "astro", level: 1 },
        { time: blueAmStart, text: "BLUE", cls: "blue", level: 2 },
        { time: srDate, text: "SUNRISE", cls: "sunrise", level: 3 },
        { time: goldenAmEnd, text: "GOLDEN", cls: "golden", level: 4 },
        { time: noon, text: "NOON", cls: "noon", level: 5 },
        { time: goldenPmStart, text: "GOLDEN", cls: "golden", level: 4 },
        { time: ssDate, text: "SUNSET", cls: "sunset", level: 3 },
        { time: bluePmEnd, text: "BLUE", cls: "blue", level: 2 },
        { time: astroDusk, text: "AST DARK", cls: "astro", level: 1 }
      ];
      
      for (var j = 0; j < labels.length; j++){
        var lb = labels[j];
        var p = pctForTime(lb.time);
        if (p >= 0 && p <= 100){
          labelsHtml += '<span class="tl-event-label ' + lb.cls + ' level-' + lb.level + '" style="left:' + p + '%">' + lb.text + '</span>';
        }
      }
      
      tlEventLabels.innerHTML = labelsHtml;
    }

    // Position NOW marker
    if (tlNow){
      var now = new Date();
      var nowPct = pctForTime(now);
      
      if (nowPct >= 0 && nowPct <= 100){
        tlNow.style.left = nowPct + "%";
        tlNow.style.display = "block";
        
        // Update NOW temp
        if (tlNowTemp && hourly && hourly.temperature_2m){
          var nowTemp = Math.round(hourly.temperature_2m[nearestIndex]);
          tlNowTemp.textContent = nowTemp + "";
        }
      } else {
        tlNow.style.display = "none";
      }
    }
  }
/* =========================================================
     AIR QUALITY & POLLEN (Open-Meteo)
     ========================================================= */
  function classifyAqi(aqi){
    if (aqi == null || isNaN(aqi)) return { label: "--", cls: "" };
    if (aqi <= 50) return { label: "Good (" + Math.round(aqi) + ")", cls: "good" };
    if (aqi <= 100) return { label: "Moderate (" + Math.round(aqi) + ")", cls: "moderate" };
    if (aqi <= 150) return { label: "Sensitive (" + Math.round(aqi) + ")", cls: "unhealthy-sensitive" };
    if (aqi <= 200) return { label: "Unhealthy (" + Math.round(aqi) + ")", cls: "unhealthy" };
    if (aqi <= 300) return { label: "Very Unhealthy (" + Math.round(aqi) + ")", cls: "very-unhealthy" };
    return { label: "Hazardous (" + Math.round(aqi) + ")", cls: "hazardous" };
  }

  function classifyPollen(val){
    if (val == null || isNaN(val) || val <= 0) return { label: "None", cls: "none" };
    if (val <= 20) return { label: "Low", cls: "low" };
    if (val <= 80) return { label: "Moderate", cls: "moderate" };
    if (val <= 200) return { label: "High", cls: "high" };
    return { label: "Very High", cls: "very-high" };
  }

  function loadAirQuality(){
    var aqiEl = document.getElementById("aqi-val");
    var pm25El = document.getElementById("pm25-val");
    var pm10El = document.getElementById("pm10-val");
    var pollenTreeEl = document.getElementById("pollen-tree");
    var pollenGrassEl = document.getElementById("pollen-grass");
    var pollenWeedEl = document.getElementById("pollen-weed");
    var pollenRagweedEl = document.getElementById("pollen-ragweed");

    var url = 
      "https://air-quality-api.open-meteo.com/v1/air-quality" +
      "?latitude=" + LOCATION.lat +
      "&longitude=" + LOCATION.lon +
      "&current=us_aqi,us_aqi_pm2_5,us_aqi_pm10,us_aqi_nitrogen_dioxide,us_aqi_ozone,us_aqi_sulphur_dioxide,us_aqi_carbon_monoxide,pm10,pm2_5,carbon_monoxide,nitrogen_dioxide,sulphur_dioxide,ozone" +
      "&current=alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen" +
      "&hourly=us_aqi,pm2_5,pm10,ozone,nitrogen_dioxide,sulphur_dioxide,carbon_monoxide" +
      "&forecast_hours=24";

    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try{
          var current = data && data.current;
          if (!current) return;

          // Store full AQ data for detail modal
          window._aqData = { current: current, hourly: data.hourly, time: data.current_units };

          // AQI
          if (aqiEl){
            var aqiInfo = classifyAqi(current.us_aqi);
            aqiEl.textContent = aqiInfo.label;
            aqiEl.className = "ap-val " + aqiInfo.cls;
            aqiEl.style.cursor = "pointer";
            aqiEl.onclick = function(){ openAqiDetail(); };
          }

          // PM2.5
          var pm25 = current.pm2_5 || 0;
          if (pm25El){
            pm25El.textContent = (pm25 != null ? Math.round(pm25) + " g/m" : "--");
          }

          // PM10
          if (pm10El){
            var pm10 = current.pm10;
            pm10El.textContent = (pm10 != null ? Math.round(pm10) + " g/m" : "--");
          }

          // Tree pollen (combine alder + birch)
          if (pollenTreeEl){
            var treePollen = Math.max(current.alder_pollen || 0, current.birch_pollen || 0);
            var treeInfo = classifyPollen(treePollen);
            pollenTreeEl.textContent = treeInfo.label;
            pollenTreeEl.className = "pollen-val " + treeInfo.cls;
          }

          // Grass pollen
          if (pollenGrassEl){
            var grassInfo = classifyPollen(current.grass_pollen);
            pollenGrassEl.textContent = grassInfo.label;
            pollenGrassEl.className = "pollen-val " + grassInfo.cls;
          }

          // Weed pollen (mugwort + olive)
          if (pollenWeedEl){
            var weedPollen = Math.max(current.mugwort_pollen || 0, current.olive_pollen || 0);
            var weedInfo = classifyPollen(weedPollen);
            pollenWeedEl.textContent = weedInfo.label;
            pollenWeedEl.className = "pollen-val " + weedInfo.cls;
          }

          // Ragweed
          if (pollenRagweedEl){
            var ragweedInfo = classifyPollen(current.ragweed_pollen);
            pollenRagweedEl.textContent = ragweedInfo.label;
            pollenRagweedEl.className = "pollen-val " + ragweedInfo.cls;
          }

        } catch(e){
          console.error("Air quality parse error", e);
        }
      })
      .catch(function(err){
        console.error("Air quality load error", err);
      });
  }
  function openAqiDetail(){
    var d=window._aqData;if(!d||!d.current)return;
    var c=d.current,hr=d.hourly;
    function ac(v){if(v==null||isNaN(v))return"#666";if(v<=50)return"#22c55e";if(v<=100)return"#eab308";if(v<=150)return"#f97316";if(v<=200)return"#ef4444";if(v<=300)return"#9333ea";return"#7f1d1d";}
    function al(v){if(v==null||isNaN(v))return"--";if(v<=50)return"Good";if(v<=100)return"Moderate";if(v<=150)return"USG";if(v<=200)return"Unhealthy";if(v<=300)return"V.Unhealthy";return"Hazardous";}
    function hg(a){
      if(a==null)return{i:"",w:"",a:""};
      if(a<=50)return{i:"",w:"",a:"Satisfactory. Great for all outdoor activities."};
      if(a<=100)return{i:"",w:"Asthma, COPD, heart disease, children, elderly",a:"Acceptable. Sensitive individuals should limit prolonged heavy exertion."};
      if(a<=150)return{i:"",w:"Children, elderly, respiratory/cardiac conditions",a:"Sensitive groups reduce outdoor exertion. Move indoors if symptoms occur."};
      if(a<=200)return{i:"",w:"Everyone  especially sensitive groups",a:"Reduce outdoor exertion. Sensitive groups avoid outdoor activity."};
      if(a<=300)return{i:"",w:"Everyone",a:"Avoid all outdoor exertion. Close windows. Run air purifiers."};
      return{i:"",w:"Everyone",a:"Health emergency. Remain indoors. Seal windows. N95 essential."};
    }
    var windEl=document.getElementById("wind");var gustEl=document.getElementById("gusts");
    var cWind=windEl?windEl.textContent:'--';var cGust=gustEl?gustEl.textContent:'--';
    var wDir='--';
    if(window._wxHourly&&window._wxHourly.wind_direction_10m&&window._wxNearestIdx!=null){
      var wd=window._wxHourly.wind_direction_10m[window._wxNearestIdx];
      if(wd!=null)wDir=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round(wd/22.5)%16];
    }
    var subs=[
      {n:'PM2.5',v:c.pm2_5,u:'g/m',a:c.us_aqi_pm2_5,k:'pm2_5',who:5,d:'Ultrafine  smoke, exhaust  lungs & blood'},
      {n:'PM10',v:c.pm10,u:'g/m',a:c.us_aqi_pm10,k:'pm10',who:15,d:'Coarse  dust, pollen  airways'},
      {n:'O',v:c.ozone,u:'g/m',a:c.us_aqi_ozone,k:'ozone',who:100,d:'Gas  smog  inflames lungs'},
      {n:'NO',v:c.nitrogen_dioxide,u:'g/m',a:c.us_aqi_nitrogen_dioxide,k:'nitrogen_dioxide',who:25,d:'Gas  diesel  damages airways'},
      {n:'SO',v:c.sulphur_dioxide,u:'g/m',a:c.us_aqi_sulphur_dioxide,k:'sulphur_dioxide',who:40,d:'Gas  coal  constricts airways'},
      {n:'CO',v:c.carbon_monoxide,u:'g/m',a:c.us_aqi_carbon_monoxide,k:'carbon_monoxide',who:4000,d:'Gas  engines  starves O'}
    ];
    var dom=subs.reduce(function(a,b){return(b.a||0)>(a.a||0)?b:a;});
    var ov=c.us_aqi!=null?Math.round(c.us_aqi):'--';
    var oc=ac(c.us_aqi),ol=al(c.us_aqi),g=hg(c.us_aqi);
    var pm25=c.pm2_5||0;

    var h='';
    // === TOP: Hero + Health + Trend + Smoke + Wind  all in one grid ===
    h+='<div style="display:grid;grid-template-columns:90px 1fr 100px;gap:8px;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.06);">';
    // Col 1: AQI number
    h+='<div style="text-align:center;display:flex;flex-direction:column;justify-content:center;">';
    h+='<div style="font-size:2.8rem;font-weight:900;color:'+oc+';line-height:1;">'+ov+'</div>';
    h+='<div style="font-size:.8rem;font-weight:800;color:'+oc+';">'+ol+'</div>';
    h+='<div style="font-size:.48rem;color:#888;margin-top:2px;font-weight:700;">'+dom.n+' dominant</div>';
    h+='</div>';
    // Col 2: Health + Trend stacked
    h+='<div>';
    h+='<div style="font-size:.68rem;color:#ddd;line-height:1.35;margin-top:8px;margin-bottom:3px;">'+g.i+' '+g.a+'</div>';
    if(g.w) h+='<div style="font-size:.52rem;color:#f97316;font-weight:700;margin-top:8px;margin-bottom:3px;">At risk: <span style="font-weight:500;color:#aaa;">'+g.w+'</span></div>';
    // Trend inline
    if(hr&&hr.us_aqi&&hr.time){
      var vals=hr.us_aqi,maxV=Math.max.apply(null,vals.filter(function(v){return v!=null;}).concat([50]));
      var pts=[];for(var i=0;i<vals.length;i++){if(vals[i]==null)continue;pts.push(((i/(vals.length-1))*180)+','+(18-(vals[i]/maxV)*18));}
      if(pts.length>1){
        var fV=vals[0]||0,lV=vals[vals.length-1]||0;
        var tr=lV<fV-5?'Improving':lV>fV+5?'Worsening':'Stable';
        var tc=lV<fV-5?'#22c55e':lV>fV+5?'#ef4444':'#eab308';
        h+='<div style="display:flex;align-items:center;gap:6px;">';
        h+='<svg viewBox="0 0 180 18" style="flex:1;height:18px;" preserveAspectRatio="none">';
        h+='<polygon points="0,18 '+pts.join(' ')+' 180,18" fill="'+oc+'" opacity="0.15"/>';
        h+='<polyline points="'+pts.join(' ')+'" fill="none" stroke="'+oc+'" stroke-width="1.5"/>';
        h+='</svg>';
        h+='<span style="font-size:.48rem;font-weight:800;color:'+tc+';white-space:nowrap;">'+tr+'</span>';
        h+='</div>';
      }
    }
    h+='</div>';
    // Col 3: Wind
    h+='<div style="text-align:center;display:flex;flex-direction:column;justify-content:center;border-left:1px solid rgba(255,255,255,.06);padding-left:8px;">';
    h+='<div style="font-size:.42rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:.5px;"> WIND</div>';
    h+='<div style="font-size:.9rem;font-weight:900;color:#fff;">'+cWind+'</div>';
    h+='<div style="font-size:.5rem;color:#aaa;font-weight:700;">'+wDir+'</div>';
    h+='<div style="font-size:.48rem;color:#777;">Gusts '+cGust+'</div>';
    h+='</div></div>';

    // 
    // AQI ROOT CAUSE ANALYSIS ENGINE
    // Cross-pollinates: weather, fire, wind, pressure, PBL, season,
    // time-of-day, precip, soil moisture, traffic patterns, AQ trends
    // to build a full narrative explaining WHY the AQI is what it is
    // 
    var wx = window._wxCurrent || {};
    var fires = window._activeFires || [];
    var hourlyAq = hr || {};
    var aqiVal = c.us_aqi != null ? Math.round(c.us_aqi) : null;
    var sunAltNow = 0;
    try { var _sd = daysSinceJ2000(new Date()); var _se = sunEcliptic(_sd); var _sq = eclToEqu(_se.x, _se.y, _se.z, _sd); var _sr = raDecFromEqu(_sq); var _sa = altAz(_sr.ra, _sr.dec, new Date(), LOCATION.lat, LOCATION.lon); sunAltNow = deg(_sa.alt); } catch(e) {}

    //  Gather all causal factors 
    var factors = [];
    var narrative = [];
    var chainStages = [];

    // FACTOR 1: Boundary layer / inversion trapping
    var pblH = wx.pblHeight;
    var inversionTrapping = false;
    if (pblH != null) {
      if (pblH < 200) {
        factors.push({icon:'', name:'Severe Inversion', severity:'critical', detail:'Boundary layer extremely shallow (' + Math.round(pblH) + 'm). Pollutants trapped below ' + Math.round(pblH * 3.28) + ' ft  like a lid on a pot. All ground emissions accumulate.'});
        inversionTrapping = true;
        chainStages.push({label:'INVERSION', active:true, color:'#f44'});
      } else if (pblH < 500) {
        factors.push({icon:'', name:'Low Mixing Height', severity:'high', detail:'Boundary layer compressed to ' + Math.round(pblH) + 'm (' + Math.round(pblH * 3.28) + ' ft). Reduced vertical mixing concentrates surface pollutants.'});
        inversionTrapping = true;
        chainStages.push({label:'INVERSION', active:true, color:'#f90'});
      } else if (pblH < 1000) {
        factors.push({icon:'', name:'Moderate Mixing', severity:'low', detail:'PBL at ' + Math.round(pblH) + 'm  adequate mixing for most conditions.'});
        chainStages.push({label:'MIXING', active:false, color:'#4f8'});
      } else {
        chainStages.push({label:'DEEP MIX', active:false, color:'#4f8'});
      }
    }

    // FACTOR 2: Wind stagnation
    var windStagnant = wx.wind != null && wx.wind < 5;
    var windCalm = wx.wind != null && wx.wind < 8;
    if (windStagnant) {
      factors.push({icon:'', name:'Stagnant Air', severity:'high', detail:'Wind only ' + wx.wind + ' mph  nearly calm. No horizontal dispersion. Pollutants accumulate at the source.'});
      chainStages.push({label:'STAGNATION', active:true, color:'#f90'});
    } else if (windCalm) {
      factors.push({icon:'', name:'Light Winds', severity:'moderate', detail:'Wind ' + wx.wind + ' mph  some dispersion but limited. Local sources dominate.'});
      chainStages.push({label:'LIGHT WIND', active:true, color:'#cc0'});
    } else if (wx.wind != null && wx.wind >= 15) {
      factors.push({icon:'', name:'Wind Dispersion', severity:'helpful', detail:'Wind at ' + wx.wind + ' mph providing good dispersion. This is reducing AQI from what it would otherwise be.'});
      chainStages.push({label:'DISPERSION', active:false, color:'#4f8'});
    }

    // FACTOR 3: Pressure system analysis
    var highPressure = wx.pressure != null && wx.pressure > 1020;
    var risingPressure = wx.pressureTrend != null && wx.pressureTrend > 1.5;
    if (highPressure && (windCalm || inversionTrapping)) {
      factors.push({icon:'', name:'High Pressure Subsidence', severity:'high', detail:'Pressure ' + (wx.pressure * 0.029529983).toFixed(2) + ' inHg (high). Sinking air aloft strengthens the inversion cap, preventing vertical mixing. Classic stagnation setup.'});
    } else if (wx.pressureTrend != null && wx.pressureTrend < -2) {
      factors.push({icon:'', name:'Approaching System', severity:'helpful', detail:'Pressure falling (' + (wx.pressureTrend > 0 ? '+' : '') + wx.pressureTrend.toFixed(1) + ' hPa/3hr). Approaching weather system will increase mixing and likely improve air quality within hours.'});
    }

    // FACTOR 4: Temperature + time of day patterns
    var nowHour = new Date().getHours();
    var isRushHour = (nowHour >= 7 && nowHour <= 9) || (nowHour >= 16 && nowHour <= 19);
    var isOvernight = nowHour >= 22 || nowHour < 6;
    var isMidDay = nowHour >= 11 && nowHour <= 15;
    var isWinter = new Date().getMonth() <= 1 || new Date().getMonth() >= 10; // NovFeb
    var isSummer = new Date().getMonth() >= 5 && new Date().getMonth() <= 8;

    if (isRushHour && aqiVal > 50) {
      // Enhanced traffic analysis using NO2 hourly pattern
      var _no2Now = c.nitrogen_dioxide || 0;
      var _coNow = c.carbon_monoxide || 0;
      var _trafficSev = 'moderate';
      var _trafficDetail = (nowHour < 12 ? 'Morning' : 'Evening') + ' commute underway. ';

      // Analyze NO2 rush-vs-offpeak ratio
      if(hr && hr.nitrogen_dioxide && hr.nitrogen_dioxide.length > 12){
        var _rushNO2 = [], _offNO2 = [];
        for(var _hi=0;_hi<hr.nitrogen_dioxide.length && _hi<24;_hi++){
          if(hr.nitrogen_dioxide[_hi]==null)continue;
          if((_hi>=7 && _hi<=9)||(_hi>=16 && _hi<=19)) _rushNO2.push(hr.nitrogen_dioxide[_hi]);
          else if(_hi>=1 && _hi<=5) _offNO2.push(hr.nitrogen_dioxide[_hi]);
        }
        var _avgR = _rushNO2.length>0?_rushNO2.reduce(function(a,b){return a+b;},0)/_rushNO2.length:0;
        var _avgO = _offNO2.length>0?_offNO2.reduce(function(a,b){return a+b;},0)/_offNO2.length:1;
        var _ratio = _avgO>0?(_avgR/_avgO):1;
        var _trafPct = Math.min(95,Math.max(5,Math.round((_ratio-1)/_ratio*100)));

        if(_ratio > 2){ _trafficSev = 'high'; _trafficDetail += 'NO is '+_ratio.toFixed(1)+' higher during rush vs overnight  traffic is the dominant pollution source (~'+_trafPct+'% of NO). '; }
        else if(_ratio > 1.3){ _trafficDetail += 'NO rush/off-peak ratio of '+_ratio.toFixed(1)+' shows clear traffic influence (~'+_trafPct+'% traffic share). '; }
        else { _trafficDetail += 'NO pattern shows moderate traffic contribution. '; }
      } else {
        _trafficDetail += 'Vehicle exhaust (NO, CO, PM2.5) peaks during rush hours. ';
      }

      // Diesel vs gasoline signature
      if(_no2Now > 0 && c.pm2_5 > 0){
        var _dpRatio = _no2Now / Math.max(c.pm2_5, 1);
        if(_dpRatio > 3) _trafficDetail += 'High NO:PM2.5 ratio suggests diesel-heavy traffic (trucks, buses). ';
      }

      // Wind trapping
      if(windStagnant) _trafficDetail += 'Calm winds (' + (wx.wind||0) + ' mph) trapping emissions at street level  actual exposure near roads may be 2-5 higher than reported.';
      else if(windCalm) _trafficDetail += 'Light winds providing limited dispersion.';
      else _trafficDetail += 'Winds providing moderate dispersion.';

      factors.push({icon:'', name:'Rush Hour Traffic', severity:_trafficSev, detail:_trafficDetail});
    } else if(!isRushHour && c.nitrogen_dioxide != null && c.nitrogen_dioxide > 40 && aqiVal > 50){
      // Off-peak but elevated NO2  unusual source
      var _isWkday = new Date().getDay() >= 1 && new Date().getDay() <= 5;
      factors.push({icon:'', name:'Non-Rush Emissions', severity:'moderate', detail:'NO elevated at '+Math.round(c.nitrogen_dioxide)+' g/m outside rush hour. Likely sources: ' + (_isWkday ? 'freight/delivery operations, construction equipment, or nearby industrial activity.' : 'weekend freight operations, event-driven traffic, or persistent industrial emissions.')});
    }

    if (isWinter && aqiVal > 80) {
      factors.push({icon:'', name:'Winter Heating', severity:'moderate', detail:'February heating season  residential and commercial combustion (oil, gas, wood) adds PM2.5 and CO directly to surface air. Cold surface air strengthens inversions.'});
    }

    if (isOvernight && inversionTrapping) {
      factors.push({icon:'', name:'Nocturnal Inversion', severity:'high', detail:'Overnight radiative cooling has created a surface-based temperature inversion. Without solar heating to break it, pollutants are trapped until morning mixing begins.'});
    }

    if (isMidDay && pblH != null && pblH > 1000 && aqiVal < 80) {
      factors.push({icon:'', name:'Solar Mixing', severity:'helpful', detail:'Afternoon solar heating has deepened the boundary layer to ' + Math.round(pblH) + 'm, enhancing vertical mixing. AQI typically improves during midday heating.'});
    }

    // FACTOR 5: Moisture / fog trapping
    var foggy = wx.rh != null && wx.rh > 95;
    var humid = wx.rh != null && wx.rh > 85;
    if (foggy && aqiVal > 50) {
      factors.push({icon:'', name:'Fog Trapping', severity:'high', detail:'RH at ' + wx.rh + '%  fog/mist conditions. While moisture scavenges some particles, fog forms IN the same stagnant inversion that traps pollutants. The fog IS the inversion made visible. Particles grow hygroscopically in humid air, increasing PM readings.'});
    } else if (humid && inversionTrapping) {
      factors.push({icon:'', name:'Hygroscopic Growth', severity:'moderate', detail:'RH ' + wx.rh + '%  particles absorb moisture and swell, increasing their effective diameter and PM mass concentration. Measured PM2.5 can increase 2040% at high humidity.'});
    }

    // FACTOR 6: Precipitation washout (improving factor)
    var raining = wx.precip != null && wx.precip > 0;
    var heavyRain = wx.precip != null && wx.precip > 0.10;
    if (heavyRain) {
      factors.push({icon:'', name:'Rain Washout (Active)', severity:'helpful', detail:'Active precipitation (' + wx.precip.toFixed(2) + ' in/hr) scavenging particles from the atmosphere. AQI should improve as rain continues  "wet deposition" is nature\'s air purifier.'});
    } else if (raining) {
      factors.push({icon:'', name:'Light Rain', severity:'moderate', detail:'Light precip (' + wx.precip.toFixed(2) + ' in)  some particle washout occurring, but light rain is less effective at scrubbing PM2.5 than heavy rain. Very small particles can remain suspended.'});
    }

    // FACTOR 7: Upwind fire smoke transport
    var nearbyFireCount = 0;
    var upwindFireNames = [];
    if (fires.length > 0 && pm25 >= 12) {
      var wDirsAll16 = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      fires.forEach(function(fire) {
        var coords = fire.geometry && fire.geometry.coordinates;
        if (!coords) return;
        var fLat = coords[1], fLon = coords[0];
        var dLat = fLat - LOCATION.lat, dLon = fLon - LOCATION.lon;
        var dist = Math.sqrt(dLat * dLat + dLon * dLon) * 69;
        if (dist > 1500 || dist < 5) return;
        nearbyFireCount++;
        var angle = Math.atan2(dLon, dLat) * 180 / Math.PI;
        if (angle < 0) angle += 360;
        var fireDir16 = wDirsAll16[Math.round(angle / 22.5) % 16];
        var wIdx = wDirsAll16.indexOf(wDir);
        var fIdx = wDirsAll16.indexOf(fireDir16);
        if (wIdx >= 0) {
          var dif = Math.abs(fIdx - wIdx); if (dif > 8) dif = 16 - dif;
          if (dif <= 2) {
            var fireName = (fire.properties || {}).IncidentName || (fire.properties || {}).FireName || 'Unknown';
            upwindFireNames.push(fireName + ' (' + Math.round(dist) + 'mi ' + fireDir16 + ')');
          }
        }
      });
      if (upwindFireNames.length > 0) {
        factors.push({icon:'', name:'Upwind Wildfire Smoke', severity:'critical', detail:upwindFireNames.length + ' active fire(s) upwind (wind from ' + wDir + '): ' + upwindFireNames.slice(0, 3).join(', ') + '. Smoke transport at this wind speed (' + (wx.wind || '?') + ' mph) takes roughly ' + (wx.wind > 0 ? Math.round(upwindFireNames.length > 0 ? 100 / wx.wind : 0) + ' hours from 100mi' : '?') + '.'});
        chainStages.push({label:'FIRE SMOKE', active:true, color:'#f44'});
      } else if (nearbyFireCount > 0) {
        factors.push({icon:'', name:'Nearby Fires', severity:'low', detail:nearbyFireCount + ' active fire(s) within 500mi but not directly upwind. Wind shift could change exposure.'});
      }
    }

    // FACTOR 8: Ozone-specific (summer photochemistry)
    var ozoneHigh = c.ozone != null && c.ozone > 80;
    if (ozoneHigh && isSummer && isMidDay) {
      factors.push({icon:'', name:'Photochemical Smog', severity:'high', detail:'Ozone at ' + Math.round(c.ozone) + ' g/m. Summer afternoon UV converts NO + VOCs into ground-level ozone. Peak typically 125 PM. Hot, sunny, stagnant = worst ozone days.'});
    } else if (ozoneHigh) {
      factors.push({icon:'', name:'Elevated Ozone', severity:'moderate', detail:'Ozone at ' + Math.round(c.ozone) + ' g/m  above WHO guideline. Photochemical production or transport from upwind urban areas.'});
    }

    // FACTOR 9: Soil moisture / dust potential
    if (wx.soilMoisture != null && wx.soilMoisture < 0.08 && wx.wind > 15 && (c.pm10 || 0) > (c.pm2_5 || 0) * 1.5) {
      factors.push({icon:'', name:'Dust Lofting', severity:'moderate', detail:'Parched soil (moisture ' + (wx.soilMoisture * 100).toFixed(0) + '%) + strong wind (' + wx.wind + ' mph) = dust entrainment. PM10 (' + Math.round(c.pm10) + ') elevated relative to PM2.5 (' + Math.round(c.pm2_5) + ') confirms coarse particle source.'});
    }

    // FACTOR 10: NO2/SO2 industrial signature
    if (c.nitrogen_dioxide != null && c.nitrogen_dioxide > 40) {
      var srcDir = '';
      if (wDir !== '--') {
        // Identify likely source based on wind direction for major cities
        var industrialDirs = {'NYC':{'SW':'NJ refineries/industrial corridor','W':'NJ industrial','S':'port/shipping','NE':'CT industry'},'LA':{'E':'Inland Empire/warehousing','S':'port of Long Beach','N':'San Fernando Valley traffic'}};
        // Generic fallback
        srcDir = ' Wind from ' + wDir + '  check industrial/port sources in that direction.';
      }
      factors.push({icon:'', name:'Industrial/Vehicle NO', severity:'moderate', detail:'NO elevated at ' + Math.round(c.nitrogen_dioxide) + ' g/m (WHO limit: 25). Primary source: diesel exhaust + industrial combustion.' + srcDir});
    }
    if (c.sulphur_dioxide != null && c.sulphur_dioxide > 20) {
      factors.push({icon:'', name:'SO Source Detected', severity:'moderate', detail:'SO at ' + Math.round(c.sulphur_dioxide) + ' g/m  suggests coal/oil combustion or industrial point source upwind.'});
    }

    // FACTOR 11: AQI trend analysis
    var aqiTrendNarr = '';
    if (hourlyAq.us_aqi && hourlyAq.us_aqi.length >= 6) {
      var aqVals = hourlyAq.us_aqi;
      var recent6 = aqVals.slice(-6);
      var earlier6 = aqVals.slice(0, 6);
      var avgRecent = recent6.reduce(function(s,v){return s+(v||0);},0) / recent6.length;
      var avgEarlier = earlier6.reduce(function(s,v){return s+(v||0);},0) / earlier6.length;
      var delta = avgRecent - avgEarlier;
      // Find peak hour
      var peakVal = 0, peakIdx = 0;
      aqVals.forEach(function(v, i) { if (v > peakVal) { peakVal = v; peakIdx = i; } });
      var peakTime = hourlyAq.time ? new Date(hourlyAq.time[peakIdx]) : null;
      var peakStr = peakTime ? ((peakTime.getHours() % 12 || 12) + (peakTime.getHours() < 12 ? 'AM' : 'PM')) : '';

      if (delta > 20) {
        aqiTrendNarr = ' <b>Rapidly worsening</b>  AQI climbed ~' + Math.round(Math.abs(delta)) + ' points over the past hours. ';
        if (inversionTrapping) aqiTrendNarr += 'Inversion is strengthening, concentrating pollutants.';
        else if (isRushHour) aqiTrendNarr += 'Rush hour emissions accumulating.';
        else aqiTrendNarr += 'Source intensity increasing or dispersion decreasing.';
      } else if (delta > 8) {
        aqiTrendNarr = ' <b>Gradually worsening</b>  up ~' + Math.round(Math.abs(delta)) + ' points. ';
        if (isOvernight) aqiTrendNarr += 'Overnight inversion deepening as surface cools.';
        else aqiTrendNarr += 'Emissions outpacing dispersion.';
      } else if (delta < -20) {
        aqiTrendNarr = ' <b>Rapidly improving</b>  AQI dropped ~' + Math.round(Math.abs(delta)) + ' points. ';
        if (raining) aqiTrendNarr += 'Precipitation washout clearing the air.';
        else if (isMidDay) aqiTrendNarr += 'Solar heating breaking the inversion  vertical mixing dispersing pollutants.';
        else if (wx.wind > 12) aqiTrendNarr += 'Increasing winds providing horizontal dispersion.';
        else aqiTrendNarr += 'Source reduction or improving dispersion.';
      } else if (delta < -8) {
        aqiTrendNarr = ' <b>Gradually improving</b>  down ~' + Math.round(Math.abs(delta)) + ' points. Recovery underway.';
      } else {
        aqiTrendNarr = ' <b>Stable</b>  emissions and dispersion roughly balanced. ';
        if (peakStr) aqiTrendNarr += 'Peak was ' + Math.round(peakVal) + ' at ' + peakStr + '.';
      }
    }

    //  BUILD THE NARRATIVE 
    // Sort factors by severity
    var sevOrder = {critical:0, high:1, moderate:2, low:3, helpful:4};
    factors.sort(function(a,b){ return (sevOrder[a.severity]||5) - (sevOrder[b.severity]||5); });

    // Compose the primary explanation
    var primaryCause = factors.length > 0 ? factors[0] : null;
    var contributingCauses = factors.filter(function(f){ return f.severity !== 'helpful'; }).slice(1, 4);
    var helpfulFactors = factors.filter(function(f){ return f.severity === 'helpful'; });

    if (aqiVal != null && (aqiVal > 30 || factors.length > 0)) {
      h += '<div style="background:rgba(255,255,255,.03);border-radius:10px;padding:10px 12px;margin-bottom:10px;border:1px solid rgba(255,255,255,.05);">';
      h += '<div style="font-size:.5rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;"> WHY IS THE AIR LIKE THIS?</div>';

      //  Event chain status bar 
      if (chainStages.length > 0) {
        // Build a comprehensive chain: Sources  Trapping  Accumulation  Exposure
        var fullChain = [
          {label:'SOURCES', active: factors.some(function(f){ return f.name.match(/Traffic|Heating|Fire|Industrial|Dust|Photochem/); }), color:''},
          {label:'TRAPPING', active: inversionTrapping || windStagnant, color:''},
          {label:'ACCUMULATION', active: aqiVal > 80, color:''},
          {label:'EXPOSURE', active: aqiVal > 100, color:''}
        ];
        fullChain.forEach(function(s) {
          if (!s.color) s.color = s.active ? (aqiVal > 150 ? '#f44' : aqiVal > 100 ? '#f90' : '#cc0') : 'rgba(255,255,255,.15)';
        });
        h += '<div style="display:flex;gap:2px;margin-bottom:8px;align-items:center;">';
        fullChain.forEach(function(s, i) {
          h += '<div style="flex:1;text-align:center;padding:3px 2px;border-radius:4px;background:' + (s.active ? s.color + '18' : 'rgba(255,255,255,.03)') + ';border:1px solid ' + (s.active ? s.color + '55' : 'rgba(255,255,255,.06)') + ';">';
          h += '<div style="font-size:.34rem;font-weight:700;color:' + (s.active ? s.color : '#555') + ';letter-spacing:.5px;">' + s.label + '</div>';
          h += '<div style="font-size:.45rem;margin-top:1px;">' + (s.active ? '' : '') + '</div>';
          h += '</div>';
          if (i < fullChain.length - 1) h += '<div style="font-size:.40rem;color:#555;flex-shrink:0;"></div>';
        });
        h += '</div>';
      }

      //  Primary cause 
      if (primaryCause) {
        var pcBorder = primaryCause.severity === 'critical' ? '#f44' : primaryCause.severity === 'high' ? '#f90' : '#cc0';
        h += '<div style="background:' + pcBorder + '0d;border-left:3px solid ' + pcBorder + ';padding:6px 10px;border-radius:0 6px 6px 0;margin-bottom:6px;">';
        h += '<div style="font-size:.60rem;font-weight:800;color:' + pcBorder + ';">' + primaryCause.icon + ' PRIMARY: ' + primaryCause.name + '</div>';
        h += '<div style="font-size:.50rem;color:#ccc;line-height:1.4;margin-top:2px;">' + primaryCause.detail + '</div>';
        h += '</div>';
      }

      //  Contributing factors 
      if (contributingCauses.length > 0) {
        h += '<div style="margin-bottom:5px;">';
        h += '<div style="font-size:.42rem;color:#888;font-weight:700;margin-bottom:3px;">CONTRIBUTING:</div>';
        contributingCauses.forEach(function(f) {
          var fCol = f.severity === 'critical' ? '#f44' : f.severity === 'high' ? '#f90' : f.severity === 'moderate' ? '#cc0' : '#78a0ff';
          h += '<div style="display:flex;gap:6px;align-items:flex-start;margin-bottom:3px;padding:3px 6px;background:rgba(255,255,255,.02);border-radius:4px;">';
          h += '<span style="font-size:.55rem;flex-shrink:0;">' + f.icon + '</span>';
          h += '<div><span style="font-size:.48rem;font-weight:700;color:' + fCol + ';">' + f.name + '</span>';
          h += '<div style="font-size:.44rem;color:#aaa;line-height:1.3;">' + f.detail + '</div></div>';
          h += '</div>';
        });
        h += '</div>';
      }

      //  Helpful / mitigating factors 
      if (helpfulFactors.length > 0) {
        h += '<div style="margin-bottom:5px;">';
        h += '<div style="font-size:.42rem;color:#4f8;font-weight:700;margin-bottom:3px;"> MITIGATING:</div>';
        helpfulFactors.forEach(function(f) {
          h += '<div style="display:flex;gap:6px;align-items:flex-start;margin-bottom:2px;padding:2px 6px;">';
          h += '<span style="font-size:.48rem;flex-shrink:0;">' + f.icon + '</span>';
          h += '<div style="font-size:.44rem;color:#4f8;line-height:1.3;"><b>' + f.name + ':</b> ' + f.detail + '</div>';
          h += '</div>';
        });
        h += '</div>';
      }

      //  Trend narrative 
      if (aqiTrendNarr) {
        h += '<div style="font-size:.48rem;color:#ccc;line-height:1.4;padding:4px 6px;background:rgba(255,255,255,.02);border-radius:4px;margin-top:4px;">' + aqiTrendNarr + '</div>';
      }

      //  Forecast narrative (what's next) 
      var fcastParts = [];
      if (wx.pressureTrend != null && wx.pressureTrend < -2) fcastParts.push('Falling pressure suggests an approaching front  expect improved mixing and AQI improvement within hours.');
      else if (wx.pressureTrend != null && wx.pressureTrend > 1.5 && inversionTrapping) fcastParts.push('Rising pressure strengthening the inversion. AQI may worsen further until a pattern change.');
      if (wx.next6hrMaxPrecipProb != null && wx.next6hrMaxPrecipProb > 50 && aqiVal > 50) fcastParts.push('Precipitation likely in next 6 hours (' + wx.next6hrMaxPrecipProb + '% chance)  rain washout should help clear the air.');
      if (isOvernight && aqiVal > 80) fcastParts.push('Morning solar heating (after sunrise) will begin breaking the inversion and improving mixing.');
      if (isMidDay && inversionTrapping && !raining) fcastParts.push('If solar heating can\'t break this inversion by now, it may persist into evening. Watch for frontal passage to scour the air.');
      if (wx.next6hrMaxGust != null && wx.next6hrMaxGust > 20 && windCalm) fcastParts.push('Gusts increasing to ' + wx.next6hrMaxGust + ' mph in next 6 hours  should improve dispersion.');

      if (fcastParts.length > 0) {
        h += '<div style="margin-top:5px;padding:5px 8px;background:rgba(120,160,255,.06);border-radius:6px;border-left:2px solid rgba(120,160,255,.4);">';
        h += '<div style="font-size:.42rem;color:#78a0ff;font-weight:700;margin-bottom:2px;"> WHAT\'S NEXT</div>';
        h += '<div style="font-size:.46rem;color:#bbb;line-height:1.4;">' + fcastParts.join(' ') + '</div>';
        h += '</div>';
      }

      h += '</div>'; // close root cause container
    }

    // === SMOKE  compact single row ===
    var sL,sC,sP;
    if(pm25>=150){sL='HEAVY';sC='#ef4444';sP='Stay indoors. HEPA on. N95 outside.';}
    else if(pm25>=55.5){sL='THICK';sC='#f97316';sP='Limit outdoor time. Close windows. N95 helps.';}
    else if(pm25>=35.5){sL='MODERATE';sC='#eab308';sP='Sensitive groups limit outdoors. Close windows PM.';}
    else if(pm25>=12.1){sL='LIGHT HAZE';sC='#a3a3a3';sP='No precautions for most.';}
    else{sL='CLEAR';sC='#22c55e';sP='Clean air. No precautions.';}
    var sVis=pm25>=150?'<1mi':pm25>=55.5?'13mi':pm25>=35.5?'35mi':pm25>=12.1?'510mi':'10+mi';

    h+='<div style="display:grid;grid-template-columns:auto 1fr auto auto auto;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,.03);border-radius:8px;margin-bottom:10px;border:1px solid rgba(255,255,255,.04);">';
    h+='<div style="font-size:.48rem;color:#888;font-weight:800;"></div>';
    h+='<div>';
    h+='<div style="font-size:.65rem;font-weight:900;color:'+sC+';line-height:1;">'+sL+'</div>';
    h+='<div style="font-size:.45rem;color:#999;">'+sP+'</div>';
    h+='</div>';
    h+='<div style="text-align:center;"><div style="font-size:.38rem;color:#777;font-weight:700;">PM2.5</div><div style="font-size:.6rem;font-weight:900;color:'+ac(c.us_aqi_pm2_5)+';">'+Math.round(pm25)+'</div></div>';
    h+='<div style="text-align:center;"><div style="font-size:.38rem;color:#777;font-weight:700;">WHO</div><div style="font-size:.6rem;font-weight:900;color:#f97316;">'+(pm25/5).toFixed(1)+'</div></div>';
    h+='<div style="text-align:center;"><div style="font-size:.38rem;color:#777;font-weight:700;">VIS</div><div style="font-size:.55rem;font-weight:700;color:#ccc;">'+sVis+'</div></div>';
    h+='</div>';

    // Smoke source from active fires + wind direction
    if(window._activeFires&&window._activeFires.length>0&&pm25>=12){
      var lat=LOCATION.lat,lon=LOCATION.lon;
      var wDirsAll=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      var windFrom=wDir; // wind blows FROM this direction
      // Find fires that are upwind (in the direction wind comes from)
      var upwindFires=[];
      window._activeFires.forEach(function(fire){
        var coords=fire.geometry&&fire.geometry.coordinates;
        var props=fire.properties||{};
        if(!coords)return;
        var fLat=coords[1],fLon=coords[0];
        var dLat=fLat-lat,dLon=fLon-lon;
        var dist=Math.sqrt(dLat*dLat+dLon*dLon)*69;
        if(dist>500||dist<5)return; // skip fires >500mi or <5mi
        var angle=Math.atan2(dLon,dLat)*180/Math.PI;
        if(angle<0)angle+=360;
        var fireDir=wDirsAll[Math.round(angle/22.5)%16];
        // Check if fire direction roughly matches wind-from direction (within 45)
        var wIdx=wDirsAll.indexOf(windFrom);
        var fIdx=wDirsAll.indexOf(fireDir);
        if(wIdx<0)return;
        var diff=Math.abs(fIdx-wIdx);if(diff>8)diff=16-diff;
        var isUpwind=diff<=2; // within ~45
        var acres=props.DailyAcres||props.GISAcres||props.CalculatedAcres||0;
        var name=props.IncidentName||props.FireName||'Unknown';
        upwindFires.push({name:name,dist:Math.round(dist),acres:acres,dir:fireDir,upwind:isUpwind,contained:props.PercentContained||0});
      });
      // Sort by relevance: upwind first, then by size
      upwindFires.sort(function(a,b){
        if(a.upwind&&!b.upwind)return-1;if(!a.upwind&&b.upwind)return 1;
        return b.acres-a.acres;
      });
      var topFires=upwindFires.slice(0,3);
      if(topFires.length>0){
        h+='<div style="padding:6px 10px;background:rgba(239,68,68,.06);border-radius:8px;margin-top:6px;border:1px solid rgba(239,68,68,.1);">';
        h+='<div style="font-size:.48rem;color:#ef4444;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-top:8px;margin-bottom:3px;"> LIKELY SMOKE SOURCES</div>';
        topFires.forEach(function(f){
          var acStr=f.acres>0?(f.acres>=1000?(Math.round(f.acres/1000)+'k'):f.acres)+' acres':'size unknown';
          var contStr=f.contained>0?'  '+f.contained+'% contained':'';
          h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">';
          h+='<span style="font-size:.58rem;color:#eee;font-weight:700;">'+f.name+'</span>';
          h+='<span style="font-size:.48rem;color:#aaa;">'+f.dist+'mi '+f.dir+(f.upwind?' ':'')+'</span>';
          h+='</div>';
          h+='<div style="font-size:.45rem;color:#999;margin-top:8px;margin-bottom:3px;">'+acStr+contStr+'</div>';
        });
        if(topFires.some(function(f){return f.upwind;})){
          h+='<div style="font-size:.45rem;color:#f97316;margin-top:2px;"> = upwind of you (wind from '+windFrom+')</div>';
        }
        h+='</div>';
      }
    }

    // === POLLUTANTS  compact 2-col grid ===
    h+='<div style="font-size:.5rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;margin-top:8px;margin-bottom:3px;">POLLUTANTS</div>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:10px;">';
    subs.forEach(function(p){
      var pc=ac(p.a),pl=al(p.a),isDom=p.n===dom.n;
      var barW=p.a!=null?Math.min((p.a/300)*100,100):0;
      var whoX='';if(p.v!=null&&p.who){var r=p.v/p.who;whoX=r<=1?'<span style="color:#22c55e;"></span>':'<span style="color:#f97316;">'+r.toFixed(1)+'</span>';}
      var ms='';
      if(hr&&hr[p.k]){var pV=hr[p.k],pM=Math.max.apply(null,pV.filter(function(v){return v!=null;}).concat([1]));var mP=[];for(var j=0;j<pV.length;j++){if(pV[j]==null)continue;mP.push(((j/(pV.length-1))*40)+','+(12-(pV[j]/pM)*12));}if(mP.length>1)ms='<svg viewBox="0 0 40 12" style="width:35px;height:12px;opacity:.5;" preserveAspectRatio="none"><polyline points="'+mP.join(' ')+'" fill="none" stroke="'+pc+'" stroke-width="1"/></svg>';}

      h+='<div style="padding:5px 7px;background:'+(isDom?'rgba(255,255,255,.06)':'rgba(255,255,255,.02)')+';border-radius:6px;border:1px solid '+(isDom?'rgba(255,255,255,.08)':'rgba(255,255,255,.03)')+';">';
      // Row 1: name + AQI
      h+='<div style="display:flex;justify-content:space-between;align-items:center;">';
      h+='<span style="font-size:.68rem;font-weight:800;color:#fff;">'+p.n+(isDom?' <span style="font-size:.32rem;background:'+pc+';color:#000;padding:1px 3px;border-radius:2px;vertical-align:middle;"></span>':'')+'</span>';
      h+='<div style="display:flex;align-items:center;gap:3px;">'+ms+'<span style="font-size:.72rem;font-weight:900;color:'+pc+';">'+(p.a!=null?Math.round(p.a):'--')+'</span></div>';
      h+='</div>';
      // Bar
      h+='<div style="height:3px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden;margin:3px 0;">';
      h+='<div style="height:100%;width:'+barW+'%;background:'+pc+';border-radius:2px;"></div></div>';
      // Row 2: value + WHO + desc
      h+='<div style="display:flex;justify-content:space-between;align-items:center;">';
      h+='<span style="font-size:.48rem;color:#aaa;">'+(p.v!=null?(Math.round(p.v*10)/10)+'g':'--')+' '+whoX+'</span>';
      h+='<span style="font-size:.42rem;color:#666;font-style:italic;">'+p.d+'</span>';
      h+='</div></div>';
    });
    h+='</div>';

    // === COMPARISON  nearby + reference ===
    var compId='aqi-cmp-'+Date.now();
    h+='<div id="'+compId+'">';
    h+='<div style="font-size:.5rem;color:#666;text-align:center;padding:8px;">Loading comparisons...</div>';
    h+='</div>';

    setTimeout(function(){
      var compEl=document.getElementById(compId);if(!compEl)return;
      var lat=LOCATION.lat,lon=LOCATION.lon;

      // Reference cities (always shown)
      var refs=[
        {lat:40.71,lon:-74.01,name:'New York City',t:'urban'},{lat:34.05,lon:-118.24,name:'Los Angeles',t:'urban'},
        {lat:41.88,lon:-87.63,name:'Chicago',t:'urban'},{lat:35.37,lon:-119.02,name:'Bakersfield',t:'urban'},
        {lat:40.76,lon:-111.89,name:'Salt Lake City',t:'urban'},{lat:29.76,lon:-95.37,name:'Houston',t:'urban'},
        {lat:46.87,lon:-110.36,name:'Rural Montana',t:'rural'},{lat:44.26,lon:-72.58,name:'Rural Vermont',t:'rural'},
        {lat:43.80,lon:-120.55,name:'Rural Oregon',t:'rural'}
      ];

      // Search for nearby cities using Open-Meteo geocoding  4 fast parallel searches
      var searchQueries=[
        'https://geocoding-api.open-meteo.com/v1/search?name=city&count=10&latitude='+lat+'&longitude='+lon+'&radius=160000',
      ];
      // Use directional searches at ~100mi offsets to find cities in each direction
      var off=1.45;
      var dirPts=[
        {lat:lat+off,lon:lon},{lat:lat-off,lon:lon},
        {lat:lat,lon:lon+off},{lat:lat,lon:lon-off},
        {lat:lat+off*.7,lon:lon+off*.7},{lat:lat-off*.7,lon:lon-off*.7},
        {lat:lat+off*.7,lon:lon-off*.7},{lat:lat-off*.7,lon:lon+off*.7},
        {lat:lat+off*.5,lon:lon},{lat:lat-off*.5,lon:lon},
        {lat:lat,lon:lon+off*.5},{lat:lat,lon:lon-off*.5}
      ];

      // Just directly fetch AQI for directional grid + refs in one call (instant)
      var allPts=dirPts.concat(refs);
      var lats=allPts.map(function(p){return p.lat.toFixed(4);}).join(',');
      var lons=allPts.map(function(p){return p.lon.toFixed(4);}).join(',');

      // Single fast AQI fetch
      fetch('https://air-quality-api.open-meteo.com/v1/air-quality?latitude='+lats+'&longitude='+lons+'&current=us_aqi,pm2_5')
      .then(function(r){return r.json();}).then(function(data){
        if(!compEl||!Array.isArray(data))return;

        var dirLabels=['N','S','E','W','NE','SW','NW','SE','N-mid','S-mid','E-mid','W-mid'];
        var near=[],ref=[];
        data.forEach(function(dd,i){
          if(!dd||!dd.current||dd.current.us_aqi==null)return;
          var a=Math.round(dd.current.us_aqi);
          if(i<dirPts.length){
            // Use latitude/longitude to generate approximate city via state lookup
            near.push({n:dirLabels[i]+' ~'+(i>=8?'50':'100')+'mi',aqi:a,lat:dirPts[i].lat,lon:dirPts[i].lon});
          } else {
            var rf=refs[i-dirPts.length];
            ref.push({n:rf.name,aqi:a,t:rf.t});
          }
        });
        var me={n:LOCATION.name||'You',aqi:Math.round(c.us_aqi),you:true};

        // Render immediately with compass directions
        renderComp(near,ref,me);

        // Background: batch reverse geocode via Nominatim for real names
        // Fire ALL at once (Nominatim may rate limit but results still come)
        var resolved=0;
        near.forEach(function(nr,idx){
          setTimeout(function(){
            fetch('https://nominatim.openstreetmap.org/reverse?lat='+nr.lat.toFixed(4)+'&lon='+nr.lon.toFixed(4)+'&format=json&zoom=10&addressdetails=1')
            .then(function(r){return r.json();}).then(function(d){
              if(d&&d.address){
                var nm=d.address.city||d.address.town||d.address.village||d.address.hamlet||d.address.county||'';
                var st=d.address.state||'';
                var ab={'New York':'NY','New Jersey':'NJ','Connecticut':'CT','Pennsylvania':'PA','Massachusetts':'MA','Vermont':'VT','New Hampshire':'NH','Maine':'ME','Maryland':'MD','Virginia':'VA','Delaware':'DE','California':'CA','Texas':'TX','Illinois':'IL','Ohio':'OH','Michigan':'MI','Georgia':'GA','Florida':'FL','North Carolina':'NC','Washington':'WA','Oregon':'OR','Colorado':'CO','Arizona':'AZ','Nevada':'NV','Utah':'UT','Montana':'MT','Idaho':'ID','Wyoming':'WY','Tennessee':'TN','Kentucky':'KY','Indiana':'IN','Wisconsin':'WI','Minnesota':'MN','Iowa':'IA','Missouri':'MO','Arkansas':'AR','Louisiana':'LA','Mississippi':'MS','Alabama':'AL','South Carolina':'SC','West Virginia':'WV','Rhode Island':'RI','Nebraska':'NE','Kansas':'KS','Oklahoma':'OK','New Mexico':'NM','South Dakota':'SD','North Dakota':'ND'};
                if(nm) nr.n=nm+', '+(ab[st]||st.substring(0,2).toUpperCase());
                nr.pop=d.address.city?'urban':'rural';
              }
              resolved++;
              if(resolved>=near.length) renderComp(near,ref,me);
            }).catch(function(){resolved++;if(resolved>=near.length)renderComp(near,ref,me);});
          },idx*120);
        });
      }).catch(function(){compEl.innerHTML='<div style="font-size:.5rem;color:#666;">Comparison unavailable</div>';});

      function renderComp(near,ref,me){
        // Dedup + filter unnamed
        var seen={},uniq=[];
        near.forEach(function(r){var k=r.n.split(',')[0].trim();if(!seen[k]&&r.n.indexOf('~')===-1){seen[k]=true;uniq.push(r);}});
        // If no named cities yet, show all compass entries
        if(uniq.length===0) uniq=near;

        uniq.sort(function(a,b){return a.aqi-b.aqi;});
        ref.sort(function(a,b){return a.aqi-b.aqi;});

        var avgN=uniq.length?Math.round(uniq.reduce(function(s,r){return s+r.aqi;},0)/uniq.length):0;
        var worst=uniq.length?uniq[uniq.length-1]:{n:'--',aqi:0};
        var best=uniq.length?uniq[0]:{n:'--',aqi:0};
        var uA=0,uC=0,rA=0,rC=0;
        ref.forEach(function(r){if(r.t==='urban'){uA+=r.aqi;uC++;}if(r.t==='rural'){rA+=r.aqi;rC++;}});
        if(uC)uA=Math.round(uA/uC);if(rC)rA=Math.round(rA/rC);

        function bars(list,max){
          var s='';list.forEach(function(r){
            var bp=Math.min((r.aqi/max)*100,100),bc=ac(r.aqi);
            var tag=r.pop==='rural'||r.t==='rural'?'':r.pop==='urban'||r.t==='urban'?'':'';
            s+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:1px;'+(r.you?'background:rgba(255,255,255,.07);border-radius:3px;padding:2px 5px;margin-left:-5px;margin-right:-5px;':'')+'">';
            s+='<div style="width:105px;font-size:.48rem;color:'+(r.you?'#fff':'#999')+';font-weight:'+(r.you?'800':'500')+';text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+(r.you?' '+r.n:r.n+(tag?' '+tag:''))+'</div>';
            s+='<div style="flex:1;height:4px;background:rgba(255,255,255,.05);border-radius:2px;overflow:hidden;"><div style="height:100%;width:'+bp+'%;background:'+bc+';border-radius:2px;"></div></div>';
            s+='<div style="width:22px;font-size:.48rem;font-weight:800;color:'+bc+';">'+r.aqi+'</div></div>';
          });return s;
        }
        var ch='';
        ch+='<div style="font-size:.5rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px;"> NEARBY (~100 mi)</div>';
        ch+='<div style="font-size:.6rem;color:#ddd;margin-bottom:2px;">'+(c.us_aqi<=avgN?'<span style="color:#22c55e;font-weight:800;">Better</span>':'<span style="color:#f97316;font-weight:800;">Worse</span>')+' than nearby avg <span style="color:'+ac(avgN)+';font-weight:800;">'+avgN+'</span>';
        if(worst.aqi-best.aqi>10) ch+='  <span style="color:'+ac(worst.aqi)+';">'+worst.n.split(',')[0]+' '+worst.aqi+'</span>  <span style="color:'+ac(best.aqi)+';">'+best.n.split(',')[0]+' '+best.aqi+'</span>';
        ch+='</div>';
        var allN=uniq.slice();allN.push(me);allN.sort(function(a,b){return a.aqi-b.aqi;});
        ch+=bars(allN,Math.max.apply(null,allN.map(function(r){return r.aqi;}).concat([100])));

        ch+='<div style="font-size:.5rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-top:8px;margin-bottom:3px;"> US REFERENCE</div>';
        var allR=ref.slice();allR.push(me);allR.sort(function(a,b){return a.aqi-b.aqi;});
        ch+=bars(allR,Math.max.apply(null,allR.map(function(r){return r.aqi;}).concat([100])));

        ch+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;margin-top:6px;">';
        ch+='<div style="text-align:center;padding:3px;background:rgba(255,255,255,.03);border-radius:4px;"><div style="font-size:.38rem;color:#888;font-weight:700;">NEARBY</div><div style="font-size:.72rem;font-weight:900;color:'+ac(avgN)+';">'+avgN+'</div></div>';
        ch+='<div style="text-align:center;padding:3px;background:rgba(255,255,255,.03);border-radius:4px;"><div style="font-size:.38rem;color:#888;font-weight:700;"> URBAN</div><div style="font-size:.72rem;font-weight:900;color:'+ac(uA)+';">'+uA+'</div></div>';
        ch+='<div style="text-align:center;padding:3px;background:rgba(255,255,255,.03);border-radius:4px;"><div style="font-size:.38rem;color:#888;font-weight:700;"> RURAL</div><div style="font-size:.72rem;font-weight:900;color:'+ac(rA)+';">'+rA+'</div></div>';
        ch+='<div style="text-align:center;padding:3px;background:rgba(255,255,255,.06);border-radius:4px;border:1px solid rgba(255,255,255,.08);"><div style="font-size:.38rem;color:#888;font-weight:700;"> YOU</div><div style="font-size:.72rem;font-weight:900;color:'+ac(c.us_aqi)+';">'+Math.round(c.us_aqi)+'</div></div>';
        ch+='</div>';
        compEl.innerHTML=ch;
      }
    },50);

    // 
    // CROSS-POLLINATION INTELLIGENCE
    // Connects AQI to astronomy, weather forecast, activity planning,
    // fire/smoke transport, and storm track clearing.
    // 

    h+='<div style="border-top:1px solid rgba(255,255,255,.06);margin-top:10px;padding-top:10px;">';
    h+='<div style="font-size:.5rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;"> AIR QUALITY INTELLIGENCE</div>';

    //  1. HOURLY AQI FORECAST TIMELINE 
    if (hr && hr.us_aqi && hr.time && hr.us_aqi.length >= 12) {
      var nowIdx = 0;
      var nowTime = new Date();
      for (var ti = 0; ti < hr.time.length; ti++) {
        if (new Date(hr.time[ti]) <= nowTime) nowIdx = ti;
      }
      // Show next 24 hours
      var forecastSlots = [];
      var bestHour = null, bestAqi = 999, worstHour = null, worstAqi = 0;
      for (var fi = nowIdx; fi < Math.min(nowIdx + 24, hr.us_aqi.length); fi++) {
        var fAqi = hr.us_aqi[fi];
        var fTime = new Date(hr.time[fi]);
        if (fAqi != null) {
          forecastSlots.push({ time: fTime, aqi: Math.round(fAqi), hr: fTime.getHours() });
          if (fAqi < bestAqi) { bestAqi = Math.round(fAqi); bestHour = fTime; }
          if (fAqi > worstAqi) { worstAqi = Math.round(fAqi); worstHour = fTime; }
        }
      }

      if (forecastSlots.length >= 6) {
        var fmtHr = function(d) { if (!d) return '?'; var hh = d.getHours(); return (hh % 12 || 12) + (hh < 12 ? 'a' : 'p'); };
        h+='<div style="margin-bottom:8px;">';
        h+='<div style="font-size:.42rem;font-weight:700;color:#78a0ff;margin-bottom:3px;"> 24-HOUR AQI FORECAST</div>';

        // Summary
        h+='<div style="font-size:.38rem;color:#aaa;margin-bottom:2px;">';
        h+='Best: <b style="color:' + ac(bestAqi) + ';">' + bestAqi + '</b> at ' + fmtHr(bestHour);
        h+='  Worst: <b style="color:' + ac(worstAqi) + ';">' + worstAqi + '</b> at ' + fmtHr(worstHour);
        h+='</div>';

        // Bar chart
        var maxAqi = Math.max(worstAqi, 100);
        h+='<div style="display:flex;gap:1px;align-items:flex-end;height:40px;background:rgba(0,0,0,.1);border-radius:4px;overflow:hidden;padding:2px;">';
        forecastSlots.forEach(function(slot) {
          var barH = Math.max(2, (slot.aqi / maxAqi) * 36);
          var isNow = Math.abs(slot.time - nowTime) < 1800000;
          h+='<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;min-width:0;">';
          h+='<div style="width:100%;height:' + barH + 'px;background:' + ac(slot.aqi) + ';opacity:' + (isNow ? '1' : '.55') + ';border-radius:1px 1px 0 0;' + (isNow ? 'box-shadow:0 0 4px ' + ac(slot.aqi) + ';' : '') + '"></div>';
          h+='</div>';
        });
        h+='</div>';

        // Time labels (every 3rd)
        h+='<div style="display:flex;gap:1px;">';
        forecastSlots.forEach(function(slot, idx) {
          var show = idx % 3 === 0;
          var isNow = Math.abs(slot.time - nowTime) < 1800000;
          h+='<div style="flex:1;text-align:center;font-size:.22rem;color:' + (isNow ? '#4f8' : '#444') + ';">' + (show ? fmtHr(slot.time) : '') + '</div>';
        });
        h+='</div>';

        // Outdoor activity window
        var goodWindow = [];
        var inWindow = false, windowStart = null;
        forecastSlots.forEach(function(slot) {
          if (slot.aqi <= 100 && slot.hr >= 6 && slot.hr <= 21) {
            if (!inWindow) { inWindow = true; windowStart = slot.time; }
          } else {
            if (inWindow) { goodWindow.push({ start: windowStart, end: slot.time }); inWindow = false; }
          }
        });
        if (inWindow && windowStart) goodWindow.push({ start: windowStart, end: forecastSlots[forecastSlots.length - 1].time });

        if (goodWindow.length > 0) {
          var best = goodWindow.reduce(function(a, b) { return (b.end - b.start) > (a.end - a.start) ? b : a; });
          h+='<div style="margin-top:3px;padding:3px 6px;background:rgba(34,197,94,.06);border-radius:4px;border-left:2px solid #22c55e;">';
          h+='<div style="font-size:.38rem;color:#22c55e;font-weight:700;"> BEST OUTDOOR WINDOW: ' + fmtHr(best.start) + '' + fmtHr(best.end) + '</div>';
          h+='<div style="font-size:.34rem;color:#888;">AQI expected 100 (Moderate or better). Safe for jogging, cycling, outdoor exercise.</div>';
          h+='</div>';
        } else if (aqiVal > 150) {
          h+='<div style="margin-top:3px;padding:3px 6px;background:rgba(239,68,68,.06);border-radius:4px;border-left:2px solid #ef4444;">';
          h+='<div style="font-size:.38rem;color:#ef4444;font-weight:700;"> NO SAFE OUTDOOR WINDOW IN NEXT 24HR</div>';
          h+='<div style="font-size:.34rem;color:#888;">AQI stays above 100 throughout. Limit outdoor exertion. Use N95 mask if going outside.</div>';
          h+='</div>';
        }

        h+='</div>';
      }
    }

    //  2. STORM TRACK  AQ FORECAST 
    var stormTrack = window._stormTrack;
    if (stormTrack && stormTrack.events && aqiVal > 50) {
      var aqRelevant = [];

      stormTrack.events.forEach(function(evt) {
        if (evt.type === 'front' || evt.type === 'wind_shift') {
          aqRelevant.push({ icon: '', text: evt.detail + '  Frontal passage mixes the boundary layer and flushes stagnant air. AQI typically drops 30-60% within 2-4 hours after a front.', pri: 'good' });
        } else if (evt.type === 'rain_start' || evt.type === 'heavy_rain') {
          aqRelevant.push({ icon: '', text: evt.detail + '  Precipitation scavenges PM2.5 and PM10 from the atmosphere. Heavy rain can cut AQI by 50%+ within an hour.', pri: 'good' });
        } else if (evt.type === 'clearing' && inversionTrapping) {
          aqRelevant.push({ icon: '', text: 'Clearing skies ahead  solar heating will break the inversion and deepen the mixing layer, improving dispersion.', pri: 'moderate' });
        }
      });

      if (aqRelevant.length > 0) {
        h+='<div style="margin-bottom:8px;">';
        h+='<div style="font-size:.42rem;font-weight:700;color:#4f8;margin-bottom:3px;"> WEATHER  AQ OUTLOOK</div>';
        aqRelevant.forEach(function(item) {
          var col = item.pri === 'good' ? '#4f8' : '#78a0ff';
          h+='<div style="padding:3px 6px;background:rgba(68,255,136,.04);border-radius:4px;margin-bottom:2px;border-left:2px solid ' + col + ';">';
          h+='<div style="font-size:.36rem;color:#aaa;line-height:1.35;">' + item.icon + ' ' + item.text + '</div>';
          h+='</div>';
        });
        h+='</div>';
      }
    }

    //  3. ASTRONOMY IMPACT 
    var pm25Val = c.pm2_5 || 0;
    var astroImpact = null;
    if (pm25Val > 35) {
      astroImpact = { level: 'severe', color: '#f44', text: 'PM2.5 at ' + Math.round(pm25Val) + ' g/m severely degrades atmospheric transparency. Limiting magnitude reduced by ~1-2 mag. Faint DSOs, galaxies, and nebulae will be invisible. Stick to bright planets and the Moon.', tip: 'Even clear skies will look hazy. Stars will appear dimmer and "bloated" due to forward scattering from fine particles.' };
    } else if (pm25Val > 20) {
      astroImpact = { level: 'moderate', color: '#f90', text: 'PM2.5 at ' + Math.round(pm25Val) + ' g/m reduces transparency. Milky Way detail washed out. Mag ~11-12 objects still visible in telescopes but contrast is reduced.', tip: 'Use narrowband filters (OIII, H) to cut through haze for nebulae. Broadband targets (galaxies, clusters) will suffer.' };
    } else if (pm25Val > 12) {
      astroImpact = { level: 'fair', color: '#eab308', text: 'PM2.5 at ' + Math.round(pm25Val) + ' g/m  slight haze. Naked-eye Milky Way may be diminished but telescope targets mostly unaffected.', tip: 'Good enough for most observing. Transparency is "fair"  about 4/5 on the Antoniadi scale.' };
    } else if (pm25Val <= 12) {
      astroImpact = { level: 'excellent', color: '#22c55e', text: 'PM2.5 at ' + Math.round(pm25Val) + ' g/m  clean air. Excellent atmospheric transparency for deep-sky observing.', tip: 'Pristine conditions. Faint objects, low-contrast nebulae, and the zodiacal light may be visible.' };
    }

    if (astroImpact) {
      h+='<div style="margin-bottom:8px;">';
      h+='<div style="font-size:.42rem;font-weight:700;color:#78a0ff;margin-bottom:3px;"> ASTRONOMY IMPACT</div>';
      h+='<div style="padding:4px 7px;background:rgba(100,140,255,.04);border-radius:5px;border-left:2px solid ' + astroImpact.color + ';">';
      h+='<div style="font-size:.38rem;color:' + astroImpact.color + ';font-weight:700;">Transparency: ' + astroImpact.level.toUpperCase() + '</div>';
      h+='<div style="font-size:.36rem;color:#aaa;line-height:1.3;margin-top:2px;">' + astroImpact.text + '</div>';
      h+='<div style="font-size:.34rem;color:#666;line-height:1.3;margin-top:2px;font-style:italic;">' + astroImpact.tip + '</div>';

      // Observing score mini display if nighttime
      var obsScore = computeObservingScore();
      if (obsScore && sunAltNow < -6) {
        h+='<div style="margin-top:4px;display:flex;gap:6px;align-items:center;">';
        var sCol = obsScore.total >= 70 ? '#4f8' : obsScore.total >= 45 ? '#78a0ff' : obsScore.total >= 25 ? '#f90' : '#f44';
        h+='<div style="font-size:.36rem;color:' + sCol + ';font-weight:700;">Observing Score: ' + obsScore.total + '/100</div>';
        var transF = obsScore.factors.find(function(f) { return f.name === 'Transparency'; });
        if (transF) h+='<div style="font-size:.34rem;color:#888;">Transparency factor: ' + transF.pts + '/' + transF.max + '</div>';
        h+='</div>';
      }
      h+='</div>';
      h+='</div>';
    }

    //  4. FIRE/SMOKE TRANSPORT INTELLIGENCE 
    var activeFireData = window._activeFires || [];
    var smokeIntel = window._smokeIntel || null;

    //  SMOKE EVENT BANNER (from engine) 
    if (smokeIntel && smokeIntel.smokeEvent) {
      var sevCols = { emergency: '#7f1d1d', warning: '#ef4444', advisory: '#f97316' };
      var sevBg = { emergency: 'rgba(127,29,29,.12)', warning: 'rgba(239,68,68,.08)', advisory: 'rgba(249,115,22,.06)' };
      var sevLabels = { emergency: ' SMOKE EMERGENCY', warning: ' SMOKE WARNING', advisory: ' SMOKE ADVISORY' };
      var sCol = sevCols[smokeIntel.severity] || '#f90';
      h+='<div style="padding:6px 8px;background:' + (sevBg[smokeIntel.severity] || 'rgba(249,115,22,.06)') + ';border-radius:6px;margin-bottom:6px;border:1px solid ' + sCol + '40;">';
      h+='<div style="font-size:.48rem;font-weight:800;color:' + sCol + ';">' + (sevLabels[smokeIntel.severity] || 'SMOKE DETECTED') + '</div>';
      h+='<div style="font-size:.38rem;color:#ddd;margin-top:2px;">Confidence: <b>' + smokeIntel.smokeConfidence + '%</b>';
      if (smokeIntel.probableSource) h+='  Probable source: <b>' + smokeIntel.probableSource + '</b>';
      h+='</div>';

      // Evidence chain
      if (smokeIntel.evidenceChain.length > 0) {
        h+='<div style="margin-top:4px;padding-top:3px;border-top:1px solid rgba(255,255,255,.05);">';
        h+='<div style="font-size:.32rem;color:#888;font-weight:700;margin-bottom:2px;">EVIDENCE:</div>';
        smokeIntel.evidenceChain.forEach(function(ev) {
          h+='<div style="font-size:.32rem;color:#aaa;line-height:1.3;"> ' + ev + '</div>';
        });
        h+='</div>';
      }

      // Surface mixdown warning
      if (smokeIntel.surfaceMixdown) {
        h+='<div style="margin-top:4px;padding:3px 5px;background:rgba(255,153,0,.06);border-radius:3px;border-left:2px solid #f90;">';
        h+='<div style="font-size:.34rem;color:#f90;"> Smoke may be aloft overnight. Sunrise mixing will bring it to surface level  PM2.5 likely to spike in early morning.</div>';
        h+='</div>';
      }

      h+='</div>';
    }

    //  SMOKE ARRIVAL TIMELINE (from engine) 
    if (smokeIntel && smokeIntel.smokeArrivalTimeline.length >= 6) {
      var timeline = smokeIntel.smokeArrivalTimeline;
      var hasAnySmoke = timeline.some(function(s) { return s.upwindCount > 0; });
      var hasEvents = timeline.some(function(s) { return s.event; });

      if (hasAnySmoke || hasEvents) {
        h+='<div style="margin-bottom:6px;">';
        h+='<div style="font-size:.42rem;font-weight:700;color:#f97316;margin-bottom:3px;"> 24-HOUR SMOKE ARRIVAL TIMELINE</div>';

        // Bar chart  height = estimated PM2.5 contribution from fires
        var maxEst = Math.max.apply(null, timeline.map(function(s) { return s.pm25est; }).concat([20]));
        h+='<div style="position:relative;height:50px;background:rgba(0,0,0,.1);border-radius:4px;overflow:hidden;margin-bottom:2px;">';
        var slotW = 100 / timeline.length;
        timeline.forEach(function(slot, idx) {
          var barH = slot.pm25est > 0 ? Math.max(3, (slot.pm25est / maxEst) * 42) : 0;
          var barCol = slot.pm25est > 30 ? '#dc2626' : slot.pm25est > 15 ? '#f97316' : slot.pm25est > 5 ? '#fbbf24' : 'rgba(255,255,255,.05)';
          // Bar
          h+='<div style="position:absolute;left:' + (idx * slotW) + '%;width:' + (slotW * 0.85) + '%;bottom:14px;height:' + barH + 'px;background:' + barCol + ';border-radius:2px 2px 0 0;opacity:.7;"></div>';
          // Event markers
          if (slot.event === 'smoke_arrives') h+='<div style="position:absolute;left:' + (idx * slotW) + '%;top:0;font-size:.30rem;color:#f44;"></div>';
          if (slot.event === 'smoke_clears') h+='<div style="position:absolute;left:' + (idx * slotW) + '%;top:0;font-size:.30rem;color:#4f8;"></div>';
          // Upwind fire count dots
          if (slot.upwindCount > 0) {
            h+='<div style="position:absolute;left:calc(' + (idx * slotW + slotW / 2) + '% - 2px);bottom:8px;width:4px;height:4px;border-radius:50%;background:#f97316;"></div>';
          }
        });
        // Time labels
        h+='<div style="position:absolute;left:0;right:0;bottom:0;display:flex;">';
        timeline.forEach(function(slot, idx) {
          var show = idx % 3 === 0;
          var fHr = function(d) { var hh = d.getHours(); return (hh % 12 || 12) + (hh < 12 ? 'a' : 'p'); };
          h+='<div style="flex:1;text-align:center;font-size:.22rem;color:#444;">' + (show ? fHr(slot.time) : '') + '</div>';
        });
        h+='</div>';
        h+='</div>';

        // Legend + wind shift alerts
        h+='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:3px;">';
        h+='<div style="font-size:.26rem;color:#555;"> Smoke PM2.5 estimate</div>';
        h+='<div style="font-size:.26rem;color:#f44;"> Smoke arrives</div>';
        h+='<div style="font-size:.26rem;color:#4f8;"> Smoke clears</div>';
        h+='<div style="font-size:.26rem;color:#f97316;"> Fires upwind</div>';
        h+='</div>';

        // Wind shift alerts
        if (smokeIntel.windShiftAlerts.length > 0) {
          smokeIntel.windShiftAlerts.slice(0, 3).forEach(function(alert) {
            var aCol = alert.type === 'incoming' ? '#f44' : '#4f8';
            var fHr = function(d) { var hh = d.getHours(); return (hh % 12 || 12) + (hh < 12 ? 'a' : 'p'); };
            h+='<div style="font-size:.34rem;color:' + aCol + ';padding:2px 5px;background:rgba(255,255,255,.02);border-radius:3px;margin-bottom:1px;border-left:2px solid ' + aCol + ';">';
            h+=(alert.type === 'incoming' ? '' : '') + ' ' + alert.msg + ' (~' + fHr(alert.time) + ')';
            h+='</div>';
          });
        }

        h+='</div>';
      }
    }

    (function() {
      if (activeFireData.length === 0 && pm25Val <= 25) return;

      var fireCount = activeFireData.length;
      var wDirs16 = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      var windDeg = null;
      if (window._wxHourly && window._wxHourly.wind_direction_10m && window._wxNearestIdx != null) {
        windDeg = window._wxHourly.wind_direction_10m[window._wxNearestIdx];
      }
      var windSpd = wx.wind || 0;
      // Wind comes FROM this direction, so smoke arrives FROM upwind
      var windFromDir = windDeg != null ? wDirs16[Math.round(windDeg / 22.5) % 16] : null;
      // Fires upwind = fires in the direction wind is coming FROM
      var upwindBearing = windDeg != null ? windDeg : null; // direction TO look for upwind fires

      //  Categorize every fire by relationship to wind 
      var fireAnalysis = [];
      activeFireData.forEach(function(fire) {
        var coords = fire.geometry && fire.geometry.coordinates;
        if (!coords) return;
        var props = fire.properties || {};
        var fLat = coords[1], fLon = coords[0];
        var dLat = fLat - LOCATION.lat, dLon = fLon - LOCATION.lon;
        var dist = Math.sqrt(dLat * dLat + dLon * dLon) * 69;
        if (dist > 800) return;

        var bearing = Math.atan2(dLon, dLat) * 180 / Math.PI;
        if (bearing < 0) bearing += 360;
        var bearingDir = wDirs16[Math.round(bearing / 22.5) % 16];

        // Is this fire upwind?
        var isUpwind = false;
        var windAlignment = 'crosswind';
        if (upwindBearing != null) {
          var diff = Math.abs(bearing - upwindBearing);
          if (diff > 180) diff = 360 - diff;
          if (diff <= 35) { isUpwind = true; windAlignment = 'directly upwind'; }
          else if (diff <= 65) { windAlignment = 'partially upwind'; isUpwind = true; }
          else if (diff >= 135) { windAlignment = 'downwind'; }
          else { windAlignment = 'crosswind'; }
        }

        var name = props.IncidentName || props.FireName || 'Unnamed';
        var acres = props.DailyAcres || props.GISAcres || props.CalculatedAcres || 0;
        var contained = props.PercentContained || 0;
        var discovered = props.FireDiscoveryDateTime || props.CreateDate || null;
        var cause = props.FireCause || null;
        var type = props.IncidentTypeCategory || props.IncidentType || null;

        // Estimate transport time (hours) = distance / wind speed
        var transportHrs = windSpd > 0 ? dist / windSpd : null;

        // Smoke intensity estimate based on acres
        var smokeIntensity = acres > 50000 ? 'extreme' : acres > 10000 ? 'heavy' : acres > 1000 ? 'moderate' : 'light';

        fireAnalysis.push({
          name: name, lat: fLat, lon: fLon,
          dist: Math.round(dist), bearing: Math.round(bearing), bearingDir: bearingDir,
          acres: acres, contained: contained, discovered: discovered, cause: cause, type: type,
          isUpwind: isUpwind, windAlignment: windAlignment,
          transportHrs: transportHrs, smokeIntensity: smokeIntensity,
          country: props._country || 'US'
        });
      });

      // Sort: upwind first, then by distance
      fireAnalysis.sort(function(a, b) {
        if (a.isUpwind && !b.isUpwind) return -1;
        if (!a.isUpwind && b.isUpwind) return 1;
        return a.dist - b.dist;
      });

      var upwindFires = fireAnalysis.filter(function(f) { return f.isUpwind; });
      var nearFires = fireAnalysis.filter(function(f) { return f.dist < 300; });

      //  Smoke source fingerprint: is PM2.5 likely from fires or urban? 
      var pm25_pm10_ratio = (c.pm2_5 && c.pm10 && c.pm10 > 0) ? c.pm2_5 / c.pm10 : null;
      var isSmokeDominant = pm25_pm10_ratio != null && pm25_pm10_ratio > 0.7 && pm25Val > 20;
      var isDustDominant = pm25_pm10_ratio != null && pm25_pm10_ratio < 0.4;
      var no2_low = c.nitrogen_dioxide != null && c.nitrogen_dioxide < 15;
      var smokeFingerprint = isSmokeDominant && no2_low && upwindFires.length > 0;

      //  HMS Smoke status 
      var hmsStatus = null;
      if (document.querySelector('.smoke-status-pill')) {
        var pillText = document.querySelector('.smoke-status-pill').textContent || '';
        if (pillText.indexOf('HMS SMOKE') >= 0) hmsStatus = 'detected';
        else if (pillText.indexOf('DETECTED') >= 0) hmsStatus = 'active';
        else hmsStatus = 'clear';
      }

      //  Build the panel 
      var showPanel = fireCount > 0 || pm25Val > 25 || hmsStatus === 'detected' || hmsStatus === 'active';
      if (!showPanel) return;

      h+='<div style="margin-bottom:8px;">';
      h+='<div style="font-size:.42rem;font-weight:700;color:#f97316;margin-bottom:2px;"> FIRE & SMOKE TRANSPORT INTELLIGENCE</div>';

      //  Smoke source fingerprint 
      if (pm25Val > 15) {
        var fpCol, fpText, fpIcon;
        if (smokeFingerprint) {
          fpCol = '#f44'; fpIcon = '';
          fpText = 'PM2.5 signature consistent with <b>wildfire smoke</b>  high PM2.5:PM10 ratio (' + pm25_pm10_ratio.toFixed(2) + '), low NO (rules out traffic). ' + upwindFires.length + ' fire(s) upwind.';
        } else if (isSmokeDominant && upwindFires.length === 0) {
          fpCol = '#f90'; fpIcon = '';
          fpText = 'PM2.5 dominates (ratio ' + (pm25_pm10_ratio ? pm25_pm10_ratio.toFixed(2) : '?') + ') suggesting <b>fine-particle source</b>  combustion, distant smoke transport, or secondary aerosol formation. No major fires directly upwind.';
        } else if (isDustDominant) {
          fpCol = '#eab308'; fpIcon = '';
          fpText = 'PM10 dominates (ratio ' + (pm25_pm10_ratio ? pm25_pm10_ratio.toFixed(2) : '?') + ')  <b>dust or mechanical source</b> rather than combustion. Construction, agriculture, or soil erosion.';
        } else {
          fpCol = '#888'; fpIcon = '';
          fpText = 'Mixed source signature  PM2.5:PM10 ratio ' + (pm25_pm10_ratio ? pm25_pm10_ratio.toFixed(2) : 'N/A') + '. Combination of traffic, industry, and background aerosol.';
        }
        h+='<div style="padding:4px 7px;background:rgba(249,115,22,.04);border-radius:5px;border-left:2px solid ' + fpCol + ';margin-bottom:5px;">';
        h+='<div style="font-size:.38rem;color:' + fpCol + ';font-weight:700;">' + fpIcon + ' SOURCE FINGERPRINT</div>';
        h+='<div style="font-size:.36rem;color:#aaa;line-height:1.35;">' + fpText + '</div>';
        h+='</div>';
      }

      //  Wind vector / transport diagram 
      if (windFromDir && (upwindFires.length > 0 || fireCount > 0)) {
        h+='<div style="padding:4px 7px;background:rgba(255,255,255,.02);border-radius:5px;margin-bottom:5px;">';
        h+='<div style="font-size:.38rem;color:#78a0ff;font-weight:700;margin-bottom:3px;"> TRANSPORT VECTOR</div>';
        h+='<div style="font-size:.36rem;color:#aaa;line-height:1.35;">';
        h+='Wind from <b style="color:#ddd;">' + windFromDir + ' at ' + windSpd + ' mph</b>';
        if (upwindFires.length > 0) {
          h+='  <span style="color:#f44;font-weight:700;">' + upwindFires.length + ' fire(s) directly upwind</span>. ';
          h+='Smoke transport pathway is <b>active</b>.';
          // Transport time for nearest upwind fire
          var nearest = upwindFires[0];
          if (nearest.transportHrs != null) {
            h+='<br>Nearest upwind: <b>' + nearest.name + '</b> (' + nearest.dist + 'mi ' + nearest.bearingDir + ')';
            h+='  transit time  <b>' + (nearest.transportHrs < 1 ? Math.round(nearest.transportHrs * 60) + ' min' : nearest.transportHrs.toFixed(1) + ' hr') + '</b> at current wind.';
          }
        } else if (nearFires.length > 0) {
          h+='  fires are present but <span style="color:#4f8;">crosswind or downwind</span>. Smoke transport currently minimal.';
          h+='<br><span style="color:#f90;"> Wind shift would change exposure.</span> Monitor forecast for directional changes.';
        } else {
          h+='  no significant fires in the transport pathway within 800mi.';
        }
        h+='</div></div>';
      }

      //  Fire inventory table 
      if (fireAnalysis.length > 0) {
        var showCount = Math.min(fireAnalysis.length, 8);
        h+='<div style="margin-bottom:2px;">';
        var caFires = fireAnalysis.filter(function(f) { return f.country === 'CA'; });
        var countryBreak = caFires.length > 0 ? ' (' + (fireAnalysis.length - caFires.length) + ' US, ' + caFires.length + ' CA)' : '';
        h+='<div style="font-size:.36rem;color:#888;margin-bottom:2px;">' + fireCount + ' fires tracked' + countryBreak + '  ' + nearFires.length + ' within 300mi  ' + upwindFires.length + ' upwind</div>';

        fireAnalysis.slice(0, showCount).forEach(function(f) {
          var windBadge = f.isUpwind ?
            (f.windAlignment === 'directly upwind' ? '<span style="background:#f44;color:#fff;padding:0 3px;border-radius:2px;font-size:.26rem;font-weight:700;">UPWIND</span>' : '<span style="background:#f90;color:#fff;padding:0 3px;border-radius:2px;font-size:.26rem;font-weight:700;">PARTIAL</span>') :
            (f.windAlignment === 'downwind' ? '<span style="font-size:.26rem;color:#4f8;"> downwind</span>' : '<span style="font-size:.26rem;color:#888;"> cross</span>');

          var containColor = f.contained >= 80 ? '#4f8' : f.contained >= 40 ? '#f90' : '#f44';
          var acreColor = f.acres > 50000 ? '#f44' : f.acres > 10000 ? '#f97316' : f.acres > 1000 ? '#eab308' : '#888';
          var smokeIcon = f.smokeIntensity === 'extreme' ? '' : f.smokeIntensity === 'heavy' ? '' : f.smokeIntensity === 'moderate' ? '' : '';

          h+='<div style="display:grid;grid-template-columns:1fr auto auto auto;gap:4px;align-items:center;padding:3px 5px;background:rgba(249,115,22,' + (f.isUpwind ? '.06' : '.02') + ');border-radius:3px;margin-bottom:1px;' + (f.isUpwind ? 'border-left:2px solid #f97316;' : '') + '">';
          // Name + distance
          var countryFlag = f.country === 'CA' ? ' ' : f.country === 'SAT' ? ' ' : '';
          h+='<div>';
          h+='<div style="font-size:.36rem;color:#ddd;font-weight:' + (f.isUpwind ? '700' : '400') + ';">' + smokeIcon + ' ' + countryFlag + f.name + '</div>';
          h+='<div style="font-size:.28rem;color:#666;">' + f.dist + 'mi ' + f.bearingDir + (f.transportHrs != null && f.isUpwind ? '  ~' + (f.transportHrs < 1 ? Math.round(f.transportHrs * 60) + 'min transit' : f.transportHrs.toFixed(1) + 'hr transit') : '') + '</div>';
          h+='</div>';
          // Acres
          h+='<div style="text-align:right;">';
          if (f.acres > 0) h+='<div style="font-size:.34rem;color:' + acreColor + ';font-weight:700;">' + (f.acres >= 1000 ? (f.acres / 1000).toFixed(1) + 'K' : f.acres) + '</div>';
          h+='<div style="font-size:.24rem;color:#555;">acres</div>';
          h+='</div>';
          // Containment
          h+='<div style="text-align:right;">';
          h+='<div style="font-size:.34rem;color:' + containColor + ';font-weight:700;">' + f.contained + '%</div>';
          h+='<div style="font-size:.24rem;color:#555;">contained</div>';
          h+='</div>';
          // Wind badge
          h+='<div style="text-align:right;">' + windBadge + '</div>';
          h+='</div>';
        });

        if (fireAnalysis.length > showCount) {
          h+='<div style="font-size:.30rem;color:#555;text-align:center;margin-top:2px;">+ ' + (fireAnalysis.length - showCount) + ' more fires</div>';
        }
        h+='</div>';
      }

      //  Smoke forecast (wind shift analysis) 
      if (window._wxHourly && window._wxHourly.wind_direction_10m && window._wxHourly.windspeed_10m) {
        var hourly = window._wxHourly;
        var ni = window._wxNearestIdx || 0;
        var windShifts = [];
        for (var wi = ni; wi < Math.min(ni + 24, hourly.wind_direction_10m.length); wi++) {
          var futureWindDeg = hourly.wind_direction_10m[wi];
          var futureWindSpd = hourly.windspeed_10m[wi];
          if (futureWindDeg == null) continue;
          var futureFromDir = wDirs16[Math.round(futureWindDeg / 22.5) % 16];
          var futureTime = new Date(hourly.time[wi]);
          var hrsFromNow = Math.round((futureTime - new Date()) / 3600000);
          if (hrsFromNow < 1) continue;

          // Check if any fire becomes upwind with new wind direction
          var wouldBeUpwind = 0;
          fireAnalysis.forEach(function(f) {
            var diff = Math.abs(f.bearing - futureWindDeg);
            if (diff > 180) diff = 360 - diff;
            if (diff <= 45) wouldBeUpwind++;
          });

          // Detect shift from current
          var currentUpwindCount = upwindFires.length;
          if (wouldBeUpwind > currentUpwindCount && wouldBeUpwind > 0) {
            windShifts.push({ hr: hrsFromNow, dir: futureFromDir, spd: Math.round(futureWindSpd), upwindCount: wouldBeUpwind, time: futureTime });
          }
          if (wouldBeUpwind === 0 && currentUpwindCount > 0 && windShifts.length === 0) {
            windShifts.push({ hr: hrsFromNow, dir: futureFromDir, spd: Math.round(futureWindSpd), upwindCount: 0, clears: true, time: futureTime });
          }
        }

        if (windShifts.length > 0) {
          var fmtHr = function(d) { var hh = d.getHours(); return (hh % 12 || 12) + (hh < 12 ? 'a' : 'p'); };
          h+='<div style="padding:4px 7px;background:rgba(255,153,0,.04);border-radius:5px;margin-bottom:5px;border-left:2px solid #f90;">';
          h+='<div style="font-size:.38rem;color:#f90;font-weight:700;"> SMOKE FORECAST</div>';
          windShifts.slice(0, 3).forEach(function(ws) {
            if (ws.clears) {
              h+='<div style="font-size:.36rem;color:#4f8;line-height:1.3;">Wind shifts to <b>' + ws.dir + '</b> (~' + fmtHr(ws.time) + ', +' + ws.hr + 'hr) at ' + ws.spd + ' mph  <b>moves fire(s) out of transport path</b>. Smoke should clear.</div>';
            } else {
              h+='<div style="font-size:.36rem;color:#f44;line-height:1.3;"> Wind shifts to <b>' + ws.dir + '</b> (~' + fmtHr(ws.time) + ', +' + ws.hr + 'hr)  <b>' + ws.upwindCount + ' fire(s) enter upwind path</b>. Expect PM2.5 increase.</div>';
            }
          });
          h+='</div>';
        }
      }

      //  HMS satellite smoke detection status 
      if (hmsStatus) {
        var hmsCol = hmsStatus === 'active' ? '#f44' : hmsStatus === 'detected' ? '#f90' : '#4f8';
        var hmsText = hmsStatus === 'active' ? 'Active smoke plumes detected by NOAA satellites' : hmsStatus === 'detected' ? 'HMS satellite analysis shows smoke in region' : 'No satellite-detected smoke in region';
        h+='<div style="display:flex;gap:6px;align-items:center;padding:3px 6px;background:rgba(255,255,255,.02);border-radius:4px;margin-bottom:3px;">';
        h+='<div style="font-size:.36rem;color:' + hmsCol + ';font-weight:700;"> SATELLITE: ' + (hmsStatus === 'clear' ? 'CLEAR' : 'SMOKE DETECTED') + '</div>';
        h+='<div style="font-size:.32rem;color:#888;">' + hmsText + '</div>';
        h+='</div>';

        // HRRR smoke model note
        h+='<div style="font-size:.32rem;color:#555;padding:2px 6px;">NWS Surface + Column smoke forecasts and HMS satellite polygons visible on the Wildfires map widget. Toggle SFC/COL/HMS layers to compare.</div>';
      }

      //  Smoke aloft detection (surface vs column comparison) 
      if (smokeIntel && smokeIntel.smokeAloft && smokeIntel.aloftDetail) {
        h+='<div style="padding:5px 7px;background:rgba(139,92,246,.05);border-radius:5px;border-left:2px solid #8b5cf6;margin-bottom:2px;">';
        h+='<div style="font-size:.40rem;font-weight:700;color:#8b5cf6;"> SMOKE ALOFT  NOT YET AT SURFACE</div>';
        h+='<div style="font-size:.34rem;color:#aaa;line-height:1.35;">' + smokeIntel.aloftDetail + '</div>';
        h+='<div style="font-size:.30rem;color:#555;margin-top:3px;">This is how Canadian smoke events develop: smoke travels at 5,000-15,000ft for 24-48hr, appearing in satellite/column data before reaching ground level. Compare COL vs SFC layers on the fire map to visualize the altitude difference.</div>';
        h+='</div>';
      }

      //  Upper-level wind transport analysis 
      if (smokeIntel && smokeIntel.upperWindAnalysis) {
        var uwa = smokeIntel.upperWindAnalysis;
        h+='<div style="padding:5px 7px;background:rgba(59,130,246,.03);border-radius:5px;border-left:2px solid #3b82f6;margin-bottom:2px;">';
        h+='<div style="font-size:.40rem;font-weight:700;color:#3b82f6;margin-bottom:3px;"> UPPER-LEVEL WIND TRANSPORT</div>';

        // Wind profile table
        h+='<div style="display:grid;grid-template-columns:auto 1fr 1fr;gap:2px 8px;font-size:.32rem;margin-bottom:3px;">';
        h+='<div style="color:#555;font-weight:600;">Level</div><div style="color:#555;font-weight:600;">Direction</div><div style="color:#555;font-weight:600;">Speed</div>';
        if (uwa.w300) h+='<div style="color:#93c5fd;">300mb (30,000ft)</div><div style="color:#ddd;">' + uwa.w300.dir + '</div><div style="color:#ddd;">' + uwa.w300.spd + ' mph</div>';
        if (uwa.w500) h+='<div style="color:#60a5fa;">500mb (18,000ft)</div><div style="color:#ddd;">' + uwa.w500.dir + '</div><div style="color:#ddd;">' + uwa.w500.spd + ' mph</div>';
        if (uwa.w700) h+='<div style="color:#3b82f6;">700mb (10,000ft)</div><div style="color:#ddd;">' + uwa.w700.dir + '</div><div style="color:#ddd;">' + uwa.w700.spd + ' mph</div>';
        if (uwa.surface) h+='<div style="color:#f97316;">Surface (10m)</div><div style="color:#ddd;">' + uwa.surface.dir + '</div><div style="color:#ddd;">' + uwa.surface.spd + ' mph</div>';
        h+='</div>';

        // Wind direction divergence note
        if (uwa.surface && uwa.w700) {
          var sfcDir = uwa.surface.dir;
          var upperDir = uwa.w700.dir;
          if (sfcDir !== upperDir) {
            h+='<div style="font-size:.30rem;color:#60a5fa;margin-bottom:2px;">Wind direction differs between surface (' + sfcDir + ') and 700mb (' + upperDir + ')  smoke transport direction depends on plume altitude.</div>';
          }
        }

        // Distant fires upwind at upper levels
        if (uwa.upperUpwindFires && uwa.upperUpwindFires.length > 0) {
          h+='<div style="font-size:.34rem;color:#ef4444;font-weight:600;margin-top:2px;"> ' + uwa.upperUpwindFires.length + ' DISTANT FIRE(S) UPWIND AT ALTITUDE</div>';
          uwa.upperUpwindFires.slice(0, 4).forEach(function(f) {
            var flag = f.country === 'CA' ? ' ' : '';
            h+='<div style="font-size:.30rem;color:#aaa;padding:1px 0;">' + flag + '<b>' + f.name + '</b>  ' + f.dist + 'mi on ' + f.level + ' (' + f.windDir + ' at ' + f.windSpd + 'mph)';
            if (f.transitHrs) h+='  ~' + f.transitHrs + 'hr transit';
            h+='</div>';
          });
        }

        if (uwa.detail) h+='<div style="font-size:.30rem;color:#888;margin-top:2px;">' + uwa.detail + '</div>';
        h+='</div>';
      }

      //  Model validation alert 
      if (smokeIntel && smokeIntel.modelMiss && smokeIntel.modelMissDetail) {
        h+='<div style="padding:4px 7px;background:rgba(59,130,246,.04);border-radius:5px;border-left:2px solid #3b82f6;margin-bottom:2px;">';
        h+='<div style="font-size:.38rem;color:#3b82f6;font-weight:700;"> MODEL MISS DETECTED</div>';
        h+='<div style="font-size:.32rem;color:#aaa;line-height:1.35;">' + smokeIntel.modelMissDetail + '</div>';
        h+='<div style="font-size:.28rem;color:#555;margin-top:2px;">Toggle the PM. forecast layer on the fire map to compare the NWS model prediction against actual conditions.</div>';
        h+='</div>';
      }

      //  Dust vs Smoke discrimination 
      if (smokeIntel && smokeIntel.dustVsSmoke && smokeIntel.dustVsSmoke.classification !== 'unknown') {
        var dvs = smokeIntel.dustVsSmoke;
        var dvsColor = dvs.classification === 'wildfire_smoke' ? '#f97316' : dvs.classification === 'dust' ? '#d9a963' : dvs.classification === 'urban_pollution' ? '#888' : '#666';
        var dvsLabel = dvs.classification === 'wildfire_smoke' ? ' WILDFIRE SMOKE' : dvs.classification === 'dust' ? ' DUST' : dvs.classification === 'urban_pollution' ? ' URBAN' : ' MIXED';
        h+='<div style="padding:4px 7px;background:rgba(255,255,255,.02);border-radius:5px;border-left:2px solid ' + dvsColor + ';margin-bottom:2px;">';
        h+='<div style="display:flex;align-items:center;gap:6px;">';
        h+='<div style="font-size:.38rem;color:' + dvsColor + ';font-weight:700;">' + dvsLabel + '</div>';
        h+='<span style="font-size:.26rem;padding:1px 4px;border-radius:2px;background:' + dvsColor + '22;color:' + dvsColor + ';font-weight:600;">' + dvs.confidence + ' confidence</span>';
        h+='</div>';
        h+='<div style="font-size:.32rem;color:#aaa;line-height:1.35;">' + dvs.detail + '</div>';
        if (dvs.classification === 'dust') {
          h+='<div style="font-size:.28rem;color:#d9a963;margin-top:2px;">Toggle the DUST  layer on the fire map to see the NWS dust forecast overlay and confirm dust transport path.</div>';
        }
        h+='</div>';
      }

      //  Multi-day event history 
      if (smokeIntel && smokeIntel.pm25History && smokeIntel.pm25History.multiDay) {
        var hist = smokeIntel.pm25History;
        h+='<div style="padding:4px 7px;background:rgba(239,68,68,.03);border-radius:5px;border-left:2px solid #f97316;margin-bottom:2px;">';
        h+='<div style="font-size:.38rem;color:#f97316;font-weight:700;"> MULTI-DAY SMOKE EVENT</div>';
        h+='<div style="font-size:.32rem;color:#aaa;line-height:1.35;">' + hist.detail + '</div>';
        h+='<div style="font-size:.28rem;color:#555;margin-top:2px;">' + hist.readings + ' readings tracked over ' + hist.hours + ' hours. Smoke events detected in ' + hist.smokeEventHours + ' readings.</div>';
        h+='</div>';
      }

      //  Smoke health context 
      if (pm25Val > 35 && (smokeFingerprint || upwindFires.length > 0)) {
        h+='<div style="padding:4px 7px;background:rgba(239,68,68,.04);border-radius:5px;border-left:2px solid #f44;margin-top:4px;">';
        h+='<div style="font-size:.38rem;color:#f44;font-weight:700;"> SMOKE HEALTH ADVISORY</div>';
        h+='<div style="font-size:.34rem;color:#aaa;line-height:1.35;">';
        if (pm25Val > 150) {
          h+='Wildfire smoke at <b>hazardous levels</b>. PM2.5 contains toxic compounds (PAHs, VOCs, black carbon) beyond what AQI captures. ';
          h+='Smoke particles are ultrafine (< 1 m) and penetrate deep into lungs and bloodstream. ';
          h+='<b>Stay indoors with sealed windows and HEPA filtration. N95 masks essential if outdoors.</b>';
        } else if (pm25Val > 55) {
          h+='Smoke-impacted air  PM2.5 at ' + Math.round(pm25Val) + ' g/m is ' + (pm25Val / 5).toFixed(0) + ' WHO guideline. ';
          h+='Wildfire smoke particles are more toxic per unit mass than urban PM2.5 due to organic compounds. ';
          h+='Limit outdoor exposure. Sensitive groups (asthma, COPD, elderly, children) should remain indoors.';
        } else {
          h+='Moderate smoke influence detected. Healthy adults can do light outdoor activity but should avoid prolonged heavy exertion. ';
          h+='Smoke concentration often varies hour-to-hour as plumes shift  conditions may worsen without warning.';
        }
        h+='</div></div>';
      }

      h+='</div>';
    })();

    //  5. INDOOR AIR QUALITY TIPS 
    if (aqiVal > 100) {
      h+='<div style="margin-bottom:8px;">';
      h+='<div style="font-size:.42rem;font-weight:700;color:#9333ea;margin-bottom:3px;"> INDOOR PROTECTION</div>';
      h+='<div style="padding:4px 7px;background:rgba(147,51,234,.04);border-radius:5px;border-left:2px solid rgba(147,51,234,.4);">';
      var tips = [];
      tips.push('Close windows and exterior doors');
      if (aqiVal > 150) tips.push('Run HEPA air purifier on high (reduces PM2.5 by 50-80%)');
      if (aqiVal > 150) tips.push('Seal gaps around windows with tape or towels');
      tips.push('Set HVAC to recirculate (not fresh air intake)');
      if (aqiVal > 200) tips.push('Wear N95 mask if you must go outside');
      if (pm25Val > 55) tips.push('Avoid cooking with gas stove, vacuuming, or using candles  these add to indoor PM2.5');
      tips.push('Monitor indoor AQI with a sensor (PurpleAir, IQAir)  indoor levels can be 30-50% of outdoor without filtration');
      tips.forEach(function(tip) {
        h+='<div style="font-size:.34rem;color:#aaa;line-height:1.3;padding:1px 0;"> ' + tip + '</div>';
      });
      h+='</div>';
      h+='</div>';
    }

    //  6. AQI & VISIBILITY CROSS-REFERENCE 
    var visVal = wx.visibility;
    if (visVal != null && pm25Val > 20) {
      var visMi = visVal > 1609 ? (visVal / 1609).toFixed(1) + ' mi' : Math.round(visVal * 3.28) + ' ft';
      h+='<div style="margin-bottom:8px;">';
      h+='<div style="font-size:.42rem;font-weight:700;color:#78a0ff;margin-bottom:3px;"> VISIBILITY IMPACT</div>';
      h+='<div style="padding:3px 6px;background:rgba(100,140,255,.03);border-radius:4px;">';
      h+='<div style="font-size:.36rem;color:#aaa;">Current visibility: <b style="color:#ddd;">' + visMi + '</b>';
      if (visVal < 8000) {
        h+='  reduced by particulate scattering. ';
        if (pm25Val > 55) h+='At this PM2.5 level, fine particles scatter light like fog. Objects appear hazy even in "clear" conditions. Sunset/sunrise colors will be enhanced but details washed out.';
        else h+='Moderate haze reducing contrast. Photography affected  distant landscapes will lack sharpness.';
      } else {
        h+='  adequate despite elevated PM2.5. Larger particles and humidity are the primary visibility limiters.';
      }
      h+='</div>';
      h+='</div>';
      h+='</div>';
    }

    h+='</div>'; // close cross-pollination div

    // EPA scale
    h+='<div style="display:flex;gap:1px;height:5px;border-radius:3px;overflow:hidden;margin-top:8px;">';
    ['#22c55e','#eab308','#f97316','#ef4444','#9333ea','#7f1d1d'].forEach(function(cc){h+='<div style="flex:1;background:'+cc+';"></div>';});
    h+='</div>';
    h+='<div style="display:flex;justify-content:space-between;margin-top:1px;margin-bottom:3px;">';
    ['Good','Moderate','USG','Unhealthy','V.Unhlthy','Hazardous'].forEach(function(l){h+='<span style="font-size:.38rem;color:#666;text-align:center;flex:1;font-weight:600;">'+l+'</span>';});
    h+='</div>';
    h+='<div style="text-align:center;font-size:.4rem;color:#555;">Open-Meteo  CAMS  EPA  Hourly</div>';

    if(widgetModal&&widgetModalBody){
      clearModalAnimations();
      updateModalHeader('AIR QUALITY','EPA  Open-Meteo','https://air-quality-api.open-meteo.com/v1/air-quality?latitude=40.74&longitude=-73.99&current=us_aqi,pm2_5');
      widgetModalBody.className='widget-modal-body content-card';
      widgetModalBody.innerHTML='<div style="max-width:560px;margin:0 auto;">'+h+'</div>';
      positionModalAtViewport(widgetModal);
    }
  }

  /* =========================================================
     WEATHER LOAD (Open-Meteo)
     ========================================================= */
  function loadWeatherForLocation(loc){
    if (!locNameEl) return;

    setText(locNameEl, loc.name);

    var url =
      "https://api.open-meteo.com/v1/forecast" +
      "?latitude=" + loc.lat +
      "&longitude=" + loc.lon +
      "&timezone=" + encodeURIComponent(TZ) +
      "&temperature_unit=fahrenheit" +
      "&windspeed_unit=mph" +
      "&precipitation_unit=inch" +
      "&hourly=temperature_2m,apparent_temperature,relativehumidity_2m,dewpoint_2m,precipitation_probability,precipitation,cloudcover,windspeed_10m,windgusts_10m,wind_direction_10m,visibility,pressure_msl,uv_index,weathercode,snowfall,rain,cape,lifted_index,freezinglevel_height,soil_moisture_0_to_1cm,boundary_layer_height,shortwave_radiation,direct_radiation,cloud_cover_low,cloud_cover_mid,cloud_cover_high,windspeed_300hPa,winddirection_300hPa,windspeed_500hPa,winddirection_500hPa,windspeed_700hPa,winddirection_700hPa" +
      "&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,sunrise,sunset,uv_index_max,windspeed_10m_max,windgusts_10m_max,snowfall_sum,rain_sum,wind_direction_10m_dominant,showers_sum,et0_fao_evapotranspiration" +
      "&forecast_days=10";

    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try{
          var hourly = data && data.hourly;
          var daily  = data && data.daily;

          if (!hourly || !daily || !hourly.time || !daily.time){
            setText(condTextEl, "No data");
            return;
          }

          // Find nearest hour index
          var now = new Date();
          var nearestIndex = 0, minDiff = Infinity;
          for (var i=0;i<hourly.time.length;i++){
            var dt = new Date(hourly.time[i]);
            var diff = Math.abs(now - dt);
            if (diff < minDiff){ minDiff = diff; nearestIndex = i; }
          }

          // Current conditions
          var temp = Math.round(hourly.temperature_2m[nearestIndex]);
          setText(tempEl, temp + "");

          var feels = hourly.apparent_temperature && hourly.apparent_temperature[nearestIndex];
          var feelsVal = (typeof feels === "number" ? Math.round(feels) : temp);
          setText(feelsInlineEl, "Feels " + feelsVal + "");

          var rh = hourly.relativehumidity_2m && hourly.relativehumidity_2m[nearestIndex];
          setText(humidityEl, (typeof rh === "number" ? Math.round(rh) + "%" : "--"));

          var gust = hourly.windgusts_10m && hourly.windgusts_10m[nearestIndex];
          setText(gustsEl, (typeof gust === "number" ? Math.round(gust) + " mph" : "--"));

          var sp = hourly.pressure_msl && hourly.pressure_msl[nearestIndex];
          setText(pressureEl, (typeof sp === "number" ? (sp * 0.029529983).toFixed(2) + " inHg" : "--"));

          var uvNow = hourly.uv_index && hourly.uv_index[nearestIndex];
          setText(uvEl, (typeof uvNow === "number" ? uvNow.toFixed(1) : "--"));

          var windSpd = hourly.windspeed_10m && hourly.windspeed_10m[nearestIndex];
          setText(windEl, (typeof windSpd === "number" ? Math.round(windSpd) + " mph" : "--"));

          setText(locMetaEl, "Updated " + fmt12NoSuffixFromDate(now));
          if (tempEl) tempEl.style.opacity = "1";

          //  STORE GLOBALLY FOR TOOLTIP LIVE INSIGHTS 
          window._wxHourly = hourly;
          window._wxDaily = daily;
          window._wxNearestIdx = nearestIndex;
          window._wxCurrent = {
            temp: temp,
            feels: feelsVal,
            rh: typeof rh === "number" ? Math.round(rh) : null,
            wind: typeof windSpd === "number" ? Math.round(windSpd) : null,
            gust: typeof gust === "number" ? Math.round(gust) : null,
            pressure: typeof sp === "number" ? sp : null,
            uv: typeof uvNow === "number" ? uvNow : null,
            dewpoint: hourly.dewpoint_2m ? Math.round(hourly.dewpoint_2m[nearestIndex]) : null,
            cloudCover: hourly.cloudcover ? Math.round(hourly.cloudcover[nearestIndex]) : null,
            visibility: hourly.visibility ? hourly.visibility[nearestIndex] : null,
            precipProb: hourly.precipitation_probability ? hourly.precipitation_probability[nearestIndex] : null,
            precip: hourly.precipitation ? hourly.precipitation[nearestIndex] : null,
            snow: hourly.snowfall ? hourly.snowfall[nearestIndex] : null,
            rain: hourly.rain ? hourly.rain[nearestIndex] : null,
            weatherCode: hourly.weathercode ? hourly.weathercode[nearestIndex] : null,
            windDir: hourly.wind_direction_10m ? hourly.wind_direction_10m[nearestIndex] : null,
            hiToday: daily.temperature_2m_max ? Math.round(daily.temperature_2m_max[0]) : null,
            loToday: daily.temperature_2m_min ? Math.round(daily.temperature_2m_min[0]) : null,
            sunrise: daily.sunrise ? daily.sunrise[0] : null,
            sunset: daily.sunset ? daily.sunset[0] : null,
            //  NEW: Real atmospheric instability from API 
            cape: hourly.cape ? hourly.cape[nearestIndex] : null,
            liftedIndex: hourly.lifted_index ? hourly.lifted_index[nearestIndex] : null,
            freezingLevel: hourly.freezinglevel_height ? hourly.freezinglevel_height[nearestIndex] : null,
            soilMoisture: hourly.soil_moisture_0_to_1cm ? hourly.soil_moisture_0_to_1cm[nearestIndex] : null,
            pblHeight: hourly.boundary_layer_height ? hourly.boundary_layer_height[nearestIndex] : null,
            solarRad: hourly.shortwave_radiation ? hourly.shortwave_radiation[nearestIndex] : null,
            directRad: hourly.direct_radiation ? hourly.direct_radiation[nearestIndex] : null,
            cloudLow: hourly.cloud_cover_low ? hourly.cloud_cover_low[nearestIndex] : null,
            cloudMid: hourly.cloud_cover_mid ? hourly.cloud_cover_mid[nearestIndex] : null,
            cloudHigh: hourly.cloud_cover_high ? hourly.cloud_cover_high[nearestIndex] : null,
            //  TREND ENGINE: 1hr, 3hr, 6hr tendencies 
            pressureTrend: (function(){
              if (!hourly.pressure_msl || nearestIndex < 3) return null;
              var now3 = hourly.pressure_msl[nearestIndex];
              var ago3 = hourly.pressure_msl[nearestIndex - 3];
              if (typeof now3 !== 'number' || typeof ago3 !== 'number') return null;
              return +(now3 - ago3).toFixed(1);
            })(),
            pressureTrend1hr: (function(){
              if (!hourly.pressure_msl || nearestIndex < 1) return null;
              var n = hourly.pressure_msl[nearestIndex];
              var a = hourly.pressure_msl[nearestIndex - 1];
              if (typeof n !== 'number' || typeof a !== 'number') return null;
              return +(n - a).toFixed(2);
            })(),
            pressureTrend6hr: (function(){
              if (!hourly.pressure_msl || nearestIndex < 6) return null;
              var n = hourly.pressure_msl[nearestIndex];
              var a = hourly.pressure_msl[nearestIndex - 6];
              if (typeof n !== 'number' || typeof a !== 'number') return null;
              return +(n - a).toFixed(1);
            })(),
            tempTrend3hr: (function(){
              if (!hourly.temperature_2m || nearestIndex < 3) return null;
              var n = hourly.temperature_2m[nearestIndex];
              var a = hourly.temperature_2m[nearestIndex - 3];
              if (typeof n !== 'number' || typeof a !== 'number') return null;
              return +(n - a).toFixed(1);
            })(),
            dewpointTrend3hr: (function(){
              if (!hourly.dewpoint_2m || nearestIndex < 3) return null;
              var n = hourly.dewpoint_2m[nearestIndex];
              var a = hourly.dewpoint_2m[nearestIndex - 3];
              if (typeof n !== 'number' || typeof a !== 'number') return null;
              return +(n - a).toFixed(1);
            })(),
            windDirTrend3hr: (function(){
              if (!hourly.wind_direction_10m || nearestIndex < 3) return null;
              var n = hourly.wind_direction_10m[nearestIndex];
              var a = hourly.wind_direction_10m[nearestIndex - 3];
              if (typeof n !== 'number' || typeof a !== 'number') return null;
              var diff = n - a;
              if (diff > 180) diff -= 360;
              if (diff < -180) diff += 360;
              return Math.round(diff);
            })(),
            gustTrend3hr: (function(){
              if (!hourly.windgusts_10m || nearestIndex < 3) return null;
              var n = hourly.windgusts_10m[nearestIndex];
              var a = hourly.windgusts_10m[nearestIndex - 3];
              if (typeof n !== 'number' || typeof a !== 'number') return null;
              return +(n - a).toFixed(0);
            })(),
            capeTrend3hr: (function(){
              if (!hourly.cape || nearestIndex < 3) return null;
              var n = hourly.cape[nearestIndex];
              var a = hourly.cape[nearestIndex - 3];
              if (typeof n !== 'number' || typeof a !== 'number') return null;
              return Math.round(n - a);
            })(),
            //  NEXT 6HR LOOKAHEAD 
            next6hrMaxPrecipProb: (function(){
              if (!hourly.precipitation_probability) return null;
              var max = 0;
              for (var fi = nearestIndex; fi < Math.min(nearestIndex + 6, hourly.precipitation_probability.length); fi++){
                if (hourly.precipitation_probability[fi] > max) max = hourly.precipitation_probability[fi];
              }
              return max;
            })(),
            next6hrMaxGust: (function(){
              if (!hourly.windgusts_10m) return null;
              var max = 0;
              for (var fi = nearestIndex; fi < Math.min(nearestIndex + 6, hourly.windgusts_10m.length); fi++){
                if (hourly.windgusts_10m[fi] > max) max = hourly.windgusts_10m[fi];
              }
              return Math.round(max);
            })(),
            next6hrMinTemp: (function(){
              if (!hourly.temperature_2m) return null;
              var min = 999;
              for (var fi = nearestIndex; fi < Math.min(nearestIndex + 6, hourly.temperature_2m.length); fi++){
                if (hourly.temperature_2m[fi] < min) min = hourly.temperature_2m[fi];
              }
              return Math.round(min);
            })(),
            next6hrMaxTemp: (function(){
              if (!hourly.temperature_2m) return null;
              var max = -999;
              for (var fi = nearestIndex; fi < Math.min(nearestIndex + 6, hourly.temperature_2m.length); fi++){
                if (hourly.temperature_2m[fi] > max) max = hourly.temperature_2m[fi];
              }
              return Math.round(max);
            })(),
            //  TOMORROW'S OUTLOOK (daily index 1) 
            hiTomorrow: daily.temperature_2m_max && daily.temperature_2m_max.length > 1 ? Math.round(daily.temperature_2m_max[1]) : null,
            loTomorrow: daily.temperature_2m_min && daily.temperature_2m_min.length > 1 ? Math.round(daily.temperature_2m_min[1]) : null,
            precipProbTomorrow: daily.precipitation_probability_max && daily.precipitation_probability_max.length > 1 ? daily.precipitation_probability_max[1] : null,
            wxCodeTomorrow: daily.weathercode && daily.weathercode.length > 1 ? daily.weathercode[1] : null,
            snowTomorrow: daily.snowfall_sum && daily.snowfall_sum.length > 1 ? daily.snowfall_sum[1] : null,
            gustMaxTomorrow: daily.windgusts_10m_max && daily.windgusts_10m_max.length > 1 ? Math.round(daily.windgusts_10m_max[1]) : null,
            //  FRONTAL DETECTION (wind shift + pressure + temp divergence) 
            frontalSignature: (function(){
              if (!hourly.wind_direction_10m || !hourly.pressure_msl || !hourly.temperature_2m || nearestIndex < 3) return null;
              var wdNow = hourly.wind_direction_10m[nearestIndex];
              var wdAgo = hourly.wind_direction_10m[nearestIndex - 3];
              var pNow = hourly.pressure_msl[nearestIndex];
              var pAgo = hourly.pressure_msl[nearestIndex - 3];
              var tNow = hourly.temperature_2m[nearestIndex];
              var tAgo = hourly.temperature_2m[nearestIndex - 3];
              if ([wdNow,wdAgo,pNow,pAgo,tNow,tAgo].some(function(v){ return typeof v !== 'number'; })) return null;
              var wdShift = wdNow - wdAgo;
              if (wdShift > 180) wdShift -= 360;
              if (wdShift < -180) wdShift += 360;
              var pChange = pNow - pAgo;
              var tChange = tNow - tAgo;
              // Cold front: wind veers (clockwise) + pressure rises after drop + temp drops
              if (wdShift > 30 && pChange > 0.5 && tChange < -3) return 'cold_front_passage';
              // Approaching cold front: pressure falling + wind backing
              if (pChange < -1.5 && tChange > 0) return 'cold_front_approaching';
              // Warm front: wind backs or veers slightly + steady pressure + temp rises
              if (tChange > 3 && Math.abs(pChange) < 1 && wdShift > -20) return 'warm_front_passage';
              // Approaching warm front: gradual pressure drop + clouds/precip
              if (pChange < -1 && tChange > 1) return 'warm_front_approaching';
              // Dryline: dewpoint change without much temp change
              if (hourly.dewpoint_2m) {
                var tdNow = hourly.dewpoint_2m[nearestIndex];
                var tdAgo = hourly.dewpoint_2m[nearestIndex - 3];
                if (typeof tdNow === 'number' && typeof tdAgo === 'number' && Math.abs(tdNow - tdAgo) > 10 && Math.abs(tChange) < 3) return 'dryline';
              }
              return null;
            })()
          };

          // Today hi/lo
          var hi = daily.temperature_2m_max[0];
          var lo = daily.temperature_2m_min[0];
          var hiLoTextEl = document.getElementById("hilo-text");
          if (hiLoTextEl) hiLoTextEl.textContent = "High " + Math.round(hi) + " | Low " + Math.round(lo) + "";

          // Precip
          var precipProb = daily.precipitation_probability_max[0];

          var precipSum = (daily.precipitation_sum && daily.precipitation_sum[0] != null) ? daily.precipitation_sum[0] : 0;
          setText(precipAmtEl, precipSum >= 0.01 ? precipSum.toFixed(2) + " in" : (precipSum > 0 ? "MIN" : "0.00 in"));
          setText(forecastRowEl, (precipProb != null ? ("Max " + Math.round(precipProb) + "%") : "--"));

          // Weather icon/text (daily code)
          var c = iconForCode(daily.weathercode[0]);
          if (condIconEl) condIconEl.src = c.i;
          setText(condTextEl, c.t);

          // Sunrise/sunset
          var srIsoToday = daily.sunrise[0];
          var ssIsoToday = daily.sunset[0];

          // Render new combined timeline
          renderTimeline(hourly, daily, nearestIndex);

          // Render TODAY Timeline widget (v4/v5)
          // Fetch Kp data then render
          fetchKpDataForToday(function(kpData){
            renderTodayTimeline(hourly, daily, nearestIndex, kpData);
          });

          // 7-day chips
          if (forecast7El){
            function iconUrlForDaily(code){
              if (code === 0) return METEO_BASE + "clear-day.svg";
              if (code === 1 || code === 2) return METEO_BASE + "partly-cloudy-day.svg";
              if (code === 3) return METEO_BASE + "overcast.svg";
              if (code === 45 || code === 48) return METEO_BASE + "fog.svg";
              if (code === 51 || code === 53 || code === 55) return METEO_BASE + "drizzle.svg";
              if (code === 56 || code === 57) return METEO_BASE + "sleet.svg";
              if (code === 61 || code === 63 || code === 65) return METEO_BASE + "rain.svg";
              if (code === 66 || code === 67) return METEO_BASE + "sleet.svg";
              if (code === 71 || code === 73 || code === 75) return METEO_BASE + "snow.svg";
              if (code === 77) return METEO_BASE + "sleet.svg";
              if (code === 80 || code === 81 || code === 82) return METEO_BASE + "rain.svg";
              if (code === 85 || code === 86) return METEO_BASE + "snow.svg";
              if (code === 95 || code === 96 || code === 99) return METEO_BASE + "thunderstorms-rain.svg";
              return METEO_BASE + "not-available.svg";
            }
            var daysHtml = "";
            
            // Find today's index in the daily array
            var todayStr = new Date().toISOString().split('T')[0];
            var startIdx = 0;
            for (var i = 0; i < daily.time.length; i++) {
              if (daily.time[i] === todayStr) {
                startIdx = i;
                break;
              }
            }
            
            // Mobile: 3 days, Desktop: 7 days
            var isMobileForecast = window.innerWidth <= 768;
            var forecastDays = isMobileForecast ? 3 : 7;
            
            // Update title
            var forecastLabel = document.querySelector('.forecast7-label');
            if (forecastLabel) forecastLabel.textContent = forecastDays + ' DAY FORECAST';
            
            // Find week min/max for bar normalization
            var weekMin = Infinity, weekMax = -Infinity;
            for (var wi = startIdx; wi < startIdx + forecastDays && wi < daily.time.length; wi++){
              var wHi = daily.temperature_2m_max[wi];
              var wLo = daily.temperature_2m_min[wi];
              if (wLo < weekMin) weekMin = wLo;
              if (wHi > weekMax) weekMax = wHi;
            }
            var weekRange = weekMax - weekMin || 1;
            
            for (var dIdx = startIdx; dIdx < startIdx + forecastDays && dIdx < daily.time.length; dIdx++){
              var dayDate = new Date(daily.time[dIdx]);
var dayName = dayDate.toLocaleDateString([], { weekday:"short" }).toUpperCase() + " | " + dayDate.getDate();
              var maxT = Math.round(daily.temperature_2m_max[dIdx]);
              var minT = Math.round(daily.temperature_2m_min[dIdx]);
              // Compute daily feels-like high and low from hourly apparent_temperature
              var feelsLo = null, feelsHi = null;
              if (hourly && hourly.apparent_temperature && hourly.time) {
                var dayStr = daily.time[dIdx];
                var dayFeels = [];
                for (var hi = 0; hi < hourly.time.length; hi++) {
                  if (hourly.time[hi].substring(0,10) === dayStr) {
                    dayFeels.push(hourly.apparent_temperature[hi]);
                  }
                }
                if (dayFeels.length > 0) {
                  feelsLo = Math.round(Math.min.apply(null, dayFeels));
                  feelsHi = Math.round(Math.max.apply(null, dayFeels));
                }
              }
              var icUrl = iconUrlForDaily(daily.weathercode[dIdx]);
              
              // Bar position: left% = where lo sits in week range, width% = day's range
              var barLeft = ((daily.temperature_2m_min[dIdx] - weekMin) / weekRange * 100).toFixed(1);
              var barWidth = (((daily.temperature_2m_max[dIdx] - daily.temperature_2m_min[dIdx]) / weekRange) * 100).toFixed(1);
              if (parseFloat(barWidth) < 8) barWidth = "8"; // minimum visible width
              
              // Color: smooth continuous gradient blue  cyan  green  yellow  orange  red
              // Uses actual temperature mapped to color stops with linear interpolation
              function tempColor(t){
                // t: 0=coldest in week, 1=warmest in week
                // Color stops: 0=blue, 0.25=cyan, 0.5=green, 0.75=yellow, 1.0=red
                var stops = [
                  [0.00, 0,200,255],    // vivid cyan
                  [0.25, 0,255,130],    // vivid green
                  [0.50, 255,230,0],    // vivid yellow
                  [0.75, 255,120,0],    // vivid orange
                  [1.00, 255,30,60]     // vivid red
                ];
                t = Math.max(0, Math.min(1, t));
                var i = 0;
                for(var s = 0; s < stops.length - 1; s++){
                  if(t >= stops[s][0] && t <= stops[s+1][0]){ i = s; break; }
                }
                var range = stops[i+1][0] - stops[i][0];
                var frac = range > 0 ? (t - stops[i][0]) / range : 0;
                var r = Math.round(stops[i][1] + frac * (stops[i+1][1] - stops[i][1]));
                var g = Math.round(stops[i][2] + frac * (stops[i+1][2] - stops[i][2]));
                var b = Math.round(stops[i][3] + frac * (stops[i+1][3] - stops[i][3]));
                return 'rgb('+r+','+g+','+b+')';
              }
              var loWarmth = (daily.temperature_2m_min[dIdx] - weekMin) / weekRange;
              var hiWarmth = (daily.temperature_2m_max[dIdx] - weekMin) / weekRange;
              var barColor = tempColor(loWarmth) + ', ' + tempColor(hiWarmth);
              
              // Precipitation probability & type
              var precipProb = daily.precipitation_probability_max ? Math.round(daily.precipitation_probability_max[dIdx]) : 0;
              var precipSum = daily.precipitation_sum ? daily.precipitation_sum[dIdx] : 0;
              var snowSum = daily.snowfall_sum ? daily.snowfall_sum[dIdx] : 0;
              var rainSum = daily.rain_sum ? daily.rain_sum[dIdx] : 0;
              var showersSum = daily.showers_sum ? daily.showers_sum[dIdx] : 0;
              
              // Determine precip type and build string
              var precipStr = "";
              if (precipProb > 0) {
                var precipIcon = "";
                var precipType = "";
                var wcode = daily.weathercode[dIdx];
                var isThunder = (wcode === 95 || wcode === 96 || wcode === 99);
                if (isThunder) {
                  precipIcon = ""; precipType = "T-STORM";
                } else if (snowSum > 0 && snowSum >= rainSum) {
                  precipIcon = ""; precipType = "SNOW";
                } else if (showersSum > 0 && showersSum >= rainSum * 0.5) {
                  precipIcon = ""; precipType = "SHOWERS";
                } else if (rainSum > 0 || precipSum > 0) {
                  precipIcon = ""; precipType = "RAIN";
                } else if (snowSum > 0 && rainSum > 0) {
                  precipIcon = ""; precipType = "MIX";
                }
                precipStr = precipIcon + ' ' + precipProb + '%';
                if (precipType === "SNOW" && snowSum > 0) {
                  precipStr += '  ' + (snowSum < 0.1 ? 'TRACE' : snowSum.toFixed(1) + '"') + ' SNOW';
                } else if (precipType === "MIX" && snowSum > 0) {
                  precipStr += '  ' + snowSum.toFixed(1) + '" + ' + rainSum.toFixed(2) + '"';
                } else if (precipSum >= 0.01) {
                  precipStr += '  ' + precipSum.toFixed(2) + '"';
                  if (precipType) precipStr += ' ' + precipType;
                } else if (precipSum > 0 && precipSum < 0.01) {
                  precipStr += '  MIN';
                  if (precipType) precipStr += ' ' + precipType;
                } else if (precipType) {
                  precipStr += ' ' + precipType;
                }
              }
              
              // Wind with dominant direction
              var windMax = daily.windspeed_10m_max ? Math.round(daily.windspeed_10m_max[dIdx]) : null;
              var gustMax = daily.windgusts_10m_max ? Math.round(daily.windgusts_10m_max[dIdx]) : null;
              var windDir = daily.wind_direction_10m_dominant ? daily.wind_direction_10m_dominant[dIdx] : null;
              var windStr = "";
              if (windMax != null) {
                // Convert degrees to compass
                var dirStr = "";
                if (windDir != null) {
                  var dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
                  dirStr = dirs[Math.round(windDir / 22.5) % 16] + " ";
                }
                windStr = dirStr + windMax;
                if (gustMax != null && gustMax > windMax) {
                  windStr += " | " + gustMax;
                }
                windStr += " MPH";
              }
              
              // UV Index
              var uvMax = daily.uv_index_max ? Math.round(daily.uv_index_max[dIdx]) : null;
              var uvStr = "";
              var uvClass = "uv-low";
              if (uvMax != null && uvMax >= 0) {
                var uvLabel, uvIcon;
                if (uvMax <= 2) { uvLabel = "LOW"; uvClass = "uv-low"; uvIcon = ""; }
                else if (uvMax <= 5) { uvLabel = "MOD"; uvClass = "uv-mod"; uvIcon = ""; }
                else if (uvMax <= 7) { uvLabel = "HIGH"; uvClass = "uv-high"; uvIcon = ""; }
                else if (uvMax <= 10) { uvLabel = "V.HIGH"; uvClass = "uv-vhigh"; uvIcon = ""; }
                else { uvLabel = "EXTREME"; uvClass = "uv-extreme"; uvIcon = ""; }
                uvStr = uvIcon + " UV " + uvMax + " " + uvLabel;
              }
              
              daysHtml +=
                '<div class="forecast7-chip">' +
                  '<div class="day">'+dayName+'</div>' +
                  '<img class="icon" src="'+icUrl+'" alt="weather" />' +
                  '<div class="forecast7-bar-block">' +
  '<div class="bar-hi" style="margin-left:'+barLeft+'%; margin-right:'+(100 - parseFloat(barLeft) - parseFloat(barWidth)).toFixed(1)+'%;">' +
    (feelsHi !== null && feelsHi !== maxT ? '<span class="feels-hi">'+feelsHi+'</span>' : '') +
    '<span class="temps">'+maxT+'<span style="display:inline-block;width:0;overflow:visible;"></span></span>' +
  '</div>' +
  '<div class="forecast7-bar-wrap"><div class="forecast7-bar" style="left:'+barLeft+'%;width:'+barWidth+'%;background:linear-gradient(90deg,'+barColor+');"></div></div>' +
  '<div class="bar-lo" style="margin-left:'+barLeft+'%; margin-right:'+(100 - parseFloat(barLeft) - parseFloat(barWidth)).toFixed(1)+'%;">' +
    '<span class="forecast7-lo">'+minT+'</span>' +
    (feelsLo !== null && feelsLo !== minT ? '<span class="feels-lo">'+feelsLo+'</span>' : '') +
  '</div>' +
'</div>' +
                  (windStr ? '<div class="forecast7-wind">'+windStr+'</div>' : '') +
                  (uvStr ? '<div class="forecast7-uv '+uvClass+'">'+uvStr+'</div>' : '') +
                  (precipStr ? '<div class="forecast7-precip">'+precipStr+'</div>' : '') +
                '</div>';
            }
            forecast7El.innerHTML = daysHtml;
          }

          // Moon mini with NASA image
          var phaseFrac = approximateMoonPhase(new Date());
          var mi = moonInfo(phaseFrac);
          
          var moonImgEl = document.getElementById("moon-mini-img");
          if (moonImgEl){
            // Direct illumination-to-frame mapping for NASA SVS 2024 Moon dataset
            // Uses the January 2024 lunar cycle as our reference frames:
            // - New Moon (0%): frame 252 (Jan 11, 2024)
            // - First Quarter (50%): frame 430 (Jan 18, 2024)  
            // - Full Moon (100%): frame 607 (Jan 25, 2024)
            // - Last Quarter (50%): frame 785 (Feb 2, 2024)
            // - Back to New (0%): frame 961 (Feb 9, 2024)
            //
            // One lunar cycle = ~709 frames (29.53 days * 24 hours)
            // Waxing: frames 252-607 (new to full) = 355 frames for 0-100%
            // Waning: frames 607-961 (full to new) = 354 frames for 100-0%
            
            var isWaxing = phaseFrac < 0.5;
            var illumPct = mi.illum; // Use the already-calculated illumination percentage
            
            // NASA SVS 2024 Moon dataset frame mapping
            // After testing, the actual key frames in January 2024 cycle:
            // New Moon: ~frame 258 (Jan 11, 2024) - completely dark
            // Full Moon: ~frame 612 (Jan 25, 2024) - fully lit
            // Next New Moon: ~frame 966 (Feb 9, 2024)
            //
            // Waxing (new->full): frames 258-612, RIGHT side illuminates first
            // Waning (full->new): frames 612-966, LEFT side stays lit
            
            // NASA SVS Moon Phase datasets are HOURLY for the YEAR
            // Frame 1 = Jan 1 00:00 UTC, Frame 8760 = Dec 31 23:00 UTC
            // The frame number IS the hour of the year, not a phase position
            //
            // Reference from 2024 dataset testing (a005048):
            // - Frame 500 = new moon (~0%)
            // - Frame 562 = ~2-3% waxing crescent  
            // - Frame 580 = ~10-12%
            // - Frame 600 = ~20-25%
            // - Frame 4380 = full moon (100%)
            //
            // Use 2025 dataset (a005187) - 2026 dataset has issues
// Calculate frame based on phase position
// In 2025 dataset: frame 946 = new moon, frame 1300 = full moon
// One lunar cycle = ~709 frames
var newMoonFrame = 946;
var fullMoonFrame = 1300;
var lunarCycleFrames = 709;

// phaseFrac: 0 = new, 0.5 = full, 1 = new again
var frameOffset = Math.round(phaseFrac * lunarCycleFrames);
var frameNum = newMoonFrame + frameOffset;
if (frameNum > 8760) frameNum -= 8760;

var frameStr = String(frameNum).padStart(4, '0');
var moonUrl = "https://svs.gsfc.nasa.gov/vis/a000000/a005100/a005187/frames/730x730_1x1_30p/moon." + frameStr + ".jpg";
            
            moonImgEl.src = moonUrl;
            moonImgEl.onerror = function(){
              // On error, don't change the image - keep whatever was showing
              // This prevents jumping to wrong phase on temporary server errors
              this.onerror = null; // Prevent infinite loop
            };
          }
          
          var moonIllumEl = document.getElementById("moon-mini-illum");
          var moonPhaseEl = document.getElementById("moon-mini-phase");
          if (moonIllumEl) moonIllumEl.textContent = mi.illum + "%";
          if (moonPhaseEl) moonPhaseEl.textContent = mi.name;

          // Night window: sunset today -> sunrise tomorrow
          var ssLocal = new Date(ssIsoToday);
          var srIsoTomorrow = (daily.sunrise && daily.sunrise[1]) ? daily.sunrise[1] : daily.sunrise[0];
          var srLocal = new Date(srIsoTomorrow);

          // Update night sky title and cloud coverage
          var nightSkyCloudEl = document.getElementById("night-sky-cloud");
          var nightSkyConditionEl = document.getElementById("night-sky-condition");
          var moonPhaseDisplayEl = document.getElementById("moon-phase-display");
          var moonIllumDisplayEl = document.getElementById("moon-illum-display");
          var cloudLine = nightCloudLine(hourly, ssLocal, srLocal);
          
          if (cloudLine && cloudLine !== "--"){
            var cloudParts = cloudLine.split("  ");
            var condition = cloudParts[0] || "--";
            var coverage = cloudParts[1] || "--";
            
            if (nightSkyConditionEl) nightSkyConditionEl.textContent = condition;
            if (nightSkyCloudEl) nightSkyCloudEl.textContent = coverage;
          } else {
            if (nightSkyConditionEl) nightSkyConditionEl.textContent = "--";
            if (nightSkyCloudEl) nightSkyCloudEl.textContent = "--";
          }
          
          // Update moon info in night sky header
          if (moonPhaseDisplayEl) moonPhaseDisplayEl.textContent = mi.name;
          if (moonIllumDisplayEl) moonIllumDisplayEl.textContent = mi.illum + "%";

          // Space events bullets
          var now2 = new Date();
          var met = nextMeteorPeak(now2);
          var eclipse = nextEclipse(now2);
          var conj = nextConjunction(now2);
          var opp = nextOpposition(now2);

          // Hide/blank the big headline (your current intent)
          if (spaceEventsEl) spaceEventsEl.textContent = "";

          if (spaceEventsBulletsEl){
            var bullets = "";

            var nextFull = findNextMoonEvent(now2, 0.50, 40);
            var nextNew  = findNextMoonEvent(now2, 0.00, 40);

            // 1. NEXT NEW MOON (dark sky window)
            if (nextNew){
              var duN = daysUntil(now2, nextNew);
              bullets += bulletHtml(
                "NEXT NEW MOON",
                fmtMonthDay(nextNew),
                "In " + duN + "d  Darkest skies for deep-sky objects, galaxies, nebulae  Prime Milky Way window: " + dayRangeAround(nextNew, 4)
              );
            }

          

            // 2. NEXT CONJUNCTION
            if (conj){
              var duC = daysUntil(now2, conj.d);
              bullets += bulletHtml(
                "NEXT CONJUNCTION",
                fmtMonthDay(conj.d),
                conj.bodies + "  " + conj.separation + " apart  Look " + conj.direction + " at " + conj.time.toLowerCase() + "  In " + duC + "d  " + conj.note
              );
            }

            // 4. METEOR SHOWER PEAK
            if (met){
              var when = (met.days === 0 ? "Tonight" : (met.days === 1 ? "Tomorrow" : ("In " + met.days + "d")));
              var showerData = METEOR_SHOWERS.find(function(s){ return s.name === met.name; });
              var zhr = showerData ? showerData.zhr : "?";
              var speed = showerData ? Math.round(showerData.speed).toLocaleString() : "?";
              var direction = showerData ? showerData.direction : "?";
              var radiantRise = showerData ? showerData.radiantRise : "?";
              var bestView = showerData ? showerData.bestView : "After midnight";
              bullets += bulletHtml(
                "METEOR SHOWER PEAK",
                when,
                met.name + "  " + fmtMonthDay(met.start) + "  Up to " + zhr + "/hr  " + speed + " mph  Look " + direction + "  Radiant rises " + radiantRise + "  Best viewing: " + bestView
              );
            }

            // 5. NEXT ECLIPSE
            if (eclipse){
              bullets += bulletHtml(
                "NEXT ECLIPSE",
                fmtMonthDay(eclipse.d),
                eclipse.type + "  " + eclipse.note
              );
            }

            // 5.5 RECENT FIREBALL (fetched async, injected later)
            
            // 6. NEXT FULL MOON
            if (nextFull){
              var duF = daysUntil(now2, nextFull);
              bullets += bulletHtml(
                "NEXT FULL MOON",
                fmtMonthDay(nextFull),
                "In " + duF + "d  Rises at sunset, sets at sunrise  Peak illumination for lunar photography  Avoid deep-sky imaging " + dayRangeAround(nextFull, 3)
              );
            }

            // VOYAGER 1 TRACKER (bottom)
            (function(){
              // Voyager 1 reference: 163.7 AU on Jan 1, 2025 00:00 UTC
              var refDate = new Date(Date.UTC(2025, 0, 1, 0, 0, 0));
              var refDistanceMiles = 15215899826.1; // miles on Jan 1, 2025
              var speedMph = 38210.55; // precise speed in mph
              var launchDate = new Date(Date.UTC(1977, 8, 5, 12, 56, 0)); // Sept 5, 1977 12:56 UTC
              
              // Calculate current distance in miles (updated every second conceptually)
              var msSinceRef = now2.getTime() - refDate.getTime();
              var hoursSinceRef = msSinceRef / (1000 * 60 * 60);
              var currentMiles = refDistanceMiles + (hoursSinceRef * speedMph);
              
              // Format with commas
              var milesFormatted = Math.floor(currentMiles).toLocaleString();
              
              // AU conversion
              var currentAU = currentMiles / 92955807.3;
              
              // Light time delay
              var lightSeconds = currentAU * 499.004784;
              var lightHours = Math.floor(lightSeconds / 3600);
              var lightMins = Math.floor((lightSeconds % 3600) / 60);
              var lightTimeStr = lightHours + "h " + lightMins + "m";
              
              // Mission duration
              var missionMs = now2.getTime() - launchDate.getTime();
              var missionYears = Math.floor(missionMs / (1000 * 60 * 60 * 24 * 365.25));
              var missionMonths = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 365.25)) / (1000 * 60 * 60 * 24 * 30.44));
              var missionDays = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 30.44)) / (1000 * 60 * 60 * 24));
              var missionStr = missionYears + "y " + missionMonths + "m " + missionDays + "d";
              
              bullets += bulletHtml(
                "VOYAGER 1",
                missionStr + " in flight",
                "Interstellar space  Local Interstellar Cloud  " + milesFormatted + " mi  Light delay " + lightTimeStr + "  " + speedMph.toLocaleString() + " mph"
              );
            })();

            spaceEventsBulletsEl.innerHTML = bullets;
            
            // ISS LIVE TRACKER with next pass estimation
            (function(){
              var issApiUrl = "https://api.wheretheiss.at/v1/satellites/25544";
              
              function haversineMi(lat1, lon1, lat2, lon2){
                var R = 3959;
                var dLat = (lat2-lat1)*Math.PI/180;
                var dLon = (lon2-lon1)*Math.PI/180;
                var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
                        Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
                        Math.sin(dLon/2)*Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              }
              
              function bearingDir(lat1, lon1, lat2, lon2){
                var y = Math.sin((lon2-lon1)*Math.PI/180)*Math.cos(lat2*Math.PI/180);
                var x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) -
                        Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos((lon2-lon1)*Math.PI/180);
                var b = Math.atan2(y,x)*180/Math.PI;
                if(b<0)b+=360;
                var dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
                return dirs[Math.round(b/22.5)%16];
              }
              
              var ORBIT_PERIOD_MIN = 92.68;
              var ISS_INCL = 51.6;
              
              fetch(issApiUrl)
                .then(function(r){ return r.json(); })
                .then(function(data){
                  var issLat = data.latitude;
                  var issLon = data.longitude;
                  var issAlt = Math.round(data.altitude * 0.621371); // km to miles
                  var issSpeed = Math.round(data.velocity * 0.621371); // km/h to mph
                  var visibility = data.visibility; // "daylight", "eclipsed", "penumbra"
                  
                  var groundDist = Math.round(haversineMi(LOCATION.lat, LOCATION.lon, issLat, issLon));
                  var totalDist = Math.round(Math.sqrt(groundDist*groundDist + issAlt*issAlt));
                  var dirStr = bearingDir(LOCATION.lat, LOCATION.lon, issLat, issLon);
                  
                  // Estimate next close pass using orbital mechanics
                  var userLat = LOCATION.lat;
                  var userLon = LOCATION.lon;
                  var bestPassMin = null;
                  var bestPassDist = Infinity;
                  
                  for(var orbit = 0; orbit < 48; orbit++){
                    var tMin = orbit * ORBIT_PERIOD_MIN;
                    var lonShiftPerOrbit = -22.5;
                    var currentPhase = Math.asin(Math.max(-1, Math.min(1, issLat / ISS_INCL)));
                    
                    for(var frac = 0; frac < 1; frac += 0.05){
                      var tCheck = tMin + frac * ORBIT_PERIOD_MIN;
                      var futLat = ISS_INCL * Math.sin(currentPhase + 2 * Math.PI * tCheck / ORBIT_PERIOD_MIN);
                      var futLon = issLon + (lonShiftPerOrbit * tCheck / ORBIT_PERIOD_MIN);
                      while(futLon > 180) futLon -= 360;
                      while(futLon < -180) futLon += 360;
                      
                      var dist = haversineMi(userLat, userLon, futLat, futLon);
                      if(dist < bestPassDist && tCheck > 5){
                        bestPassDist = dist;
                        bestPassMin = tCheck;
                      }
                    }
                  }
                  
                  // Format next pass estimate
                  var passStr = "";
                  if(bestPassMin !== null && bestPassDist < 800){
                    var passTime = new Date(Date.now() + bestPassMin * 60000);
                    var h = passTime.getHours();
                    var m = passTime.getMinutes();
                    var ampm = h >= 12 ? "PM" : "AM";
                    var hh = h % 12; if(hh === 0) hh = 12;
                    var timeStr = hh + ":" + (m < 10 ? "0"+m : m) + " " + ampm;
                    
                    var hoursUntil = Math.floor(bestPassMin / 60);
                    var minsUntil = Math.round(bestPassMin % 60);
                    var untilStr = hoursUntil > 0 ? (hoursUntil + "h " + minsUntil + "m") : (minsUntil + "m");
                    
                    passStr = "  NEXT PASS ~" + timeStr + " (in ~" + untilStr + ")";
                  } else if(bestPassMin !== null){
                    var hoursUntil2 = Math.floor(bestPassMin / 60);
                    var minsUntil2 = Math.round(bestPassMin % 60);
                    var untilStr2 = hoursUntil2 > 0 ? (hoursUntil2 + "h " + minsUntil2 + "m") : (minsUntil2 + "m");
                    passStr = "  NEXT PASS in ~" + untilStr2;
                  }
                  
                  var isNearby = groundDist < 500;
                  var statusStr = isNearby ? " NEARBY  LOOK UP!" : (totalDist.toLocaleString() + " mi " + dirStr);
                  
                  var issBullet = bulletHtml(
                    "ISS TRACKER",
                    statusStr,
                    "Alt " + issAlt + " mi  " + issSpeed.toLocaleString() + " mph  " + visibility + passStr
                  );
                  
                  if(spaceEventsBulletsEl){
                    spaceEventsBulletsEl.innerHTML += issBullet;
                  }
                })
                .catch(function(err){
                  console.log("ISS tracker error:", err);
                });
            })();
          }

          // Night sky SVG (windows + cloud series)
          if (nightSkySvg){
            var bodies = ["moon","mercury","venus","mars","jupiter","saturn","uranus","neptune"];
            var startObs2 = new Date(ssLocal.getTime());
            var endObs2 = new Date(srLocal.getTime());
            if (endObs2 <= startObs2) endObs2 = new Date(startObs2.getTime() + 10*60*60*1000);

            var windows = computeVisibilityWindows(startObs2, endObs2, bodies, LOCATION.lat, LOCATION.lon);

            var nameMap = {
              moon:"Moon", mercury:"Mercury", venus:"Venus", mars:"Mars",
              jupiter:"Jupiter", saturn:"Saturn", uranus:"Uranus", neptune:"Neptune"
            };

            var show = {};
            for (var p in windows){
              if (!windows[p]) continue;
              var label = nameMap[p] || p;
              var w = windows[p];
              show[label] = {
                any: !!w.any,
                first: w.first || null,
                last: w.last || null,
                segments: w.segments || []
              };
            }

            var cloudSeries = [];
            if (hourly && hourly.time && hourly.cloudcover){
              for (var ci=0; ci<hourly.time.length; ci++){
                var dtc = new Date(hourly.time[ci]);
                if (dtc >= startObs2 && dtc <= endObs2){
                  var cc = hourly.cloudcover[ci];
                  if (typeof cc === "number" && isFinite(cc)){
                    cloudSeries.push({ t: dtc, cc: clamp(cc, 0, 100) });
                  }
                }
              }
            }

            // Fetch Kp data for aurora bar
            fetchKpDataForNight(startObs2, endObs2, function(kpSeries){
              drawNightSkyBar(nightSkySvg, nightSkyLegend, startObs2, endObs2, show, cloudSeries, kpSeries);
            });
          }

        } catch(e){
          console.error("Weather parse error", e);
          setText(condTextEl, "Data error");
        }
      })
      .catch(function(err){
        console.error("Weather load error", err);
        setText(condTextEl, "Network error");
      });
  }

  // 
  // UPSTREAM WEATHER INTELLIGENCE SCANNER
  // Fetches current conditions at upwind points to track approaching
  // weather systems. Uses hourly forecast curve-shape analysis to
  // detect incoming fronts, precipitation shields, and wind events.
  // 
  function scanUpstreamWeather() {
    if (!LOCATION || !LOCATION.lat || !LOCATION.lon) return;
    var wx = window._wxCurrent;
    if (!wx) return;
    var h = window._wxHourly;
    var ni = window._wxNearestIdx;
    if (!h || ni == null) return;

    //  PART 1: FORECAST TIMELINE ANALYSIS 
    // The hourly forecast IS the storm track through your location.
    // Scan the next 48 hours for regime changes.
    var timeline = [];
    var scanHours = Math.min(48, h.time.length - ni);
    for (var i = 0; i < scanHours; i++) {
      var idx = ni + i;
      timeline.push({
        hr: i,
        time: h.time[idx],
        temp: h.temperature_2m ? h.temperature_2m[idx] : null,
        dp: h.dewpoint_2m ? h.dewpoint_2m[idx] : null,
        wind: h.windspeed_10m ? h.windspeed_10m[idx] : null,
        wdir: h.wind_direction_10m ? h.wind_direction_10m[idx] : null,
        gust: h.windgusts_10m ? h.windgusts_10m[idx] : null,
        press: h.pressure_msl ? h.pressure_msl[idx] : null,
        precip: h.precipitation ? h.precipitation[idx] : null,
        precipProb: h.precipitation_probability ? h.precipitation_probability[idx] : null,
        cloud: h.cloudcover ? h.cloudcover[idx] : null,
        cloudLow: h.cloud_cover_low ? h.cloud_cover_low[idx] : null,
        cloudMid: h.cloud_cover_mid ? h.cloud_cover_mid[idx] : null,
        cloudHigh: h.cloud_cover_high ? h.cloud_cover_high[idx] : null,
        rh: h.relativehumidity_2m ? h.relativehumidity_2m[idx] : null,
        cape: h.cape ? h.cape[idx] : null,
        code: h.weathercode ? h.weathercode[idx] : null,
        snow: h.snowfall ? h.snowfall[idx] : null
      });
    }
    if (timeline.length < 6) return;

    //  Detect incoming events by scanning timeline 
    var events = [];
    var currentPress = timeline[0].press;
    var currentTemp = timeline[0].temp;
    var currentWdir = timeline[0].wdir;
    var precipStarted = timeline[0].precip > 0.01;
    var stormPeakHr = null, stormPeakGust = 0;
    var pressMinHr = null, pressMin = 9999;
    var pressMaxDropRate = 0, pressMaxDropHr = null;
    var tempDropMax = 0, tempDropHr = null;
    var tempRiseMax = 0, tempRiseHr = null;
    var firstPrecipHr = null, precipEndHr = null;
    var firstSnowHr = null;
    var maxCapeHr = null, maxCape = 0;
    var windShiftHr = null, windShiftMagnitude = 0;
    var clearingHr = null;

    for (var j = 1; j < timeline.length; j++) {
      var t = timeline[j];
      var prev = timeline[j - 1];

      // Pressure minimum (low center passage)
      if (t.press != null && t.press < pressMin) {
        pressMin = t.press;
        pressMinHr = j;
      }

      // Pressure drop rate (approaching system intensity)
      if (t.press != null && currentPress != null) {
        var dropRate = currentPress - t.press;
        if (dropRate > pressMaxDropRate && j <= 24) {
          pressMaxDropRate = dropRate;
          pressMaxDropHr = j;
        }
      }

      // Temperature drops (cold front)
      if (t.temp != null && currentTemp != null) {
        var tempDrop = currentTemp - t.temp;
        if (tempDrop > tempDropMax) { tempDropMax = tempDrop; tempDropHr = j; }
        var tempRise = t.temp - currentTemp;
        if (tempRise > tempRiseMax) { tempRiseMax = tempRise; tempRiseHr = j; }
      }

      // First precipitation
      if (t.precip > 0.01 && firstPrecipHr == null && !precipStarted) {
        firstPrecipHr = j;
      }
      // Precip end
      if (t.precip <= 0.01 && prev.precip > 0.01 && firstPrecipHr != null && precipEndHr == null) {
        precipEndHr = j;
      }

      // First snow
      if (t.snow > 0 && firstSnowHr == null) { firstSnowHr = j; }

      // Peak gusts
      if (t.gust != null && t.gust > stormPeakGust) {
        stormPeakGust = t.gust;
        stormPeakHr = j;
      }

      // Max CAPE
      if (t.cape != null && t.cape > maxCape) {
        maxCape = t.cape;
        maxCapeHr = j;
      }

      // Wind direction shift (frontal passage marker)
      if (t.wdir != null && currentWdir != null && j <= 24) {
        var shift = t.wdir - currentWdir;
        if (shift > 180) shift -= 360;
        if (shift < -180) shift += 360;
        if (Math.abs(shift) > windShiftMagnitude) {
          windShiftMagnitude = Math.abs(shift);
          windShiftHr = j;
        }
      }

      // Clearing after precip
      if (t.cloud != null && t.cloud < 30 && prev.cloud >= 50 && clearingHr == null && j > 3) {
        clearingHr = j;
      }
    }

    //  Cloud layer transition detection (warm front approach) 
    var cloudTransition = null;
    if (timeline.length > 12) {
      // Check if high clouds build well before mid/low  classic warm front sequence
      var highBuildHr = null, midBuildHr = null, lowBuildHr = null;
      for (var ct = 1; ct < Math.min(24, timeline.length); ct++) {
        if (timeline[ct].cloudHigh > 50 && timeline[0].cloudHigh < 30 && highBuildHr == null) highBuildHr = ct;
        if (timeline[ct].cloudMid > 50 && timeline[0].cloudMid < 30 && midBuildHr == null) midBuildHr = ct;
        if (timeline[ct].cloudLow > 50 && timeline[0].cloudLow < 30 && lowBuildHr == null) lowBuildHr = ct;
      }
      if (highBuildHr != null && midBuildHr != null && highBuildHr < midBuildHr) {
        cloudTransition = {
          type: 'warm_front_clouds',
          highHr: highBuildHr,
          midHr: midBuildHr,
          lowHr: lowBuildHr,
          leadTime: midBuildHr - highBuildHr
        };
      }
    }

    //  Cloud clearing window detection (for astronomy/outdoor) 
    var clearWindow = null;
    if (timeline.length > 6) {
      var inClear = false, clearStart = null;
      for (var cw = 0; cw < timeline.length; cw++) {
        if (timeline[cw].cloud < 25 && !inClear) {
          inClear = true; clearStart = cw;
        } else if (timeline[cw].cloud >= 40 && inClear) {
          if (clearStart != null && (cw - clearStart) >= 2) {
            clearWindow = { start: clearStart, end: cw, duration: cw - clearStart };
          }
          inClear = false; clearStart = null;
        }
      }
      // If still clear at end of scan
      if (inClear && clearStart != null && (timeline.length - clearStart) >= 2) {
        clearWindow = { start: clearStart, end: timeline.length - 1, duration: timeline.length - clearStart };
      }
    }

    //  Build event detections 
    function fmtHr(hr) {
      var dt = new Date(timeline[hr].time);
      var h12 = dt.getHours() % 12 || 12;
      var ampm = dt.getHours() < 12 ? 'AM' : 'PM';
      var day = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dt.getDay()];
      return day + ' ' + h12 + ampm;
    }
    function fmtEta(hr) {
      if (hr < 1) return 'NOW';
      if (hr === 1) return '~1 hour';
      if (hr < 24) return '~' + hr + ' hours';
      return '~' + (hr / 24).toFixed(1) + ' days';
    }

    // APPROACHING LOW / CYCLONE
    if (pressMinHr != null && pressMaxDropRate > 3 && pressMinHr <= 36) {
      events.push({
        type: 'cyclone',
        severity: pressMaxDropRate > 8 ? 'major' : pressMaxDropRate > 5 ? 'significant' : 'moderate',
        icon: '',
        title: (pressMaxDropRate > 8 ? 'MAJOR ' : '') + 'LOW PRESSURE SYSTEM',
        detail: 'Pressure drops ' + pressMaxDropRate.toFixed(1) + ' mb over ' + pressMaxDropHr + 'hr, bottoming at ' + Math.round(pressMin) + ' mb around ' + fmtHr(pressMinHr) + '. ' +
          (pressMaxDropRate > 8 ? 'Rapid cyclogenesis ("bomb cyclone")  widespread high winds + heavy precip.' :
           pressMaxDropRate > 5 ? 'Strong system  significant wind and precipitation likely.' :
           'Moderate system passage.'),
        eta: fmtEta(pressMaxDropHr),
        etaHr: pressMaxDropHr
      });
    }

    // COLD FRONT PASSAGE
    if (tempDropMax >= 8 && windShiftMagnitude > 40 && tempDropHr <= 36) {
      var cfHr = Math.min(tempDropHr, windShiftHr || tempDropHr);
      events.push({
        type: 'cold_front',
        severity: tempDropMax >= 20 ? 'major' : tempDropMax >= 12 ? 'significant' : 'moderate',
        icon: '',
        title: 'COLD FRONT',
        detail: 'Temperature drops ' + Math.round(tempDropMax) + 'F by ' + fmtHr(tempDropHr) + ' with ' + Math.round(windShiftMagnitude) + ' wind shift. ' +
          (tempDropMax >= 20 ? 'Arctic front  dramatic temperature plunge.' :
           tempDropMax >= 12 ? 'Strong cold front with gusty winds and clearing.' :
           'Moderate frontal passage.') +
          (stormPeakGust > 40 ? ' Peak gusts ' + Math.round(stormPeakGust) + ' mph near frontal passage.' : ''),
        eta: fmtEta(cfHr),
        etaHr: cfHr
      });
    }

    // WARM FRONT / WARMING
    if (tempRiseMax >= 10 && tempRiseHr <= 24) {
      events.push({
        type: 'warm_front',
        severity: tempRiseMax >= 20 ? 'significant' : 'moderate',
        icon: '',
        title: 'WARM ADVECTION',
        detail: 'Temperature rises ' + Math.round(tempRiseMax) + 'F by ' + fmtHr(tempRiseHr) + '. ' +
          'Warm sector air arrives  watch for instability if dewpoints also rise.',
        eta: fmtEta(tempRiseHr),
        etaHr: tempRiseHr
      });
    }

    // PRECIPITATION ONSET
    if (firstPrecipHr != null && firstPrecipHr > 0 && firstPrecipHr <= 36) {
      var precipDuration = precipEndHr ? (precipEndHr - firstPrecipHr) : null;
      var precipType = firstSnowHr != null && firstSnowHr <= firstPrecipHr + 3 ? 'snow' : 'rain';
      var totalPrecip = 0;
      for (var p = firstPrecipHr; p < Math.min(precipEndHr || timeline.length, timeline.length); p++) {
        totalPrecip += timeline[p].precip || 0;
      }
      events.push({
        type: 'precip_onset',
        severity: totalPrecip > 1 ? 'significant' : totalPrecip > 0.25 ? 'moderate' : 'minor',
        icon: precipType === 'snow' ? '' : '',
        title: (precipType === 'snow' ? 'SNOW' : 'RAIN') + ' ARRIVES',
        detail: (precipType === 'snow' ? 'Snow' : 'Precipitation') + ' begins around ' + fmtHr(firstPrecipHr) + '.' +
          (precipDuration ? ' Lasts ~' + precipDuration + ' hours.' : '') +
          (totalPrecip > 0 ? ' Estimated total: ' + totalPrecip.toFixed(2) + '".' : '') +
          (precipType === 'snow' && wx.temp <= 34 ? ' Surface temps support accumulation.' : ''),
        eta: fmtEta(firstPrecipHr),
        etaHr: firstPrecipHr
      });
    }

    // SEVERE POTENTIAL (CAPE spike)
    if (maxCape >= 1500 && maxCapeHr != null && maxCapeHr <= 24) {
      events.push({
        type: 'severe',
        severity: maxCape >= 3500 ? 'major' : maxCape >= 2500 ? 'significant' : 'moderate',
        icon: '',
        title: 'THUNDERSTORM POTENTIAL',
        detail: 'CAPE peaks at ' + Math.round(maxCape) + ' J/kg around ' + fmtHr(maxCapeHr) + '. ' +
          (maxCape >= 3500 ? 'Extreme instability  severe storms likely with any trigger.' :
           maxCape >= 2500 ? 'Strong instability  organized storms possible.' :
           'Moderate instability  scattered storms.') +
          (stormPeakGust > 40 ? ' Gusts to ' + Math.round(stormPeakGust) + ' mph possible.' : ''),
        eta: fmtEta(maxCapeHr),
        etaHr: maxCapeHr
      });
    }

    // WIND EVENT
    if (stormPeakGust >= 40 && stormPeakHr != null && stormPeakHr <= 36 && stormPeakGust > (wx.gust || 0) + 15) {
      events.push({
        type: 'wind',
        severity: stormPeakGust >= 58 ? 'major' : stormPeakGust >= 45 ? 'significant' : 'moderate',
        icon: '',
        title: 'WIND EVENT',
        detail: 'Gusts increase to ' + Math.round(stormPeakGust) + ' mph by ' + fmtHr(stormPeakHr) + '.' +
          (stormPeakGust >= 58 ? ' Meets severe criteria (58+ mph). Structural damage possible.' :
           stormPeakGust >= 45 ? ' Damaging wind potential. Secure loose objects.' :
           ' Strong wind  tree limb damage possible.'),
        eta: fmtEta(stormPeakHr),
        etaHr: stormPeakHr
      });
    }

    // CLEARING
    if (clearingHr != null && (firstPrecipHr != null || wx.cloudCover > 70)) {
      events.push({
        type: 'clearing',
        severity: 'positive',
        icon: '',
        title: 'CLEARING',
        detail: 'Skies clear around ' + fmtHr(clearingHr) + '.' +
          (clearingHr > 18 ? ' Evening clearing  good for stargazing.' : ''),
        eta: fmtEta(clearingHr),
        etaHr: clearingHr
      });
    }

    // CLOUD LAYER TRANSITION (warm front approach visible in layers)
    if (cloudTransition && cloudTransition.type === 'warm_front_clouds') {
      events.push({
        type: 'cloud_sequence',
        severity: 'moderate',
        icon: '',
        title: 'CLOUD DECK LOWERING',
        detail: 'Classic warm front cloud sequence: high cirrus fills in by ' + fmtHr(cloudTransition.highHr) + ', mid-level altostratus by ' + fmtHr(cloudTransition.midHr) +
          (cloudTransition.lowHr ? ', low overcast by ' + fmtHr(cloudTransition.lowHr) : '') + '. ' +
          'Lead time between high and mid layers: ' + cloudTransition.leadTime + 'hr  ' +
          (cloudTransition.leadTime > 8 ? 'slow-moving front, gradual deterioration.' : 'fast-moving front, rapid cloud thickening.'),
        eta: fmtEta(cloudTransition.highHr),
        etaHr: cloudTransition.highHr
      });
    }

    // CLEAR WINDOW (for planning outdoor/astronomy activities)
    if (clearWindow && clearWindow.start > 0 && wx.cloudCover > 40) {
      events.push({
        type: 'clear_window',
        severity: 'positive',
        icon: '',
        title: 'CLEAR WINDOW',
        detail: 'Cloud break opens around ' + fmtHr(clearWindow.start) + ', lasting ~' + clearWindow.duration + ' hours until ' + fmtHr(clearWindow.end) + '.' +
          (isDark !== false && clearWindow.duration >= 3 ? ' Long enough for astronomy.' : ''),
        eta: fmtEta(clearWindow.start),
        etaHr: clearWindow.start
      });
    }

    //  PART 2: UPSTREAM POINT SAMPLING 
    // Fetch current conditions at upwind points to see what's heading this way.
    // Use the dominant 500mb steering flow direction (approximated by wind direction)
    var steeringDir = wx.windDir; // degrees wind comes FROM
    if (steeringDir == null && timeline.length > 6) {
      // Average wind direction over next 6 hours as proxy
      var sDirSum = 0, sDirCount = 0;
      for (var sd = 0; sd < 6; sd++) {
        if (timeline[sd].wdir != null) { sDirSum += timeline[sd].wdir; sDirCount++; }
      }
      if (sDirCount > 0) steeringDir = sDirSum / sDirCount;
    }

    var upstreamPoints = [];
    if (steeringDir != null) {
      // Sample at ~150mi and ~300mi upwind (in the direction wind comes FROM)
      var steerRad = steeringDir * Math.PI / 180;
      var miToDeg = 1 / 69.0;
      [150, 300].forEach(function(distMi) {
        var dLat = Math.cos(steerRad) * distMi * miToDeg;
        var dLon = Math.sin(steerRad) * distMi * miToDeg / Math.cos(LOCATION.lat * Math.PI / 180);
        upstreamPoints.push({
          lat: +(LOCATION.lat + dLat).toFixed(2),
          lon: +(LOCATION.lon + dLon).toFixed(2),
          dist: distMi,
          label: distMi + 'mi upwind'
        });
      });
    }

    // Sort events by ETA
    events.sort(function(a, b) { return (a.etaHr || 99) - (b.etaHr || 99); });

    //  Store for tooltip access 
    window._stormTrack = {
      events: events,
      timeline: timeline,
      upstreamPoints: upstreamPoints,
      steeringDir: steeringDir,
      updated: Date.now()
    };

    //  Fetch upstream conditions (async, non-blocking) 
    if (upstreamPoints.length > 0) {
      var upstreamUrl = 'https://api.open-meteo.com/v1/forecast?latitude=' +
        upstreamPoints.map(function(p){ return p.lat; }).join(',') +
        '&longitude=' + upstreamPoints.map(function(p){ return p.lon; }).join(',') +
        '&current=temperature_2m,precipitation,weathercode,pressure_msl,windspeed_10m,wind_direction_10m,cloudcover,relativehumidity_2m,cloud_cover_low,cloud_cover_mid,cloud_cover_high' +
        '&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch&timezone=auto';

      fetchWithTimeout(upstreamUrl, null, 10000)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          // Open-Meteo returns array when multiple coords
          var results = Array.isArray(data) ? data : [data];
          var upstream = [];
          results.forEach(function(d, i) {
            if (!d || !d.current) return;
            var c = d.current;
            var dirLabels = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
            var wdl = c.wind_direction_10m != null ? dirLabels[Math.round(c.wind_direction_10m / 22.5) % 16] : null;
            upstream.push({
              dist: upstreamPoints[i].dist,
              label: upstreamPoints[i].label,
              lat: upstreamPoints[i].lat,
              lon: upstreamPoints[i].lon,
              temp: c.temperature_2m != null ? Math.round(c.temperature_2m) : null,
              precip: c.precipitation,
              code: c.weathercode,
              pressure: c.pressure_msl,
              wind: c.windspeed_10m != null ? Math.round(c.windspeed_10m) : null,
              windDir: wdl,
              cloud: c.cloudcover,
              cloudLow: c.cloud_cover_low || 0,
              cloudMid: c.cloud_cover_mid || 0,
              cloudHigh: c.cloud_cover_high || 0,
              rh: c.relativehumidity_2m,
              isRaining: c.precipitation > 0.01,
              isSnowing: c.weathercode >= 71 && c.weathercode <= 77,
              isStormy: c.weathercode >= 95
            });
          });

          if (upstream.length > 0) {
            window._stormTrack.upstream = upstream;

            //  Build upstream narrative 
            var upstreamNarr = [];
            upstream.forEach(function(u) {
              if (u.isRaining && !precipStarted) {
                var speed = wx.wind || 15;
                var etaHrs = Math.round(u.dist / speed);
                upstreamNarr.push({
                  icon: u.isSnowing ? '' : u.isStormy ? '' : '',
                  text: (u.isSnowing ? 'Snow' : u.isStormy ? 'Thunderstorms' : 'Rain') + ' currently ' + u.dist + 'mi upwind (' + u.windDir + '). At current wind speed (' + speed + ' mph), arrival in ~' + etaHrs + ' hours.',
                  severity: u.isStormy ? 'major' : 'moderate'
                });
              }
              if (u.temp != null && wx.temp != null && (wx.temp - u.temp) > 10) {
                upstreamNarr.push({
                  icon: '',
                  text: 'Air ' + u.dist + 'mi upwind is ' + (wx.temp - u.temp) + 'F colder (' + u.temp + 'F vs your ' + wx.temp + 'F). Cold advection heading your way.',
                  severity: (wx.temp - u.temp) > 20 ? 'major' : 'moderate'
                });
              }
              if (u.temp != null && wx.temp != null && (u.temp - wx.temp) > 10) {
                upstreamNarr.push({
                  icon: '',
                  text: 'Warmer air (' + u.temp + 'F) approaching from ' + u.dist + 'mi upwind. ' + (u.temp - wx.temp) + 'F warming trend incoming.',
                  severity: 'moderate'
                });
              }
              if (u.pressure != null && wx.pressure != null && (wx.pressure - u.pressure) > 4) {
                upstreamNarr.push({
                  icon: '',
                  text: 'Pressure ' + (wx.pressure - u.pressure).toFixed(1) + ' mb lower at ' + u.dist + 'mi upwind (' + Math.round(u.pressure) + ' vs ' + Math.round(wx.pressure) + ' mb). Low center approaching.',
                  severity: (wx.pressure - u.pressure) > 8 ? 'major' : 'significant'
                });
              }
              // Cloud layer approach detection
              var myTotal = wx.cloudCover || 0;
              if (u.cloud > 70 && myTotal < 40) {
                var cloudText = '';
                if (u.cloudHigh > 50 && u.cloudMid < 30) cloudText = 'High cirrus shield (Ci/Cs) ' + u.dist + 'mi upwind  first wave of approaching storm system. Mid/low clouds follow.';
                else if (u.cloudMid > 50) cloudText = 'Mid-level cloud deck (As/Ac) ' + u.dist + 'mi upwind  overcast with possible precipitation arriving.';
                else if (u.cloudLow > 50) cloudText = 'Low overcast ' + u.dist + 'mi upwind  stratus/fog layer approaching.';
                else cloudText = 'Overcast (' + u.cloud + '%) at ' + u.dist + 'mi upwind while clear here. Cloud cover approaching.';
                upstreamNarr.push({
                  icon: '',
                  text: cloudText,
                  severity: u.isRaining ? 'significant' : 'moderate'
                });
              }
            });
            window._stormTrack.upstreamNarrative = upstreamNarr;
          }
        })
        .catch(function() {
          // Non-critical  upstream data is supplementary
          console.log('Upstream weather scan failed  non-critical');
        });
    }
  }

  // Run upstream scan 5 seconds after main weather loads
  setTimeout(function() { scanUpstreamWeather(); }, 5000);
  // Refresh every 30 minutes
  setInterval(function() { scanUpstreamWeather(); }, 30 * 60 * 1000);

  //  STORM TRACK NARRATIVE BUILDER (for tooltip injection) 
  function buildStormTrackInsight() {
    var st = window._stormTrack;
    if (!st || (!st.events.length && (!st.upstreamNarrative || !st.upstreamNarrative.length))) return '';

    var out = '<div style="background:rgba(120,100,255,.06);border-radius:8px;padding:8px 10px;margin-top:6px;border-left:3px solid rgba(120,100,255,.5);">';
    out += '<div style="font-weight:700;font-size:.54rem;color:#a78bfa;margin-bottom:5px;"> STORM TRACK INTELLIGENCE</div>';

    //  Steering flow indicator 
    if (st.steeringDir != null) {
      var dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      var fromDir = dirs[Math.round(st.steeringDir / 22.5) % 16];
      out += '<div style="font-size:.44rem;color:#888;margin-bottom:5px;">Flow from <b>' + fromDir + '</b>  weather systems arrive from that direction</div>';
    }

    //  Upstream observations 
    if (st.upstreamNarrative && st.upstreamNarrative.length > 0) {
      out += '<div style="margin-bottom:5px;">';
      out += '<div style="font-size:.42rem;color:#a78bfa;font-weight:700;margin-bottom:3px;"> UPSTREAM RIGHT NOW</div>';
      st.upstreamNarrative.forEach(function(n) {
        var col = n.severity === 'major' ? '#f44' : n.severity === 'significant' ? '#f90' : '#ccc';
        out += '<div style="font-size:.46rem;color:' + col + ';line-height:1.35;margin-bottom:2px;">' + n.icon + ' ' + n.text + '</div>';
      });
      out += '</div>';
    }

    //  Timeline events 
    if (st.events.length > 0) {
      out += '<div style="margin-bottom:3px;">';
      out += '<div style="font-size:.42rem;color:#a78bfa;font-weight:700;margin-bottom:3px;"> INCOMING EVENTS</div>';

      // Timeline visual bar
      out += '<div style="display:flex;gap:1px;margin-bottom:5px;height:20px;border-radius:4px;overflow:hidden;">';
      var maxHr = 48;
      st.events.forEach(function(ev) {
        var pct = Math.min((ev.etaHr / maxHr) * 100, 100);
        var col = ev.severity === 'major' ? '#f44' : ev.severity === 'significant' ? '#f90' : ev.severity === 'positive' ? '#4f8' : '#78a0ff';
        out += '<div style="position:relative;flex-shrink:0;width:' + Math.max(pct, 5) + '%;background:' + col + '15;border-left:2px solid ' + col + ';padding:1px 3px;overflow:hidden;" title="' + ev.title + ' in ' + ev.eta + '">';
        out += '<div style="font-size:.32rem;color:' + col + ';font-weight:700;white-space:nowrap;">' + ev.icon + ' ' + ev.eta + '</div>';
        out += '<div style="font-size:.28rem;color:' + col + ';opacity:.7;white-space:nowrap;">' + ev.title + '</div>';
        out += '</div>';
      });
      out += '</div>';

      // Event details
      st.events.slice(0, 4).forEach(function(ev) {
        var col = ev.severity === 'major' ? '#f44' : ev.severity === 'significant' ? '#f90' : ev.severity === 'positive' ? '#4f8' : '#78a0ff';
        out += '<div style="display:flex;gap:6px;align-items:flex-start;margin-bottom:2px;padding:3px 6px;background:rgba(255,255,255,.02);border-radius:4px;border-left:2px solid ' + col + ';">';
        out += '<div style="flex-shrink:0;text-align:center;min-width:36px;">';
        out += '<div style="font-size:.55rem;">' + ev.icon + '</div>';
        out += '<div style="font-size:.34rem;color:' + col + ';font-weight:700;">' + ev.eta + '</div>';
        out += '</div>';
        out += '<div>';
        out += '<div style="font-size:.48rem;font-weight:700;color:' + col + ';">' + ev.title + '</div>';
        out += '<div style="font-size:.44rem;color:#aaa;line-height:1.3;">' + ev.detail + '</div>';
        out += '</div></div>';
      });
      out += '</div>';
    }

    //  Upstream point conditions comparison 
    if (st.upstream && st.upstream.length > 0) {
      out += '<div style="display:flex;gap:4px;margin-top:4px;">';
      out += '<div style="flex:1;padding:4px 6px;background:rgba(255,255,255,.03);border-radius:4px;text-align:center;border:1px solid rgba(255,255,255,.08);">';
      out += '<div style="font-size:.34rem;color:#888;font-weight:700;"> YOU</div>';
      var mwx = window._wxCurrent;
      if (mwx) {
        out += '<div style="font-size:.52rem;font-weight:800;">' + (mwx.temp || '?') + '</div>';
        out += '<div style="font-size:.36rem;color:#aaa;">' + (mwx.precip > 0 ? '' : mwx.cloudCover > 70 ? '' : '') + ' ' + Math.round(mwx.pressure || 0) + 'mb</div>';
        // Mini cloud layers
        out += '<div style="display:flex;gap:1px;height:9px;margin-top:2px;border-radius:2px;overflow:hidden;">';
        out += '<div style="flex:1;background:rgba(180,200,255,' + Math.max((mwx.cloudHigh || 0)/120, 0.04).toFixed(2) + ');" title="High ' + (mwx.cloudHigh || 0) + '%"></div>';
        out += '<div style="flex:1;background:rgba(140,160,200,' + Math.max((mwx.cloudMid || 0)/120, 0.04).toFixed(2) + ');" title="Mid ' + (mwx.cloudMid || 0) + '%"></div>';
        out += '<div style="flex:1;background:rgba(170,170,180,' + Math.max((mwx.cloudLow || 0)/120, 0.04).toFixed(2) + ');" title="Low ' + (mwx.cloudLow || 0) + '%"></div>';
        out += '</div>';
      }
      out += '</div>';
      st.upstream.forEach(function(u) {
        var borderCol = u.isStormy ? '#f44' : u.isRaining ? '#78a0ff' : u.cloud > 70 ? 'rgba(140,160,200,.4)' : 'rgba(255,255,255,.06)';
        out += '<div style="flex:1;padding:4px 6px;background:rgba(255,255,255,.03);border-radius:4px;text-align:center;border:1px solid ' + borderCol + ';">';
        out += '<div style="font-size:.34rem;color:#888;font-weight:700;">' + u.dist + 'MI </div>';
        out += '<div style="font-size:.52rem;font-weight:800;">' + (u.temp || '?') + '</div>';
        out += '<div style="font-size:.36rem;color:#aaa;">' + (u.isStormy ? '' : u.isRaining ? '' : u.cloud > 70 ? '' : '') + ' ' + Math.round(u.pressure || 0) + 'mb</div>';
        // Mini cloud layers for upstream
        out += '<div style="display:flex;gap:1px;height:9px;margin-top:2px;border-radius:2px;overflow:hidden;">';
        out += '<div style="flex:1;background:rgba(180,200,255,' + Math.max((u.cloudHigh || 0)/120, 0.04).toFixed(2) + ');" title="High ' + (u.cloudHigh || 0) + '%"></div>';
        out += '<div style="flex:1;background:rgba(140,160,200,' + Math.max((u.cloudMid || 0)/120, 0.04).toFixed(2) + ');" title="Mid ' + (u.cloudMid || 0) + '%"></div>';
        out += '<div style="flex:1;background:rgba(170,170,180,' + Math.max((u.cloudLow || 0)/120, 0.04).toFixed(2) + ');" title="Low ' + (u.cloudLow || 0) + '%"></div>';
        out += '</div>';
        out += '</div>';
      });
      out += '</div>';
    }

    out += '</div>';
    return out;
  }

  // 
  // ASTRONOMER'S INTELLIGENCE SYSTEM
  // Comprehensive deep-space, planetary, and observing conditions
  // engine. Synthesizes weather, atmospheric, and astronomical data
  // into a unified observing guide.
  // 

  //  DEEP SKY OBJECTS CATALOG (Brightest/most popular) 
  var DSO_CATALOG = [
    // Messier showpieces
    {id:'M31', name:'Andromeda Galaxy', type:'galaxy', ra:10.68, dec:41.27, mag:3.4, size:'31', con:'Andromeda', bestMonths:[9,10,11,12,1], desc:'Nearest large galaxy, 2.5M ly. Visible naked eye from dark sites. Binoculars show oval glow; telescope reveals dust lanes.', minAperture:'naked eye', difficulty:'easy'},
    {id:'M42', name:'Orion Nebula', type:'nebula', ra:83.82, dec:-5.39, mag:4.0, size:'8560\'', con:'Orion', bestMonths:[11,12,1,2,3], desc:'Stellar nursery 1,344 ly away. The Trapezium cluster at its heart is a stunning telescope target. Visible naked eye as fuzzy "star" in Orion\'s sword.', minAperture:'naked eye', difficulty:'easy'},
    {id:'M45', name:'Pleiades', type:'open cluster', ra:56.87, dec:24.12, mag:1.6, size:'110\'', con:'Taurus', bestMonths:[10,11,12,1,2,3], desc:'The Seven Sisters, 444 ly. Stunning in binoculars (6-9 stars naked eye, 100+ with optics). Blue reflection nebulosity in long exposures.', minAperture:'naked eye', difficulty:'easy'},
    {id:'M13', name:'Hercules Cluster', type:'globular', ra:250.42, dec:36.46, mag:5.8, size:'20\'', con:'Hercules', bestMonths:[5,6,7,8,9], desc:'300,000 stars in a ball 145 ly across, 22,000 ly away. Resolves into individual stars in 8"+ telescopes. The finest globular in northern skies.', minAperture:'binoculars', difficulty:'easy'},
    {id:'M51', name:'Whirlpool Galaxy', type:'galaxy', ra:202.47, dec:47.20, mag:8.4, size:'117\'', con:'Canes Venatici', bestMonths:[3,4,5,6,7], desc:'Face-on spiral 23M ly away, interacting with NGC 5195. Spiral arms visible in 8"+ scopes under dark skies. Classic astrophotography target.', minAperture:'4" telescope', difficulty:'moderate'},
    {id:'M57', name:'Ring Nebula', type:'planetary nebula', ra:283.40, dec:33.03, mag:8.8, size:'1.41\'', con:'Lyra', bestMonths:[6,7,8,9,10], desc:'Dying star\'s expelled shell, 2,300 ly. Small but bright  looks like a ghostly smoke ring at 100x+. Central star visible in 12"+.', minAperture:'3" telescope', difficulty:'easy'},
    {id:'M27', name:'Dumbbell Nebula', type:'planetary nebula', ra:299.90, dec:22.72, mag:7.5, size:'85.7\'', con:'Vulpecula', bestMonths:[7,8,9,10], desc:'Largest planetary nebula in the sky, 1,360 ly. Apple-core shape visible in small scopes. Beautiful in any aperture.', minAperture:'binoculars', difficulty:'easy'},
    {id:'M44', name:'Beehive Cluster', type:'open cluster', ra:130.03, dec:19.67, mag:3.7, size:'95\'', con:'Cancer', bestMonths:[2,3,4,5], desc:'1,000 stars at 577 ly, one of nearest open clusters. Best in binoculars  fills the field of view. Known since antiquity.', minAperture:'naked eye', difficulty:'easy'},
    {id:'M81', name:'Bode\'s Galaxy', type:'galaxy', ra:148.89, dec:69.07, mag:6.9, size:'2714\'', con:'Ursa Major', bestMonths:[2,3,4,5,6], desc:'Grand design spiral 12M ly away. Forms a pair with M82 (Cigar Galaxy)  both fit in one low-power field. Superb photo pair.', minAperture:'binoculars', difficulty:'moderate'},
    {id:'M8', name:'Lagoon Nebula', type:'nebula', ra:270.92, dec:-24.38, mag:6.0, size:'9040\'', con:'Sagittarius', bestMonths:[6,7,8], desc:'Giant emission nebula near galactic center, 4,100 ly. Visible naked eye from dark sites. Binoculars show the dark lagoon lane.', minAperture:'naked eye', difficulty:'easy'},
    {id:'NGC869', name:'Double Cluster', type:'open cluster', ra:34.75, dec:57.13, mag:3.7, size:'30\'', con:'Perseus', bestMonths:[9,10,11,12,1], desc:'Twin clusters h and  Persei, 7,500 ly. One of the finest binocular objects  hundreds of stars in two adjacent groups.', minAperture:'binoculars', difficulty:'easy'},
    {id:'M1', name:'Crab Nebula', type:'supernova remnant', ra:83.63, dec:22.01, mag:8.4, size:'75\'', con:'Taurus', bestMonths:[11,12,1,2], desc:'Remnant of the supernova of 1054 AD, 6,500 ly. Faint oval smudge in small scopes; filamentary structure in 12"+. Pulsar at center spins 30x/sec.', minAperture:'4" telescope', difficulty:'moderate'},
    {id:'NGC7000', name:'North America Nebula', type:'nebula', ra:314.73, dec:44.35, mag:4.0, size:'120100\'', con:'Cygnus', bestMonths:[7,8,9,10], desc:'Huge emission nebula shaped like the continent, near Deneb. Best with binoculars or widefield astrophotography  too big for most telescopes.', minAperture:'binoculars', difficulty:'moderate'},
    //  ADDITIONAL DSOs 
    {id:'M104', name:'Sombrero Galaxy', type:'galaxy', ra:190.0, dec:-11.6, mag:8.0, size:'94\'', con:'Virgo', bestMonths:[3,4,5,6], desc:'Edge-on spiral with prominent dust lane and bright core, 29M ly. One of the most visually striking galaxies  looks like a hat. 1 billion solar mass black hole.', minAperture:'4" telescope', difficulty:'moderate'},
    {id:'M82', name:'Cigar Galaxy', type:'galaxy', ra:148.9, dec:69.7, mag:8.4, size:'115\'', con:'Ursa Major', bestMonths:[1,2,3,4,5,6], desc:'Starburst galaxy with shredded appearance from intense star formation, forming stars 10 faster than Milky Way. Pair with M81.', minAperture:'4" telescope', difficulty:'moderate'},
    {id:'M20', name:'Trifid Nebula', type:'nebula', ra:270.6, dec:-23.0, mag:6.3, size:'28\'', con:'Sagittarius', bestMonths:[6,7,8], desc:'Rare triple nebula  emission (red), reflection (blue), and dark nebulae in one. Named for three dark dust lanes that trisect the emission region.', minAperture:'binoculars', difficulty:'moderate'},
    {id:'M33', name:'Triangulum Galaxy', type:'galaxy', ra:23.5, dec:30.7, mag:5.7, size:'7345\'', con:'Triangulum', bestMonths:[9,10,11,12], desc:'Third largest galaxy in Local Group, 2.7M ly. Face-on spiral, low surface brightness. Challenging naked-eye from pristine sites; binoculars in dark skies.', minAperture:'binoculars', difficulty:'hard'},
    {id:'M17', name:'Omega/Swan Nebula', type:'nebula', ra:275.2, dec:-16.2, mag:6.0, size:'4637\'', con:'Sagittarius', bestMonths:[6,7,8,9], desc:'Bright emission nebula with distinctive swan/horseshoe shape. Contains a young open cluster. Rich region near galactic center.', minAperture:'binoculars', difficulty:'easy'},
    {id:'M22', name:'Sagittarius Cluster', type:'globular', ra:279.1, dec:-23.9, mag:5.1, size:'32\'', con:'Sagittarius', bestMonths:[6,7,8,9], desc:'One of the nearest and brightest globulars, 10,400 ly. Easy in binoculars. Resolves into stars in 6"+. Contains a planetary nebula (rare for globulars).', minAperture:'binoculars', difficulty:'easy'},
    {id:'M16', name:'Eagle Nebula', type:'nebula', ra:274.7, dec:-13.8, mag:6.0, size:'3528\'', con:'Serpens', bestMonths:[6,7,8,9], desc:'Home of the "Pillars of Creation" (Hubble\'s most famous image). Open cluster embedded in emission nebula. UHC filter dramatically improves the view.', minAperture:'binoculars', difficulty:'moderate'},
    {id:'NGC6826', name:'Blinking Planetary', type:'planetary nebula', ra:295.4, dec:50.5, mag:8.8, size:'0.4\'', con:'Cygnus', bestMonths:[7,8,9,10], desc:'Bright planetary nebula that appears to "blink"  look directly at it and it vanishes, use averted vision and it reappears. Fun telescope target.', minAperture:'3" telescope', difficulty:'easy'},
    {id:'IC1396', name:'Elephant Trunk Nebula', type:'nebula', ra:324.7, dec:57.5, mag:3.5, size:'170\'', con:'Cepheus', bestMonths:[8,9,10,11], desc:'Enormous emission nebula surrounding star cluster Tr 37. The dark "elephant trunk" is a stellar nursery. Best in widefield with H filter.', minAperture:'binoculars', difficulty:'hard'},
    {id:'M3', name:'Globular Cluster M3', type:'globular', ra:205.5, dec:28.4, mag:6.2, size:'18\'', con:'Canes Venatici', bestMonths:[3,4,5,6,7], desc:'One of the brightest and largest globulars, 33,900 ly. Contains ~500,000 stars. Resolves beautifully in 8" scope. 274 variable stars  most of any globular.', minAperture:'binoculars', difficulty:'easy'}
  ];

  //  PLANET PHYSICAL DATA & OBSERVING GUIDE 
  var PLANET_DATA = {
    mercury: {
      name:'Mercury', symbol:'', color:'#b0a090',
      diameter:3032, distSun:0.39, yearLen:'88d', dayLen:'59d', moons:0,
      type:'Rocky', maxMag:-1.9, angSizeRange:'5-13"',
      telescope:'Tiny disk shows phases like Venus. Requires very steady seeing near horizon. Best at greatest elongation. Surface featureless in amateur scopes.',
      facts:['Smallest planet  only 40% larger than our Moon','Surface temperature swings 1,100F between day and night','Has ice in permanently shadowed polar craters despite 800F daytime','Orbits so fast a "year" is only 88 Earth days','Most eccentric orbit of any planet (0.206)'],
      missions:'MESSENGER (2011-15) mapped entire surface. BepiColombo (ESA/JAXA) arriving 2025 for polar orbit study.',
      tip:'Only visible low on horizon near sunrise/sunset. Best opportunities at greatest elongation (18-28 from Sun).'
    },
    venus: {
      name:'Venus', symbol:'', color:'#ffe0a0',
      diameter:7521, distSun:0.72, yearLen:'225d', dayLen:'243d', moons:0,
      type:'Rocky', maxMag:-4.9, angSizeRange:'10-66"',
      telescope:'Brilliant! Shows dramatic crescent-to-gibbous phases. No surface visible (cloud-covered). UV filter reveals Y-shaped cloud patterns. At 66" near inferior conjunction, crescent is spectacular.',
      facts:['Hottest planet (900F)  hotter than Mercury despite being farther from Sun','Rotates backwards (retrograde) and slower than it orbits  a Venus day > Venus year','Atmospheric pressure 90 Earth  equivalent to 3,000ft underwater','Sulfuric acid clouds reflect 70% of sunlight, making it the brightest planet','Possible phosphine detection in atmosphere (2020) sparked "life in the clouds" debate'],
      missions:'Akatsuki (JAXA, orbiting since 2015). VERITAS (NASA radar mapper), DAVINCI+ (atmosphere probe), EnVision (ESA) all planned for early 2030s.',
      tip:'Brightest object after Sun and Moon. Easy naked-eye as "morning star" or "evening star." Never appears more than 47 from Sun.'
    },
    mars: {
      name:'Mars', symbol:'', color:'#e08050',
      diameter:4212, distSun:1.52, yearLen:'687d', dayLen:'24h 37m', moons:2,
      type:'Rocky', maxMag:-2.9, angSizeRange:'4-25"',
      telescope:'At opposition: polar ice caps (white spots), dark surface markings (Syrtis Major is most prominent), seasonal dust storms. 6"+ scope recommended. Mars is dramatically better within 2 months of opposition.',
      facts:['Olympus Mons is the tallest volcano in the solar system (72,000 ft  2.5 Everest)','Valles Marineris canyon stretches 2,500 miles  would span the entire US','One day (sol) is only 37 minutes longer than Earth\'s','Has seasons like Earth due to 25 axial tilt','Perseverance is caching samples for the first Mars-to-Earth sample return'],
      missions:'Active: Perseverance + Ingenuity (NASA), Curiosity (NASA), Zhurong (CNSA, dormant), MAVEN, MRO, Mars Express, TGO. Mars Sample Return planned ~2033.',
      tip:'Best viewed within 3 months of opposition (every 26 months). At other times, it\'s a small featureless dot. 2026 opposition: Feb 19.'
    },
    jupiter: {
      name:'Jupiter', symbol:'', color:'#d4a06a',
      diameter:86881, distSun:5.20, yearLen:'11.9yr', dayLen:'9h 56m', moons:95,
      type:'Gas giant', maxMag:-2.9, angSizeRange:'30-50"',
      telescope:'THE planet for telescopes. Cloud bands visible in 3"+. Great Red Spot transits (use timing tables). 4 Galilean moons change position nightly  eclipses, transits, shadow transits. Always something new.',
      facts:['Contains 2.5 the mass of all other planets combined','Great Red Spot is a storm larger than Earth, raging for 350+ years (now shrinking)','95 known moons  Europa has subsurface ocean with 2 Earth\'s water volume','Intense radiation belts (1,000 Earth) would kill an unshielded astronaut in minutes','Fastest-rotating planet  equatorial bulge visible in telescopes'],
      missions:'Juno (NASA, orbiting since 2016, extended to 2025). Europa Clipper (launched Oct 2024, arriving 2030). JUICE (ESA, arriving 2031 for Ganymede orbit).',
      tip:'Best for beginners. Even cheap telescopes show cloud bands and moons. Track GRS transits at shallowsky.com/jupiter/.'
    },
    saturn: {
      name:'Saturn', symbol:'', color:'#e8d098',
      diameter:72367, distSun:9.54, yearLen:'29.5yr', dayLen:'10h 42m', moons:146,
      type:'Gas giant', maxMag:-0.5, angSizeRange:'15-21"',
      telescope:'Most beautiful object in any telescope. Rings visible in 2" scope at 25. Cassini Division (dark gap in rings) visible in 4"+. Titan appears as a star-like point. Ring tilt varies from edge-on (2025) to 27.',
      facts:['Ring system is 282,000 km across but only ~10 meters thick  proportionally thinner than a sheet of paper','146 known moons  most of any planet. Titan is larger than Mercury with lakes of liquid methane','Would float in water (density 0.687 g/cm  less dense than water)','Enceladus has geysers shooting water ice into space from a subsurface ocean  prime astrobiology target','Hexagonal storm at north pole is 20,000 miles across'],
      missions:'Cassini-Huygens (1997-2017, 13 years at Saturn). Dragonfly (NASA, launching 2028 to fly a drone on Titan). No current orbiter.',
      tip:'Rings currently near edge-on (2025 crossing). Will reopen 2026+. Saturn\'s ring tilt is the #1 factor in visual impact.'
    },
    uranus: {
      name:'Uranus', symbol:'', color:'#a0d8d8',
      diameter:31518, distSun:19.2, yearLen:'84yr', dayLen:'17h 14m', moons:28,
      type:'Ice giant', maxMag:+5.6, angSizeRange:'3.3-4.1"',
      telescope:'Small blue-green disk visible in 6"+ at 150+. No surface detail. But you can say you saw a planet discovered in 1781! Interesting challenge target.',
      facts:['Tilted 98  essentially rolls around the Sun on its side (likely from ancient collision)','Has 13 faint rings discovered in 1977 during a stellar occultation','Coldest planetary atmosphere (357F) despite not being farthest from Sun','Takes 84 years to orbit  it hasn\'t completed one orbit since its discovery in 1781','2023 Decadal Survey ranked Uranus Orbiter as #1 priority flagship mission'],
      missions:'Only Voyager 2 (1986 flyby). Uranus Orbiter & Probe is the highest-priority flagship mission per 2023 Planetary Decadal Survey. Launch possible ~2032.',
      tip:'Barely naked-eye from dark sites (mag 5.6). Use star chart to distinguish from field stars. Opposition: Nov 2026.'
    },
    neptune: {
      name:'Neptune', symbol:'', color:'#4488cc',
      diameter:30599, distSun:30.1, yearLen:'165yr', dayLen:'16h 6m', moons:16,
      type:'Ice giant', maxMag:+7.8, angSizeRange:'2.2-2.4"',
      telescope:'Requires telescope and finder chart. Appears as a tiny blue star-like dot  2.3" disk barely resolvable. Triton (mag 13.5) visible in 10"+.',
      facts:['Strongest winds in the solar system  up to 1,200 mph (supersonic)','Discovered mathematically before being seen  predicted by perturbations in Uranus\' orbit','Triton orbits retrograde  almost certainly a captured Kuiper Belt object','Has only completed ~1 orbit since discovery in 1846','Internal heat source radiates 2.6 the energy it receives from the Sun'],
      missions:'Only Voyager 2 (1989 flyby). No missions currently planned. Neptune/Triton Orbiter proposed but not funded.',
      tip:'Invisible to naked eye (mag 7.8). Need 4"+ telescope and precise star chart or goto mount. Worth seeing just to say you did.'
    }
  };

  //  ACTIVE SPACE MISSIONS DATABASE 
  var SPACE_MISSIONS = {
    mars: [
      {name:'Perseverance', agency:'NASA', type:'Rover', since:'2021', status:'Active', note:'Collecting samples for Mars Sample Return. Has Ingenuity helicopter.'},
      {name:'Curiosity', agency:'NASA', type:'Rover', since:'2012', status:'Active', note:'Climbing Mt. Sharp, studying Gale Crater geology.'},
      {name:'MAVEN', agency:'NASA', type:'Orbiter', since:'2014', status:'Active', note:'Studying how Mars lost its atmosphere.'},
      {name:'MRO', agency:'NASA', type:'Orbiter', since:'2006', status:'Active', note:'Highest-resolution camera ever sent to another planet (HiRISE).'},
      {name:'Mars Express', agency:'ESA', type:'Orbiter', since:'2003', status:'Active', note:'Longest-serving Mars orbiter. Discovered subsurface ice.'}
    ],
    jupiter: [
      {name:'Juno', agency:'NASA', type:'Orbiter', since:'2016', status:'Active', note:'Studying Jupiter\'s interior, magnetic field, and polar regions.'},
      {name:'Europa Clipper', agency:'NASA', type:'Flyby', since:'2024', status:'En route', note:'49 flybys of Europa planned. Arriving 2030. Studying subsurface ocean habitability.'}
    ],
    sun: [
      {name:'Parker Solar Probe', agency:'NASA', type:'Probe', since:'2018', status:'Active', note:'Closest object to the Sun ever. "Touched" the corona in 2021. 430,000 mph.'},
      {name:'Solar Orbiter', agency:'ESA/NASA', type:'Orbiter', since:'2020', status:'Active', note:'First images of Sun\'s poles. Studying solar wind origins.'},
      {name:'SDO', agency:'NASA', type:'Orbiter', since:'2010', status:'Active', note:'Primary solar monitoring satellite. Images Sun every 12 seconds.'}
    ],
    moon: [
      {name:'LRO', agency:'NASA', type:'Orbiter', since:'2009', status:'Active', note:'Mapped entire lunar surface at <1m resolution. Found ice in craters.'},
      {name:'Chandrayaan-3', agency:'ISRO', type:'Lander', since:'2023', status:'Landed', note:'First successful south pole landing. India became 4th nation to soft-land.'},
      {name:'SLIM', agency:'JAXA', type:'Lander', since:'2024', status:'Landed', note:'Precision landing within 100m of target. Japan became 5th nation to soft-land.'}
    ],
    venus: [
      {name:'Akatsuki', agency:'JAXA', type:'Orbiter', since:'2015', status:'Active', note:'Studying atmospheric dynamics. Discovered equatorial jet and gravity waves.'}
    ],
    mercury: [
      {name:'BepiColombo', agency:'ESA/JAXA', type:'Orbiter', since:'2018', status:'En route', note:'Two orbiters in one. Will study Mercury\'s magnetic field and surface. Arriving 2025.'}
    ],
    deep: [
      {name:'New Horizons', agency:'NASA', type:'Probe', since:'2006', status:'Active', note:'Flew past Pluto (2015) and Arrokoth (2019). Now in Kuiper Belt, studying heliosphere.'},
      {name:'Voyager 1', agency:'NASA', type:'Probe', since:'1977', status:'Active', note:'Farthest human-made object. Entered interstellar space 2012. ~164 AU from Sun.'},
      {name:'Voyager 2', agency:'NASA', type:'Probe', since:'1977', status:'Active', note:'Only craft to visit all 4 giant planets. Entered interstellar space 2018. ~137 AU.'}
    ],
    telescopes: [
      {name:'JWST', agency:'NASA/ESA/CSA', type:'Space telescope', since:'2022', status:'Active', note:'Most powerful telescope ever. Infrared. Studying first galaxies, exoplanet atmospheres.'},
      {name:'Hubble', agency:'NASA/ESA', type:'Space telescope', since:'1990', status:'Active', note:'35 years and counting. Optical/UV/near-IR. Determined age of universe, dark energy.'},
      {name:'Chandra', agency:'NASA', type:'X-ray telescope', since:'1999', status:'Active', note:'X-ray vision reveals black holes, supernova remnants, galaxy clusters.'},
      {name:'Euclid', agency:'ESA', type:'Space telescope', since:'2023', status:'Active', note:'Mapping dark matter and dark energy across 1/3 of the sky. 6-year survey.'},
      {name:'IXPE', agency:'NASA/ASI', type:'X-ray telescope', since:'2021', status:'Active', note:'First X-ray polarimetry mission. Studying magnetic fields around black holes and neutron stars.'}
    ]
  };

  //  SOLAR SYSTEM FACTS ENGINE 
  // Contextual facts based on what's currently visible
  function getPlanetFact(name) {
    var pd = PLANET_DATA[name.toLowerCase()];
    if (!pd || !pd.facts) return '';
    return pd.facts[Math.floor(Math.random() * pd.facts.length)];
  }

  //  MILKY WAY / GALACTIC CENTER DATA 
  var GALACTIC_CENTER = { ra: 266.42, dec: -29.01 }; // Sagittarius A*

  function getMilkyWayStatus(date, lat, lon) {
    var gc = altAz(GALACTIC_CENTER.ra / 15, GALACTIC_CENTER.dec, date, lat, lon);
    var gcAlt = deg(gc.alt);
    var gcAz = deg(gc.az);
    var dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
    var gcDir = dirs[Math.round(((gcAz % 360) + 360) % 360 / 22.5) % 16];

    var status = {
      alt: gcAlt,
      az: gcAz,
      dir: gcDir,
      visible: gcAlt > 0,
      core: gcAlt > 15,
      optimal: gcAlt > 30
    };

    if (gcAlt > 30) {
      status.narrative = 'Galactic core well above horizon at ' + Math.round(gcAlt) + ' (' + gcDir + '). The Milky Way\'s brightest region (Sagittarius through Scorpius) is fully accessible. Best deep-sky hunting zone.';
      status.rating = 'excellent';
    } else if (gcAlt > 15) {
      status.narrative = 'Galactic core rising at ' + Math.round(gcAlt) + ' (' + gcDir + '). Core clouds becoming visible but atmospheric extinction dims the lowest portions. Scan the sky overhead for the Milky Way band.';
      status.rating = 'good';
    } else if (gcAlt > 0) {
      status.narrative = 'Galactic core on the horizon at ' + Math.round(gcAlt) + ' (' + gcDir + '). Too low for detail but the Milky Way band stretches overhead through Cygnus and Cassiopeia.';
      status.rating = 'fair';
    } else {
      // Find when it rises
      status.narrative = 'Galactic core below horizon (' + Math.round(gcAlt) + '). The Milky Way\'s richest star fields are not visible. Focus on galaxies (M31, M81/M82, Virgo Cluster) which are best when the Milky Way is down.';
      status.rating = 'below';
    }
    return status;
  }

  //  OBSERVING CONDITIONS SCORE ENGINE 
  function computeObservingScore() {
    var wx = window._wxCurrent;
    if (!wx) return null;

    var score = { total: 0, max: 100, factors: [], narrative: '' };

    // 1. Cloud cover (0-30 points)
    var cloudPts = 0;
    if (wx.cloudCover != null) {
      if (wx.cloudCover < 5) cloudPts = 30;
      else if (wx.cloudCover < 15) cloudPts = 25;
      else if (wx.cloudCover < 30) cloudPts = 18;
      else if (wx.cloudCover < 50) cloudPts = 10;
      else if (wx.cloudCover < 70) cloudPts = 5;
      else cloudPts = 0;
      score.factors.push({ name: 'Cloud Cover', pts: cloudPts, max: 30, detail: wx.cloudCover + '%' + (wx.cloudCover < 15 ? '  excellent' : wx.cloudCover < 40 ? '  usable' : '  poor') });
    }
    score.total += cloudPts;

    // 2. Transparency (0-20 points)  humidity, aerosols, AQI
    var transPts = 0;
    if (wx.rh != null) {
      if (wx.rh < 40) transPts += 10;
      else if (wx.rh < 60) transPts += 7;
      else if (wx.rh < 75) transPts += 4;
      else if (wx.rh < 90) transPts += 1;
    }
    var usAqi = window._wxAQI ? window._wxAQI.us_aqi : null;
    if (usAqi != null) {
      if (usAqi < 25) transPts += 10;
      else if (usAqi < 50) transPts += 7;
      else if (usAqi < 100) transPts += 3;
      else transPts += 0;
    } else transPts += 5;
    score.factors.push({ name: 'Transparency', pts: transPts, max: 20, detail: 'RH ' + (wx.rh || '?') + '%' + (usAqi != null ? ', AQI ' + usAqi : '') });
    score.total += transPts;

    // 3. Seeing (0-20 points)  wind, temp stability, PBL
    var seePts = 0;
    if (wx.wind != null) {
      if (wx.wind < 5) seePts += 8;
      else if (wx.wind < 10) seePts += 6;
      else if (wx.wind < 15) seePts += 3;
      else if (wx.wind < 25) seePts += 1;
    }
    if (wx.tempTrend3hr != null) {
      if (Math.abs(wx.tempTrend3hr) < 1) seePts += 7;
      else if (Math.abs(wx.tempTrend3hr) < 2.5) seePts += 4;
      else if (Math.abs(wx.tempTrend3hr) < 5) seePts += 2;
    }
    if (wx.pblHeight != null) {
      if (wx.pblHeight < 200) seePts += 5;
      else if (wx.pblHeight < 500) seePts += 3;
      else if (wx.pblHeight > 1500) seePts -= 1;
    }
    score.factors.push({ name: 'Seeing', pts: Math.max(0, seePts), max: 20, detail: 'Wind ' + (wx.wind || '?') + ' mph, T/3hr ' + (wx.tempTrend3hr != null ? wx.tempTrend3hr.toFixed(1) + 'F' : '?') });
    score.total += Math.max(0, seePts);

    // 4. Moon interference (0-15 points)
    var moonPts = 15;
    var phase = window._moonPhase;
    if (phase != null) {
      if (phase < 0.05 || phase > 0.95) moonPts = 15; // new moon
      else if (phase < 0.15 || phase > 0.85) moonPts = 12;
      else if (phase < 0.30 || phase > 0.70) moonPts = 8;
      else if (phase < 0.45 || phase > 0.55) moonPts = 4;
      else moonPts = 0; // full moon
    }
    score.factors.push({ name: 'Moon', pts: moonPts, max: 15, detail: phase != null ? Math.round(phase * 100) + '% illuminated' : '?' });
    score.total += moonPts;

    // 5. Darkness (0-15 points)  based on sun altitude
    var darkPts = 0;
    var now = new Date();
    var sunPos = sunEcliptic ? (function() {
      var d = daysSinceJ2000(now);
      var s = sunEcliptic(d);
      var eq = eclToEqu(s.x, s.y, s.z, d);
      var rd = raDecFromEqu(eq);
      return altAz(rd.ra, rd.dec, now, LOCATION.lat, LOCATION.lon);
    })() : null;
    var sunAlt = sunPos ? deg(sunPos.alt) : null;
    if (sunAlt != null) {
      if (sunAlt < -18) darkPts = 15; // astronomical dark
      else if (sunAlt < -12) darkPts = 10; // nautical twilight
      else if (sunAlt < -6) darkPts = 5; // civil twilight
      else if (sunAlt < 0) darkPts = 2; // below horizon but bright
      else darkPts = 0;
    }
    score.factors.push({ name: 'Darkness', pts: darkPts, max: 15, detail: sunAlt != null ? (sunAlt < -18 ? 'Astronomical dark' : sunAlt < -12 ? 'Nautical twilight' : sunAlt < -6 ? 'Civil twilight' : sunAlt < 0 ? 'Twilight' : 'Daylight') : '?' });
    score.total += darkPts;

    // Overall narrative
    if (score.total >= 85) score.narrative = 'EXCEPTIONAL  pristine conditions. Deep-sky objects, faint galaxies, and nebulosity will be at their best. Grab your telescope.';
    else if (score.total >= 70) score.narrative = 'VERY GOOD  excellent for most targets. Planets, bright DSOs, and the Milky Way will show well.';
    else if (score.total >= 50) score.narrative = 'FAIR  usable for bright targets (planets, Moon, double stars, bright clusters). Faint objects will be washed out.';
    else if (score.total >= 30) score.narrative = 'POOR  limited to bright planets and the Moon. Clouds, moonlight, or humidity degrading conditions.';
    else score.narrative = 'NOT RECOMMENDED  overcast, bright twilight, or severe atmospheric conditions. Wait for better skies.';

    return score;
  }

  //  TONIGHT'S TARGETS ENGINE 
  function buildTonightsTargets() {
    var now = new Date();
    var wx = window._wxCurrent;
    if (!wx) return '';
    var score = computeObservingScore();
    if (!score) return '';

    var lat = LOCATION.lat, lon = LOCATION.lon;

    // Check if it's dark enough
    var sunD = daysSinceJ2000(now);
    var sunEc = sunEcliptic(sunD);
    var sunEq = eclToEqu(sunEc.x, sunEc.y, sunEc.z, sunD);
    var sunRd = raDecFromEqu(sunEq);
    var sunAA = altAz(sunRd.ra, sunRd.dec, now, lat, lon);
    var sunAltDeg = deg(sunAA.alt);
    var isDark = sunAltDeg < -6;

    //  Observing Score Arc Gauge 
    var out = '<div style="background:rgba(100,120,255,.04);border-radius:10px;padding:10px 12px;margin-top:6px;border-left:3px solid rgba(100,180,255,.4);">';
    out += '<div style="font-weight:700;font-size:.56rem;color:#64b5f6;margin-bottom:6px;">ASTRONOMER\'S INTELLIGENCE</div>';

    // Score gauge
    var pct = score.total / score.max;
    var gaugeCol = pct >= 0.85 ? '#4f8' : pct >= 0.7 ? '#78a0ff' : pct >= 0.5 ? '#f90' : '#f44';
    out += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">';
    out += '<div style="position:relative;width:60px;height:60px;">';
    out += '<svg viewBox="0 0 36 36" style="width:60px;height:60px;transform:rotate(-90deg);">';
    out += '<circle cx="18" cy="18" r="15" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="3"/>';
    out += '<circle cx="18" cy="18" r="15" fill="none" stroke="' + gaugeCol + '" stroke-width="3" stroke-dasharray="' + (pct * 94.25).toFixed(1) + ' 94.25" stroke-linecap="round"/>';
    out += '</svg>';
    out += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.7rem;font-weight:900;color:' + gaugeCol + ';">' + score.total + '</div>';
    out += '</div>';
    out += '<div style="flex:1;">';
    out += '<div style="font-size:.48rem;font-weight:700;color:' + gaugeCol + ';">OBSERVING SCORE: ' + score.total + '/100</div>';
    out += '<div style="font-size:.40rem;color:#aaa;line-height:1.3;">' + score.narrative + '</div>';
    out += '</div></div>';

    // Factor bars
    out += '<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px;">';
    score.factors.forEach(function(f) {
      var fPct = f.pts / f.max;
      var fCol = fPct >= 0.8 ? '#4f8' : fPct >= 0.5 ? '#78a0ff' : fPct >= 0.3 ? '#f90' : '#f44';
      out += '<div style="flex:1;min-width:55px;padding:3px 5px;background:rgba(255,255,255,.02);border-radius:4px;text-align:center;">';
      out += '<div style="font-size:.32rem;opacity:.5;">' + f.name + '</div>';
      out += '<div style="height:3px;background:rgba(255,255,255,.06);border-radius:2px;margin:2px 0;overflow:hidden;">';
      out += '<div style="width:' + (fPct * 100) + '%;height:100%;background:' + fCol + ';border-radius:2px;"></div>';
      out += '</div>';
      out += '<div style="font-size:.30rem;color:' + fCol + ';">' + f.pts + '/' + f.max + '</div>';
      out += '</div>';
    });
    out += '</div>';

    // 
    // SITUATIONAL ADVISOR  "What should I do right now?"
    // Reads ALL conditions and gives prioritized, actionable guidance.
    // This is the executive summary that sits above all detail panels.
    // 
    (function() {
      var advise = [];
      var moonPhase = window._moonPhase;
      var moonIll = moonPhase != null ? Math.round(moonPhase * 100) : null;
      var cloudCover = wx.cloudCover != null ? wx.cloudCover : 50;
      var isOvercast = cloudCover >= 80;
      var isClear = cloudCover < 20;
      var isPartly = cloudCover >= 20 && cloudCover < 60;
      var isAstroDark = sunAltDeg < -18;
      var isNautical = sunAltDeg < -12 && sunAltDeg >= -18;
      var isCivil = sunAltDeg < -6 && sunAltDeg >= -12;
      var isDaytime = sunAltDeg >= 0;
      var isTwilight = sunAltDeg < 0 && sunAltDeg >= -6;
      var wind = wx.wind || 0;
      var rh = wx.rh || 50;

      // Compute time to sunset/sunrise
      var sr = wx.sunrise ? new Date(wx.sunrise) : null;
      var ss = wx.sunset ? new Date(wx.sunset) : null;
      var minsToSunset = ss ? Math.round((ss - now) / 60000) : null;
      var minsToSunrise = sr ? Math.round((sr - now) / 60000) : null;
      var minsToDark = ss ? Math.round((new Date(ss.getTime() + 90 * 60000) - now) / 60000) : null; // ~90min after sunset = astro dark

      // Check upcoming events urgency
      var met = nextMeteorPeak(now);
      var opp = nextOpposition(now);
      var conj = nextConjunction(now);
      var ecl = nextEclipse(now);
      var meteorTonight = met && met.days === 0;
      var oppSoon = opp && daysUntil(now, opp.d) <= 7;
      var conjTonight = conj && daysUntil(now, conj.d) <= 1;

      // Check what planets are visible right now
      var planetsVisible = [];
      ['mercury','venus','mars','jupiter','saturn'].forEach(function(name) {
        try {
          var rd = planetRaDec(name, now);
          var aa = altAz(rd.ra, rd.dec, now, lat, lon);
          var alt = deg(aa.alt);
          if (alt > 10) planetsVisible.push({ name: PLANET_DATA[name].name, alt: Math.round(alt), symbol: PLANET_DATA[name].symbol });
        } catch(e) {}
      });

      // Check Milky Way
      var mw = getMilkyWayStatus(now, lat, lon);

      // Priority color
      var priCol = function(level) {
        return level === 'urgent' ? '#f44' : level === 'go' ? '#4f8' : level === 'tip' ? '#78a0ff' : level === 'wait' ? '#f90' : '#aaa';
      };

      //  DECISION TREE 

      // SCENARIO 1: Daytime  nothing to observe (with exceptions)
      if (isDaytime) {
        if (minsToSunset != null && minsToSunset > 0 && minsToSunset < 120) {
          advise.push({ pri:'go', icon:'', text:'Sunset in ' + minsToSunset + ' min. ' + (isClear ? 'Clear skies  twilight observing starts soon. Venus/Mercury may be visible shortly after sunset.' : 'Clouds at ' + cloudCover + '%  monitor for breaks.') });
        } else {
          advise.push({ pri:'info', icon:'', text:'Daytime  visual astronomy starts after sunset' + (ss ? ' (' + ss.toLocaleTimeString([], {hour:'numeric',minute:'2-digit'}) + ')' : '') + '. ' + (isClear ? 'Skies look promising for tonight.' : 'Cloud cover currently ' + cloudCover + '%.') });
        }
        // Daytime solar observing
        if (isClear) {
          advise.push({ pri:'tip', icon:'', text:'Clear daytime sky  excellent for solar observing with a proper solar filter. Sunspots, prominences, and granulation visible.' });
        }
        // Prep advice
        if (score.total >= 60) {
          advise.push({ pri:'tip', icon:'', text:'Tonight looks good (score ' + score.total + '/100). Prep your equipment now: cool down optics, charge batteries, plan targets.' });
        }
      }

      // SCENARIO 2: Twilight  transition period
      else if (isTwilight || isCivil) {
        advise.push({ pri:'go', icon:'', text:'Twilight  bright planets and the Moon are visible now. ' + (planetsVisible.length > 0 ? planetsVisible.map(function(p) { return p.symbol + ' ' + p.name + ' (' + p.alt + ')'; }).join(', ') + ' above horizon.' : 'Planets may emerge as sky darkens.') });
        if (minsToDark != null && minsToDark > 0) {
          advise.push({ pri:'tip', icon:'', text:'Full darkness in ~' + minsToDark + ' min. Use this time to set up equipment, let optics cool, and align your finder scope.' });
        }
      }

      // SCENARIO 3: Night  main observing scenarios
      else if (isDark) {

        // 3A: EXCELLENT conditions  go observe!
        if (score.total >= 80 && isClear) {
          advise.push({ pri:'go', icon:'', text:'EXCEPTIONAL SKY  Score ' + score.total + '/100. This is a rare night. Drop everything and observe. Faint galaxies, nebulae, and the Milky Way at their best.' });
          if (mw.core) advise.push({ pri:'go', icon:'', text:'Milky Way core ' + (mw.optimal ? 'perfectly positioned' : 'rising') + ' at ' + Math.round(mw.alt) + ' ' + mw.dir + '. Prime deep-sky zone in Sagittarius/Scorpius.' });
          if (moonIll != null && moonIll < 10) advise.push({ pri:'go', icon:'', text:'Nearly new moon (' + moonIll + '%)  zero moonlight interference. Faintest objects accessible tonight.' });
        }

        // 3B: GOOD conditions
        else if (score.total >= 60 && (isClear || isPartly)) {
          advise.push({ pri:'go', icon:'', text:'Good observing night (score ' + score.total + '). ' + (isPartly ? 'Partly cloudy  work the gaps. ' : '') + 'Planets, bright DSOs, and double stars will show well.' });
        }

        // 3C: FAIR conditions
        else if (score.total >= 35 && !isOvercast) {
          advise.push({ pri:'tip', icon:'', text:'Fair conditions (score ' + score.total + '). Stick to bright targets: planets, Moon, bright clusters. Faint objects will be washed out by ' +
            (moonIll > 50 ? 'moonlight' : cloudCover > 40 ? 'clouds' : rh > 80 ? 'humidity haze' : 'atmospheric conditions') + '.' });
        }

        // 3D: POOR/OVERCAST  don't bother (or lunar/planetary only)
        else if (isOvercast) {
          advise.push({ pri:'wait', icon:'', text:'Overcast (' + cloudCover + '% cloud). Visual astronomy not possible. ' });
          // Check if clearing is coming
          var st = window._stormTrack;
          if (st && st.events) {
            var clearEvts = st.events.filter(function(e) { return e.type === 'clearing' || e.type === 'clear_window'; });
            if (clearEvts.length > 0) {
              advise.push({ pri:'tip', icon:'', text:'Clearing may be coming: ' + clearEvts[0].detail });
            }
          }
          advise.push({ pri:'info', icon:'', text:'Good night for: planning future sessions, learning constellations from charts, reading about upcoming events, or processing astrophotos.' });
        }

        else if (score.total < 35) {
          advise.push({ pri:'wait', icon:'', text:'Poor conditions (score ' + score.total + '). Limited to bright planets and the Moon if visible through gaps.' });
        }

        //  EVENT-DRIVEN URGENCY OVERRIDES 

        // Meteor shower tonight
        if (meteorTonight && !isOvercast) {
          var showerData = METEOR_SHOWERS.find(function(s) { return s.name === met.name; });
          advise.push({ pri:'urgent', icon:'', text:met.name + ' meteor shower peaks TONIGHT! Up to ' + (showerData ? showerData.zhr : '?') + '/hr. Look ' + (showerData ? showerData.direction : 'overhead') + ' after ' + (showerData ? showerData.bestView : 'midnight') + '. ' + (moonIll > 50 ? 'Moon interference  face away from it.' : 'Dark moon = perfect!') });
        }

        // Opposition right now
        if (oppSoon && !isOvercast) {
          var oppDays = daysUntil(now, opp.d);
          advise.push({ pri:'urgent', icon:'', text:opp.planet + ' at opposition ' + (oppDays === 0 ? 'TODAY' : 'in ' + oppDays + 'd') + '! Brightest and closest (mag ' + opp.magnitude + '). Visible all night in ' + opp.constellation + '. ' + opp.note });
        }

        // Conjunction tonight
        if (conjTonight && !isOvercast) {
          advise.push({ pri:'urgent', icon:'', text:conj.bodies + ' conjunction ' + (daysUntil(now, conj.d) === 0 ? 'TONIGHT' : 'TOMORROW') + '! Only ' + conj.separation + ' apart. Look ' + conj.direction + ' at ' + conj.time.toLowerCase() + '. ' + conj.note });
        }

        //  EQUIPMENT-SPECIFIC RECOMMENDATIONS 
        if (score.total >= 50 && !isOvercast) {
          var recs = [];

          // Naked eye
          if (mw.visible && moonIll < 30) recs.push(' Naked eye: Milky Way, constellations, ' + (meteorTonight ? met.name + ' meteors' : 'satellite passes'));
          else if (moonIll < 50) recs.push(' Naked eye: Constellations, bright planets, satellite passes');

          // Binoculars
          var month = now.getMonth() + 1;
          var binocTargets = DSO_CATALOG.filter(function(d) {
            return d.bestMonths.indexOf(month) >= 0 && (d.minAperture === 'naked eye' || d.minAperture === 'binoculars');
          });
          if (binocTargets.length > 0) {
            recs.push(' Binoculars: ' + binocTargets.slice(0, 3).map(function(d) { return d.id + ' ' + d.name; }).join(', '));
          }

          // Telescope
          if (score.total >= 60) {
            if (planetsVisible.length > 0) {
              var bestPlanet = planetsVisible.sort(function(a,b) { return b.alt - a.alt; })[0];
              recs.push(' Telescope priority: ' + bestPlanet.symbol + ' ' + bestPlanet.name + ' at ' + bestPlanet.alt + '  ' + PLANET_DATA[bestPlanet.name.toLowerCase()].telescope.split('.')[0] + '.');
            }
            var scopeTargets = DSO_CATALOG.filter(function(d) {
              return d.bestMonths.indexOf(month) >= 0 && d.minAperture.indexOf('telescope') >= 0 && d.difficulty !== 'hard';
            });
            if (scopeTargets.length > 0) {
              recs.push(' Deep sky: ' + scopeTargets.slice(0, 2).map(function(d) { return d.id + ' ' + d.name; }).join(', '));
            }
          }

          // Astrophotography
          if (score.total >= 70 && moonIll < 30) {
            recs.push(' Imaging: Excellent night for astrophotography. Low moon, good transparency. Wide-field Milky Way or tracked deep-sky targets.');
          } else if (score.total >= 50 && moonIll >= 50) {
            recs.push(' Imaging: Bright moon  stick to lunar/planetary imaging or use narrowband filters for DSOs.');
          }

          if (recs.length > 0) {
            advise.push({ pri:'tip', icon:'', text:'EQUIPMENT GUIDE', recs: recs });
          }
        }

        //  ATMOSPHERIC NOTES 
        if (wind > 20 && score.total >= 40) {
          advise.push({ pri:'info', icon:'', text:'High wind (' + wind + ' mph) degrades seeing. Planetary detail and high-magnification work will suffer. Stick to low-power wide-field views.' });
        }
        if (rh > 85 && score.total >= 40) {
          advise.push({ pri:'info', icon:'', text:'High humidity (' + rh + '%)  dew risk on optics. Use a dew shield or heated strap. Lens heater for camera lenses.' });
        }
        if (wx.temp != null && wx.temp < 30) {
          advise.push({ pri:'info', icon:'', text:'Cold (' + wx.temp + 'F)  dress in layers, bring hand warmers. Batteries drain fast. Keep spares warm in a pocket.' });
        }
      }

      //  RENDER ADVISOR 
      if (advise.length === 0) return;

      out += '<div style="margin-bottom:6px;">';
      advise.forEach(function(a) {
        var col = priCol(a.pri);
        var bgAlpha = a.pri === 'urgent' ? '.08' : a.pri === 'go' ? '.05' : '.03';
        var borderW = a.pri === 'urgent' ? '3px' : '2px';

        out += '<div style="padding:4px 7px;margin-bottom:3px;background:rgba(' + (a.pri === 'urgent' ? '255,68,68' : a.pri === 'go' ? '68,255,136' : a.pri === 'tip' ? '100,140,255' : a.pri === 'wait' ? '255,153,0' : '170,170,170') + ',' + bgAlpha + ');border-radius:5px;border-left:' + borderW + ' solid ' + col + ';">';
        out += '<div style="font-size:.42rem;color:' + col + ';line-height:1.35;">';
        out += '<span style="font-size:.46rem;">' + a.icon + '</span> ' + a.text;
        out += '</div>';

        // Equipment sub-recommendations
        if (a.recs) {
          a.recs.forEach(function(r) {
            out += '<div style="font-size:.38rem;color:#aaa;line-height:1.3;margin-top:2px;padding-left:6px;border-left:1px solid rgba(255,255,255,.06);">' + r + '</div>';
          });
        }

        out += '</div>';
      });
      out += '</div>';
    })();

    //  Milky Way Status 
    if (isDark) {
      var mw = getMilkyWayStatus(now, lat, lon);
      var mwCol = mw.rating === 'excellent' ? '#4f8' : mw.rating === 'good' ? '#78a0ff' : mw.rating === 'fair' ? '#f90' : '#888';
      out += '<div style="padding:4px 6px;background:rgba(255,255,255,.02);border-radius:4px;margin-bottom:5px;border-left:2px solid ' + mwCol + ';">';
      out += '<div style="font-size:.42rem;font-weight:700;color:' + mwCol + ';">MILKY WAY</div>';
      out += '<div style="font-size:.40rem;color:#aaa;line-height:1.3;">' + mw.narrative + '</div>';
      out += '</div>';
    }

    //  PLANETS TONIGHT  Real-time positions, detail cards, telescope guide 
    (function() {
      var planetNames = ['mercury','venus','mars','jupiter','saturn','uranus','neptune'];
      var planetPositions = [];
      var sunRaH = sunRd.ra;

      planetNames.forEach(function(name) {
        try {
          var rd = planetRaDec(name, now);
          var aa = altAz(rd.ra, rd.dec, now, lat, lon);
          var altDeg2 = deg(aa.alt);
          var azDeg2 = deg(aa.az);
          var dirs16 = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
          var dir2 = dirs16[Math.round(((azDeg2 % 360) + 360) % 360 / 22.5) % 16];
          var pd = PLANET_DATA[name];
          if (!pd) return;

          // Elongation from Sun (rough, degrees)
          var elong = Math.abs(rd.ra * 15 - sunRaH * 15);
          if (elong > 180) elong = 360 - elong;

          // Determine observing quality for this planet
          var quality = 'not visible';
          if (altDeg2 > 30) quality = 'excellent';
          else if (altDeg2 > 20) quality = 'good';
          else if (altDeg2 > 10) quality = 'fair';
          else if (altDeg2 > 0) quality = 'low  atmospheric distortion';

          // Is it setting or rising?
          var futureDate = new Date(now.getTime() + 30 * 60000);
          var futRd = planetRaDec(name, futureDate);
          var futAa = altAz(futRd.ra, futRd.dec, futureDate, lat, lon);
          var futAlt = deg(futAa.alt);
          var trend = futAlt > altDeg2 ? 'rising' : 'setting';

          // Get relevant missions for this planet
          var missionKey = name;
          var missions = SPACE_MISSIONS[missionKey] || [];

          planetPositions.push({
            name: pd.name, key: name, symbol: pd.symbol, color: pd.color,
            alt: altDeg2, az: azDeg2, dir: dir2, elong: elong,
            quality: quality, trend: trend,
            data: pd, missions: missions,
            isUp: altDeg2 > 0, isVisible: altDeg2 > 5 && (isDark || name === 'venus')
          });
        } catch(e) {}
      });

      // Sort: visible first, then by altitude descending
      planetPositions.sort(function(a, b) {
        if (a.isVisible && !b.isVisible) return -1;
        if (!a.isVisible && b.isVisible) return 1;
        return b.alt - a.alt;
      });

      var visCount = planetPositions.filter(function(p) { return p.isVisible; }).length;

      out += '<div style="margin-bottom:6px;">';
      out += '<div style="font-size:.46rem;font-weight:700;color:#64b5f6;margin-bottom:2px;">PLANETS' + (isDark ? '  ' + visCount + ' VISIBLE NOW' : '') + '</div>';

      // Overview strip  all 7 planets at a glance
      out += '<div style="display:flex;gap:2px;margin-bottom:5px;padding:3px 0;">';
      planetPositions.forEach(function(p) {
        var isVis = p.isVisible && isDark;
        var stripCol = isVis ? p.color : 'rgba(255,255,255,.12)';
        var txtCol = isVis ? '#fff' : 'rgba(255,255,255,.25)';
        out += '<div style="flex:1;text-align:center;padding:3px 1px;background:' + (isVis ? 'rgba(255,255,255,.04)' : 'transparent') + ';border-radius:4px;border-bottom:2px solid ' + stripCol + ';">';
        out += '<div style="font-size:.38rem;color:' + stripCol + ';">' + p.symbol + '</div>';
        out += '<div style="font-size:.28rem;color:' + txtCol + ';">' + p.name.substring(0, 3) + '</div>';
        out += '<div style="font-size:.26rem;color:' + (p.isUp ? (p.alt > 20 ? '#4f8' : '#f90') : '#f44') + ';">' + (p.isUp ? p.alt.toFixed(0) + '' : 'set') + '</div>';
        out += '</div>';
      });
      out += '</div>';

      // Detail cards for visible planets (or all if daytime preview)
      var showPlanets = isDark ? planetPositions.filter(function(p) { return p.isUp; }) : planetPositions.filter(function(p) { return p.isUp || p.alt > -15; });
      showPlanets = showPlanets.slice(0, 5); // limit to avoid overwhelming

      showPlanets.forEach(function(p) {
        var qualCol = p.quality === 'excellent' ? '#4f8' : p.quality === 'good' ? '#78a0ff' : p.quality === 'fair' ? '#f90' : p.alt > 0 ? '#f44' : '#555';
        var trendIcon = p.trend === 'rising' ? '' : '';

        out += '<div style="padding:5px 7px;margin-bottom:2px;background:rgba(255,255,255,.02);border-radius:6px;border-left:3px solid ' + p.color + ';">';

        // Header row: name, position, quality
        out += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;">';
        out += '<div style="display:flex;align-items:center;gap:5px;">';
        out += '<span style="font-size:.54rem;color:' + p.color + ';">' + p.symbol + '</span>';
        out += '<span style="font-size:.48rem;font-weight:800;color:#ddd;">' + p.name + '</span>';
        out += '<span style="font-size:.34rem;color:#666;font-style:italic;">' + p.data.type + '</span>';
        out += '</div>';
        out += '<div style="text-align:right;">';
        if (p.isUp) {
          out += '<div style="font-size:.40rem;font-weight:700;color:' + qualCol + ';">' + p.alt.toFixed(0) + ' ' + p.dir + ' ' + trendIcon + '</div>';
          out += '<div style="font-size:.30rem;color:#666;">' + p.quality + '</div>';
        } else {
          out += '<div style="font-size:.36rem;color:#555;">Below horizon</div>';
        }
        out += '</div></div>';

        // Physical stats row
        out += '<div style="display:flex;gap:3px;margin-bottom:3px;flex-wrap:wrap;">';
        var stats = [
          { label:'', value:p.data.diameter.toLocaleString() + ' mi' },
          { label:'', value:p.data.distSun + ' AU' },
          { label:'Year', value:p.data.yearLen },
          { label:'Day', value:p.data.dayLen }
        ];
        if (p.data.moons > 0) stats.push({ label:'Moons', value:String(p.data.moons) });
        if (p.data.angSizeRange) stats.push({ label:'Disk', value:p.data.angSizeRange });
        stats.forEach(function(s) {
          out += '<div style="padding:1px 4px;background:rgba(255,255,255,.03);border-radius:3px;font-size:.30rem;">';
          out += '<span style="color:#666;">' + s.label + '</span> <span style="color:#aaa;">' + s.value + '</span>';
          out += '</div>';
        });
        out += '</div>';

        // Telescope guide
        out += '<div style="font-size:.38rem;color:#aaa;line-height:1.3;margin-bottom:2px;">';
        out += '<span style="color:#64b5f6;font-weight:600;">SCOPE: </span>' + p.data.telescope;
        out += '</div>';

        // Random fact
        var fact = p.data.facts ? p.data.facts[Math.floor(now.getMinutes() / 9) % p.data.facts.length] : null;
        if (fact) {
          out += '<div style="font-size:.34rem;color:#78a0ff;line-height:1.3;margin-bottom:2px;">';
          out += fact;
          out += '</div>';
        }

        // Observing tip
        if (p.data.tip) {
          out += '<div style="font-size:.34rem;color:#f90;line-height:1.25;margin-bottom:2px;">';
          out += p.data.tip;
          out += '</div>';
        }

        // Active missions at this planet
        if (p.missions.length > 0) {
          out += '<div style="margin-top:2px;padding-top:2px;border-top:1px solid rgba(255,255,255,.04);">';
          out += '<div style="font-size:.32rem;color:#666;font-weight:600;margin-bottom:1px;">MISSIONS AT ' + p.name.toUpperCase() + '</div>';
          p.missions.forEach(function(m) {
            var statusCol = m.status === 'Active' ? '#4f8' : m.status === 'En route' ? '#f90' : '#78a0ff';
            out += '<div style="font-size:.32rem;color:#888;line-height:1.3;">';
            out += '<span style="color:' + statusCol + ';font-weight:600;">' + m.name + '</span>';
            out += ' <span style="opacity:.6;">(' + m.agency + ', ' + m.type + ', ' + m.since + ')</span>  ' + m.note;
            out += '</div>';
          });
          out += '</div>';
        }

        // Upcoming opposition/conjunction awareness
        var opp2 = nextOpposition(now);
        if (opp2 && opp2.planet.toLowerCase() === p.key) {
          var oppDays = daysUntil(now, opp2.d);
          if (oppDays <= 60) {
            var oppCol = oppDays <= 7 ? '#f44' : oppDays <= 21 ? '#f90' : '#78a0ff';
            out += '<div style="margin-top:2px;padding:2px 5px;background:rgba(255,170,0,.06);border-radius:3px;border-left:2px solid ' + oppCol + ';">';
            out += '<span style="font-size:.34rem;font-weight:700;color:' + oppCol + ';">OPPOSITION ' + (oppDays === 0 ? 'TODAY' : 'IN ' + oppDays + 'd') + '</span>';
            out += '<span style="font-size:.32rem;color:#aaa;">  ' + opp2.note + ' (mag ' + opp2.magnitude + ' in ' + opp2.constellation + ')</span>';
            out += '</div>';
          }
        }

        var conj2 = nextConjunction(now);
        if (conj2 && conj2.bodies.toLowerCase().indexOf(p.key) >= 0) {
          var conjDays = daysUntil(now, conj2.d);
          if (conjDays <= 30) {
            var cjCol = conjDays <= 3 ? '#f44' : conjDays <= 14 ? '#f90' : '#78a0ff';
            out += '<div style="margin-top:2px;padding:2px 5px;background:rgba(120,160,255,.06);border-radius:3px;border-left:2px solid ' + cjCol + ';">';
            out += '<span style="font-size:.34rem;font-weight:700;color:' + cjCol + ';">CONJUNCTION ' + (conjDays === 0 ? 'TODAY' : 'IN ' + conjDays + 'd') + '</span>';
            out += '<span style="font-size:.32rem;color:#aaa;">  ' + conj2.bodies + ', ' + conj2.separation + ' apart. ' + conj2.note + '</span>';
            out += '</div>';
          }
        }

        out += '</div>';
      });

      // Below-horizon summary for planets not shown
      var belowPlanets = planetPositions.filter(function(p) { return !p.isUp; });
      if (belowPlanets.length > 0 && isDark) {
        out += '<div style="font-size:.32rem;color:#555;margin-top:2px;">Below horizon: ';
        out += belowPlanets.map(function(p) { return p.symbol + ' ' + p.name + ' (' + p.alt.toFixed(0) + ')'; }).join('  ');
        out += '</div>';
      }

      out += '</div>';
    })();

    //  Tonight's Visible DSOs 
    if (isDark && score.total >= 30) {
      var month = now.getMonth() + 1;
      var visibleDSOs = [];

      DSO_CATALOG.forEach(function(dso) {
        // Check if in season
        if (dso.bestMonths.indexOf(month) === -1) return;
        // Compute current altitude
        var aa = altAz(dso.ra / 15, dso.dec, now, lat, lon);
        var altDeg = deg(aa.alt);
        if (altDeg < 15) return; // below treeline

        var azDeg = deg(aa.az);
        var dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
        var dir = dirs[Math.round(((azDeg % 360) + 360) % 360 / 22.5) % 16];

        visibleDSOs.push({
          dso: dso,
          alt: altDeg,
          dir: dir,
          score: altDeg + (dso.difficulty === 'easy' ? 20 : 0) + (14 - dso.mag) * 3
        });
      });

      visibleDSOs.sort(function(a, b) { return b.score - a.score; });

      if (visibleDSOs.length > 0) {
        out += '<div style="margin-bottom:5px;">';
        out += '<div style="font-size:.42rem;color:#64b5f6;font-weight:700;margin-bottom:3px;">TONIGHT\'S TOP TARGETS</div>';

        visibleDSOs.slice(0, 5).forEach(function(v) {
          var d = v.dso;
          var typeCol = d.type === 'galaxy' ? '#e8a954' : d.type === 'nebula' ? '#ff6b9d' : d.type === 'globular' ? '#f0c75e' : d.type === 'open cluster' ? '#8ecae6' : d.type === 'planetary nebula' ? '#4f8' : '#aaa';
          var typeIcon = d.type === 'galaxy' ? '' : d.type === 'nebula' ? '' : d.type === 'globular' ? '' : d.type === 'open cluster' ? '' : d.type === 'planetary nebula' ? '' : d.type === 'supernova remnant' ? '' : '';

          out += '<div style="display:flex;gap:6px;align-items:flex-start;margin-bottom:2px;padding:4px 6px;background:rgba(255,255,255,.02);border-radius:4px;border-left:2px solid ' + typeCol + ';">';
          out += '<div style="flex-shrink:0;text-align:center;min-width:40px;">';
          out += '<div style="font-size:.52rem;">' + typeIcon + '</div>';
          out += '<div style="font-size:.34rem;color:' + typeCol + ';font-weight:700;">' + d.id + '</div>';
          out += '</div>';
          out += '<div style="flex:1;min-width:0;">';
          out += '<div style="font-size:.46rem;font-weight:700;color:#ddd;">' + d.name + '</div>';
          out += '<div style="font-size:.38rem;color:#888;margin-bottom:1px;">';
          out += '<span style="color:' + typeCol + ';">' + d.type + '</span>';
          out += '  mag ' + d.mag + '  ' + d.con;
          out += '  <b style="color:#4f8;">' + Math.round(v.alt) + ' ' + v.dir + '</b>';
          out += '</div>';
          out += '<div style="font-size:.36rem;color:#999;line-height:1.3;">' + d.desc + '</div>';
          out += '<div style="font-size:.32rem;color:#666;margin-top:1px;">Needs: ' + d.minAperture + '  Difficulty: ' + d.difficulty + '</div>';
          out += '</div></div>';
        });
        out += '</div>';
      }
    }

    //  Clear Sky Window Finder 
    var st = window._stormTrack;
    if (st && st.events) {
      var clearEvts = st.events.filter(function(e) { return e.type === 'clearing' || e.type === 'clear_window'; });
      if (clearEvts.length > 0 && score.total < 50) {
        out += '<div style="padding:4px 6px;background:rgba(100,255,150,.04);border-radius:4px;margin-bottom:5px;border-left:2px solid rgba(100,255,150,.3);">';
        out += '<div style="font-size:.42rem;font-weight:700;color:#4f8;">NEXT CLEAR WINDOW</div>';
        clearEvts.forEach(function(ce) {
          out += '<div style="font-size:.40rem;color:#aaa;line-height:1.3;">' + ce.icon + ' ' + ce.detail + '</div>';
        });
        out += '</div>';
      }
    }

    // 
    // TONIGHT'S SKY FORECAST  Hour-by-hour visual timeline
    // Cloud layers, darkness depth, moon position, transparency,
    // and observing quality through the night.
    // 
    (function() {
      var hourly = window._wxHourly;
      var ni = window._wxNearestIdx;
      if (!hourly || !hourly.time || !hourly.cloudcover || ni == null) return;

      // Find tonight's sunset and tomorrow's sunrise
      var ssTime = wx.sunset ? new Date(wx.sunset) : null;
      var srTime = wx.sunrise ? new Date(wx.sunrise) : null;
      if (!ssTime || !srTime) return;

      // If it's before sunset, use today's sunsettomorrow sunrise
      // If it's after sunset, use today's times (we're already in the observing window)
      var tonight_start, tonight_end;
      if (now < ssTime) {
        tonight_start = ssTime;
        // Find next sunrise (could be tomorrow)
        tonight_end = new Date(srTime.getTime() + 86400000); // approximate next sunrise
      } else {
        tonight_start = ssTime;
        tonight_end = srTime;
        // If sunrise is before now (ie we're past midnight), push to tomorrow
        if (tonight_end < now) {
          tonight_end = new Date(srTime.getTime() + 86400000);
        }
      }

      // Collect hourly data for tonight's observing window (extend 1hr before sunset, 1hr after sunrise)
      var windowStart = new Date(tonight_start.getTime() - 3600000);
      var windowEnd = new Date(tonight_end.getTime() + 3600000);
      var slots = [];

      for (var si = 0; si < hourly.time.length; si++) {
        var slotTime = new Date(hourly.time[si]);
        if (slotTime < windowStart || slotTime > windowEnd) continue;

        var cc = typeof hourly.cloudcover[si] === 'number' ? hourly.cloudcover[si] : null;
        var ccLow = hourly.cloud_cover_low ? hourly.cloud_cover_low[si] : null;
        var ccMid = hourly.cloud_cover_mid ? hourly.cloud_cover_mid[si] : null;
        var ccHigh = hourly.cloud_cover_high ? hourly.cloud_cover_high[si] : null;
        var rhVal = hourly.relativehumidity_2m ? hourly.relativehumidity_2m[si] : null;
        var visVal = hourly.visibility ? hourly.visibility[si] : null;
        var windVal = hourly.windspeed_10m ? hourly.windspeed_10m[si] : null;
        var tempVal = hourly.temperature_2m ? hourly.temperature_2m[si] : null;
        var precipProb = hourly.precipitation_probability ? hourly.precipitation_probability[si] : null;

        // Compute sun altitude for this hour
        var slotSunD = daysSinceJ2000(slotTime);
        var slotSunEc = sunEcliptic(slotSunD);
        var slotSunEq = eclToEqu(slotSunEc.x, slotSunEc.y, slotSunEc.z, slotSunD);
        var slotSunRd = raDecFromEqu(slotSunEq);
        var slotSunAA = altAz(slotSunRd.ra, slotSunRd.dec, slotTime, lat, lon);
        var slotSunAlt = deg(slotSunAA.alt);

        // Compute moon altitude for this hour
        var slotMoonRd = moonRaDec(slotTime);
        var slotMoonAA = altAz(slotMoonRd.ra, slotMoonRd.dec, slotTime, lat, lon);
        var slotMoonAlt = deg(slotMoonAA.alt);

        // Darkness category
        var darkCat = slotSunAlt < -18 ? 'astro' : slotSunAlt < -12 ? 'nautical' : slotSunAlt < -6 ? 'civil' : slotSunAlt < 0 ? 'horizon' : 'day';

        // Per-hour observing quality (simplified)
        var slotScore = 0;
        if (cc != null) slotScore += cc < 10 ? 30 : cc < 25 ? 22 : cc < 50 ? 12 : cc < 70 ? 5 : 0;
        if (darkCat === 'astro') slotScore += 25;
        else if (darkCat === 'nautical') slotScore += 15;
        else if (darkCat === 'civil') slotScore += 5;
        if (moonIll != null) {
          if (slotMoonAlt < 0) slotScore += 20; // moon below horizon = bonus
          else if (moonIll < 20) slotScore += 15;
          else if (moonIll < 50) slotScore += 8;
          else slotScore += 0;
        } else slotScore += 10;
        if (rhVal != null) slotScore += rhVal < 50 ? 10 : rhVal < 70 ? 7 : rhVal < 85 ? 3 : 0;
        if (windVal != null) slotScore += windVal < 8 ? 10 : windVal < 15 ? 6 : windVal < 25 ? 2 : 0;
        // Precipitation penalty
        if (precipProb != null && precipProb > 30) slotScore -= 15;

        slots.push({
          time: slotTime,
          hr: slotTime.getHours(),
          cc: cc, ccLow: ccLow, ccMid: ccMid, ccHigh: ccHigh,
          rh: rhVal, vis: visVal, wind: windVal, temp: tempVal,
          precipProb: precipProb,
          sunAlt: slotSunAlt, moonAlt: slotMoonAlt,
          darkCat: darkCat, score: Math.max(0, Math.min(100, slotScore))
        });
      }

      if (slots.length < 4) return;

      //  Find best observing window (contiguous hours with score  50) 
      var bestRunStart = -1, bestRunLen = 0, bestRunAvg = 0;
      var runStart = -1, runLen = 0, runSum = 0;
      for (var ri = 0; ri < slots.length; ri++) {
        if (slots[ri].score >= 40 && slots[ri].darkCat !== 'day') {
          if (runStart < 0) runStart = ri;
          runLen++;
          runSum += slots[ri].score;
        } else {
          if (runLen > bestRunLen || (runLen === bestRunLen && runLen > 0 && runSum / runLen > bestRunAvg)) {
            bestRunStart = runStart; bestRunLen = runLen; bestRunAvg = runLen > 0 ? runSum / runLen : 0;
          }
          runStart = -1; runLen = 0; runSum = 0;
        }
      }
      if (runLen > bestRunLen || (runLen === bestRunLen && runLen > 0 && runSum / runLen > bestRunAvg)) {
        bestRunStart = runStart; bestRunLen = runLen; bestRunAvg = runLen > 0 ? runSum / runLen : 0;
      }

      //  RENDER TIMELINE 
      out += '<div style="margin-bottom:6px;">';
      out += '<div style="font-size:.44rem;font-weight:700;color:#64b5f6;margin-bottom:2px;"> TONIGHT\'S SKY FORECAST</div>';

      // Summary line
      var avgCC = 0, clearHrs = 0, darkHrs = 0;
      slots.forEach(function(s) {
        if (s.cc != null) avgCC += s.cc;
        if (s.cc != null && s.cc < 25 && s.darkCat === 'astro') clearHrs++;
        if (s.darkCat === 'astro') darkHrs++;
      });
      avgCC = slots.length > 0 ? Math.round(avgCC / slots.length) : 0;

      var sumCol = clearHrs >= 6 ? '#4f8' : clearHrs >= 3 ? '#78a0ff' : clearHrs >= 1 ? '#f90' : '#f44';
      out += '<div style="font-size:.38rem;color:' + sumCol + ';margin-bottom:2px;">';
      out += clearHrs + ' clear dark hr' + (clearHrs !== 1 ? 's' : '') + ' tonight  ' + darkHrs + ' hrs astronomical darkness  avg cloud ' + avgCC + '%';
      if (bestRunLen >= 2) {
        var bStart = slots[bestRunStart].time;
        var bEnd = slots[bestRunStart + bestRunLen - 1].time;
        var fmtHr = function(d) { var h = d.getHours(); return (h % 12 || 12) + (h < 12 ? 'a' : 'p'); };
        out += '  <b style="color:#4f8;">Best window: ' + fmtHr(bStart) + '' + fmtHr(bEnd) + '</b>';
      }
      out += '</div>';

      //  Visual bar chart 
      var barH = 60;
      out += '<div style="position:relative;height:' + (barH + 38) + 'px;background:rgba(0,0,0,.15);border-radius:6px;overflow:hidden;margin-bottom:2px;">';

      // Slot width
      var slotW = (100 / slots.length);

      // Darkness background bands
      slots.forEach(function(s, idx) {
        var bgCol = s.darkCat === 'astro' ? 'rgba(0,0,30,.6)' : s.darkCat === 'nautical' ? 'rgba(10,10,50,.4)' : s.darkCat === 'civil' ? 'rgba(30,30,80,.25)' : s.darkCat === 'horizon' ? 'rgba(80,60,40,.15)' : 'rgba(120,100,60,.1)';
        out += '<div style="position:absolute;left:' + (idx * slotW) + '%;width:' + slotW + '%;top:0;bottom:0;background:' + bgCol + ';"></div>';
      });

      // Best window highlight
      if (bestRunLen >= 2) {
        out += '<div style="position:absolute;left:' + (bestRunStart * slotW) + '%;width:' + (bestRunLen * slotW) + '%;top:0;bottom:0;background:rgba(68,255,136,.04);border-left:1px solid rgba(68,255,136,.3);border-right:1px solid rgba(68,255,136,.3);"></div>';
      }

      // Cloud cover bars (inverted: taller = more cloud = worse)
      slots.forEach(function(s, idx) {
        if (s.cc == null) return;
        var h = (s.cc / 100) * barH;
        var cloudCol;
        if (s.ccHigh != null && s.ccHigh > s.ccMid && s.ccHigh > (s.ccLow||0)) cloudCol = 'rgba(150,150,200,.5)'; // high = thin
        else if (s.ccMid != null && s.ccMid > (s.ccLow||0)) cloudCol = 'rgba(120,120,160,.6)'; // mid
        else cloudCol = 'rgba(80,80,100,.8)'; // low = thick

        out += '<div style="position:absolute;left:' + (idx * slotW + slotW * 0.1) + '%;width:' + (slotW * 0.8) + '%;bottom:18px;height:' + h + 'px;background:' + cloudCol + ';border-radius:2px 2px 0 0;"></div>';

        // Cloud layer breakdown (tiny dots at bottom of bar)
        if (s.ccLow != null && s.ccLow > 20) {
          out += '<div style="position:absolute;left:' + (idx * slotW + slotW * 0.15) + '%;bottom:' + (18 + h - 3) + 'px;width:3px;height:3px;border-radius:50%;background:#f44;opacity:.7;" title="Low cloud ' + s.ccLow + '%"></div>';
        }
        if (s.ccHigh != null && s.ccHigh > 30 && (s.ccLow||0) < 20) {
          out += '<div style="position:absolute;left:' + (idx * slotW + slotW * 0.6) + '%;bottom:' + (18 + h - 3) + 'px;width:3px;height:3px;border-radius:50%;background:#78a0ff;opacity:.7;" title="High cloud ' + s.ccHigh + '%"></div>';
        }
      });

      // Moon altitude trace (yellow curve)
      var moonIllum = moonIll || 0;
      if (moonIllum > 5) {
        var moonPts = [];
        slots.forEach(function(s, idx) {
          if (s.moonAlt > -10) {
            var yPct = Math.max(0, Math.min(1, (s.moonAlt + 10) / 80)); // -10 to 70 range
            var y = barH - (yPct * (barH - 5)) + 0;
            moonPts.push((idx * slotW + slotW / 2) + '% ' + y + 'px');
          }
        });
        if (moonPts.length >= 2) {
          // Draw moon path as a series of dots
          slots.forEach(function(s, idx) {
            if (s.moonAlt > 0) {
              var yPct = Math.min(1, s.moonAlt / 70);
              var y = barH - (yPct * (barH - 10));
              var moonOpacity = moonIllum > 60 ? 0.8 : moonIllum > 30 ? 0.5 : 0.3;
              out += '<div style="position:absolute;left:calc(' + (idx * slotW + slotW / 2) + '% - 2px);top:' + y + 'px;width:4px;height:4px;border-radius:50%;background:rgba(255,230,100,' + moonOpacity + ');"></div>';
            }
          });
          // Moon label
          var peakMoonSlot = slots.reduce(function(best, s) { return s.moonAlt > best.moonAlt ? s : best; }, slots[0]);
          if (peakMoonSlot.moonAlt > 5) {
            var peakIdx = slots.indexOf(peakMoonSlot);
            var peakY = barH - (Math.min(1, peakMoonSlot.moonAlt / 70) * (barH - 10));
            out += '<div style="position:absolute;left:' + (peakIdx * slotW) + '%;top:' + (peakY - 10) + 'px;font-size:.26rem;color:rgba(255,230,100,.7);">' + moonIllum + '%</div>';
          }
        }
      }

      // Observing quality gradient at bottom
      out += '<div style="position:absolute;left:0;right:0;bottom:0;height:18px;display:flex;">';
      slots.forEach(function(s) {
        var qCol = s.score >= 70 ? '#4f8' : s.score >= 50 ? '#78a0ff' : s.score >= 30 ? '#f90' : s.darkCat === 'day' ? '#444' : '#f44';
        out += '<div style="flex:1;background:' + qCol + ';opacity:.25;"></div>';
      });
      out += '</div>';

      // Time labels
      out += '<div style="position:absolute;left:0;right:0;bottom:1px;display:flex;">';
      slots.forEach(function(s, idx) {
        var showLabel = (idx % 2 === 0) || slots.length <= 10;
        var h = s.hr;
        var label = showLabel ? ((h % 12) || 12) + (h < 12 ? 'a' : 'p') : '';
        var isNow = Math.abs(s.time - now) < 1800000;
        out += '<div style="flex:1;text-align:center;font-size:.24rem;color:' + (isNow ? '#4f8' : '#555') + ';' + (isNow ? 'font-weight:900;' : '') + '">' + label + '</div>';
      });
      out += '</div>';

      out += '</div>'; // end bar chart

      //  Legend 
      out += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:3px;">';
      out += '<div style="font-size:.26rem;color:#555;"> <span style="color:rgba(80,80,100,.8);">Low cloud</span></div>';
      out += '<div style="font-size:.26rem;color:#555;"> <span style="color:rgba(120,120,160,.6);">Mid cloud</span></div>';
      out += '<div style="font-size:.26rem;color:#555;"> <span style="color:rgba(150,150,200,.5);">High cloud</span></div>';
      if (moonIllum > 5) out += '<div style="font-size:.26rem;color:#555;"> <span style="color:rgba(255,230,100,.7);">Moon path</span></div>';
      out += '<div style="font-size:.26rem;color:#555;"> <span style="color:#4f8;">Good</span>/<span style="color:#78a0ff;">Fair</span>/<span style="color:#f90;">Poor</span>/<span style="color:#f44;">Bad</span></div>';
      if (bestRunLen >= 2) out += '<div style="font-size:.26rem;color:#4f8;"> Best window</div>';
      out += '</div>';

      //  Hourly detail strip (condensed) 
      out += '<div style="display:flex;gap:1px;margin-bottom:3px;">';
      slots.forEach(function(s, idx) {
        if (idx % 2 !== 0 && slots.length > 12) return; // skip every other for long nights
        var bgAlpha = s.score >= 60 ? '.05' : '.02';
        var borderCol = s.score >= 60 ? 'rgba(68,255,136,.15)' : s.score >= 35 ? 'rgba(120,160,255,.1)' : 'rgba(255,255,255,.03)';
        var h = s.hr;
        out += '<div style="flex:1;min-width:0;padding:2px 1px;background:rgba(255,255,255,' + bgAlpha + ');border-radius:2px;text-align:center;border-top:1px solid ' + borderCol + ';">';
        out += '<div style="font-size:.24rem;color:#555;">' + ((h % 12) || 12) + (h < 12 ? 'a' : 'p') + '</div>';
        // Cloud cover %
        var ccCol = s.cc < 15 ? '#4f8' : s.cc < 40 ? '#78a0ff' : s.cc < 70 ? '#f90' : '#f44';
        out += '<div style="font-size:.28rem;font-weight:700;color:' + ccCol + ';">' + (s.cc != null ? s.cc + '%' : '?') + '</div>';
        // Darkness indicator
        var dkIcon = s.darkCat === 'astro' ? '' : s.darkCat === 'nautical' ? '' : s.darkCat === 'civil' ? '' : '';
        out += '<div style="font-size:.20rem;" title="' + s.darkCat + '">' + dkIcon + '</div>';
        // Temp
        if (s.temp != null) out += '<div style="font-size:.22rem;color:#666;">' + Math.round(s.temp) + '</div>';
        out += '</div>';
      });
      out += '</div>';

      //  Dew point / frost warning 
      var dewRisk = slots.some(function(s) { return s.rh != null && s.rh > 90; });
      var frostRisk = slots.some(function(s) { return s.temp != null && s.temp < 34; });
      var precipRisk = slots.some(function(s) { return s.precipProb != null && s.precipProb > 40; });
      if (dewRisk || frostRisk || precipRisk) {
        out += '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:2px;">';
        if (dewRisk) out += '<div style="font-size:.32rem;padding:1px 5px;background:rgba(68,170,255,.08);border-radius:3px;color:#4af;"> Dew risk  use dew shield</div>';
        if (frostRisk) out += '<div style="font-size:.32rem;padding:1px 5px;background:rgba(150,200,255,.08);border-radius:3px;color:#8cf;"> Frost likely  protect optics</div>';
        if (precipRisk) out += '<div style="font-size:.32rem;padding:1px 5px;background:rgba(255,100,100,.08);border-radius:3px;color:#f88;"> Precipitation risk tonight</div>';
        out += '</div>';
      }

      out += '</div>';
    })();

    //  Upcoming Events Calendar 
    var upcomingEvents = [];
    var nxt;
    nxt = nextEclipse(now);
    if (nxt) upcomingEvents.push({ type: 'eclipse', icon: '', name: nxt.type + ' Eclipse', date: nxt.d, detail: nxt.note, days: daysUntil(now, nxt.d) });
    nxt = nextConjunction(now);
    if (nxt) upcomingEvents.push({ type: 'conjunction', icon: '', name: nxt.bodies, date: nxt.d, detail: nxt.separation + ' apart  ' + nxt.note, days: daysUntil(now, nxt.d) });
    nxt = nextOpposition(now);
    if (nxt) upcomingEvents.push({ type: 'opposition', icon: '', name: nxt.planet + ' at Opposition', date: nxt.d, detail: 'Mag ' + nxt.magnitude + ' in ' + nxt.constellation + '  ' + nxt.note, days: daysUntil(now, nxt.d) });

    // Meteor showers
    var nearestMet = null, metDays = 999;
    for (var mi = 0; mi < METEOR_SHOWERS.length; mi++) {
      var ms = METEOR_SHOWERS[mi];
      var mPeakDate = new Date(now.getFullYear(), ms.peakStart.m - 1, ms.peakStart.d);
      if (mPeakDate < now) mPeakDate = new Date(now.getFullYear() + 1, ms.peakStart.m - 1, ms.peakStart.d);
      var mDays = daysUntil(now, mPeakDate);
      if (mDays < metDays) { metDays = mDays; nearestMet = { shower: ms, date: mPeakDate, days: mDays }; }
    }
    if (nearestMet) {
      upcomingEvents.push({ type: 'meteor', icon: '', name: nearestMet.shower.name + ' Meteors', date: nearestMet.date, detail: 'ZHR ' + nearestMet.shower.zhr + '  Best view: ' + nearestMet.shower.bestView + '  Radiant in ' + nearestMet.shower.radiant, days: nearestMet.days });
    }

    upcomingEvents.sort(function(a, b) { return a.days - b.days; });

    if (upcomingEvents.length > 0) {
      out += '<div>';
      out += '<div style="font-size:.42rem;color:#64b5f6;font-weight:700;margin-bottom:3px;">UPCOMING SKY EVENTS</div>';
      upcomingEvents.slice(0, 4).forEach(function(evt) {
        var urgency = evt.days <= 3 ? '#f44' : evt.days <= 14 ? '#f90' : evt.days <= 30 ? '#78a0ff' : '#888';
        out += '<div style="display:flex;gap:6px;align-items:flex-start;margin-bottom:3px;padding:3px 5px;background:rgba(255,255,255,.02);border-radius:4px;">';
        out += '<div style="flex-shrink:0;text-align:center;min-width:32px;">';
        out += '<div style="font-size:.48rem;">' + evt.icon + '</div>';
        out += '<div style="font-size:.32rem;color:' + urgency + ';font-weight:700;">' + (evt.days === 0 ? 'TODAY' : evt.days + 'd') + '</div>';
        out += '</div>';
        out += '<div>';
        out += '<div style="font-size:.44rem;font-weight:700;color:#ddd;">' + evt.name + '</div>';
        out += '<div style="font-size:.38rem;color:#888;">' + evt.date.toLocaleDateString('en-US', {month:'short', day:'numeric'}) + '  ' + evt.detail + '</div>';
        out += '</div></div>';
      });
      out += '</div>';
    }

    out += '</div>';
    return out;
  }

  /* =========================================================
     RADAR autoplay (NWS RIDGE loop GIF)
     ========================================================= */
  var radarRefreshTimer = null;
  function startRadarNwsLoop(){
    if (!radarLiveEl || !radarImg) return;

    var STATION = LOCATION.radar || "KENX";
    var region = LOCATION.radarRegion || "NORTHEAST";
    var base = "https://radar.weather.gov/ridge/standard/" + region + "_loop.gif";

    // Update radar subtitle
    var radarSubEl = document.querySelector(".widget:has(#radar-img) .widget-sub");
    if (radarSubEl) radarSubEl.textContent = LOCATION.radarName || "NWS";

    function refresh(){
      radarImg.src = base + "?cb=" + Date.now();
      radarImg.style.filter = "invert(1) hue-rotate(180deg) contrast(1.4) saturate(1.8)";
      radarLiveEl.textContent = " LIVE";
      
      // Update timestamp
      var tsEl = document.getElementById("local-radar-timestamp");
      if (tsEl) {
        var d = new Date();
        var h = d.getHours();
        var m = d.getMinutes();
        var ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12; if (h === 0) h = 12;
        tsEl.textContent = h + ':' + (m < 10 ? '0' + m : m) + ' ' + ampm;
      }
    }

    refresh();
    if (radarRefreshTimer) clearInterval(radarRefreshTimer);
    radarRefreshTimer = setInterval(refresh, 2 * 60 * 1000);
  }

  /* Radar mode switching (reflectivity vs hydrometeor classification) */
  var currentRadarMode = "reflectivity";
  var hydroRefreshTimer = null;
  
  function loadHydrometeorImage(){
    var container = document.getElementById("radar-hydro-container");
    if (!container) return;
    
    var STATION = (LOCATION.radar || "KOKX").toLowerCase();
    var region = LOCATION.radarRegion || "NORTHEAST";
    var W = container.clientWidth || 800;
    var H = container.clientHeight || 500;
    
    /* Use the RIDGE regional static frame as base map (same as reflectivity view) */
    var ridgeBase = "https://radar.weather.gov/ridge/standard/" + region + "_0.gif?cb=" + Date.now();
    
    /* RIDGE region extents (approx lat/lon bounding boxes for WMS alignment) */
    var regionExtents = {
      "NORTHEAST":     { minLon: -82.0, minLat: 37.0, maxLon: -66.5, maxLat: 48.0 },
      "UPPERMISSVLY":  { minLon: -98.0, minLat: 38.0, maxLon: -82.0, maxLat: 50.0 },
      "SOUTHEAST":     { minLon: -92.0, minLat: 24.0, maxLon: -74.0, maxLat: 38.0 },
      "SOUTHMISSVLY":  { minLon: -100.0, minLat: 26.0, maxLon: -86.0, maxLat: 38.0 },
      "SOUTHPLAINS":   { minLon: -107.0, minLat: 26.0, maxLon: -93.0, maxLat: 38.0 },
      "CENTGRLAKES":   { minLon: -92.0, minLat: 38.0, maxLon: -76.0, maxLat: 48.0 },
      "NORTHROCKIES":  { minLon: -117.0, minLat: 40.0, maxLon: -101.0, maxLat: 50.0 },
      "SOUTHROCKIES":  { minLon: -115.0, minLat: 30.0, maxLon: -99.0, maxLat: 42.0 },
      "PACNORTHWEST":  { minLon: -128.0, minLat: 40.0, maxLon: -114.0, maxLat: 50.0 },
      "PACSOUTHWEST":  { minLon: -124.0, minLat: 30.0, maxLon: -112.0, maxLat: 42.0 },
      "NORTHPLAINS":   { minLon: -108.0, minLat: 38.0, maxLon: -94.0, maxLat: 50.0 }
    };
    
    var ext = regionExtents[region] || { minLon: LOCATION.lon - 8, minLat: LOCATION.lat - 5.5, maxLon: LOCATION.lon + 8, maxLat: LOCATION.lat + 5.5 };
    var bbox = ext.minLon + "," + ext.minLat + "," + ext.maxLon + "," + ext.maxLat;
    
    var wmsUrl = "https://opengeo.ncep.noaa.gov/geoserver/" + STATION + "/ows?" +
      "service=WMS&version=1.1.0&request=GetMap" +
      "&layers=" + STATION + "_bdhc" +
      "&styles=&bbox=" + bbox +
      "&width=" + Math.round(W) + "&height=" + Math.round(H) +
      "&srs=EPSG:4326" +
      "&format=image/png" +
      "&transparent=true" +
      "&cb=" + Date.now();
    
    var html = "";
    html += '<img src="' + ridgeBase + '" style="position:absolute;top:0;left:0;width:100%;height:100%;filter:invert(1) hue-rotate(180deg) brightness(0.4) contrast(1.2) saturate(0);z-index:1;" onerror="this.style.display=\'none\'" />';
    html += '<img src="' + wmsUrl + '" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;" onerror="this.style.display=\'none\'" />';
    
    container.innerHTML = html;
  }
  
  function switchRadarMode(mode){
    currentRadarMode = mode;
    var reflImg = document.getElementById("radar-img");
    var hydroContainer = document.getElementById("radar-hydro-container");
    var reflBtn = document.getElementById("radar-mode-refl");
    var hydroBtn = document.getElementById("radar-mode-hydro");
    var reflLegend = document.getElementById("radar-legend-refl");
    var hydroLegend = document.getElementById("radar-legend-hydro");
    var badge = document.getElementById("radar-badge");
    
    if (mode === "hydrometeor"){
      // Show hydrometeor, hide reflectivity
      if (reflImg) reflImg.style.display = "none";
      if (hydroContainer) hydroContainer.style.display = "block";
      if (reflBtn){ reflBtn.style.background = "transparent"; reflBtn.style.color = "rgba(255,255,255,.5)"; }
      if (hydroBtn){ hydroBtn.style.background = "rgba(255,255,255,.2)"; hydroBtn.style.color = "#fff"; }
      if (reflLegend) reflLegend.style.display = "none";
      if (hydroLegend) hydroLegend.style.display = "block";
      if (badge) badge.textContent = "NWS DUAL-POL";
      
      loadHydrometeorImage();
      
      // Refresh hydrometeor every 5 min
      if (hydroRefreshTimer) clearInterval(hydroRefreshTimer);
      hydroRefreshTimer = setInterval(loadHydrometeorImage, 5 * 60 * 1000);
    } else {
      // Show reflectivity, hide hydrometeor
      if (reflImg) reflImg.style.display = "block";
      if (hydroContainer) hydroContainer.style.display = "none";
      if (reflBtn){ reflBtn.style.background = "rgba(255,255,255,.2)"; reflBtn.style.color = "#fff"; }
      if (hydroBtn){ hydroBtn.style.background = "transparent"; hydroBtn.style.color = "rgba(255,255,255,.5)"; }
      if (reflLegend) reflLegend.style.display = "block";
      if (hydroLegend) hydroLegend.style.display = "none";
      if (badge) badge.textContent = "NWS RIDGE";
      
      if (hydroRefreshTimer){ clearInterval(hydroRefreshTimer); hydroRefreshTimer = null; }
    }
  }

  /* =========================================================
     AURORA (Animated from OVATION JSON)
     ========================================================= */
  var auroraAnim = {
    frames: [],
    idx: 0,
    playing: true,
    timer: null,
    refreshTimer: null,
    ctx: null
  };
  
  function startAuroraBlackBackground(){
    if (!auroraCanvas || !auroraLiveEl) return;

    auroraAnim.ctx = auroraCanvas.getContext("2d");
    var JSON_URL = "https://services.swpc.noaa.gov/products/animations/ovation_north_24h.json";
    var FALLBACK_URL = "https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg";

    function resizeToDisplaySize(){
      var parent = auroraCanvas.parentElement;
      if (!parent) return;
      var w = Math.max(1, parent.clientWidth);
      var h = Math.max(1, parent.clientHeight);
      if (auroraCanvas.width !== w || auroraCanvas.height !== h){
        auroraCanvas.width = w;
        auroraCanvas.height = h;
      }
    }

    function drawCover(img){
      var ctx = auroraAnim.ctx;
      var cw = auroraCanvas.width, ch = auroraCanvas.height;
      var iw = img.naturalWidth, ih = img.naturalHeight;
      var scale = Math.max(cw / iw, ch / ih);
      var dw = iw * scale, dh = ih * scale;
      var dx = (cw - dw) / 2;
      var dy = (ch - dh) / 2;

      ctx.clearRect(0,0,cw,ch);
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,cw,ch);
      ctx.drawImage(img, dx, dy, dw, dh);
    }

    function showFallback(){
      if (auroraFallbackImg){
        auroraFallbackImg.style.display = "block";
        auroraFallbackImg.src = FALLBACK_URL + "?cb=" + Date.now();
      }
      auroraCanvas.style.display = "none";
      auroraLiveEl.textContent = " LIVE";
    }

    function loadFrames(){
      auroraLiveEl.textContent = " LOADING";
      resizeToDisplaySize();
      
      fetchWithTimeout(JSON_URL, null, 15000)
        .then(function(r){ return r.json(); })
        .then(function(data){
          if (data && data.length > 0){
            auroraAnim.frames = data.map(function(f){
              return "https://services.swpc.noaa.gov" + f.url;
            });
            auroraAnim.idx = 0;
            auroraLiveEl.textContent = " LIVE";
            auroraCanvas.style.display = "block";
            if (auroraFallbackImg) auroraFallbackImg.style.display = "none";
            startAuroraAnimation();
          } else {
            throw new Error("No frames");
          }
        })
        .catch(function(){
          showFallback();
        });
    }
    
    function startAuroraAnimation(){
      if (auroraAnim.timer) clearTimeout(auroraAnim.timer);
      
      function step(){
        if (auroraAnim.playing && auroraAnim.frames.length > 0){
          var img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = function(){
            try {
              resizeToDisplaySize();
              drawCover(img);
            } catch(e){}
          };
          img.src = auroraAnim.frames[auroraAnim.idx];
          auroraAnim.idx = (auroraAnim.idx + 1) % auroraAnim.frames.length;
        }
        auroraAnim.timer = setTimeout(step, 200);
      }
      step();
    }

    loadFrames();
    
    if (auroraAnim.refreshTimer) clearInterval(auroraAnim.refreshTimer);
    auroraAnim.refreshTimer = setInterval(loadFrames, 5 * 60 * 1000);
    
    var resizeDebounceTimer = null;
    window.addEventListener("resize", function(){ 
      if (resizeDebounceTimer) clearTimeout(resizeDebounceTimer);
      resizeDebounceTimer = setTimeout(resizeToDisplaySize, 150);
    });
  }

    /* =========================================================
     KP DATA FOR TODAY TIMELINE (full 24 hours)
     ========================================================= */
  function fetchKpDataForToday(callback){
    var url = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json";
    
    var now = new Date();
    var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
    var todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
    
    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(rows){
        var kpSeries = [];
        
        if (!rows || rows.length < 2){
          callback(kpSeries);
          return;
        }
        
        // Find column indices
        var header = rows[0];
        var timeIdx = header.indexOf("time_tag");
        var kpIdx = header.indexOf("kp");
        
        if (timeIdx < 0 || kpIdx < 0){
          callback(kpSeries);
          return;
        }
        
        // Parse data rows
        for (var i = 1; i < rows.length; i++){
          var row = rows[i];
          if (!row || row.length <= Math.max(timeIdx, kpIdx)) continue;
          
          var timeStr = row[timeIdx];
          var kpVal = parseFloat(row[kpIdx]);
          
          if (!timeStr || isNaN(kpVal)) continue;
          
          // Parse UTC time (format: "2026-01-12 18:00:00")
          var dt = new Date(timeStr.replace(" ", "T") + "Z");
          if (!isFinite(dt.getTime())) continue;
          
          // Check if this falls within today (with buffer)
          var bufferMs = 6 * 60 * 60 * 1000;
          if (dt >= new Date(todayStart.getTime() - bufferMs) && 
              dt <= new Date(todayEnd.getTime() + bufferMs)){
            kpSeries.push({ t: dt, kp: kpVal });
          }
        }
        
        callback(kpSeries);
      })
      .catch(function(err){
        console.log("Kp data fetch error:", err);
        callback([]);
      });
  }

  /* =========================================================
     KP DATA FOR NIGHT SKY BAR
     ========================================================= */
  function fetchKpDataForNight(sunsetLocal, sunriseLocal, callback){
    var url = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json";
    
    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(rows){
        var kpSeries = [];
        
        if (!rows || rows.length < 2){
          callback(kpSeries);
          return;
        }
        
        // Find column indices
        var header = rows[0];
        var timeIdx = header.indexOf("time_tag");
        var kpIdx = header.indexOf("kp");
        
        if (timeIdx < 0 || kpIdx < 0){
          callback(kpSeries);
          return;
        }
        
        // Parse data rows
        for (var i = 1; i < rows.length; i++){
          var row = rows[i];
          if (!row || row.length <= Math.max(timeIdx, kpIdx)) continue;
          
          var timeStr = row[timeIdx];
          var kpVal = parseFloat(row[kpIdx]);
          
          if (!timeStr || isNaN(kpVal)) continue;
          
          // Parse UTC time (format: "2026-01-12 18:00:00")
          var dt = new Date(timeStr.replace(" ", "T") + "Z");
          if (!isFinite(dt.getTime())) continue;
          
          // Check if this falls within our night window (with some buffer)
          var bufferMs = 6 * 60 * 60 * 1000; // 6 hour buffer
          if (dt >= new Date(sunsetLocal.getTime() - bufferMs) && 
              dt <= new Date(sunriseLocal.getTime() + bufferMs)){
            kpSeries.push({ t: dt, kp: kpVal });
          }
        }
        
        callback(kpSeries);
      })
      .catch(function(err){
        console.log("Kp data fetch error:", err);
        callback([]);
      });
  }
  // Approximate geomagnetic latitude from geographic latitude (simplified)
  // US locations are roughly 10-12 lower geomagnetically than geographically
  function geomagLat(lat){
    return lat - 11;
  }

  // Minimum Kp needed to potentially see aurora at a given geomagnetic latitude
  // Based on SWPC guidelines: aurora oval reaches ~66 at Kp0, moves 2 equatorward per Kp level
  // But aurora can be VISIBLE on horizon ~600 miles (10) beyond the oval edge
  function minKpForLat(geomagLat){
    // For overhead aurora (oval edge)
    // Kp 0 = 66, Kp 1 = 64, ... Kp 9 = 48
    
    // For horizon visibility, subtract ~8-10 (can see ~600mi north)
    // So effective visibility: Kp 5 reaches ~56 overhead but visible from ~46
    
    if (geomagLat >= 66) return 0;  // Under the oval
    if (geomagLat >= 62) return 2;
    if (geomagLat >= 58) return 4;
    if (geomagLat >= 54) return 5;  // Northern US - Kp 5-6
    if (geomagLat >= 50) return 6;
    if (geomagLat >= 45) return 7;  // Central US - Kp 7+
    if (geomagLat >= 40) return 7;  // Mid-latitudes - strong storm
    if (geomagLat >= 35) return 8;  // Southern US - severe storm
    if (geomagLat >= 30) return 8;  // Deep south - G4+ storm
    return 9; // Below 30 geomagnetic - extreme G5 storm only
  }

  function auroraVisibilityPctFromKp(kp, lat){
    if (kp == null || isNaN(kp)) return null;
    if (lat == null) lat = 41.7; // Default to Pleasant Valley
    
    var gLat = geomagLat(lat);
    var minKp = minKpForLat(gLat);
    
    // How far above minimum Kp are we?
    var margin = kp - minKp;
    
    if (margin < 0) return 0;        // Below threshold - no chance
    if (margin < 0.5) return 5;      // Just at threshold - slim chance
    if (margin < 1) return 15;       // Slightly above - possible
    if (margin < 2) return 35;       // Good margin - likely visible
    if (margin < 3) return 60;       // Well above - very likely
    return 80;                        // Strong storm - excellent chance
  }

  function visLabel(pct){
    if (pct == null) return "--";
    if (pct <= 0) return "No";
    if (pct <= 5) return "Slim";
    return pct + "%";
  }

  function updateSolarMini(){
    if (!swKp || !swG || !swBz || !swWind || !swVis) return;

    swKp.textContent="--"; swG.textContent="--"; swBz.textContent="--"; swWind.textContent="--"; swVis.textContent="--";

    fetchWithTimeout("https://services.swpc.noaa.gov/products/wing-kp.json", null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try{
          if (!data || data.length < 2) throw new Error("No Wing Kp data");
          
          // Wing Kp format: array of arrays [time_tag, kp, kp_1hr, kp_4hr]
          // Skip header row if present
          var startIdx = (data[0] && typeof data[0][0] === 'string' && data[0][0].toLowerCase().indexOf('time') > -1) ? 1 : 0;
          
          // Get the most recent row
          var latestRow = data[data.length - 1];
          var kpVal = parseFloat(latestRow[1]); // Current Kp estimate
          
          if (isNaN(kpVal)) throw new Error("Invalid Kp value");
          
          swKp.textContent = kpVal.toFixed(1);
          
          // Determine G-scale from Kp
          var gScale = "G0";
          if (kpVal >= 9) gScale = "G5";
          else if (kpVal >= 8) gScale = "G4";
          else if (kpVal >= 7) gScale = "G3";
          else if (kpVal >= 6) gScale = "G2";
          else if (kpVal >= 5) gScale = "G1";
          
          swG.textContent = gScale;
          swVis.textContent = visLabel(auroraVisibilityPctFromKp(kpVal, LOCATION.lat));
        } catch(e){
          console.log("Wing Kp error, falling back to forecast:", e);
          // Fallback to regular Kp forecast
          fetchWithTimeout("https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json", null, 12000)
            .then(function(r){ return r.json(); })
            .then(function(rows){
              try{
                var header = rows && rows[0];
                if (!header) return;
                var kpIdx = header.indexOf("kp");
                var obsIdx = header.indexOf("observed");
                var scaleIdx = header.indexOf("noaa_scale");
                var latestRow = null;
                for (var i=rows.length-1;i>0;i--){
                  var row = rows[i];
                  if (!row || row.length <= kpIdx) continue;
                  var obsType = row[obsIdx];
                  if (obsType === "observed" || obsType === "estimated"){ latestRow = row; break; }
                }
                if (!latestRow) latestRow = rows[rows.length-1];
                var kpVal = parseFloat(latestRow[kpIdx]);
                var gScale = (scaleIdx >= 0 ? latestRow[scaleIdx] : "") || "";
                if (!isNaN(kpVal)){
                  swKp.textContent = kpVal.toFixed(1);
                  swG.textContent = gScale ? String(gScale) : "G0";
                  swVis.textContent = visLabel(auroraVisibilityPctFromKp(kpVal, LOCATION.lat));
                }
              } catch(e2){}
            })
            .catch(function(){});
        }
      })
      .catch(function(){
        console.log("Wing Kp fetch failed, trying fallback");
        // Fallback to regular Kp forecast
        fetchWithTimeout("https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json", null, 12000)
          .then(function(r){ return r.json(); })
          .then(function(rows){
            try{
              var header = rows && rows[0];
              if (!header) return;
              var kpIdx = header.indexOf("kp");
              var obsIdx = header.indexOf("observed");
              var scaleIdx = header.indexOf("noaa_scale");
              var latestRow = null;
              for (var i=rows.length-1;i>0;i--){
                var row = rows[i];
                if (!row || row.length <= kpIdx) continue;
                var obsType = row[obsIdx];
                if (obsType === "observed" || obsType === "estimated"){ latestRow = row; break; }
              }
              if (!latestRow) latestRow = rows[rows.length-1];
              var kpVal = parseFloat(latestRow[kpIdx]);
              var gScale = (scaleIdx >= 0 ? latestRow[scaleIdx] : "") || "";
              if (!isNaN(kpVal)){
                swKp.textContent = kpVal.toFixed(1);
                swG.textContent = gScale ? String(gScale) : "G0";
                swVis.textContent = visLabel(auroraVisibilityPctFromKp(kpVal, LOCATION.lat));
                // Cache globally
                if (!window._swData) window._swData = {};
                window._swData.kp = kpVal;
                window._swData.gScale = gScale ? String(gScale) : "G0";
              }
            } catch(e2){}
          })
          .catch(function(){});
      });

    Promise.all([
      fetchWithTimeout("https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json", null, 12000).then(function(r){return r.json();}).catch(function(){return null;}),
      fetchWithTimeout("https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json", null, 12000).then(function(r){return r.json();}).catch(function(){return null;})
    ]).then(function(all){
      try{
        var plasma = all[0], mag = all[1];

        if (plasma && plasma.length > 1){
          var ph = plasma[0];
          var speedIdx = ph.indexOf("speed");
          var densIdx = ph.indexOf("density");
          var last = plasma[plasma.length-1];
          var spd = speedIdx >= 0 ? parseFloat(last[speedIdx]) : NaN;
          var den = densIdx >= 0 ? parseFloat(last[densIdx]) : NaN;
          if (!isNaN(spd)) swWind.textContent = Math.round(spd) + " km/s";
          // Cache globally
          if (!window._swData) window._swData = {};
          window._swData.speed = !isNaN(spd) ? Math.round(spd) : null;
          window._swData.density = !isNaN(den) ? den : null;
        }

        if (mag && mag.length > 1){
          var mh = mag[0];
          var bzIdx = mh.indexOf("bz_gsm");
          var btIdx = mh.indexOf("bt");
          var bxIdx = mh.indexOf("bx_gsm");
          var byIdx = mh.indexOf("by_gsm");
          var lastm = mag[mag.length-1];
          var bz = bzIdx >= 0 ? parseFloat(lastm[bzIdx]) : NaN;
          var bt = btIdx >= 0 ? parseFloat(lastm[btIdx]) : NaN;
          var bx = bxIdx >= 0 ? parseFloat(lastm[bxIdx]) : NaN;
          var by = byIdx >= 0 ? parseFloat(lastm[byIdx]) : NaN;
          if (!isNaN(bz)) swBz.textContent = (bz >= 0 ? "+" : "") + bz.toFixed(1) + " nT";
          // Cache globally
          if (!window._swData) window._swData = {};
          window._swData.bz = !isNaN(bz) ? bz : null;
          window._swData.bt = !isNaN(bt) ? bt : null;
          window._swData.bx = !isNaN(bx) ? bx : null;
          window._swData.by = !isNaN(by) ? by : null;
        }
      } catch(e){}
    });

    //  GOES X-RAY FLUX (real-time flare detection) 
    fetchWithTimeout("https://services.swpc.noaa.gov/json/goes/primary/xrays-6-hour.json", null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try {
          if (!data || data.length < 2) return;
          if (!window._swData) window._swData = {};
          // data[0] is header, rest are time series
          // Find the latest short-wavelength (0.05-0.4nm) and long (0.1-0.8nm) flux
          var latest = data[data.length - 1];
          var flux = parseFloat(latest.flux);
          var energy = latest.energy || '';
          if (!isNaN(flux) && energy.indexOf('0.1-0.8') >= 0) {
            window._swData.xrayFlux = flux;
            // Classify flare level
            if (flux >= 1e-4) window._swData.xrayClass = 'X' + (flux / 1e-4).toFixed(1);
            else if (flux >= 1e-5) window._swData.xrayClass = 'M' + (flux / 1e-5).toFixed(1);
            else if (flux >= 1e-6) window._swData.xrayClass = 'C' + (flux / 1e-6).toFixed(1);
            else if (flux >= 1e-7) window._swData.xrayClass = 'B' + (flux / 1e-7).toFixed(1);
            else window._swData.xrayClass = 'A';
          }
          // Also get long-wavelength for the same timestamp
          // Scan backwards for peak flux in last 6 hours
          var peakFlux = 0, peakClass = 'A';
          for (var xi = 1; xi < data.length; xi++) {
            var xf = parseFloat(data[xi].flux);
            var xe = data[xi].energy || '';
            if (!isNaN(xf) && xe.indexOf('0.1-0.8') >= 0 && xf > peakFlux) {
              peakFlux = xf;
            }
          }
          if (peakFlux >= 1e-4) peakClass = 'X' + (peakFlux / 1e-4).toFixed(1);
          else if (peakFlux >= 1e-5) peakClass = 'M' + (peakFlux / 1e-5).toFixed(1);
          else if (peakFlux >= 1e-6) peakClass = 'C' + (peakFlux / 1e-6).toFixed(1);
          else if (peakFlux >= 1e-7) peakClass = 'B' + (peakFlux / 1e-7).toFixed(1);
          window._swData.xrayPeak6hr = peakFlux;
          window._swData.xrayPeakClass = peakClass;
        } catch(e){}
      }).catch(function(){});

    //  SWPC ALERTS & NOTIFICATIONS (CME watches, solar flare alerts, geomag warnings) 
    fetchWithTimeout("https://services.swpc.noaa.gov/products/alerts.json", null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try {
          if (!data || !data.length) return;
          if (!window._swData) window._swData = {};
          window._swData.spaceAlerts = [];
          // Parse last 24 hrs of alerts
          var now = Date.now();
          for (var ai = data.length - 1; ai >= Math.max(0, data.length - 50); ai--) {
            var a = data[ai];
            var issued = a.issue_datetime ? new Date(a.issue_datetime).getTime() : 0;
            if (now - issued > 86400000) continue; // >24hr old, skip
            var msg = (a.message || '').substring(0, 300);
            var product = a.product_id || '';
            // Categorize
            var alertObj = { msg: msg, product: product, time: a.issue_datetime };
            if (/X-ray|flare|FLR/i.test(msg)) alertObj.type = 'flare';
            else if (/CME|coronal mass/i.test(msg)) alertObj.type = 'cme';
            else if (/geomagnetic|K-index|Kp/i.test(msg)) alertObj.type = 'geomag';
            else if (/solar wind|shock/i.test(msg)) alertObj.type = 'wind';
            else if (/radio|blackout|HF/i.test(msg)) alertObj.type = 'radio';
            else alertObj.type = 'other';
            window._swData.spaceAlerts.push(alertObj);
          }
        } catch(e){}
      }).catch(function(){});

    //  SOLAR EVENT REPORTS (recent flares, CMEs, filament eruptions) 
    fetchWithTimeout("https://services.swpc.noaa.gov/json/edited_events.json", null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try {
          if (!data || !data.length) return;
          if (!window._swData) window._swData = {};
          window._swData.solarEvents = [];
          // Last 48 hours of events
          var now = Date.now();
          for (var si = data.length - 1; si >= Math.max(0, data.length - 100); si--) {
            var ev = data[si];
            var evTime = ev.begin_datetime ? new Date(ev.begin_datetime).getTime() : 0;
            if (now - evTime > 172800000) continue; // >48hr
            window._swData.solarEvents.push({
              type: ev.type || '',
              classType: ev.classtype || '',
              begin: ev.begin_datetime || '',
              end: ev.end_datetime || '',
              region: ev.active_region || '',
              location: ev.location || '',
              freq: ev.frequency || ''
            });
          }
        } catch(e){}
      }).catch(function(){});
  }

  /* =========================================================
     GOES autoplay (NE sector)
     ========================================================= */
  var goesTimer = null;
  var goesRefreshTimer = null;
  var goesFrames = [];
  var goesImages = []; // preloaded Image objects
  var goesIdx = 0;
  var goesLength = 36; // default 6h (~6 frames/hr)
  var goesLengthLabel = '6h';
  var goesAnimId = null; // requestAnimationFrame id
  var goesAnimState = {
    currentFrame: 0,
    nextFrame: 1,
    blendProgress: 0,
    lastTime: 0,
    frameDuration: 1200, // ms per frame crossfade - long smooth blend
    pauseAtFrame: 100,   // minimal pause - nearly continuous flow
    phase: 'blend', // 'blend' or 'pause'
    pauseElapsed: 0,
    playing: true
  };

  var goesLengthMap = { '1h': 6, '6h': 36, '12h': 72, '24h': 144, '48h': 288 };

  function switchGoesLength(len){
    goesLength = goesLengthMap[len] || 36;
    goesLengthLabel = len;
    var opts = ['1h','6h','12h','24h','48h'];
    opts.forEach(function(o){
      var btn = document.getElementById('goes-len-' + o);
      if (!btn) return;
      if (o === len){
        btn.style.background = 'rgba(255,140,0,.15)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(255,140,0,.95)'; btn.style.boxShadow = '0 0 12px rgba(255,140,0,.15)';
      } else {
        btn.style.background = 'rgba(200,200,210,.25)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(43,34,244,.65)'; btn.style.boxShadow = 'none';
      }
    });
    var loopEl = document.getElementById('goes-loop');
    if (loopEl) loopEl.textContent = len;
    // Stop current playback, refetch, restart
    if (goesAnimId) { cancelAnimationFrame(goesAnimId); goesAnimId = null; }
    var overlay = document.getElementById('goes-loading-overlay');
    if (overlay) { overlay.style.display = 'flex'; overlay.style.opacity = '1'; }
    goesFrames = [];
    goesImages = [];
    goesIdx = 0;
    fetchGoesFrames().then(function(){ preloadGoesImages(); });
  }
  window.switchGoesLength = switchGoesLength;

  function fetchGoesFrames(){
    if (!goesLiveEl) return Promise.resolve();

    var goesSat = (LOCATION.goes && LOCATION.goes.sat) || "G19";
    var goesSector = (LOCATION.goes && LOCATION.goes.sector) || "ne";
    var indexUrl = "https://www.star.nesdis.noaa.gov/GOES/sector_band.php?band=GEOCOLOR&sat=" + goesSat + "&sector=" + goesSector + "&length=" + goesLength;
    goesLiveEl.textContent = " LOADING";

    return fetchWithTimeout(indexUrl, null, 12000)
      .then(function(r){ return r.text(); })
      .then(function(html){
        var goesNum = goesSat === "G18" ? "GOES18" : "GOES19";
        var re = new RegExp("https://cdn\\.star\\.nesdis\\.noaa\\.gov/" + goesNum + "/ABI/SECTOR/" + goesSector + "/GEOCOLOR/[^\"' ]+\\.jpg", "gi");
    
        var goesSubEl = document.getElementById("goes-sub");
        var sectorNames = { ne: "NORTHEAST", se: "SOUTHEAST", wus: "WEST US", umv: "UPPER MISSISSIPPI VALLEY" };
        var satName = goesSat === "G18" ? "GOES-18" : "GOES-19";
        if (goesSubEl) goesSubEl.textContent = "NESDIS/STAR " + satName + " | " + (sectorNames[goesSector] || goesSector.toUpperCase()) + "  GEOCOLOR";

        var matches = html.match(re) || [];
        var seen = Object.create(null);
        var uniq = [];

        for (var i=0;i<matches.length;i++){
          var u = matches[i];
          if (seen[u]) continue;
          seen[u] = true;
          uniq.push(u);
        }

        if (uniq.length){
          goesFrames = uniq.slice(-goesLength);
          goesIdx = 0;
          goesLiveEl.textContent = " LIVE";
          if (goesFrameEl) goesFrameEl.textContent = "--/--";
        } else {
          goesLiveEl.textContent = " OFFLINE";
        }
      })
      .catch(function(){
        goesLiveEl.textContent = " OFFLINE";
      });
  }

  function preloadGoesImages(){
    if (!goesFrames.length) return;
    goesImages = [];
    var loaded = 0;
    var total = goesFrames.length;
    var overlay = document.getElementById('goes-loading-overlay');
    var loadText = document.getElementById('goes-loading-text');
    if (overlay) { overlay.style.opacity = '1'; overlay.style.display = 'flex'; }
    if (loadText) loadText.textContent = 'CHASING CLOUDS 0/' + total;
    if (goesLiveEl) goesLiveEl.textContent = " LOADING 0%";

    goesFrames.forEach(function(url, i){
      var img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = function(){
        loaded++;
        var pct = Math.round(loaded/total*100);
        if (goesLiveEl) goesLiveEl.textContent = " LOADING " + pct + "%";
        if (loadText) loadText.textContent = 'CHASING CLOUDS ' + loaded + '/' + total;
        if (loaded === total){
          if (goesLiveEl) goesLiveEl.textContent = " LIVE";
          if (overlay) { overlay.style.opacity = '0'; setTimeout(function(){ overlay.style.display = 'none'; }, 600); }
          startGoesCanvasAnim();
        }
      };
      img.onerror = function(){
        loaded++;
        if (loaded === total){
          if (goesLiveEl) goesLiveEl.textContent = " LIVE";
          if (overlay) { overlay.style.opacity = '0'; setTimeout(function(){ overlay.style.display = 'none'; }, 600); }
          startGoesCanvasAnim();
        }
      };
      img.src = url;
      goesImages[i] = img;
    });
  }

  function drawGoesFrame(ctx, img, w, h){
    if (!img || !img.complete || !img.naturalWidth) return;
    // Cover the canvas (like object-fit:cover)
    var iw = img.naturalWidth, ih = img.naturalHeight;
    var scale = Math.max(w/iw, h/ih);
    var dw = iw * scale, dh = ih * scale;
    var dx = (w - dw) / 2, dy = (h - dh) / 2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function startGoesCanvasAnim(){
    if (!goesCanvas || goesImages.length < 2) {
      // If only 1 frame, just draw it
      if (goesCanvas && goesImages.length === 1){
        var ctx = goesCanvas.getContext('2d');
        var rect = goesCanvas.getBoundingClientRect();
        goesCanvas.width = rect.width * (window.devicePixelRatio || 1);
        goesCanvas.height = rect.height * (window.devicePixelRatio || 1);
        ctx.setTransform(window.devicePixelRatio || 1, 0, 0, window.devicePixelRatio || 1, 0, 0);
        drawGoesFrame(ctx, goesImages[0], rect.width, rect.height);
      }
      return;
    }

    if (goesAnimId) cancelAnimationFrame(goesAnimId);

    var s = goesAnimState;
    s.currentFrame = 0;
    s.nextFrame = 1;
    s.blendProgress = 0;
    s.lastTime = 0;
    s.phase = 'pause';
    s.pauseElapsed = 0;
    s.playing = true;

    var ctx = goesCanvas.getContext('2d');

    function animate(timestamp){
      if (!s.playing) { goesAnimId = requestAnimationFrame(animate); return; }

      var rect = goesCanvas.getBoundingClientRect();
      var dpr = window.devicePixelRatio || 1;
      if (goesCanvas.width !== Math.round(rect.width * dpr) || goesCanvas.height !== Math.round(rect.height * dpr)){
        goesCanvas.width = Math.round(rect.width * dpr);
        goesCanvas.height = Math.round(rect.height * dpr);
      }
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      var w = rect.width, h = rect.height;

      if (!s.lastTime) s.lastTime = timestamp;
      var dt = timestamp - s.lastTime;
      s.lastTime = timestamp;
      // Cap dt to avoid jumps when tab is hidden
      if (dt > 200) dt = 16;

      var n = goesImages.length;

      if (s.phase === 'pause'){
        s.pauseElapsed += dt;
        // Draw current frame fully
        ctx.globalAlpha = 1;
        drawGoesFrame(ctx, goesImages[s.currentFrame], w, h);

        if (s.pauseElapsed >= s.pauseAtFrame){
          s.phase = 'blend';
          s.blendProgress = 0;
        }
      } else {
        // Crossfade blend
        s.blendProgress += dt / s.frameDuration;
        if (s.blendProgress >= 1) s.blendProgress = 1;

        // Linear blend for continuous smooth flow
        var t = s.blendProgress;
        var ease = t;

        // Draw current frame
        ctx.globalAlpha = 1;
        drawGoesFrame(ctx, goesImages[s.currentFrame], w, h);
        // Blend next frame on top
        ctx.globalAlpha = ease;
        drawGoesFrame(ctx, goesImages[s.nextFrame], w, h);
        ctx.globalAlpha = 1;

        // Update frame counter
        if (goesFrameEl) goesFrameEl.textContent = (s.currentFrame+1) + "/" + n;

        if (s.blendProgress >= 1){
          s.currentFrame = s.nextFrame;
          s.nextFrame = (s.nextFrame + 1) % n;
          s.phase = 'pause';
          s.pauseElapsed = 0;
        }
      }

      goesAnimId = requestAnimationFrame(animate);
    }

    goesAnimId = requestAnimationFrame(animate);

    // Refresh frames periodically
    if (goesRefreshTimer) clearInterval(goesRefreshTimer);
    goesRefreshTimer = setInterval(function(){
      fetchGoesFrames().then(function(){ preloadGoesImages(); });
    }, 5 * 60 * 1000);
  }

  function startGoesAutoplay(){
    fetchGoesFrames().then(function(){ preloadGoesImages(); });
  }

  /* =========================================================
     SPACE WEATHER ANIMATIONS
     (Geospace Velocity/Density/Pressure, WSA-Enlil, LASCO C2/C3)
     ========================================================= */
  
  // Animation state for each widget
  var animations = {
    geoVel:  { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    geoDen:  { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    geoPre:  { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    enlil:   { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    lascoC3: { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    lascoC2: { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null }
  };
  

  
  // Generic animation runner
  function runAnimation(key, fps){
    var anim = animations[key];
    if (!anim || !anim.imgEl) return;
    
    function step(){
      if (anim.playing && anim.frames.length > 0){
        anim.imgEl.src = anim.frames[anim.idx];
        anim.idx = (anim.idx + 1) % anim.frames.length;
      }
      anim.timer = setTimeout(step, 1000 / fps);
    }
    step();
  }
  
  // Load animation frames from SWPC JSON
  function loadAnimationFrames(jsonUrl, key, fps, fallbackUrl){
    var anim = animations[key];
    if (!anim || !anim.imgEl) return;
    
    if (anim.liveEl) anim.liveEl.textContent = " LOADING";
    
    fetchWithTimeout(jsonUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.length > 0){
          anim.frames = data.map(function(f){
            return "https://services.swpc.noaa.gov" + f.url;
          });
          if (anim.liveEl) anim.liveEl.textContent = " LIVE";
          runAnimation(key, fps);
        } else {
          throw new Error("No frames");
        }
      })
      .catch(function(){
        // Fallback to static image
        if (fallbackUrl){
          anim.imgEl.src = fallbackUrl + "?cb=" + Date.now();
        }
        if (anim.liveEl) anim.liveEl.textContent = " LIVE";
        if (anim.btnEl) anim.btnEl.style.display = "none";
      });
  }
  
  // Load static/GIF images with periodic refresh (for sources without JSON)
  
    function initSpaceWeatherAnimations(){
    // Bind DOM elements
    animations.enlil.imgEl = document.getElementById("enlil-img");
    animations.enlil.liveEl = document.getElementById("enlil-live");
    animations.enlil.btnEl = document.getElementById("enlil-btn");
    
    animations.lascoC3.imgEl = document.getElementById("lasco-c3-img");
    animations.lascoC3.liveEl = document.getElementById("lasco-c3-live");
    animations.lascoC3.btnEl = document.getElementById("lasco-c3-btn");
    
    animations.lascoC2.imgEl = document.getElementById("lasco-c2-img");
    animations.lascoC2.liveEl = document.getElementById("lasco-c2-live");
    animations.lascoC2.btnEl = document.getElementById("lasco-c2-btn");
    
    // Load WSA-Enlil animation (8 fps - faster for solar wind)
    loadAnimationFrames(
      "https://services.swpc.noaa.gov/products/animations/enlil.json",
      "enlil", 8,
      "https://services.swpc.noaa.gov/images/animations/enlil/latest.jpg"
    );
    
    // Load LASCO animations (6 fps)
    loadAnimationFrames(
      "https://services.swpc.noaa.gov/products/animations/lasco-c3.json",
      "lascoC3", 6,
      "https://soho.nascom.nasa.gov/data/realtime/c3/512/latest.jpg"
    );
    
    loadAnimationFrames(
      "https://services.swpc.noaa.gov/products/animations/lasco-c2.json",
      "lascoC2", 6,
      "https://soho.nascom.nasa.gov/data/realtime/c2/512/latest.jpg"
    );
    
    // Load Geospace animated images
    loadGeospaceAnimations();
  }
  
  function loadGeospaceAnimations(){
    var geoWidgets = [
      { id: "geo-vel-img", liveId: "geo-vel-live", jsonUrl: "https://services.swpc.noaa.gov/products/animations/geospace/velocity.json" },
      { id: "geo-den-img", liveId: "geo-den-live", jsonUrl: "https://services.swpc.noaa.gov/products/animations/geospace/density.json" },
      { id: "geo-pre-img", liveId: "geo-pre-live", jsonUrl: "https://services.swpc.noaa.gov/products/animations/geospace/pressure.json" }
    ];
    
    geoWidgets.forEach(function(w){
      var imgEl = document.getElementById(w.id);
      var liveEl = document.getElementById(w.liveId);
      if (!imgEl) return;
      
      var frames = [];
      var frameIndex = 0;
      var animInterval = null;
      var frameDelay = 150; // 150ms = ~6.6 fps, smooth animation
      
      function fetchFrames(){
        if (liveEl) liveEl.textContent = " LOADING";
        
        fetch(w.jsonUrl + "?cb=" + Date.now())
          .then(function(r){ 
            if (!r.ok) throw new Error("Fetch failed");
            return r.json(); 
          })
          .then(function(data){
            if (!Array.isArray(data) || data.length === 0) throw new Error("No frames");
            frames = data.map(function(f){ return "https://services.swpc.noaa.gov" + f.url; });
            preloadFrames();
          })
          .catch(function(err){
            console.error("Geospace animation error:", err);
            if (liveEl) liveEl.textContent = " OFFLINE";
            imgEl.style.opacity = "0.3";
          });
      }
      
      function preloadFrames(){
        var loaded = 0;
        var total = Math.min(frames.length, 50); // Preload first 50 frames max
        
        for (var i = 0; i < total; i++){
          var img = new Image();
          img.onload = img.onerror = function(){
            loaded++;
            if (loaded >= total) startAnimation();
          };
          img.src = frames[i];
        }
      }
      
      function startAnimation(){
        if (liveEl) liveEl.textContent = " LIVE";
        imgEl.style.opacity = "1";
        frameIndex = 0;
        
        if (animInterval) clearInterval(animInterval);
        animInterval = setInterval(function(){
          imgEl.src = frames[frameIndex];
          frameIndex = (frameIndex + 1) % frames.length;
        }, frameDelay);
      }
      
      // Initial load
      fetchFrames();
      
      // Refresh frame list every 5 min (will pick up new model runs)
      setInterval(fetchFrames, 5 * 60 * 1000);
    });
  }

  /* Geospace tab switching + live insight engine */
  var geoCurrentTab = 'velocity';
  var geoInsightEl = document.getElementById('geo-insight');
  var geoImgs = {
    velocity: document.getElementById('geo-vel-img'),
    density: document.getElementById('geo-den-img'),
    pressure: document.getElementById('geo-pre-img')
  };
  var geoLiveEls = {
    velocity: document.getElementById('geo-vel-live'),
    density: document.getElementById('geo-den-live'),
    pressure: document.getElementById('geo-pre-live')
  };
  var geoTitleEl = document.querySelector('#geo-widget .widget-title');

  function switchGeoTab(mode){
    geoCurrentTab = mode;
    var allTabs = document.querySelectorAll('.geo-tab');
    for(var i = 0; i < allTabs.length; i++){
      if(allTabs[i].getAttribute('data-geo') === mode) allTabs[i].classList.add('active');
      else allTabs[i].classList.remove('active');
    }
    var keys = ['velocity','density','pressure'];
    for(var k = 0; k < keys.length; k++){
      if(geoImgs[keys[k]]) geoImgs[keys[k]].style.opacity = keys[k] === mode ? '1' : '0';
    }
    if(geoTitleEl){
      var live = geoLiveEls[mode];
      var liveText = live ? live.textContent : ' LIVE';
      geoTitleEl.innerHTML = 'GEOSPACE MAGNETOSPHERE | ' + mode.toUpperCase() + ' <span class="live-tag">' + liveText + '</span>';
    }
    updateGeoInsight();
  }

  function updateGeoInsight(){
    if(!geoInsightEl) return;
    var sw = window._swData;
    if(!sw){ geoInsightEl.innerHTML = '<div style="color:rgba(255,255,255,.4);font-size:.5rem;letter-spacing:.08em;">LOADING SOLAR WIND DATA</div>'; return; }

    var speed = sw.speed, den = sw.density, bz = sw.bz, bt = sw.bt, kp = sw.kp, gScale = sw.gScale || 'G0';
    var dynPres = (speed != null && den != null) ? (1.6726e-6 * den * speed * speed) : null;
    var mpDist = (dynPres != null && dynPres > 0) ? (11.4 * Math.pow(dynPres, -1/6.6)) : null;

    var isStorm = kp != null && kp >= 5;
    var isSubstorm = bz != null && bz <= -5 && speed != null && speed > 400;
    var isCompressed = mpDist != null && mpDist < 8;
    var isReconnecting = bz != null && bz <= -10;
    var stateColor = isStorm ? '#f44' : isSubstorm ? '#f90' : '#4ddc7b';
    var stateLabel = isStorm ? 'STORM' : isSubstorm ? 'SUBSTORM CONDITIONS' : 'QUIET';

    var h = '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">';
    h += '<span style="display:inline-flex;align-items:center;gap:4px;background:' + stateColor + '22;border:1px solid ' + stateColor + '55;border-radius:6px;padding:2px 8px;">';
    h += '<span style="width:6px;height:6px;border-radius:50%;background:' + stateColor + ';display:inline-block;' + (isStorm || isSubstorm ? 'animation:geoStatusPulse 1.2s ease-in-out infinite;' : '') + '"></span>';
    h += '<span style="color:' + stateColor + ';font-size:.48rem;font-weight:800;letter-spacing:.1em;">' + stateLabel + (isStorm ? ' (' + gScale + ')' : '') + '</span>';
    h += '</span>';

    h += '<span style="display:flex;gap:10px;font-size:.46rem;color:rgba(255,255,255,.55);font-weight:600;letter-spacing:.05em;">';
    if(speed != null) h += '<span>WIND <span style="color:rgba(255,255,255,.85);">' + speed + '</span> km/s</span>';
    if(den != null) h += '<span>N <span style="color:rgba(255,255,255,.85);">' + den.toFixed(1) + '</span> /cm</span>';
    if(bz != null) h += '<span>Bz <span style="color:' + (bz <= -10 ? '#f44' : bz <= -5 ? '#f90' : bz < 0 ? '#dda' : '#4ddc7b') + ';">' + (bz >= 0 ? '+' : '') + bz.toFixed(1) + '</span> nT</span>';
    if(dynPres != null) h += '<span>P <span style="color:rgba(255,255,255,.85);">' + dynPres.toFixed(1) + '</span> nPa</span>';
    if(mpDist != null) h += '<span>MP <span style="color:' + (mpDist < 7 ? '#f44' : mpDist < 9 ? '#f90' : '#4ddc7b') + ';">~' + mpDist.toFixed(1) + '</span> R</span>';
    if(kp != null) h += '<span>Kp <span style="color:' + (kp >= 7 ? '#f44' : kp >= 5 ? '#f90' : kp >= 4 ? '#dda' : '#4ddc7b') + ';">' + kp.toFixed(0) + '</span></span>';
    h += '</span></div>';

    h += '<div style="font-size:.48rem;color:rgba(255,255,255,.72);line-height:1.55;max-width:700px;">';

    if(geoCurrentTab === 'velocity'){
      h += '<span style="color:rgba(255,255,255,.35);font-weight:700;letter-spacing:.08em;font-size:.42rem;">READING THIS VIEW </span>';
      if(isStorm || (speed != null && speed > 600)){
        h += 'High-speed solar wind (' + (speed||'?') + ' km/s) is slamming into Earth\'s magnetic field. The <b style="color:#fff;">bow shock</b> (bright boundary on the left/sunward side) should appear pushed inward and intensely heated. ';
        h += 'The <b style="color:#fff;">magnetosheath</b> between the bow shock and magnetopause is turbulent with compressed, deflected flow. ';
        if(isReconnecting) h += 'With Bz at ' + bz.toFixed(1) + ' nT, magnetic reconnection is ripping open the dayside  watch for accelerated flows in the tail (right side) as stored energy explosively releases in substorm breakups.';
        else h += 'Watch the nightside tail for sudden velocity jets  those signal substorm reconnection events that launch aurora.';
      } else if(speed != null && speed > 450){
        h += 'Moderate solar wind flow (' + speed + ' km/s). The bow shock stands at a normal distance. Solar wind decelerates from ~' + speed + ' to ~100 km/s across the shock front. ';
        h += 'The magnetosheath shows steady deflected flow around Earth\'s magnetic obstacle. Tail flows are calm.';
      } else {
        h += 'Solar wind is slow (' + (speed||'~350') + ' km/s). The bow shock is at its normal standoff distance (~1315 R). ';
        h += 'Flow around the magnetosphere is smooth and laminar. The magnetotail extends quietly to the right with no signs of stress or imminent substorm activity.';
      }
    }

    else if(geoCurrentTab === 'density'){
      h += '<span style="color:rgba(255,255,255,.35);font-weight:700;letter-spacing:.08em;font-size:.42rem;">READING THIS VIEW </span>';
      if(den != null && den > 15){
        h += 'Plasma density is very high (' + den.toFixed(1) + '/cm). The <b style="color:#fff;">magnetosheath</b> should glow bright  that\'s compressed solar wind piling up against Earth\'s magnetic barrier. ';
        h += 'High density combined with ' + (speed||'?') + ' km/s speed produces ' + (dynPres ? dynPres.toFixed(1) : '?') + ' nPa of ram pressure, ' + (isCompressed ? 'severely compressing the magnetopause to ~' + mpDist.toFixed(1) + ' R (inside geosynchronous orbit  satellites in the raw solar wind). ' : 'pressing the magnetopause to ~' + (mpDist ? mpDist.toFixed(1) : '10') + ' R. ');
        h += 'Look for density enhancements deep in the magnetotail  that\'s plasma sheet loading that precedes substorm onset.';
      } else if(den != null && den > 7){
        h += 'Moderate plasma density (' + den.toFixed(1) + '/cm). The magnetosheath shows normal compressed plasma. ';
        h += 'Inside the magnetosphere proper, density remains low  Earth\'s field is successfully excluding most solar wind particles. The boundary is clear and well-defined.';
      } else {
        h += 'Low solar wind density (' + (den ? den.toFixed(1) : '~5') + '/cm). Even at ' + (speed||'?') + ' km/s, ram pressure is only ' + (dynPres ? dynPres.toFixed(1) : '?') + ' nPa  the magnetopause sits comfortably at ~' + (mpDist ? mpDist.toFixed(1) : '10') + ' R. ';
        h += 'The magnetosheath is thin and dim. The inner magnetosphere is well-shielded with minimal particle intrusion.';
      }
    }

    else if(geoCurrentTab === 'pressure'){
      h += '<span style="color:rgba(255,255,255,.35);font-weight:700;letter-spacing:.08em;font-size:.42rem;">READING THIS VIEW </span>';
      if(dynPres != null && dynPres > 8){
        h += 'Extreme dynamic pressure (' + dynPres.toFixed(1) + ' nPa) is crushing the magnetosphere. ';
        h += 'The magnetopause is pushed to ~' + (mpDist ? mpDist.toFixed(1) : '?') + ' R' + (isCompressed ? '  <b style="color:#f44;">inside geosynchronous orbit</b>. Satellites at 6.6 R are directly exposed to solar wind plasma, risking surface charging and anomalies. ' : '. ');
        h += 'The sudden pressure increase likely triggered a <b style="color:#fff;">sudden storm commencement (SSC)</b>  a compression wave that rings through the magnetosphere like a bell, measurable on ground magnetometers worldwide. ';
        h += 'This is the opening phase of a geomagnetic storm.';
      } else if(dynPres != null && dynPres > 3){
        h += 'Elevated pressure (' + dynPres.toFixed(1) + ' nPa)  above the typical ~2 nPa baseline. The dayside magnetosphere shows asymmetric compression. ';
        if(bz != null && bz <= -5) h += 'Combined with southward Bz (' + bz.toFixed(1) + ' nT), energy is being injected into the system. Pressure on the dayside + reconnection on the flanks = ring current intensification and equatorward aurora expansion.';
        else h += 'The magnetopause at ~' + (mpDist ? mpDist.toFixed(1) : '?') + ' R is pushed in but holding. Watch for pressure pulses that could trigger sudden impulse events.';
      } else {
        h += 'Normal dynamic pressure (' + (dynPres ? dynPres.toFixed(1) : '~2') + ' nPa). The magnetosphere is in a relaxed, balanced state with the solar wind. ';
        h += 'Dayside compression is minimal, the magnetopause sits near its equilibrium at ~' + (mpDist ? mpDist.toFixed(1) : '10') + ' R, and pressure is evenly distributed. ';
        h += 'No sudden impulses expected. For reference, CME-driven storms can spike pressure to 2050+ nPa.';
      }
    }

    if(sw.spaceAlerts && sw.spaceAlerts.length > 0){
      var geoAlerts = [];
      for(var ai = 0; ai < sw.spaceAlerts.length; ai++){
        var at = sw.spaceAlerts[ai].type;
        if(at === 'geomag' || at === 'wind' || at === 'cme') geoAlerts.push(sw.spaceAlerts[ai]);
      }
      if(geoAlerts.length > 0){
        var latest = geoAlerts[0];
        var snippet = latest.msg.replace(/<[^>]+>/g,'').substring(0,120);
        h += ' <span style="color:#f90;">  SWPC: ' + snippet + '</span>';
      }
    }

    h += '</div>';
    geoInsightEl.innerHTML = h;
  }

  // Refresh insight every 30s to pick up new solar wind data
  setInterval(updateGeoInsight, 30000);
  setTimeout(updateGeoInsight, 4000);
  setTimeout(updateGeoInsight, 10000);

  /* =========================================================
     ========================================================= */
  var suviTimer = null;

  /* =========================================================
     GFS UPPER AIR / POLAR VORTEX WIDGET
     ========================================================= */
  var gfsState = {
    activeTab: '500mb',
    fhrIndex: 0,
    playing: false,
    playTimer: null,
    cycle: '00',
    fhrs500: (function(){
      var arr = [];
      for(var i=0; i<=384; i+=6) arr.push(i.toString().padStart(3,'0'));
      return arr;
    })(),
    fhrs10: ['f00','f24','f48','f72','f96','f120','f144','f168','f192','f216','f240','f264','f288','f312','f336','f360','f384']
  };

  function getGfsCycle(){
    var now = new Date();
    var utcH = now.getUTCHours();
    var cycles = [0, 6, 12, 18];
    var bestCycle = '00';
    for(var i = cycles.length - 1; i >= 0; i--){
      if(utcH >= cycles[i] + 5 || (utcH < cycles[0] + 5 && i === cycles.length - 1)){
        bestCycle = cycles[i].toString().padStart(2,'0');
        break;
      }
    }
    if(utcH < 5) bestCycle = '18';
    return bestCycle;
  }

  function buildGfsUrl(tab, fhrIndex){
    if(tab === '500mb'){
      var fhr = gfsState.fhrs500[fhrIndex] || '000';
      return 'https://mag.ncep.noaa.gov/data/gfs/' + gfsState.cycle + '/namer/500_vort_ht/gfs_namer_' + fhr + '_500_vort_ht.gif';
    } else {
      var code = gfsState.fhrs10[fhrIndex] || 'f00';
      return 'https://www.cpc.ncep.noaa.gov/products/stratosphere/strat_a_f/gif_files/gfs_t10_nh_' + code + '.png';
    }
  }

  function getFhrLabel(tab, fhrIndex){
    if(tab === '500mb'){
      var h = parseInt(gfsState.fhrs500[fhrIndex], 10);
      if(h === 0) return 'F000  Analysis';
      var d = Math.floor(h / 24);
      var rem = h % 24;
      if(d === 0) return 'F' + gfsState.fhrs500[fhrIndex] + '  +' + h + 'h';
      return 'F' + gfsState.fhrs500[fhrIndex] + '  Day ' + d + (rem ? '+' + rem + 'h' : '');
    } else {
      var code = gfsState.fhrs10[fhrIndex];
      var hrs = parseInt(code.replace('f',''), 10);
      if(hrs === 0) return 'Analysis';
      var days = hrs / 24;
      return '+' + hrs + 'h  Day ' + days;
    }
  }

  function loadGfsFrame(){
    var tab = gfsState.activeTab;
    var imgId = tab === '500mb' ? 'gfs-500mb-img' : 'gfs-10mb-img';
    var img = document.getElementById(imgId);
    var liveEl = document.getElementById('gfs-live');
    if(!img) return;
    var url = buildGfsUrl(tab, gfsState.fhrIndex);
    img.onload = function(){ if(liveEl) liveEl.textContent = ' LIVE'; };
    img.onerror = function(){ if(liveEl) liveEl.textContent = ' OFFLINE'; };
    img.src = url;
    if(tab === '500mb'){
      img.style.filter = "invert(1) hue-rotate(180deg) contrast(1.3) saturate(1.2)";
    } else {
      img.style.filter = "invert(1) hue-rotate(180deg) contrast(1.3) saturate(1.2)";
    }
    var label = document.getElementById('gfs-fhr-label');
    if(label) label.textContent = getFhrLabel(tab, gfsState.fhrIndex);
    // Preload next frame for smoother animation
    var maxIdx = tab === '500mb' ? gfsState.fhrs500.length - 1 : gfsState.fhrs10.length - 1;
    var nextIdx = gfsState.fhrIndex + 1;
    if(nextIdx > maxIdx) nextIdx = 0;
    var preload = new Image();
    preload.src = buildGfsUrl(tab, nextIdx);
  }

  function switchGfsTab(tab){
    gfsState.activeTab = tab;
    gfsState.fhrIndex = 0;
    gfsStopPlay();
    var img500 = document.getElementById('gfs-500mb-img');
    var img10 = document.getElementById('gfs-10mb-img');
    if(img500) img500.style.display = tab === '500mb' ? '' : 'none';
    if(img10) img10.style.display = tab === '10mb' ? '' : 'none';
    var btn500 = document.getElementById('gfs-tab-500mb');
    var btn10 = document.getElementById('gfs-tab-10mb');
    if(btn500){
      btn500.style.background = tab === '500mb' ? 'rgba(255,255,255,.15)' : 'rgba(255,255,255,.06)';
      btn500.style.color = tab === '500mb' ? '#fff' : 'rgba(255,255,255,.5)';
      btn500.style.borderColor = tab === '500mb' ? 'rgba(255,255,255,.25)' : 'rgba(255,255,255,.15)';
    }
    if(btn10){
      btn10.style.background = tab === '10mb' ? 'rgba(255,255,255,.15)' : 'rgba(255,255,255,.06)';
      btn10.style.color = tab === '10mb' ? '#fff' : 'rgba(255,255,255,.5)';
      btn10.style.borderColor = tab === '10mb' ? 'rgba(255,255,255,.25)' : 'rgba(255,255,255,.15)';
    }
    loadGfsFrame();
  }

  function gfsStepFhr(dir){
    var maxIdx = gfsState.activeTab === '500mb' ? gfsState.fhrs500.length - 1 : gfsState.fhrs10.length - 1;
    gfsState.fhrIndex = Math.max(0, Math.min(maxIdx, gfsState.fhrIndex + dir));
    loadGfsFrame();
  }

  function gfsStopPlay(){
    gfsState.playing = false;
    if(gfsState.playTimer){ clearInterval(gfsState.playTimer); gfsState.playTimer = null; }
    var btn = document.getElementById('gfs-play-btn');
    if(btn) btn.textContent = '';
  }

  function gfsTogglePlay(){
    if(gfsState.playing){ gfsStopPlay(); return; }
    gfsState.playing = true;
    var btn = document.getElementById('gfs-play-btn');
    if(btn) btn.textContent = '';
    var speed = gfsState.activeTab === '500mb' ? 900 : 1200;
    gfsState.playTimer = setInterval(function(){
      var maxIdx = gfsState.activeTab === '500mb' ? gfsState.fhrs500.length - 1 : gfsState.fhrs10.length - 1;
      gfsState.fhrIndex++;
      if(gfsState.fhrIndex > maxIdx) gfsState.fhrIndex = 0;
      loadGfsFrame();
    }, speed);
  }

  function initGfsWidget(){
    gfsState.cycle = getGfsCycle();
    var cycleLabel = document.getElementById('gfs-cycle-label');
    if(cycleLabel) cycleLabel.textContent = 'Cycle: ' + gfsState.cycle + 'Z';
    loadGfsFrame();
    // Auto-start animation
    setTimeout(function(){ gfsTogglePlay(); }, 1500);
    setInterval(function(){
      var newCycle = getGfsCycle();
      if(newCycle !== gfsState.cycle){
        gfsState.cycle = newCycle;
        if(cycleLabel) cycleLabel.textContent = 'Cycle: ' + gfsState.cycle + 'Z';
        loadGfsFrame();
      }
    }, 30 * 60 * 1000);
  }

  // Expose GFS controls to global scope for inline onclick handlers
  window.switchGfsTab = switchGfsTab;
  window.gfsStepFhr = gfsStepFhr;
  window.gfsTogglePlay = gfsTogglePlay;

  /* =========================================================
     FORECAST RADAR & PRECIP TYPE (GFS/NAM-HIRES/HRRR)
     ========================================================= */
  var RIDGE_AREA_MAP = {
    'conus':'CONUS', 'namer':'CONUS-LARGE',
    'us-ne':'NORTHEAST', 'us-se':'SOUTHEAST', 'us-nc':'CENTGRLAKES', 'us-sc':'SOUTHMISSVLY',
    'us-nw':'PACNORTHWEST', 'us-sw':'PACSOUTHWEST',
    'upper-ms':'UPPERMISSVLY', 'south-ms':'SOUTHMISSVLY',
    'n-rockies':'NORTHROCKIES', 's-rockies':'SOUTHROCKIES', 's-plains':'SOUTHPLAINS',
    'alaska':'ALASKA', 'hawaii':'HAWAII', 'pr':'CARIB', 'guam':'GUAM'
  };

  var fcastState = {
    cycle: getGfsCycle(),
    idx: 0,
    playing: false,
    timer: null,
    product: 'precip_total',
    range: 'live',
    model: 'gfs',
    area: 'conus',
    allFhrs: (function(){
      var arr = [];
      for(var i = 3; i <= 84; i += 3) arr.push(i.toString().padStart(3, '0'));
      for(var i = 90; i <= 240; i += 6) arr.push(i.toString().padStart(3, '0'));
      for(var i = 252; i <= 384; i += 12) arr.push(i.toString().padStart(3, '0'));
      return arr;
    })(),
  };

  // Model area configs: which areas each model supports
  var modelAreaConfig = {
    'gfs':       {areas:['conus','namer','alaska','hawaii','north-pac','west-atl','atlantic','east-pac'], default:'conus'},
    'nam':       {areas:['conus','namer','us-ne','us-se','us-nw','us-sw','us-nc','us-sc','upper-ms','south-ms','n-rockies','s-rockies','s-plains','north-pac','west-atl','east-pac'], default:'conus'},
    'nam_hires': {areas:['conus','us-ne','us-se','us-nw','us-sw','us-nc','us-sc','alaska','hawaii','pr'], default:'us-ne'},
    'hrrr':      {areas:['conus','us-ne','us-se','us-nw','us-sw','us-nc','us-sc','alaska','hawaii','pr','guam'], default:'us-ne'},
    'href':      {areas:['conus','us-ne','us-se','us-nw','us-sw','us-nc','us-sc','alaska','hawaii','pr'], default:'us-ne'},
    'nbm':       {areas:['conus','namer','alaska','hawaii','pr'], default:'conus'},
    'gefs':      {areas:['conus','namer','north-pac','west-atl','atlantic','east-pac','alaska','arctic','europe','asia','africa'], default:'conus'}
  };

  // NAM-HIRES: 3-hourly out to 60h, cycles 00/06/12/18
  function getNamHiresFhrs(){
    var arr = [];
    for(var i = 3; i <= 60; i += 3) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // HRRR: hourly out to 48h
  function getHrrrFhrs(){
    var arr = [];
    for(var i = 1; i <= 48; i++) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // NAM (regular): hourly to 36h, 3-hourly to 84h
  function getNamFhrs(){
    var arr = [];
    for(var i = 1; i <= 36; i++) arr.push(i.toString().padStart(3, '0'));
    for(var i = 39; i <= 84; i += 3) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // HREF: hourly out to 48h
  function getHrefFhrs(){
    var arr = [];
    for(var i = 1; i <= 48; i++) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // NBM: 3-hourly out to 192h (8 days)
  function getNbmFhrs(){
    var arr = [];
    for(var i = 3; i <= 192; i += 3) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // GEFS: 6-hourly out to 384h (16 days)
  function getGefsFhrs(){
    var arr = [];
    for(var i = 6; i <= 384; i += 6) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }

  function getHrrrCycle(){
    var now = new Date();
    var utcH = now.getUTCHours();
    var cycles = [0, 6, 12, 18];
    var bestCycle = '00';
    for(var i = cycles.length - 1; i >= 0; i--){
      if(utcH >= cycles[i] + 4 || (utcH < cycles[0] + 4 && i === cycles.length - 1)){
        bestCycle = cycles[i].toString().padStart(2,'0');
        break;
      }
    }
    if(utcH < 4) bestCycle = '18';
    return bestCycle;
  }
  function getNamHiresCycle(){
    var now = new Date();
    var utcH = now.getUTCHours();
    var cycles = [0, 6, 12, 18];
    var bestCycle = '00';
    for(var i = cycles.length - 1; i >= 0; i--){
      if(utcH >= cycles[i] + 5 || (utcH < cycles[0] + 5 && i === cycles.length - 1)){
        bestCycle = cycles[i].toString().padStart(2,'0');
        break;
      }
    }
    if(utcH < 5) bestCycle = '18';
    return bestCycle;
  }
  // Generic 6-hourly cycle with configurable lag
  function get6hCycle(lag){
    var now = new Date();
    var utcH = now.getUTCHours();
    var cycles = [0, 6, 12, 18];
    var bestCycle = '00';
    for(var i = cycles.length - 1; i >= 0; i--){
      if(utcH >= cycles[i] + lag || (utcH < cycles[0] + lag && i === cycles.length - 1)){
        bestCycle = cycles[i].toString().padStart(2,'0');
        break;
      }
    }
    if(utcH < lag) bestCycle = '18';
    return bestCycle;
  }
  function getCycleForModel(model){
    if(model === 'gfs') return getGfsCycle();
    if(model === 'hrrr') return getHrrrCycle();
    if(model === 'nam_hires') return getNamHiresCycle();
    if(model === 'nam') return get6hCycle(5);
    if(model === 'href') return get6hCycle(5);
    if(model === 'nbm') return get6hCycle(4);
    if(model === 'gefs') return get6hCycle(7);
    return getGfsCycle();
  }

  function getActiveFhrs(){
    // LIVE mode: 10 frames from Ridge radar (9=oldest, 0=newest)
    if (fcastState.range === 'live') return ['9','8','7','6','5','4','3','2','1','0'];
    
    // Get full FHR array for the model
    var allFhrs;
    if (fcastState.model === 'nam_hires') allFhrs = getNamHiresFhrs();
    else if (fcastState.model === 'hrrr') allFhrs = getHrrrFhrs();
    else if (fcastState.model === 'nam') allFhrs = getNamFhrs();
    else if (fcastState.model === 'href') allFhrs = getHrefFhrs();
    else if (fcastState.model === 'nbm') allFhrs = getNbmFhrs();
    else if (fcastState.model === 'gefs') allFhrs = getGefsFhrs();
    else {
      // GFS special products
      if (fcastState.product === '10mb'){
        allFhrs = [];
        for (var i = 0; i <= 384; i += 24) allFhrs.push(i.toString().padStart(3,'0'));
      } else if (fcastState.product === '500mb'){
        allFhrs = [];
        for (var i = 0; i <= 384; i += 6) allFhrs.push(i.toString().padStart(3,'0'));
      } else {
        allFhrs = fcastState.allFhrs;
      }
    }

    // Apply range filter to ALL models
    if (fcastState.range === 'tomorrow'){
      var cycleHour = parseInt(fcastState.cycle, 10);
      var now = new Date();
      var cycleDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), cycleHour));
      if (cycleDate > now) cycleDate.setUTCDate(cycleDate.getUTCDate() - 1);
      var tomorrowStart = new Date(now); tomorrowStart.setDate(tomorrowStart.getDate() + 1); tomorrowStart.setHours(0,0,0,0);
      var tomorrowEnd = new Date(tomorrowStart); tomorrowEnd.setDate(tomorrowEnd.getDate() + 1);
      var minH = Math.max(1, Math.ceil((tomorrowStart.getTime() - cycleDate.getTime()) / 3600000));
      var maxH = Math.ceil((tomorrowEnd.getTime() - cycleDate.getTime()) / 3600000);
      var result = allFhrs.filter(function(f){ var h = parseInt(f,10); return h >= minH && h <= maxH; });
      if (result.length === 0) result = allFhrs.filter(function(f){ return parseInt(f,10) <= 48; });
      return result;
    }
    var maxH = fcastState.range === '48h' ? 48 : fcastState.range === '72h' ? 72 : (fcastState.range === '7d' ? 168 : 9999);
    return allFhrs.filter(function(f){ return parseInt(f,10) <= maxH; });
  }

  function buildFcastUrl(fhrIdx){
    var fhrs = getActiveFhrs();
    var fhr = fhrs[fhrIdx] || '0';
    
    // LIVE mode: use NOAA Ridge radar
    if (fcastState.range === 'live'){
      var region = RIDGE_AREA_MAP[fcastState.area] || 'CONUS';
      return 'https://radar.weather.gov/ridge/standard/' + region + '_' + fhr + '.gif?cb=' + Math.floor(Date.now()/60000);
    }

    var area = fcastState.area;
    var cycle = fcastState.cycle;
    var base = 'https://mag.ncep.noaa.gov/data/';

    // Shared product map for high-res models (HRRR, NAM-HIRES, HREF, NAM)
    var hiresProductMap = {
      'sim_radar':'sim_radar_comp', 'precip_type':'precip_rate_type', 'precip_total':'precip_ptot',
      'snow_accum':'snow_total', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
      'humidity':'700_rh_ht', 'cape':'sfc_cape_cin',
      'max_ref':'sim_radar_max', 'radar_1km':'sim_radar_1km', 'precip_1hr':'precip_p01',
      'best_cape':'best_cape_cin', 'helicity':'helicity_3km', 'updraft':'max_updraft_hlcy',
      'echo_top':'echo_top', 'lightning':'lightning', 'max_wind':'10m_maxwnd',
      'visibility':'vis', 'ceiling':'ceiling', '850temp':'850_temp_mslp_precip',
      '500vort':'500_vort_ht', '250wind':'250_wnd'
    };

    // NAM-HIRES  flat: /data/nam-hires/{HH}/nam-hires_{area}_{FHR}_{product}.gif
    if (fcastState.model === 'nam_hires'){
      var prod = hiresProductMap[fcastState.product] || 'sim_radar_comp';
      return base + 'nam-hires/' + cycle + '/nam-hires_' + area + '_' + fhr + '_' + prod + '.gif';
    }

    // HRRR  flat with 00 suffix: /data/hrrr/{HH}/hrrr_{area}_{FHR}00_{product}.gif
    if (fcastState.model === 'hrrr'){
      var hrrrOverrides = {'wind':'10m_wnd_sfc_gust'};
      var prod = hrrrOverrides[fcastState.product] || hiresProductMap[fcastState.product] || 'sim_radar_comp';
      return base + 'hrrr/' + cycle + '/hrrr_' + area + '_' + fhr + '00_' + prod + '.gif';
    }

    // NAM (regular)  flat: /data/nam/{HH}/nam_{area}_{FHR}_{product}.gif
    if (fcastState.model === 'nam'){
      var namProdMap = {
        'sim_radar':'sim_radar_comp', 'precip_type':'precip_rate_type', 'precip_total':'precip_ptot',
        'snow_accum':'snodpth_chng', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
        'humidity':'700_rh_ht', 'cape':'850_pw_ht', 'precip_6hr':'precip_p06', 'precip_24hr':'precip_p24',
        'low_thick':'1000_850_thick', 'mid_thick':'850_700_thick', 'wnd_temp':'10m_wnd_2m_temp',
        'gfs_850temp':'850_temp_ht', 'gfs_850vort':'850_vort_ht', 'gfs_500wind':'500_wnd_ht',
        'gfs_500rh':'500_rh_ht', 'jet_stream':'250_wnd_ht', 'gfs_fourpanel':'850vor_500ht_200wd',
        '850temp':'850_temp_mslp_precip', '500vort':'500_vort_ht', '250wind':'250_wnd_ht'
      };
      var prod = namProdMap[fcastState.product] || 'sim_radar_comp';
      return base + 'nam/' + cycle + '/nam_' + area + '_' + fhr + '_' + prod + '.gif';
    }

    // HREF  flat with mean_ prefix: /data/href/{HH}/href_{area}_{FHR}_mean_{product}.gif
    if (fcastState.model === 'href'){
      var prod = hiresProductMap[fcastState.product] || 'sim_radar_comp';
      return base + 'href/' + cycle + '/href_' + area + '_' + fhr + '_mean_' + prod + '.gif';
    }

    // NBM  flat: /data/nbm/{HH}/nbm_{area}_{FHR}_{product}.gif
    if (fcastState.model === 'nbm'){
      var nbmProdMap = {
        'sim_radar':'sim_radar_comp', 'precip_type':'precip_rate_type', 'precip_total':'precip_ptot',
        'snow_accum':'snodpth_chng', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
        'humidity':'700_rh_ht', 'cape':'850_pw_ht', 'precip_1hr':'precip_p01',
        'precip_6hr':'precip_p06', 'precip_24hr':'precip_p24'
      };
      var prod = nbmProdMap[fcastState.product] || 'sim_radar_comp';
      return base + 'nbm/' + cycle + '/nbm_' + area + '_' + fhr + '_' + prod + '.gif';
    }

    // GEFS  flat: /data/gefs-mean-sprd/{HH}/gefs-mean-sprd_{area}_{FHR}_{product}.gif
    if (fcastState.model === 'gefs'){
      var gefsProdMap = {
        'sim_radar':'sim_radar_comp', 'precip_total':'precip_ptot', 'precip_type':'precip_rate_type',
        'snow_accum':'snodpth_chng', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
        'humidity':'700_rh_ht', 'cape':'850_pw_ht', 'precip_6hr':'precip_p06', 'precip_24hr':'precip_p24',
        'jet_stream':'250_wnd_ht', '500vort':'500_vort_ht', 'gfs_850temp':'850_temp_ht',
        'gfs_500wind':'500_wnd_ht', 'gfs_500rh':'500_rh_ht'
      };
      var prod = gefsProdMap[fcastState.product] || 'precip_p06';
      return base + 'gefs-mean-sprd/' + cycle + '/gefs-mean-sprd_' + area + '_' + fhr + '_' + prod + '.gif';
    }

    // GFS model  subfolder pattern: /data/gfs/{HH}/{area}/{product}/gfs_{area}_{FHR}_{product}.gif
    var gfsProdMap = {
      'sim_radar':'sim_radar_comp', 'precip_type':'precip_rate_type', 'precip_total':'precip_ptot',
      'snow_accum':'snodpth_chng', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
      'humidity':'700_rh_ht', 'cape':'850_pw_ht', 'jet_stream':'250_wnd_ht',
      'precip_6hr':'precip_p06', 'precip_24hr':'precip_p24',
      'low_thick':'1000_850_thick', 'mid_thick':'850_700_thick', 'wnd_temp':'10m_wnd_2m_temp',
      'gfs_850temp':'850_temp_ht', 'gfs_850vort':'850_vort_ht', 'gfs_500wind':'500_wnd_ht',
      'gfs_500rh':'500_rh_ht', 'gfs_fourpanel':'850vor_500ht_200wd'
    };
    // Special cases
    if (fcastState.product === '500mb'){
      return base + 'gfs/' + cycle + '/namer/500_vort_ht/gfs_namer_' + fhr + '_500_vort_ht.gif';
    }
    if (fcastState.product === '10mb'){
      var h = parseInt(fhr, 10);
      var code = 'f' + h.toString().padStart(2,'0');
      return 'https://www.cpc.ncep.noaa.gov/products/stratosphere/strat_a_f/gif_files/gfs_t10_nh_' + code + '.png';
    }
    var gfsProd = gfsProdMap[fcastState.product] || 'sim_radar_comp';
    return base + 'gfs/' + cycle + '/' + area + '/' + gfsProd + '/gfs_' + area + '_' + fhr + '_' + gfsProd + '.gif';
  }

  function getFcastLabel(fhrIdx){
    var fhrs = getActiveFhrs();
    
    // LIVE mode: show relative time
    if (fcastState.range === 'live'){
      var frameNum = parseInt(fhrs[fhrIdx], 10);
      if (frameNum === 0) return 'NOW';
      var minsAgo = frameNum * 2; // ~2 min per frame
      return '~' + minsAgo + ' MIN AGO';
    }
    
    var h = parseInt(fhrs[fhrIdx], 10);
    var cycleHour = parseInt(fcastState.cycle, 10);
    var now = new Date();
    var cycleDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), cycleHour));
    if (cycleDate > now) cycleDate.setUTCDate(cycleDate.getUTCDate() - 1);
    var targetUTC = new Date(cycleDate.getTime() + h * 3600000);
    var fullDays = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
    var dayName = fullDays[targetUTC.getDay()];
    var mon = targetUTC.getMonth() + 1;
    var date = targetUTC.getDate();
    var hr = targetUTC.getHours();
    var ampm = hr >= 12 ? 'PM' : 'AM';
    hr = hr % 12; if (hr === 0) hr = 12;
    var today = new Date();
    var isToday = targetUTC.toDateString() === today.toDateString();
    var tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
    var isTomorrow = targetUTC.toDateString() === tomorrow.toDateString();
    var prefix = isToday ? 'TODAY' : (isTomorrow ? 'TOMORROW' : dayName);
    return prefix + ' ' + mon + '/' + date + ' ' + hr + ampm + '  (+' + h + 'H)';
  }

  var lastGoodSrc = ''; // Track last successfully loaded frame
  var lastGoodSrc = ''; // Last successfully loaded frame
  var loopGeneration = 0; // Increments each time playback loops back to frame 0

  function loadFcastRadar(){
    var fhrs = getActiveFhrs();
    var img = document.getElementById('fcast-radar-img');
    var label = document.getElementById('fcast-radar-label');
    if (!fhrs || fhrs.length === 0){
      if (label) label.textContent = 'No data for range';
      return;
    }
    
    // LIVE mode: use Ridge individual frames
    if (fcastState.range === 'live'){
      var region = RIDGE_AREA_MAP[fcastState.area] || 'CONUS';
      var frameNum = fhrs[fcastState.idx] || '0';
      var url = 'https://radar.weather.gov/ridge/standard/' + region + '_' + frameNum + '.gif?cb=' + Math.floor(Date.now()/60000);
      if (img) {
        var loader = document.getElementById('fcast-loading');
        if (loader && !lastGoodSrc) loader.style.opacity = '1';
        img.onerror = function(){ if (lastGoodSrc && img.src !== lastGoodSrc) img.src = lastGoodSrc; else { img.style.opacity = '0'; } if (loader) loader.style.opacity = '0'; };
        img.onload = function(){ img.style.opacity = '1'; lastGoodSrc = img.src; if (loader) loader.style.opacity = '0'; };
        img.src = url;
        img.style.top = '50%';
        img.style.left = '50%';
        img.style.objectFit = 'contain';
        img.style.objectPosition = 'center center';
        img.style.width = '100%';
        img.style.height = '100%';
      }
      if (label){
        var n = parseInt(frameNum, 10);
        label.textContent = n === 0 ? 'NOW' : '~' + (n * 2) + ' MIN AGO';
      }
      return;
    }
    
    // Always attempt the real URL  even if it failed last loop, server may have caught up
    var url = buildFcastUrl(fcastState.idx);
    if (img) {
      var loader = document.getElementById('fcast-loading');
      if (loader && !lastGoodSrc) loader.style.opacity = '1';
      img.onerror = function(){ if (lastGoodSrc && img.src !== lastGoodSrc) img.src = lastGoodSrc; else { img.style.opacity = '0'; } if (loader) loader.style.opacity = '0'; };
      img.onload = function(){ img.style.opacity = '1'; lastGoodSrc = img.src; if (loader) loader.style.opacity = '0'; };
      img.src = url;
    }
    if (label) label.textContent = getFcastLabel(fcastState.idx);
  }

  function fcastRadarStep(dir){
    var fhrs = getActiveFhrs();
    fcastState.idx = Math.max(0, Math.min(fhrs.length - 1, fcastState.idx + dir));
    loadFcastRadar();
  }

  function fcastRadarTogglePlay(){
    var btn = document.getElementById('fcast-radar-play-btn');
    if (fcastState.playing){
      clearInterval(fcastState.timer);
      fcastState.playing = false;
      if (btn) btn.textContent = '';
    } else {
      fcastState.playing = true;
      if (btn) btn.textContent = '';
      var interval = fcastState.range === 'live' ? 1200 : 500;
      fcastState.timer = setInterval(function(){
        var fhrs = getActiveFhrs();
        fcastState.idx++;
        if (fcastState.idx >= fhrs.length) fcastState.idx = 0;
        loadFcastRadar();
      }, interval);
    }
  }

  function updateFcastBadge(){
    var badge = document.getElementById('fcast-badge');
    if (!badge) return;
    var prodLabels = {'precip_type':'PRECIP TYPE','snow_accum':'SNOW ACCUMULATION','precip_total':'PRECIP TOTALS','wind':'WIND & MSLP','cape': (fcastState.model === 'gfs' ? 'PRECIP WATER 850MB' : 'CAPE & CIN'),'temperature':'THICKNESS & PRECIP','jet_stream':'JET STREAM 250MB','humidity':'700MB HUMIDITY','500mb':'500MB VORTICITY','10mb':'10MB STRATOSPHERE','max_ref':'MAX REFLECTIVITY','radar_1km':'1KM REFLECTIVITY','precip_1hr':'1HR PRECIP','best_cape':'BEST CAPE','helicity':'3KM HELICITY','updraft':'UPDRAFT HELICITY','echo_top':'ECHO TOPS','lightning':'LIGHTNING','max_wind':'MAX WIND','visibility':'VISIBILITY','ceiling':'CEILING','850temp':'850MB TEMP','500vort':'500MB VORTICITY','250wind':'250MB JETS','precip_6hr':'6HR PRECIP','precip_24hr':'24HR PRECIP','low_thick':'1000-850 THICKNESS','mid_thick':'850-700 THICKNESS','wnd_temp':'WIND & 2M TEMP','gfs_850temp':'850MB TEMP','gfs_850vort':'850MB VORTICITY','gfs_500wind':'500MB WIND','gfs_500rh':'500MB HUMIDITY','gfs_fourpanel':'4-PANEL COMPOSITE'};
    var prod = prodLabels[fcastState.product] || 'SIM RADAR';
    var modelLabels = {'gfs':'GFS','nam':'NAM','nam_hires':'NAM 3KM','hrrr':'HRRR 3KM','href':'HREF','nbm':'NBM','gefs':'GEFS'};
    var areaLabels = {'conus':'CONUS','namer':'NAMER','us-ne':'NE','us-se':'SE','us-nc':'NC','us-sc':'SC','us-nw':'NW','us-sw':'SW','alaska':'AK','hawaii':'HI','pr':'PR','guam':'GU','north-pac':'N PAC','east-pac':'E PAC','west-atl':'W ATL','atlantic':'ATL','arctic':'ARC','europe':'EUR','asia':'ASIA','africa':'AFR'};
    var modelName = (modelLabels[fcastState.model] || 'GFS') + ' ' + (areaLabels[fcastState.area] || '');
    if (fcastState.range === 'live'){
      var ridgeAreaLabels = {'conus':'CONUS','namer':'CONUS','us-ne':'NORTHEAST','us-se':'SOUTHEAST','us-nc':'CENT GL','us-sc':'S MISS VLY','us-nw':'PAC NW','us-sw':'PAC SW','upper-ms':'UP MISS VLY','south-ms':'S MISS VLY','n-rockies':'N ROCKIES','s-rockies':'S ROCKIES','s-plains':'S PLAINS','alaska':'ALASKA','hawaii':'HAWAII','pr':'CARIBBEAN','guam':'GUAM'};
      badge.textContent = 'LIVE RADAR ' + (ridgeAreaLabels[fcastState.area] || 'CONUS');
    } else {
      badge.textContent = modelName + ' ' + prod;
    }
    updateFcastInfo();
  }

  function updateFcastInfo(){
    var el = document.getElementById('fcast-info-text');
    if (!el) return;
    var S = function(title){ return '<div class="info-heading">' + title + '</div>'; };

    // MODEL DESCRIPTIONS
    var modelInfo = {
      'gfs': S('MODEL') + '<b>GFS (Global Forecast System)</b>  NOAA\'s flagship global weather model run by the National Centers for Environmental Prediction (NCEP). Covers the entire globe at <span class="k">~13km resolution</span>, producing forecasts out to <span class="k">16 days (3<span class="k">84 hours</span>)</span>. <span class="k">Updated 4 times daily</span> at 00Z, 06Z, 12Z, and 18Z. Best for identifying synoptic-scale patterns like frontal boundaries, jet stream position, and multi-day storm tracks. Less reliable for pinpointing exactly where individual thunderstorms will fire due to its coarser grid spacing  use HRRR or NAM 3KM for that.',
      'nam': S('MODEL') + '<b>NAM (North American Mesoscale)</b>  NOAA\'s regional model focused on North America at <span class="k">~12km resolution</span>, forecasting out to <span class="k">84 hours</span>. Updated every 6 hours. Resolves terrain-driven weather better than GFS  lake-effect snow bands, orographic precipitation, and sea breeze fronts. Its strength is the 1-3 day range over CONUS. Beyond 3 days, the GFS generally has more skill at the synoptic scale.',
      'nam_hires': S('MODEL') + '<b>NAM 3KM (High-Resolution NAM Nest)</b>  A <span class="k">convection-allowing</span> nested domain within the NAM, running at <span class="k">3km grid spacing</span> out to 60 hours. At this resolution, individual thunderstorm cells are explicitly simulated rather than parameterized  you can see discrete storms, squall lines, and supercell structures in the output. Excellent for severe weather forecasting, mesoscale convective systems, and terrain-forced precipitation like downslope windstorms.',
      'hrrr': S('MODEL') + '<b>HRRR (High-Resolution Rapid Refresh)</b>  NOAA\'s highest-resolution operational model at 3km, <span class="k">updated every single hour</span> with forecasts to 48 hours. It <span class="k">assimilates real-time radar data</span>, satellite imagery, aircraft reports, and surface observations every cycle. This makes it the <span class="k">best model for nowcasting</span>  when will the rain start at your location? When will the storm line pass? The HRRR\'s hourly updates capture rapidly evolving convection that other models miss between their 6-hour cycles.',
      'href': S('MODEL') + '<b>HREF (High-Resolution Ensemble Forecast)</b>  Instead of a single model run, HREF combines multiple high-resolution models (HRRR, NAM Nest, and time-lagged HRRR members) to show the range of possible outcomes. When all members agree on storm placement, confidence is high. When members diverge, that\'s the model telling you "this is uncertain." The <span class="k">probabilistic approach</span> is consistently more skillful than trusting any single deterministic run, especially for severe weather timing and placement.',
      'nbm': S('MODEL') + '<b>NBM (National Blend of Models)</b>  A statistically post-processed blend of every major model (GFS, NAM, ECMWF, HRRR, Canadian, and more) optimized using years of historical verification data. NBM applies <span class="k">bias correction</span>  if the GFS consistently runs 2F too warm in your area, NBM adjusts for that. It also weights models differently based on which performs best for each variable. Often the single best forecast product for temperature, precipitation probability, wind speed, and sky cover.',
      'gefs': S('MODEL') + '<b>GEFS (Global Ensemble Forecast System)</b>  <span class="k">31 slightly different versions</span> of the GFS, each started with tiny variations in initial conditions. The <span class="k">ensemble mean</span> (average of all members) is smoother and more skillful than any single run beyond day 3. The spread between members quantifies uncertainty  tight clustering means high confidence, wide spread means the atmosphere is in a chaotic state where small changes lead to very different outcomes. Essential for planning around weather 5-16 days out.'
    };

    // PRODUCT DESCRIPTIONS
    var productInfo = {
      'sim_radar': S('PRODUCT') + '<b>Simulated Composite Reflectivity</b>  Model-predicted radar echoes showing where precipitation is forecast to occur. The model calculates hydrometeor (rain, snow, ice, graupel) concentrations and converts them to equivalent radar reflectivity.' +
        S('HOW TO READ') + 'Colors follow the standard NWS dBZ reflectivity scale. <span style="color:#00e600"><b>Green (20-35 dBZ)</b></span> = light to moderate rain or snow. <span style="color:#e6e600"><b>Yellow (35-45 dBZ)</b></span> = moderate to heavy rain. <span style="color:#e69000"><b>Orange (45-50 dBZ)</b></span> = heavy rain, small hail possible. <span style="color:#e62000"><b>Red (50-60 dBZ)</b></span> = very heavy rain, hail likely. <span style="color:#e600e6"><b>Magenta (60+ dBZ)</b></span> = extreme intensity, large hail, damaging winds. Compare the model\'s simulated radar with the actual live radar to gauge how well the model is performing  if it\'s nailing current conditions, trust the forecast more.',
      'max_ref': S('PRODUCT') + '<b>Composite Max Reflectivity</b>  The highest reflectivity value found anywhere in the vertical column at each grid point. This catches elevated convection and hail cores that surface-level reflectivity would miss.' +
        S('HOW TO READ') + 'Values above 50 dBZ suggest severe thunderstorm potential. Above 60 dBZ strongly indicates large hail (1 inch). Above 65 dBZ signals giant hail (2 inches). If you see a compact core of 60+ dBZ embedded within a larger storm complex, that\'s likely a supercell with a significant hail threat.',
      'radar_1km': S('PRODUCT') + '<b>1km AGL Reflectivity</b>  Simulated radar returns at exactly 1km above ground level  the altitude closest to what actual weather radar scans in its lowest tilt.' +
        S('HOW TO READ') + 'This view is more realistic than composite reflectivity for assessing what precipitation is actually reaching the ground. If you see strong returns in composite but weak returns at 1km, that\'s <span class="k">virga</span>  precipitation evaporating before reaching the surface. Common in dry climates and with elevated thunderstorms.',
      'echo_top': S('PRODUCT') + '<b>Echo Tops</b>  The height (in feet) of the highest detectable radar echo in the atmosphere.' +
        S('HOW TO READ') + 'Echo tops above 35,000 ft indicate vigorous convection. Above 45,000 ft suggests an extremely powerful updraft punching into the stratosphere (<span class="k">overshooting top</span>). Rapidly rising echo tops  jumping 10,000+ ft in 15-30 minutes  are one of the earliest indicators that a storm is becoming severe. Critical for aviation: pilots avoid anything above 25,000 ft echo tops.',
      'precip_type': S('PRODUCT') + '<b>Precipitation Type</b>  The model analyzes the temperature profile from cloud level to the surface to categorize precipitation as rain, snow, freezing rain, sleet (ice pellets), or mixed.' +
        S('HOW TO READ') + 'The critical factor is whether a warm layer exists above freezing aloft. Snow falling through a warm layer melts to rain. If it then falls through a shallow cold layer near the surface, it refreezes as sleet (bounces on impact) or remains liquid and freezes on contact as freezing rain (coats everything in ice). Freezing rain is the most dangerous winter precipitation  even 0.25" of ice accumulation can down trees and power lines.',
      'precip_total': S('PRODUCT') + '<b>Total QPF (Quantitative Precipitation Forecast)</b>  Accumulated liquid-equivalent precipitation over the entire forecast period. Snow is melted down  12 inches of snow might show as 1 inch of liquid.' +
        S('HOW TO READ') + 'Compare forecast totals against your county\'s <span class="k">Flash Flood Guidance (FFG)</span> values, available from your local NWS office. If the QPF exceeds the FFG for your area\'s soil conditions, flash flooding is possible. For snow, multiply the liquid equivalent by the snow-to-liquid ratio (typically 10:1 to 15:1 depending on temperature) to estimate actual snowfall depth.',
      'precip_1hr': S('PRODUCT') + '<b>1-Hour Precipitation</b>  Forecast rainfall or liquid-equivalent snowfall for each individual hour.' +
        S('HOW TO READ') + 'Rates above 0.5 in/hr indicate moderate-heavy rain. Above 1 in/hr is intense and can cause urban flooding and rapid creek rises. Above 2 in/hr is extreme and almost certainly produces flash flooding in any terrain. For snow, rates above 1 in/hr liquid equivalent can produce thundersnow and near-zero visibility. Step through frames to find exactly when the heaviest precipitation arrives at your location.',
      'precip_6hr': S('PRODUCT') + '<b>6-Hour Precipitation</b>  Accumulated precipitation in 6-hour windows, the standard interval used by NCEP for model verification and NWS coordination.' +
        S('HOW TO READ') + 'This smooths out the noise of individual convective cells and reveals the broader precipitation pattern. Values above 2 inches in 6 hours indicate a significant rainfall event. Above 4 inches in 6 hours is extreme and exceeds flash flood guidance for most of the eastern US.',
      'precip_24hr': S('PRODUCT') + '<b>24-Hour Precipitation</b>  Full-day accumulation totals showing the total storm impact.' +
        S('HOW TO READ') + 'Compare with local climatological records. Values exceeding your area\'s 1-in-10-year 24-hour rainfall amount (available from NOAA Atlas 14) suggest significant flooding potential. In the eastern US, 4-6 inches in 24 hours is a major event. In the arid West, 1-2 inches can be catastrophic due to poor soil absorption.',
      'snow_accum': S('PRODUCT') + '<b>Snowfall Accumulation</b>  Forecast snow depth accounting for the <span class="k">snow-to-liquid ratio (SLR)</span>, which varies dramatically with temperature and crystal structure.' +
        S('HOW TO READ') + 'Fluffy, cold snow (temperatures in the teens F) may have a 15:1 or 20:1 ratio  1 inch of liquid produces 15-20 inches of snow. Heavy, wet snow near 32F may only be 8:1 or less. Models typically assume a fixed ratio around 10:1 to 13:1. If the storm is particularly cold or warm, mentally adjust the displayed totals. Also note that compaction occurs  12 inches falling over 6 hours may only measure 8 inches on the ground due to settling.',
      'cape': S('PRODUCT') + '<b>CAPE & CIN / Precipitable Water</b>  On GFS: Precipitable Water (PWAT)  the total moisture content of the atmospheric column if every drop were condensed. On hi-res models: CAPE (Convective Available Potential Energy) measuring thunderstorm fuel, and CIN (Convective Inhibition) measuring the "cap" suppressing convection.' +
        S('HOW TO READ') + 'PWAT values above 1.5 inches indicate a moisture-rich atmosphere; above 2 inches is anomalously moist and primed for heavy rainfall. For CAPE: 500-1000 J/kg is marginal instability, <span class="k">1000-2500</span> is moderate (scattered storms), <span class="k">2500-4000</span> is strong (organized severe weather possible), <span class="k">above 4000</span> is extreme. However, CAPE alone doesn\'t produce severe weather  you also need wind shear and a trigger (front, outflow boundary, terrain).',
      'best_cape': S('PRODUCT') + '<b>Most Unstable CAPE (MUCAPE)</b>  CAPE calculated from the most unstable air parcel in the lowest 300mb of the atmosphere, regardless of its altitude. More relevant than surface-based CAPE when instability is elevated.' +
        S('HOW TO READ') + 'MUCAPE catches situations where a warm, moist layer exists above the surface (like above a frontal inversion). If MUCAPE is high but surface CAPE is zero, storms can still develop  they\'ll be "elevated" convection rooted above the surface. These elevated storms can still produce heavy rain, hail, and occasionally tornadoes, but they behave differently than surface-based supercells.',
      'helicity': S('PRODUCT') + '<b>0-3km Storm-Relative Helicity (SRH)</b>  A measure of the horizontal spin (vorticity) in the lowest 3km that thunderstorm updrafts can tilt into vertical rotation.' +
        S('HOW TO READ') + 'Values of 100-150 m/s support weak rotation in storms. 150-300 m/s can produce mesocyclones and is favorable for supercells. Above 300 m/s strongly favors significant (<span class="k">EF2+) tornadoes</span> when combined with CAPE above 1000 J/kg. The <span class="k">Significant Tornado Parameter (STP)</span> combines SRH, CAPE, wind shear, and the lifting condensation level  when all ingredients overlap, tornado risk is maximized.',
      'updraft': S('PRODUCT') + '<b>Updraft Helicity (UH)</b>  A field that identifies rotating updrafts within model-simulated storms. Computed by integrating the product of vertical velocity and vertical vorticity through the 2-5km layer.' +
        S('HOW TO READ') + 'UH tracks above 25 m/s indicate storm rotation. Above 75 m/s shows supercell-like structures. <span class="k">Above 150 m/s</span> indicates intense mesocyclones with high tornado probability. Forecasters animate UH tracks to see where the model develops rotating storms and how they move. Long, continuous UH tracks suggest long-lived supercells.',
      'lightning': S('PRODUCT') + '<b>Lightning Threat Index</b>  Model-derived lightning potential based on ice-phase microphysics: graupel production, vertical motion intensity, and the collision of ice crystals and graupel that generates electrical charge separation.' +
        S('HOW TO READ') + 'Higher values indicate greater charge separation and more frequent lightning. Useful for outdoor event planning, wildfire ignition risk assessment, and identifying which model-generated storms are most electrically active. Lightning can strike 10+ miles from the rain shaft  if you can hear thunder, you\'re within strike range.',
      'max_wind': S('PRODUCT') + '<b>Maximum Surface Wind Gust</b>  The predicted peak wind gust at 10 meters above ground, factoring in convective downdraft mixing, pressure gradient forces, and terrain channeling.' +
        S('HOW TO READ') + 'The NWS issues Severe Thunderstorm Warnings when gusts reach <span class="k">58 mph (50 knots)</span>. Gusts of 40-57 mph can down tree limbs and cause minor damage. 58-75 mph causes significant tree damage and roof damage. Above 75 mph is equivalent to a weak tornado (EF0-EF1). Microbursts from collapsing thunderstorms can produce localized gusts exceeding 100 mph.',
      'temperature': S('PRODUCT') + '<b>1000-500mb Thickness & Precipitation Type</b>  Thickness is the distance (in decameters) between the 1000mb and 500mb pressure surfaces. It\'s directly proportional to the mean temperature of that atmospheric layer.' +
        S('HOW TO READ') + 'The <b><span class="k">540 decameter line</span></b> is the classic rain/snow discriminator. North of the 540dm line, precipitation is more likely to fall as snow. South of it, rain predominates. This is a rough guideline  local factors like elevation, warm noses aloft, and cold air damming can shift the rain/snow line significantly. The overlaid precipitation shading shows where the transition zones are.',
      'wind': S('PRODUCT') + '<b>10m Wind & Mean Sea Level Pressure (MSLP)</b>  Wind barbs show speed and direction at 10 meters above ground. Isobars (lines of equal pressure) show the MSLP field in millibars.' +
        S('HOW TO READ') + 'Wind flows roughly parallel to isobars (with slight inward turn due to friction). Tightly packed isobars = strong pressure gradient = high winds. Each full barb = 10 knots, half barb = 5 knots, flag = 50 knots. Low pressure centers show counterclockwise circulation (Northern Hemisphere). Look for sharp wind shifts along fronts  where winds change direction over a short distance, that\'s a frontal boundary.',
      'jet_stream': S('PRODUCT') + '<b>250mb Jet Stream Wind</b>  Upper-level winds at approximately 34,000 feet (250 millibars) showing the position and intensity of the jet stream.' +
        S('HOW TO READ') + 'Jet streaks are embedded wind maxima within the jet stream, often exceeding 100-150 knots. The key to forecasting is the <b><span class="k">four-quadrant model</span></b>: the <span class="k">right entrance region and left exit region</span> of a jet streak produce upper-level divergence, which forces air to rise below, fueling surface low pressure development and precipitation. When a jet streak moves over an area of existing instability, explosive severe weather can result.',
      'humidity': S('PRODUCT') + '<b>700mb Relative Humidity</b>  Moisture content at approximately 10,000 feet elevation (the mid-troposphere).' +
        S('HOW TO READ') + 'RH above 80% indicates saturated air  expect clouds and likely precipitation. RH below 40% shows dry air, fair skies, or a "dry slot" wrapping around a cyclone. A dry air intrusion on the west side of a storm system indicates the cold conveyor belt and signals the storm is reaching maturity or beginning to occlude. Dry air aloft over moist surface air enhances evaporative cooling and increases severe thunderstorm downdraft potential.',
      '500mb': S('PRODUCT') + '<b>500mb Geopotential Height & Absolute Vorticity</b>  The 500mb surface (~18,000 ft) is called the "steering level" because weather systems at the surface roughly follow the 500mb flow.' +
        S('HOW TO READ') + 'Troughs (southward dips in the height contours) bring unsettled, stormier weather. Ridges (northward bulges) bring fair, warmer weather. Vorticity maxima (red/warm colors) embedded in troughs are "shortwaves"  when they cross your area, expect clouds, precipitation, and possible severe weather. <span class="k">Positive Vorticity Advection (PVA)</span> ahead of approaching shortwaves creates the large-scale lift that triggers widespread precipitation.',
      '10mb': S('PRODUCT') + '<b>10mb Stratospheric Analysis</b>  Conditions at approximately 31km (100,000 ft) altitude in the stratosphere, well above all weather but capable of influencing it weeks later.' +
        S('HOW TO READ') + 'This level shows the polar vortex  the large-scale circulation of cold air over the poles. During a <b><span class="k">Sudden Stratospheric Warming</span> <span class="k">(SSW)</span></b>, the polar vortex weakens or reverses direction. This disruption propagates downward through the atmosphere over 2-6 weeks, often leading to prolonged cold outbreaks, blocking patterns, and increased storminess at the surface. SSW events are some of the most reliable predictors of extended cold snaps.',
      'visibility': S('PRODUCT') + '<b>Surface Visibility</b>  Forecast visibility in miles or kilometers, accounting for precipitation, fog, haze, smoke, and blowing snow.' +
        S('HOW TO READ') + 'Aviation categories: <span class="k">VFR</span> = visibility >3 statute miles; <span class="k">MVFR</span> (Marginal) = 1-3 miles; <span class="k">IFR</span> (Instrument) = 1/2 to 1 mile; <span class="k">LIFR</span> (Low IFR) = below 1/2 mile. For driving, visibility under 1/4 mile is extremely dangerous. Radiation fog forms overnight in valleys with clear skies and light winds, typically burning off by mid-morning. Advection fog occurs when warm, moist air moves over cold surfaces (common along coastlines).',
      'ceiling': S('PRODUCT') + '<b>Cloud Ceiling Height</b>  The altitude of the lowest cloud layer classified as broken (5-7 oktas) or overcast (8 oktas).' +
        S('HOW TO READ') + 'Below 200 ft AGL = LIFR (near-zero ceiling, extremely hazardous). 200-500 ft = IFR. 500-1000 ft = low IFR. 1000-3000 ft = MVFR. Above 3000 ft = VFR. Mountain passes and ridgelines are dangerous when ceiling heights drop below terrain elevation  the clouds literally engulf the roadway. For pilots, ceilings are the primary factor in determining whether visual or instrument approaches are required.',
      '850temp': S('PRODUCT') + '<b>850mb Temperature</b>  Temperature at approximately 5,000 ft elevation, above the surface boundary layer where ground heating and cooling effects are removed.' +
        S('HOW TO READ') + 'The 850mb 0C isotherm roughly marks the surface rain/snow transition. Warm colors (red/orange) advecting into cold areas indicate an approaching warm front. Cold colors (blue/purple) pushing into warm areas show cold air advection behind a cold front. The 850mb temperature is also used for forecasting severe weather  the warmer the 850mb temperatures ahead of a dryline or front, the greater the instability.',
      '500vort': S('PRODUCT') + '<b>500mb Vorticity</b>  The spin of the atmosphere at the steering level, a key driver of surface weather development.' +
        S('HOW TO READ') + 'Positive (cyclonic) vorticity maxima are the "energy" embedded in the jet stream. As a vorticity max approaches, expect increasing clouds, lowering pressure, and precipitation. The area of maximum <span class="k">Positive Vorticity Advection (PVA)</span>  just ahead and east of the vort max  is where surface cyclogenesis (low pressure development) is most favored. Animate frames to track these features and anticipate where they\'ll be at your forecast time.',
      '250wind': S('PRODUCT') + '<b>250mb Upper-Level Winds</b>  Wind speeds and jet streak analysis at the primary jet stream altitude.' +
        S('HOW TO READ') + 'Identify jet streak cores (wind maxima >80 knots embedded in the broader flow). The <span class="k">four-quadrant model</span> divides each jet streak into entrance/exit, left/right regions. Upper-level divergence in the right entrance and left exit quadrants forces compensating ascent below, creating favorable conditions for surface low deepening and severe weather. Multiple jet streaks interacting (coupling) can produce explosive cyclogenesis.',
      'low_thick': S('PRODUCT') + '<b>1000-850mb Thickness</b>  Temperature of the lowest ~5,000 ft of the atmosphere, the layer that determines what precipitation type reaches the ground.' +
        S('HOW TO READ') + 'Values below 1280m strongly favor all-snow. 1280-1300m is the critical transition zone  freezing rain and sleet are most likely here. Above 1300m, precipitation falls as rain at the surface. These thresholds vary by region and elevation. Cold air damming east of the Appalachians can keep low-level thickness values cold even when the free atmosphere above is warming  a setup that produces devastating ice storms.',
      'mid_thick': S('PRODUCT') + '<b>850-700mb Thickness</b>  Temperature of the mid-level layer between ~5,000-10,000 ft, the zone where snow often melts and refreezes.' +
        S('HOW TO READ') + 'When this layer is warm (>1540m thickness), a "warm nose" exists aloft that melts falling snow into rain. If the surface layer below is cold, the rain either refreezes into sleet (if the cold layer is deep enough, >~1000 ft) or remains as supercooled liquid that freezes on contact as freezing rain (if the cold layer is shallow). Freezing rain is the most dangerous winter precipitation  even a quarter inch of ice accumulation can snap trees, down power lines, and make all surfaces impassable.',
      'wnd_temp': S('PRODUCT') + '<b>10m Wind & 2m Temperature</b>  Surface temperature at 2 meters with wind speed and direction at 10 meters overlaid.' +
        S('HOW TO READ') + 'Look for sharp temperature gradients  these are frontal boundaries. Temperatures dropping 10-20F over a short distance with a wind shift from south to north/northwest marks a cold front passage. Wind chill: at 30F with 20 mph wind, exposed skin feels like 17F. At 0F with 30 mph wind, frostbite occurs on exposed skin within 10-15 minutes.',
      'gfs_850temp': S('PRODUCT') + '<b>GFS 850mb Temperature (Global)</b>  Global-scale view of temperatures at ~5,000 ft, showing the large-scale thermal pattern across continents and oceans.' +
        S('HOW TO READ') + 'Track the movement of air masses by watching isotherms advance frame to frame. Warm air advection (WAA) ahead of warm fronts brings overrunning precipitation. Cold air advection (CAA) behind cold fronts brings clearing skies. The Arctic front  the boundary between polar and arctic air masses  is visible as the tightest temperature gradient.',
      'gfs_850vort': S('PRODUCT') + '<b>GFS 850mb Vorticity</b>  Low-level atmospheric spin at ~5,000 ft, showing surface fronts, developing low pressure systems, and mesoscale vortices.' +
        S('HOW TO READ') + 'Strong 850mb vorticity centers directly correspond to surface low pressure systems and frontal wave developments. Track their movement to forecast where precipitation bands will set up. When 850mb vorticity maxima align vertically with 500mb vorticity maxima, the system is <span class="k">vertically stacked</span> and at peak intensity  it will begin to weaken as the upper-level feature outruns the surface low.',
      'gfs_500wind': S('PRODUCT') + '<b>GFS 500mb Wind</b>  Mid-level steering flow at ~18,000 ft showing the direction and speed at which surface weather systems will move.' +
        S('HOW TO READ') + 'Surface lows generally move at about 50-75% of the 500mb wind speed and in roughly the same direction. A slow-moving 500mb pattern (weak flow, cutoff lows) means weather systems stall and produce extended precipitation events. Fast 500mb flow means systems progress quickly  the storm may be intense but brief.',
      'gfs_500rh': S('PRODUCT') + '<b>GFS 500mb Relative Humidity</b>  Mid-tropospheric moisture content showing the large-scale cloud and precipitation pattern.' +
        S('HOW TO READ') + 'The dry slot wrapping around an extratropical cyclone marks the boundary of the <span class="k">dry conveyor belt</span>  descending air from the upper troposphere. This feature is a clear signal of storm maturity. The <span class="k">comma-head cloud</span> (high RH region wrapping north and west of the low) is where the heaviest precipitation occurs in a mature cyclone. Low RH (dry air) aloft over a moist surface layer increases convective instability.',
      'gfs_fourpanel': S('PRODUCT') + '<b>4-Panel Composite</b>  A multi-level diagnostic chart combining 850mb vorticity, 500mb geopotential heights, and 200mb (jet level) winds on a single display.' +
        S('HOW TO READ') + 'This is the same type of chart operational NWS forecasters use to quickly assess the three-dimensional state of the atmosphere. Look for vertical alignment (stacking) of features: when low-level vorticity, mid-level troughs, and upper-level jet divergence all overlap, that\'s where the most significant weather will develop. Tilted systems (features offset with height) are still intensifying; <span class="k">vertically stacked</span> systems are at peak strength or weakening.'
    };

    // LIVE MODE INFO - sectioned
    var liveInfo = S('WHAT YOU\'RE SEEING') +
      '<b>Live NEXRAD Doppler Radar Mosaic</b>  Real-time composite reflectivity from the NWS network of <span class="k">160 WSR-88D</span> (Weather Surveillance Radar, 1988 Doppler) stations positioned across the United States. Each station transmits pulses of microwave energy at ~3 GHz (S-band, 10cm wavelength) and measures the returned signal reflected by precipitation particles  raindrops, snowflakes, hail, and even insects or dust. The mosaic combines all station data into a single seamless image updated every 2-5 minutes.' +

      S('READING THE REFLECTIVITY SCALE') +
      'The color legend displays <b><span class="k">decibels of reflectivity (dBZ)</span></b>  a logarithmic measure of the energy returned to the radar. Each step up in color represents significantly more intense precipitation:' +
      '<br><span style="color:#00e600"></span> <span style="color:#00e600"><b>Green (20-35 dBZ)</b></span>  Light to moderate rain (~0.01-0.15 in/hr) or moderate snow. Widespread stratiform precipitation from frontal systems typically appears as broad areas of green.' +
      '<br><span style="color:#e6e600"></span> <span style="color:#e6e600"><b>Yellow (35-45 dBZ)</b></span>  Moderate to heavy rain (~0.15-0.50 in/hr). Embedded convective cells within a larger rain shield, or the core of well-organized rain bands.' +
      '<br><span style="color:#e69000"></span> <span style="color:#e69000"><b>Orange (45-50 dBZ)</b></span>  Heavy rain (~0.5-1.0 in/hr) with small hail possible. Urban flooding becomes a concern at these rates.' +
      '<br><span style="color:#e62000"></span> <span style="color:#e62000"><b>Red (50-60 dBZ)</b></span>  Very heavy rain (>1 in/hr), hail likely. Severe thunderstorm criteria often met. Flash flooding risk is high.' +
      '<br><span style="color:#e600e6"></span> <span style="color:#e600e6"><b>Magenta/Pink (60-70 dBZ)</b></span>  Extreme precipitation. Large hail (1 inch), damaging winds, and tornado-producing supercells. These returns almost always warrant a severe thunderstorm or tornado warning.' +
      '<br><span style="color:#c8a0ff"></span> <span style="color:#c8a0ff"><b>White/Purple (70+ dBZ)</b></span>  Giant hail (2 inches), extremely rare and violent. Possible debris signature if a tornado is lofting objects.' +

      S('WHAT TO LOOK FOR') +
      '<b>Storm Motion:</b> Animate the frames using the playback controls. Storms generally move from west to east in the mid-latitudes, but individual cells can deviate  supercells often move to the right of the mean wind. A storm moving toward you will appear to grow larger frame-to-frame.' +
      '<br><br><b>Storm Structure:</b> A <span class="k">hook-shaped echo</span> appendage on the southwest side of a storm is a <span class="k">classic tornado signature</span>. A <span class="k">V-notch</span> or enhanced reflectivity on the downwind side indicates an intense updraft deflecting the upper-level flow. A <span class="k">Bounded Weak Echo Region (BWER)</span>  a notch of low reflectivity within high returns  shows where the updraft is so strong it suspends all precipitation.' +
      '<br><br><b>Bowing Segments:</b> A line of storms that develops a <span class="k">bow shape (concave forward)</span> indicates damaging straight-line winds, often <span class="k">60-80+ mph</span>. The apex of the bow is where the strongest winds occur. <span class="k">Book-end vortices</span>  small rotation features at the ends of the bow  can produce brief tornadoes.' +
      '<br><br><b><span class="k">Training Echoes</span>:</b> When multiple cells repeatedly move over the same area (like train cars on a track), extreme rainfall totals and <span class="k">flash flooding</span> result. This "<span class="k">training</span>" pattern is one of the most dangerous rainfall setups.' +
      '<br><br><b><span class="k">Bright Band</span>:</b> A thin ring of enhanced reflectivity at the melting level where snowflakes are melting into raindrops. This is a normal feature in stratiform precipitation and does not indicate severe weather.' +

      S('LIMITATIONS') +
      'Radar has blind spots between stations and below the beam at long range (the beam overshoots low-level precipitation beyond ~120 miles due to Earth\'s curvature). Mountain terrain blocks the beam in parts of the West. Ground clutter and anomalous propagation ("AP") can produce false echoes, especially at night when temperature inversions are common.' +

      S('SOURCE') +
      '<a href="https://www.weather.gov/radar" target="_blank" rel="noopener">NOAA</a> <a href="https://www.weather.gov/about" target="_blank" rel="noopener">National Weather Service</a>, <a href="https://www.roc.noaa.gov/WSR88D/" target="_blank" rel="noopener">NEXRAD</a> Level III composite reflectivity mosaics via <a href="https://radar.weather.gov/ridge/standard/NORTHEAST_loop.gif" target="_blank" rel="noopener">radar.weather.gov RIDGE</a>. Processed by the <a href="https://www.nssl.noaa.gov/projects/mrms/" target="_blank" rel="noopener">Multi-Radar Multi-Sensor (MRMS)</a> and Ridge Radar systems. Radar stations operated and maintained by the <a href="https://www.weather.gov/radar" target="_blank" rel="noopener">NWS</a>, <a href="https://www.faa.gov/air_traffic/weather" data-fallback="https://www.faa.gov" title="FAA Weather Services  Fallback: faa.gov" target="_blank" rel="noopener">FAA</a>, and <a href="https://www.weather.mil" data-fallback="https://www.defense.gov" title="DoD Weather  Fallback: defense.gov" target="_blank" rel="noopener">Department of Defense</a>.';

    var parts = [];

    // Build title line
    var areaFullNames = {'conus':'CONTINENTAL US','namer':'NORTH AMERICA','us-ne':'NORTHEAST','us-se':'SOUTHEAST','us-nc':'GREAT LAKES','us-sc':'SOUTH CENTRAL','us-nw':'PACIFIC NORTHWEST','us-sw':'PACIFIC SOUTHWEST','alaska':'ALASKA','hawaii':'HAWAII','pr':'PUERTO RICO','guam':'GUAM','upper-ms':'UPPER MISSISSIPPI VALLEY','south-ms':'SOUTH MISSISSIPPI VALLEY','n-rockies':'NORTHERN ROCKIES','s-rockies':'SOUTHERN ROCKIES','s-plains':'SOUTHERN PLAINS','north-pac':'NORTH PACIFIC','east-pac':'EAST PACIFIC','west-atl':'WEST ATLANTIC','atlantic':'ATLANTIC','arctic':'ARCTIC','europe':'EUROPE','asia':'ASIA','africa':'AFRICA'};
    var rangeFullNames = {'live':'LIVE','tomorrow':'24 HOUR FORECAST','48h':'48 HOUR FORECAST','72h':'72 HOUR FORECAST','7d':'7 DAY FORECAST','16d':'16 DAY FORECAST'};
    var modelFullNames = {'gfs':'GFS','nam':'NAM','nam_hires':'NAM 3KM','hrrr':'HRRR','href':'HREF ENSEMBLE','nbm':'NATIONAL BLEND','gefs':'GEFS ENSEMBLE'};
    var productFullNames = {'sim_radar':'SIMULATED RADAR','precip_type':'PRECIPITATION TYPE','snow_accum':'SNOW ACCUMULATION','precip_total':'PRECIPITATION TOTALS','wind':'WIND & PRESSURE','cape':'CAPE & INSTABILITY','temperature':'THICKNESS & PRECIP TYPE','jet_stream':'JET STREAM','humidity':'RELATIVE HUMIDITY','500mb':'500MB VORTICITY','10mb':'STRATOSPHERIC ANALYSIS','max_ref':'MAX REFLECTIVITY','radar_1km':'1KM REFLECTIVITY','precip_1hr':'HOURLY PRECIPITATION','best_cape':'MOST UNSTABLE CAPE','helicity':'STORM-RELATIVE HELICITY','updraft':'UPDRAFT HELICITY','echo_top':'ECHO TOPS','lightning':'LIGHTNING THREAT','max_wind':'MAX WIND GUST','visibility':'VISIBILITY','ceiling':'CLOUD CEILING','850temp':'850MB TEMPERATURE','500vort':'500MB VORTICITY','250wind':'250MB UPPER WINDS','precip_6hr':'6-HOUR PRECIPITATION','precip_24hr':'24-HOUR PRECIPITATION','low_thick':'LOW-LEVEL THICKNESS','mid_thick':'MID-LEVEL THICKNESS','wnd_temp':'WIND & TEMPERATURE','gfs_850temp':'GFS 850MB TEMPERATURE','gfs_850vort':'GFS 850MB VORTICITY','gfs_500wind':'GFS 500MB WIND','gfs_500rh':'GFS 500MB HUMIDITY','gfs_fourpanel':'4-PANEL COMPOSITE'};

    var areaName = areaFullNames[fcastState.area] || 'CONTINENTAL US';
    var title = '';
    if (fcastState.range === 'live') {
      title = 'LIVE RADAR  ' + areaName;
    } else {
      var rangeName = rangeFullNames[fcastState.range] || 'FORECAST';
      var modelName = modelFullNames[fcastState.model] || 'GFS';
      var productName = productFullNames[fcastState.product] || 'SIMULATED RADAR';
      title = modelName + ' ' + rangeName + '  ' + areaName + '  ' + productName;
    }
    // Set title in header bar
    var titleBar = document.getElementById('fcast-info-title-bar');
    if (titleBar) titleBar.textContent = title;

    if (fcastState.range === 'live') {
      parts.push(liveInfo);
    } else {
      var mi = modelInfo[fcastState.model];
      if (mi) parts.push(mi);
      var pi = productInfo[fcastState.product];
      if (pi) parts.push(pi);

      // Forecast tips
      parts.push(S('ANALYSIS TIPS') +
        '<b><span class="k">Compare Models:</span></b> Switch between GFS, NAM, and HRRR using the model buttons. If all three agree on timing and placement, confidence is high. If they disagree, pay attention to which model has been verifying best in recent days for your area  the HRRR often wins within 18 hours, GFS beyond day 3.' +
        '<br><br><b><span class="k">Step Through Time:</span></b> Use the arrow controls to advance frame-by-frame. Watch how features evolve  a front accelerating faster in later model runs suggests the model is correcting toward a faster solution. Slowing features suggest the system may stall.' +
        '<br><br><b><span class="k">Model Run Timing:</span></b> The most recent model run is shown. GFS/NAM update every 6 hours (00Z, 06Z, 12Z, 18Z = 7pm, 1am, 7am, 1pm ET). HRRR updates every hour. Data becomes available ~3-4 hours after initialization time due to computation. The 00Z and 12Z runs are most reliable  they assimilate the most rawinsonde (weather balloon) observations.');

      parts.push(S('DATA SOURCE') +
        '<a href="https://www.noaa.gov/information-technology/open-data-dissemination" data-fallback="https://www.noaa.gov" title="NOAA Open Data  Fallback: noaa.gov" target="_blank" rel="noopener">NOAA</a>/<a href="https://www.weather.gov/about" target="_blank" rel="noopener">NWS</a> <a href="https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems.php" data-fallback="https://www.ncep.noaa.gov" title="NCEP Operational Models  Fallback: ncep.noaa.gov" target="_blank" rel="noopener">National Centers for Environmental Prediction (NCEP)</a>. Imagery from the <a href="https://mag.ncep.noaa.gov/model-guidance-model-parameter.php" data-fallback="https://mag.ncep.noaa.gov" title="MAG Model Guidance  Fallback: mag.ncep.noaa.gov" target="_blank" rel="noopener">Model Analysis and Guidance (MAG)</a> system. Model runs are initialized using the <a href="https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/gfs/implementation.php" target="_blank" rel="noopener">Global Data Assimilation System (GDAS)</a>, which ingests observations from ~3,500 radiosondes (weather balloons launched twice daily worldwide), commercial aircraft (<a href="https://amdar.noaa.gov" target="_blank" rel="noopener">AMDAR/ACARS</a>), geostationary satellites (<a href="https://www.star.nesdis.noaa.gov/goes/fulldisk_band.php?sat=G16&band=GEOCOLOR&length=12" data-fallback="https://www.star.nesdis.noaa.gov/goes/index.php" title="GOES-16 Fulldisk GEOCOLOR  Fallback: star.nesdis.noaa.gov/goes" target="_blank" rel="noopener">GOES-16 East, GOES-18 West</a>), polar-orbiting satellites (<a href="https://www.jpss.noaa.gov/science_documents.html" data-fallback="https://www.jpss.noaa.gov" title="JPSS Science Data  Fallback: jpss.noaa.gov" target="_blank" rel="noopener">NOAA-20, JPSS-1 Suomi NPP</a>), surface <a href="https://www.aviationweather.gov/metar" target="_blank" rel="noopener">METAR</a>/SYNOP stations, <a href="https://www.ndbc.noaa.gov/obs.shtml" data-fallback="https://www.ndbc.noaa.gov" title="NDBC Observations  Fallback: ndbc.noaa.gov" target="_blank" rel="noopener">ocean buoys</a>, and Doppler radar velocity data.');
    }

    // Always-visible quick reference
    parts.push(S('QUICK REFERENCE') +
      '<b> Low Pressure (L)</b>  Counterclockwise rotation (Northern Hemisphere). Air converges inward and rises, producing clouds, precipitation, and storminess. The stronger the low, the tighter the circulation and the more intense the weather.' +
      '<br><b> High Pressure (H)</b>  Clockwise rotation (Northern Hemisphere). Air diverges outward and sinks, suppressing clouds and producing fair, stable weather. Winds flow outward from the center.' +
      '<br><span style="font-size:.5rem;color:rgba(43,34,244,.4);display:inline-block;">Southern Hemisphere: rotation is reversed  Lows spin clockwise, Highs spin counterclockwise (Coriolis effect).</span>' +
      '<br><br><b>Wind Barbs</b>  Point in the direction wind is coming FROM. Half line = <span class="k">5 knots</span>, full line = <span class="k">10 knots</span>, pennant/flag = <span class="k">50 knots</span>. Add them up: two full lines + one half = 25 knots.' +
      '<br><br><b>Fronts</b>  <span style="color:#f00"><b>Cold front</b></span> (blue triangles pointing direction of movement): sharp temp drop, wind shift, heavy showers. <span style="color:#f00"><b>Warm front</b></span> (red semicircles): gradual warming, steady rain/drizzle ahead of it. <span style="color:#a0a"><b>Occluded front</b></span> (alternating): cold front overtakes warm front, complex precipitation. <span style="color:#f80"><b>Stationary front</b></span>: stalled boundary, prolonged precipitation along it.' +
      '<br><br><b>Pressure Units</b>  <span class="k">1013.25 mb</span> (millibars) = standard sea level pressure. Below 1000 mb = strong low. Below 980 mb = intense storm. Below 950 mb = extreme (major hurricane-force). Pressure drops of <span class="k">>24 mb in 24 hours</span> = bombogenesis (bomb cyclone).' +
      '<br><br><b>Atmospheric Layers</b>  <span class="k">Surface/2m</span>: what you feel outside. <span class="k">850mb (~5,000 ft)</span>: above boundary layer, rain/snow line. <span class="k">700mb (~10,000 ft)</span>: mid-level moisture, dry slots. <span class="k">500mb (~18,000 ft)</span>: steering level, troughs & ridges. <span class="k">250mb (~34,000 ft)</span>: jet stream. <span class="k">10mb (~100,000 ft)</span>: stratosphere, polar vortex.' +
      '<br><br><b>Precipitation Rates</b>  Light rain: <span class="k"><0.1 in/hr</span>. Moderate: <span class="k">0.1-0.3 in/hr</span>. Heavy: <span class="k">0.3-1.0 in/hr</span>. Intense/flooding: <span class="k">>1.0 in/hr</span>. Snow equivalent: multiply liquid by snow ratio (typically 10:1 to 15:1).' +
      '<br><br><b>Severe Weather Thresholds</b>  Severe thunderstorm: winds <span class="k">58 mph</span> or hail <span class="k">1 inch</span>. Tornado: rotating wall cloud, hook echo on radar. Flash flood: rainfall exceeding local <span class="k">Flash Flood Guidance (FFG)</span>. Blizzard: sustained winds <span class="k">35 mph</span> with falling/blowing snow reducing visibility below <span class="k"> mile</span> for 3+ hours.' +
      '<br><br><b>UTC Time Conversion</b>  Radar and model timestamps use UTC (Zulu). <span class="k">EST = UTC  5</span>. <span class="k">CST = UTC  6</span>. <span class="k">MST = UTC  7</span>. <span class="k">PST = UTC  8</span>. Add 1 hour during Daylight Saving Time. Example: 18Z = 1:00 PM EST / 12:00 PM CST.' +
      '<br><br><b>C  F Conversion</b>  Formula: <span class="k">F = (C  9/5) + 32</span>. Quick trick: double the C and add 30 (close enough for a fast estimate). Common benchmarks: <span class="k">-40 = -40</span> (scales meet)  <span class="k">-20C = -4F</span>  <span class="k">-10C = 14F</span>  <span class="k">0C = 32F</span> (freezing)  <span class="k">10C = 50F</span>  <span class="k">20C = 68F</span>  <span class="k">30C = 86F</span>  <span class="k">37C = 98.6F</span> (body)  <span class="k">100C = 212F</span> (boiling).');

    el.innerHTML = parts.join('');
  }

  function switchFcastRange(range){
    lastGoodSrc = "";
    if (fcastState.playing) fcastRadarTogglePlay();
    fcastState.range = range;
    fcastState.idx = 0;
    
    // Style range buttons
    var ranges = ['live','tomorrow','48h','72h','7d','16d'];
    ranges.forEach(function(r){
      var btn = document.getElementById('fcast-range-' + r);
      if (!btn) return;
      if (r === range){
        if (r === 'live'){
          btn.style.background = 'rgba(220,38,38,.85)';
          btn.style.borderColor = 'transparent';
          btn.style.color = '#fff';
          btn.style.boxShadow = '0 0 16px rgba(220,38,38,.3)';
        } else {
          btn.style.background = 'rgba(255,140,0,.15)';
          btn.style.borderColor = 'transparent';
          btn.style.color = 'rgba(255,140,0,.95)';
          btn.style.boxShadow = '0 0 12px rgba(255,140,0,.15)';
        }
      } else {
        if (r === 'live'){
          btn.style.background = 'rgba(200,200,210,.25)';
          btn.style.borderColor = 'transparent';
          btn.style.color = 'rgba(220,38,38,.4)';
          btn.style.boxShadow = 'none';
        } else {
          btn.style.background = 'rgba(200,200,210,.25)';
          btn.style.borderColor = 'transparent';
          btn.style.color = 'rgba(43,34,244,.65)';
          btn.style.boxShadow = 'none';
        }
      }
    });
    
    // Image filter
    var img = document.getElementById('fcast-radar-img');
    if (img){
      if (range === 'live'){
        img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.1) saturate(1.4) brightness(0.95)';
      } else {
        img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.2) saturate(1.5)';
      }
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.top = '50%';
      img.style.left = '50%';
      img.style.objectFit = 'contain';
      img.style.objectPosition = 'center center';
    }
    
    // Hide/show model buttons and product panel based on LIVE vs forecast
    var isLive = (range === 'live');
    // Model buttons - always visible
    ['gfs','nam','nam_hires','hrrr','href','nbm','gefs'].forEach(function(m){
      var btn = document.getElementById('fcast-model-' + m);
      if (btn) btn.style.display = '';
    });
    // MODELS sub-label - always visible
    var modelsLabel = document.getElementById('fcast-models-label');
    if (modelsLabel) modelsLabel.style.display = '';
    // FORECAST label
    var fcLabel = document.getElementById('fcast-forecast-label');
    if (fcLabel) fcLabel.style.display = '';
    // Forecast range buttons - always visible so user can switch back
    var rangeArea = document.getElementById('fcast-range-area');
    if (rangeArea) rangeArea.style.display = 'flex';
    // Right-side product panel
    var rightPanel = document.getElementById('fcast-right-panel');
    if (rightPanel) {
      if (isLive) {
        rightPanel.style.opacity = '.25';
        rightPanel.style.pointerEvents = 'none';
      } else {
        rightPanel.style.opacity = '1';
        rightPanel.style.pointerEvents = 'auto';
      }
    }
    // Adjust image container for panel visibility
    var imgContainer = document.getElementById('fcast-img-container');
    if (imgContainer) {
      imgContainer.style.left = '140px';
      imgContainer.style.right = '130px';
    }
    var playBar = document.getElementById('fcast-playback-bar');
    if (playBar) {
      playBar.style.left = '140px';
      playBar.style.right = '130px';
    }
    // Source link
    var srcLink = document.getElementById('fcast-source-link');
    if (srcLink) {
      if (isLive) {
        srcLink.style.display = '';
        srcLink.href = 'https://radar.weather.gov/ridge/standard/NORTHEAST_loop.gif';
        srcLink.textContent = 'NWS RADAR';
      } else {
        srcLink.style.display = '';
      }
    }
    
    // Area buttons: show Ridge regions for LIVE, model regions for forecast
    if (isLive) {
      var liveAreas = ['conus','us-ne','us-se','us-nw','us-sw','upper-ms','south-ms','n-rockies','s-rockies','s-plains','us-nc','alaska','hawaii','pr','guam'];
      allAreaIds.forEach(function(a){
        var btn = document.getElementById('fcast-area-' + a);
        if (btn) {
          btn.style.display = liveAreas.indexOf(a) !== -1 ? '' : 'none';
          if (a === fcastState.area){
            btn.style.background = 'rgba(255,140,0,.15)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(255,140,0,.95)'; btn.style.boxShadow = '0 0 12px rgba(255,140,0,.15)';
          } else {
            btn.style.background = 'rgba(200,200,210,.25)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(43,34,244,.65)'; btn.style.boxShadow = 'none';
          }
        }
      });
      // If current area isn't in live areas, default to conus
      if (liveAreas.indexOf(fcastState.area) === -1) {
        fcastState.area = 'conus';
        var cb = document.getElementById('fcast-area-conus');
        if (cb) { cb.style.background = 'rgba(255,140,0,.15)'; cb.style.borderColor = 'transparent'; cb.style.color = 'rgba(255,140,0,.95)'; cb.style.boxShadow = '0 0 12px rgba(255,140,0,.15)'; }
      }
      updateAreaSubLabels(liveAreas);
    } else {
      // Fallback area if current area isn't valid for current model
      var cfg = modelAreaConfig[fcastState.model] || {areas:['conus'], default:'conus'};
      if (cfg.areas.indexOf(fcastState.area) === -1) {
        fcastState.area = cfg.default;
      }
      updateAreaButtons(fcastState.model);
    }
    
    updateFcastBadge();
    loadFcastRadar();
    fcastRadarTogglePlay();
  }

  function switchFcastProduct(prod){
    lastGoodSrc = "";
    if (fcastState.playing) fcastRadarTogglePlay();
    fcastState.product = prod;
    fcastState.idx = 0;
    
    // If in LIVE mode and user clicks a product, switch to default forecast range
    if (fcastState.range === 'live'){
      var modelMaxH = {'gfs':384,'gefs':384,'nam':84,'nam_hires':60,'hrrr':48,'href':48,'nbm':192};
      var maxH = modelMaxH[fcastState.model] || 384;
      fcastState.range = maxH >= 384 ? '16d' : (maxH >= 168 ? '7d' : (maxH >= 72 ? '72h' : '48h'));
      // Re-style range buttons
      switchFcastRange(fcastState.range);
      return;
    }
    var allBtns = ['fcast-tab-sim','fcast-tab-ptype','fcast-tab-snow','fcast-tab-ptot','fcast-tab-wind','fcast-tab-cape','fcast-tab-temp','fcast-tab-jet','fcast-tab-rh','fcast-tab-500mb','fcast-tab-10mb','fcast-tab-maxref','fcast-tab-radar1km','fcast-tab-precip1hr','fcast-tab-bestcape','fcast-tab-helicity','fcast-tab-updraft','fcast-tab-echotop','fcast-tab-lightning','fcast-tab-maxwind','fcast-tab-vis','fcast-tab-ceiling','fcast-tab-850temp','fcast-tab-500vort','fcast-tab-250wind','fcast-tab-precip6hr','fcast-tab-precip24hr','fcast-tab-lowthick','fcast-tab-midthick','fcast-tab-wndtemp','fcast-tab-gfs850temp','fcast-tab-gfs850vort','fcast-tab-gfs500wind','fcast-tab-gfs500rh','fcast-tab-gfs4panel'];
    var activeMap = {'sim_radar':'fcast-tab-sim','precip_type':'fcast-tab-ptype','snow_accum':'fcast-tab-snow','precip_total':'fcast-tab-ptot','wind':'fcast-tab-wind','cape':'fcast-tab-cape','temperature':'fcast-tab-temp','jet_stream':'fcast-tab-jet','humidity':'fcast-tab-rh','500mb':'fcast-tab-500mb','10mb':'fcast-tab-10mb','max_ref':'fcast-tab-maxref','radar_1km':'fcast-tab-radar1km','precip_1hr':'fcast-tab-precip1hr','best_cape':'fcast-tab-bestcape','helicity':'fcast-tab-helicity','updraft':'fcast-tab-updraft','echo_top':'fcast-tab-echotop','lightning':'fcast-tab-lightning','max_wind':'fcast-tab-maxwind','visibility':'fcast-tab-vis','ceiling':'fcast-tab-ceiling','850temp':'fcast-tab-850temp','500vort':'fcast-tab-500vort','250wind':'fcast-tab-250wind','precip_6hr':'fcast-tab-precip6hr','precip_24hr':'fcast-tab-precip24hr','low_thick':'fcast-tab-lowthick','mid_thick':'fcast-tab-midthick','wnd_temp':'fcast-tab-wndtemp','gfs_850temp':'fcast-tab-gfs850temp','gfs_850vort':'fcast-tab-gfs850vort','gfs_500wind':'fcast-tab-gfs500wind','gfs_500rh':'fcast-tab-gfs500rh','gfs_fourpanel':'fcast-tab-gfs4panel'};
    allBtns.forEach(function(id){
      var btn = document.getElementById(id);
      if (!btn) return;
      var icon = btn.querySelector('.radar-info-icon');
      if (id === activeMap[prod]){
        btn.style.background = 'rgba(255,140,0,.15)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(255,140,0,.95)'; btn.style.boxShadow = '0 0 12px rgba(255,140,0,.15)';
        if (icon){ icon.style.color = 'rgba(255,140,0,.7)'; icon.style.borderColor = 'rgba(255,140,0,.3)'; }
      } else {
        btn.style.background = 'rgba(200,200,210,.25)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(43,34,244,.65)'; btn.style.boxShadow = 'none';
        if (icon){ icon.style.color = ''; icon.style.borderColor = ''; }
      }
    });
    // Adjust image sizing for different products
    var img = document.getElementById('fcast-radar-img');
    if (img){
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.top = '50%';
      img.style.left = '50%';
      img.style.objectFit = 'contain';
      img.style.objectPosition = 'center center';
      img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.2) saturate(1.5)';
    }
    updateFcastBadge();
    // If in LIVE mode, just reload live radar and skip forecast play
    if (fcastState.range === 'live'){
      loadFcastRadar();
      if (!fcastState.playing) fcastRadarTogglePlay();
      return;
    }
    loadFcastRadar();
    fcastRadarTogglePlay();
  }

  function initFcastWidgets(){
    fcastState.cycle = getGfsCycle();
    fcastState.idx = 0;
    
    // Map user's radarRegion to LIVE area ID
    var regionToArea = {
      'NORTHEAST':'us-ne', 'SOUTHEAST':'us-se', 'CENTGRLAKES':'us-nc',
      'PACNORTHWEST':'us-nw', 'PACSOUTHWEST':'us-sw',
      'UPPERMISSVLY':'upper-ms', 'SOUTHMISSVLY':'south-ms',
      'NORTHROCKIES':'n-rockies', 'SOUTHROCKIES':'s-rockies', 'SOUTHPLAINS':'s-plains',
      'ALASKA':'alaska', 'HAWAII':'hawaii', 'CARIB':'pr', 'GUAM':'guam'
    };
    var localArea = regionToArea[LOCATION.radarRegion] || 'conus';
    
    // Set state to LIVE + local area before any UI calls
    fcastState.range = 'live';
    fcastState.area = localArea;
    
    // Now trigger UI updates
    switchFcastRange('live');
    
    // Highlight correct area button after range switch has shown LIVE areas
    allAreaIds.forEach(function(a){
      var btn = document.getElementById('fcast-area-' + a);
      if (!btn) return;
      if (a === localArea){
        btn.style.background = 'rgba(255,140,0,.15)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(255,140,0,.95)'; btn.style.boxShadow = '0 0 12px rgba(255,140,0,.15)';
      } else {
        btn.style.background = 'rgba(200,200,210,.25)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(43,34,244,.65)'; btn.style.boxShadow = 'none';
      }
    });
    
    updateFcastBadge();
    
    // Scroll fade for left and right panels
    ['fcast-left-panel','fcast-right-panel'].forEach(function(id){
      var panel = document.getElementById(id);
      if (!panel) return;
      panel.addEventListener('scroll', function(){
        var atBottom = panel.scrollHeight - panel.scrollTop - panel.clientHeight < 8;
        if (atBottom) {
          panel.style.webkitMaskImage = 'none';
          panel.style.maskImage = 'none';
        } else {
          panel.style.webkitMaskImage = 'linear-gradient(to bottom, black 0%, black 80%, transparent 100%)';
          panel.style.maskImage = 'linear-gradient(to bottom, black 0%, black 80%, transparent 100%)';
        }
      });
    });
  }

  // Define which product groups each model type supports
  var hiresModels = ['hrrr','nam_hires','href'];
  var gfsLikeModels = ['gfs','nam','nbm','gefs'];

  function switchFcastModel(model){
    lastGoodSrc = "";
    if (fcastState.playing) fcastRadarTogglePlay();
    fcastState.model = model;
    fcastState.idx = 0;
    fcastState.cycle = getCycleForModel(model);

    // Set default area for this model
    var cfg = modelAreaConfig[model] || {areas:['conus'], default:'conus'};
    if (cfg.areas.indexOf(fcastState.area) === -1) {
      fcastState.area = cfg.default;
    }

    // Product fallback: if current product isn't available on new model
    var hrOnlyProducts = ['max_ref','radar_1km','precip_1hr','best_cape','helicity','updraft','echo_top','lightning','max_wind','visibility','ceiling','850temp','500vort','250wind'];
    var gfsExclusive = ['500mb','10mb','gfs_fourpanel']; // Only GFS has these
    var gfsOnlyProducts = gfsExclusive.concat(['precip_6hr','precip_24hr','low_thick','mid_thick','wnd_temp','gfs_850temp','gfs_850vort','gfs_500wind','gfs_500rh','jet_stream']);

    if (hiresModels.indexOf(model) !== -1) {
      if (gfsOnlyProducts.indexOf(fcastState.product) !== -1) fcastState.product = 'sim_radar';
    } else if (model === 'nbm') {
      // NBM has limited products
      var nbmValid = ['sim_radar','precip_type','precip_total','snow_accum','temperature','wind','humidity','cape'];
      if (nbmValid.indexOf(fcastState.product) === -1) fcastState.product = 'precip_total';
    } else if (model === 'gefs') {
      var gefsValid = ['sim_radar','precip_total','precip_type','snow_accum','temperature','wind','humidity','cape','precip_6hr','precip_24hr','jet_stream','gfs_850temp','gfs_500wind','gfs_500rh'];
      if (gefsValid.indexOf(fcastState.product) === -1) fcastState.product = 'precip_total';
    } else if (model === 'nam') {
      // NAM has most GFS products except 500mb/10mb/fourpanel
      if (hrOnlyProducts.indexOf(fcastState.product) !== -1 || gfsExclusive.indexOf(fcastState.product) !== -1) fcastState.product = 'sim_radar';
    } else {
      // GFS  fall back from hires-only
      if (hrOnlyProducts.indexOf(fcastState.product) !== -1) fcastState.product = 'sim_radar';
    }

    // Range buttons: only show for GFS and GEFS (long-range models)
    var rangeArea = document.getElementById('fcast-range-area');
    if (rangeArea) {
      rangeArea.style.display = 'flex';
      // Show range buttons appropriate for model's max forecast hours
      var modelMaxH = {'gfs':384,'gefs':384,'nam':84,'nam_hires':60,'hrrr':48,'href':48,'nbm':192};
      var maxH = modelMaxH[model] || 384;
      var rangeHours = {'tomorrow':48,'48h':48,'72h':72,'7d':168,'16d':384};
      ['tomorrow','48h','72h','7d','16d'].forEach(function(r){
        var btn = document.getElementById('fcast-range-' + r);
        if (!btn) return;
        var avail = rangeHours[r] <= maxH;
        btn.style.display = '';
        btn.style.opacity = avail ? '1' : '.25';
        btn.style.pointerEvents = avail ? 'auto' : 'none';
      });
      // If current range exceeds model's max, fall back to highest valid range
      if (fcastState.range !== 'live') {
        var currentRangeH = rangeHours[fcastState.range] || 9999;
        if (currentRangeH > maxH) {
          var validRanges = ['7d','72h','48h','tomorrow'];
          for (var ri = 0; ri < validRanges.length; ri++) {
            if (rangeHours[validRanges[ri]] <= maxH) { fcastState.range = validRanges[ri]; break; }
          }
        }
      }
    }

    // Show/hide hires-only product tabs  grey out unavailable, reorder to bottom
    var hrBtns = ['fcast-tab-maxref','fcast-tab-radar1km','fcast-tab-precip1hr','fcast-tab-bestcape','fcast-tab-helicity','fcast-tab-updraft','fcast-tab-echotop','fcast-tab-lightning','fcast-tab-maxwind','fcast-tab-vis','fcast-tab-ceiling','fcast-tab-850temp','fcast-tab-500vort','fcast-tab-250wind'];
    var isHires = hiresModels.indexOf(model) !== -1;
    
    function setTabAvailable(id, available) {
      var btn = document.getElementById(id);
      if (!btn) return;
      btn.style.display = btn.querySelector('.radar-info-icon') ? 'inline-flex' : '';
      if (available) {
        btn.style.opacity = '1';
        btn.style.pointerEvents = 'auto';
        btn.style.order = '0';
      } else {
        btn.style.opacity = '.25';
        btn.style.pointerEvents = 'none';
        btn.style.order = '100';
      }
    }
    function setLabelAvailable(id, available) {
      var el = document.getElementById(id);
      if (!el) return;
      el.style.display = '';
      if (available) {
        el.style.opacity = '1';
        el.style.order = '0';
      } else {
        el.style.opacity = '.25';
        el.style.order = '100';
      }
    }
    
    hrBtns.forEach(function(id){ setTabAvailable(id, isHires); });
    var hrrrDiv = document.getElementById('fcast-hrrr-divider');
    if (hrrrDiv) { hrrrDiv.style.display = ''; hrrrDiv.style.order = isHires ? '0' : '100'; hrrrDiv.style.opacity = isHires ? '1' : '.25'; }
    setLabelAvailable('fcast-severe-label', isHires);
    setLabelAvailable('fcast-aviation-label', isHires);

    // Show/hide GFS-like product tabs based on specific model capabilities
    var gfsBtns = ['fcast-tab-jet','fcast-tab-500mb','fcast-tab-10mb','fcast-tab-precip6hr','fcast-tab-precip24hr','fcast-tab-lowthick','fcast-tab-midthick','fcast-tab-wndtemp','fcast-tab-gfs850temp','fcast-tab-gfs850vort','fcast-tab-gfs500wind','fcast-tab-gfs500rh','fcast-tab-gfs4panel'];
    
    var unavailGfs = [];
    if (model === 'gfs') {
      unavailGfs = [];
    } else if (model === 'nam') {
      unavailGfs = ['fcast-tab-500mb','fcast-tab-10mb','fcast-tab-gfs4panel'];
    } else if (model === 'gefs') {
      unavailGfs = ['fcast-tab-500mb','fcast-tab-10mb','fcast-tab-lowthick','fcast-tab-midthick','fcast-tab-wndtemp','fcast-tab-gfs850vort','fcast-tab-gfs4panel'];
    } else if (model === 'nbm') {
      unavailGfs = gfsBtns.slice(); // all unavailable
    } else {
      // Hires models  all GFS products unavailable
      unavailGfs = gfsBtns.slice();
    }
    gfsBtns.forEach(function(id){
      setTabAvailable(id, unavailGfs.indexOf(id) === -1);
    });

    // Update CAPE button label
    var capeBtn = document.getElementById('fcast-tab-cape');
    if (capeBtn) capeBtn.textContent = isHires ? 'CAPE' : 'Precip Water';

    // Update source link
    var srcLink = document.getElementById('fcast-source-link');
    if (srcLink){
      var srcMap = {
        'gfs':       {text:'GFS NCEP',        url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=gfs&area=conus'},
        'nam':       {text:'NAM NCEP',         url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=nam&area=conus'},
        'nam_hires': {text:'NAM HIRES NCEP',   url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=nam-hires&area=US-NE'},
        'hrrr':      {text:'HRRR NCEP',        url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=HRRR&area=US-NE'},
        'href':      {text:'HREF NCEP',        url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=HREF&area=US-NE'},
        'nbm':       {text:'NBM NCEP',         url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=NBM&area=conus'},
        'gefs':      {text:'GEFS NCEP',        url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=gefs-mean-sprd&area=conus'}
      };
      var src = srcMap[model] || srcMap['gfs'];
      srcLink.textContent = src.text;
      srcLink.href = src.url;
    }

    // Update model button styles
    ['gfs','nam','nam_hires','hrrr','href','nbm','gefs'].forEach(function(m){
      var btn = document.getElementById('fcast-model-' + m);
      if (!btn) return;
      var icon = btn.querySelector('.radar-info-icon');
      if (m === model){
        btn.style.background = 'rgba(255,140,0,.15)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(255,140,0,.95)'; btn.style.boxShadow = '0 0 12px rgba(255,140,0,.15)';
        if (icon){ icon.style.color = 'rgba(255,140,0,.7)'; icon.style.borderColor = 'rgba(255,140,0,.3)'; }
      } else {
        btn.style.background = 'rgba(200,200,210,.25)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(43,34,244,.65)'; btn.style.boxShadow = 'none';
        if (icon){ icon.style.color = ''; icon.style.borderColor = ''; }
      }
    });

    // Update area buttons
    updateAreaButtons(model);
    updateFcastBadge();
    
    // If in LIVE mode, just reload the live radar (model doesn't matter for live)
    if (fcastState.range === 'live'){
      loadFcastRadar();
      if (!fcastState.playing) fcastRadarTogglePlay();
      return;
    }
    switchFcastProduct(fcastState.product);
  }

  var allAreaIds = ['conus','namer','us-ne','us-se','us-nc','us-sc','us-nw','us-sw','alaska','hawaii','pr','guam','upper-ms','south-ms','n-rockies','s-rockies','s-plains','north-pac','east-pac','west-atl','atlantic','arctic','europe','asia','africa'];

  function switchFcastArea(area){
    lastGoodSrc = "";
    if (fcastState.playing) fcastRadarTogglePlay();
    fcastState.area = area;
    fcastState.idx = 0;
    allAreaIds.forEach(function(a){
      var btn = document.getElementById('fcast-area-' + a);
      if (!btn) return;
      if (a === area){
        btn.style.background = 'rgba(255,140,0,.15)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(255,140,0,.95)'; btn.style.boxShadow = '0 0 12px rgba(255,140,0,.15)';
      } else {
        btn.style.background = 'rgba(200,200,210,.25)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(43,34,244,.65)'; btn.style.boxShadow = 'none';
      }
    });
    // Reload for area change in LIVE mode
    if (fcastState.range === 'live'){
      var img = document.getElementById('fcast-radar-img');
      if (img) img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.1) saturate(1.4) brightness(0.95)';
    }
    updateFcastBadge();
    loadFcastRadar();
    if (!fcastState.playing) fcastRadarTogglePlay();
  }

  function updateAreaButtons(model){
    var cfg = modelAreaConfig[model] || {areas:['conus'], default:'conus'};
    allAreaIds.forEach(function(a){
      var btn = document.getElementById('fcast-area-' + a);
      if (!btn) return;
      var avail = cfg.areas.indexOf(a) !== -1;
      btn.style.display = '';
      btn.style.opacity = avail ? '1' : '.25';
      btn.style.pointerEvents = avail ? 'auto' : 'none';
      if (a === fcastState.area && avail){
        btn.style.background = 'rgba(255,140,0,.15)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(255,140,0,.95)'; btn.style.boxShadow = '0 0 12px rgba(255,140,0,.15)';
      } else {
        btn.style.background = 'rgba(200,200,210,.25)'; btn.style.borderColor = 'transparent'; btn.style.color = 'rgba(43,34,244,.65)'; btn.style.boxShadow = 'none';
      }
    });
    updateAreaSubLabels(cfg.areas);
  }
  
  function updateAreaSubLabels(visibleAreas){
    var eastAreas = ['us-ne','us-se'];
    var centralAreas = ['us-nc','us-sc','upper-ms','south-ms','s-plains'];
    var westAreas = ['us-nw','us-sw','n-rockies','s-rockies'];
    var territoryAreas = ['alaska','hawaii','pr','guam'];
    var globalAreas = ['north-pac','east-pac','west-atl','atlantic','arctic','europe','asia','africa'];
    
    var hasEast = eastAreas.some(function(a){ return visibleAreas.indexOf(a) !== -1; });
    var hasCentral = centralAreas.some(function(a){ return visibleAreas.indexOf(a) !== -1; });
    var hasWest = westAreas.some(function(a){ return visibleAreas.indexOf(a) !== -1; });
    var hasTerritory = territoryAreas.some(function(a){ return visibleAreas.indexOf(a) !== -1; });
    var hasGlobal = globalAreas.some(function(a){ return visibleAreas.indexOf(a) !== -1; });
    
    var el;
    el = document.getElementById('fcast-area-sub-east'); if(el) { el.style.display = ''; el.style.opacity = hasEast ? '1' : '.25'; }
    el = document.getElementById('fcast-area-sub-central'); if(el) { el.style.display = ''; el.style.opacity = hasCentral ? '1' : '.25'; }
    el = document.getElementById('fcast-area-sub-west'); if(el) { el.style.display = ''; el.style.opacity = hasWest ? '1' : '.25'; }
    
  }

  function toggleFcastInfo(){
    var body = document.getElementById('fcast-info-body');
    var btn = document.getElementById('fcast-info-toggle');
    var header = document.getElementById('fcast-info-header');
    if (!body || !btn) return;
    if (body.style.display === 'none') {
      body.style.display = '';
      btn.textContent = 'HIDE \u25B4';
      if (header) header.style.borderBottom = 'none';
    } else {
      body.style.display = 'none';
      btn.textContent = 'SHOW \u25BE';
      if (header) header.style.borderBottom = 'none';
    }
  }

  window.toggleFcastInfo = toggleFcastInfo;
  window.fcastRadarStep = fcastRadarStep;
  window.fcastRadarTogglePlay = fcastRadarTogglePlay;
  window.switchFcastProduct = switchFcastProduct;

  // ============ SPACE INFO PANEL ============
  function toggleSpaceInfo(){
    var body = document.getElementById('space-info-body');
    var btn = document.getElementById('space-info-toggle');
    if (!body || !btn) return;
    if (body.style.display === 'none') {
      body.style.display = '';
      btn.textContent = 'HIDE \u25B4';
    } else {
      body.style.display = 'none';
      btn.textContent = 'SHOW \u25BE';
    }
  }
  window.toggleSpaceInfo = toggleSpaceInfo;

  function buildSpaceInfoPanel(){
    var el = document.getElementById('space-info-text');
    if (!el) return;
    var S = function(t){ return '<div class="info-heading">' + t + '</div>'; };

    // Aurora viewing info based on location
    var lat = LOCATION.lat;
    var gLat = geomagLat(lat);
    var minKp = minKpForLat(gLat);
    var auroraNote = '';
    if (minKp <= 3) {
      auroraNote = 'Your location at <span class="k">' + lat.toFixed(1) + 'N</span> (geomagnetic ~' + gLat.toFixed(0) + ') is <span class="k">excellent for aurora viewing</span>. Even moderate geomagnetic storms (Kp ' + minKp + '+) can produce visible aurora from your area. Watch for Kp spikes and clear skies after dark.';
    } else if (minKp <= 5) {
      auroraNote = 'Your location at <span class="k">' + lat.toFixed(1) + 'N</span> (geomagnetic ~' + gLat.toFixed(0) + ') requires a <span class="k">moderate to strong geomagnetic storm (Kp ' + minKp + '+)</span> for aurora visibility. These occur several times per year during solar maximum. When Kp reaches ' + minKp + ', look toward the <span class="k">northern horizon</span> from a dark location away from city light pollution. Aurora may appear as a faint green or reddish glow low on the horizon before becoming more vivid overhead.';
    } else if (minKp <= 7) {
      auroraNote = 'Your location at <span class="k">' + lat.toFixed(1) + 'N</span> (geomagnetic ~' + gLat.toFixed(0) + ') needs a <span class="k">strong geomagnetic storm (Kp ' + minKp + '+, G' + Math.max(1, minKp - 4) + ')</span> for aurora visibility. This happens a few times per year during solar maximum. When conditions align, drive north of any city lights and look toward the <span class="k">northern horizon</span>  aurora is often visible to cameras before the naked eye. Use a 10-15 second exposure pointed north to check.';
    } else {
      auroraNote = 'Your location at <span class="k">' + lat.toFixed(1) + 'N</span> (geomagnetic ~' + gLat.toFixed(0) + ') requires a <span class="k">severe geomagnetic storm (Kp ' + minKp + '+, G' + Math.max(1, minKp - 4) + ')</span> for any aurora visibility. These are rare but do occur during solar maximum  the May 2024 event reached Kp 9 and produced aurora visible as far south as Florida. When SWPC issues G4/G5 watches, get to the <span class="k">darkest location</span> possible with a clear northern horizon. Long-exposure phone photography (Night Mode) can capture aurora invisible to the eye.';
    }

    var auroraTerms = '<div class="widget-block">' +
      '<span class="k">Kp Index (09)</span>  The planetary geomagnetic activity index, measured by ground-based magnetometers worldwide every 3 hours. It quantifies how disturbed Earth\'s magnetic field is. Kp 01 is quiet, Kp 23 is unsettled, Kp 4 is active, and Kp 5+ means a geomagnetic storm is underway. Each whole number represents roughly a <span class="k">2 equatorward expansion</span> of the auroral oval  so Kp 5 pushes aurora about 10 further south than Kp 0. For your location, you need Kp <span class="k">' + minKp + '+</span> for the oval to reach your geomagnetic latitude.' +
      '<br><br><span class="k">G-Scale (G0G5)</span>  NOAA\'s Geomagnetic Storm scale, directly tied to Kp. G0 = no storm (Kp 04). G1 = minor storm (Kp 5). G2 = moderate (Kp 6). G3 = strong (Kp 7). G4 = severe (Kp 8). G5 = extreme (Kp 9). G1 storms happen ~900 times per solar cycle, G5 storms only ~4 times. Higher G-levels also affect power grids, satellites, and GPS accuracy.' +
      '<br><br><span class="k">Bz  Interplanetary Magnetic Field (IMF) North-South Component</span>  This is the <span class="k">single most important real-time aurora indicator</span>. The Sun\'s magnetic field carried by the solar wind has a north-south orientation (Bz). When Bz points <span class="k">south (negative)</span>, it opposes Earth\'s northward-pointing magnetic field, creating a magnetic reconnection at the dayside magnetopause that opens Earth\'s field to solar wind energy. Think of it like a zipper  southward Bz "unzips" Earth\'s magnetic shield. Bz above -5 nT = minimal coupling. Bz -5 to -10 nT = moderate. Bz below -10 nT = strong coupling and likely visible aurora. Bz below -20 nT = intense storm conditions. When Bz is positive (northward), the shield stays closed regardless of wind speed.' +
      '<br><br><span class="k">Solar Wind Speed</span>  The velocity of charged particles streaming from the Sun, measured by the DSCOVR satellite at the L1 point ~1.5 million km upstream. Normal speed is 300400 km/s. Coronal hole streams produce 500700 km/s. CME-driven shocks can exceed 1,000 km/s. Faster wind delivers more energy per second to Earth\'s magnetosphere, but <span class="k">speed alone doesn\'t cause aurora</span>  you need negative Bz simultaneously. The combination of fast wind + strongly negative Bz is what drives the most dramatic aurora displays.' +
      '<br><br><span class="k">Vis (Visibility %)</span>  An estimated aurora visibility probability for your specific location based on your geomagnetic latitude and the current Kp index. This is calculated locally using SWPC aurora oval guidelines. Higher percentage = better chance if skies are clear and dark.' +
      '</div>';

    var auroraViewingTips = '<div class="widget-block">' +
      '<span class="k">Best conditions:</span> Clear skies + dark location (away from city light pollution) + Kp at or above your threshold (' + minKp + ') + negative Bz. All four must align. ' +
      '<span class="k">Timing:</span> Best viewing is typically 10 PM  2 AM local time when the auroral oval is most active over North America. Substorm injections (sudden brightenings) are most common around local magnetic midnight (~1 AM). ' +
      '<span class="k">The recipe:</span> Watch DSCOVR real-time data. When you see solar wind speed climb above 500 km/s AND Bz drop below -10 nT, that\'s your signal to go outside within the next 3060 minutes. Aurora responds almost immediately to Bz changes since the solar wind is already at Earth. ' +
      '<span class="k">Phone photography:</span> Most modern smartphones can capture aurora in Night Mode even when it appears faint or invisible to the naked eye. Point north, prop the phone steady, and use a 10-30 second exposure. If the camera shows green/purple that your eyes don\'t see, the aurora is there  your eyes just need time to dark-adapt (15+ minutes away from screens).' +
      '</div>';

    var html = '';

    // AURORA VIEWING (location-specific, first)
    html += S('Aurora Viewing  ' + LOCATION.name);
    html += '<div class="widget-block">' + auroraNote + '</div>';
    html += S('Understanding the Indicators');
    html += auroraTerms;
    html += S('Viewing Tips');
    html += auroraViewingTips;

    el.innerHTML = html;
  }

  // Build on load
  buildSpaceInfoPanel();
  
  // Populate individual widget info popups
  function populateSpacePopups(){
    var popups = {

      'lasco-c3-popup':
        '<b>LASCO C3  Outer Coronagraph</b>' +
        '<br><br><span class="k">Satellite:</span> SOHO (Solar and Heliospheric Observatory), a joint NASA/ESA mission orbiting the L1 Lagrange point  1.5 million km sunward of Earth  providing an uninterrupted solar view since 1996.' +
        '<br><br><span class="k">What you\'re seeing:</span> The bright disk of the Sun is blocked by a physical occulting disk (the solid circle in the center), revealing the faint outer corona from <b>3.7 to 30 solar radii</b> (~2.6 to 21 million km). The white circle drawn inside represents the Sun\'s actual size. Everything you see glowing outward is scattered light from free electrons in the million-degree corona.' +
        '<br><br><span class="k">What the features mean:</span>' +
        '<br> <b>Coronal streamers</b>  steady, ray-like bright structures extending radially outward. These trace the Sun\'s magnetic equator and mark the boundary between open and closed magnetic field regions. Their shape reveals the large-scale magnetic topology.' +
        '<br> <b>CMEs (Coronal Mass Ejections)</b>  expanding bright clouds or loops erupting outward. A typical CME carries 1-10 billion tons of plasma at 400-2,000+ km/s. They appear as bright arcs, bubbles, or flux rope structures.' +
        '<br> <b>Halo CMEs</b>  when a CME expands symmetrically around the entire occulting disk, it is traveling <b>directly toward or away from Earth</b>. Front-side halos are the most geoeffective events.' +
        '<br> <b>Background stars</b>  the Milky Way star field is visible, slowly drifting as SOHO\'s perspective shifts. Occasionally comets (sungrazers) streak toward the Sun.' +
        '<br><br><span class="k">How to use this:</span> Compare C3 with C2  a CME first appears in C2 (closer to the Sun) and expands into C3. Estimate CME speed by watching how fast the leading edge crosses the field of view. Full halo + fast speed (>1,000 km/s) = high-confidence Earth impact in 1-2 days. Partial halo or one-sided = likely a glancing blow or miss. Check the WSA-Enlil model for arrival time prediction.' +
        '<br><br><span class="k">Update cadence:</span> New images every ~30 minutes. During active events, C3 may update more frequently.',

      'lasco-c2-popup':
        '<b>LASCO C2  Inner Coronagraph</b>' +
        '<br><br><span class="k">Satellite:</span> SOHO (NASA/ESA) at L1. C2 is the higher-resolution companion to C3, viewing <b>1.5 to 6 solar radii</b> (~1 to 4.2 million km from Sun center).' +
        '<br><br><span class="k">What you\'re seeing:</span> The inner corona in much finer detail than C3. The occulting disk is smaller, revealing the region where CMEs are first launched and accelerated. You can see the detailed structure of eruptions  magnetic flux ropes, shock fronts, and post-eruption arcades.' +
        '<br><br><span class="k">What the features mean:</span>' +
        '<br> <b>Bright leading edge</b> of a CME  this is compressed plasma being piled up ahead of the magnetic flux rope. The shape tells you about the 3D structure.' +
        '<br> <b>Dark cavity</b> behind the leading edge  this is the low-density interior of the magnetic flux rope itself, the engine of the CME.' +
        '<br> <b>Bright core</b>  often visible as a bright knot within the cavity, this is cool dense prominence material being carried outward by the eruption.' +
        '<br> <b>Coronal streamers</b>  appear as bright stalks. When a streamer is disrupted or blown out, it indicates a CME originated from that region.' +
        '<br> <b>Inflows</b>  faint material falling back toward the Sun after an eruption = magnetic reconnection occurring, rebuilding the post-eruption field.' +
        '<br><br><span class="k">How to use this:</span> C2 catches the birth of CMEs. If you see a fast, bright eruption in C2, switch to C3 within 30-60 minutes to track its expansion. Estimate initial speed here  eruptions crossing the full C2 field in under 1 hour are fast (>1,000 km/s) and potentially dangerous. Slower CMEs (several hours to cross) are less geoeffective.' +
        '<br><br><span class="k">Update cadence:</span> ~20-30 minutes. C2 images are sharper and show more structural detail than C3.',

      'pfss-popup':
        '<b>Solar Magnetic Field  SDO AIA 171 + PFSS</b>' +
        '<br><br><span class="k">Satellite:</span> SDO (Solar Dynamics Observatory), NASA, in geosynchronous orbit. Captures the full solar disk in 10 wavelengths every 12 seconds at 40964096 resolution  the highest-cadence, highest-resolution solar observatory ever built.' +
        '<br><br><span class="k">What you\'re seeing:</span> The base image is <b>AIA 171</b> (extreme ultraviolet), which shows plasma at approximately <b>600,000C</b>  the temperature of the quiet corona. This reveals the intricate magnetic architecture of the Sun\'s atmosphere: loops, fans, plumes, and dark voids.' +
        '<br><br>Overlaid are <b>PFSS (Potential Field Source Surface)</b> magnetic field lines computed from photospheric magnetogram data:' +
        '<br> <b style="color:#fff;">White lines</b>  <b>Closed magnetic loops</b> connecting back to the solar surface. Plasma is trapped along these loops. Active regions show dense tangles of white lines.' +
        '<br> <b style="color:#4f4;">Green lines</b>  <b>Open field toward Earth</b>. Solar wind escapes along these lines and flows toward Earth\'s position in the heliosphere.' +
        '<br> <b style="color:#f4f;">Magenta lines</b>  <b>Open field away from Earth</b>. Solar wind escapes but is directed to the far side of the heliosphere.' +
        '<br><br><span class="k">Key features to identify:</span>' +
        '<br> <b>Coronal holes</b>  large dark regions with predominantly open (green/magenta) field lines. These are the source of fast solar wind streams (600-800 km/s). When a coronal hole faces Earth, expect enhanced wind 2-4 days later as the Sun rotates.' +
        '<br> <b>Active regions</b>  bright, complex areas with dense closed (white) loops. These have the strongest magnetic fields and produce solar flares (sudden energy releases) and CMEs. The more complex the field topology, the higher the flare potential.' +
        '<br> <b>Filament channels</b>  long dark threads where the magnetic field is horizontal. These suspend cool plasma above the surface; if destabilized, they erupt as CMEs.' +
        '<br><br><span class="k">How to use this:</span> Track coronal holes as the Sun rotates (27-day period). If a large coronal hole with Earth-directed (green) open field is approaching the central meridian, prepare for enhanced solar wind in 2-4 days. Monitor active regions for increasing complexity  delta-class sunspot configurations with highly sheared magnetic fields produce the strongest flares (M and X class).' +
        '<br><br><span class="k">Update cadence:</span> PFSS overlay updates ~every 6 hours. AIA images update every 12 seconds.',

      'suvi-popup':
        '<b>SUVI Thematic Map  Solar Feature Classification</b>' +
        '<br><br><span class="k">Satellite:</span> GOES-16 and GOES-18 (NOAA), geostationary orbit. The Solar Ultraviolet Imager (SUVI) captures the Sun in six EUV wavelengths simultaneously, providing operational solar monitoring for space weather forecasting.' +
        '<br><br><span class="k">What you\'re seeing:</span> An algorithmically generated <b>thematic classification map</b> where machine learning identifies and color-codes distinct solar features from the multi-wavelength data. Each color represents a different physical phenomenon:' +
        '<br><br><span class="k">Color legend:</span>' +
        '<br> <b style="color:#ff69b4;">Pink  Flare</b>: Active flaring regions with sudden intense brightening. X-ray emission spikes. These are the most energetic events on the Sun.' +
        '<br> <b style="color:#87ceeb;">Light blue  Limb</b>: The solar edge, where optically thin coronal plasma is viewed along a longer path length, appearing brighter.' +
        '<br> <b style="color:#4a9adf;">Blue  Quiet Sun</b>: The calm background corona. Diffuse, relatively uniform emission at ~1-2 million K.' +
        '<br> <b style="color:#2ecc71;">Green  Coronal Hole</b>: Open magnetic field regions where plasma escapes as fast solar wind. <b>Key aurora driver</b>  track these as they rotate toward Earth.' +
        '<br> <b style="color:#e67e22;">Orange  Prominence / Filament</b>: Cool dense plasma (~10,000 K) suspended in the hot corona by magnetic fields. On the limb = prominence (bright). On disk = filament (dark absorption). Erupting filaments become CMEs.' +
        '<br> <b style="color:#e74c3c;">Red  Filament</b>: On-disk filament channels. Dark in most wavelengths because the cool material absorbs EUV radiation from below.' +
        '<br> <b style="color:#f1c40f;">Yellow  Bright Region / Active Region</b>: Areas of strong magnetic flux concentration. Sunspot groups, plage, and magnetically active areas that produce flares.' +
        '<br> <b>Black  Outer Space</b>: Background beyond the solar disk.' +
        '<br><br><span class="k">How to use this:</span> This is your best single-image overview of the Sun\'s current state. Quickly identify where coronal holes, active regions, and filaments are positioned relative to the Earth-facing disk center. Features near disk center are most geoeffective. Compare with the SDO PFSS to understand the magnetic context of what you see here.' +
        '<br><br><span class="k">Update cadence:</span> ~every 4 minutes.',

      'aurora-popup':
        '<b>Aurora Forecast  OVATION Prime Model</b>' +
        '<br><br><span class="k">Source:</span> NOAA Space Weather Prediction Center (SWPC). The OVATION (Oval Variation, Assessment, Tracking, Intensity, and Online Nowcasting) model, updated every <b>30 minutes</b> using real-time solar wind measurements from the DSCOVR satellite at L1.' +
        '<br><br><span class="k">What you\'re seeing:</span> A polar projection of the Northern Hemisphere with the predicted <b>auroral oval</b>  the ring-shaped zone where aurora is most likely. Brighter green/yellow colors indicate higher probability of visible aurora overhead. The oval\'s size and intensity expand equatorward during geomagnetic storms.' +
        '<br><br><span class="k">The indicators explained:</span>' +
        '<br> <b>Kp (0-9)</b>  The planetary geomagnetic activity index. Measured by ground magnetometers worldwide every 3 hours. Kp 0-1 = quiet. Kp 2-3 = unsettled. Kp 4 = active. Kp 5+ = geomagnetic storm. Each unit  2 equatorward expansion of the oval.' +
        '<br> <b>G-Scale (G0-G5)</b>  NOAA storm severity. G0 = none (Kp 0-4). G1 = minor (Kp 5, ~900/cycle). G2 = moderate (Kp 6). G3 = strong (Kp 7). G4 = severe (Kp 8). G5 = extreme (Kp 9, ~4/cycle). G3+ can affect power grids and GPS.' +
        '<br> <b>Bz (nT)</b>  The IMF north-south component. <b>The single most important real-time predictor.</b> Negative Bz "unzips" Earth\'s magnetic shield via reconnection. Above -5 nT = minimal. -5 to -10 = moderate. Below -10 = strong aurora likely. Below -20 = intense storm.' +
        '<br> <b>Wind (km/s)</b>  Solar wind speed from DSCOVR at L1. Normal: 300-400. Coronal hole stream: 500-700. CME shock: 800-2,000+. Speed amplifies Bz effects  fast wind + negative Bz = rapid energy injection.' +
        '<br> <b>Vis%</b>  Estimated visibility probability for your specific geomagnetic latitude and current Kp. Higher = better chance with clear dark skies.' +
        '<br><br><span class="k">The aurora recipe:</span> All four must align: (1) Clear skies, (2) Dark location away from light pollution, (3) Kp at or above your threshold, (4) Negative Bz. Watch DSCOVR data  when wind climbs above 500 km/s AND Bz drops below -10 nT, go outside within 30-60 minutes. Aurora responds almost immediately to Bz changes. Best viewing: 10 PM  2 AM local time.' +
        '<br><br><span class="k">Phone tip:</span> Night Mode with 10-30s exposure pointed north can capture aurora invisible to unadjusted eyes. Allow 15+ min away from screens for dark adaptation.',

      'enlil-popup':
        '<b>Solar Wind  WSA-Enlil Heliosphere Model</b>' +
        '<br><br><span class="k">Source:</span> NOAA SWPC. The Wang-Sheeley-Arge (WSA) coronal model feeds into the Enlil 3D magnetohydrodynamic (MHD) simulation, modeling solar wind propagation from the Sun to beyond Earth\'s orbit.' +
        '<br><br><span class="k">What you\'re seeing:</span> A <b>top-down view of the ecliptic plane</b> (the flat plane of the solar system). The Sun is at center. Earth\'s position is marked (usually as a green dot or label). The color field represents solar wind <b>density</b> (particles/cm) or <b>speed</b> (km/s) depending on the frame.' +
        '<br><br><span class="k">What the features mean:</span>' +
        '<br> <b>Spiral structure</b>  the Parker spiral. Solar wind flows radially outward but the Sun\'s rotation curves it into an Archimedean spiral pattern, like water from a spinning sprinkler.' +
        '<br> <b>Yellow/red blobs</b>  CMEs or corotating interaction regions (CIRs) propagating outward through the heliosphere. Brighter = denser or faster.' +
        '<br> <b>Stream interaction regions</b>  where fast solar wind from coronal holes catches up to slower ambient wind, creating compressed high-density boundaries (CIRs). These produce recurrent geomagnetic disturbances every ~27 days.' +
        '<br> <b>CME cone</b>  when SWPC inputs a detected CME, it appears as a bright expanding structure. Track its approach toward Earth\'s position.' +
        '<br><br><span class="k">How to use this:</span> This is your <b>1-4 day advance warning</b> system. When a bright structure (CME or CIR) approaches Earth\'s position in the animation, estimate arrival time by watching the frame timestamps. Cross-reference with LASCO: halo CME in LASCO + blob aimed at Earth in Enlil = high-confidence geomagnetic storm prediction. The model also shows CME-CME interactions  when a fast CME overtakes a slower one, the combined impact can be much stronger than either alone (a "cannibal CME").' +
        '<br><br><span class="k">Limitations:</span> Enlil models density and speed well but does <b>not predict Bz</b>. A CME can arrive on time at predicted speed but have northward Bz (no storm) or strongly southward Bz (major storm). The actual Bz is only measured when the CME hits DSCOVR  about 15-45 minutes before Earth impact.' +
        '<br><br><span class="k">Update cadence:</span> Model reruns every ~2 hours, or immediately when a new CME is detected.',

      'geo-popup':
        '<b>Geospace Magnetosphere  Real-Time MHD Simulation</b>' +
        '<br><br><span class="k">Source:</span> NOAA SWPC Geospace model. A 3D magnetohydrodynamic simulation of Earth\'s magnetic environment, driven in real-time by measured solar wind conditions from DSCOVR at L1.' +
        '<br><br><span class="k">What you\'re seeing:</span> A cross-section of Earth\'s magnetosphere in the noon-midnight meridional plane. The Sun is to the left. Earth is the small circle in the center. The colors represent plasma properties in the surrounding magnetic cavity.' +
        '<br><br><span class="k">Three views explained:</span>' +
        '<br><br><b>Velocity</b>  Solar wind flow speed (km/s) around Earth\'s magnetic obstacle.' +
        '<br> The <b>bow shock</b> is visible as a sharp color boundary on the dayside (left)  this is where the supersonic solar wind abruptly decelerates from 400+ km/s to ~100 km/s, heating the plasma to >1 million K.' +
        '<br> The <b>magnetosheath</b> is the turbulent layer between the bow shock and magnetopause where deflected solar wind flows around Earth.' +
        '<br> The <b>magnetotail</b> stretches far to the right (nightside), where magnetic field lines are stretched like a rubber band by the solar wind drag.' +
        '<br><br><b>Density</b>  Plasma concentration (particles/cm).' +
        '<br> Highest in the <b>magnetosheath</b>  compressed solar wind piling up against the magnetic barrier.' +
        '<br> Low inside the <b>magnetosphere</b> proper  Earth\'s magnetic field excludes most solar wind plasma.' +
        '<br> Density enhancements in the tail indicate plasma sheet thickening before a substorm.' +
        '<br><br><b>Pressure</b>  Dynamic pressure (nPa) compressing the magnetosphere.' +
        '<br> When solar wind pressure increases (fast wind or high density), the <b>magnetopause is pushed closer to Earth</b>  from its normal ~10 Earth radii to as close as ~6 during extreme events (geosynchronous orbit).' +
        '<br> Sudden pressure pulses cause <b>sudden commencements</b>  the start of geomagnetic storms, when the compressed field rings like a bell.' +
        '<br><br><span class="k">What to watch for:</span>' +
        '<br> <b>Compressed dayside</b> (magnetopause pushed in close) = strong solar wind forcing, storm conditions.' +
        '<br> <b>Stretched, thin magnetotail</b> followed by <b>sudden contraction</b> = a <b>substorm</b>. Magnetic energy stored in the stretched tail is explosively released, accelerating particles into the polar atmosphere to produce bright, dynamic aurora  the "dancing curtains" of light.' +
        '<br> <b>Symmetric compression</b> with high pressure on all sides = strong CME impact, likely G3+ storm.' +
        '<br><br><span class="k">Update cadence:</span> Near real-time, refreshing every few minutes.'

    };
    Object.keys(popups).forEach(function(id){
      var el = document.getElementById(id);
      if (el) el.innerHTML = popups[id];
    });
  }
  populateSpacePopups();

  // Toggle popup visibility
  function toggleSpacePopup(id, event){
    if (event) event.stopPropagation();
    var popup = document.getElementById(id);
    if (!popup) return;
    var wasActive = popup.classList.contains('active');
    // Close all popups first
    document.querySelectorAll('.space-info-popup.active').forEach(function(p){ p.classList.remove('active'); });
    if (!wasActive) {
      // Inject live data  wrapped in try/catch so popup still opens if injection fails
      try {
        if (id === 'aurora-popup') injectLiveAuroraData(popup);
        if (id === 'lasco-c3-popup' || id === 'lasco-c2-popup') injectLiveLascoData(popup);
        if (id === 'pfss-popup') injectLivePfssData(popup);
        if (id === 'suvi-popup') injectLiveSuviData(popup);
        if (id === 'enlil-popup') injectLiveEnlilData(popup);
        if (id === 'geo-popup') injectLiveGeoData(popup);
      } catch(e){ console.error('Space popup injection error:', e); }
      popup.classList.add('active');
    }
  }

  //  SHARED: Observing conditions cross-reference for space widgets 
  //  SHARED: Cloud Layer Stack Visualization 
  function buildCloudStackVisual(low, mid, high) {
    if (low == null && mid == null && high == null) return '';
    var l = low || 0, m = mid || 0, h = high || 0;
    var wx = window._wxCurrent || {};
    var hourly = window._wxHourly;
    var ni = window._wxNearestIdx;

    //  Cloud type inference from atmospheric context 
    // Real meteorologists don't just say "low clouds"  they identify genera
    function inferCloudType(layer, pct) {
      if (pct < 5) return { type: '', desc: '' };
      var temp = wx.temp, dp = wx.dewpoint, wind = wx.wind, rh = wx.rh;
      var cape = wx.cape, precip = wx.precip, code = wx.weatherCode;
      var pbl = wx.pblHeight, spread = (temp != null && dp != null) ? temp - dp : null;
      var isRaining = precip > 0.01 || (code >= 51 && code <= 82);
      var isStormy = code >= 95;
      var isFreezing = temp != null && temp <= 32;

      if (layer === 'high') {
        // HIGH CLOUDS (>20,000 ft / >6km): Cirrus family
        if (isRaining || (wx.precipProb > 60)) {
          // Cs (Cirrostratus)  thin veil ahead of warm front
          return pct > 70 ?
            { type: 'Cs', desc: 'Cirrostratus  continuous ice crystal veil, often precedes warm front by 12-24hr. Watch for halo around sun/moon.' } :
            { type: 'Ci', desc: 'Cirrus thickening  precip approaching. Classic warm front sequence: Ci  Cs  As  Ns.' };
        }
        if (wx.pressureTrend != null && wx.pressureTrend <= -1) {
          return { type: 'Cs', desc: 'Cirrostratus with falling pressure  warm front or cyclone shield approaching. Precip likely within 12-24 hours.' };
        }
        if (pct > 70) {
          return { type: 'Cs', desc: 'Cirrostratus  continuous ice crystal sheet. May produce halos. Often the first sign of an approaching storm system.' };
        }
        if (pct > 30) {
          return { type: 'Ci', desc: 'Cirrus  wispy ice crystal streaks at jet stream altitude. Hooks or mare\'s tails indicate upper-level wind shear direction.' };
        }
        return { type: 'Ci', desc: 'Thin cirrus  fair weather ice crystals. No significant weather impact.' };
      }

      if (layer === 'mid') {
        // MID CLOUDS (6,500-20,000 ft / 2-6km): Alto family
        if (isRaining && pct > 60) {
          return { type: 'Ns', desc: 'Nimbostratus  thick, dark, rain-producing. The main precipitation engine of warm fronts and mature cyclones. Steady rain/snow, not showers.' };
        }
        if (pct > 80 && (wx.precipProb > 40 || (wx.pressureTrend != null && wx.pressureTrend <= -1))) {
          return { type: 'As', desc: 'Altostratus  featureless gray sheet, sun dimly visible or invisible. Precip often falling from this layer (may be virga if RH low below).' };
        }
        if (pct > 60 && !isRaining && cape != null && cape > 500) {
          return { type: 'Ac cast', desc: 'Altocumulus castellanus  turret-like mid-level convection. Warning sign: indicates mid-level instability, often precedes afternoon/evening thunderstorms by 4-8 hours.' };
        }
        if (pct > 40 && pct <= 80) {
          return { type: 'Ac', desc: 'Altocumulus  patchy white/gray layer with cellular pattern. If thickening with falling pressure, storm approaching. "Mackerel sky" pattern = weather change within 24hr.' };
        }
        if (pct > 15) {
          return { type: 'Ac', desc: 'Scattered altocumulus  mid-level moisture present. Fair weather if stable; convective fuel if unstable layer exists above.' };
        }
        return { type: '', desc: '' };
      }

      if (layer === 'low') {
        // LOW CLOUDS (<6,500 ft / <2km): Stratus/Cumulus family
        if (isStormy) {
          return { type: 'Cb', desc: 'Cumulonimbus  towering thunderstorm. Extends from near surface through all layers to tropopause. Produces lightning, heavy rain, hail, possible tornadoes.' };
        }
        if (cape != null && cape > 1500 && pct > 30) {
          return { type: 'TCu', desc: 'Towering cumulus  deep convection building. Tops growing rapidly. If reaching freezing level, will become cumulonimbus (thunderstorm) within 15-30 minutes.' };
        }
        if (isRaining && pct > 70) {
          return { type: 'St/Fs', desc: 'Stratus/fractostratus  low ragged cloud base in active precipitation. Scud clouds racing beneath the main cloud deck.' };
        }
        if (spread != null && spread <= 3 && wind < 8) {
          return { type: 'Fg/St', desc: 'Fog/stratus  T-Td spread ' + (spread != null ? spread + 'F' : 'minimal') + ' with light winds. Ground-hugging moisture. Burns off with solar heating or lifts to low stratus as winds increase.' };
        }
        if (pct > 80 && (!cape || cape < 200)) {
          return { type: 'Sc', desc: 'Stratocumulus  lumpy, continuous low overcast. The most common cloud type on Earth. Ceiling likely 1,500-4,500 ft. Drizzle possible from thicker sections.' };
        }
        if (pct > 40 && pbl != null && pbl > 1500 && temp > 70) {
          return { type: 'Cu', desc: 'Fair-weather cumulus  flat-bottomed, growing vertically. Products of daytime heating. Tops indicate mixing depth (PBL height ~' + Math.round(pbl) + 'm). More = more heating = possible afternoon storms.' };
        }
        if (pct > 30 && pct <= 60) {
          return { type: 'Cu/Sc', desc: 'Scattered cumulus/stratocumulus  broken cloud field. Gaps let sunlight through for uneven heating, which creates convergence zones where new clouds preferentially develop.' };
        }
        if (pct > 5 && pct <= 30) {
          return { type: 'Cu', desc: 'Few cumulus  mostly clear with isolated clouds. Fair weather pattern.' };
        }
        return { type: '', desc: '' };
      }
      return { type: '', desc: '' };
    }

    //  Cloud layer trends from hourly data 
    function getLayerTrend(arrayKey, hoursBack) {
      if (!hourly || !hourly[arrayKey] || ni == null || ni < hoursBack) return null;
      var now = hourly[arrayKey][ni];
      var ago = hourly[arrayKey][ni - hoursBack];
      if (typeof now !== 'number' || typeof ago !== 'number') return null;
      return now - ago;
    }

    var lowTrend3 = getLayerTrend('cloud_cover_low', 3);
    var midTrend3 = getLayerTrend('cloud_cover_mid', 3);
    var highTrend3 = getLayerTrend('cloud_cover_high', 3);

    //  6-hour cloud layer forecast mini-strip 
    function buildCloudForecastStrip() {
      if (!hourly || !hourly.cloud_cover_low || ni == null) return '';
      var cells = [];
      for (var ci = 0; ci < 8; ci++) {
        var idx = ni + ci;
        if (idx >= hourly.time.length) break;
        var dt = new Date(hourly.time[idx]);
        var hr = dt.getHours();
        cells.push({
          hr: (hr % 12 || 12) + (hr < 12 ? 'a' : 'p'),
          low: hourly.cloud_cover_low[idx] || 0,
          mid: hourly.cloud_cover_mid ? (hourly.cloud_cover_mid[idx] || 0) : 0,
          high: hourly.cloud_cover_high ? (hourly.cloud_cover_high[idx] || 0) : 0,
          total: hourly.cloudcover ? (hourly.cloudcover[idx] || 0) : 0
        });
      }
      if (cells.length < 4) return '';
      var strip = '<div style="margin-top:5px;">';
      strip += '<div style="font-size:.36rem;opacity:.4;margin-bottom:2px;">CLOUD LAYERS  NEXT 8HR</div>';
      strip += '<div style="display:flex;gap:1px;">';
      cells.forEach(function(c) {
        // Each cell is a mini stacked bar showing the 3 layers
        var totalH = 28;
        strip += '<div style="flex:1;text-align:center;min-width:0;">';
        strip += '<div style="font-size:.32rem;opacity:.4;margin-bottom:1px;">' + c.hr + '</div>';
        // Stacked vertical bar
        strip += '<div style="height:' + totalH + 'px;display:flex;flex-direction:column;gap:0;border-radius:2px;overflow:hidden;background:rgba(255,255,255,.03);">';
        // High (top third)
        var hAlpha = Math.max(c.high / 120, 0.03).toFixed(2);
        strip += '<div style="flex:1;background:rgba(180,200,255,' + hAlpha + ');"></div>';
        // Mid (middle third)
        var mAlpha = Math.max(c.mid / 120, 0.03).toFixed(2);
        strip += '<div style="flex:1;background:rgba(140,160,200,' + mAlpha + ');"></div>';
        // Low (bottom third)
        var lAlpha = Math.max(c.low / 120, 0.03).toFixed(2);
        strip += '<div style="flex:1;background:rgba(170,170,180,' + lAlpha + ');"></div>';
        strip += '</div>';
        // Total % label
        strip += '<div style="font-size:.30rem;opacity:.35;margin-top:1px;">' + c.total + '</div>';
        strip += '</div>';
      });
      strip += '</div>';
      strip += '<div style="display:flex;justify-content:flex-end;gap:8px;font-size:.28rem;opacity:.3;margin-top:1px;">';
      strip += '<span> High</span><span style="color:rgba(140,160,200,.8);"> Mid</span><span style="color:rgba(170,170,180,.8);"> Low</span>';
      strip += '</div>';
      strip += '</div>';
      return strip;
    }

    // Infer cloud types
    var highType = inferCloudType('high', h);
    var midType = inferCloudType('mid', m);
    var lowType = inferCloudType('low', l);

    // Trend arrows
    function trendLabel(trend, layer) {
      if (trend == null) return '';
      if (trend > 25) return ' <span style="color:#f90;"> surging (+' + trend + '%/3hr)</span>';
      if (trend > 10) return ' <span style="color:#f90;"> building</span>';
      if (trend < -25) return ' <span style="color:#4f8;"> clearing (' + Math.abs(trend) + '%/3hr)</span>';
      if (trend < -10) return ' <span style="color:#4f8;"> thinning</span>';
      return '';
    }

    //  Build the visual 
    var out = '<div style="margin:5px 0 3px 0;">';

    // Layer bars with expanded info
    out += '<div style="display:flex;flex-direction:column;gap:2px;width:100%;">';

    // HIGH
    out += '<div style="display:flex;align-items:center;gap:4px;height:' + (highType.desc ? '22' : '14') + 'px;">';
    out += '<span style="font-size:.40rem;opacity:.6;width:26px;text-align:right;flex-shrink:0;">High</span>';
    out += '<div style="flex:1;display:flex;flex-direction:column;gap:0;">';
    out += '<div style="display:flex;align-items:center;gap:4px;">';
    out += '<div style="flex:1;max-width:180px;height:10px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;position:relative;">';
    out += '<div style="width:' + h + '%;height:100%;background:linear-gradient(90deg, rgba(180,200,255,.25), rgba(180,200,255,' + Math.max(h/120, 0.15).toFixed(2) + '));border-radius:3px;transition:width .5s;"></div>';
    if (h > 0) out += '<span style="position:absolute;right:3px;top:0;font-size:.38rem;line-height:10px;color:rgba(180,200,255,' + Math.max(h/100, 0.5).toFixed(2) + ');">' + h + '%</span>';
    out += '</div>';
    out += '<span style="font-size:.40rem;color:rgba(180,200,255,.7);font-weight:600;min-width:28px;">' + (highType.type || (h > 60 ? 'Ci/Cs' : h > 20 ? 'Ci' : '')) + '</span>';
    out += '<span style="font-size:.36rem;opacity:.5;">' + trendLabel(highTrend3, 'high') + '</span>';
    out += '</div>';
    if (highType.desc && h > 10) out += '<div style="font-size:.36rem;color:rgba(180,200,255,.5);line-height:1.2;margin-top:1px;max-width:260px;">' + highType.desc + '</div>';
    out += '</div></div>';

    // MID
    out += '<div style="display:flex;align-items:center;gap:4px;height:' + (midType.desc ? '22' : '14') + 'px;">';
    out += '<span style="font-size:.40rem;opacity:.6;width:26px;text-align:right;flex-shrink:0;">Mid</span>';
    out += '<div style="flex:1;display:flex;flex-direction:column;gap:0;">';
    out += '<div style="display:flex;align-items:center;gap:4px;">';
    out += '<div style="flex:1;max-width:180px;height:10px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;position:relative;">';
    out += '<div style="width:' + m + '%;height:100%;background:linear-gradient(90deg, rgba(140,160,200,.25), rgba(140,160,200,' + Math.max(m/120, 0.15).toFixed(2) + '));border-radius:3px;transition:width .5s;"></div>';
    if (m > 0) out += '<span style="position:absolute;right:3px;top:0;font-size:.38rem;line-height:10px;color:rgba(140,160,200,' + Math.max(m/100, 0.5).toFixed(2) + ');">' + m + '%</span>';
    out += '</div>';
    out += '<span style="font-size:.40rem;color:rgba(140,160,200,.7);font-weight:600;min-width:28px;">' + (midType.type || (m > 60 ? 'As/Ac' : m > 20 ? 'Ac' : '')) + '</span>';
    out += '<span style="font-size:.36rem;opacity:.5;">' + trendLabel(midTrend3, 'mid') + '</span>';
    out += '</div>';
    if (midType.desc && m > 10) out += '<div style="font-size:.36rem;color:rgba(140,160,200,.5);line-height:1.2;margin-top:1px;max-width:260px;">' + midType.desc + '</div>';
    out += '</div></div>';

    // LOW
    out += '<div style="display:flex;align-items:center;gap:4px;height:' + (lowType.desc ? '22' : '14') + 'px;">';
    out += '<span style="font-size:.40rem;opacity:.6;width:26px;text-align:right;flex-shrink:0;">Low</span>';
    out += '<div style="flex:1;display:flex;flex-direction:column;gap:0;">';
    out += '<div style="display:flex;align-items:center;gap:4px;">';
    out += '<div style="flex:1;max-width:180px;height:10px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;position:relative;">';
    out += '<div style="width:' + l + '%;height:100%;background:linear-gradient(90deg, rgba(160,160,170,.25), rgba(160,160,170,' + Math.max(l/120, 0.15).toFixed(2) + '));border-radius:3px;transition:width .5s;"></div>';
    if (l > 0) out += '<span style="position:absolute;right:3px;top:0;font-size:.38rem;line-height:10px;color:rgba(160,160,170,' + Math.max(l/100, 0.5).toFixed(2) + ');">' + l + '%</span>';
    out += '</div>';
    out += '<span style="font-size:.40rem;color:rgba(170,170,180,.7);font-weight:600;min-width:28px;">' + (lowType.type || (l > 60 ? 'St/Sc' : l > 20 ? 'Cu' : '')) + '</span>';
    out += '<span style="font-size:.36rem;opacity:.5;">' + trendLabel(lowTrend3, 'low') + '</span>';
    out += '</div>';
    if (lowType.desc && l > 10) out += '<div style="font-size:.36rem;color:rgba(170,170,180,.5);line-height:1.2;margin-top:1px;max-width:260px;">' + lowType.desc + '</div>';
    out += '</div></div>';

    out += '</div>';

    //  Multi-layer interaction physics 
    var interactions = '';
    // Classic warm front approach: highmidlow sequence
    if (h > 60 && m > 40 && l < 30 && highTrend3 > 0) {
      interactions += '<div style="color:#f90;"> <b>Warm front sequence:</b> High clouds arrived first, mid-layer thickening. Classic CiCsAsNs progression. Expect cloud base to lower and precip to begin as mid/low layers fill in.</div>';
    } else if (h > 50 && m > 50 && l > 50) {
      interactions += '<div style="color:#78a0ff;"> <b>Deep overcast:</b> All three layers filled. Thick cloud deck  steady precipitation likely. Cloud-top temps well below freezing  ice crystal seeder-feeder process enhancing precipitation.</div>';
    } else if (l > 70 && m < 20 && h < 20) {
      interactions += '<div style="color:#aaa;"> <b>Shallow stratus:</b> Trapped in the boundary layer (' + (wx.pblHeight ? Math.round(wx.pblHeight) + 'm PBL' : 'low PBL') + '). No deep moisture aloft. Drizzle only. ' + (wx.solarRad > 200 ? 'Solar heating should erode from above.' : 'Persistent until wind increases or inversion breaks.') + '</div>';
    } else if (h > 40 && l > 40 && m < 20) {
      interactions += '<div style="color:#a78bfa;"> <b>Dual-layer:</b> High cirrus over low clouds with dry mid-level gap. Two separate moisture sources  the high cloud is not connected to the low cloud. May see thin spots between layers.</div>';
    } else if (m > 60 && h < 20 && l < 20 && (wx.cape > 500 || (wx.liftedIndex != null && wx.liftedIndex < -2))) {
      interactions += '<div style="color:#f90;"> <b>Altocumulus castellanus:</b> Mid-level instability with dry above and below. Classic pre-convective signal  thunderstorms often develop 4-8 hours after Ac castellanus appears.</div>';
    } else if (l < 10 && m < 10 && h < 10) {
      interactions += '<div style="color:#4f8;"> <b>Crystal clear:</b> No significant cloud at any level. Excellent for astronomy' + (wx.rh < 50 ? ' with dry air enhancing transparency.' : '.') + '</div>';
    }
    // Seeder-feeder
    if (h > 40 && l > 40) {
      if (wx.precip > 0.05) interactions += '<div style="font-size:.36rem;opacity:.6;margin-top:1px;">Ice crystals falling from high clouds "seed" the lower clouds, enhancing precipitation rates beyond what either layer would produce alone (seeder-feeder mechanism).</div>';
    }
    // Cap/inversion
    if (l > 50 && m < 15 && wx.cape > 500) {
      interactions += '<div style="font-size:.36rem;color:#f90;margin-top:1px;"> Cap in place  cumulus tops hitting the inversion and spreading into stratocumulus. CAPE ' + Math.round(wx.cape) + ' J/kg trapped below. If cap breaks, explosive convection.</div>';
    }

    if (interactions) {
      out += '<div style="font-size:.40rem;line-height:1.3;margin-top:3px;padding:3px 5px;background:rgba(255,255,255,.02);border-radius:4px;">' + interactions + '</div>';
    }

    //  Cloud layer forecast strip 
    out += buildCloudForecastStrip();

    // Altitude scale
    out += '<div style="display:flex;justify-content:flex-end;gap:12px;font-size:.30rem;opacity:.25;margin-top:2px;">';
    out += '<span>High: &gt;20kft (Ci/Cs/Cc)</span><span>Mid: 6-20kft (As/Ac)</span><span>Low: &lt;6kft (St/Sc/Cu)</span>';
    out += '</div>';

    out += '</div>';
    return out;
  }

  //  SHARED: STP Gauge  small arc gauge for Significant Tornado Parameter 
  function buildSTPGauge(stp) {
    if (stp == null || stp <= 0) return '';
    var maxStp = 5;
    var pct = Math.min(stp / maxStp, 1);
    var col = stp >= 4 ? '#f44' : stp >= 2.5 ? '#f90' : stp >= 1 ? '#cc0' : '#78a0ff';
    var bgTrack = 'rgba(255,255,255,.08)';
    var label = stp >= 4 ? 'EXTREME' : stp >= 2.5 ? 'SIGNIFICANT' : stp >= 1 ? 'FAVORABLE' : 'MARGINAL';
    var out = '<div style="display:flex;align-items:center;gap:8px;margin:5px 0 2px 0;">';
    // Horizontal gauge bar
    out += '<div style="flex:1;max-width:140px;">';
    out += '<div style="height:8px;background:' + bgTrack + ';border-radius:4px;overflow:hidden;position:relative;">';
    // Gradient fill
    out += '<div style="width:' + (pct * 100).toFixed(0) + '%;height:100%;border-radius:4px;background:linear-gradient(90deg, rgba(120,160,255,.5), ' + col + ');box-shadow:0 0 6px ' + col + '44;transition:width .5s;"></div>';
    // Tick marks at 1 and 3
    out += '<div style="position:absolute;left:20%;top:0;width:1px;height:100%;background:rgba(255,255,255,.15);"></div>';
    out += '<div style="position:absolute;left:60%;top:0;width:1px;height:100%;background:rgba(255,255,255,.15);"></div>';
    out += '</div>';
    // Scale labels
    out += '<div style="display:flex;justify-content:space-between;font-size:.32rem;opacity:.4;margin-top:1px;">';
    out += '<span>0</span><span>1</span><span>3</span><span>5</span>';
    out += '</div>';
    out += '</div>';
    // Value + label
    out += '<div style="text-align:center;">';
    out += '<div style="font-size:.70rem;font-weight:800;color:' + col + ';line-height:1;">' + stp.toFixed(1) + '</div>';
    out += '<div style="font-size:.36rem;font-weight:600;color:' + col + ';opacity:.8;">' + label + '</div>';
    out += '</div>';
    out += '</div>';
    return out;
  }

  //  SHARED: Seeing + Transparency dual meter 
  function buildSeeingTransBars(seeScore, transScore) {
    var maxSee = 6, maxTrans = 8;
    function bar(score, max, label, goodLabel, badLabel) {
      var pct = Math.max(Math.min(score / max, 1), 0);
      var col = pct >= 0.75 ? '#4f8' : pct >= 0.5 ? '#78a0ff' : pct >= 0.25 ? '#f90' : '#f44';
      var txt = pct >= 0.75 ? 'Excellent' : pct >= 0.5 ? 'Good' : pct >= 0.25 ? 'Fair' : 'Poor';
      var o = '<div style="flex:1;">';
      o += '<div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:1px;">';
      o += '<span style="font-size:.42rem;opacity:.6;">' + label + '</span>';
      o += '<span style="font-size:.42rem;font-weight:600;color:' + col + ';">' + txt + '</span>';
      o += '</div>';
      o += '<div style="height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;">';
      o += '<div style="width:' + (pct * 100).toFixed(0) + '%;height:100%;border-radius:3px;background:linear-gradient(90deg, ' + col + '44, ' + col + ');transition:width .5s;"></div>';
      o += '</div>';
      o += '<div style="display:flex;justify-content:space-between;font-size:.30rem;opacity:.3;margin-top:1px;"><span>' + badLabel + '</span><span>' + goodLabel + '</span></div>';
      o += '</div>';
      return o;
    }
    var out = '<div style="display:flex;gap:8px;margin:5px 0 3px 0;">';
    out += bar(seeScore, maxSee, 'Seeing', 'steady', 'turbulent');
    out += bar(transScore, maxTrans, ' Transparency', 'crystal', 'murky');
    out += '</div>';
    return out;
  }

  //  SHARED: Soil Moisture Gauge 
  function buildSoilMoistureGauge(moisture) {
    if (moisture == null) return '';
    var pct = Math.min(moisture * 100, 100);
    // Color: dry tan  moist green  saturated blue
    var col, label;
    if (pct >= 45) { col = '#4af'; label = 'SATURATED'; }
    else if (pct >= 30) { col = '#78a0ff'; label = 'WET'; }
    else if (pct >= 18) { col = '#4f8'; label = 'MOIST'; }
    else if (pct >= 8) { col = '#cc0'; label = 'DRY'; }
    else { col = '#f90'; label = 'PARCHED'; }
    var out = '<div style="margin:4px 0 2px 0;">';
    out += '<div style="display:flex;align-items:center;gap:6px;">';
    out += '<span style="font-size:.42rem;opacity:.6;width:32px;">Soil</span>';
    out += '<div style="flex:1;max-width:130px;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden;position:relative;">';
    // Multi-stop gradient showing full range as background reference
    out += '<div style="position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg, rgba(255,153,0,.1), rgba(204,204,0,.1) 20%, rgba(68,255,136,.1) 40%, rgba(120,160,255,.1) 70%, rgba(68,170,255,.15) 100%);border-radius:4px;"></div>';
    // Actual fill
    out += '<div style="position:relative;width:' + pct.toFixed(0) + '%;height:100%;border-radius:4px;background:linear-gradient(90deg, ' + col + '33, ' + col + ');box-shadow:0 0 4px ' + col + '33;transition:width .5s;"></div>';
    out += '</div>';
    out += '<span style="font-size:.44rem;font-weight:600;color:' + col + ';">' + pct.toFixed(0) + '%</span>';
    out += '<span style="font-size:.36rem;color:' + col + ';opacity:.7;">' + label + '</span>';
    out += '</div>';
    out += '</div>';
    return out;
  }

  //  SHARED: 6-Hour Lookahead Strip 
  function build6hrStrip(wx) {
    if (!window._wxHourly || !window._wxHourly.time || window._wxNearestIdx == null) return '';
    var h = window._wxHourly;
    var start = window._wxNearestIdx;
    var cells = [];
    for (var i = 0; i < 6; i++) {
      var idx = start + i;
      if (idx >= h.time.length) break;
      var dt = new Date(h.time[idx]);
      var hr = dt.getHours();
      var pp = h.precipitation_probability ? (h.precipitation_probability[idx] || 0) : 0;
      var pr = h.precipitation ? (h.precipitation[idx] || 0) : 0;
      var g = h.windgusts_10m ? (h.windgusts_10m[idx] || 0) : 0;
      var t = h.temperature_2m ? h.temperature_2m[idx] : null;
      var wc = h.weathercode ? (h.weathercode[idx] || 0) : 0;
      // Determine cell color based on severity
      var bg, borderCol;
      if (wc >= 95 || g >= 58 || pr > 0.5) { bg = 'rgba(255,68,68,.2)'; borderCol = '#f44'; }
      else if (wc >= 80 || g >= 35 || pr > 0.15 || pp >= 70) { bg = 'rgba(255,153,0,.15)'; borderCol = '#f90'; }
      else if (pp >= 40 || g >= 25 || pr > 0.01) { bg = 'rgba(204,204,0,.12)'; borderCol = '#cc0'; }
      else { bg = 'rgba(100,255,136,.06)'; borderCol = 'rgba(100,255,136,.3)'; }
      // Weather icon
      var icon = '';
      if (wc >= 95) icon = ''; else if (wc >= 80) icon = ''; else if (wc >= 71) icon = ''; else if (wc >= 61) icon = ''; else if (wc >= 51) icon = ''; else if (wc >= 45) icon = ''; else if (wc === 3) icon = ''; else if (wc === 2) icon = ''; else if (wc === 1) icon = '';
      cells.push({
        hr: (hr % 12 || 12) + (hr < 12 ? 'a' : 'p'),
        icon: icon,
        bg: bg,
        borderCol: borderCol,
        temp: t != null ? Math.round(t) + '' : '',
        gust: g > 20 ? Math.round(g) + '' : '',
        pp: pp > 20 ? pp + '%' : ''
      });
    }
    if (cells.length < 3) return '';
    var out = '<div style="margin:5px 0 2px 0;">';
    out += '<div style="font-size:.38rem;opacity:.5;margin-bottom:2px;">NEXT 6 HOURS</div>';
    out += '<div style="display:flex;gap:2px;">';
    cells.forEach(function(c) {
      out += '<div style="flex:1;background:' + c.bg + ';border:1px solid ' + c.borderCol + ';border-radius:4px;padding:2px 1px;text-align:center;min-width:0;">';
      out += '<div style="font-size:.36rem;opacity:.5;">' + c.hr + '</div>';
      out += '<div style="font-size:.52rem;line-height:1.1;">' + c.icon + '</div>';
      out += '<div style="font-size:.38rem;font-weight:600;">' + c.temp + '</div>';
      if (c.pp) out += '<div style="font-size:.32rem;color:#78a0ff;">' + c.pp + '</div>';
      if (c.gust) out += '<div style="font-size:.32rem;color:#f90;">' + c.gust + 'g</div>';
      out += '</div>';
    });
    out += '</div></div>';
    return out;
  }

  //  SHARED: Inline Sparkline SVG 
  // Generates a tiny SVG sparkline from an hourly data array
  // hoursBack: how many hours of history, hoursFwd: how many hours ahead
  // Returns inline HTML string or '' if insufficient data
  function buildSparkline(arrayKey, hoursBack, hoursFwd, color, opts) {
    var h = window._wxHourly;
    var ni = window._wxNearestIdx;
    if (!h || !h[arrayKey] || ni == null) return '';
    opts = opts || {};
    var arr = h[arrayKey];
    var startIdx = Math.max(0, ni - hoursBack);
    var endIdx = Math.min(arr.length - 1, ni + hoursFwd);
    // Collect valid points
    var pts = [];
    for (var i = startIdx; i <= endIdx; i++) {
      if (typeof arr[i] === 'number') pts.push({ i: i - startIdx, v: arr[i], isNow: i === ni });
    }
    if (pts.length < 4) return '';
    // SVG dimensions
    var w = opts.width || 80, ht = opts.height || 18, pad = 2;
    var vMin = pts.reduce(function(a, p){ return Math.min(a, p.v); }, Infinity);
    var vMax = pts.reduce(function(a, p){ return Math.max(a, p.v); }, -Infinity);
    if (vMax === vMin) { vMin -= 1; vMax += 1; }
    var xScale = (w - pad * 2) / (pts.length - 1);
    var yScale = (ht - pad * 2) / (vMax - vMin);
    // Build path
    var pathParts = [];
    var nowX = null, nowY = null;
    pts.forEach(function(p, idx) {
      var x = pad + idx * xScale;
      var y = ht - pad - (p.v - vMin) * yScale;
      pathParts.push((idx === 0 ? 'M' : 'L') + x.toFixed(1) + ',' + y.toFixed(1));
      if (p.isNow) { nowX = x; nowY = y; }
    });
    // Build fill area (gradient under the line)
    var fillPath = pathParts.join(' ') + ' L' + (pad + (pts.length - 1) * xScale).toFixed(1) + ',' + ht + ' L' + pad + ',' + ht + ' Z';
    var svg = '<svg width="' + w + '" height="' + ht + '" viewBox="0 0 ' + w + ' ' + ht + '" style="display:inline-block;vertical-align:middle;margin:0 3px;">';
    // Gradient fill under curve
    svg += '<defs><linearGradient id="sfg_' + arrayKey + '" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="' + color + '" stop-opacity="0.25"/><stop offset="100%" stop-color="' + color + '" stop-opacity="0.02"/></linearGradient></defs>';
    svg += '<path d="' + fillPath + '" fill="url(#sfg_' + arrayKey + ')"/>';
    // Line
    svg += '<path d="' + pathParts.join(' ') + '" fill="none" stroke="' + color + '" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>';
    // "Now" dot
    if (nowX != null) {
      svg += '<circle cx="' + nowX.toFixed(1) + '" cy="' + nowY.toFixed(1) + '" r="2" fill="' + color + '" stroke="rgba(0,0,0,.4)" stroke-width="0.5"/>';
    }
    // Min/max subtle markers
    if (opts.showRange) {
      var first = pts[0], last = pts[pts.length - 1];
      svg += '<text x="' + pad + '" y="' + (ht - 1) + '" font-size="5" fill="' + color + '" opacity="0.5">' + (opts.unit ? first.v.toFixed(opts.decimals || 0) : '') + '</text>';
      svg += '<text x="' + (w - pad) + '" y="' + (ht - 1) + '" font-size="5" fill="' + color + '" opacity="0.5" text-anchor="end">' + (opts.unit ? last.v.toFixed(opts.decimals || 0) : '') + '</text>';
    }
    svg += '</svg>';
    return svg;
  }

  // Convenience sparkline builders for common parameters
  function sparkPressure() { return buildSparkline('pressure_msl', 12, 6, '#78a0ff', {width:75, height:16}); }
  function sparkTemp() { return buildSparkline('temperature_2m', 8, 6, '#f90', {width:70, height:16}); }
  function sparkDewpoint() { return buildSparkline('dewpoint_2m', 8, 6, '#4af', {width:70, height:16}); }
  function sparkGusts() { return buildSparkline('windgusts_10m', 8, 6, '#f90', {width:70, height:16}); }
  function sparkCAPE() { return buildSparkline('cape', 8, 6, '#f44', {width:70, height:16}); }
  function sparkPrecipProb() { return buildSparkline('precipitation_probability', 6, 6, '#78a0ff', {width:65, height:14}); }
  function sparkCloudCover() { return buildSparkline('cloudcover', 8, 6, '#aab', {width:65, height:14}); }
  function sparkRH() { return buildSparkline('relativehumidity_2m', 8, 6, '#4af', {width:65, height:14}); }
  function sparkSolar() { return buildSparkline('shortwave_radiation', 8, 4, '#f90', {width:60, height:14}); }
  function sparkWindDir() { return buildSparkline('wind_direction_10m', 6, 4, '#aab', {width:55, height:14}); }
  function sparkWindSpeed() { return buildSparkline('windspeed_10m', 8, 6, '#78a0ff', {width:65, height:14}); }

  function buildObservingConditions(context) {
    var wx = window._wxCurrent;
    if (!wx) return '';
    var out = '';
    var isDark = (function(){ if (!wx.sunrise || !wx.sunset) return null; var now = new Date(); var sr = new Date(wx.sunrise); var ss = new Date(wx.sunset); return now < sr || now > ss; })();
    var clear = wx.cloudCover != null && wx.cloudCover < 25;
    var partlyCloudy = wx.cloudCover != null && wx.cloudCover >= 25 && wx.cloudCover < 60;
    var overcast = wx.cloudCover != null && wx.cloudCover >= 80;
    var goodVis = wx.visibility != null && wx.visibility > 8000;
    var foggy = wx.rh != null && wx.rh > 95 && wx.visibility != null && wx.visibility < 3000;
    var aq = window._aqData || {};
    var pm25 = aq.current ? aq.current.pm2_5 : null;

    out += '<div style="background:rgba(120,160,255,.06);border-radius:6px;padding:6px 8px;margin-top:6px;border-left:2px solid rgba(120,160,255,.4);">';
    out += '<div style="font-weight:600;font-size:.54rem;color:#78a0ff;margin-bottom:3px;">SKY CONDITIONS & OBSERVING QUALITY</div>';
    out += '<div style="display:grid;grid-template-columns:auto 1fr;gap:1px 8px;font-size:.50rem;">';
    if (wx.cloudCover != null) out += '<span style="opacity:.7;">Cloud cover:</span><span>' + wx.cloudCover + '%' + (clear ? ' <span style="color:#4f8;"> Clear</span>' : overcast ? ' <span style="color:#f44;"> Overcast</span>' : partlyCloudy ? ' <span style="color:#f90;"> Partly cloudy</span>' : '') + '</span>';
    //  Cloud layer breakdown for astronomers 
    if (wx.cloudLow != null || wx.cloudMid != null || wx.cloudHigh != null) {
      out += '</div>'; // close the grid temporarily
      out += buildCloudStackVisual(wx.cloudLow, wx.cloudMid, wx.cloudHigh);
      out += '<div style="display:grid;grid-template-columns:auto 1fr;gap:1px 8px;font-size:.50rem;">'; // reopen grid
      if (wx.cloudHigh > 40 && (wx.cloudLow || 0) < 15 && (wx.cloudMid || 0) < 15) out += '<span style="opacity:.7;">Note:</span><span style="color:#f90;">Cirrus dominant  dims faint objects but won\'t block bright targets</span>';
      else if ((wx.cloudLow || 0) > 60 && (wx.cloudMid || 0) < 20) out += '<span style="opacity:.7;">Note:</span><span style="color:#f44;">Low clouds/fog  ceiling likely &lt;3,000 ft, blocks all observing</span>';
      else if ((wx.cloudMid || 0) > 60 && (wx.cloudLow || 0) < 20) out += '<span style="opacity:.7;">Note:</span><span style="color:#f90;">Mid-level layer  partial obstruction, gaps may allow viewing</span>';
    }
    if (isDark != null) out += '<span style="opacity:.7;">Daylight:</span><span>' + (isDark ? '<span style="color:#4f8;">Dark  observing window open</span>' : '<span style="color:#f90;">Daylight  ' + context + ' not visible</span>') + '</span>';
    if (wx.visibility != null) { var vm = (wx.visibility * 0.000621371).toFixed(1); out += '<span style="opacity:.7;">Visibility:</span><span>' + vm + ' mi' + (goodVis ? '' : foggy ? ' <span style="color:#f44;">(foggy)</span>' : ' <span style="color:#f90;">(hazy)</span>') + '</span>'; }
    if (wx.precipProb != null && wx.precipProb > 40) out += '<span style="opacity:.7;">Precip prob:</span><span style="color:#f90;">' + wx.precipProb + '%  may interfere</span>';
    if (pm25 != null && pm25 >= 20) out += '<span style="opacity:.7;">Smoke/haze:</span><span>PM2.5 ' + pm25.toFixed(0) + ' g/m' + (pm25 >= 55 ? ' <span style="color:#f44;"> heavy smoke blocks faint objects</span>' : ' <span style="color:#f90;"> reduced transparency</span>') + '</span>';
    out += '</div>';

    //  Astronomical seeing & transparency visual meters 
    if (isDark || isDark === null) {
      var seeScore = 0; var transScore = 0;
      // Seeing (atmospheric stability)
      if (wx.wind != null) { if (wx.wind < 5) seeScore += 2; else if (wx.wind < 12) seeScore++; else if (wx.wind > 20) seeScore -= 2; else if (wx.wind > 15) seeScore--; }
      if (wx.tempTrend3hr != null) { if (Math.abs(wx.tempTrend3hr) < 1.5) seeScore += 2; else if (Math.abs(wx.tempTrend3hr) < 3) seeScore++; else seeScore--; }
      if (wx.pblHeight != null) { if (wx.pblHeight < 300) seeScore++; else if (wx.pblHeight > 1500) seeScore--; }
      // Transparency
      if (clear) transScore += 3; else if (wx.cloudCover < 15) transScore += 2; else if (wx.cloudCover < 40) transScore++;
      if (goodVis) transScore += 2; else if (wx.visibility > 5000) transScore++;
      if (wx.rh != null) { if (wx.rh < 50) transScore += 2; else if (wx.rh < 70) transScore++; else if (wx.rh > 85) transScore--; }
      if (pm25 != null) { if (pm25 < 12) transScore++; else if (pm25 > 35) transScore -= 2; else if (pm25 > 20) transScore--; }

      out += buildSeeingTransBars(seeScore, transScore);
    }

    // Verdict
    out += '<div style="font-size:.50rem;margin-top:3px;">';
    if (isDark && clear && goodVis) out += '<span style="color:#4f8;font-weight:600;"> Excellent observing conditions right now for ' + context + '.</span>';
    else if (isDark && clear) out += '<span style="color:#4f8;">Good observing conditions  dark and clear.</span>';
    else if (isDark && partlyCloudy) out += '<span style="color:#f90;">Partial clouds  look for gaps. ' + context + ' may be visible through breaks.</span>';
    else if (isDark && overcast) out += '<span style="color:#f44;">Overcast skies block ' + context + ' viewing. Monitor cloud cover forecast for clear windows.</span>';
    else if (isDark === false && clear) out += 'Clear skies but still daylight. ' + context + ' observing begins after sunset' + (wx.sunset ? ' (' + new Date(wx.sunset).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) + ' local)' : '') + '.';
    else if (isDark === false) out += 'Daylight + clouds. Check forecast for clear skies after dark for ' + context + ' viewing.';
    else out += 'Check cloud cover and darkness for observing feasibility.';
    out += '</div></div>';
    return out;
  }

  // 
  function buildSolarChain(stage) {
    var sw = window._swData || {};
    var out = '';
    var hasXray = sw.xrayClass != null;
    var hasAlerts = sw.spaceAlerts && sw.spaceAlerts.length > 0;
    var hasEvents = sw.solarEvents && sw.solarEvents.length > 0;

    //  Detect what's happening at each stage 
    var chain = {};

    // STAGE 1: Flare activity (X-ray flux)
    chain.flareActive = false;
    chain.flareClass = sw.xrayClass || null;
    chain.flarePeak = sw.xrayPeakClass || null;
    if (hasXray) {
      var fc = sw.xrayClass.charAt(0);
      if (fc === 'M' || fc === 'X') chain.flareActive = true;
    }
    // Check event reports for recent flares
    chain.recentFlares = [];
    chain.recentCMEs = [];
    chain.recentFilaments = [];
    if (hasEvents) {
      sw.solarEvents.forEach(function(ev) {
        if (/FLA|XRA/i.test(ev.type)) chain.recentFlares.push(ev);
        if (/CME/i.test(ev.type)) chain.recentCMEs.push(ev);
        if (/FIL|DSF/i.test(ev.type)) chain.recentFilaments.push(ev);
      });
    }
    // Check SWPC alerts for CME/flare notifications
    chain.cmeWatch = false;
    chain.flareAlert = false;
    chain.geomagWatch = false;
    if (hasAlerts) {
      sw.spaceAlerts.forEach(function(a) {
        if (a.type === 'cme') chain.cmeWatch = true;
        if (a.type === 'flare') chain.flareAlert = true;
        if (a.type === 'geomag') chain.geomagWatch = true;
      });
    }

    // STAGE 2: CME in progress
    chain.cmeDetected = chain.recentCMEs.length > 0 || chain.cmeWatch;

    // STAGE 3: Solar wind shows impact
    chain.impactInProgress = (sw.speed > 500 && sw.density > 8) || (sw.speed > 600 && sw.density > 5);
    chain.shockDetected = sw.speed > 600 && sw.density > 15;

    // STAGE 4: Geomagnetic response
    chain.stormActive = sw.kp != null && sw.kp >= 5;
    chain.substormLikely = sw.bz != null && sw.bz <= -10;
    chain.reconnectionActive = sw.bz != null && sw.bz <= -5;

    //  Determine the chain narrative based on which stage we're in 
    // Find the "hottest" stage
    var chainPhase = 'quiet';
    if (chain.stormActive || chain.shockDetected) chainPhase = 'impact';
    else if (chain.impactInProgress) chainPhase = 'arrival';
    else if (chain.cmeDetected && chain.flareActive) chainPhase = 'eruption';
    else if (chain.flareActive || chain.recentFlares.length > 0) chainPhase = 'flare';
    else if (chain.recentFilaments.length > 0) chainPhase = 'filament';

    // Don't show chain panel if nothing interesting
    if (chainPhase === 'quiet' && !hasXray) return '';

    out += '<div style="background:rgba(167,139,250,.08);border-radius:6px;padding:6px 8px;margin-top:6px;border-left:2px solid rgba(167,139,250,.5);">';
    out += '<div style="font-weight:600;font-size:.54rem;color:#a78bfa;margin-bottom:2px;"> SOLAR EVENT CHAIN</div>';

    // Visual chain status bar
    var stages = [
      { id: 'source', icon: '', label: 'Sun', active: chain.flareActive || chain.recentFlares.length > 0 },
      { id: 'eruption', icon: '', label: 'Flare/CME', active: chain.cmeDetected || chain.flareActive },
      { id: 'transit', icon: '', label: 'Transit', active: chain.cmeDetected && !chain.impactInProgress },
      { id: 'impact', icon: '', label: 'Impact', active: chain.impactInProgress || chain.shockDetected },
      { id: 'geomag', icon: '', label: 'Storm', active: chain.stormActive || chain.reconnectionActive },
      { id: 'aurora', icon: '', label: 'Aurora', active: chain.stormActive && sw.kp >= 5 }
    ];
    out += '<div style="display:flex;gap:2px;margin-bottom:5px;font-size:.44rem;">';
    stages.forEach(function(s) {
      var bg = s.active ? 'rgba(167,139,250,.3)' : 'rgba(255,255,255,.05)';
      var col = s.active ? '#a78bfa' : 'rgba(255,255,255,.35)';
      var glow = (s.id === stage) ? 'box-shadow:0 0 6px rgba(167,139,250,.5);' : '';
      var border = (s.id === stage) ? 'border:1px solid #a78bfa;' : 'border:1px solid transparent;';
      out += '<div style="flex:1;text-align:center;padding:2px 1px;border-radius:4px;background:' + bg + ';color:' + col + ';' + glow + border + '">';
      out += s.icon + '<br>' + s.label;
      out += '</div>';
    });
    out += '</div>';

    //  Stage-specific narrative 
    out += '<div style="font-size:.50rem;">';

    if (stage === 'source') {
      // SUVI / PFSS  what's the flare potential?
      if (hasXray) out += '<b>X-ray flux:</b> ' + sw.xrayClass + ' (6hr peak: ' + (sw.xrayPeakClass || '?') + '). ';
      if (chain.flareActive) {
        out += '<span style="color:#f90;">Active flaring detected. </span>';
        if (chain.recentFlares.length > 0) {
          var rf = chain.recentFlares[0];
          out += 'Recent: ' + (rf.classType || 'unknown class') + ' from region ' + (rf.region || '?') + '. ';
        }
        out += 'Watch for bright active regions  any complex ones near disk center could launch an Earth-directed CME. <b>Next step:</b> Check LASCO C2 for eruption within 30-60 min of a flare.';
      } else if (chain.recentFlares.length > 0) {
        var rf2 = chain.recentFlares[0];
        out += 'Recent flare: ' + (rf2.classType || '?') + ' from AR ' + (rf2.region || '?') + '. Region may still be capable of further activity. Monitor for increasing brightness/complexity on SUVI.';
      } else {
        out += 'No significant flaring. Look for bright yellow regions (active regions) on SUVI thematic map and complex closed-loop structures on PFSS. Sheared fields = higher flare potential.';
      }
      if (chain.recentFilaments.length > 0) {
        out += '<br><span style="color:#e67e22;">Filament eruption detected</span>  check LASCO for associated CME. Filaments carry massive plasma + magnetic field.';
      }
    }

    else if (stage === 'eruption') {
      // LASCO C2/C3  connecting flares to CMEs
      if (chain.flareActive || chain.recentFlares.length > 0) {
        if (hasXray) out += '<b>Current X-ray:</b> ' + sw.xrayClass + '. ';
        if (chain.recentFlares.length > 0) {
          var rf3 = chain.recentFlares[0];
          out += '<b>Source:</b> ' + (rf3.classType || '?') + ' flare from AR ' + (rf3.region || '?') + (rf3.location ? ' at ' + rf3.location : '') + '. ';
          if (rf3.location && /[NS]\d+[EW]\d+/i.test(rf3.location)) {
            var locMatch = rf3.location.match(/([EW])(\d+)/i);
            if (locMatch) {
              var dir = locMatch[1].toUpperCase();
              var deg = parseInt(locMatch[2]);
              if (dir === 'W' && deg < 45) out += '<span style="color:#f44;">EARTH-FACING  any CME from this location is aimed at us.</span> ';
              else if (dir === 'E' && deg < 30) out += '<span style="color:#f90;">Near disk center  moderate Earth-impact probability.</span> ';
              else if (deg > 60) out += 'Near the limb  CME likely directed away from Earth. ';
            }
          }
        }
        out += '<b>Look for:</b> Bright expanding arc/bubble in C2 within 30-60 min of flare. Halo CME (expands around entire disk) = aimed at Earth. Track into C3 for speed estimate.';
      }
      if (chain.cmeWatch) {
        out += '<br><span style="color:#f44;"> SWPC has issued a CME watch.</span> Check Enlil for modeled arrival time.';
      }
      if (chain.recentCMEs.length > 0) {
        out += '<br><b>Recent CMEs:</b> ' + chain.recentCMEs.length + ' in last 48hr. ';
      }
      if (!chain.flareActive && !chain.cmeDetected) {
        out += 'No active eruptions. Scan for faint expanding structures  slow CMEs can be hard to see but still impact Earth. Compare consecutive frames.';
      }
    }

    else if (stage === 'transit') {
      // Enlil  CME propagation
      if (chain.cmeDetected) {
        out += '<span style="color:#f90;"><b>CME in transit.</b></span> ';
        if (chain.recentFlares.length > 0) {
          var rf4 = chain.recentFlares[0];
          out += 'Source: ' + (rf4.classType || '?') + ' flare. ';
        }
        out += 'The Enlil model shows the CME as a bright blob propagating through the heliosphere. Track its leading edge toward the green dot (Earth). ';
        out += '<b>Arrival estimate:</b> Fast CMEs (>1000 km/s in LASCO) arrive in 15-24 hours. Moderate (500-1000) in 2-3 days. Slow (<500) in 3-4 days. ';
        out += '<b>Next step:</b> Watch DSCOVR real-time data for sudden speed/density jump = CME arrival at L1.';
      }
      if (chain.cmeWatch) {
        out += '<br><span style="color:#f44;">SWPC CME watch active  arrival expected within the next 24-48 hours based on Enlil modeling.</span>';
      }
      if (!chain.cmeDetected) {
        out += 'No CMEs currently tracked. The Enlil spiral pattern shows background solar wind. Coronal hole streams appear as fast-wind sectors (brighter colors) in the spiral.';
      }
    }

    else if (stage === 'impact') {
      // DSCOVR / Geospace  CME hitting Earth
      if (chain.shockDetected) {
        out += '<span style="color:#f44;"><b> INTERPLANETARY SHOCK DETECTED.</b> Speed ' + (sw.speed || '?') + ' km/s, density ' + (sw.density ? sw.density.toFixed(1) : '?') + ' p/cm. This is likely a CME impact. </span>';
        out += 'The magnetosphere is being compressed. ';
        if (chain.reconnectionActive) out += '<span style="color:#f44;">Bz is strongly south (' + sw.bz.toFixed(1) + ' nT)  <b>magnetic reconnection active</b>. Energy pouring into magnetosphere. Expect rapid aurora intensification.</span>';
        else if (sw.bz > 0) out += 'Bz is currently north  magnetosphere holding. If Bz turns south in the CME magnetic cloud (often happens hours after initial shock), aurora will erupt rapidly.';
      } else if (chain.impactInProgress) {
        out += '<b>Elevated solar wind:</b> Speed ' + (sw.speed || '?') + ' km/s. ';
        if (sw.density > 8) out += 'High density (' + sw.density.toFixed(1) + ' p/cm) suggests CME material or CIR compression. ';
        if (chain.reconnectionActive) out += 'Bz south (' + sw.bz.toFixed(1) + ' nT)  aurora likely at Kp ' + (sw.kp || '?') + '.';
      }
      if (chain.flareActive) {
        out += '<br><b>Upstream:</b> Active flaring continues. Additional CMEs could compound the current event.';
      }
    }

    else if (stage === 'geomag') {
      // Magnetosphere response
      if (chain.stormActive) {
        out += '<span style="color:#f44;"><b>GEOMAGNETIC STORM IN PROGRESS</b> (Kp ' + sw.kp.toFixed(1) + ', ' + (sw.gScale || '?') + '). </span>';
        if (chain.shockDetected) out += 'Driven by CME impact. ';
        else if (sw.speed > 500) out += 'Driven by high-speed solar wind. ';
        if (chain.reconnectionActive) out += 'Active reconnection (Bz ' + sw.bz.toFixed(1) + ' nT)  substorm breakups producing bright aurora.';
      } else if (chain.reconnectionActive) {
        out += 'Bz is southward (' + sw.bz.toFixed(1) + ' nT)  magnetic energy loading into magnetotail. Substorm aurora likely even without formal storm threshold.';
      }
      if (chain.geomagWatch) out += '<br><span style="color:#f90;">SWPC geomagnetic storm watch active.</span>';
    }

    else if (stage === 'aurora') {
      // Aurora  the end result
      if (chain.stormActive) {
        out += '<b>Storm driving aurora:</b> ';
        if (chain.shockDetected) out += 'CME impact  ';
        else if (sw.speed > 500) out += 'Fast solar wind  ';
        if (chain.reconnectionActive) out += 'Reconnection active  ';
        out += 'Kp ' + sw.kp.toFixed(1) + ' (' + (sw.gScale || '?') + '). ';
        out += 'The entire chain is active from source to aurora.';
      }
      if (chain.cmeWatch && !chain.stormActive) {
        out += 'CME approaching  aurora possible when it arrives. Watch DSCOVR for the speed/density jump.';
      }
      if (chain.flareActive && !chain.stormActive && !chain.cmeWatch) {
        out += 'Active flaring on the Sun. If an Earth-directed CME was launched, aurora could follow in 1-3 days. Check LASCO and Enlil.';
      }
    }

    else {
      // Quiet  still show X-ray level as baseline monitoring
      if (hasXray) {
        out += '<b>X-ray background:</b> ' + sw.xrayClass + ' (6hr peak: ' + (sw.xrayPeakClass || '?') + '). ';
        var fc2 = (sw.xrayClass || 'A').charAt(0);
        if (fc2 === 'C') out += 'Low-level C-class activity  minor active regions present. Watch for escalation to M-class.';
        else if (fc2 === 'B' || fc2 === 'A') out += 'Background level. No significant activity. Good time to learn the baseline appearance of each widget.';
      }
    }

    out += '</div></div>';
    return out;
  }

  //  LIVE INJECTION: LASCO C2/C3 
  function injectLiveLascoData(popup) {
    var sw = window._swData;
    if (!sw) return;
    var live = '<div style="background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;margin:10px 0;border-left:3px solid ';
    var speed = sw.speed, bz = sw.bz, den = sw.density, kp = sw.kp;

    // Assess CME arrival state
    var cmeArrival = false;
    if (speed > 600 && den > 10) cmeArrival = true;
    var col = cmeArrival ? '#f44' : (speed > 500 ? '#f90' : '#4a9');
    var label = cmeArrival ? 'POSSIBLE CME IN PROGRESS' : (speed > 500 ? 'ELEVATED SOLAR WIND' : 'QUIET');

    live += col + ';">';
    live += '<div style="font-weight:700;font-size:.62rem;color:' + col + ';margin-bottom:2px;"> REAL-TIME SPACE WEATHER  ' + label + '</div>';
    live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.52rem;">';
    if (speed != null) live += '<span style="opacity:.7;">Solar wind:</span><span>' + speed + ' km/s</span>';
    if (den != null) live += '<span style="opacity:.7;">Density:</span><span>' + den.toFixed(1) + ' p/cm</span>';
    if (bz != null) live += '<span style="opacity:.7;">IMF Bz:</span><span>' + (bz >= 0 ? '+' : '') + bz.toFixed(1) + ' nT</span>';
    if (kp != null) live += '<span style="opacity:.7;">Kp index:</span><span>' + kp.toFixed(1) + '</span>';
    live += '</div>';

    if (cmeArrival) {
      live += '<div style="color:#f44;font-size:.52rem;margin-top:4px;"> High speed + elevated density suggests a CME or strong CIR may be impacting Earth now. Look at the coronagraph for any halo CMEs in the last 1-3 days that could be the source. Check Enlil for arrival confirmation.</div>';
    } else if (speed > 500) {
      live += '<div style="font-size:.52rem;margin-top:4px;">Solar wind speed is elevated  likely a coronal hole high-speed stream or CME glancing blow. Watch for new CMEs in the coronagraph expanding toward Earth. Any halo CME you see now would arrive in 1-3 days.</div>';
    } else {
      live += '<div style="font-size:.52rem;margin-top:4px;">Background solar wind is nominal. Any new CMEs visible in the coronagraph would take 1-4 days to reach Earth depending on speed. Fast halo CMEs (crossing the C3 field in <1 hour) can arrive in under 24 hours.</div>';
    }
    live += '</div>';
    // Cross-reference: if a CME is in progress or solar wind elevated, note aurora potential + sky conditions
    if (cmeArrival || speed > 500) {
      live += buildObservingConditions('aurora from CME/solar wind impact');
    }
    live += buildSolarChain('eruption');

    var html = popup.innerHTML;
    var insertAfter = html.indexOf('Update cadence:');
    if (insertAfter > 0) {
      var lineEnd = html.indexOf('.', insertAfter);
      if (lineEnd > 0) {
        popup.innerHTML = html.substring(0, lineEnd + 1) + '<br><br>' + live + html.substring(lineEnd + 1);
        return;
      }
    }
    popup.innerHTML = html + '<br><br>' + live;
  }

  //  LIVE INJECTION: SDO PFSS 
  function injectLivePfssData(popup) {
    var sw = window._swData;
    if (!sw) return;
    var live = '<div style="background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;margin:10px 0;border-left:3px solid ';
    var speed = sw.speed, kp = sw.kp;
    var chStream = speed > 500;

    var col = chStream ? '#f90' : '#4a9';
    live += col + ';">';
    live += '<div style="font-weight:700;font-size:.62rem;color:' + col + ';margin-bottom:2px;"> CORONAL HOLE WIND CHECK  ' + (chStream ? 'ELEVATED WIND DETECTED' : 'BACKGROUND') + '</div>';
    live += '<div style="font-size:.52rem;">';
    if (speed != null) live += 'Current solar wind: <b>' + speed + ' km/s</b>. ';
    if (chStream) {
      live += 'Elevated speed suggests a <span class="k">coronal hole high-speed stream (CH HSS)</span> is currently reaching Earth. Look for large dark regions with open (green) field lines near or just past disk center on the PFSS image  that\'s likely the source. ';
      live += 'This stream will persist for 2-3 days as the coronal hole rotates past Earth\'s connection point on the Parker spiral.';
    } else {
      live += 'No coronal hole stream detected. Look for dark regions with green/magenta open field lines on the image. If a large coronal hole with green (Earth-directed) lines is approaching disk center, expect elevated solar wind in 2-4 days.';
    }
    if (kp != null && kp >= 4) live += '<br><br>Current Kp ' + kp.toFixed(1) + ' indicates active geomagnetic conditions  likely driven by what you see on this chart.';
    live += '</div></div>';
    if (chStream || (kp != null && kp >= 4)) {
      live += buildObservingConditions('aurora from coronal hole stream');
    }
    live += buildSolarChain('source');

    var html = popup.innerHTML;
    popup.innerHTML = html + '<br><br>' + live;
  }

  //  LIVE INJECTION: SUVI 
  function injectLiveSuviData(popup) {
    var sw = window._swData;
    if (!sw) return;
    var live = '<div style="background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;margin:10px 0;border-left:3px solid ';
    var kp = sw.kp, speed = sw.speed, bz = sw.bz;
    var geoActive = kp != null && kp >= 4;

    var col = geoActive ? '#f90' : '#4a9';
    live += col + ';">';
    live += '<div style="font-weight:700;font-size:.62rem;color:' + col + ';margin-bottom:2px;"> SOLAR ACTIVITY STATUS</div>';
    live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.52rem;">';
    if (kp != null) live += '<span style="opacity:.7;">Kp index:</span><span>' + kp.toFixed(1) + ' (' + sw.gScale + ')</span>';
    if (speed != null) live += '<span style="opacity:.7;">Solar wind:</span><span>' + speed + ' km/s</span>';
    if (bz != null) live += '<span style="opacity:.7;">IMF Bz:</span><span>' + (bz >= 0 ? '+' : '') + bz.toFixed(1) + ' nT</span>';
    live += '</div>';
    live += '<div style="font-size:.52rem;margin-top:4px;">';
    if (geoActive) {
      live += 'Geomagnetic activity elevated. Cross-reference with the thematic map: <b style="color:#2ecc71;">green regions (coronal holes)</b> near disk center likely driving the current wind, and <b style="color:#f1c40f;">yellow regions (active regions)</b> could produce flares that create additional CMEs.';
    } else {
      live += 'Quiet conditions. Monitor <b style="color:#f1c40f;">yellow/bright regions</b> for flare potential and <b style="color:#2ecc71;">green regions</b> approaching disk center for upcoming CH HSS activity. <b style="color:#e67e22;">Orange prominences</b> on the limb could erupt as CMEs.';
    }
    live += '</div></div>';
    if (geoActive) {
      live += buildObservingConditions('aurora from active solar conditions');
    }
    live += buildSolarChain('source');

    var html = popup.innerHTML;
    popup.innerHTML = html + '<br><br>' + live;
  }

  //  LIVE INJECTION: WSA-ENLIL 
  function injectLiveEnlilData(popup) {
    var sw = window._swData;
    if (!sw) return;
    var live = '<div style="background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;margin:10px 0;border-left:3px solid ';
    var speed = sw.speed, den = sw.density, bz = sw.bz, kp = sw.kp, bt = sw.bt;

    // Dynamic pressure = 1.6726e-6 * density * speed^2 (in nPa when density in p/cm, speed in km/s)
    var dynPres = (speed != null && den != null) ? (1.6726e-6 * den * speed * speed).toFixed(1) : null;
    var isDisturbed = (speed > 500 && den > 8) || (kp != null && kp >= 5);

    var col = isDisturbed ? '#f44' : (speed > 450 ? '#f90' : '#4a9');
    live += col + ';">';
    live += '<div style="font-weight:700;font-size:.62rem;color:' + col + ';margin-bottom:2px;"> MEASURED vs MODELED  DSCOVR L1 DATA</div>';
    live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.52rem;">';
    if (speed != null) live += '<span style="opacity:.7;">Measured speed:</span><span>' + speed + ' km/s</span>';
    if (den != null) live += '<span style="opacity:.7;">Measured density:</span><span>' + den.toFixed(1) + ' p/cm</span>';
    if (dynPres) live += '<span style="opacity:.7;">Dynamic pressure:</span><span>' + dynPres + ' nPa</span>';
    if (bt != null) live += '<span style="opacity:.7;">IMF Bt:</span><span>' + bt.toFixed(1) + ' nT (total field)</span>';
    if (bz != null) live += '<span style="opacity:.7;">IMF Bz:</span><span>' + (bz >= 0 ? '+' : '') + bz.toFixed(1) + ' nT</span>';
    live += '</div>';
    live += '<div style="font-size:.52rem;margin-top:4px;">';
    live += '<b>Compare these measured values with the Enlil model\'s prediction:</b> ';
    if (isDisturbed) {
      live += 'Current conditions are disturbed  either a CME impact or strong CIR is hitting Earth. The Enlil animation should show a bright structure at Earth\'s position right now. If it doesn\'t, the model missed this event or underpredicted its strength. ';
      if (bz != null && bz <= -10) live += '<br><span style="color:#f44;">Bz is strongly southward  remember Enlil does NOT predict Bz. The actual storm impact is more severe than the model could have shown.</span>';
    } else {
      live += 'Conditions are relatively quiet. Compare with Enlil to see if any structures (CMEs or CIRs) are approaching Earth in the coming hours/days. The model\'s speed and density predictions should roughly match these measured values during quiet periods.';
    }
    live += '</div></div>';
    if (isDisturbed) {
      live += buildObservingConditions('aurora during geomagnetic disturbance');
    }
    live += buildSolarChain('transit');

    var html = popup.innerHTML;
    var insertAfter = html.indexOf('Update cadence:');
    if (insertAfter > 0) {
      var lineEnd = html.indexOf('.', insertAfter);
      if (lineEnd > 0) {
        popup.innerHTML = html.substring(0, lineEnd + 1) + '<br><br>' + live + html.substring(lineEnd + 1);
        return;
      }
    }
    popup.innerHTML = html + '<br><br>' + live;
  }

  //  LIVE INJECTION: GEOSPACE MAGNETOSPHERE 
  function injectLiveGeoData(popup) {
    var sw = window._swData;
    if (!sw) return;
    var live = '<div style="background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;margin:10px 0;border-left:3px solid ';
    var speed = sw.speed, den = sw.density, bz = sw.bz, kp = sw.kp, bt = sw.bt;
    var dynPres = (speed != null && den != null) ? (1.6726e-6 * den * speed * speed) : null;

    // Estimate magnetopause standoff distance (Shue et al. 1998 simplified)
    var mpDist = null;
    if (dynPres != null && dynPres > 0) {
      mpDist = (11.4 * Math.pow(dynPres, -1/6.6)).toFixed(1);
    }

    var isStorm = kp != null && kp >= 5;
    var isSubstorm = bz != null && bz <= -5 && speed > 400;
    var col = isStorm ? '#f44' : (isSubstorm ? '#f90' : '#4a9');
    var label = isStorm ? 'GEOMAGNETIC STORM' : (isSubstorm ? 'SUBSTORM LIKELY' : 'QUIET');

    live += col + ';">';
    live += '<div style="font-weight:700;font-size:.62rem;color:' + col + ';margin-bottom:2px;"> MAGNETOSPHERE STATUS  ' + label + '</div>';
    live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.52rem;">';
    if (speed != null) live += '<span style="opacity:.7;">Solar wind:</span><span>' + speed + ' km/s</span>';
    if (dynPres != null) live += '<span style="opacity:.7;">Ram pressure:</span><span>' + dynPres.toFixed(1) + ' nPa</span>';
    if (mpDist) live += '<span style="opacity:.7;">Est. magnetopause:</span><span>~' + mpDist + ' R<sub>E</sub> ' + (parseFloat(mpDist) < 7 ? '<span style="color:#f44;">(SEVERELY COMPRESSED)</span>' : parseFloat(mpDist) < 9 ? '<span style="color:#f90;">(compressed)</span>' : '<span style="color:#4f8;">(normal)</span>') + '</span>';
    if (bz != null) live += '<span style="opacity:.7;">IMF Bz:</span><span>' + (bz >= 0 ? '+' : '') + bz.toFixed(1) + ' nT ' + (bz <= -10 ? '<span style="color:#f44;">(reconnecting)</span>' : bz <= -5 ? '<span style="color:#f90;">(coupling)</span>' : bz >= 0 ? '<span style="color:#4f8;">(shielded)</span>' : '') + '</span>';
    if (kp != null) live += '<span style="opacity:.7;">Kp:</span><span>' + kp.toFixed(1) + ' (' + sw.gScale + ')</span>';
    live += '</div>';
    live += '<div style="font-size:.52rem;margin-top:4px;">';
    if (isStorm) {
      live += '<b>What to see in the simulation:</b> Look for strong dayside compression (magnetopause pushed close to Earth on the sunward/left side) and an energized, glowing magnetotail on the nightside. The velocity plot should show intense red tones in the magnetosheath. ';
      if (bz != null && bz <= -10) live += 'With Bz strongly south, magnetic reconnection is opening the dayside magnetopause  energy is flooding into the system. Expect substorm aurora breakups on the nightside.';
    } else if (isSubstorm) {
      live += '<b>What to see in the simulation:</b> Watch the magnetotail (right side). Southward Bz is loading energy into the tail, stretching it thin. When it snaps back (tail reconnection), you\'ll see a sudden brightening and contraction  that\'s a substorm onset, which produces rapid aurora intensification at high latitudes.';
    } else {
      live += '<b>What to see in the simulation:</b> Conditions are relatively quiet. The bow shock should be at a normal standoff distance (~13-15 R<sub>E</sub>), the magnetopause at ~10 R<sub>E</sub>, and the tail should be relaxed. Compare: during storms, the bow shock can be pushed in to ~8 R<sub>E</sub> and the magnetopause to ~6 R<sub>E</sub>.';
    }
    live += '</div></div>';
    if (isStorm || isSubstorm) {
      live += buildObservingConditions('aurora from magnetospheric activity');
    }
    live += buildSolarChain('geomag');

    var html = popup.innerHTML;
    var insertAfter = html.indexOf('Update cadence:');
    if (insertAfter > 0) {
      var lineEnd = html.indexOf('.', insertAfter);
      if (lineEnd > 0) {
        popup.innerHTML = html.substring(0, lineEnd + 1) + '<br><br>' + live + html.substring(lineEnd + 1);
        return;
      }
    }
    popup.innerHTML = html + '<br><br>' + live;
  }

  function injectLiveAuroraData(popup) {
    var kpEl = document.getElementById('sw-kp');
    var bzEl = document.getElementById('sw-bz');
    var windEl = document.getElementById('sw-wind');
    var gEl = document.getElementById('sw-g');
    var visEl = document.getElementById('sw-vis');
    var kpStr = kpEl ? kpEl.textContent.trim() : '--';
    var bzStr = bzEl ? bzEl.textContent.trim() : '--';
    var windStr = windEl ? windEl.textContent.trim() : '--';
    var gStr = gEl ? gEl.textContent.trim() : '--';
    var visStr = visEl ? visEl.textContent.trim() : '--';
    var kpNum = parseFloat(kpStr);
    var bzNum = parseFloat(bzStr);
    var windNum = parseFloat(windStr);

    // Build live conditions banner
    var live = '<div style="background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;margin-bottom:10px;border-left:3px solid ';

    // Color based on conditions
    var condColor = '#4a9';
    var condLabel = 'Quiet';
    var condDetail = 'Minimal geomagnetic activity. Aurora confined to high latitudes (>65N).';
    if (!isNaN(kpNum)) {
      if (kpNum >= 7) { condColor = '#e44'; condLabel = 'Severe Storm'; condDetail = 'Aurora visible at mid-latitudes (4050N). Check for naked-eye visibility even from suburbs.'; }
      else if (kpNum >= 5) { condColor = '#f90'; condLabel = 'Geomagnetic Storm'; condDetail = gStr + ' storm in progress. Aurora oval expanding equatorward. Dark sky sites at 5055N+ should look north.'; }
      else if (kpNum >= 4) { condColor = '#cc0'; condLabel = 'Active'; condDetail = 'Elevated activity. Aurora possible from dark locations at 5560N.'; }
      else if (kpNum >= 2) { condColor = '#4a9'; condLabel = 'Unsettled'; condDetail = 'Normal background activity. Aurora limited to latitudes above 65N.'; }
    }

    live += condColor + ';">';
    live += '<div style="font-weight:700;font-size:.62rem;color:' + condColor + ';margin-bottom:2px;"> CURRENT CONDITIONS  ' + condLabel.toUpperCase() + '</div>';
    live += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:5px;">';
    live += '<span><b>Kp:</b> ' + kpStr + '</span>';
    live += '<span><b>G:</b> ' + gStr + '</span>';
    live += '<span><b>Bz:</b> ' + bzStr + '</span>';
    live += '<span><b>Wind:</b> ' + windStr + '</span>';
    live += '<span><b>Vis:</b> ' + visStr + '</span>';
    live += '</div>';

    // Bz interpretation
    if (!isNaN(bzNum)) {
      if (bzNum <= -10) live += '<div style="color:#f90;font-size:.52rem;"> Bz is strongly southward  magnetic reconnection is active. Energy is pouring into Earth\'s magnetosphere. Prime aurora conditions.</div>';
      else if (bzNum <= -5) live += '<div style="font-size:.52rem;">Bz is moderately southward  some magnetic coupling occurring. Aurora enhancement possible if sustained.</div>';
      else if (bzNum < 0) live += '<div style="font-size:.52rem;">Bz is weakly southward  marginal coupling. Minor aurora enhancement at best.</div>';
      else live += '<div style="font-size:.52rem;">Bz is northward (positive)  Earth\'s magnetic shield is closed. Even with high Kp, aurora will be muted until Bz turns south.</div>';
    }

    // Wind interpretation  
    if (!isNaN(windNum)) {
      if (windNum >= 700) live += '<div style="color:#f90;font-size:.52rem;margin-top:2px;"> Solar wind speed is very fast (' + windStr + ')  consistent with CME arrival or strong coronal hole stream.</div>';
      else if (windNum >= 500) live += '<div style="font-size:.52rem;margin-top:2px;">Solar wind elevated (' + windStr + ')  coronal hole stream or CME influence likely.</div>';
    }

    // Location-specific note
    var lat = LOCATION ? LOCATION.lat : 40.7;
    var minKpNeeded = lat >= 60 ? 2 : lat >= 55 ? 4 : lat >= 50 ? 5 : lat >= 45 ? 6 : lat >= 40 ? 7 : 8;
    live += '<div style="font-size:.52rem;margin-top:4px;opacity:.8;">At your latitude (' + lat.toFixed(1) + 'N), visible aurora typically requires Kp  ' + minKpNeeded + '. ';
    if (!isNaN(kpNum)) {
      if (kpNum >= minKpNeeded) live += '<b style="color:#4f8;">Current Kp meets your threshold  check for clear dark skies!</b>';
      else live += 'Current Kp is ' + (minKpNeeded - kpNum).toFixed(0) + ' point' + (minKpNeeded - kpNum > 1 ? 's' : '') + ' below your threshold.';
    }
    live += '</div></div>';
    // Aurora is THE most important popup for observing conditions cross-reference
    live += buildObservingConditions('aurora');
    try { live += buildTonightsTargets(); } catch(e){ console.error('buildTonightsTargets error:', e); }
    try { live += buildSolarChain('aurora'); } catch(e){ console.error('buildSolarChain error:', e); }

    // Find the first <br> after opening <b> tag and insert live data after the source line
    var existingHTML = popup.innerHTML;
    var sourceEnd = existingHTML.indexOf('DSCOVR satellite at L1.');
    if (sourceEnd > 0) {
      var insertAt = existingHTML.indexOf('<br><br>', sourceEnd);
      if (insertAt > 0) {
        popup.innerHTML = existingHTML.substring(0, insertAt) + '<br><br>' + live + existingHTML.substring(insertAt + 8);
        return;
      }
    }
    // Fallback: prepend
    popup.innerHTML = live + existingHTML;
  }
  // Close on outside click
  document.addEventListener('click', function(e){
    if (!e.target.closest('.space-info-popup') && !e.target.closest('.space-info-btn')){
      document.querySelectorAll('.space-info-popup.active').forEach(function(p){ p.classList.remove('active'); });
    }
  });
  window.toggleSpacePopup = toggleSpacePopup;

  // ============= RADAR PRODUCT INFO TOOLTIPS =============
  var radarInfoData = {
    // PRODUCTS - RIGHT PANEL
    'fcast-tab-sim': '<b>Simulated Composite Reflectivity</b><br><br><span class="k">What it shows:</span> Model-predicted radar returns as if you were looking at a real radar display. The model simulates what the national radar composite would look like at each forecast hour by calculating expected precipitation intensity, type, and vertical structure.<br><br><span class="k">How to read it:</span> Same dBZ color scale as live radar. <b>Green (20-35 dBZ)</b> = light to moderate rain. <b>Yellow (35-45)</b> = moderate to heavy. <b>Orange/Red (45-60)</b> = heavy rain, small hail possible. <b>Magenta/Pink (60-70)</b> = severe  large hail, damaging winds likely. <b>Purple/White (70+)</b> = extreme, destructive hail.<br><br><span class="k">Why it matters:</span> This is your primary forecast radar product  it tells you <b>where and when</b> precipitation will occur. Compare it with live radar to see how well the model is performing, then trust or discount the later forecast hours accordingly.<br><br><span class="k">Best for:</span> General precipitation timing, storm cell tracking, travel planning.',

    'fcast-tab-maxref': '<b>Maximum Reflectivity (Column Max)</b><br><br><span class="k">What it shows:</span> The highest reflectivity value found anywhere in the vertical column above each point. While composite reflectivity shows the overall picture, max reflectivity captures the most intense returns at any altitude.<br><br><span class="k">How to read it:</span> Same dBZ scale. Values will often be <b>higher than composite</b> because it picks up elevated cores  strong updrafts lofting precipitation aloft that hasn\'t reached the surface yet.<br><br><span class="k">Why it matters:</span> Elevated high reflectivity (50+ dBZ) at altitude = <b>strong updraft = hail production zone</b>. Even if surface reflectivity is moderate, high column-max values indicate severe potential. This is how meteorologists identify hail cores before damage reports come in.<br><br><span class="k">Best for:</span> Severe weather assessment, hail detection, identifying storm intensity.',

    'fcast-tab-radar1km': '<b>1km AGL Reflectivity</b><br><br><span class="k">What it shows:</span> Predicted radar reflectivity at exactly 1 kilometer above ground level. Unlike composite (which looks at all altitudes), this shows what\'s happening near the surface.<br><br><span class="k">How to read it:</span> Standard dBZ colors. Values here represent precipitation that is <b>actually reaching the ground</b> or very close to it, not elevated returns from high in the cloud.<br><br><span class="k">Why it matters:</span> Eliminates the "virga problem"  precipitation that shows on composite radar but evaporates before reaching the surface. What you see here is what you\'ll actually feel. Also better for detecting shallow precipitation like drizzle, freezing rain, and lake-effect snow bands that don\'t extend high into the atmosphere.<br><br><span class="k">Best for:</span> Surface precipitation accuracy, winter weather, shallow convection, lake-effect snow.',

    'fcast-tab-echotop': '<b>Echo Top Height</b><br><br><span class="k">What it shows:</span> The altitude (in thousands of feet) of the highest detectable radar echo above each point  essentially, how tall the storms are.<br><br><span class="k">How to read it:</span> Taller values = stronger storms. Typical rain showers: 15,000-25,000 ft. Moderate thunderstorms: 30,000-40,000 ft. Severe thunderstorms: 40,000-55,000 ft. Supercells: 50,000-65,000+ ft. Echo tops penetrating the tropopause (the boundary between troposphere and stratosphere) indicate <b>extreme updraft strength</b>.<br><br><span class="k">Why it matters:</span> Echo top height is directly proportional to updraft intensity. A storm pushing 55,000+ ft is almost certainly severe. Overshooting tops (punching above the surrounding anvil) are a classic signature of supercells and tornado producers. Rapidly rising echo tops = storm is intensifying. Collapsing tops = storm is weakening or may produce a downburst.<br><br><span class="k">Best for:</span> Storm severity assessment, aviation hazards, supercell identification.',

    'fcast-tab-ptype': '<b>Precipitation Type</b><br><br><span class="k">What it shows:</span> Model-predicted precipitation phase at the surface  whether what\'s falling is rain, snow, freezing rain, sleet (ice pellets), or a mix. This is determined by the model\'s vertical temperature profile at each grid point.<br><br><span class="k">How to read it:</span> Color-coded by type. <b>Green</b> = rain. <b>Blue</b> = snow. <b>Pink/Red</b> = freezing rain (ice storm). <b>Orange/Yellow</b> = sleet/ice pellets. Mixed zones show where the rain/snow line is transitional.<br><br><span class="k">Why it matters:</span> The <b>single most impactful winter weather product</b>. A 1" rain event is unremarkable; the same moisture as freezing rain is catastrophic (ice storms down power lines, trees, make roads impassable). Small temperature differences (1-2F) in the boundary layer determine the type. Watch where the rain/snow line sets up relative to your location.<br><br><span class="k">Best for:</span> Winter storm planning, freezing rain risk, rain/snow line positioning.',

    'fcast-tab-ptot': '<b>Total Accumulated Precipitation</b><br><br><span class="k">What it shows:</span> The running total of all liquid-equivalent precipitation from the model initialization time to each forecast hour. Includes rain, melted snow, and all other precipitation types combined.<br><br><span class="k">How to read it:</span> Measured in inches (liquid equivalent). The map builds over time  each frame shows the cumulative total, not the instantaneous rate. Darker/warmer colors = higher totals.<br><br><span class="k">Why it matters:</span> This is your <b>storm total QPF</b> (Quantitative Precipitation Forecast). It tells you how much total precipitation to expect from an event. Critical for flood forecasting  compare totals against flash flood guidance values for your area. Totals of 2-3"+ in a few hours can cause urban flooding. 4-6"+ over a day can cause river flooding.<br><br><span class="k">Best for:</span> Flood risk, total storm impact, water resource planning.',

    'fcast-tab-precip1hr': '<b>1-Hour Precipitation</b><br><br><span class="k">What it shows:</span> The amount of precipitation expected to fall in each individual 1-hour window. Unlike totals (which accumulate), this shows the <b>instantaneous rate</b> of rainfall.<br><br><span class="k">How to read it:</span> Inches per hour. 0.10-0.30"/hr = light to moderate rain. 0.30-0.50" = moderate to heavy. 0.50-1.0" = heavy rain, minor flooding possible. 1.0"+ = torrential, flash flood threat. 2.0"+ = extreme, life-threatening flash flooding.<br><br><span class="k">Why it matters:</span> Rain rate determines <b>flash flood risk</b> more than total accumulation. Urban drainage systems typically handle ~0.50"/hr. Anything above overwhelms them. Also critical for identifying when the heaviest rain will hit  you might see 3" total but knowing it falls in 1 hour vs 12 hours is the difference between a flood and a regular rain day.<br><br><span class="k">Best for:</span> Flash flood timing, peak rainfall intensity, event planning.',

    'fcast-tab-precip6hr': '<b>6-Hour Precipitation</b><br><br><span class="k">What it shows:</span> Accumulated precipitation over each 6-hour window. A middle ground between instantaneous rates and storm totals.<br><br><span class="k">How to read it:</span> Inches per 6-hour period. This matches the traditional NWS QPF interval and is directly comparable to flash flood guidance values, which are also issued in 6-hour windows.<br><br><span class="k">Why it matters:</span> The <b>standard operational QPF interval</b> used by NWS forecasters. Flash flood guidance (FFG) maps use 6-hour thresholds  when model 6-hr QPF exceeds FFG, flash flooding is expected. This is how the NWS issues flash flood watches.<br><br><span class="k">Best for:</span> Flash flood watch criteria, comparing against NWS guidance.',

    'fcast-tab-precip24hr': '<b>24-Hour Precipitation</b><br><br><span class="k">What it shows:</span> Accumulated precipitation over each rolling 24-hour period. Smooths out short-term variability to show the broader precipitation pattern.<br><br><span class="k">Why it matters:</span> Matches daily climate reporting intervals. Useful for comparing against daily precipitation records, drought monitoring, and agricultural planning. Also the standard interval for river flood forecasting  river crests depend on 24-hour basin-wide totals.<br><br><span class="k">Best for:</span> River flooding, daily planning, climate comparison.',

    'fcast-tab-snow': '<b>Snow Accumulation</b><br><br><span class="k">What it shows:</span> Predicted snowfall depth on the ground, converted from liquid equivalent using snow-to-liquid ratios (SLR). A 10:1 ratio is typical (1" of liquid = 10" of snow), but ratios vary: cold dry snow can be 15-20:1 (fluffy), warm wet snow can be 5-8:1 (heavy, packable).<br><br><span class="k">How to read it:</span> Inches of snow accumulation. Models typically use a fixed or temperature-dependent SLR. Light blue/white shading increases with depth. Pay attention to sharp gradients  the rain/snow line can produce zero accumulation on one side and 12"+ on the other within just 10-20 miles.<br><br><span class="k">Why it matters:</span> Direct impact planning  school closures, travel disruptions, infrastructure stress. 4-6" = significant travel impacts. 8-12"+ = potential roof loads, power outages from wet snow on trees/lines. Banding features (narrow strips of heavy snow) are common in nor\'easters and can produce 2-3"/hr rates.<br><br><span class="k">Best for:</span> Winter storm preparation, travel decisions, snow day forecasting.',

    'fcast-tab-cape': '<b>Precipitable Water / CAPE</b><br><br><span class="k">CAPE (hires models):</span> Convective Available Potential Energy  the total energy available to a rising air parcel, measured in J/kg. <b>0-500</b> = marginal instability. <b>500-1,500</b> = moderate. <b>1,500-3,000</b> = high. <b>3,000+</b> = extreme. High CAPE = fuel for thunderstorms. Combined with wind shear, high CAPE drives severe weather.<br><br><span class="k">Precipitable Water (GFS/global):</span> The total water vapor content in a vertical column of atmosphere, expressed as depth (inches) if all vapor condensed. Normal: 0.5-1.0". Moist: 1.0-1.5". Tropical: 1.5-2.0"+. Extremely anomalous: 2.5"+. High PWAT = high flood potential per inch of forcing.<br><br><span class="k">Why it matters:</span> CAPE tells you <b>how explosive storms can be</b>  it\'s the fuel gauge for convection. PWAT tells you <b>how much water is available</b>  the flood potential gauge. Together they paint the severe/flood picture.',

    'fcast-tab-bestcape': '<b>Best CAPE  Maximum Instability Analysis</b><br><br><span class="k">What it shows:</span> The "Best" or "Most Unstable" CAPE  calculated by finding the air parcel in the lowest 300mb of atmosphere with the <b>highest equivalent potential temperature</b> and lifting it to get maximum CAPE. This is more aggressive than surface-based CAPE (SBCAPE).<br><br><span class="k">Why it differs from surface CAPE:</span> Surface CAPE uses air at ground level. If a cap (warm layer aloft) exists, surface air may have zero CAPE. But elevated parcels above the cap can have significant CAPE  meaning storms initiated by a front or outflow boundary can tap this elevated instability. Best CAPE captures this.<br><br><span class="k">Thresholds:</span> <b>500-1,000 J/kg</b> = weak storms. <b>1,000-2,500</b> = strong thunderstorms. <b>2,500-4,000</b> = severe potential. <b>4,000+</b> = extreme  violent storms, large hail, strong tornadoes possible. Overlap zones where CAPE >2,500 AND shear >40 kt are your prime severe weather corridors.<br><br><span class="k">Best for:</span> Severe thunderstorm potential, supercell environments.',

    'fcast-tab-helicity': '<b>Storm-Relative Helicity (0-3km SRH)</b><br><br><span class="k">What it shows:</span> A measure of the <b>horizontal wind shear and curvature</b> in the lowest 3km of atmosphere, relative to a moving storm. It quantifies the rotational potential available to thunderstorm updrafts  the ingredient that turns ordinary storms into rotating supercells.<br><br><span class="k">Thresholds:</span> <b>50-150 m/s</b> = weak rotation. <b>150-300</b> = mesocyclones possible. <b>300-500</b> = significant tornadoes possible. <b>500+</b> = violent tornadoes possible (EF3+). The SPC uses SRH as a primary ingredient in their convective outlook process.<br><br><span class="k">Why it matters:</span> Helicity is the <b>rotation ingredient</b> for tornadoes. CAPE provides the updraft energy, helicity provides the spin. The combination of CAPE  SRH (the Energy-Helicity Index, EHI) is one of the strongest predictors of supercells and tornadoes. Watch for corridors where both CAPE >1,500 and SRH >200 overlap  that\'s tornado alley for the event.<br><br><span class="k">Best for:</span> Tornado risk assessment, supercell environments, SPC outlook verification.',

    'fcast-tab-updraft': '<b>Updraft Helicity (2-5km UH)</b><br><br><span class="k">What it shows:</span> The helicity integrated through the 2-5 km layer, weighted by updraft strength. Unlike storm-relative helicity (which measures environmental shear), updraft helicity detects <b>actual rotating updrafts</b> that the model is producing  simulated mesocyclones.<br><br><span class="k">How to read it:</span> UH tracks (colored swaths) show where the model is generating <b>rotating thunderstorms</b>. Stronger values = more intense rotation. Think of each UH swath as the model\'s prediction of a supercell track.<br><br><span class="k">Thresholds:</span> <b>25-75 m/s</b> = rotating updraft. <b>75-150</b> = significant mesocyclone. <b>150-300</b> = intense rotation, tornado likely. <b>300+</b> = violent rotation, strong tornado. The SPC uses UH from ensembles as a key tool for Day 1-3 severe outlook calibration.<br><br><span class="k">Best for:</span> The most direct model-predicted tornado/supercell signal available. If you see UH tracks near your location, take it very seriously.',

    'fcast-tab-lightning': '<b>Lightning Threat</b><br><br><span class="k">What it shows:</span> Model-predicted lightning flash density based on parameterized relationships between graupel production, vertical ice mass flux, and CAPE. The model estimates where charge separation in deep convective clouds would generate lightning.<br><br><span class="k">Why it matters:</span> Lightning is the <b>#1 weather killer for outdoor recreation</b>. This product tells you when and where thunderstorms with lightning are predicted. Even modest thunderstorms produce dangerous lightning. The "30-30 rule" applies: if the time between flash and thunder is <30 seconds, seek shelter; stay sheltered 30 minutes after the last flash.<br><br><span class="k">Best for:</span> Outdoor event planning, aviation safety, fire weather (dry lightning in the West starts wildfires).',

    'fcast-tab-temp': '<b>Temperature & Precipitation Overlay</b><br><br><span class="k">What it shows:</span> 2-meter surface temperature (color fill) overlaid with precipitation areas. Combines two key parameters in a single view to show the relationship between temperature patterns and where precipitation falls.<br><br><span class="k">Why it matters:</span> Temperature determines precipitation type. Watch for the <b>32F (0C) line</b>  that\'s your rain/snow boundary. Narrow transition zones where temperatures hover near freezing are ice storm corridors. Also reveals cold air damming, warm frontal overrunning, and cold pool effects behind storm systems.<br><br><span class="k">Best for:</span> Rain/snow line, winter storm analysis, temperature trends.',

    'fcast-tab-wndtemp': '<b>Wind & 2-Meter Temperature</b><br><br><span class="k">What it shows:</span> Surface wind barbs overlaid on 2m temperature. Wind barbs encode both speed and direction: each full barb = 10 kt, half barb = 5 kt, pennant/flag = 50 kt.<br><br><span class="k">Why it matters:</span> Wind direction reveals frontal positions  wind shifts mark where cold fronts, warm fronts, and drylines are located. The combination with temperature shows cold air advection (NW winds pushing temperatures down) vs warm air advection (SW winds pushing temps up). Also identifies wind chill corridors in winter and heat stress areas in summer.<br><br><span class="k">Best for:</span> Frontal analysis, wind chill, fire weather conditions (dry + windy).',

    'fcast-tab-wind': '<b>Surface Wind & Mean Sea Level Pressure (MSLP)</b><br><br><span class="k">What it shows:</span> Wind speed/direction at 10 meters combined with isobars (lines of equal pressure). The MSLP field reveals the positions and intensity of high and low pressure systems, fronts, and troughs.<br><br><span class="k">How to read it:</span> Tightly packed isobars = strong pressure gradient = high winds. In the Northern Hemisphere, wind spirals counterclockwise into lows and clockwise out of highs (Buys Ballot\'s Law). The tightest pressure gradients (strongest winds) are found on the north and west sides of deep cyclones.<br><br><span class="k">Why it matters:</span> MSLP is the <b>backbone of synoptic meteorology</b>. It tells you where the major weather-driving features are and where they\'re headed. Deepening lows (falling central pressure) = strengthening storm. The 996mb threshold is significant; below 980mb = major storm. Explosive cyclogenesis ("bomb cyclone") = pressure drop of 24mb+ in 24 hours.<br><br><span class="k">Best for:</span> Synoptic weather analysis, storm track, wind forecast.',

    'fcast-tab-maxwind': '<b>Maximum Surface Wind Speed</b><br><br><span class="k">What it shows:</span> The highest wind speed (including gusts) predicted at 10m AGL for each grid point. This captures the peak gust potential, not just the sustained wind.<br><br><span class="k">Thresholds:</span> <b>25-35 kt</b> = high wind advisory territory. <b>35-50 kt</b> = high wind warning. <b>50-65 kt</b> = damaging wind gusts, scattered power outages. <b>65+ kt</b> = hurricane-force gusts, widespread damage and outages. Thunderstorm outflows (downbursts) can produce 60-100+ kt gusts in localized areas.<br><br><span class="k">Best for:</span> Wind damage potential, power outage risk, outdoor structure safety.',

    'fcast-tab-jet': '<b>Jet Stream (250-300mb Wind)</b><br><br><span class="k">What it shows:</span> The upper-level jet stream  a river of fast-moving air at 30,000-40,000 ft altitude that steers weather systems. Jet stream winds typically range from 60-150+ kt, occasionally exceeding 200 kt in jet streaks.<br><br><span class="k">How to read it:</span> The jet core (darkest colors) marks the main flow axis. Left exit regions of jet streaks (areas where the jet is accelerating) favor upper-level divergence, which promotes surface low development and rising air  this is where storms intensify. Right entrance regions have a similar effect.<br><br><span class="k">Why it matters:</span> The jet stream <b>controls the weather pattern</b>. It steers surface storms, separates air masses, and provides the dynamic forcing for cyclone development. A highly amplified (wavy) jet brings extreme temperature swings and active weather. A flat, zonal jet means quiet, boring weather. Knowing the jet position tells you the large-scale story.<br><br><span class="k">Best for:</span> Pattern recognition, storm track forecasting, understanding the big picture.',

    'fcast-tab-gfs500wind': '<b>500mb Wind Speed</b><br><br><span class="k">What it shows:</span> Wind speed at the 500mb pressure level (~18,000 ft / 5,500m). This is the mid-troposphere, the "steering level" for surface weather systems.<br><br><span class="k">Why it matters:</span> Surface storms generally move in the direction and at roughly half the speed of the 500mb flow. Strong 500mb winds also indicate deep-layer shear, which is critical for supercell thunderstorm development. The combination of strong 500mb flow over high surface CAPE creates the most dangerous severe weather environments.<br><br><span class="k">Best for:</span> Storm motion, deep-layer shear, severe weather environment.',

    'fcast-tab-250wind': '<b>250mb Jets  Upper Troposphere</b><br><br><span class="k">What it shows:</span> Wind speeds at 250mb (~34,000 ft), typically the core of the polar jet stream. This is where jet stream winds are strongest.<br><br><span class="k">Why it matters:</span> 250mb isotachs (lines of equal wind speed) reveal jet streak dynamics. Four-quadrant jet streak model: the <b>right entrance</b> and <b>left exit</b> regions force upper-level divergence (rising air, storm development). The <b>left entrance</b> and <b>right exit</b> force convergence (sinking air, clearing). Understanding where you are relative to the jet streak predicts whether weather improves or deteriorates.<br><br><span class="k">Best for:</span> Jet streak dynamics, cyclogenesis forecasting, upper-level divergence.',

    'fcast-tab-gfs4panel': '<b>4-Panel Analysis</b><br><br><span class="k">What it shows:</span> Four standard synoptic analysis levels displayed simultaneously: 250mb (jet stream), 500mb (steering flow/vorticity), 850mb (low-level temperature/moisture), and surface (fronts/pressure). This is the classic meteorologist\'s briefing view.<br><br><span class="k">Why it matters:</span> Weather happens in <b>three dimensions</b>. The 4-panel lets you see the vertical structure of the atmosphere at a glance  whether upper-level support (jet streak) is aligned with mid-level forcing (vorticity max) and low-level moisture/instability over a surface trigger (front). When all four levels are in phase, significant weather occurs. When they\'re out of phase, events underperform.<br><br><span class="k">Best for:</span> Complete synoptic overview, pattern analysis, forecast verification.',

    'fcast-tab-rh': '<b>700mb Relative Humidity</b><br><br><span class="k">What it shows:</span> Moisture content at the 700mb level (~10,000 ft / 3,000m). The mid-tropospheric humidity field reveals where the atmosphere is saturated vs dry at cloud-forming altitudes.<br><br><span class="k">How to read it:</span> <b>RH > 80%</b> = clouds and precipitation likely. <b>RH > 90%</b> = active precipitation. <b>RH < 40%</b> = very dry, clear skies. Sharp moisture gradients indicate drylines and moisture boundaries.<br><br><span class="k">Why it matters:</span> Dry air at 700mb can cap convection (suppress thunderstorms) even when surface moisture is high  the "cap" that keeps lids on severe weather until a strong trigger breaks through. Dry intrusions at 700mb also enhance downdraft potential in thunderstorms (stronger microbursts). Elevated dry air over low-level moisture = high CAPE but capped = volatile setup.<br><br><span class="k">Best for:</span> Cloud cover, cap assessment, dry air intrusion, precipitation efficiency.',

    'fcast-tab-gfs500rh': '<b>500mb Relative Humidity</b><br><br><span class="k">What it shows:</span> Moisture at the 500mb level (~18,000 ft). Higher altitude than 700mb RH, showing mid-tropospheric moisture associated with larger-scale weather systems.<br><br><span class="k">Why it matters:</span> Dry slots in 500mb RH often correspond to the dry intrusion behind cold fronts  the descending dry air that clears skies rapidly after frontal passage. Deep layered moisture (both 700 and 500mb wet) supports heavy precipitation. Dry mid-level air over moist low levels creates an unstable "loaded gun" profile.<br><br><span class="k">Best for:</span> Deep moisture analysis, frontal structure, precipitation longevity.',

    'fcast-tab-gfs850vort': '<b>850mb Vorticity</b><br><br><span class="k">What it shows:</span> The spin of the atmosphere at the 850mb level (~5,000 ft). Positive vorticity (cyclonic spin) at this level indicates low-level rotation and convergence.<br><br><span class="k">Why it matters:</span> 850mb vorticity maxima often correspond to surface low centers, frontal wave developments, and mesoscale vortices. In winter storms, 850mb vorticity tracks correlate well with heavy snow bands. Low-level vorticity is also an ingredient in tornado environments  strong 0-1km vorticity combined with CAPE produces tornadoes more efficiently than CAPE alone.<br><br><span class="k">Best for:</span> Low-level cyclone tracking, mesoscale vortex identification, snow banding.',

    'fcast-tab-500vort': '<b>500mb Vorticity</b><br><br><span class="k">What it shows:</span> Absolute vorticity at the 500mb level, showing areas of spin in the mid-troposphere. Vorticity maxima ("vort maxes") are the engines that drive surface weather system development.<br><br><span class="k">How to read it:</span> Warm colors = positive (cyclonic) vorticity. Vort maxes appear as concentrated blobs moving through the flow. The <b>downstream side</b> (ahead) of an approaching vort max is where upper-level divergence and surface pressure falls occur = storminess. The <b>upstream side</b> (behind) produces convergence = clearing.<br><br><span class="k">Why it matters:</span> <b>Vorticity advection drives weather.</b> Positive Vorticity Advection (PVA) at 500mb forces rising air and surface low development. Every major storm system has a vort max driving it. Following the vort max parade through the westerlies is the fundamental approach to medium-range forecasting.<br><br><span class="k">Best for:</span> Storm system tracking, cyclogenesis, upper-level forcing diagnosis.',

    'fcast-tab-500mb': '<b>500mb Vorticity & Height</b><br><br><span class="k">What it shows:</span> Geopotential heights (contour lines) and absolute vorticity (color fill) at 500mb. This is the <b>most analyzed chart in meteorology</b>. Heights show ridges (high pressure aloft = nice weather) and troughs (low pressure aloft = active weather).<br><br><span class="k">How to read it:</span> Height contours flow west to east. Troughs dip southward, ridges bulge northward. Short-wave troughs (small wiggles) embedded in the larger flow carry vort maxes that trigger surface weather events. Closed lows (concentric height contours) are cut-off systems that stall and produce prolonged weather.<br><br><span class="k">Why it matters:</span> This is the <b>map meteorologists check first</b> every morning. It tells the entire medium-range story: where the jet is, where troughs and ridges are, how amplified the pattern is, and where surface weather will develop. Heights falling = storm approaching. Heights rising = clearing coming.<br><br><span class="k">Best for:</span> The single most important weather map. Pattern recognition, storm tracking, medium-range forecasting.',

    'fcast-tab-lowthick': '<b>1000-850mb Thickness</b><br><br><span class="k">What it shows:</span> The depth (in meters) of the atmospheric layer between 1000mb and 850mb. Thickness is directly proportional to the <b>mean temperature</b> of the layer  warm air expands (thicker), cold air contracts (thinner).<br><br><span class="k">Critical line:</span> The <b>1,300m thickness line</b> (~540dam in the 1000-500mb layer) is the classic rain/snow demarcation. Below 1,300m = cold enough for snow at the surface. Above = rain. This boundary is more reliable than surface temperature alone because it accounts for the entire lower atmosphere profile.<br><br><span class="k">Why it matters:</span> Thickness is the <b>primary tool for winter weather forecasting</b>. It determines precipitation type more accurately than surface temp because a shallow cold layer at the surface can produce snow even when surface temps are above freezing. Watch for the 1,300m line and how it shifts relative to precipitation areas.<br><br><span class="k">Best for:</span> Rain/snow line forecasting, winter storm analysis, air mass identification.',

    'fcast-tab-midthick': '<b>850-700mb Thickness</b><br><br><span class="k">What it shows:</span> Thickness of the 850-700mb layer (roughly 5,000-10,000 ft). This mid-level thermal field captures warm air advection (WAA) and cold air advection (CAA) patterns at levels important for precipitation type and frontal analysis.<br><br><span class="k">Why it matters:</span> Warm noses at 850-700mb are what cause freezing rain  warm air aloft melts snow into rain, but the shallow cold surface layer refreezes it on contact. Tracking thickness changes shows where warm fronts are overrunning cold air and where the critical melting layer exists. The 850-700mb layer is where the magic (or misery) of ice storms happens.<br><br><span class="k">Best for:</span> Freezing rain forecasting, warm frontal analysis, thermal advection patterns.',

    'fcast-tab-gfs850temp': '<b>850mb Temperature</b><br><br><span class="k">What it shows:</span> Temperature at the 850mb pressure level (~5,000 ft / 1,500m). This removes surface effects like urban heat islands, cold pools in valleys, and shallow surface inversions to show the "true" lower-atmospheric temperature.<br><br><span class="k">Key thresholds:</span> <b>0C at 850mb</b> = approximate rain/snow line (adjusted for elevation). <b>-5C</b> = all snow. <b>+3 to +5C above a surface freezing layer</b> = ice storm zone (warm nose melts snow, surface refreezes). Temperature gradients reveal frontal positions  the tightest gradient is the frontal zone.<br><br><span class="k">Why it matters:</span> 850mb temp is the <b>go-to for precipitation type discrimination</b>. It\'s also the best single-level indicator of air mass temperature, unbothered by surface terrain effects. Warm 850s in winter (>0C) with surface temps below freezing = ice storm red flag.<br><br><span class="k">Best for:</span> Precipitation type, air mass analysis, frontal positions.',

    'fcast-tab-vis': '<b>Surface Visibility</b><br><br><span class="k">What it shows:</span> Predicted horizontal visibility at the surface in miles or kilometers. Reduced visibility can result from fog, precipitation, blowing snow, dust, or smoke.<br><br><span class="k">Categories:</span> <b>> 6 mi</b> = VFR (Visual Flight Rules), good. <b>3-5 mi</b> = MVFR (Marginal VFR). <b>1-3 mi</b> = IFR (Instrument Flight Rules), hazardous. <b>< 1 mi</b> = LIFR (Low IFR), dangerous. <b>< 1/4 mi</b> = near-zero visibility, travel should be avoided.<br><br><span class="k">Why it matters:</span> Visibility is a <b>life-safety parameter</b> for both aviation and driving. Dense fog (< 1/4 mi) causes chain-reaction highway pileups. Freezing fog deposits ice. Snow squalls can reduce visibility to near-zero in seconds. This product identifies when and where visibility drops become dangerous.<br><br><span class="k">Best for:</span> Aviation flight planning, fog forecasting, travel safety.',

    'fcast-tab-ceiling': '<b>Cloud Ceiling Height</b><br><br><span class="k">What it shows:</span> The height (AGL) of the lowest broken or overcast cloud layer  the base of the clouds as seen from the ground. This is the ceiling a pilot or observer sees looking up.<br><br><span class="k">Categories:</span> <b>> 3,000 ft</b> = VFR, good flying weather. <b>1,000-3,000 ft</b> = MVFR. <b>500-1,000 ft</b> = IFR. <b>< 500 ft</b> = LIFR, very low clouds. <b>< 200 ft</b> = minimums approach, most airports require instrument approaches.<br><br><span class="k">Why it matters:</span> Ceiling is the <b>primary aviation weather parameter</b> along with visibility. Low ceilings close airports, force instrument approaches (slower traffic flow = delays), and make visual approaches impossible. For general aviation (non-commercial), low ceilings are the leading cause of VFR-into-IMC accidents  the most lethal category of GA accident.<br><br><span class="k">Best for:</span> Aviation planning, airport operations, low-cloud forecasting.',

    'fcast-tab-10mb': '<b>10mb Stratospheric Analysis</b><br><br><span class="k">What it shows:</span> Conditions at the 10mb level (~100,000 ft / 31 km)  deep in the stratosphere, far above the weather-producing troposphere. This shows the <b>polar vortex</b>  the massive upper-atmosphere circulation of cold air over the pole.<br><br><span class="k">Why it matters:</span> The stratospheric polar vortex influences tropospheric weather on <b>2-6 week timescales</b>. A strong, symmetrical polar vortex tends to produce mild, zonal (west to east) weather patterns across North America and Europe. A disrupted or displaced polar vortex (Sudden Stratospheric Warming, SSW) can trigger <b>prolonged cold outbreaks and winter storms</b> at the surface 2-6 weeks later as the signal propagates downward.<br><br><span class="k">What to watch for:</span> When the polar vortex splits into two lobes or is displaced off the pole, prepare for a significant pattern change toward cold and active weather. These events are rare (a few per winter) but have outsized impacts lasting weeks.<br><br><span class="k">Best for:</span> Sub-seasonal forecasting, cold outbreak prediction, pattern change detection.',

    // MODELS - LEFT PANEL
    'fcast-model-gfs': '<b>GFS  Global Forecast System</b>' +
      '<br><br><span class="k">Operator:</span> NOAA / NCEP Environmental Modeling Center (EMC). The flagship American global model, first deployed in 1980, running on NOAA supercomputers in Reston, VA and Orlando, FL.' +
      '<br><br><span class="k">Schedule:</span> 4 daily at 00, 06, 12, 18 UTC. Data available ~3.54 hrs after init. All cycles run to 384 hours.' +
      '<br><br><span class="k">Resolution:</span> 0.25 (~28 km) globally, 127 vertical levels extending to 80 km (mesosphere). One of the higher-resolution global models, though too coarse to resolve thunderstorms.' +
      '<br><br><span class="k">Forecast range:</span> <b>16 days (384 hours)</b>  the longest of any deterministic model. Meaningful skill degrades significantly after Day 78.' +
      '<br><br><span class="k">Physics:</span> FV3 (Finite-Volume Cubed-Sphere) dynamical core since the v15 upgrade (June 2019). Uses GFDL microphysics, scale-aware Arakawa-Wu deep convection, Noah-MP land surface model, and RRTMGP radiation. The FV3 core replaced the legacy spectral model, improving terrain handling and gravity wave representation.' +
      '<br><br><span class="k">Strengths:</span> Excellent at large-scale pattern evolution  jet stream, trough/ridge amplification, storm tracks, tropical cyclone genesis. Its 127 vertical levels give strong stratospheric representation for polar vortex monitoring. The GFS is the workhorse of all NOAA extended guidance.' +
      '<br><br><span class="k">Known weaknesses:</span> Can "flip-flop" dramatically between runs beyond Day 5, especially with cutoff lows. Historical warm and wet bias in winter. Misses mesoscale features  individual storm cells, terrain-forced precip, sea breeze fronts. Often underperforms the ECMWF in medium-range pattern forecasting.' +
      '<br><br><span class="k">Best use:</span> Days 310 pattern forecasting. Always compare with ECMWF. Trust the GFS more for large-scale pattern calls than for precise precip amounts.' +
      '<br><br><span class="k">Source:</span> <a href="https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/gfs.php" target="_blank" style="color:rgba(120,160,255,.95);">NCEP/EMC GFS</a>  <a href="https://nomads.ncep.noaa.gov/" target="_blank" style="color:rgba(120,160,255,.95);">NOMADS Data</a>',

    'fcast-model-nam': '<b>NAM  North American Mesoscale Model</b>' +
      '<br><br><span class="k">Operator:</span> NOAA / NCEP EMC. NOAA\'s primary regional model since 2006, replacing the Eta model. Bridges the gap between the coarse global GFS and high-res convection-allowing models.' +
      '<br><br><span class="k">Schedule:</span> 4 daily at 00, 06, 12, 18 UTC. Data available ~1.52 hrs after init.' +
      '<br><br><span class="k">Resolution:</span> 12 km parent domain covering North America, Central America, and surrounding oceans. 60 vertical levels.' +
      '<br><br><span class="k">Forecast range:</span> <b>84 hours (3.5 days)</b> for 00Z/12Z. 06Z/18Z run to 60 hours.' +
      '<br><br><span class="k">Physics:</span> NEMS/NMMB (Nonhydrostatic Multiscale Model on the B-grid) dynamical core with Ferrier-Aligo microphysics, Betts-Miller-Janjic (BMJ) convective parameterization, and Noah land surface model. The BMJ scheme is the source of many known biases.' +
      '<br><br><span class="k">Strengths:</span> Better than GFS at mesoscale features: frontal precipitation bands, orographic enhancement, lake-effect snow, sea breeze circulations, and coastal fronts. At 12km it captures terrain interactions the 28km GFS misses.' +
      '<br><br><span class="k">Known weaknesses:</span> The infamous "wet NAM"  systematically over-predicts precipitation by 50100%. BMJ convection fires too early and too broadly. Can produce unrealistic runaway convective feedback loops. Has been largely surpassed by the HRRR for short-range work.' +
      '<br><br><span class="k">Best use:</span> 1248 hr regional forecasting, winter storm QPF, terrain-influenced weather. Mentally discount its convective precip by ~30%.' +
      '<br><br><span class="k">Source:</span> <a href="https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/nam.php" target="_blank" style="color:rgba(120,160,255,.95);">NCEP/EMC NAM</a>  <a href="https://nomads.ncep.noaa.gov/" target="_blank" style="color:rgba(120,160,255,.95);">NOMADS Data</a>',

    'fcast-model-nam_hires': '<b>NAM 3km  North American Mesoscale Convection-Allowing Nest</b>' +
      '<br><br><span class="k">Operator:</span> NOAA / NCEP EMC. A high-resolution inner nest within the NAM parent, using the same NMMB core at a resolution fine enough to explicitly simulate individual thunderstorm cells.' +
      '<br><br><span class="k">Schedule:</span> Runs with NAM parent cycle (4 daily).' +
      '<br><br><span class="k">Resolution:</span> <b>3 km</b>  the critical threshold for "convection-allowing" modeling. At 3km, the model directly simulates updrafts, downdrafts, and storm-scale circulations using fluid dynamics rather than statistical parameterization. Multiple nested domains cover different CONUS regions.' +
      '<br><br><span class="k">Forecast range:</span> <b>60 hours.</b>' +
      '<br><br><span class="k">Why convection-allowing matters:</span> Convective parameterization (used in GFS, NAM 12km, etc.) is the #1 source of error in weather models. It approximates thunderstorms with statistical assumptions. At 3km, the model grows storms from actual physics  producing realistic supercell structures, squall lines, MCSs, and mesoscale snow bands that parameterized models simply cannot capture.' +
      '<br><br><span class="k">Strengths:</span> Resolves individual storm cells, winter mesoscale banding, outflow boundaries, and terrain-forced features. Simulated radar closely matches reality. Far superior to NAM 12km for convective weather.' +
      '<br><br><span class="k">Known weaknesses:</span> Inherits NAM physics biases. Limited regional domains (not CONUS-wide). Doesn\'t assimilate radar data like the HRRR, so initial hours are less accurate. Can overdo convection once initiated.' +
      '<br><br><span class="k">Best use:</span> Short-range storm mode and winter banding when HRRR isn\'t available for a particular cycle.' +
      '<br><br><span class="k">Source:</span> <a href="https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/nam.php" target="_blank" style="color:rgba(120,160,255,.95);">NCEP/EMC NAM</a>',

    'fcast-model-hrrr': '<b>HRRR  High-Resolution Rapid Refresh</b>' +
      '<br><br><span class="k">Operator:</span> NOAA / NCEP EMC + NOAA Global Systems Laboratory (GSL), Boulder, CO. America\'s premier short-range weather model and arguably the most innovative operational NWP system in the world. Operational since 2014, continuously upgraded.' +
      '<br><br><span class="k">Schedule:</span> Runs <b>every single hour</b>, 24/7  the fastest operational cycle in the world. 00/06/12/18Z extend to 48 hrs; all other hourly runs go to 18 hrs.' +
      '<br><br><span class="k">Resolution:</span> <b>3 km</b> convection-allowing, CONUS domain, 80 vertical levels. Uses the WRF-ARW dynamical core with Thompson aerosol-aware microphysics  a sophisticated mixed-phase ice scheme that tracks 5 hydrometeor species.' +
      '<br><br><span class="k">The secret weapon  data assimilation:</span> What makes the HRRR special is its <span class="k">data assimilation</span>. Every hour it ingests:' +
      '<br> 3D radar reflectivity from the entire NEXRAD network' +
      '<br> Satellite radiance data (GOES-16/17/18)' +
      '<br> Aircraft observations (AMDAR/ACARS, ~750,000 obs/day)' +
      '<br> Surface METAR, mesonet, and buoy observations' +
      '<br> GPS precipitable water retrievals' +
      '<br> Lightning data (GLM/NLDN)' +
      '<br>It uses hybrid ensemble-variational (EnVar) analysis to blend everything. Result: the HRRR\'s first few hours are remarkably accurate because it <i>knows</i> where storms are right now.' +
      '<br><br><span class="k">Strengths:</span> <b>The undisputed best model for 018 hour forecasting.</b> Exceptional at convective mode (discrete cells vs. squall lines vs. MCSs), storm timing, evolution, and simulated radar. Thompson microphysics produces realistic precipitation type discrimination. Used operationally by every NWS office, the SPC, and the Aviation Weather Center.' +
      '<br><br><span class="k">Known weaknesses:</span> Beyond 18 hrs, skill degrades toward NAM/GFS levels as the data assimilation advantage fades. Struggles with convective <i>initiation</i> timing  knows where storms are, but predicting where new ones form is harder. Hourly updates mean rapidly changing solutions. Difficulty with fog and low stratus.' +
      '<br><br><span class="k">Best use:</span> Same-day and next-day forecasting, real-time severe operations, precise precip timing  any time "the next 12 hours" is what matters.' +
      '<br><br><span class="k">Source:</span> <a href="https://rapidrefresh.noaa.gov/hrrr/" target="_blank" style="color:rgba(120,160,255,.95);">NOAA GSL HRRR</a>  <a href="https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/hrrr.php" target="_blank" style="color:rgba(120,160,255,.95);">NCEP/EMC HRRR</a>  <a href="https://nomads.ncep.noaa.gov/" target="_blank" style="color:rgba(120,160,255,.95);">NOMADS</a>',

    'fcast-model-href': '<b>HREF  High-Resolution Ensemble Forecast</b>' +
      '<br><br><span class="k">Operator:</span> NOAA / NCEP EMC. NOAA\'s convection-allowing ensemble  multiple high-res runs combined for probabilistic severe weather and heavy rainfall guidance.' +
      '<br><br><span class="k">Schedule:</span> 2 daily (00Z, 12Z). Data available ~56 hrs after init.' +
      '<br><br><span class="k">Resolution:</span> All members at <b>3 km</b> convection-allowing. <b>Forecast range: 48 hours.</b>' +
      '<br><br><span class="k">Members (~810):</span>' +
      '<br> HRRR (current + previous run)' +
      '<br> NAM 3km Nest (current + previous run)' +
      '<br> HiResW ARW (WRF core, 2 members)' +
      '<br> HiResW NMMB (2 members)' +
      '<br>Time-lagging adds diversity without running extra models.' +
      '<br><br><span class="k">Why ensembles matter:</span> A single deterministic model gives one answer  and it\'s wrong somewhere. An ensemble gives a <i>range</i> of answers. Where members agree = high confidence. Where they diverge = real uncertainty. The HREF addresses <b>the biggest problem in convective forecasting: overconfidence</b>.' +
      '<br><br><span class="k">Key products:</span> Ensemble mean, Probability-Matched Mean (PMM  preserves realistic intensities the simple mean smooths out), exceedance probabilities for precip and reflectivity thresholds, ensemble maximum, and spread.' +
      '<br><br><span class="k">Known weaknesses:</span> Members share similar physics, so spread can be too narrow (under-dispersive). Limited to 48 hrs. Less member diversity than a "true" perturbed-IC ensemble.' +
      '<br><br><span class="k">Best use:</span> Day 12 probabilistic severe/heavy rain forecasting, confidence assessment, SPC mesoscale discussion support.' +
      '<br><br><span class="k">Source:</span> <a href="https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/href.php" target="_blank" style="color:rgba(120,160,255,.95);">NCEP/EMC HREF</a>',

    'fcast-model-nbm': '<b>NBM  National Blend of Models</b>' +
      '<br><br><span class="k">Operator:</span> NOAA / NCEP / MDL (Meteorological Development Laboratory). The NBM is fundamentally different  it\'s not a weather model. It\'s a <b>statistical post-processing system</b> that blends multiple models, bias-corrects against observations, and produces calibrated probabilistic guidance.' +
      '<br><br><span class="k">Schedule:</span> Updates hourly with latest model guidance.' +
      '<br><br><span class="k">Resolution:</span> <b>2.5 km</b> (CONUS). <b>Forecast range: 10+ days.</b>' +
      '<br><br><span class="k">Input models blended:</span>' +
      '<br> GFS + GEFS (American global + ensemble)' +
      '<br> ECMWF + ENS (European  world\'s best global model)' +
      '<br> CMC + GEPS (Canadian global + ensemble)' +
      '<br> NAM, HRRR, HREF (American regional)' +
      '<br> RAP (Rapid Refresh, 13km)' +
      '<br> MOS (Model Output Statistics)' +
      '<br><br><span class="k">How it works:</span> Applies MOS regression, bias correction, and Bayesian Model Averaging to weight each model based on its recent performance for each specific element and location. If ECMWF has been better at temperature recently, it gets more weight for temperature. If HRRR has been better at precip, it gets more weight there.' +
      '<br><br><span class="k">Strengths:</span> <b>The most accurate single source for sensible weather</b>  temperature, dewpoint, wind, PoP, sky cover. Calibrated probabilities are statistically reliable: when NBM says 40% rain, it rains ~40% of the time. This calibration is invaluable for decisions. The NBM drives the NWS hourly forecast grids that power weather.gov and most weather apps.' +
      '<br><br><span class="k">Known weaknesses:</span> No simulated radar, no upper-air charts, no severe parameters. Statistical smoothing loses mesoscale detail. Performs poorly during rare/unprecedented events (trained on historical data). Cannot capture "black swan" scenarios.' +
      '<br><br><span class="k">Best use:</span> The best starting point for any point forecast. Use as baseline, then adjust with raw model data for details NBM can\'t capture.' +
      '<br><br><span class="k">Source:</span> <a href="https://vlab.noaa.gov/web/mdl/nbm" target="_blank" style="color:rgba(120,160,255,.95);">NOAA MDL NBM</a>  <a href="https://blend.mdl.nws.noaa.gov/" target="_blank" style="color:rgba(120,160,255,.95);">NBM Viewer</a>',

    'fcast-model-gefs': '<b>GEFS  Global Ensemble Forecast System</b>' +
      '<br><br><span class="k">Operator:</span> NOAA / NCEP EMC. The ensemble version of the GFS  instead of one run, it runs <b>31 times simultaneously</b> with slightly different starting conditions and physics to map out the range of possible outcomes.' +
      '<br><br><span class="k">Schedule:</span> 4 daily (00, 06, 12, 18 UTC). Data available ~5 hrs after init.' +
      '<br><br><span class="k">Resolution:</span> 0.25 (~28 km) Days 010, degrading to 0.5 (~50 km) Days 1016. 64 vertical levels. <b>Forecast range: 16 days (384 hours).</b>' +
      '<br><br><span class="k">Members:</span> 1 control (unperturbed GFS) + 30 perturbed members. Perturbations use Ensemble Transform with Rescaling (ETR) for initial conditions + stochastic physics (SPPT, SHUM, SKEB) during integration. Each member = a plausible alternative atmosphere.' +
      '<br><br><span class="k">Reading ensemble output:</span>' +
      '<br> <b>Ensemble mean:</b> Average of all 31 members. Beyond Day 5, it outperforms any single deterministic run by filtering out chaos.' +
      '<br> <b>Spread:</b> How much members disagree. Low = high confidence. High = multiple outcomes possible, don\'t trust any single solution.' +
      '<br> <b>Spaghetti plots:</b> One contour tracked across all members. Tight = reliable. Wild spaghetti = chaos.' +
      '<br><br><span class="k">Strengths:</span> The best tool for <b>forecast uncertainty</b>. Essential for Days 516. Identifies high-impact, low-probability scenarios. Used for TC track uncertainty cones, winter storm probabilities, and Week 2 outlooks.' +
      '<br><br><span class="k">Known weaknesses:</span> Can be under-dispersive (members cluster too tightly). Coarse resolution misses mesoscale detail. Individual members aren\'t skillful alone; value is in the collective.' +
      '<br><br><span class="k">Best use:</span> Days 516 pattern forecasting, uncertainty assessment, tropical cyclone guidance  any time you need "how confident should I be?"' +
      '<br><br><span class="k">Source:</span> <a href="https://www.emc.ncep.noaa.gov/emc/pages/numerical_forecast_systems/gefs.php" target="_blank" style="color:rgba(120,160,255,.95);">NCEP/EMC GEFS</a>  <a href="https://nomads.ncep.noaa.gov/" target="_blank" style="color:rgba(120,160,255,.95);">NOMADS Data</a>'
  };
  //  RIGHT-SIDE PRODUCT TAB TOOLTIPS 
  var productTooltips = {

    // 
    // PRECIPITATION
    // 

    'fcast-tab-sim': '<b>Simulated Composite Reflectivity</b>' +
      '<br><br><span class="k">What this is:</span> The model calculates where rain, snow, ice, and graupel will exist in the atmosphere, then converts those hydrometeor concentrations into the equivalent radar reflectivity (dBZ) that a real WSR-88D would observe. This is the single most intuitive forecast product  it looks like radar because it <i>is</i> simulated radar.' +
      '<br><br><span class="k">The dBZ scale:</span>' +
      '<br><span style="color:#00e600"></span> <b>Green (2035 dBZ)</b>  Light to moderate rain at ~0.010.15 in/hr, or moderate snow. Broad green areas = stratiform precipitation from a warm/cold front or overrunning pattern.' +
      '<br><span style="color:#e6e600"></span> <b>Yellow (3545 dBZ)</b>  Moderate to heavy rain ~0.150.50 in/hr. Embedded convective cells within a frontal rain shield. Snowfall rates of 12 in/hr possible.' +
      '<br><span style="color:#e69000"></span> <b>Orange (4550 dBZ)</b>  Heavy rain ~0.51.0 in/hr. Small hail possible. Urban drainage systems start struggling at this intensity.' +
      '<br><span style="color:#e62000"></span> <b>Red (5060 dBZ)</b>  Very heavy rain >1 in/hr, hail likely (0.5\"). Severe thunderstorm criteria met. Flash flood risk is high.' +
      '<br><span style="color:#e600e6"></span> <b>Magenta (6070 dBZ)</b>  Extreme intensity. Large hail (1\"), damaging winds, tornado-producing supercells. Almost always warrants severe/tornado warnings.' +
      '<br><span style="color:#c8a0ff"></span> <b>Purple/White (70+ dBZ)</b>  Giant hail (2\"), extremely violent storms. May indicate lofted debris (tornado debris signature).' +
      '<br><br><span class="k">How to use it:</span> Compare the model\'s current-hour simulated radar against the live radar to grade model performance. If it\'s nailing the placement and intensity of current storms, trust its forecast hours more. If it\'s off by 50+ miles or missing key features, weight other models more heavily. Animate the full loop to see where storms develop, intensify, and weaken.',

    'fcast-tab-maxref': '<b>Composite Maximum Reflectivity</b>' +
      '<br><br><span class="k">What this is:</span> At every grid point, the model scans the <i>entire</i> vertical atmospheric column from surface to tropopause and reports the single highest reflectivity value found at any altitude. This catches features that surface-level or low-level radar would completely miss  especially hail cores suspended in powerful updrafts miles above the ground.' +
      '<br><br><span class="k">Why it matters:</span> A storm can have 65 dBZ returns at 25,000 ft (where grapefruit-sized hail is growing) while showing only 45 dBZ near the surface (because the hail hasn\'t fallen yet). Max reflectivity reveals what\'s happening <i>inside</i> the storm, not just what\'s near ground level.' +
      '<br><br><span class="k">Thresholds:</span> >50 dBZ = severe potential. >60 dBZ = large hail (1\") almost certain. >65 dBZ = giant hail (2\"), a genuine threat to life and property. A compact, isolated core of 60+ dBZ embedded in a broader storm complex is the hallmark of a supercell updraft.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km, HREF  convection-allowing models only. GFS/NAM 12km are too coarse to explicitly simulate individual storm cores.',

    'fcast-tab-radar1km': '<b>1km AGL (Above Ground Level) Reflectivity</b>' +
      '<br><br><span class="k">What this is:</span> Simulated radar returns at exactly 1 kilometer above the terrain surface  the altitude closest to what a real weather radar sees on its lowest elevation scan (~0.5 tilt). While composite reflectivity tells you what\'s happening anywhere in the atmosphere, 1km reflectivity tells you what\'s actually reaching the ground.' +
      '<br><br><span class="k">The key insight  virga:</span> When composite reflectivity shows strong returns but 1km reflectivity is weak or absent, that\'s <span class="k">virga</span>  precipitation evaporating or sublimating before reaching the surface. Virga is common in the Desert Southwest, the High Plains, and during elevated convection events. You might see a dramatic-looking composite radar display, but nothing is falling at the ground.' +
      '<br><br><span class="k">Why forecasters love it:</span> It\'s the most honest representation of what you\'ll actually experience at ground level. It strips away the noise of upper-level ice and elevated returns. If 1km shows 50+ dBZ, that heavy rain or hail IS reaching you. If it\'s blank while composite is screaming, everything is evaporating aloft.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km, HREF only.',

    'fcast-tab-echotop': '<b>Echo Tops</b>' +
      '<br><br><span class="k">What this is:</span> The altitude (in feet above sea level) where the highest detectable radar echo exists in the column. It directly measures the vertical extent of precipitation and, by proxy, the strength of the storm\'s updraft  the engine that powers every thunderstorm. The stronger the updraft, the higher it lofts precipitation particles.' +
      '<br><br><span class="k">Reading the thresholds:</span>' +
      '<br> <b>20,00030,000 ft</b>  Normal convection. Typical summer showers. No severe threat.' +
      '<br> <b>30,00040,000 ft</b>  Vigorous convection. Moderate-heavy rain, small hail possible. Avoid for aviation.' +
      '<br> <b>40,00050,000 ft</b>  Powerful updraft. Large hail, damaging winds likely. These storms are severe or becoming severe.' +
      '<br> <b>50,000+ ft</b>  Explosive updraft punching into the stratosphere (<span class="k">overshooting top</span>). The tropopause over the CONUS is typically at 35,00040,000 ft, so a 50,000+ ft echo overshoots by 10,00015,000 ft. This takes incredible energy.' +
      '<br><br><span class="k">Critical pattern  rapidly rising tops:</span> Echo tops jumping 10,000+ ft in 1530 minutes signal a storm undergoing explosive intensification. This often happens right before a storm becomes severe. It\'s one of the earliest indicators available to forecasters, often preceding radar rotation signatures by 1530 minutes.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km, HREF only.',

    'fcast-tab-ptype': '<b>Precipitation Type</b>' +
      '<br><br><span class="k">What this is:</span> The model analyzes the complete temperature profile from cloud level down to the surface and categorizes every grid point\'s precipitation as rain, snow, freezing rain, or sleet. This is the product that answers the question every winter storm generates: "Will it be rain, snow, or ice?"' +
      '<br><br><span class="k">How precipitation type is determined:</span> Snow forms in clouds and falls toward the ground. What happens next depends entirely on the thermal layers it passes through:' +
      '<br> <b>All cold below</b>  <span class="k">Snow</span>. The flake never melts. You get pure snowfall.' +
      '<br> <b>Deep warm layer aloft + deep cold near surface</b>  <span class="k">Sleet (ice pellets)</span>. Snow melts completely in the warm layer, then the raindrop refreezes during a long fall through deep cold air. You hear it bouncing off hard surfaces.' +
      '<br> <b>Deep warm layer aloft + shallow cold near surface</b>  <span class="k">Freezing rain</span>. Snow melts but the cold surface layer isn\'t deep enough to refreeze it. The drop remains liquid and <i>instantly freezes on contact</i> with any surface at or below 32F. Silent. Invisible. Deadly.' +
      '<br> <b>All warm below</b>  <span class="k">Rain</span>.' +
      '<br><br><span class="k">Why freezing rain is the worst:</span> Even 0.25\" of ice accumulation can snap tree limbs, collapse power lines, and make every surface a sheet of glass. A half-inch of ice has brought entire metro areas to a standstill for days. Ice storms cause more power outages than any other weather event  recovery often takes 13 weeks.' +
      '<br><br><span class="k">Model limitations:</span> The rain/snow line is one of the hardest things to forecast. It depends on the exact depth and temperature of boundary-layer cold air, which can be influenced by terrain, urban heat islands, and cold air damming. A 1F error in the warm nose temperature can flip the entire forecast.',

    'fcast-tab-ptot': '<b>Total QPF (Quantitative Precipitation Forecast)</b>' +
      '<br><br><span class="k">What this is:</span> The grand total of all liquid-equivalent precipitation accumulated over the entire forecast period. All frozen precipitation is melted down  12 inches of fluffy powder snow shows up as roughly 0.81.0 inches. Think of it as "how much water is this storm delivering to the landscape?"' +
      '<br><br><span class="k">Flash flood assessment:</span> Compare the QPF total against your county\'s <span class="k">Flash Flood Guidance (FFG)</span> values, published by your local NWS River Forecast Center. FFG tells you how much rain is needed over 1, 3, or 6 hours to cause flooding given current soil moisture and stream levels. If model QPF exceeds FFG, flash flooding becomes likely  and if it exceeds FFG by a wide margin, catastrophic flooding is possible.' +
      '<br><br><span class="k">Regional context:</span>' +
      '<br> <b>Eastern US:</b> 46\" in 24 hrs is a major flood event. Soils are often already moist; terrain funnels runoff efficiently.' +
      '<br> <b>Arid West:</b> 12\" can be catastrophic. Desert soils don\'t absorb water, and canyons concentrate flash floods into lethal walls of water moving 1520 mph.' +
      '<br> <b>Gulf Coast:</b> Can tolerate 610+\" due to flat terrain and high-capacity drainage  but anything beyond overwhelms those systems too.' +
      '<br><br><span class="k">Snow conversion:</span> Multiply QPF by the snow-to-liquid ratio (SLR) to estimate snow depth. Typical SLR is 1013:1, but cold fluffy snow can be 1520:1 and warm wet snow as low as 58:1.',

    'fcast-tab-precip1hr': '<b>1-Hour Precipitation</b>' +
      '<br><br><span class="k">What this is:</span> The predicted rainfall (or liquid-equivalent snowfall) for each individual forecast hour. This is the temporal precision product  it tells you not just <i>how much</i> but <i>exactly when</i> the heaviest precipitation hits your location.' +
      '<br><br><span class="k">Intensity scale:</span>' +
      '<br> <b>0.100.25 in/hr</b>  Moderate rain. Streets wet, drainage handles it.' +
      '<br> <b>0.250.50 in/hr</b>  Heavy rain. Puddles form, low-lying roads begin flooding.' +
      '<br> <b>0.501.00 in/hr</b>  Very heavy. Urban flooding begins. Storm drains overwhelmed. Poor visibility for driving.' +
      '<br> <b>1.002.00 in/hr</b>  Intense. Flash flooding in most terrain. Rapid creek rises. Life-threatening driving conditions.' +
      '<br> <b>>2.00 in/hr</b>  Extreme. Flash flooding is almost certain on any terrain. Walls of water in ravines and draws.' +
      '<br><br><span class="k">For snow:</span> Rates above 1 in/hr liquid equivalent can produce <span class="k">thundersnow</span> and near-zero visibility (whiteout). At a 12:1 SLR, that\'s 12 in/hr of snow accumulation  roads become impassable within minutes.' +
      '<br><br><span class="k">Tip:</span> Step through frames one at a time to pinpoint the exact hour the heaviest precip arrives at your location. This is how NWS forecasters determine warning timing.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km, HREF only.',

    'fcast-tab-precip6hr': '<b>6-Hour Precipitation</b>' +
      '<br><br><span class="k">What this is:</span> Accumulated precipitation in 6-hour windows  the standard operational interval used by NCEP for model verification and NWS inter-office coordination. This is the "official" QPF resolution that forecasters build their warnings around.' +
      '<br><br><span class="k">Why 6 hours?</span> Hourly precipitation is noisy because individual convective cells come and go on 3060 minute timescales. By accumulating over 6 hours, you see the persistent, organized precipitation pattern  the frontal rain band, the overrunning shield, the mesoscale convective system\'s total footprint  with the short-lived noise filtered out.' +
      '<br><br><span class="k">Thresholds:</span> >2\" in 6 hrs = significant event warranting a Flood Watch. >3\" = approaches flash flood emergency levels for most eastern US locations. >4\" = extreme, exceeds flash flood guidance for nearly everywhere east of the Rockies.' +
      '<br><br><span class="k">Available on:</span> GFS, NAM, GEFS.',

    'fcast-tab-precip24hr': '<b>24-Hour Precipitation</b>' +
      '<br><br><span class="k">What this is:</span> Full-day accumulation totals that capture an entire storm\'s liquid-equivalent water delivery. This is the product you compare against historical records and engineering design standards.' +
      '<br><br><span class="k">Benchmarking your storm:</span> NOAA Atlas 14 publishes precipitation frequency estimates for every location in the US  you can look up what a "100-year storm" means for your county in terms of 24-hour rainfall. If the model QPF approaches or exceeds that value, you\'re looking at a genuinely rare and dangerous event.' +
      '<br><br><span class="k">Regional benchmarks:</span>' +
      '<br> <b>Northeast:</b> 34\" is significant, 6+\" is exceptional (often tropical remnants).' +
      '<br> <b>Southeast:</b> 46\" is common with tropical moisture; 810+\" causes widespread catastrophic flooding.' +
      '<br> <b>Central Plains:</b> 35\" from MCS complexes; training cells can produce 8+\" in narrow swaths.' +
      '<br> <b>West:</b> 23\" is a major event; atmospheric rivers can deliver 510+\" on windward mountain slopes over 2448 hrs.' +
      '<br><br><span class="k">Available on:</span> GFS, NAM, GEFS.',

    'fcast-tab-snow': '<b>Snowfall Accumulation</b>' +
      '<br><br><span class="k">What this is:</span> Forecast snow depth in inches, accounting for the <span class="k">snow-to-liquid ratio (SLR)</span>  the factor that converts liquid water into actual snow depth on the ground. The SLR is critically important because the same amount of moisture can produce wildly different snow amounts depending on temperature.' +
      '<br><br><span class="k">Snow-to-liquid ratio by temperature:</span>' +
      '<br> <b>3032F:</b> SLR 58:1. Heavy, wet, "heart attack snow." Packs dense, extremely heavy to shovel (~20 lbs per cubic foot). Clings to trees and power lines, causing widespread damage.' +
      '<br> <b>2530F:</b> SLR 1012:1. Classic "normal" snow. Good packing snow. Standard assumption in most models.' +
      '<br> <b>1525F:</b> SLR 1215:1. Light, fluffy snow. Drifts easily in even moderate wind.' +
      '<br> <b>015F:</b> SLR 1520:1. Very fluffy powder. 1\" of liquid = 1520\" of snow. Blows around with any wind, creating ground blizzard conditions.' +
      '<br> <b>Below 0F:</b> SLR can reach 2540:1 with tiny "diamond dust" crystals. The air is so cold it holds very little moisture, so amounts are small but incredibly fluffy.' +
      '<br><br><span class="k">Model caveat:</span> Most models use a simplified SLR around 1013:1. If your storm is particularly cold or warm, actual accumulation will differ significantly. Also, settling is real  12\" falling over 6 hours may only measure 8\" on the ground because the weight of new snow compresses what fell earlier.',

    'fcast-tab-cape': '<b>CAPE & CIN / Precipitable Water</b>' +
      '<br><br><span class="k">This product shows different things depending on which model you\'re using:</span>' +
      '<br><br><span class="k">On GFS/GEFS  Precipitable Water (PWAT):</span> The total amount of moisture in the entire atmospheric column, as if you squeezed every drop of water vapor from surface to tropopause into a bucket. Measured in inches.' +
      '<br> <b><1.0\":</b> Dry atmosphere. Fair skies, or very efficient precipitation (moisture wrung out quickly).' +
      '<br> <b>1.01.5\":</b> Moderate moisture. Scattered showers possible but not prolific rain producers.' +
      '<br> <b>1.52.0\":</b> Moisture-rich. Sustained heavy rainfall possible. Flood risk elevates considerably.' +
      '<br> <b>>2.0\":</b> Anomalously moist  in the top 10% for your region and season. Extreme rainfall rates likely if a lifting mechanism triggers convection. Tropical moisture connections (atmospheric rivers, tropical moisture exports).' +
      '<br><br><span class="k">On Hi-Res Models  CAPE + CIN:</span>' +
      '<br><span class="k">CAPE (Convective Available Potential Energy)</span> measures the fuel available for thunderstorms  the total positive buoyancy a rising air parcel can tap. Measured in Joules per kilogram:' +
      '<br> <b>0500 J/kg:</b> Marginal. Weak storms at best, usually not severe.' +
      '<br> <b>5001500:</b> Moderate. Ordinary thunderstorms; isolated severe possible with good shear.' +
      '<br> <b>15003000:</b> Strong. Organized severe weather likely if shear is sufficient. Supercells favored.' +
      '<br> <b>30005000:</b> Very strong. Intense storms almost certain when triggered.' +
      '<br> <b>>5000:</b> Extreme. The atmosphere is loaded with energy  but only matters if something breaks through the cap.' +
      '<br><br><span class="k">CIN (Convective Inhibition)</span> is the cap  the energy barrier preventing air parcels from rising freely. Moderate CIN (50150 J/kg) can actually make severe weather <i>worse</i>: it prevents early weak storms from firing and consuming instability, allowing CAPE to build all day until something finally breaks through late afternoon, producing fewer but much more violent storms.',

    // 
    // TEMPERATURE
    // 

    'fcast-tab-temp': '<b>1000500mb Thickness & Precipitation Type</b>' +
      '<br><br><span class="k">What this is:</span> Thickness is the distance in decameters between two pressure surfaces. Because warm air expands and cold air contracts, the thickness of a layer is directly proportional to its mean temperature. This product overlays thickness contours with precipitation shading to reveal the rain/snow transition zone across the map.' +
      '<br><br><span class="k">The 540-decameter rule:</span> The <span class="k">540 dam line</span> on the 1000500mb thickness chart is the most famous rule of thumb in meteorology. North of it, the mean tropospheric temperature supports snow. South of it, rain. Forecasters have used this single contour since the 1940s.' +
      '<br><br><span class="k">When the rule breaks:</span>' +
      '<br> <b>Elevation:</b> Higher terrain is colder, so snow occurs south of the 540 line in mountains.' +
      '<br> <b>Warm noses:</b> A shallow warm layer aloft can melt snow into freezing rain even when the 1000500mb mean is cold enough for snow.' +
      '<br> <b>Cold air damming:</b> East of the Appalachians, cold air gets trapped against the mountains while warm air overrides above  producing ice storms well south of the 540 line.' +
      '<br> <b>Lake effect:</b> Near the Great Lakes, the warm lake surface modifies the lowest layers, pushing the rain/snow line further north than thickness alone would suggest.',

    'fcast-tab-wndtemp': '<b>10m Wind & 2-Meter Temperature</b>' +
      '<br><br><span class="k">What this is:</span> The most direct "sensible weather" product  surface temperature at 2 meters above ground combined with wind barbs at 10 meters. This is what you feel when you step outside.' +
      '<br><br><span class="k">Identifying fronts:</span> Frontal boundaries appear as sharp temperature gradients where colors change dramatically over a short distance. A 1020F temperature drop coinciding with a wind shift from southerly to northwesterly is the textbook signature of a cold front passage. Gradual warming with veering winds (SE  S  SW) marks a warm front approach.' +
      '<br><br><span class="k">Wind chill reference:</span>' +
      '<br> 30F + 20 mph wind  feels like 17F' +
      '<br> 10F + 25 mph  feels like 7F' +
      '<br> 0F + 30 mph  frostbite on exposed skin in 1015 minutes' +
      '<br> 10F + 30 mph  frostbite in under 5 minutes' +
      '<br>Wind chill becomes dangerous faster than most people realize  and it is the #1 cause of hypothermia emergencies in winter storms.' +
      '<br><br><span class="k">Available on:</span> GFS, NAM.',

    'fcast-tab-lowthick': '<b>1000850mb Thickness (Low-Level)</b>' +
      '<br><br><span class="k">What this is:</span> Temperature of the lowest ~5,000 feet of the atmosphere  the layer that ultimately determines what precipitation type reaches the ground. While the 1000500mb "540 line" gives the big picture, low-level thickness reveals the critical near-surface details that control rain vs. snow vs. ice.' +
      '<br><br><span class="k">Thresholds:</span>' +
      '<br> <b><1280m:</b> Deep cold at the surface. Pure snow, no questions.' +
      '<br> <b>12801300m:</b> <span class="k">The danger zone.</span> This is where freezing rain, sleet, and the dreaded "wintry mix" live. Small changes within this range dramatically change precipitation type  a 10m difference can flip an entire county from snow to ice.' +
      '<br> <b>>1300m:</b> Warm enough at the surface for rain. Any snow melts before reaching the ground.' +
      '<br><br><span class="k">Cold air damming (CAD):</span> East of the Appalachians, cold air from the north gets channeled southward along the mountain barrier and becomes trapped in the Piedmont. This creates a shallow cold wedge at the surface while warm, moist air overruns it above. Low-level thickness stays in the 12801300m danger zone for days, producing devastating ice storms from Virginia to the Carolinas even when the free atmosphere above is well above freezing. CAD is one of the most persistently misforecast weather patterns in the eastern US.' +
      '<br><br><span class="k">Available on:</span> GFS, NAM.',

    'fcast-tab-midthick': '<b>850700mb Thickness (Mid-Level)</b>' +
      '<br><br><span class="k">What this is:</span> Temperature of the mid-level layer between approximately 5,000 and 10,000 feet  the critical zone where falling snow encounters (or doesn\'t encounter) above-freezing air. The behavior of precipitation in this layer determines whether you get snow, sleet, or freezing rain.' +
      '<br><br><span class="k">The "warm nose":</span> When a warm layer exists in this mid-level zone (thickness >1540m), falling snow <i>completely melts</i> into raindrops. What happens next depends entirely on the surface layer below:' +
      '<br> If the surface cold layer is <b>deep (>1000 ft)</b>, the raindrop has enough time to refreeze  <span class="k">sleet</span>. You hear it clicking and bouncing.' +
      '<br> If the surface cold layer is <b>shallow (<1000 ft)</b>, the drop doesn\'t have time to refreeze. It hits the ground as supercooled liquid and <i>instantly</i> freezes on any surface  <span class="k">freezing rain</span>.' +
      '<br><br><span class="k">Why this matters so much:</span> Freezing rain is the most damaging winter weather event per occurrence. A half-inch of ice accumulation adds roughly 500 pounds of weight per span of power line. Trees become coated in a crystalline shell that exceeds what their branches can support. Ice storms routinely cause multi-day to multi-week power outages affecting millions.' +
      '<br><br><span class="k">Available on:</span> GFS, NAM.',

    'fcast-tab-gfs850temp': '<b>GFS 850mb Temperature (Global)</b>' +
      '<br><br><span class="k">What this is:</span> Temperature at approximately 5,000 feet elevation on the GFS global grid, showing large-scale thermal patterns across continents and oceans. At this altitude, you\'re above the messy surface boundary layer where local heating, terrain, and urban effects create noise  the 850mb temperature reveals the true character of the air mass overhead.' +
      '<br><br><span class="k">How to use it:</span> Animate the forecast frames and watch the isotherms (temperature contour lines) move:' +
      '<br> Isotherms surging northward = <span class="k">warm air advection (WAA)</span>  overrunning precipitation, warm front development, thickening clouds.' +
      '<br> Isotherms plunging southward = <span class="k">cold air advection (CAA)</span>  post-frontal clearing, gusty NW winds, temperature drops.' +
      '<br><br><span class="k">The 0C isotherm:</span> This single line at 850mb roughly marks the surface rain/snow transition (with caveats for elevation). Tracking its position across forecast frames tells you how the rain/snow line will evolve over the coming days. When the 0C line retreats northward, the rain/snow line shifts north too.' +
      '<br><br><span class="k">Available on:</span> GFS, GEFS.',

    'fcast-tab-850temp': '<b>850mb Temperature (Hi-Res Regional)</b>' +
      '<br><br><span class="k">What this is:</span> Same physical measurement as the GFS 850mb temperature, but on the 3km regional grid. The finer resolution captures terrain-influenced temperature patterns that the GFS smooths over  cold air pooling in valleys, mountain wave lee-side warming, lake-enhanced temperature gradients, and sea/bay breeze boundaries.' +
      '<br><br><span class="k">Severe weather application:</span> The warmer the 850mb air ahead of an advancing dryline or cold front, the greater the potential instability. A tongue of 20C+ air at 850mb in the warm sector of a developing cyclone is a strong indicator that explosive thunderstorm development is possible. Forecasters call this a "warm advection pattern" or "elevated mixed layer"  warm, dry air riding atop a cooler, moist surface layer creates an inherently unstable sandwich that releases violently when the cap breaks.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km only.',

    // 
    // WIND & DYNAMICS
    // 

    'fcast-tab-wind': '<b>10-Meter Wind & Mean Sea Level Pressure (MSLP)</b>' +
      '<br><br><span class="k">What this is:</span> Wind barbs show speed and direction at 10 meters above ground  the standard measurement height. Overlaid isobars (lines of constant pressure) show the sea-level-corrected pressure field in millibars. Together, these two fields reveal the structure and intensity of every weather system on the map.' +
      '<br><br><span class="k">Reading wind barbs:</span> The barb points in the direction the wind is coming FROM. A half line = 5 knots. A full line = 10 knots. A pennant/flag = 50 knots. Example: a barb with 2 full lines + 1 half = 25 knots. Multiply knots  1.15 = mph.' +
      '<br><br><span class="k">Reading isobars:</span> Wind flows roughly parallel to isobars, with a slight inward angle (toward lower pressure) due to surface friction. <span class="k">Tightly packed isobars = strong pressure gradient = high winds.</span> The closer the lines, the harder the wind blows. A 4mb gradient across 100 miles is very tight and produces dangerous winds.' +
      '<br><br><span class="k">What to look for:</span>' +
      '<br> <b>Low pressure centers:</b> Counterclockwise circulation (Northern Hemisphere). The lower the central pressure, the stronger the system.' +
      '<br> <b>Frontal boundaries:</b> Sharp wind direction shifts  where direction changes 90+ over a short distance marks a front. SNW = cold front. SES veering = approaching warm front.' +
      '<br> <b>High pressure:</b> Clockwise flow, calm weather. Strong winter highs produce clear, cold conditions with radiation fog in valleys.' +
      '<br> <b>Pressure falls:</b> Animate frames  rapidly dropping pressure (>4mb in 3 hrs) at your location = an intensifying storm is approaching.',

    'fcast-tab-maxwind': '<b>Maximum Surface Wind Gust</b>' +
      '<br><br><span class="k">What this is:</span> The predicted peak instantaneous wind gust at 10 meters above ground  the absolute strongest gust the model expects. This accounts for convective downdraft mixing (thunderstorm outflow), pressure gradient forces, terrain channeling through gaps and canyons, and downslope windstorms.' +
      '<br><br><span class="k">Damage scale:</span>' +
      '<br> <b>4057 mph:</b> Tree limbs down, loose objects airborne, minor structural damage. Difficult to walk against.' +
      '<br> <b>5874 mph:</b> <span class="k">NWS Severe Thunderstorm Warning threshold (58 mph / 50 kt).</span> Large limbs broken, shallow-rooted trees uprooted, significant roof damage. Flying debris becomes dangerous.' +
      '<br> <b>7595 mph:</b> EF0EF1 tornado equivalent. Extensive tree damage, roof sections peeled, mobile homes heavily damaged. Widespread power outages.' +
      '<br> <b>95110 mph:</b> EF1EF2 equivalent. Major structural roof damage, vehicles shifted, mobile homes destroyed.' +
      '<br> <b>>110 mph:</b> EF2+ equivalent. Well-built homes sustain major damage, vehicles thrown, devastating destruction.' +
      '<br><br><span class="k">Microbursts:</span> A collapsing thunderstorm updraft can produce a localized downburst (<span class="k">microburst</span>) with gusts exceeding 100 mph concentrated in an area less than 2.5 miles across. These are extremely dangerous  they can exceed tornado wind speeds at the surface while having no visible funnel cloud. They\'re also a major cause of aviation accidents during landing and takeoff.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km, HREF only.',

    'fcast-tab-jet': '<b>250mb Jet Stream Wind</b>' +
      '<br><br><span class="k">What this is:</span> Upper-level winds at approximately 34,000 feet (250 millibars)  the altitude of the jet stream, where winds regularly exceed 100 mph. The jet stream is the primary driver of all mid-latitude surface weather. Understanding its position, intensity, and embedded features is the key to forecasting weather days in advance.' +
      '<br><br><span class="k">Jet streaks and the four-quadrant model:</span> Within the broad jet stream, you\'ll find embedded wind maxima called <span class="k">jet streaks</span>  compact zones where winds spike above 100150+ knots. Each jet streak has four quadrants with dramatically different effects on the atmosphere below:' +
      '<br> <b>Right entrance region</b>  Upper-level divergence  air must rise from below to compensate  surface low development, clouds, precipitation.' +
      '<br> <b>Left exit region</b>  Same divergence effect  rising motion  storm development.' +
      '<br> <b>Left entrance / Right exit</b>  Convergence aloft  air sinks  fair weather, clearing, high pressure.' +
      '<br><br><span class="k">Coupled jet streaks:</span> When two jet streaks interact such that the left exit of one overlaps the right entrance of another, the combined divergence is extremely powerful. This coupling produces <span class="k">explosive cyclogenesis</span>  surface pressure dropping 24+ mb in 24 hours (a "bomb cyclone"). These are the setups behind the most powerful nor\'easters and Great Lakes storms.' +
      '<br><br><span class="k">Aviation note:</span> Jet stream winds affect flight times by 12+ hours on transcontinental routes. Clear air turbulence (CAT) is most frequent near jet stream boundaries where wind shear is greatest.',

    'fcast-tab-gfs500wind': '<b>GFS 500mb Wind</b>' +
      '<br><br><span class="k">What this is:</span> The mid-level steering flow at approximately 18,000 feet. The 500mb wind field is the single most important tool for predicting <i>where weather systems will go</i>, because surface lows generally move in the direction of 500mb flow at roughly 5075% of the 500mb wind speed.' +
      '<br><br><span class="k">Speed regimes:</span>' +
      '<br> <b>Strong flow (50+ knots):</b> Systems move quickly. Storms are intense but brief. "Progressive" patterns produce weather that comes and goes.' +
      '<br> <b>Moderate flow (2550 kt):</b> Normal steering. Weather systems take 12 days to cross a region.' +
      '<br> <b>Weak flow (<20 kt):</b> Systems stall. Cutoff lows wander erratically or park for days. Flash flood risk skyrockets because precipitation keeps falling on the same area.' +
      '<br><br><span class="k">Cutoff lows:</span> When a trough detaches from the main jet stream flow, it becomes a "cutoff low" steered only by weak local gradients. These are the most unpredictable features in weather forecasting  they can meander, loop, or stagnate for a week. The classic weather forecaster frustration: "the models can\'t agree on the cutoff."' +
      '<br><br><span class="k">Available on:</span> GFS, GEFS.',

    'fcast-tab-250wind': '<b>250mb Upper-Level Winds (Hi-Res)</b>' +
      '<br><br><span class="k">What this is:</span> Jet stream analysis on the high-resolution 3km grid, resolving finer details of jet streak structure, interaction, and terrain-forced flow accelerations that the coarser GFS misses.' +
      '<br><br><span class="k">Advanced application:</span> Identify jet streak cores exceeding 80 knots and mentally divide each into four quadrants. The <span class="k">right entrance</span> and <span class="k">left exit</span> quadrants produce upper-level divergence that forces air to rise below, creating the large-scale lift that triggers cyclogenesis and severe weather. When a divergent quadrant passes over an area already primed with high surface CAPE and sufficient wind shear, conditions are maximized for tornado outbreaks and long-track supercells.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km only.',

    'fcast-tab-gfs4panel': '<b>4-Panel Composite</b>' +
      '<br><br><span class="k">What this is:</span> A multi-level diagnostic chart combining 850mb vorticity (low-level spin), 500mb geopotential heights and vorticity (mid-level pattern), and 200mb winds (jet stream) on a single display. This is the same chart type that operational NWS forecasters at the Weather Prediction Center (WPC), Storm Prediction Center (SPC), and local offices use daily to assess the three-dimensional state of the atmosphere at a glance.' +
      '<br><br><span class="k">The key concept  vertical stacking:</span> Look at how features at different levels relate to each other vertically:' +
      '<br> <b>Tilted system</b> (upper feature west of surface low)  The system is still intensifying. Upper-level divergence is positioned ahead of and above the surface low, creating strong lift. The most significant weather is still ahead.' +
      '<br> <b>Vertically stacked</b> (all levels aligned over same spot)  The system has reached <span class="k">peak intensity</span> and is beginning to occlude and weaken. The upper-level support is no longer positioned to enhance the surface low.' +
      '<br><br><span class="k">When all three levels show features overlapping geographically</span>  strong 850mb vorticity, a deep 500mb trough, and jet-level divergence above  that\'s where the most significant weather will develop. This chart lets you see that alignment instantly.' +
      '<br><br><span class="k">GFS only.</span>',

    // 
    // SEVERE
    // 

    'fcast-tab-bestcape': '<b>Most Unstable CAPE (MUCAPE)</b>' +
      '<br><br><span class="k">What this is:</span> Unlike standard surface-based CAPE (which lifts the surface air parcel), MUCAPE searches the lowest 300mb (~3km) of the atmosphere to find the single air parcel with the <i>most</i> energy available for convection, regardless of altitude. This catches a critical scenario surface CAPE misses entirely: <span class="k">elevated instability</span>.' +
      '<br><br><span class="k">Why this matters:</span> Sometimes the most unstable air isn\'t at the surface. Above a frontal boundary, a warm, moist layer can exist at 2,0005,000 ft while surface air is stable and cool. Surface CAPE reads zero  no thunderstorm threat. But MUCAPE reveals 2,000+ J/kg of energy sitting right there, waiting for a trigger.' +
      '<br><br><span class="k">Elevated convection:</span> Storms rooted above the surface in an elevated unstable layer behave differently  they\'re harder to detect with surface observations, they often fire at night (when surface cooling strengthens the inversion trapping the elevated moisture), and they can still produce heavy rain, hail, and occasionally tornadoes. Many deadly nighttime flash flood events come from elevated convection that surface CAPE never hinted at.' +
      '<br><br><span class="k">Thresholds are the same as surface CAPE:</span> 5001500 = moderate, 15003000 = strong, >3000 = very strong, >5000 = extreme. But even moderate MUCAPE (10001500) with strong shear can produce significant severe weather when it\'s elevated.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km, HREF only.',

    'fcast-tab-helicity': '<b>03km Storm-Relative Helicity (SRH)</b>' +
      '<br><br><span class="k">What this is:</span> A measure of the rotational potential of the lowest 3 kilometers of the atmosphere <i>relative to a moving thunderstorm</i>. When wind changes speed and/or direction with height (wind shear), it creates horizontal tubes of spinning air. A thunderstorm\'s updraft can tilt these horizontal tubes into the vertical  creating rotation within the storm (a mesocyclone). SRH quantifies how much raw rotation is available for storms to ingest.' +
      '<br><br><span class="k">Threshold scale:</span>' +
      '<br> <b>50100 m/s:</b> Marginal. Brief gustnadoes or landspouts possible, but not organized mesocyclones.' +
      '<br> <b>100200:</b> Weak to moderate rotation. Supercell mesocyclones can develop. Brief, weak tornadoes (EF0EF1) possible.' +
      '<br> <b>200300:</b> Significant rotation. Persistent mesocyclones. Strong tornadoes (EF2EF3) possible.' +
      '<br> <b>300450:</b> Extreme rotation. <span class="k">Strongly favors significant tornadoes (EF2+)</span> when combined with CAPE >1000 J/kg.' +
      '<br> <b>>450:</b> Off the charts. If CAPE is even moderate, violent tornadoes (EF4EF5) are on the table. These are the values seen during major tornado outbreaks like April 27, 2011.' +
      '<br><br><span class="k">The Significant Tornado Parameter (STP):</span> Forecasters don\'t use SRH in isolation. STP combines SRH, CAPE, 06km bulk wind shear, and the lifting condensation level (cloud base height) into a single composite. Low cloud bases (<1000m LCL) are crucial  they mean the rotating mesocyclone is close to the ground, making tornado development more likely. When STP >1, conditions favor significant tornadoes. When all ingredients overlap geographically and temporally, the risk is maximized.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km, HREF only.',

    'fcast-tab-updraft': '<b>Updraft Helicity (UH)</b>' +
      '<br><br><span class="k">What this is:</span> A computed field that identifies <i>where rotating updrafts exist within model-simulated storms</i>. Mathematically, it\'s the integral of (vertical velocity  vertical vorticity) through the 25km layer above ground. In plain language: it finds exactly where the model is producing supercell-like rotating thunderstorms.' +
      '<br><br><span class="k">This is the tornado surrogate field.</span> Because models can\'t explicitly resolve tornadoes (which are ~100m wide, far smaller than the 3km grid), forecasters use UH as a proxy. Research published by the Storm Prediction Center shows a strong statistical correlation between UH tracks in convection-allowing models and observed severe weather reports, including tornadoes.' +
      '<br><br><span class="k">Reading UH tracks:</span>' +
      '<br> <b>2550 m/s:</b> Storm-scale rotation present. Ordinary rotating cells.' +
      '<br> <b>50100:</b> Supercell-like structures. Organized mesocyclones, hail likely, tornado possible.' +
      '<br> <b>100200:</b> Strong supercells. Significant hail, tornado likely.' +
      '<br> <b>>200:</b> Intense mesocyclones. <span class="k">High probability of significant or violent tornado.</span> The model is screaming that this storm is dangerous.' +
      '<br><br><span class="k">Track analysis:</span> Animate UH and study the tracks. Long, continuous UH swaths stretching 50100+ miles indicate long-lived supercells capable of producing long-track tornadoes. Short, scattered UH blips suggest disorganized or short-lived rotation. When the HRRR paints a 150+ m/s UH track stretching across multiple counties, that\'s the model\'s way of forecasting a potentially violent, long-lived supercell.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km, HREF only.',

    'fcast-tab-lightning': '<b>Lightning Threat Index</b>' +
      '<br><br><span class="k">What this is:</span> A model-derived field estimating lightning potential based on ice-phase microphysics inside simulated thunderstorms. Lightning is generated by collisions between rising ice crystals and falling graupel pellets in the mixed-phase zone of the storm (10C to 20C)  these collisions strip electrons and create the electrical charge separation that eventually discharges as lightning.' +
      '<br><br><span class="k">What drives lightning:</span> Three ingredients are needed:' +
      '<br>1. A strong updraft to loft ice and water into the mixed-phase zone' +
      '<br>2. Sufficient graupel (soft hail) production' +
      '<br>3. Vigorous vertical mixing to maximize particle collisions' +
      '<br>The strongest lightning producers are severe thunderstorms with powerful updrafts. Some tropical maritime storms produce minimal lightning despite heavy rain because their updrafts are broad and gentle rather than narrow and explosive.' +
      '<br><br><span class="k">Practical applications:</span>' +
      '<br> <b>Outdoor events:</b> If the model shows lightning threat over your location during your planned time outside, plan for shelter. The 30/30 rule: if the time between flash and thunder is <30 seconds, go inside. Wait 30 minutes after the last thunder.' +
      '<br> <b>Wildfire ignition:</b> Dry thunderstorms (lightning with minimal rain) are the #1 natural cause of wildfire in the western US. Look for lightning threat areas that DON\'T overlap significant precipitation  those are the dry lightning zones.' +
      '<br> <b>Safety radius:</b> Lightning can strike 10+ miles from the nearest rain shaft  well outside the visible storm. If you can hear thunder, you are within strike range. Lightning kills ~20 people per year in the US and injures hundreds more.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km, HREF only.',

    // 
    // UPPER AIR
    // 

    'fcast-tab-rh': '<b>700mb Relative Humidity</b>' +
      '<br><br><span class="k">What this is:</span> Moisture content at approximately 10,000 feet  the mid-troposphere. The 700mb RH field is one of the most diagnostically powerful tools in meteorology because it reveals the large-scale cloud pattern, dry air intrusions, and the internal structure of developing cyclones.' +
      '<br><br><span class="k">Reading the field:</span>' +
      '<br> <b>>80% (dark shading):</b> Saturated air. Expect clouds and precipitation. Broad >80% areas = the main precipitation shield of a storm system.' +
      '<br> <b>5080%:</b> Partly cloudy. Marginal for precipitation. May support light drizzle or patchy fog.' +
      '<br> <b><40% (clear areas):</b> Dry air. Fair skies  or diagnostically important, a <span class="k">dry slot</span> within a storm system.' +
      '<br><br><span class="k">The dry slot:</span> In a developing extratropical cyclone, a tongue of dry air wraps around the west and south side of the low center. This is the <span class="k">dry conveyor belt</span>  descending air from the upper troposphere. When this dry slot wraps completely behind the surface low, the storm has reached maturity and is beginning to occlude.' +
      '<br><br><span class="k">Severe weather context:</span> Dry air at 700mb overlying moist surface air is a setup called an "inverted-V" sounding. Thunderstorms in this environment entrain dry mid-level air into their downdrafts, causing intense evaporative cooling that accelerates downdrafts to produce damaging surface winds. Some of the most violent microbursts occur in this "dry over moist" pattern  common over the High Plains and Desert Southwest.',

    'fcast-tab-gfs500rh': '<b>GFS 500mb Relative Humidity</b>' +
      '<br><br><span class="k">What this is:</span> Moisture at ~18,000 ft on the GFS global grid  showing the large-scale cloud pattern from a higher perspective than 700mb. At 500mb, you see the mid-tropospheric moisture that shapes the cloud patterns visible on satellite imagery.' +
      '<br><br><span class="k">Key diagnostic features:</span>' +
      '<br> <b>The dry slot:</b> The pronounced dry area wrapping around the west side of an extratropical cyclone marks descending upper-tropospheric air  one of three main airstreams in a cyclone (alongside the warm and cold conveyor belts).' +
      '<br> <b>The comma head:</b> The high-RH region wrapping N and W of the surface low creates the classic comma-shaped satellite cloud. This is where the heaviest, most persistent precipitation occurs.' +
      '<br> <b>Instability signal:</b> Dry air at 500mb over moist 700mb air and a moist surface creates steep lapse rates and high convective instability. This configuration ahead of an approaching trough favors explosive thunderstorm development once the cap breaks.' +
      '<br><br><span class="k">Available on:</span> GFS, GEFS.',

    'fcast-tab-gfs850vort': '<b>GFS 850mb Vorticity</b>' +
      '<br><br><span class="k">What this is:</span> Low-level atmospheric spin at approximately 5,000 feet  showing surface fronts, developing lows, and mesoscale vortices. At 850mb, vorticity is more directly connected to surface weather than the 500mb field  you can literally see fronts, lows, and deformation zones in the vorticity pattern.' +
      '<br><br><span class="k">Vertical stacking analysis:</span> Compare 850mb vort max positions with 500mb vort maxes:' +
      '<br> <b>500mb feature WEST of 850mb feature:</b> System is <span class="k">tilted</span>  still intensifying. The most significant weather is still ahead.' +
      '<br> <b>Features aligned vertically:</b> System is <span class="k">vertically stacked</span> at peak intensity, beginning to weaken and occlude.' +
      '<br><br><span class="k">Frontal bands:</span> Strong 850mb vorticity maxima elongated into narrow bands correspond to intense frontal zones where air masses are colliding. These produce the heavy, banded precipitation that causes the worst winter storm impacts.' +
      '<br><br><span class="k">Available on:</span> GFS, NAM.',

    'fcast-tab-500vort': '<b>500mb Vorticity (Hi-Res)</b>' +
      '<br><br><span class="k">What this is:</span> Atmospheric spin at the ~18,000 ft steering level on the high-resolution 3km grid. Resolves finer-scale vorticity features  small shortwaves, mesoscale vortices, and terrain-induced spin that the GFS smooths over.' +
      '<br><br><span class="k">How to use it:</span> Track vorticity maxima frame by frame. The area of maximum <span class="k">Positive Vorticity Advection (PVA)</span>  just ahead (east) of each vort max  is where the atmosphere is forced to rise, triggering surface low development and precipitation. When a vort max crosses your area, expect increasing clouds, lowering pressure, and onset of precipitation.' +
      '<br><br><span class="k">Phasing:</span> When two separate vorticity maxima merge ("phase"), their combined energy produces a much stronger surface storm than either alone. Phasing shortwaves are behind many of the most impactful cyclones.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km only.',

    'fcast-tab-500mb': '<b>500mb Geopotential Heights & Absolute Vorticity</b>' +
      '<br><br><span class="k">What this is:</span> The 500mb surface (~18,000 ft) is the <span class="k">"steering level"</span>  it controls where surface weather systems travel. Height contours show the large-scale wave pattern (ridges and troughs), while vorticity shading reveals the energy embedded in that flow.' +
      '<br><br><span class="k">Troughs and ridges:</span> Southward dips in height contours = <span class="k">troughs</span>  unsettled, stormier weather. Northward bulges = <span class="k">ridges</span>  fair, warmer weather. High-amplitude troughs bring intense cold and storms; high-amplitude ridges bring heat waves and drought.' +
      '<br><br><span class="k">Vorticity maxima ("shortwaves"):</span> Warm-colored (red) blobs embedded in the trough are individual packets of energy moving through the jet stream. The area of maximum <span class="k">PVA</span>  just ahead of each vort max  is where surface cyclogenesis and precipitation are triggered.' +
      '<br><br><span class="k">How to forecast:</span> Animate frames and track the vort maxes. Where they go, weather follows. When multiple shortwaves phase together, the resulting surface storm can be explosive. A 500mb trough that deepens (height values drop lower) as it approaches signals an intensifying storm system.' +
      '<br><br><span class="k">GFS only.</span>',

    // 
    // AVIATION
    // 

    'fcast-tab-vis': '<b>Surface Visibility</b>' +
      '<br><br><span class="k">What this is:</span> Forecast horizontal visibility in miles, accounting for precipitation, fog, haze, blowing snow, and smoke. Visibility is one of the most directly impactful weather variables  it determines safe driving, whether planes can land, and outdoor work feasibility.' +
      '<br><br><span class="k">Aviation flight categories (FAA):</span>' +
      '<br> <b>VFR:</b> Visibility >3 statute miles, ceiling >3000 ft. Normal operations.' +
      '<br> <b>MVFR (Marginal):</b> Visibility 35 miles, ceiling 10003000 ft. Caution.' +
      '<br> <b>IFR (Instrument):</b> Visibility 3 miles, ceiling 2001000 ft. Instrument approaches required. Many small airports close.' +
      '<br> <b>LIFR (Low IFR):</b> Visibility < mile, ceiling <200 ft. Only CAT III airports/aircraft can operate.' +
      '<br><br><span class="k">Fog types:</span>' +
      '<br> <b>Radiation fog:</b> Forms overnight in valleys under clear skies and light winds (<5 mph). Ground radiates heat, cooling air to dewpoint. Usually burns off by mid-morning.' +
      '<br> <b>Advection fog:</b> Warm, moist air moves over cold surface (ocean, snow cover). Can persist for days. Common along coastlines.' +
      '<br> <b>Freezing fog:</b> Fog below 32F. Deposits rime ice on bridges, overpasses, aircraft, and power lines. Creates invisible black ice.' +
      '<br><br><span class="k">Driving safety:</span> Below  mile visibility, multi-vehicle pileups become likely. Use low beams only  high beams reflect off particles and <i>worsen</i> visibility.' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km only.',

    'fcast-tab-ceiling': '<b>Cloud Ceiling Height</b>' +
      '<br><br><span class="k">What this is:</span> The altitude above ground level (AGL) of the lowest cloud layer classified as broken (5/87/8 sky coverage) or overcast (8/8). Scattered clouds don\'t count  you can see through the gaps. The ceiling is the effective "roof" above you.' +
      '<br><br><span class="k">Impact thresholds:</span>' +
      '<br> <b>>3000 ft:</b> VFR. Normal conditions.' +
      '<br> <b>10003000 ft:</b> MVFR. Low overcast. Mountain ridges may be in cloud.' +
      '<br> <b>5001000 ft:</b> Low IFR. Tall buildings enter clouds. Hilly terrain obscured.' +
      '<br> <b>200500 ft:</b> IFR. Very low overcast. Instrument approaches required.' +
      '<br> <b><200 ft:</b> LIFR. Near-zero ceiling. Fog-like conditions at the surface.' +
      '<br><br><span class="k">Terrain hazard  the critical danger:</span> When ceiling heights drop below local terrain elevation, clouds engulf the terrain. Mountain passes, ridgeline roads, and high-elevation highways become extremely dangerous  drivers enter and exit cloud with no warning, losing all visual reference. This is a leading cause of mountain road fatalities in winter. <b>Always check ceiling forecasts before mountain travel.</b>' +
      '<br><br><span class="k">Available on:</span> HRRR, NAM 3km only.',

    // 
    // STRATOSPHERE
    // 

    'fcast-tab-10mb': '<b>10mb Stratospheric Analysis</b>' +
      '<br><br><span class="k">What this is:</span> Conditions at ~31 km (100,000 ft) in the middle stratosphere  above all weather and above commercial aircraft. This shows the <span class="k">stratospheric polar vortex</span>, the massive cyclonic circulation of extremely cold air (80C and below) over the winter pole.' +
      '<br><br><span class="k">Why the stratosphere controls YOUR weather:</span> Normally, a strong polar vortex keeps the tropospheric jet stream organized and zonal (west-to-east), producing a "normal" winter pattern. But when a massive wave energy pulse from the troposphere disrupts the vortex  a <span class="k">Sudden Stratospheric Warming (SSW)</span>  temperatures at 10mb spike 3050C in days and the vortex weakens or reverses direction entirely.' +
      '<br><br><span class="k">The downward cascade:</span> The disruption propagates downward through the atmosphere over 26 weeks. As it reaches the troposphere, it weakens the jet stream, makes it highly amplified (wavy), and produces persistent <span class="k">blocking patterns</span> where high pressure parks over a region and deflects storms for weeks. The result: prolonged cold outbreaks, extended storminess, and weather patterns that get "stuck" for 24 weeks.' +
      '<br><br><span class="k">What to watch for on this chart:</span>' +
      '<br> <b>Tight, circular vortex on the pole:</b> Normal, strong. Winter weather proceeds as expected.' +
      '<br> <b>Elongated or displaced vortex:</b> Weakening. Increased cold outbreak and blocking risk in coming weeks.' +
      '<br> <b>Split vortex (two separate lobes):</b> Major SSW event. Expect significant cold/stormy impacts at the surface 26 weeks later. This is one of the most reliable extended-range predictors available in meteorology.' +
      '<br><br><span class="k">GFS only.</span>'

  };
  // Merge product tooltips into radarInfoData
  Object.keys(productTooltips).forEach(function(k){ radarInfoData[k] = productTooltips[k]; });

  Object.keys(radarInfoData).forEach(function(id){
    var btn = document.getElementById(id);
    if (!btn) return;
    // Make button flex to support the icon on right
    btn.style.display = 'inline-flex';
    btn.style.alignItems = 'center';
    btn.style.gap = '0';
    // Create info icon
    var icon = document.createElement('span');
    icon.className = 'radar-info-icon';
    icon.textContent = '';
    icon.addEventListener('click', function(e){
      e.stopPropagation();
      showRadarTooltip(id, icon);
    });
    icon.addEventListener('mouseenter', function(e){
      showRadarTooltip(id, icon);
    });
    btn.appendChild(icon);
  });

  var radarTooltip = document.getElementById('radar-info-tooltip');
  var radarTooltipTimer = null;

  //  DYNAMIC LIVE DATA INJECTION FOR TOOLTIPS 
  function injectLiveModelState(id, content) {
    // Extract model key from id: 'fcast-model-hrrr'  'hrrr'
    var modelKey = id.replace('fcast-model-', '');
    var isActiveModel = fcastState && fcastState.model === modelKey;

    var live = '<div style="background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;margin-bottom:10px;border-left:3px solid ';

    if (isActiveModel) {
      // This model is currently selected  show full status
      var cycle = fcastState.cycle || '?';
      var idx = fcastState.idx || 0;
      var allFhrs = fcastState.allFhrs || [];
      var currentFhr = allFhrs[idx] || '?';
      var fhrNum = parseInt(currentFhr, 10);
      var totalFrames = allFhrs.length;
      var maxFhr = allFhrs.length > 0 ? parseInt(allFhrs[allFhrs.length - 1], 10) : '?';

      // Calculate init time in local
      var cycleH = parseInt(cycle, 10);
      var now = new Date();
      var todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), cycleH, 0, 0));
      if (todayUTC > now) todayUTC.setUTCDate(todayUTC.getUTCDate() - 1);
      var initLocal = todayUTC.toLocaleString('en-US', {timeZone: LOCATION.tz, hour:'numeric', minute:'2-digit', hour12:true, month:'short', day:'numeric'});
      var hoursAgo = Math.round((now - todayUTC) / 3600000);

      // Valid time
      var validTime = new Date(todayUTC.getTime() + fhrNum * 3600000);
      var validLocal = validTime.toLocaleString('en-US', {timeZone: LOCATION.tz, weekday:'short', hour:'numeric', minute:'2-digit', hour12:true, month:'short', day:'numeric'});

      // Model freshness assessment  
      var freshColor = '#4f8';
      var freshLabel = 'FRESH';
      if (hoursAgo >= 10) { freshColor = '#f66'; freshLabel = 'STALE'; }
      else if (hoursAgo >= 6) { freshColor = '#f90'; freshLabel = 'AGING'; }

      // Forecast hour quality (model-specific)
      var qualColor = '#4f8';
      var qualLabel = 'Sweet spot';
      if (modelKey === 'hrrr') {
        if (fhrNum > 36) { qualColor = '#f66'; qualLabel = 'Low confidence'; }
        else if (fhrNum > 18) { qualColor = '#f90'; qualLabel = 'Degrading skill'; }
        else { qualLabel = 'Peak accuracy (radar-assimilated)'; }
      } else if (modelKey === 'nam' || modelKey === 'nam_hires') {
        if (fhrNum > 60) { qualColor = '#f90'; qualLabel = 'Extended range'; }
        else if (fhrNum > 36) { qualColor = '#cc0'; qualLabel = 'Good'; }
        else { qualLabel = 'Best performance window'; }
      } else if (modelKey === 'gfs' || modelKey === 'gefs') {
        if (fhrNum > 240) { qualColor = '#f66'; qualLabel = 'Low confidence  pattern only'; }
        else if (fhrNum > 168) { qualColor = '#f90'; qualLabel = 'Moderate confidence'; }
        else if (fhrNum > 72) { qualColor = '#cc0'; qualLabel = 'Good for synoptic pattern'; }
        else { qualLabel = 'Best accuracy range'; }
      } else if (modelKey === 'href') {
        if (fhrNum > 36) { qualColor = '#f90'; qualLabel = 'Extended'; }
        else { qualLabel = 'Peak ensemble value'; }
      } else if (modelKey === 'nbm') {
        if (fhrNum > 168) { qualColor = '#f90'; qualLabel = 'Extended blend'; }
        else { qualLabel = 'Calibrated guidance'; }
      }

      live += '#4a9;">';
      live += '<div style="font-weight:700;font-size:.62rem;color:#4a9;margin-bottom:5px;"> ACTIVE  VIEWING NOW</div>';
      live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.52rem;">';
      live += '<span style="opacity:.7;">Init:</span><span>' + cycle + 'Z  ' + initLocal + ' <span style="color:' + freshColor + ';">(' + hoursAgo + 'h ago  ' + freshLabel + ')</span></span>';
      live += '<span style="opacity:.7;">Frame:</span><span>Hour +' + fhrNum + ' of ' + maxFhr + ' (frame ' + (idx + 1) + '/' + totalFrames + ')</span>';
      live += '<span style="opacity:.7;">Valid:</span><span>' + validLocal + '</span>';
      live += '<span style="opacity:.7;">Skill:</span><span style="color:' + qualColor + ';">' + qualLabel + '</span>';
      live += '</div>';
      live += '</div>';
    } else {
      // Not the active model  show comparison note
      var activeModelName = {gfs:'GFS', nam:'NAM', nam_hires:'NAM 3km', hrrr:'HRRR', href:'HREF', nbm:'NBM', gefs:'GEFS'};
      var thisName = activeModelName[modelKey] || modelKey.toUpperCase();
      var activeName = fcastState ? (activeModelName[fcastState.model] || fcastState.model.toUpperCase()) : '?';

      live += 'rgba(100,120,160,.5);">';
      live += '<div style="font-size:.52rem;opacity:.8;">Currently viewing <b>' + activeName + '</b>. Click to switch to ' + thisName + '.</div>';
      live += '</div>';
    }

    // Insert after the first <b>...</b> title + first <br><br>
    var firstBreak = content.indexOf('<br><br>');
    if (firstBreak > 0) {
      return content.substring(0, firstBreak + 8) + live + content.substring(firstBreak + 8);
    }
    return live + content;
  }

  //  LIVE PRODUCT CONTEXT INJECTION FOR PRODUCT TOOLTIPS 
  function injectLiveProductContext(id, content) {
    var wx = window._wxCurrent;
    var alerts = window._nwsAlerts || [];
    var sw = window._swData || {};
    if (!wx) return content;

    var live = '';
    var S = function(l){ return '<div style="background:rgba(255,255,255,.08);border-radius:8px;padding:8px 10px;margin-bottom:10px;border-left:3px solid ' + l; };
    var E = '</div>';
    var G = '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.52rem;">';
    var GE = '</div>';
    var XS = '<div style="background:rgba(120,160,255,.06);border-radius:6px;padding:6px 8px;margin-top:6px;border-left:2px solid rgba(120,160,255,.4);font-size:.50rem;color:rgba(255,255,255,.85);">';

    // Cross-reference builder: synthesizes all available data into unified insight lines
    // Each product appends its own, but we build shared assessments here
    var geoStorm = sw.kp != null && sw.kp >= 5;
    var geoActive = sw.kp != null && sw.kp >= 4;
    var bzSouth = sw.bz != null && sw.bz <= -5;
    var highSolarWind = sw.speed != null && sw.speed > 500;
    var lat = LOCATION ? LOCATION.lat : 40;
    var auroraVisLat = sw.kp != null ? (sw.kp >= 8 ? 35 : sw.kp >= 6 ? 42 : sw.kp >= 5 ? 48 : sw.kp >= 4 ? 55 : 65) : 99;
    var canSeeAurora = lat >= auroraVisLat - 5; // within range
    var clearSky = wx.cloudCover != null && wx.cloudCover < 30;
    var overcast = wx.cloudCover != null && wx.cloudCover >= 80;
    var goodVis = wx.visibility != null && wx.visibility > 8000;
    var isDark = (function(){ if (!wx.sunrise || !wx.sunset) return null; var now = new Date(); var sr = new Date(wx.sunrise); var ss = new Date(wx.sunset); return now < sr || now > ss; })();
    var severeWx = wx.precip > 0.5 || (wx.gust != null && wx.gust >= 58) || (wx.weatherCode >= 95);
    //  UPGRADED: Use real CAPE when available, fall back to proxy 
    var realCAPE = wx.cape != null && wx.cape > 0;
    var convectiveEnv = realCAPE ? wx.cape >= 500 : (wx.dewpoint != null && wx.temp != null && wx.dewpoint >= 55 && wx.temp >= 75);
    var strongConvective = realCAPE ? wx.cape >= 2000 : (wx.dewpoint >= 60 && wx.temp >= 85);
    var extremeConvective = realCAPE ? wx.cape >= 3500 : (wx.dewpoint >= 65 && wx.temp >= 90);
    var strongShear = wx.gust != null && wx.gust >= 35;
    var winterPrecip = wx.temp != null && wx.temp <= 34 && wx.precipProb > 30;
    var fogRisk = wx.temp != null && wx.dewpoint != null && (wx.temp - wx.dewpoint) <= 3 && (wx.wind == null || wx.wind < 8);
    //  NEW: Frontal detection 
    var frontalSig = wx.frontalSignature || null;
    var frontalApproaching = frontalSig === 'cold_front_approaching' || frontalSig === 'warm_front_approaching';
    var frontalPassage = frontalSig === 'cold_front_passage' || frontalSig === 'warm_front_passage';
    //  NEW: AQI cross-reference 
    var aq = window._aqData || {};
    var aqCurrent = aq.current || {};
    var pm25 = aqCurrent.pm2_5 != null ? aqCurrent.pm2_5 : null;
    var usAqi = aqCurrent.us_aqi != null ? aqCurrent.us_aqi : null;
    var smokeImpact = pm25 != null && pm25 >= 35;
    //  NEW: Active fires cross-reference 
    var activeFires = window._activeFires || [];
    var nearbyFireCount = activeFires.length;
    //  NEW: Lifted Index assessment 
    var liUnstable = wx.liftedIndex != null && wx.liftedIndex <= -2;
    var liVeryUnstable = wx.liftedIndex != null && wx.liftedIndex <= -6;
    //  NEW: Significant Tornado Parameter estimate 
    var stpEstimate = (function(){
      if (!realCAPE || wx.cape < 500 || !strongShear) return 0;
      var capeTerm = Math.min(wx.cape / 1500, 2.0);
      var shearTerm = wx.gust >= 50 ? 1.5 : wx.gust >= 35 ? 1.0 : 0.5;
      var moistTerm = wx.dewpoint >= 60 ? 1.2 : wx.dewpoint >= 55 ? 0.8 : 0.4;
      var lclTerm = (wx.temp != null && wx.dewpoint != null) ? (1.0 - Math.min((wx.temp - wx.dewpoint) / 20, 1.0)) : 0.5;
      return +(capeTerm * shearTerm * moistTerm * lclTerm).toFixed(1);
    })();
    //  NEW: Trend summaries for injection 
    function trendArrow(val, unit, threshHi, threshLo) {
      if (val == null) return '';
      if (val >= threshHi) return ' <span style="color:#f44;"> rapidly ' + (unit === 'F' ? 'warming' : 'rising') + ' (' + (val > 0 ? '+' : '') + val + unit + '/3hr)</span>';
      if (val <= threshLo) return ' <span style="color:#4af;"> rapidly ' + (unit === 'F' ? 'cooling' : 'falling') + ' (' + val + unit + '/3hr)</span>';
      if (Math.abs(val) > Math.abs(threshHi) * 0.3) return ' <span style="opacity:.7;">(' + (val > 0 ? '+' : '') + val + unit + '/3hr)</span>';
      return '';
    }
    var tempTrendStr = trendArrow(wx.tempTrend3hr, 'F', 5, -5);
    var dewTrendStr = trendArrow(wx.dewpointTrend3hr, 'F', 5, -5);
    //  NEW: 6hr lookahead warning builder 
    function build6hrLookahead() {
      var parts = [];
      if (wx.next6hrMaxPrecipProb != null && wx.next6hrMaxPrecipProb >= 50 && wx.precipProb < 30) {
        parts.push('<span style="color:#f90;"> Precip probability jumps to ' + wx.next6hrMaxPrecipProb + '% within 6hr</span>');
      }
      if (wx.next6hrMaxGust != null && wx.next6hrMaxGust >= 40 && wx.gust < 25) {
        parts.push('<span style="color:#f90;"> Gusts increase to ' + wx.next6hrMaxGust + ' mph within 6hr</span>');
      }
      if (wx.next6hrMinTemp != null && wx.temp != null && (wx.temp - wx.next6hrMinTemp) >= 10) {
        parts.push('<span style="color:#4af;">Temp dropping to ' + wx.next6hrMinTemp + 'F within 6hr (' + (wx.temp - wx.next6hrMinTemp) + ')</span>');
      }
      if (wx.next6hrMaxTemp != null && wx.temp != null && (wx.next6hrMaxTemp - wx.temp) >= 10) {
        parts.push('<span style="color:#f90;">Temp rising to ' + wx.next6hrMaxTemp + 'F within 6hr (+' + (wx.next6hrMaxTemp - wx.temp) + ')</span>');
      }
      if (frontalApproaching) {
        var fType = frontalSig === 'cold_front_approaching' ? 'Cold front' : 'Warm front';
        parts.push('<span style="color:#f90;"> ' + fType + ' approaching  wind shift + pressure change + temp ' + (frontalSig === 'cold_front_approaching' ? 'drop' : 'rise') + ' expected</span>');
      }
      if (frontalPassage) {
        var fType2 = frontalSig === 'cold_front_passage' ? 'Cold front' : 'Warm front';
        parts.push('<span style="color:#4af;"> ' + fType2 + ' passage detected  wind shifted, ' + (frontalSig === 'cold_front_passage' ? 'clearing/cooling' : 'warming') + ' underway</span>');
      }
      if (frontalSig === 'dryline') {
        parts.push('<span style="color:#f90;"> Dryline detected  dewpoint gradient >10F over 3hr. Prime convective initiation zone.</span>');
      }
      return parts.length > 0 ? '<div style="margin-top:4px;font-size:.50rem;border-top:1px solid rgba(255,255,255,.1);padding-top:4px;">' + parts.join('<br>') + '</div>' + build6hrStrip(wx) : build6hrStrip(wx);
    }

    // Helpers
    function windDirLabel(deg) {
      if (deg == null) return null;
      var dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      return dirs[Math.round(deg / 22.5) % 16];
    }
    function wxCodeLabel(c) {
      if (c == null) return null;
      if (c === 0) return 'Clear sky';
      if (c <= 3) return ['Mainly clear','Partly cloudy','Overcast'][c-1];
      if (c === 45 || c === 48) return 'Fog' + (c === 48 ? ' (depositing rime)' : '');
      if (c >= 51 && c <= 55) return 'Drizzle';
      if (c === 56 || c === 57) return 'Freezing drizzle';
      if (c >= 61 && c <= 65) return ['Light rain','Moderate rain','Heavy rain'][Math.min(Math.floor((c-61)/2),2)];
      if (c === 66 || c === 67) return 'Freezing rain';
      if (c >= 71 && c <= 75) return ['Light snow','Moderate snow','Heavy snow'][Math.min(Math.floor((c-71)/2),2)];
      if (c === 77) return 'Snow grains';
      if (c >= 80 && c <= 82) return 'Rain showers';
      if (c === 85 || c === 86) return 'Snow showers';
      if (c === 95) return 'Thunderstorm';
      if (c === 96 || c === 99) return 'Thunderstorm with hail';
      return 'Code ' + c;
    }
    function approxDbz(rate) {
      if (rate == null || rate <= 0) return null;
      var mmhr = rate * 25.4;
      var z = 200 * Math.pow(mmhr, 1.6);
      return Math.round(10 * Math.log10(z));
    }
    function pressTrend(t) {
      if (t == null) return '';
      if (t <= -3) return ' <span style="color:#f44;"> RAPIDLY FALLING (' + t.toFixed(1) + ' mb/3hr)</span>';
      if (t <= -1.5) return ' <span style="color:#f90;"> falling (' + t.toFixed(1) + ' mb/3hr)</span>';
      if (t < -0.3) return ' <span style="opacity:.8;"> slowly falling (' + t.toFixed(1) + ')</span>';
      if (t <= 0.3) return ' <span style="color:#4f8;"> steady</span>';
      if (t < 1.5) return ' <span style="opacity:.8;"> slowly rising (+' + t.toFixed(1) + ')</span>';
      if (t < 3) return ' <span style="color:#4f8;"> rising (+' + t.toFixed(1) + ' mb/3hr)</span>';
      return ' <span style="color:#4f8;"> RAPIDLY RISING (+' + t.toFixed(1) + ' mb/3hr)</span>';
    }
    var wDir = windDirLabel(wx.windDir);
    var wxLabel = wxCodeLabel(wx.weatherCode);
    var ktsWind = wx.wind != null ? Math.round(wx.wind * 0.868976) : null;
    var ktsGust = wx.gust != null ? Math.round(wx.gust * 0.868976) : null;
    function filterAlerts(keywords) {
      return alerts.filter(function(a) {
        var al = a.toLowerCase();
        for (var i = 0; i < keywords.length; i++) { if (al.indexOf(keywords[i]) >= 0) return true; }
        return false;
      });
    }

    //  REFLECTIVITY PRODUCTS (differentiated per product) 
    //  ATMOSPHERIC SITUATION BANNER  top of every product 
    // One-line assessment of "what's happening" so users always have the big picture
    var _sitBanner = '';
    (function(){
      var parts = [];
      // Current conditions one-liner
      if (wxLabel) parts.push(wxLabel);
      if (wx.temp != null) parts.push(wx.temp + 'F');
      if (wx.wind != null && wDir) parts.push(wDir + ' ' + wx.wind + (wx.gust > wx.wind + 10 ? ' G' + wx.gust : '') + ' mph');
      // Active weather situation
      if (severeWx) parts.push('<span style="color:#f44;font-weight:700;"> SEVERE</span>');
      else if (frontalPassage) parts.push('<span style="color:#4af;"> Frontal passage</span>');
      else if (frontalApproaching) parts.push('<span style="color:#f90;"> Front approaching</span>');
      else if (fogRisk) parts.push('<span style="color:#f90;"> Fog risk</span>');
      else if (wx.precip > 0.1) parts.push(' Active precip');
      else if (winterPrecip) parts.push('<span style="color:#4af;"> Winter precip</span>');
      // Trend summary
      if (wx.pressureTrend != null) {
        if (wx.pressureTrend <= -3) parts.push('<span style="color:#f44;">pressure crashing</span>');
        else if (wx.pressureTrend <= -1.5) parts.push('<span style="color:#f90;">pressure falling</span>');
        else if (wx.pressureTrend >= 3) parts.push('<span style="color:#4f8;">pressure surging</span>');
      }
      // Space weather if notable
      if (geoStorm) parts.push('<span style="color:#a78bfa;">G' + (sw.kp >= 8 ? '4' : sw.kp >= 7 ? '3' : sw.kp >= 6 ? '2' : '1') + ' geomag storm</span>');
      // NWS alerts count
      if (alerts.length > 0) parts.push('<span style="color:#f44;">' + alerts.length + ' alert' + (alerts.length > 1 ? 's' : '') + ' active</span>');
      if (parts.length > 0) {
        _sitBanner = '<div style="font-size:.44rem;color:#aaa;padding:3px 6px;background:rgba(255,255,255,.03);border-radius:4px;margin-bottom:6px;display:flex;flex-wrap:wrap;gap:3px 8px;align-items:center;">';
        _sitBanner += '<span style="font-weight:700;color:#78a0ff;font-size:.38rem;letter-spacing:.5px;">NOW</span>';
        _sitBanner += parts.join('  ');
        _sitBanner += '</div>';
      }
    })();
    // Prepend to live if we have any injection
    var _preBanner = _sitBanner;

    if (id === 'fcast-tab-sim' || id === 'fcast-tab-maxref' || id === 'fcast-tab-radar1km') {
      var col = '#4a9', label = 'DRY';
      if (wx.precip > 0.5) { col = '#f44'; label = 'HEAVY PRECIP'; }
      else if (wx.precip > 0.1) { col = '#f90'; label = 'MODERATE PRECIP'; }
      else if (wx.precip > 0.01) { col = '#cc0'; label = 'LIGHT PRECIP'; }
      else if (wx.precipProb > 60) { col = '#78a0ff'; label = 'PRECIP LIKELY SOON'; }
      live += S(col + ';">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:' + col + ';margin-bottom:2px;"> YOUR LOCATION  ' + label + '</div>';
      live += G;
      if (wxLabel) live += '<span style="opacity:.7;">Conditions:</span><span><b>' + wxLabel + '</b></span>';
      if (wx.precip != null) { var dbz = approxDbz(wx.precip); live += '<span style="opacity:.7;">Precip rate:</span><span>' + wx.precip.toFixed(2) + ' in/hr' + (dbz ? ' (~' + dbz + ' dBZ)' : '') + '</span>'; }
      if (wx.snow > 0) live += '<span style="opacity:.7;">Snowfall:</span><span>' + wx.snow.toFixed(2) + ' in/hr</span>';
      if (wx.precipProb != null) live += '<span style="opacity:.7;">Precip prob:</span><span>' + wx.precipProb + '%</span>';
      if (wx.cloudCover != null) live += '<span style="opacity:.7;">Cloud cover:</span><span>' + wx.cloudCover + '%</span>';
      if (wx.rh != null) live += '<span style="opacity:.7;">Humidity:</span><span>' + wx.rh + '%</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Wind:</span><span>' + wDir + ' ' + wx.wind + ' mph' + (wx.gust > wx.wind + 5 ? ' (G' + wx.gust + ')' : '') + '</span>';
      live += GE;
      if (id === 'fcast-tab-sim') {
        if (wx.precip > 0) live += '<div style="font-size:.52rem;margin-top:4px;"><b>Model verification:</b> Getting ' + wx.precip.toFixed(2) + ' in/hr right now. Compare the model\'s current-hour sim radar against this  if placement and intensity match, trust the forecast hours. If 50+ mi off or missing your precip, discount later hours.</div>';
        else if (wx.precipProb > 60 && wx.cloudCover > 70) live += '<div style="font-size:.52rem;margin-top:4px;">Heavy cloud cover + high precip probability  primed. Watch for returns developing near you in the next frames.</div>';
      } else if (id === 'fcast-tab-maxref') {
        live += '<div style="font-size:.52rem;margin-top:4px;"><b>Elevated core check:</b> ';
        if (wx.precip > 0.3 && wx.dewpoint >= 55) live += 'Active precip with rich moisture (Td ' + wx.dewpoint + 'F). Max ref 10-15+ dBZ above composite = hail cores suspended in updrafts.';
        else if (wx.precip > 0) live += 'Compare max ref to composite at your location. Higher max ref with lower composite = precip aloft hasn\'t reached surface yet.';
        else live += 'When storms develop, max ref spikes before surface returns increase  early warning of intensification.';
        live += '</div>';
      } else {
        live += '<div style="font-size:.52rem;margin-top:4px;"><b>Surface truth:</b> ';
        if (wx.rh < 40) live += 'Very dry air (' + wx.rh + '% RH)  virga conditions. Composite may show returns but 1km will be blank where precip evaporates.';
        else if (wx.precip > 0) live += 'What 1km shows is what you feel. Current rate: ' + wx.precip.toFixed(2) + ' in/hr at the ground.';
        else live += 'No surface precip. 1km cuts through elevated returns and virga to show only what reaches the ground.';
        live += '</div>';
      }
      var precipAlerts = filterAlerts(['flood','storm','rain','thunder','tornado','hurricane']);
      if (precipAlerts.length > 0) live += '<div style="color:#f44;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + precipAlerts.join(', ') + '</div>';
      live += build6hrLookahead();
      //  Storm track intelligence 
      live += buildStormTrackInsight();
      live += E;
    }

    //  ECHO TOPS 
    if (id === 'fcast-tab-echotop') {
      var lat = LOCATION ? LOCATION.lat : 40;
      var now = new Date(); var month = now.getMonth();
      var tropHeight = lat > 50 ? (month >= 5 && month <= 8 ? '38,00042,000' : '28,00035,000') : lat > 35 ? (month >= 5 && month <= 8 ? '42,00048,000' : '35,00042,000') : '48,00055,000';
      live += S('#78a0ff;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#78a0ff;margin-bottom:2px;"> TROPOPAUSE & INSTABILITY</div>';
      live += G;
      live += '<span style="opacity:.7;">Est. tropopause:</span><span><b>' + tropHeight + ' ft</b> (lat ' + lat.toFixed(1) + ', ' + ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][month] + ')</span>';
      if (wx.temp != null) live += '<span style="opacity:.7;">Surface temp:</span><span>' + wx.temp + 'F</span>';
      if (wx.dewpoint != null) live += '<span style="opacity:.7;">Dewpoint:</span><span>' + wx.dewpoint + 'F</span>';
      if (wx.cloudCover != null) live += '<span style="opacity:.7;">Cloud cover:</span><span>' + wx.cloudCover + '%</span>';
      if (wx.freezingLevel != null) live += '<span style="opacity:.7;">Freezing lvl:</span><span>' + Math.round(wx.freezingLevel * 3.28084).toLocaleString() + ' ft  hail melts below this altitude</span>';
      if (wx.cape != null && wx.cape > 0) live += '<span style="opacity:.7;">CAPE:</span><span>' + Math.round(wx.cape) + ' J/kg' + (wx.cape > 2000 ? ' <span style="color:#f90;">high  overshooting tops likely</span>' : '') + '</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.dewpoint >= 60 && wx.temp >= 80) live += '<span style="color:#f44;">Rich moisture + high temps  extreme instability. Expect echo tops easily 50,000+ ft. Any storm with rapidly rising tops is almost certainly severe.</span>';
      else if (wx.dewpoint >= 50 && wx.temp >= 70) live += 'Moderate instability. Echo tops 35,00045,000 ft with organized convection. Tops exceeding ' + tropHeight.split('')[0] + ' ft = severe potential.';
      else if (wx.temp < 50) live += 'Cool conditions limit convective depth. Tops generally below 30,000 ft. Elevated tops suggest dynamic forcing  frontal lift or shortwave interaction.';
      else live += 'Echo tops exceeding the tropopause are <span class="k">overshooting tops</span>. Rising tops = intensifying. Collapsing tops = weakening or downburst risk.';
      live += '</div>' + E;
    }

    //  PRECIP TYPE 
    if (id === 'fcast-tab-ptype') {
      var isWinterPx = (wx.snow > 0 || (wx.weatherCode >= 66 && wx.weatherCode <= 77));
      live += S((isWinterPx ? '#4af' : wx.temp != null && wx.temp <= 36 ? '#f90' : '#78a0ff') + ';">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:' + (isWinterPx ? '#4af' : '#78a0ff') + ';margin-bottom:2px;"> PRECIPITATION PHASE</div>';
      live += G;
      if (wxLabel) live += '<span style="opacity:.7;">Current wx:</span><span><b>' + wxLabel + '</b></span>';
      if (wx.temp != null) live += '<span style="opacity:.7;">Surface temp:</span><span>' + wx.temp + 'F</span>';
      if (wx.dewpoint != null) live += '<span style="opacity:.7;">Dewpoint:</span><span>' + wx.dewpoint + 'F</span>';
      if (wx.pressure != null) live += '<span style="opacity:.7;">Pressure:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      if (wx.snow > 0) live += '<span style="opacity:.7;">Snowfall now:</span><span style="color:#4af;">' + wx.snow.toFixed(2) + ' in/hr</span>';
      if (wx.rain > 0) live += '<span style="opacity:.7;">Rainfall now:</span><span>' + wx.rain.toFixed(2) + ' in/hr</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Wind:</span><span>' + wDir + ' ' + wx.wind + ' mph</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.temp != null) {
        if (wx.temp <= 28) live += '<span style="color:#4af;"> Well below freezing  all precip is snow/ice.</span>';
        else if (wx.temp <= 34) live += '<span style="color:#f90;"> <b>Critical zone</b> (' + wx.temp + 'F)  on the rain/snow line. 12F determines everything. Hardest forecast in meteorology.</span>';
        else if (wx.temp <= 38 && wx.precipProb > 30) live += 'Cool surface. If a warm nose exists at 850mb, freezing rain/sleet is possible. Check 850mb temp and 850-700mb thickness.';
        else if (wx.temp > 38) live += 'Above freezing  rain at your location. Rain/snow line is north or at higher elevations.';
      }
      live += '</div>';
      var winterAlerts = filterAlerts(['winter','ice','freez','snow','blizzard','sleet']);
      if (winterAlerts.length > 0) live += '<div style="color:#4af;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + winterAlerts.join(', ') + '</div>';
      live += E;
    }

    //  PRECIPITATION TOTALS (timescale-differentiated) 
    if (id === 'fcast-tab-ptot' || id === 'fcast-tab-precip1hr' || id === 'fcast-tab-precip6hr' || id === 'fcast-tab-precip24hr') {
      var floodAlerts = filterAlerts(['flood']);
      live += S((floodAlerts.length > 0 ? '#f44' : '#78a0ff') + ';">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:' + (floodAlerts.length > 0 ? '#f44' : '#78a0ff') + ';margin-bottom:2px;">' + (floodAlerts.length > 0 ? ' FLOOD CONTEXT' : ' PRECIPITATION CONTEXT') + '</div>';
      live += G;
      if (wxLabel) live += '<span style="opacity:.7;">Current wx:</span><span><b>' + wxLabel + '</b></span>';
      if (wx.precip != null) live += '<span style="opacity:.7;">Rate now:</span><span>' + wx.precip.toFixed(2) + ' in/hr' + (wx.precip > 0.5 ? ' <span style="color:#f44;">(heavy)</span>' : wx.precip > 0.1 ? ' <span style="color:#f90;">(moderate)</span>' : '') + '</span>';
      if (wx.rh != null) live += '<span style="opacity:.7;">Humidity:</span><span>' + wx.rh + '%' + (wx.rh > 85 ? '  soils near saturation' : '') + '</span>';
      if (wx.pressure != null) live += '<span style="opacity:.7;">Pressure:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (id === 'fcast-tab-precip1hr') {
        if (wx.precip > 0.5) live += '<span style="color:#f44;">Current rate (' + wx.precip.toFixed(2) + ' in/hr) exceeds urban drainage capacity (~0.50"/hr). Flash flooding likely if sustained. Step frame-by-frame to find the heaviest hour.</span>';
        else live += 'Step frame-by-frame to pinpoint peak hourly intensity. Rate jumps from 0.15 to 0.50+ in/hr can trigger flash flooding within minutes.';
      } else if (id === 'fcast-tab-precip6hr') {
        live += 'Compare 6-hr totals against Flash Flood Guidance (FFG). QPF exceeding FFG = flash flooding expected. ';
        if (wx.rh > 85) live += 'Saturated soils lower effective FFG  flooding starts at lower thresholds.';
      } else if (id === 'fcast-tab-precip24hr') {
        live += 'Compare against NOAA Atlas 14 recurrence intervals. ';
        if (wx.precip > 0.25) live += 'Current rate sustained = ' + (wx.precip * 24).toFixed(1) + '" in 24 hrs' + (wx.precip * 24 > 6 ? '  exceeds most regional major flood benchmarks.' : '.');
      } else {
        if (wx.pressureTrend != null && wx.pressureTrend <= -2) live += '<span style="color:#f90;">Rapidly falling pressure  intensifying system. Totals may increase in later model runs.</span>';
        else live += 'Track storm total vs terrain capacity. Urban areas struggle at 23"; arid terrain at 12"; eastern mountains at 46".';
      }
      live += '</div>';
      if (floodAlerts.length > 0) live += '<div style="color:#f44;font-size:.52rem;margin-top:4px;font-weight:600;"> ' + floodAlerts.join(', ') + '</div>';
      live += E;
    }

    //  SNOW ACCUMULATION 
    if (id === 'fcast-tab-snow') {
      live += S('#4af;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#4af;margin-bottom:2px;"> SNOW CONDITIONS</div>';
      live += G;
      if (wxLabel) live += '<span style="opacity:.7;">Current wx:</span><span><b>' + wxLabel + '</b></span>';
      if (wx.temp != null) live += '<span style="opacity:.7;">Surface temp:</span><span>' + wx.temp + 'F</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Wind:</span><span>' + wDir + ' ' + wx.wind + ' mph' + (wx.gust > 25 ? ' <span style="color:#f90;">(G' + wx.gust + '  blowing snow risk)</span>' : '') + '</span>';
      if (wx.snow > 0) live += '<span style="opacity:.7;">Snowfall now:</span><span style="color:#4af;font-weight:600;">' + wx.snow.toFixed(2) + ' in/hr</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.temp != null) {
        var slr = wx.temp <= 10 ? '1520:1' : wx.temp <= 20 ? '1316:1' : wx.temp <= 28 ? '1013:1' : wx.temp <= 32 ? '810:1' : '58:1';
        var slrDesc = wx.temp <= 10 ? 'ultra-light powder, drifts easily' : wx.temp <= 20 ? 'dry fluffy' : wx.temp <= 28 ? 'average, good packing' : wx.temp <= 32 ? 'wet/heavy  strains trees & lines' : 'very wet, minimal accumulation';
        live += '<b>SLR at ' + wx.temp + 'F:</b> <span class="k">' + slr + '</span> (' + slrDesc + '). Ex: 0.5" liquid  ' + slr.split('')[0] + ' = ' + (0.5 * parseInt(slr)).toFixed(0) + '" snow. ';
        if (wx.temp > 35) live += '<span style="color:#f90;">Above freezing  rain, not snow.</span>';
      }
      if (wx.gust > 30 && wx.temp < 35) live += '<br><span style="color:#f90;"> Gusts ' + wx.gust + ' mph + snow = blowing/drifting. Visibility drops even after snow stops. Drifts 35x snowfall in open areas.</span>';
      if (wx.snow > 0.5) live += '<br><span style="color:#f44;">Heavy rate (' + wx.snow.toFixed(2) + ' in/hr)  roads impassable in 3060 min. Near-zero visibility.</span>';
      live += '</div>';
      var wA = filterAlerts(['winter','snow','blizzard','ice']);
      if (wA.length > 0) live += '<div style="color:#4af;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + wA.join(', ') + '</div>';
      live += E;
    }

    //  CAPE / INSTABILITY 
    if (id === 'fcast-tab-bestcape' || id === 'fcast-tab-cape') {
      var capeCol = extremeConvective ? '#f44' : strongConvective ? '#f90' : convectiveEnv ? '#cc0' : '#78a0ff';
      live += S(capeCol + ';">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:' + capeCol + ';margin-bottom:2px;"> INSTABILITY ANALYSIS</div>';
      live += G;
      if (wx.cape != null) live += '<span style="opacity:.7;">CAPE:</span><span><b>' + Math.round(wx.cape) + ' J/kg</b>' + (wx.cape >= 3500 ? ' <span style="color:#f44;">EXTREME</span>' : wx.cape >= 2000 ? ' <span style="color:#f90;">HIGH</span>' : wx.cape >= 1000 ? ' <span style="color:#cc0;">MODERATE</span>' : wx.cape >= 500 ? ' marginal' : '') + (wx.capeTrend3hr != null && Math.abs(wx.capeTrend3hr) > 200 ? (wx.capeTrend3hr > 0 ? ' <span style="color:#f44;">+' + wx.capeTrend3hr + '/3hr BUILDING</span>' : ' <span style="color:#4f8;">' + wx.capeTrend3hr + '/3hr weakening</span>') : '') + sparkCAPE() + '</span>';
      if (wx.liftedIndex != null) live += '<span style="opacity:.7;">Lifted Index:</span><span>' + wx.liftedIndex.toFixed(1) + (wx.liftedIndex <= -6 ? ' <span style="color:#f44;">VERY UNSTABLE</span>' : wx.liftedIndex <= -2 ? ' <span style="color:#f90;">unstable</span>' : wx.liftedIndex <= 0 ? ' marginally unstable' : ' <span style="color:#4f8;">stable</span>') + '</span>';
      if (wx.temp != null) live += '<span style="opacity:.7;">Temp:</span><span>' + wx.temp + 'F' + tempTrendStr + sparkTemp() + '</span>';
      if (wx.dewpoint != null) live += '<span style="opacity:.7;">Dewpoint:</span><span>' + wx.dewpoint + 'F' + dewTrendStr + sparkDewpoint() + (wx.dewpoint >= 65 ? ' <span style="color:#f44;">RICH</span>' : wx.dewpoint >= 55 ? ' <span style="color:#f90;">moderate</span>' : '') + '</span>';
      if (wx.temp != null && wx.dewpoint != null) { var spread = wx.temp - wx.dewpoint; var lclFt = Math.round(spread * 228); live += '<span style="opacity:.7;">LCL est:</span><span>~' + lclFt.toLocaleString() + ' ft AGL' + (lclFt < 3000 ? ' <span style="color:#f44;">LOW  tornado-favorable</span>' : lclFt < 5000 ? ' (moderate)' : ' (high  less tornado-favorable)') + '</span>'; }
      if (wx.pblHeight != null) live += '<span style="opacity:.7;">PBL height:</span><span>' + Math.round(wx.pblHeight) + ' m' + (wx.pblHeight > 2000 ? ' (deep mixing  vigorous convective boundary layer)' : wx.pblHeight > 1000 ? ' (moderate mixing)' : ' (shallow  capped or nocturnal)') + '</span>';
      if (wx.freezingLevel != null) live += '<span style="opacity:.7;">Freezing lvl:</span><span>' + Math.round(wx.freezingLevel * 3.28084).toLocaleString() + ' ft' + (wx.freezingLevel * 3.28084 < 8000 ? '  hail reaching surface more likely' : '') + '</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Sfc wind:</span><span>' + wDir + ' ' + wx.wind + ' mph (' + ktsWind + ' kt)</span>';
      if (wx.gust != null) live += '<span style="opacity:.7;">Gusts:</span><span>' + wx.gust + ' mph (' + ktsGust + ' kt)' + (wx.gustTrend3hr != null && wx.gustTrend3hr > 10 ? ' <span style="color:#f90;"> increasing rapidly</span>' : '') + '</span>';
      if (wx.uv != null && wx.uv > 5) live += '<span style="opacity:.7;">UV index:</span><span>' + wx.uv.toFixed(1) + (wx.uv > 8 ? ' <span style="color:#f44;">(extreme heating)</span>' : ' (strong heating)') + '</span>';
      //  Solar heating / boundary layer coupling 
      if (wx.solarRad != null) live += '<span style="opacity:.7;">Solar flux:</span><span>' + Math.round(wx.solarRad) + ' W/m' + (wx.solarRad > 700 ? ' <span style="color:#f90;">INTENSE  destabilization accelerating</span>' : wx.solarRad > 400 ? ' (strong surface heating)' : wx.solarRad > 100 ? ' (moderate)' : wx.solarRad < 50 ? ' <span style="color:#4af;">(minimal  nocturnal stabilization)</span>' : '') + sparkSolar() + '</span>';
      live += GE;
      // STP gauge when conditions warrant
      if (stpEstimate > 0 && realCAPE) {
        live += buildSTPGauge(stpEstimate);
        live += '<div style="font-size:.46rem;opacity:.7;margin-bottom:2px;">';
        live += stpEstimate >= 3 ? '<span style="color:#f44;">CAPE ' + Math.round(wx.cape) + '  shear  low LCL  moisture all aligned.</span>' : stpEstimate >= 1 ? 'Tornado-favorable. One or more ingredients suboptimal but environment supports rotation.' : 'Marginal tornado support.';
        live += '</div>';
      }
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (realCAPE) {
        // Use REAL CAPE data
        if (wx.cape >= 4000) live += '<span style="color:#f44;"> <b>Extreme instability.</b> ' + Math.round(wx.cape) + ' J/kg CAPE' + (liVeryUnstable ? ' with LI ' + wx.liftedIndex.toFixed(0) : '') + '. ' + (strongShear ? 'Shear confirms supercell environment  violent storms likely.' : 'Check helicity: high CAPE + weak shear = pulse storms with damaging downbursts. High CAPE + strong shear = supercells.') + '</span>';
        else if (wx.cape >= 2500) live += '<span style="color:#f90;"><b>High instability.</b> ' + Math.round(wx.cape) + ' J/kg' + (wx.capeTrend3hr > 500 ? ' and RAPIDLY BUILDING (+' + wx.capeTrend3hr + '/3hr)' : '') + '. Severe thunderstorms likely with any trigger. ' + (strongShear ? 'Supercell mode favored.' : 'Check helicity for storm organization mode.') + '</span>';
        else if (wx.cape >= 1000) live += '<b>Moderate instability</b> (' + Math.round(wx.cape) + ' J/kg). Strong thunderstorms possible. ' + (wx.capeTrend3hr > 300 ? '<span style="color:#f90;">CAPE building rapidly  peak instability ahead.</span>' : wx.capeTrend3hr < -300 ? 'CAPE declining  convective window may be closing.' : 'Watch for trigger mechanisms (front, outflow, terrain).');
        else if (wx.cape >= 250) live += 'Weak instability (' + Math.round(wx.cape) + ' J/kg). Isolated storms possible with strong forcing. ' + (wx.capeTrend3hr > 200 ? '<span style="color:#f90;">CAPE increasing  monitor for threshold crossing.</span>' : '');
        else live += 'Minimal instability (' + Math.round(wx.cape) + ' J/kg). Convection unlikely without extreme dynamic forcing.';
        //  Diurnal cycle context for instability 
        var capeHour = new Date().getHours();
        if (realCAPE && wx.cape >= 250) {
          if (capeHour < 10) live += '<br><span style="opacity:.7;"> <b>Morning:</b> CAPE will increase as surface heats. Peak instability typically 35 PM. Current values are the floor  afternoon CAPE could be 25x higher.</span>';
          else if (capeHour >= 10 && capeHour < 14) live += '<br><span style="opacity:.7;"> <b>Midday:</b> Boundary layer deepening rapidly. CAPE building toward afternoon peak. Watch the CAPE sparkline trend  steep rises = explosive convection potential later.</span>';
          else if (capeHour >= 14 && capeHour < 18) live += '<br><span style="opacity:.7;"> <b>Peak heating:</b> Near maximum instability window. If storms haven\'t fired yet and a cap exists, the first storm to break through will be the strongest  all that stored energy releases at once.</span>';
          else if (capeHour >= 18 && capeHour < 21) live += '<br><span style="opacity:.7;"> <b>Evening:</b> Surface cooling beginning to erode surface CAPE, but elevated instability may persist  favors elevated MCS development overnight.</span>';
          else live += '<br><span style="opacity:.7;"> <b>Overnight:</b> Surface CAPE near zero but MUCAPE can remain. Elevated nocturnal storms feed on residual instability above the surface inversion. These produce heavy rain + flash flooding.</span>';
        }
      } else {
        // Fallback to proxy estimates
        if (wx.dewpoint >= 65 && wx.temp >= 85) live += '<span style="color:#f44;"> <b>Explosive.</b> Td ' + wx.dewpoint + ' + ' + wx.temp + 'F = 3,0005,000+ J/kg CAPE possible. ' + (wx.gust > 25 ? 'Gusty winds suggest shear  supercells/tornadoes likely.' : 'Check helicity for shear to determine convective mode.') + '</span>';
        else if (wx.dewpoint >= 60 && wx.temp >= 80) live += '<b>High instability.</b> CAPE 2,0003,500 J/kg if uncapped. ' + (wx.gust > 25 ? 'Surface gusts (' + wx.gust + ' mph) indicate shear  organized supercells more likely than pulse.' : 'Check helicity to assess convective mode.');
        else if (wx.dewpoint >= 55 && wx.temp >= 70) live += 'Moderate instability. CAPE 1,0002,000 J/kg. Isolated severe possible with trigger (front, dryline, outflow).';
        else if (wx.dewpoint < 40) live += 'Dry low levels (Td ' + wx.dewpoint + 'F). Surface CAPE minimal. MUCAPE may show elevated instability above frontal boundaries. Dry air enhances microburst potential.';
        else live += 'Cool/marginal conditions. Any convection needs strong dynamic forcing.';
      }
      live += '</div>';
      live += build6hrLookahead();
      //  Storm track intelligence 
      live += buildStormTrackInsight();
      var sA = filterAlerts(['tornado','severe','thunder']);
      if (sA.length > 0) live += '<div style="color:#f44;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + sA.join(', ') + '</div>';
      live += E;
    }

    //  HELICITY / UPDRAFT HELICITY (always shows) 
    if (id === 'fcast-tab-helicity' || id === 'fcast-tab-updraft') {
      var isH = (id === 'fcast-tab-helicity');
      live += S('#f90;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#f90;margin-bottom:2px;">' + (isH ? ' SHEAR ENVIRONMENT' : ' ROTATION ENVIRONMENT') + '</div>';
      live += G;
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Sfc wind:</span><span>' + wDir + ' ' + wx.wind + ' mph (' + ktsWind + ' kt)</span>';
      if (wx.gust != null) live += '<span style="opacity:.7;">Gusts:</span><span>' + wx.gust + ' mph (' + ktsGust + ' kt)' + (wx.gust >= 40 ? ' <span style="color:#f90;">STRONG</span>' : '') + sparkGusts() + '</span>';
      if (wx.dewpoint != null) live += '<span style="opacity:.7;">Dewpoint:</span><span>' + wx.dewpoint + 'F' + sparkDewpoint() + '</span>';
      if (wx.pressure != null) live += '<span style="opacity:.7;">MSLP:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (isH) {
        if (wx.gust >= 40) live += '<span style="color:#f44;"><b>Strong shear</b> (' + wx.gust + ' mph gusts). SRH >200 m/s likely. Tornado-favorable if CAPE >1,000 J/kg.</span>';
        else if (wx.gust >= 25) live += '<b>Moderate shear</b> (gusts ' + wx.gust + ' mph). SRH 100200 m/s expected. With CAPE >1,500 J/kg, organized supercells can produce tornadoes.';
        else live += 'Light surface winds. Helicity depends on full 03km profile  the model may show shear aloft not visible at the surface.' + (wx.windDir != null && wx.windDir >= 130 && wx.windDir <= 200 ? ' Southerly surface flow + backed winds aloft = classic tornado setup.' : '');
      } else {
        if (wx.dewpoint >= 60 && wx.gust >= 30) live += '<span style="color:#f44;">Rich moisture + strong shear = prime rotation environment. UH >75 m/s = supercells. >150 m/s = intense mesocyclones, high tornado probability.</span>';
        else if (wx.dewpoint >= 50 && wx.gust >= 20) live += 'Moderate environment. Long continuous UH tracks = persistent rotating storms. Short blips = brief spin-ups.';
        else live += 'Limited instability/shear. Watch for isolated UH maxima near boundaries where local shear is enhanced.';
      }
      live += '</div>';
      var sA2 = filterAlerts(['tornado','severe']);
      if (sA2.length > 0) live += '<div style="color:#f44;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + sA2.join(', ') + '</div>';
      live += E;
    }

    //  WIND & MSLP 
    if (id === 'fcast-tab-wind') {
      live += S('#78a0ff;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#78a0ff;margin-bottom:2px;"> SURFACE WIND & PRESSURE</div>';
      live += G;
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Wind:</span><span>' + wDir + ' ' + wx.wind + ' mph (' + ktsWind + ' kt)  barb: ' + Math.floor(ktsWind/10) + ' line' + (Math.floor(ktsWind/10) !== 1 ? 's' : '') + (ktsWind%10 >= 5 ? '+half' : '') + (wx.windDirTrend3hr != null && Math.abs(wx.windDirTrend3hr) > 20 ? ' <span style="color:#f90;"> shifted ' + (wx.windDirTrend3hr > 0 ? 'veering (clockwise)' : 'backing (counter-CW)') + ' ' + Math.abs(wx.windDirTrend3hr) + ' in 3hr</span>' : '') + sparkWindSpeed() + '</span>';
      if (wx.gust != null) live += '<span style="opacity:.7;">Gusts:</span><span>' + wx.gust + ' mph (' + ktsGust + ' kt)' + (wx.gustTrend3hr != null && Math.abs(wx.gustTrend3hr) > 8 ? (wx.gustTrend3hr > 0 ? ' <span style="color:#f90;"> +' + wx.gustTrend3hr + ' mph/3hr</span>' : ' <span style="color:#4f8;"> ' + wx.gustTrend3hr + ' mph/3hr</span>') : '') + sparkGusts() + '</span>';
      if (wx.pressure != null) live += '<span style="opacity:.7;">MSLP:</span><span>' + Math.round(wx.pressure) + ' mb (' + (wx.pressure * 0.029529983).toFixed(2) + ' inHg)' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      if (wx.pressureTrend6hr != null) live += '<span style="opacity:.7;">6hr trend:</span><span>' + (wx.pressureTrend6hr > 0 ? '+' : '') + wx.pressureTrend6hr + ' mb' + (Math.abs(wx.pressureTrend6hr) >= 6 ? ' <span style="color:#f44;">SIGNIFICANT  major system</span>' : Math.abs(wx.pressureTrend6hr) >= 3 ? ' <span style="color:#f90;">notable change</span>' : '') + '</span>';
      //  AQI cross-reference for wind stagnation 
      if (wx.wind < 5 && usAqi != null && usAqi > 80) live += '<span style="opacity:.7;">AQI impact:</span><span style="color:#f90;">Stagnant winds concentrating pollutants  AQI ' + usAqi + (wx.pblHeight != null && wx.pblHeight < 500 ? '. PBL only ' + Math.round(wx.pblHeight) + 'm  inversion trapping.' : '') + '</span>';
      live += GE;
      // Frontal detection
      if (frontalSig) {
        live += '<div style="font-size:.52rem;margin-top:4px;background:rgba(255,153,0,.1);border-radius:4px;padding:4px 6px;">';
        if (frontalSig === 'cold_front_passage') live += '<span style="color:#4af;"> <b>COLD FRONT PASSAGE DETECTED.</b> Wind veered ' + (wx.windDirTrend3hr > 0 ? '+' + wx.windDirTrend3hr + '' : '') + ', pressure rising, temp dropping ' + (wx.tempTrend3hr != null ? wx.tempTrend3hr + 'F' : '') + '. Expect clearing, gusty NW winds, then sharp cooling.</span>';
        else if (frontalSig === 'cold_front_approaching') live += '<span style="color:#f90;"> <b>COLD FRONT APPROACHING.</b> Pressure falling ' + (wx.pressureTrend != null ? '(' + wx.pressureTrend + ' mb/3hr)' : '') + ' with warming ahead of the front. Wind shift imminent  watch for veering to W/NW.</span>';
        else if (frontalSig === 'warm_front_passage') live += '<span style="color:#f90;"> <b>WARM FRONT PASSAGE.</b> Temp rising ' + (wx.tempTrend3hr != null ? '+' + wx.tempTrend3hr + 'F' : '') + '. Warm sector air now in place  if unstable, thunderstorm development possible.</span>';
        else if (frontalSig === 'warm_front_approaching') live += '<span style="color:#f90;"> <b>WARM FRONT APPROACHING.</b> Gradual pressure fall with warming. Expect increasing clouds, possible light precip (overrunning), then warm sector.</span>';
        else if (frontalSig === 'dryline') live += '<span style="color:#f90;"> <b>DRYLINE DETECTED.</b> Sharp moisture gradient (dewpoint shift >10F/3hr). Classic Plains severe weather trigger  convection often fires explosively along the dryline.</span>';
        live += '</div>';
      }
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.pressureTrend != null && wx.pressureTrend <= -3) live += '<span style="color:#f44;"> <b>Rapidly falling pressure</b>  strong low approaching/deepening. Isobars tightly packed near you on the model. Expect winds to increase significantly.</span>';
      else if (wx.pressureTrend != null && wx.pressureTrend >= 3) live += '<span style="color:#4f8;">Rapidly rising pressure  storm departing. Initial gusty winds then diminishing.</span>';
      else if (wx.pressure < 1000) live += 'Low pressure  active cyclone. Look for tightly packed isobars and counterclockwise flow on the model.';
      else if (wx.pressure > 1025) live += 'Strong high pressure. Clockwise flow, calm conditions.';
      else live += 'Find your location on the model and note isobar spacing. Tighter = stronger gradient = stronger winds.';
      live += '</div>';
      live += build6hrLookahead();
      //  Storm track intelligence 
      live += buildStormTrackInsight();
      var wA2 = filterAlerts(['wind','gale','hurricane','tropical']);
      if (wA2.length > 0) live += '<div style="color:#f90;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + wA2.join(', ') + '</div>';
      live += E;
    }

    //  HUMIDITY 
    if (id === 'fcast-tab-rh' || id === 'fcast-tab-gfs500rh') {
      live += S('#78a0ff;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#78a0ff;margin-bottom:2px;"> MOISTURE PROFILE</div>';
      live += G;
      if (wx.rh != null) live += '<span style="opacity:.7;">Surface RH:</span><span>' + wx.rh + '%' + sparkRH() + '</span>';
      if (wx.temp != null) live += '<span style="opacity:.7;">Temp:</span><span>' + wx.temp + 'F' + tempTrendStr + sparkTemp() + '</span>';
      if (wx.dewpoint != null) live += '<span style="opacity:.7;">Dewpoint:</span><span>' + wx.dewpoint + 'F' + dewTrendStr + sparkDewpoint() + '</span>';
      if (wx.temp != null && wx.dewpoint != null) live += '<span style="opacity:.7;">T-Td spread:</span><span>' + (wx.temp - wx.dewpoint) + 'F' + ((wx.temp - wx.dewpoint) <= 3 ? ' <span style="color:#4af;">(fog/clouds at surface)</span>' : (wx.temp - wx.dewpoint) <= 5 ? ' <span style="color:#f90;">(low clouds likely)</span>' : '') + '</span>';
      if (wx.cloudCover != null) live += '<span style="opacity:.7;">Cloud cover:</span><span>' + wx.cloudCover + '%' + sparkCloudCover() + '</span>';
      if (wx.visibility != null) live += '<span style="opacity:.7;">Visibility:</span><span>' + (wx.visibility * 0.000621371).toFixed(1) + ' mi</span>';
      //  Boundary layer height  critical for moisture trapping 
      if (wx.pblHeight != null) live += '<span style="opacity:.7;">PBL height:</span><span>' + Math.round(wx.pblHeight) + ' m' + (wx.pblHeight > 2500 ? ' (deep mixing  dry air entrained)' : wx.pblHeight < 500 ? ' <span style="color:#f90;">(shallow  trapped moisture' + (fogRisk ? ', fog forming' : '') + ')</span>' : wx.pblHeight < 200 ? ' <span style="color:#f44;">(severe inversion  all moisture/pollutants trapped)</span>' : '') + '</span>';
      if (wx.soilMoisture != null) live += '<span style="opacity:.7;">Soil moisture:</span><span>' + (wx.soilMoisture * 100).toFixed(1) + '%' + (wx.soilMoisture > 0.4 ? ' <span style="color:#4af;">saturated  flood risk elevated</span>' : wx.soilMoisture < 0.1 ? ' <span style="color:#f44;">very dry  fire risk + poor absorption</span>' : '') + '</span>';
      if (wx.pblHeight != null) live += '<span style="opacity:.7;">PBL height:</span><span>' + Math.round(wx.pblHeight) + ' m' + (wx.pblHeight > 2500 ? ' (deep mixing  dry air entrained)' : wx.pblHeight < 500 ? ' (shallow  trapped moisture)' : '') + '</span>';
      //  AQI/smoke 
      if (pm25 != null && pm25 >= 12) live += '<span style="opacity:.7;">PM2.5:</span><span>' + pm25.toFixed(1) + ' g/m' + (pm25 >= 55 ? ' <span style="color:#f44;">heavy smoke</span>' : pm25 >= 35 ? ' <span style="color:#f90;">moderate smoke</span>' : '') + '</span>';
      live += GE;
      //  Soil moisture gauge 
      live += buildSoilMoistureGauge(wx.soilMoisture);
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.rh > 95) live += '<span style="color:#4af;">Near-saturation (' + wx.rh + '%). Fog/drizzle likely. If 700mb is also >80%, moisture is deep  persistent clouds and precip.' + (wx.soilMoisture > 0.35 ? ' Saturated soils amplify flood risk from any rainfall.' : '') + '</span>';
      else if (wx.rh > 80) live += 'High humidity. If 700mb is also wet, precip supported. If 700mb is dry while surface is moist, a cap exists  instability present but suppressed.';
      else if (wx.rh > 50) live += 'Moderate moisture. Compare with 700mb RH  both 5080% = light precip possible. 700mb much drier = strong cap.';
      else if (wx.rh > 30) live += 'Dry air. If 700mb also dry, fair skies. Dry surface under moist mid-levels = enhanced downdraft potential (microbursts).';
      else live += '<span style="color:#f90;">Very dry (' + wx.rh + '%). Extreme fire risk' + (wx.soilMoisture != null && wx.soilMoisture < 0.1 ? ' + bone-dry soils (' + (wx.soilMoisture * 100).toFixed(0) + '%)' : '') + '. Any precip will evaporate (virga). Dry lightning = wildfire ignition scenario.' + (nearbyFireCount > 0 ? ' <span style="color:#f44;">' + nearbyFireCount + ' active fire' + (nearbyFireCount > 1 ? 's' : '') + ' in region.</span>' : '') + '</span>';
      live += '</div>';
      var fA = filterAlerts(['fire','red flag']);
      if (fA.length > 0) live += '<div style="color:#f44;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + fA.join(', ') + '</div>';
      live += E;
    }

    //  TEMPERATURE 
    if (id === 'fcast-tab-temp' || id === 'fcast-tab-wndtemp' || id === 'fcast-tab-gfs850temp' || id === 'fcast-tab-850temp') {
      var is850 = (id === 'fcast-tab-gfs850temp' || id === 'fcast-tab-850temp');
      live += S('#78a0ff;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#78a0ff;margin-bottom:2px;"> ' + (is850 ? '850mb THERMAL CONTEXT' : 'SURFACE THERMAL STATE') + '</div>';
      live += G;
      if (wx.temp != null) live += '<span style="opacity:.7;">Surface temp:</span><span>' + wx.temp + 'F' + tempTrendStr + sparkTemp() + '</span>';
      if (wx.feels != null && wx.feels !== wx.temp) live += '<span style="opacity:.7;">Feels like:</span><span>' + wx.feels + 'F (' + (wx.feels < wx.temp ? 'wind chill' : 'heat index') + ')</span>';
      if (wx.dewpoint != null) live += '<span style="opacity:.7;">Dewpoint:</span><span>' + wx.dewpoint + 'F' + dewTrendStr + sparkDewpoint() + '</span>';
      if (wx.hiToday != null && wx.loToday != null) live += '<span style="opacity:.7;">Today range:</span><span>' + wx.loToday + '  ' + wx.hiToday + ' (swing: ' + (wx.hiToday - wx.loToday) + 'F)</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Wind:</span><span>' + wDir + ' ' + wx.wind + ' mph</span>';
      //  NEW: Freezing level for winter context 
      if (wx.freezingLevel != null) live += '<span style="opacity:.7;">Freezing lvl:</span><span>' + Math.round(wx.freezingLevel * 3.28084).toLocaleString() + ' ft AGL' + (wx.freezingLevel < 500 ? ' <span style="color:#4af;">NEAR SURFACE  snow possible at all elevations</span>' : '') + '</span>';
      //  NEW: Tomorrow preview 
      if (wx.hiTomorrow != null && wx.loTomorrow != null) {
        var tDelta = wx.hiTomorrow - wx.hiToday;
        live += '<span style="opacity:.7;">Tomorrow:</span><span>' + wx.loTomorrow + '  ' + wx.hiTomorrow + '' + (Math.abs(tDelta) >= 8 ? ' <span style="color:#f90;">(' + (tDelta > 0 ? '+' : '') + tDelta + ' from today  ' + (tDelta > 0 ? 'warming' : 'cooling') + ' trend)</span>' : '') + '</span>';
      }
      live += GE;
      // Frontal context
      if (frontalSig && !is850) {
        live += '<div style="font-size:.52rem;margin-top:4px;background:rgba(255,153,0,.08);border-radius:4px;padding:4px 6px;">';
        if (frontalSig === 'cold_front_passage') live += ' <b>Post-frontal cooling underway.</b> Temp dropped ' + (wx.tempTrend3hr != null ? Math.abs(wx.tempTrend3hr) + 'F' : '') + ' in 3hr. Expect continued cooling + clearing.';
        else if (frontalSig === 'warm_front_passage') live += ' <b>Warm advection.</b> Temp rose ' + (wx.tempTrend3hr != null ? '+' + wx.tempTrend3hr + 'F' : '') + ' in 3hr. Warm sector air  check instability for storm potential.';
        else if (frontalSig === 'cold_front_approaching') live += ' Pre-frontal warming in progress. Max temps likely before frontal passage, then sharp cooling.';
        else if (frontalSig === 'warm_front_approaching') live += ' Warm front approaching  gradual warming with increasing clouds and possible light precip.';
        live += '</div>';
      }
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (is850) {
        live += '<b>850mb  5,000 ft AGL.</b> ';
        if (wx.temp <= 32) live += 'Surface below freezing. If 850mb is above 0C while surface is cold = warm nose = <b>freezing rain/sleet</b> potential.';
        else if (wx.temp >= 80) live += 'Warm surface confirms deep warm layer supporting convective instability.' + (wx.cape != null ? ' CAPE: ' + Math.round(wx.cape) + ' J/kg.' : '');
        else live += '850mb temp advection reveals frontal positions  sharp gradients mark warm/cold fronts.';
      } else {
        if (wx.feels != null && Math.abs(wx.temp - wx.feels) > 10) live += '<span style="color:#f90;">Feels-like spread ' + Math.abs(wx.temp - wx.feels) + 'F. Impact is significantly ' + (wx.feels < wx.temp ? 'colder  frostbite risk' : 'hotter  heat illness risk') + ' than the map shows.</span>';
        else live += 'Watch for frontal gradients  where temp changes 1020F over short distance marks a front. Compare with wind shifts on Wind & MSLP.';
      }
      live += '</div>';
      live += build6hrLookahead();
      //  Inversion / AQI cross-reference for surface temp 
      if (!is850 && wx.pblHeight != null && wx.pblHeight < 500 && usAqi != null && usAqi > 50) {
        live += '<div style="font-size:.48rem;color:#f90;margin-top:4px;background:rgba(255,153,0,.06);border-radius:4px;padding:3px 6px;"> <b>Inversion detected:</b> PBL at ' + Math.round(wx.pblHeight) + 'm with AQI ' + usAqi + '. The same temperature inversion trapping cold surface air is concentrating pollutants. AQI improves when the boundary layer deepens' + (wx.solarRad != null && wx.solarRad < 100 ? '  low solar input means the inversion may persist.' : wx.solarRad > 300 ? '  solar heating should break it within hours.' : '.') + '</div>';
      }
      var hcA = filterAlerts(['heat','cold','chill','freeze','frost','excessive']);
      if (hcA.length > 0) live += '<div style="color:#f90;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + hcA.join(', ') + '</div>';
      live += E;
    }

    //  VISIBILITY / CEILING 
    if (id === 'fcast-tab-vis' || id === 'fcast-tab-ceiling') {
      var isCeil = (id === 'fcast-tab-ceiling');
      live += S('#78a0ff;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#78a0ff;margin-bottom:2px;">' + (isCeil ? ' CEILING CONDITIONS' : ' VISIBILITY CONDITIONS') + '</div>';
      live += G;
      if (wx.visibility != null) { var visMi = (wx.visibility * 0.000621371).toFixed(1); var visCat = visMi > 3 ? 'VFR' : visMi > 1 ? 'MVFR' : visMi > 0.5 ? 'IFR' : 'LIFR'; var visCol = visCat === 'VFR' ? '#4f8' : visCat === 'MVFR' ? '#78a0ff' : visCat === 'IFR' ? '#f90' : '#f44'; live += '<span style="opacity:.7;">Visibility:</span><span>' + visMi + ' mi <span style="color:' + visCol + ';font-weight:600;">(' + visCat + ')</span></span>'; }
      if (wx.cloudCover != null) live += '<span style="opacity:.7;">Total clouds:</span><span>' + wx.cloudCover + '%' + (wx.cloudCover >= 87 ? ' (overcast)' : wx.cloudCover >= 62 ? ' (broken)' : wx.cloudCover >= 37 ? ' (scattered)' : ' (few/clear)') + '</span>';
      //  Cloud layer breakdown 
      if (wx.cloudLow != null || wx.cloudMid != null || wx.cloudHigh != null) {
        live += '</div>'; // close grid temporarily for the visual
        live += buildCloudStackVisual(wx.cloudLow, wx.cloudMid, wx.cloudHigh);
        live += G; // reopen grid
      }
      if (wx.temp != null && wx.dewpoint != null) live += '<span style="opacity:.7;">T-Td spread:</span><span>' + (wx.temp - wx.dewpoint) + 'F' + ((wx.temp - wx.dewpoint) <= 3 ? ' <span style="color:#f90;"> FOG LIKELY</span>' : '') + '</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Wind:</span><span>' + wDir + ' ' + wx.wind + ' mph</span>';
      //  NEW: AQI/smoke cross-reference 
      if (usAqi != null) live += '<span style="opacity:.7;">AQI:</span><span>' + usAqi + (usAqi > 150 ? ' <span style="color:#f44;">UNHEALTHY  smoke/haze reducing visibility</span>' : usAqi > 100 ? ' <span style="color:#f90;">USG  sensitive groups affected</span>' : usAqi > 50 ? ' <span style="color:#cc0;">Moderate</span>' : ' <span style="color:#4f8;">Good</span>') + '</span>';
      if (pm25 != null && pm25 >= 20) live += '<span style="opacity:.7;">PM2.5:</span><span>' + pm25.toFixed(1) + ' g/m' + (pm25 >= 55 ? ' <span style="color:#f44;">heavy particulate  visibility degraded</span>' : pm25 >= 35 ? ' <span style="color:#f90;">elevated</span>' : '') + '</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.temp != null && wx.dewpoint != null && (wx.temp - wx.dewpoint) <= 3) {
        if (wx.wind < 5) live += '<span style="color:#f90;"> <b>Radiation fog setup:</b> T-Td ' + (wx.temp - wx.dewpoint) + 'F + calm winds. Dense fog likely' + (wx.sunrise ? ', thickening until sunrise then burning off by mid-morning.' : '.') + '</span>';
        else live += 'Low T-Td spread with wind suggests low stratus (ceiling 2001,000 ft) rather than ground fog.';
      } else if (smokeImpact) {
        live += '<span style="color:#f90;"> <b>Smoke impact:</b> PM2.5 ' + pm25.toFixed(0) + ' g/m  visibility degraded by wildfire smoke' + (nearbyFireCount > 0 ? ' (' + nearbyFireCount + ' active fire' + (nearbyFireCount > 1 ? 's' : '') + ' in region)' : '') + '. Haze may persist for days even after visible smoke clears. HRRR may underestimate visibility in smoke plumes.</span>';
      } else if (isCeil) {
        if (wx.cloudCover >= 87) live += 'Overcast  ceiling height critical for aviation and mountain visibility.';
        else if (wx.cloudCover < 30) live += 'Clear/few clouds  ceiling unrestricted.';
        if (wx.cloudLow > 70 && wx.cloudMid < 30) live += ' Low clouds dominate  stratus/fog layer. Ceiling likely <3,000 ft.';
        else if (wx.cloudMid > 70 && wx.cloudLow < 20) live += ' Mid-level clouds dominant  altostratus/altocumulus. Ceiling ~6,000-15,000 ft.';
      } else {
        if (wx.rh > 90) live += 'High humidity  haze reducing visibility even without fog/precip.';
        else if (wx.precipProb > 60) live += 'Precip approaching. Heavy rain visibility <1 mi; heavy snow < mi.';
      }
      live += '</div>';
      //  Astronomical observing quality (night sky cross-reference) 
      if (isDark && clearSky) {
        var vSee = 0; var vTrans = 0;
        if (wx.wind < 5) vSee += 2; else if (wx.wind < 12) vSee++; else if (wx.wind > 20) vSee -= 2; else if (wx.wind > 15) vSee--;
        if (wx.tempTrend3hr != null) { if (Math.abs(wx.tempTrend3hr) < 1.5) vSee += 2; else if (Math.abs(wx.tempTrend3hr) < 3) vSee++; else vSee--; }
        if (wx.pblHeight != null) { if (wx.pblHeight < 300) vSee++; else if (wx.pblHeight > 1500) vSee--; }
        if (clearSky) vTrans += 3; else if (wx.cloudCover < 15) vTrans += 2; else if (wx.cloudCover < 40) vTrans++;
        if (goodVis) vTrans += 2; else if (wx.visibility > 5000) vTrans++;
        if (wx.rh != null) { if (wx.rh < 50) vTrans += 2; else if (wx.rh < 70) vTrans++; else if (wx.rh > 85) vTrans--; }
        if (pm25 != null) { if (pm25 < 12) vTrans++; else if (pm25 > 35) vTrans -= 2; else if (pm25 > 20) vTrans--; }
        live += '<div style="background:rgba(100,255,150,.06);border-radius:4px;padding:4px 6px;margin-top:4px;border-left:2px solid rgba(100,255,150,.3);">';
        live += buildSeeingTransBars(vSee, vTrans);
        if (wx.cloudHigh != null && wx.cloudHigh > 30 && wx.cloudLow < 10) live += '<div style="font-size:.42rem;opacity:.7;">High cirrus (' + wx.cloudHigh + '%) may dim faint objects but won\'t block bright targets.</div>';
        if (wx.tempTrend3hr != null && Math.abs(wx.tempTrend3hr) > 5) live += '<div style="font-size:.42rem;color:#f90;">Rapidly changing temperature degrades seeing (turbulent air column).</div>';
        live += '</div>';
      }
      var fogA = filterAlerts(['fog','visibility']);
      if (fogA.length > 0) live += '<div style="color:#f90;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + fogA.join(', ') + '</div>';
      //  Astronomer's Intelligence (in visibility/ceiling products) 
      live += buildTonightsTargets();
      live += E;
    }

    //  LIGHTNING 
    if (id === 'fcast-tab-lightning') {
      live += S('#ff0;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#ff0;margin-bottom:2px;"> THUNDERSTORM ENVIRONMENT</div>';
      live += G;
      if (wxLabel) live += '<span style="opacity:.7;">Current wx:</span><span><b>' + wxLabel + '</b>' + (wx.weatherCode >= 95 ? ' <span style="color:#ff0;font-weight:600;"> ACTIVE TSTORM</span>' : '') + '</span>';
      if (wx.temp != null) live += '<span style="opacity:.7;">Temp:</span><span>' + wx.temp + 'F</span>';
      if (wx.dewpoint != null) live += '<span style="opacity:.7;">Dewpoint:</span><span>' + wx.dewpoint + 'F</span>';
      if (wx.rh != null) live += '<span style="opacity:.7;">RH:</span><span>' + wx.rh + '%</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Wind:</span><span>' + wDir + ' ' + wx.wind + ' mph</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.weatherCode >= 95) live += '<span style="color:#ff0;font-weight:600;"> Active thunderstorm! Compare model lightning placement with actual strikes to verify accuracy.</span>';
      else if (wx.dewpoint >= 65 && wx.temp >= 85) live += '<span style="color:#f44;"> Extreme lightning potential. Td ' + wx.dewpoint + ' + ' + wx.temp + 'F = prolific charge separation. 10,000+ flashes/hr possible.</span>';
      else if (wx.dewpoint >= 60 && wx.temp >= 80) live += 'High lightning potential  rich moisture + strong heating.';
      else if (wx.rh < 30 && wx.temp > 80) live += '<span style="color:#f90;"> <b>Dry lightning risk.</b> RH ' + wx.rh + '%  any thunder produces lightning without surface rain. #1 wildfire ignition cause. Watch for lightning threat areas NOT overlapping precip.</span>';
      else if (wx.dewpoint >= 50 && wx.temp >= 70) live += 'Moderate convective potential.';
      else live += 'Limited thermodynamic support. Needs strong dynamic forcing for any lightning.';
      live += '</div>';
      var tA = filterAlerts(['thunder','tornado','severe','lightning']);
      if (tA.length > 0) live += '<div style="color:#f44;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + tA.join(', ') + '</div>';
      live += E;
    }

    //  10mb STRATOSPHERE 
    if (id === 'fcast-tab-10mb') {
      var now = new Date(); var m = now.getMonth(); var isWinter = (m >= 10 || m <= 2);
      live += S('#a78bfa;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#a78bfa;margin-bottom:2px;"> POLAR VORTEX</div>';
      live += '<div style="font-size:.52rem;">';
      if (isWinter) {
        live += '<b>Winter</b>  vortex active. ' + (wx.pressure != null && wx.pressure < 1005 ? 'Your low surface pressure (' + Math.round(wx.pressure) + ' mb) may reflect vortex-influenced jet pattern. ' : '');
        live += 'SSW now would cause 26 week pattern disruption through ' + ['Jan','Feb','Mar','Apr','May'][Math.min(m <= 2 ? m + 1 : m - 9, 4)] + '. Look for: tight circle = strong/stable; elongated = blocking risk; split = major SSW.';
      } else live += '<b>Warm season</b>  vortex weak/absent. This chart is most diagnostic NovMar.';
      live += '</div>' + E;
    }

    //  JET STREAM / 250mb 
    if (id === 'fcast-tab-jet' || id === 'fcast-tab-250wind') {
      live += S('#a78bfa;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#a78bfa;margin-bottom:2px;"> JET STREAM COUPLING</div>';
      live += G;
      if (wx.pressure != null) live += '<span style="opacity:.7;">MSLP:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Sfc wind:</span><span>' + wDir + ' ' + wx.wind + ' mph (' + ktsWind + ' kt)</span>';
      if (wx.cloudCover != null) live += '<span style="opacity:.7;">Clouds:</span><span>' + wx.cloudCover + '%</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.pressure < 1000) live += '<span style="color:#f44;">Very low pressure (' + Math.round(wx.pressure) + ' mb)  active cyclone. The jet streak\'s <b>right entrance</b> or <b>left exit</b> should be overhead, providing divergence deepening this low.</span>';
      else if (wx.pressureTrend != null && wx.pressureTrend <= -2) live += '<span style="color:#f90;">Rapidly falling pressure  approaching jet streak divergence driving intensification.</span>';
      else if (wx.pressure > 1020) live += 'High pressure  you\'re in a convergent quadrant (left entrance/right exit) with subsidence maintaining the ridge.';
      else {
        live += 'Find jet streak cores (>80 kt). Right entrance + left exit = divergence = storms. Left entrance + right exit = convergence = fair.';
        if (wx.windDir != null) live += ' Surface ' + wDir + ' wind  compare with upper flow for veering (warm advection) or backing (cold advection).';
      }
      live += '</div>' + E;
    }

    //  500mb WIND 
    if (id === 'fcast-tab-gfs500wind') {
      live += S('#78a0ff;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#78a0ff;margin-bottom:2px;"> STEERING FLOW</div>';
      live += G;
      if (wx.pressure != null) live += '<span style="opacity:.7;">MSLP:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Sfc wind:</span><span>' + wDir + ' ' + wx.wind + ' mph</span>';
      if (wx.precipProb != null) live += '<span style="opacity:.7;">Precip prob:</span><span>' + wx.precipProb + '%</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.pressure < 1005) live += 'Nearby cyclone. Surface lows move at 5075% of 500mb speed in the 500mb flow direction.' + (wx.pressureTrend <= -2 ? ' <span style="color:#f90;">Rapid deepening  strong 500mb forcing.</span>' : '');
      else if (wx.precipProb > 50) live += 'Weather approaching. Weak 500mb flow (<25 kt) = stalling/flood risk. Strong (>50 kt) = fast-moving, brief.';
      else live += '<20 kt = stalling/cutoff risk. 2550 kt = normal. >50 kt = fast progressive pattern.' + (wx.cloudCover < 30 ? ' Clear skies confirm benign flow regime.' : '');
      live += '</div>' + E;
    }

    //  500mb VORTICITY / HEIGHTS 
    if (id === 'fcast-tab-500vort' || id === 'fcast-tab-500mb') {
      live += S('#78a0ff;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#78a0ff;margin-bottom:2px;"> SYNOPTIC DIAGNOSIS</div>';
      live += G;
      if (wx.pressure != null) live += '<span style="opacity:.7;">MSLP:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      if (wx.cloudCover != null) live += '<span style="opacity:.7;">Clouds:</span><span>' + wx.cloudCover + '%</span>';
      if (wx.precipProb != null) live += '<span style="opacity:.7;">Precip prob:</span><span>' + wx.precipProb + '%</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Sfc wind:</span><span>' + wDir + ' ' + wx.wind + ' mph</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.pressure < 1005 && wx.precipProb > 50) live += '<span style="color:#f90;"><b>Active weather.</b> Low MSLP + high precip prob = PVA zone. A vort max is near/overhead on the map.' + (wx.pressureTrend <= -2 ? ' Rapid deepening confirms strong upper forcing.' : '') + '</span>';
      else if (wx.cloudCover > 80 && wx.precipProb > 30) live += 'Overcast with precip likely. Shortwave approaching  look upstream on the map.';
      else if (wx.cloudCover < 25 && wx.pressure > 1015) live += 'Clear + high pressure = ridge axis or NVA (subsidence) zone. Heights high on the 500mb chart at your location.';
      else live += 'Animate vort maxes to track weather drivers. Each one triggers a surface event as it crosses your longitude.';
      live += '</div>' + E;
    }

    //  850mb VORTICITY 
    if (id === 'fcast-tab-gfs850vort') {
      live += S('#78a0ff;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#78a0ff;margin-bottom:2px;"> LOW-LEVEL SPIN</div>';
      live += G;
      if (wx.pressure != null) live += '<span style="opacity:.7;">MSLP:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Sfc wind:</span><span>' + wDir + ' ' + wx.wind + ' mph (' + ktsWind + ' kt)</span>';
      if (wx.gust != null) live += '<span style="opacity:.7;">Gusts:</span><span>' + wx.gust + ' mph (' + ktsGust + ' kt)</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.pressure < 1005) live += '850mb vort maxima track with surface lows. MSLP ' + Math.round(wx.pressure) + ' mb  look for an 850mb vort max stacked near/west of the surface low. ';
      if (wx.gust > 30) live += 'Strong gusts (' + wx.gust + ' mph) + 850mb vorticity enhances tornado efficiency in convective environments. ';
      var n2 = new Date(), m2 = n2.getMonth();
      if (m2 >= 10 || m2 <= 2) live += '<span style="color:#4af;"> Winter: Heaviest snow falls along and north of the 850mb vort max track.</span>';
      else if (m2 >= 3 && m2 <= 5) live += 'Spring: 850mb vort + dryline + low-level jet = classic severe/tornado setup.';
      else live += '850mb vort tracks correspond to frontal waves and mesolow development that focus convection.';
      live += '</div>' + E;
    }

    //  4-PANEL COMPOSITE 
    if (id === 'fcast-tab-gfs4panel') {
      live += S('#a78bfa;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#a78bfa;margin-bottom:2px;"> ATMOSPHERIC STATE</div>';
      live += G;
      if (wxLabel) live += '<span style="opacity:.7;">Wx:</span><span><b>' + wxLabel + '</b></span>';
      if (wx.pressure != null) live += '<span style="opacity:.7;">MSLP:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      if (wx.temp != null) live += '<span style="opacity:.7;">Temp:</span><span>' + wx.temp + 'F' + (wx.feels != null && wx.feels !== wx.temp ? ' (feels ' + wx.feels + ')' : '') + '</span>';
      if (wx.dewpoint != null) live += '<span style="opacity:.7;">Td:</span><span>' + wx.dewpoint + 'F</span>';
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Wind:</span><span>' + wDir + ' ' + wx.wind + (wx.gust > wx.wind + 5 ? ' G' + wx.gust : '') + ' mph</span>';
      if (wx.cloudCover != null) live += '<span style="opacity:.7;">Clouds:</span><span>' + wx.cloudCover + '%</span>';
      if (wx.precipProb != null) live += '<span style="opacity:.7;">Precip:</span><span>' + wx.precipProb + '%' + (wx.precip > 0 ? ' (' + wx.precip.toFixed(2) + ' in/hr)' : '') + '</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;"><b>Vertical phasing:</b> ';
      if (wx.pressure < 1005 && wx.precipProb > 50) live += '<span style="color:#f90;">Active system. Check if 850mb vort, 500mb trough, and 200mb divergence are stacked. <b>Tilted</b> = still intensifying. <b>Stacked</b> = peaking/weakening.</span>';
      else if (wx.pressureTrend <= -2) live += '<span style="color:#f90;">Falling pressure. Look for approaching 850mb warm advection  500mb shortwave  200mb divergence alignment.</span>';
      else live += 'Check pattern: jet position (200mb), shortwave location (500mb), thermal advection (850mb). Next weather change arrives when these features phase over your location.';
      live += '</div>' + E;
    }

    //  THICKNESS 
    if (id === 'fcast-tab-lowthick' || id === 'fcast-tab-midthick') {
      var isLow = (id === 'fcast-tab-lowthick');
      live += S('#4af;">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:#4af;margin-bottom:2px;">' + (isLow ? ' RAIN/SNOW LINE' : ' WARM NOSE / ICE CHECK') + '</div>';
      live += G;
      if (wx.temp != null) live += '<span style="opacity:.7;">Surface temp:</span><span>' + wx.temp + 'F</span>';
      if (wx.dewpoint != null) live += '<span style="opacity:.7;">Dewpoint:</span><span>' + wx.dewpoint + 'F</span>';
      if (wx.precipProb != null) live += '<span style="opacity:.7;">Precip prob:</span><span>' + wx.precipProb + '%</span>';
      if (wx.snow > 0) live += '<span style="opacity:.7;">Snow now:</span><span style="color:#4af;">' + wx.snow.toFixed(2) + ' in/hr</span>';
      if (wx.rain > 0) live += '<span style="opacity:.7;">Rain now:</span><span>' + wx.rain.toFixed(2) + ' in/hr</span>';
      if (wx.pressure != null) live += '<span style="opacity:.7;">Pressure:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (isLow) {
        if (wx.temp <= 28) live += 'Below freezing  thickness below 1,300m. All snow.';
        else if (wx.temp <= 34) live += '<span style="color:#f90;"> <b>Critical zone</b> (' + wx.temp + 'F). Near the 1,300m thickness line. A 50-mile shift changes everything  rain vs snow. Watch animation for line movement.</span>';
        else if (wx.temp <= 40) live += 'Cool. If thickness drops during the event (cold advection), the rain/snow line can shift south to include you.';
        else live += 'Above threshold  rain at your location. Track where 1,300m intersects precip for the rain/snow boundary.';
      } else {
        if (wx.temp <= 34 && wx.precipProb > 30) live += '<span style="color:#f44;"> <b>ICE STORM CHECK.</b> Surface ' + wx.temp + 'F + precip likely. If 850-700mb thickness is elevated (warm nose), snow melts aloft then refreezes on contact = FREEZING RAIN. Thin warm layer = sleet. Deep warm layer = freezing rain. Most dangerous winter precip type.</span>';
        else if (wx.temp <= 38 && wx.precipProb > 20) live += 'Cool surface + approaching precip. Monitor for incoming warm nose  warm front overrunning cold surface air creates the ice storm profile.';
        else live += 'Thickness advection reveals frontal structure. Warming = warm front approach. Cooling = cold front passage.';
      }
      live += '</div>';
      var wA3 = filterAlerts(['winter','ice','freez','snow','blizzard','sleet']);
      if (wA3.length > 0) live += '<div style="color:#4af;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + wA3.join(', ') + '</div>';
      live += E;
    }

    //  MAX WIND GUST 
    if (id === 'fcast-tab-maxwind') {
      var gC = wx.gust > 57 ? '#f44' : wx.gust > 39 ? '#f90' : '#78a0ff';
      live += S(gC + ';">\n');
      live += '<div style="font-weight:700;font-size:.62rem;color:' + gC + ';margin-bottom:2px;"> WIND DAMAGE ASSESSMENT</div>';
      live += G;
      if (wx.wind != null && wDir) live += '<span style="opacity:.7;">Sustained:</span><span>' + wDir + ' ' + wx.wind + ' mph (' + ktsWind + ' kt)</span>';
      if (wx.gust != null) { live += '<span style="opacity:.7;">Gusts:</span><span>' + wx.gust + ' mph (' + ktsGust + ' kt)'; if (wx.gust >= 58) live += ' <span style="color:#f44;font-weight:600;"> SEVERE (58 mph)</span>'; else if (wx.gust >= 40) live += ' <span style="color:#f90;">damaging</span>'; live += '</span>'; }
      if (wx.wind > 0 && wx.gust != null) { var gr = (wx.gust / wx.wind).toFixed(1); live += '<span style="opacity:.7;">Gust factor:</span><span>' + gr + 'x' + (gr > 2.0 ? ' (convective outflow/terrain)' : gr > 1.5 ? ' (gusty)' : ' (steady gradient)') + '</span>'; }
      if (wx.pressure != null) live += '<span style="opacity:.7;">MSLP:</span><span>' + Math.round(wx.pressure) + ' mb' + pressTrend(wx.pressureTrend) + sparkPressure() + '</span>';
      live += GE;
      live += '<div style="font-size:.52rem;margin-top:4px;">';
      if (wx.gust >= 58) live += '<span style="color:#f44;"><b>Severe threshold exceeded.</b> Current gusts meet NWS warning criteria. If model shows lower values now, future peaks are also underestimated  apply correction.</span>';
      else if (wx.gust >= 40) live += 'Damaging gusts. Compare model current-hour values with observations to calibrate trust in future peak predictions.';
      else if (wx.pressureTrend <= -3) live += '<span style="color:#f90;">Rapidly falling pressure  gradient tightening. Even with modest current gusts, model peak forecasts may verify or exceed.</span>';
      else live += 'Compare model current-hour max gust with observations. Model accuracy now calibrates trust in later forecasts.';
      live += '</div>';
      var wA4 = filterAlerts(['wind','gale','hurricane','tropical']);
      if (wA4.length > 0) live += '<div style="color:#f44;font-size:.52rem;margin-top:4px;font-weight:600;"> Active: ' + wA4.join(', ') + '</div>';
      live += E;
    }

    // 
    // WEATHER EVENT CHAINS  like the solar chain, each product knows
    // its role in active meteorological sequences and cross-references
    // upstream causes and downstream consequences
    // 
    if (live) {
      var xref = '';
      // Product  chain role mapping
      var upperAir = ['fcast-tab-jet','fcast-tab-250wind','fcast-tab-gfs500wind','fcast-tab-500vort','fcast-tab-500mb','fcast-tab-gfs850vort','fcast-tab-10mb','fcast-tab-gfs4panel'];
      var surface = ['fcast-tab-wind','fcast-tab-temp','fcast-tab-wndtemp'];
      var instability = ['fcast-tab-bestcape','fcast-tab-cape','fcast-tab-echotop'];
      var shear = ['fcast-tab-helicity','fcast-tab-updraft'];
      var precip = ['fcast-tab-sim','fcast-tab-maxref','fcast-tab-radar1km','fcast-tab-ptype','fcast-tab-ptot','fcast-tab-precip1hr','fcast-tab-precip6hr','fcast-tab-precip24hr'];
      var winterProducts = ['fcast-tab-ptype','fcast-tab-lowthick','fcast-tab-midthick','fcast-tab-snow','fcast-tab-gfs850temp','fcast-tab-850temp'];
      var moistureProducts = ['fcast-tab-rh','fcast-tab-gfs500rh','fcast-tab-vis','fcast-tab-ceiling'];
      var isUpper = upperAir.indexOf(id) >= 0;
      var isSurface = surface.indexOf(id) >= 0;
      var isInstability = instability.indexOf(id) >= 0;
      var isShear = shear.indexOf(id) >= 0;
      var isPrecip = precip.indexOf(id) >= 0;
      var isWinter = winterProducts.indexOf(id) >= 0;
      var isMoisture = moistureProducts.indexOf(id) >= 0;

      // 
      // CHAIN 1: SEVERE WEATHER (convective)
      // Jet  Surface setup  CAPE  Shear  Storms  Hazards
      // 
      if (convectiveEnv || severeWx || (wx.weatherCode >= 95) || (frontalSig === 'dryline')) {
        var sevStages = [
          { icon: '', label: 'Jet/Upper', active: wx.pressureTrend != null && wx.pressureTrend <= -1.5 },
          { icon: '', label: 'Surface', active: wx.wind > 10 || (wx.pressureTrend != null && Math.abs(wx.pressureTrend) >= 1.5) || frontalApproaching },
          { icon: '', label: 'CAPE', active: convectiveEnv },
          { icon: '', label: 'Shear', active: strongShear },
          { icon: '', label: 'Storms', active: wx.weatherCode >= 80 || wx.precip > 0.1 },
          { icon: '', label: 'Hazards', active: severeWx }
        ];
        var sevActive = sevStages.filter(function(s){ return s.active; }).length;

        if (sevActive >= 2 || convectiveEnv) {
          xref += '<div style="margin-bottom:6px;">';
          xref += '<div style="font-weight:600;font-size:.50rem;color:#f90;margin-bottom:3px;"> SEVERE WEATHER CHAIN</div>';
          xref += '<div style="display:flex;gap:1px;margin-bottom:2px;font-size:.40rem;">';
          sevStages.forEach(function(s) {
            var myStage = (isUpper && s.label.indexOf('Jet')>=0) || (isSurface && s.label==='Surface') || (isInstability && s.label==='CAPE') || (isShear && s.label==='Shear') || (isPrecip && s.label==='Storms') || (id==='fcast-tab-lightning' && s.label==='Hazards') || (id==='fcast-tab-maxwind' && s.label==='Hazards');
            var bg = s.active ? 'rgba(255,153,0,.25)' : 'rgba(255,255,255,.05)';
            var col = s.active ? '#f90' : 'rgba(255,255,255,.3)';
            var bdr = myStage ? 'border:1px solid #f90;box-shadow:0 0 4px rgba(255,153,0,.4);' : 'border:1px solid transparent;';
            xref += '<div style="flex:1;text-align:center;padding:2px;border-radius:3px;background:' + bg + ';color:' + col + ';' + bdr + '">' + s.icon + '<br>' + s.label + '</div>';
          });
          xref += '</div>';

          // Narrative for THIS product's position in the chain
          if (isUpper) {
            xref += 'You\'re viewing the <b>forcing mechanism</b>. ';
            if (wx.pressureTrend <= -2) xref += 'Falling pressure confirms active upper forcing. ';
            xref += '<b>Downstream:</b> Check CAPE for instability buildup  helicity for shear  reflectivity for storm initiation.';
          } else if (isSurface) {
            xref += 'You\'re at the <b>surface setup</b> stage. ';
            if (wDir && wx.windDir >= 130 && wx.windDir <= 200) xref += 'Southerly flow importing moisture + warmth. ';
            xref += '<b>Upstream:</b> Jet/vorticity provide forcing. <b>Downstream:</b> CAPE shows if instability is realized  helicity determines storm mode.';
          } else if (isInstability) {
            xref += 'You\'re viewing <b>fuel</b> for convection. ';
            if (realCAPE) xref += '<b>CAPE ' + Math.round(wx.cape) + ' J/kg</b>' + (wx.liftedIndex != null ? ', LI ' + wx.liftedIndex.toFixed(0) : '') + '. ';
            else if (convectiveEnv) xref += 'Td ' + wx.dewpoint + 'F + T ' + wx.temp + 'F = significant instability. ';
            if (strongShear) xref += '<span style="color:#f44;"><b>Cross-check:</b> Surface gusts ' + wx.gust + ' mph confirm shear  supercell environment.' + (stpEstimate >= 1 ? ' STP ~' + stpEstimate + (stpEstimate >= 3 ? '  SIGNIFICANT TORNADO ENVIRONMENT' : '') + '.' : '') + '</span>';
            else xref += '<b>Critical check:</b> Helicity/updraft helicity determines organized (supercell) vs scattered (pulse) mode.';
          } else if (isShear) {
            xref += 'You\'re viewing the <b>organization mechanism</b>. ';
            if (convectiveEnv) xref += '<span style="color:#f44;">Instability IS present (Td ' + wx.dewpoint + 'F). CAPE  shear = <b>Significant Tornado Parameter</b>. </span>';
            else xref += 'Instability check: ';
            if (convectiveEnv && strongShear) xref += 'ALL INGREDIENTS PRESENT. Watch reflectivity for storm initiation and echo tops for rapid growth.';
            else if (convectiveEnv) xref += 'Fuel present, needs shear increase for organized storms.';
          } else if (isPrecip || id === 'fcast-tab-echotop') {
            xref += 'You\'re seeing the <b>result</b> of the upstream chain. ';
            if (severeWx) xref += '<span style="color:#f44;">Severe conditions active. </span>';
            if (convectiveEnv && strongShear) xref += 'Environment is loaded  any new storm in this profile should be treated as potentially severe.';
            xref += ' <b>Check:</b> Lightning for electrical hazards  max wind for damaging gust forecasts.';
          } else if (id === 'fcast-tab-lightning' || id === 'fcast-tab-maxwind') {
            xref += '<b>Hazard product.</b> ';
            if (convectiveEnv && strongShear) xref += 'The full ingredient chain is active: jet forcing + surface moisture + CAPE + shear. These hazards are a direct result of that chain.';
            else if (wx.weatherCode >= 95) xref += 'Active thunderstorms producing hazards. Check upstream products to assess if environment supports continuation/intensification.';
          }
          xref += '</div>';
        }
      }

      // 
      // CHAIN 2: WINTER STORM
      // Upper trough  Surface low  Moisture  Thermal profile  Precip type  Accumulation
      // 
      if (winterPrecip || (wx.snow > 0) || (wx.temp != null && wx.temp <= 36 && wx.precipProb > 40)) {
        var winStages = [
          { icon: '', label: 'Trough', active: wx.pressureTrend != null && wx.pressureTrend <= -1.5 },
          { icon: '', label: 'Sfc Low', active: wx.pressure != null && wx.pressure < 1008 },
          { icon: '', label: 'Moisture', active: wx.rh != null && wx.rh > 70 },
          { icon: '', label: 'Thermal', active: wx.temp != null && wx.temp <= 36 },
          { icon: '', label: 'Type', active: wx.snow > 0 || (wx.weatherCode >= 66 && wx.weatherCode <= 77) },
          { icon: '', label: 'Accum', active: wx.snow > 0.1 }
        ];
        var winActive = winStages.filter(function(s){ return s.active; }).length;

        if (winActive >= 2) {
          xref += '<div style="margin-bottom:6px;">';
          xref += '<div style="font-weight:600;font-size:.50rem;color:#4af;margin-bottom:3px;"> WINTER STORM CHAIN</div>';
          xref += '<div style="display:flex;gap:1px;margin-bottom:2px;font-size:.40rem;">';
          winStages.forEach(function(s) {
            var myStage = (isUpper && s.label==='Trough') || (id==='fcast-tab-wind' && s.label==='Sfc Low') || (isMoisture && s.label==='Moisture') || ((id==='fcast-tab-gfs850temp'||id==='fcast-tab-850temp'||id==='fcast-tab-lowthick'||id==='fcast-tab-midthick') && s.label==='Thermal') || (id==='fcast-tab-ptype' && s.label==='Type') || (id==='fcast-tab-snow' && s.label==='Accum');
            var bg = s.active ? 'rgba(68,170,255,.2)' : 'rgba(255,255,255,.05)';
            var col = s.active ? '#4af' : 'rgba(255,255,255,.3)';
            var bdr = myStage ? 'border:1px solid #4af;box-shadow:0 0 4px rgba(68,170,255,.4);' : 'border:1px solid transparent;';
            xref += '<div style="flex:1;text-align:center;padding:2px;border-radius:3px;background:' + bg + ';color:' + col + ';' + bdr + '">' + s.icon + '<br>' + s.label + '</div>';
          });
          xref += '</div>';

          if (isUpper) {
            xref += '<b>Forcing:</b> Upper trough drives the surface low. <b>Check:</b> 850mb temp for warm nose  thickness for rain/snow line  precip type for what actually falls.';
          } else if (id === 'fcast-tab-wind') {
            xref += 'Surface low organizes the storm. <b>Wind field:</b> heaviest precip typically north/northwest of the low center. Blowing snow risk if gusts >25 mph.';
          } else if (isMoisture) {
            xref += 'Moisture feeds the storm. Deep-layer saturation  steady precip. Dry air aloft with moist surface  enhanced snowfall rates from dendritic growth zone.';
          } else if (id === 'fcast-tab-gfs850temp' || id === 'fcast-tab-850temp' || id === 'fcast-tab-lowthick' || id === 'fcast-tab-midthick') {
            xref += '<b>CRITICAL STAGE.</b> The thermal profile determines everything: ';
            if (wx.temp <= 28) xref += 'well below freezing  all snow.';
            else if (wx.temp <= 34) xref += '<span style="color:#f90;">MARGINAL (' + wx.temp + 'F). Check 850mb for warm nose (freezing rain) and 1000-850mb thickness for rain/snow line.</span>';
            else xref += 'above freezing  rain at surface. Check if cooling is expected.';
          } else if (id === 'fcast-tab-ptype') {
            xref += '<b>Upstream determines this:</b> 850mb temp sets warm/cold nose  thickness shows the layer depth  this product shows the model\'s verdict. <b>Verify:</b> Compare with thickness  disagreements flag model uncertainty.';
          } else if (id === 'fcast-tab-snow') {
            xref += 'End of the chain. <b>Verify upstream:</b> Precip type confirms snow reaches surface. Thickness confirms no warm nose. Multiply QPF by snow-liquid ratio at current temp for expected depth.';
          } else if (isPrecip) {
            xref += '<b>Winter context:</b> Returns could be rain, snow, or ice. Check precip type + thickness to decode what\'s actually falling at the surface.';
          }
          xref += '</div>';
        }
      }

      // 
      // CHAIN 3: FLOOD EVENT
      // Antecedent moisture  Moisture transport  Forcing  Heavy rain  Exceeds capacity  Flooding
      // 
      if ((wx.precip > 0.25 && wx.precipProb > 60) || (wx.precip > 0.5) || (filterAlerts(['flood']).length > 0) || (wx.soilMoisture > 0.4 && wx.precipProb > 50)) {
        var fldStages = [
          { icon: '', label: 'Soil', active: (wx.rh != null && wx.rh > 80) || (wx.soilMoisture != null && wx.soilMoisture > 0.35) },
          { icon: '', label: 'Transport', active: wx.rh > 70 && (wx.wind > 15 || (wx.dewpoint != null && wx.dewpoint >= 60)) },
          { icon: '', label: 'Forcing', active: wx.pressureTrend != null && wx.pressureTrend <= -1.5 },
          { icon: '', label: 'Rain', active: wx.precip > 0.1 },
          { icon: '', label: 'Capacity', active: wx.precip > 0.3 || (wx.soilMoisture > 0.4 && wx.precip > 0.1) },
          { icon: '', label: 'Flood', active: filterAlerts(['flood']).length > 0 || wx.precip > 0.5 }
        ];
        var fldActive = fldStages.filter(function(s){ return s.active; }).length;

        if (fldActive >= 3 || filterAlerts(['flood']).length > 0) {
          xref += '<div style="margin-bottom:6px;">';
          xref += '<div style="font-weight:600;font-size:.50rem;color:#f44;margin-bottom:3px;"> FLOOD EVENT CHAIN</div>';
          xref += '<div style="display:flex;gap:1px;margin-bottom:2px;font-size:.40rem;">';
          fldStages.forEach(function(s) {
            var myStage = (isMoisture && s.label==='Soil') || ((id==='fcast-tab-gfs500wind'||id==='fcast-tab-jet') && s.label==='Transport') || (isUpper && s.label==='Forcing') || ((id==='fcast-tab-precip1hr'||id==='fcast-tab-sim') && s.label==='Rain') || ((id==='fcast-tab-precip6hr'||id==='fcast-tab-precip24hr'||id==='fcast-tab-ptot') && s.label==='Capacity');
            var bg = s.active ? 'rgba(255,68,68,.2)' : 'rgba(255,255,255,.05)';
            var col = s.active ? '#f44' : 'rgba(255,255,255,.3)';
            var bdr = myStage ? 'border:1px solid #f44;box-shadow:0 0 4px rgba(255,68,68,.4);' : 'border:1px solid transparent;';
            xref += '<div style="flex:1;text-align:center;padding:2px;border-radius:3px;background:' + bg + ';color:' + col + ';' + bdr + '">' + s.icon + '<br>' + s.label + '</div>';
          });
          xref += '</div>';

          if (id === 'fcast-tab-precip1hr') xref += '<b>Flash flood timescale.</b> Rate >0.50"/hr overwhelms urban drainage. Compare 1hr totals vs Flash Flood Guidance (FFG).';
          else if (id === 'fcast-tab-precip6hr' || id === 'fcast-tab-precip24hr') xref += '<b>Accumulation timescale.</b> Compare vs FFG and Atlas 14 recurrence intervals. Saturated soils (' + (wx.soilMoisture != null ? 'soil moisture ' + (wx.soilMoisture * 100).toFixed(0) + '%' + (wx.soilMoisture > 0.35 ? '  YES, SATURATED' : '  check antecedent moisture') : (wx.rh > 80 ? 'RH ' + wx.rh + '%  YES' : 'check antecedent moisture')) + ') lower effective thresholds.';
          else if (id === 'fcast-tab-ptot') xref += '<b>Storm total.</b> Track against terrain capacity: urban ~2-3", arid ~1-2", mountains ~4-6". ' + (wx.soilMoisture > 0.35 ? '<span style="color:#f44;">Soil already saturated (' + (wx.soilMoisture * 100).toFixed(0) + '%)  all rain becomes runoff.</span> ' : '') + (wx.pressureTrend <= -2 ? 'Deepening cyclone may increase totals in later runs.' : '');
          else if (isUpper || id === 'fcast-tab-gfs500wind') xref += 'Steering flow determines storm motion. <b>Stalling risk:</b> <20 kt 500mb flow = extended heavy rain over same area = flood catastrophe.';
          else if (isMoisture) xref += 'Saturated soils can\'t absorb more. All additional rain  runoff  flooding. Check precip totals for expected amounts.';
          else if (isPrecip) xref += 'Compare model precip with current rate (' + wx.precip.toFixed(2) + ' in/hr). ' + (wx.precip > 0.5 ? '<span style="color:#f44;">Current rate exceeds flash flood thresholds.</span>' : '');
          xref += '</div>';
        }
      }

      // 
      // CHAIN 4: FIRE WEATHER
      // Drought  Heat  Low RH  Wind  Dry lightning  Fire
      // 
      if ((wx.rh != null && wx.rh < 30 && wx.temp > 75) || (wx.rh < 20) || filterAlerts(['fire','red flag']).length > 0 || (nearbyFireCount > 0 && wx.rh < 40)) {
        var fireStages = [
          { icon: '', label: 'Dry', active: wx.rh != null && wx.rh < 30 },
          { icon: '', label: 'Heat', active: wx.temp > 80 },
          { icon: '', label: 'Wind', active: wx.gust > 20 },
          { icon: '', label: 'Ignition', active: (convectiveEnv && wx.rh < 30) || nearbyFireCount > 0 },
          { icon: '', label: 'Fire', active: filterAlerts(['fire','red flag']).length > 0 || nearbyFireCount > 0 }
        ];
        var fireActive = fireStages.filter(function(s){ return s.active; }).length;

        if (fireActive >= 2) {
          xref += '<div style="margin-bottom:6px;">';
          xref += '<div style="font-weight:600;font-size:.50rem;color:#f44;margin-bottom:3px;"> FIRE WEATHER CHAIN</div>';
          xref += '<div style="display:flex;gap:1px;margin-bottom:2px;font-size:.40rem;">';
          fireStages.forEach(function(s) {
            var myStage = (isMoisture && s.label==='Dry') || ((id==='fcast-tab-temp'||id==='fcast-tab-wndtemp') && s.label==='Heat') || (id==='fcast-tab-wind'||id==='fcast-tab-maxwind') && s.label==='Wind' || (id==='fcast-tab-lightning' && s.label==='Ignition');
            var bg = s.active ? 'rgba(255,68,68,.2)' : 'rgba(255,255,255,.05)';
            var col = s.active ? '#f44' : 'rgba(255,255,255,.3)';
            var bdr = myStage ? 'border:1px solid #f44;box-shadow:0 0 4px rgba(255,68,68,.4);' : 'border:1px solid transparent;';
            xref += '<div style="flex:1;text-align:center;padding:2px;border-radius:3px;background:' + bg + ';color:' + col + ';' + bdr + '">' + s.icon + '<br>' + s.label + '</div>';
          });
          xref += '</div>';

          if (id === 'fcast-tab-lightning') xref += '<span style="color:#f44;"><b>DRY LIGHTNING = #1 wildfire ignition cause.</b> RH ' + (wx.rh || '?') + '%  precipitation evaporates before reaching the ground. Lightning reaches surface but rain doesn\'t. Every bolt is a potential fire start.</span>';
          else if (isMoisture) xref += '<b>Fuel moisture:</b> RH ' + (wx.rh || '?') + '%' + (wx.soilMoisture != null ? ', soil ' + (wx.soilMoisture * 100).toFixed(0) + '%' : '') + '  fine fuels (grass, brush) are critically dry. Fire spread rate increases exponentially below 25% RH. Check wind for spread potential, lightning for ignition risk.';
          else if (id === 'fcast-tab-wind' || id === 'fcast-tab-maxwind') xref += '<b>Spread vector:</b> Wind drives fire direction and speed. Gusts ' + (wx.gust || '?') + ' mph in these conditions = rapid fire expansion. Check humidity for fuel dryness, lightning for ignition.';
          else if (id === 'fcast-tab-temp' || id === 'fcast-tab-wndtemp') xref += 'Heat drives fuel curing and atmospheric instability for dry thunderstorms. Higher temps = lower RH = drier fuels. Check RH product for actual moisture levels.';
          else xref += 'Fire weather conditions present. RH ' + (wx.rh || '?') + '%, gusts ' + (wx.gust || '?') + ' mph. Check lightning for dry thunderstorm risk.';
          //  NEW: Active fire & AQI cross-reference 
          if (nearbyFireCount > 0 || smokeImpact) {
            xref += '<div style="margin-top:3px;color:#f90;">';
            if (nearbyFireCount > 0) xref += ' ' + nearbyFireCount + ' active fire' + (nearbyFireCount > 1 ? 's' : '') + ' detected in region. ';
            if (smokeImpact) xref += 'PM2.5 ' + pm25.toFixed(0) + ' g/m  smoke reducing visibility and air quality.';
            xref += '</div>';
          }
          xref += '</div>';
        }
      }

      // 
      // CHAIN 5: FOG/VISIBILITY EVENT
      // Moisture  Cooling  Light winds  Fog  Low ceilings  Impacts
      // 
      if (fogRisk || (wx.visibility != null && wx.visibility < 3000) || (wx.rh > 95)) {
        xref += '<div style="margin-bottom:6px;">';
        xref += '<div style="font-weight:600;font-size:.50rem;color:#8ba;margin-bottom:3px;"> FOG/VISIBILITY CHAIN</div>';
        var fogType = (wx.wind < 5 && isDark !== false) ? 'Radiation fog' : (wx.wind >= 5 && wx.wind < 15) ? 'Advection fog' : 'Low stratus/fog';
        xref += '<b>' + fogType + ' conditions.</b> ';
        if (id === 'fcast-tab-temp' || id === 'fcast-tab-wndtemp') xref += 'T-Td spread ' + (wx.temp != null && wx.dewpoint != null ? (wx.temp - wx.dewpoint) + 'F' : '?') + '  <b>check visibility/ceiling</b> products for spatial extent and model forecast for fog dissipation timing.';
        else if (isMoisture) xref += 'Surface saturation driving fog formation. Check wind product  calm winds = dense ground fog, 5-15 mph = advection fog, >15 mph = fog lifts to low stratus.';
        else if (id === 'fcast-tab-vis' || id === 'fcast-tab-ceiling') xref += '<b>Upstream:</b> Temperature/dewpoint convergence (T-Td ' + (wx.temp != null && wx.dewpoint != null ? (wx.temp - wx.dewpoint) + 'F' : '?') + ') and calm winds (' + (wx.wind || '?') + ' mph) are the ingredients.' + (wx.sunrise ? ' Sunrise: ' + new Date(wx.sunrise).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) + '  radiation fog typically burns off 2-3 hr after.' : '');
        else if (isPrecip) xref += '<span style="color:#f90;">Fog may produce faint radar returns mimicking light drizzle.</span> Verify with visibility product before interpreting as real precipitation.';
        else xref += 'Monitor T-Td spread and wind for fog evolution.';
        xref += '</div>';
      }

      // 
      // SPACE WEATHER  WEATHER PRODUCTS (always check)
      // 
      if (geoStorm) {
        if (id === 'fcast-tab-lightning' || isPrecip) {
          xref += '<div style="margin-bottom:2px;"><span style="color:#a78bfa;"> <b>Geomagnetic storm</b> (Kp ' + sw.kp + '). Lightning detection networks and satellite data assimilation may have reduced accuracy.</span></div>';
        }
      }
      if (canSeeAurora && geoActive) {
        if (id === 'fcast-tab-vis' || id === 'fcast-tab-ceiling') {
          if (clearSky && isDark) xref += '<div style="margin-bottom:2px;"><span style="color:#4f8;"> <b>Aurora possible!</b> Kp ' + sw.kp + ', clear dark skies  look north!</span></div>';
          else if (overcast) xref += '<div style="margin-bottom:2px;"><span style="color:#f90;"> Aurora possible (Kp ' + sw.kp + ') but overcast skies block the view.</span></div>';
        }
      }
      if (id === 'fcast-tab-10mb' && highSolarWind) {
        xref += '<div style="margin-bottom:2px;"><span style="color:#a78bfa;"> <b>Active solar wind</b> (' + sw.speed + ' km/s). Energetic particle precipitation can affect stratospheric ozone chemistry in extreme events.</span></div>';
      }

      // Render
      if (xref) {
        live += XS;
        live += '<div style="font-weight:600;font-size:.54rem;color:#78a0ff;margin-bottom:2px;"> EVENT CHAINS</div>';
        live += xref;
        live += E;
      }
    }

    if (!live) return content;
    // Prepend the atmospheric situation banner
    live = _preBanner + live;
    var firstBreak = content.indexOf('<br><br>');
    if (firstBreak > 0) {
      return content.substring(0, firstBreak + 8) + live + content.substring(firstBreak + 8);
    }
    return live + content;
  }

  function showRadarTooltip(id, anchor){
    if (!radarInfoData[id] || !radarTooltip) return;
    var content = radarInfoData[id];
    // Inject live model state for model tooltips
    var isModel = id.indexOf('fcast-model-') === 0;
    if (isModel) content = injectLiveModelState(id, content);
    // Inject live product context for product tab tooltips
    var isProduct = id.indexOf('fcast-tab-') === 0;
    if (isProduct) content = injectLiveProductContext(id, content);
    radarTooltip.innerHTML = content;
    radarTooltip.style.display = 'block';
    // Determine if this is a left-panel (model) or right-panel (product) icon
    var isRightPanel = id.indexOf('fcast-tab-') === 0;
    var mapEl = document.getElementById('fcast-img-container');
    var anchorRect = anchor.getBoundingClientRect();
    var ttH = radarTooltip.offsetHeight;
    var winH = window.innerHeight;
    if (mapEl) {
      var mapRect = mapEl.getBoundingClientRect();
      if (isRightPanel) {
        // Position to the left of the right panel, vertically near the anchor
        var rightPanel = document.getElementById('fcast-right-panel');
        var rpLeft = rightPanel ? rightPanel.getBoundingClientRect().left : mapRect.right - 130;
        radarTooltip.style.left = (rpLeft - 348) + 'px';
      } else {
        // Left-panel icons: position to the right of left panel
        var leftPanel = document.getElementById('fcast-left-panel');
        var lpRight = leftPanel ? leftPanel.getBoundingClientRect().right : mapRect.left + 140;
        radarTooltip.style.left = (lpRight + 8) + 'px';
      }
      // Vertical: center on anchor, clamped to viewport
      var idealTop = anchorRect.top + anchorRect.height / 2 - ttH / 2;
      var clampedTop = Math.max(mapRect.top + 4, Math.min(idealTop, winH - ttH - 8));
      radarTooltip.style.top = clampedTop + 'px';
    } else {
      radarTooltip.style.left = (anchorRect.left - 350) + 'px';
      radarTooltip.style.top = Math.max(8, anchorRect.top - ttH / 2) + 'px';
    }
    clearTimeout(radarTooltipTimer);
  }

  // Hide on mouse leave from both icon and tooltip
  if (radarTooltip) {
    radarTooltip.addEventListener('mouseleave', function(){
      radarTooltipTimer = setTimeout(function(){ radarTooltip.style.display = 'none'; }, 200);
    });
    radarTooltip.addEventListener('mouseenter', function(){
      clearTimeout(radarTooltipTimer);
    });
  }
  document.querySelectorAll('.radar-info-icon').forEach(function(icon){
    icon.addEventListener('mouseleave', function(){
      radarTooltipTimer = setTimeout(function(){ if(radarTooltip) radarTooltip.style.display = 'none'; }, 300);
    });
  });
  // Also close on click elsewhere
  document.addEventListener('click', function(e){
    if (!e.target.closest('.radar-info-icon') && !e.target.closest('#radar-info-tooltip')){
      if(radarTooltip) radarTooltip.style.display = 'none';
    }
  });
  window.switchFcastRange = switchFcastRange;
  window.switchFcastModel = switchFcastModel;
  window.switchFcastArea = switchFcastArea;

  /* ---- LIVE RADAR MAP (RainViewer tiles in Leaflet) ---- */


  /* =========================================================
     LOCATION SWITCHER
     ========================================================= */
  function initLocationSwitcher(){
    var locIndex = 0;
    var dotsEl = document.getElementById("loc-dots");
    var prevBtn = document.getElementById("loc-prev");
    var nextBtn = document.getElementById("loc-next");
    
    if (!dotsEl || !prevBtn || !nextBtn) return;
    
    // Find current location index
    for (var i = 0; i < LOCATIONS.length; i++){
      if (LOCATIONS[i].id === LOCATION.id){ locIndex = i; break; }
    }
    
    // Build dots
    function renderDots(){
      dotsEl.innerHTML = "";
      for (var i = 0; i < LOCATIONS.length; i++){
        var dot = document.createElement("div");
        dot.className = "loc-dot" + (i === locIndex ? " active" : "");
        dotsEl.appendChild(dot);
      }
    }
    renderDots();
    
    function cycleTo(newIndex){
      if (window.locationSwitching) return;
      locIndex = (newIndex + LOCATIONS.length) % LOCATIONS.length;
      var newLoc = LOCATIONS[locIndex];
      
      renderDots();
      switchLocation(newLoc.id);
    }
    
    prevBtn.addEventListener("click", function(){ cycleTo(locIndex - 1); });
    nextBtn.addEventListener("click", function(){ cycleTo(locIndex + 1); });

    // Search location button
    var searchToggle = document.getElementById("loc-search-toggle");
    var searchBox = document.getElementById("loc-search-box");
    var searchInput = document.getElementById("loc-search-input");
    var searchClose = document.getElementById("loc-search-close");

    function openSearchBox(){
      if(searchBox) searchBox.classList.add("open");
      if(searchToggle) searchToggle.classList.add("active");
      /* Stop attention pulses  user engaged */
      if(searchToggle) searchToggle.style.animation = "none";
      if(locNameEl) locNameEl.classList.remove("pulse-hint");
      var dots = document.getElementById("loc-dots");
      var prev = document.getElementById("loc-prev");
      var next = document.getElementById("loc-next");
      if(dots) dots.style.opacity = "0";
      if(prev) prev.style.opacity = "0";
      if(next) next.style.opacity = "0";
      if(locNameEl) locNameEl.style.opacity = "0";
      setTimeout(function(){ if(searchInput) searchInput.focus(); }, 220);
    }
    function closeSearchBox(){
      if(searchBox) searchBox.classList.remove("open");
      if(searchToggle) searchToggle.classList.remove("active");
      if(searchInput){ searchInput.value = ""; searchInput.blur(); }
      var dots = document.getElementById("loc-dots");
      var prev = document.getElementById("loc-prev");
      var next = document.getElementById("loc-next");
      if(dots) dots.style.opacity = "1";
      if(prev) prev.style.opacity = "1";
      if(next) next.style.opacity = "1";
      if(locNameEl) locNameEl.style.opacity = "1";
    }

    if(searchToggle){
      searchToggle.addEventListener("click", function(){
        if(searchBox && searchBox.classList.contains("open")) closeSearchBox();
        else openSearchBox();
      });
    }
    if(searchClose){
      searchClose.addEventListener("click", function(){ closeSearchBox(); });
    }
    // Close on click outside
    document.addEventListener("click", function(e){
      if(searchBox && searchBox.classList.contains("open")){
        if(!searchBox.contains(e.target) && e.target !== searchToggle){
          closeSearchBox();
        }
      }
    });
    if (gpsBtn){
      gpsBtn.addEventListener("click", function(){
        if (!navigator.geolocation){
          alert("Geolocation is not supported by your browser.");
          return;
        }
        gpsBtn.classList.add("loading");
        navigator.geolocation.getCurrentPosition(function(pos){
          gpsBtn.classList.remove("loading");
          gpsBtn.classList.add("active");
          var lat = Math.round(pos.coords.latitude * 10000) / 10000;
          var lon = Math.round(pos.coords.longitude * 10000) / 10000;

          // Auto-detect nearest NWS radar
          var RADARS = [
            {id:"KENX",name:"NWS Albany",lat:42.59,lon:-73.99,region:"NORTHEAST"},
            {id:"KOKX",name:"NWS Upton",lat:40.87,lon:-72.86,region:"NORTHEAST"},
            {id:"KBOX",name:"NWS Taunton",lat:41.96,lon:-71.14,region:"NORTHEAST"},
            {id:"KDIX",name:"NWS Mt Holly",lat:39.95,lon:-74.41,region:"NORTHEAST"},
            {id:"KLWX",name:"NWS Sterling",lat:38.98,lon:-77.49,region:"NORTHEAST"},
            {id:"KBUF",name:"NWS Buffalo",lat:42.95,lon:-78.74,region:"NORTHEAST"},
            {id:"KCLX",name:"NWS Charleston",lat:32.66,lon:-81.04,region:"SOUTHEAST"},
            {id:"KFFC",name:"NWS Peachtree",lat:33.36,lon:-84.57,region:"SOUTHEAST"},
            {id:"KTBW",name:"NWS Tampa",lat:27.71,lon:-82.40,region:"SOUTHEAST"},
            {id:"KAMX",name:"NWS Miami",lat:25.61,lon:-80.41,region:"SOUTHEAST"},
            {id:"KJAX",name:"NWS Jacksonville",lat:30.48,lon:-81.70,region:"SOUTHEAST"},
            {id:"KBMX",name:"NWS Birmingham",lat:33.17,lon:-86.77,region:"SOUTHEAST"},
            {id:"KLOT",name:"NWS Chicago",lat:41.60,lon:-88.08,region:"UPPERMISSVLY"},
            {id:"KMKX",name:"NWS Milwaukee",lat:42.97,lon:-88.55,region:"UPPERMISSVLY"},
            {id:"KDTX",name:"NWS Detroit",lat:42.70,lon:-83.47,region:"UPPERMISSVLY"},
            {id:"KMPX",name:"NWS Minneapolis",lat:44.85,lon:-93.57,region:"UPPERMISSVLY"},
            {id:"KILX",name:"NWS Lincoln",lat:40.15,lon:-89.34,region:"UPPERMISSVLY"},
            {id:"KIND",name:"NWS Indianapolis",lat:39.71,lon:-86.28,region:"UPPERMISSVLY"},
            {id:"KLSX",name:"NWS St Louis",lat:38.70,lon:-90.68,region:"CENTGRTLAKES"},
            {id:"KEAX",name:"NWS Kansas City",lat:38.81,lon:-94.26,region:"CENTGRTLAKES"},
            {id:"KFWS",name:"NWS Dallas",lat:32.57,lon:-97.30,region:"SOUTHPLAINS"},
            {id:"KEWX",name:"NWS Austin",lat:29.70,lon:-98.03,region:"SOUTHPLAINS"},
            {id:"KHGX",name:"NWS Houston",lat:29.47,lon:-95.08,region:"SOUTHPLAINS"},
            {id:"KOUN",name:"NWS Norman",lat:35.24,lon:-97.46,region:"SOUTHPLAINS"},
            {id:"KUEX",name:"NWS Hastings",lat:40.32,lon:-98.44,region:"NORTHPLAINS"},
            {id:"KABR",name:"NWS Aberdeen",lat:45.46,lon:-98.41,region:"NORTHPLAINS"},
            {id:"KVTX",name:"NWS Los Angeles",lat:34.41,lon:-119.18,region:"PACSOUTHWEST"},
            {id:"KMUX",name:"NWS San Francisco",lat:37.16,lon:-121.90,region:"PACNORTHWEST"},
            {id:"KATX",name:"NWS Seattle",lat:48.19,lon:-122.50,region:"PACNORTHWEST"},
            {id:"KRTX",name:"NWS Portland",lat:45.72,lon:-122.97,region:"PACNORTHWEST"},
            {id:"KCBX",name:"NWS Boise",lat:43.49,lon:-116.24,region:"PACNORTHWEST"},
            {id:"KPUX",name:"NWS Pueblo",lat:38.46,lon:-104.18,region:"CENTGRTLAKES"},
            {id:"KSLC",name:"NWS Salt Lake",lat:40.97,lon:-111.93,region:"CENTGRTLAKES"},
            {id:"KFGZ",name:"NWS Flagstaff",lat:35.23,lon:-111.20,region:"PACSOUTHWEST"},
            {id:"KIWA",name:"NWS Phoenix",lat:33.29,lon:-111.67,region:"PACSOUTHWEST"},
            {id:"KLRX",name:"NWS Elko",lat:40.74,lon:-116.80,region:"PACNORTHWEST"},
            {id:"KREV",name:"NWS Reno",lat:39.51,lon:-119.46,region:"PACNORTHWEST"}
          ];

          var nearestRadar = RADARS[0];
          var minDist = 999999;
          for (var r = 0; r < RADARS.length; r++){
            var dlat = lat - RADARS[r].lat;
            var dlon = lon - RADARS[r].lon;
            var d = dlat*dlat + dlon*dlon;
            if (d < minDist){ minDist = d; nearestRadar = RADARS[r]; }
          }

          // Auto-detect GOES sector
          var goesSat = lon < -105 ? "G18" : "G19";
          var goesSector;
          if (lon < -105) goesSector = "wus";
          else if (lat > 38) goesSector = "ne";
          else goesSector = "se";

          // Auto-detect timezone
          var guessTz = "America/New_York";
          if (lon < -115) guessTz = "America/Los_Angeles";
          else if (lon < -105) guessTz = "America/Denver";
          else if (lon < -90) guessTz = "America/Chicago";

          // Reverse geocode for location name
          var locName = "My Location";
          fetch("https://api.open-meteo.com/v1/forecast?latitude=" + lat + "&longitude=" + lon + "&current=temperature_2m&timezone=auto")
            .then(function(r){ return r.json(); })
            .then(function(data){
              if (data && data.timezone) guessTz = data.timezone;

              // Build the GPS location object
              var gpsLoc = {
                id: "gps",
                name: locName,
                lat: lat,
                lon: lon,
                tz: guessTz,
                radar: nearestRadar.id,
                radarName: nearestRadar.name,
                radarRegion: nearestRadar.region,
                goes: { sat: goesSat, sector: goesSector }
              };

              // Add or replace GPS entry in LOCATIONS
              var gpsIdx = -1;
              for (var g = 0; g < LOCATIONS.length; g++){
                if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
              }
              if (gpsIdx >= 0){
                LOCATIONS[gpsIdx] = gpsLoc;
              } else {
                LOCATIONS.push(gpsLoc);
                gpsIdx = LOCATIONS.length - 1;
              }

              locIndex = gpsIdx;
              renderDots();
              switchLocation("gps");
            })
            .catch(function(){
              // Fallback without timezone detection
              var gpsLoc = {
                id: "gps",
                name: locName,
                lat: lat,
                lon: lon,
                tz: guessTz,
                radar: nearestRadar.id,
                radarName: nearestRadar.name,
                radarRegion: nearestRadar.region,
                goes: { sat: goesSat, sector: goesSector }
              };
              var gpsIdx = -1;
              for (var g = 0; g < LOCATIONS.length; g++){
                if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
              }
              if (gpsIdx >= 0){
                LOCATIONS[gpsIdx] = gpsLoc;
              } else {
                LOCATIONS.push(gpsLoc);
                gpsIdx = LOCATIONS.length - 1;
              }
              locIndex = gpsIdx;
              renderDots();
              switchLocation("gps");
            });
        }, function(err){
          gpsBtn.classList.remove("loading");
          if (err.code === 1) alert("Location access denied. Please enable location permissions.");
          else alert("Could not get your location. Please try again.");
        }, { enableHighAccuracy: true, timeout: 10000 });
      });
    }
    
    // Search location input
    var searchInput = document.getElementById("loc-search-input");
    if (searchInput){
      searchInput.addEventListener("keydown", function(e){
        if (e.key !== "Enter") return;
        var q = searchInput.value.trim();
        if (!q) return;
        searchInput.disabled = true;
        searchInput.placeholder = "Searching...";
        var url = "https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(q) + "&count=1&language=en&format=json";
        fetch(url).then(function(r){ return r.json(); }).then(function(data){
          searchInput.disabled = false;
          searchInput.placeholder = "City or zip...";
          if (!data.results || !data.results.length){
            alert("Location not found. Try a different search.");
            return;
          }
          var r = data.results[0];
          var lat = Math.round(r.latitude * 10000) / 10000;
          var lon = Math.round(r.longitude * 10000) / 10000;
          var name = r.name || "Custom";
          var RADARS = [
            {id:"KENX",name:"NWS Albany",lat:42.59,lon:-73.99,region:"NORTHEAST"},
            {id:"KOKX",name:"NWS Upton",lat:40.87,lon:-72.86,region:"NORTHEAST"},
            {id:"KBOX",name:"NWS Taunton",lat:41.96,lon:-71.14,region:"NORTHEAST"},
            {id:"KDIX",name:"NWS Mt Holly",lat:39.95,lon:-74.41,region:"NORTHEAST"},
            {id:"KLWX",name:"NWS Sterling",lat:38.98,lon:-77.49,region:"NORTHEAST"},
            {id:"KBUF",name:"NWS Buffalo",lat:42.95,lon:-78.74,region:"NORTHEAST"},
            {id:"KCLX",name:"NWS Charleston",lat:32.66,lon:-81.04,region:"SOUTHEAST"},
            {id:"KFFC",name:"NWS Peachtree",lat:33.36,lon:-84.57,region:"SOUTHEAST"},
            {id:"KTBW",name:"NWS Tampa",lat:27.71,lon:-82.40,region:"SOUTHEAST"},
            {id:"KAMX",name:"NWS Miami",lat:25.61,lon:-80.41,region:"SOUTHEAST"},
            {id:"KJAX",name:"NWS Jacksonville",lat:30.48,lon:-81.70,region:"SOUTHEAST"},
            {id:"KBMX",name:"NWS Birmingham",lat:33.17,lon:-86.77,region:"SOUTHEAST"},
            {id:"KLOT",name:"NWS Chicago",lat:41.60,lon:-88.08,region:"UPPERMISSVLY"},
            {id:"KMKX",name:"NWS Milwaukee",lat:42.97,lon:-88.55,region:"UPPERMISSVLY"},
            {id:"KDTX",name:"NWS Detroit",lat:42.70,lon:-83.47,region:"UPPERMISSVLY"},
            {id:"KMPX",name:"NWS Minneapolis",lat:44.85,lon:-93.57,region:"UPPERMISSVLY"},
            {id:"KILX",name:"NWS Lincoln",lat:40.15,lon:-89.34,region:"UPPERMISSVLY"},
            {id:"KIND",name:"NWS Indianapolis",lat:39.71,lon:-86.28,region:"UPPERMISSVLY"},
            {id:"KLSX",name:"NWS St Louis",lat:38.70,lon:-90.68,region:"CENTGRTLAKES"},
            {id:"KEAX",name:"NWS Kansas City",lat:38.81,lon:-94.26,region:"CENTGRTLAKES"},
            {id:"KFWS",name:"NWS Dallas",lat:32.57,lon:-97.30,region:"SOUTHPLAINS"},
            {id:"KEWX",name:"NWS Austin",lat:29.70,lon:-98.03,region:"SOUTHPLAINS"},
            {id:"KHGX",name:"NWS Houston",lat:29.47,lon:-95.08,region:"SOUTHPLAINS"},
            {id:"KOUN",name:"NWS Norman",lat:35.24,lon:-97.46,region:"SOUTHPLAINS"},
            {id:"KUEX",name:"NWS Hastings",lat:40.32,lon:-98.44,region:"NORTHPLAINS"},
            {id:"KABR",name:"NWS Aberdeen",lat:45.46,lon:-98.41,region:"NORTHPLAINS"},
            {id:"KVTX",name:"NWS Los Angeles",lat:34.41,lon:-119.18,region:"PACSOUTHWEST"},
            {id:"KMUX",name:"NWS San Francisco",lat:37.16,lon:-121.90,region:"PACNORTHWEST"},
            {id:"KATX",name:"NWS Seattle",lat:48.19,lon:-122.50,region:"PACNORTHWEST"},
            {id:"KRTX",name:"NWS Portland",lat:45.72,lon:-122.97,region:"PACNORTHWEST"},
            {id:"KCBX",name:"NWS Boise",lat:43.49,lon:-116.24,region:"PACNORTHWEST"},
            {id:"KPUX",name:"NWS Pueblo",lat:38.46,lon:-104.18,region:"CENTGRTLAKES"},
            {id:"KSLC",name:"NWS Salt Lake",lat:40.97,lon:-111.93,region:"CENTGRTLAKES"},
            {id:"KFGZ",name:"NWS Flagstaff",lat:35.23,lon:-111.20,region:"PACSOUTHWEST"},
            {id:"KIWA",name:"NWS Phoenix",lat:33.29,lon:-111.67,region:"PACSOUTHWEST"},
            {id:"KLRX",name:"NWS Elko",lat:40.74,lon:-116.80,region:"PACNORTHWEST"},
            {id:"KREV",name:"NWS Reno",lat:39.51,lon:-119.46,region:"PACNORTHWEST"}
          ];
          var nearestRadar = RADARS[0];
          var minDist = 999999;
          for (var ri = 0; ri < RADARS.length; ri++){
            var dlat = lat - RADARS[ri].lat;
            var dlon = lon - RADARS[ri].lon;
            var d = dlat*dlat + dlon*dlon;
            if (d < minDist){ minDist = d; nearestRadar = RADARS[ri]; }
          }
          var goesSat = lon < -105 ? "G18" : "G19";
          var goesSector = lon < -105 ? "wus" : (lat > 38 ? "ne" : "se");
          var guessTz = "America/New_York";
          if (lon < -115) guessTz = "America/Los_Angeles";
          else if (lon < -105) guessTz = "America/Denver";
          else if (lon < -90) guessTz = "America/Chicago";
          if (r.timezone) guessTz = r.timezone;

          var searchLoc = {
            id: "search",
            name: name,
            lat: lat,
            lon: lon,
            tz: guessTz,
            radar: nearestRadar.id,
            radarName: nearestRadar.name,
            radarRegion: nearestRadar.region,
            goes: { sat: goesSat, sector: goesSector }
          };
          var sIdx = -1;
          for (var g = 0; g < LOCATIONS.length; g++){
            if (LOCATIONS[g].id === "search"){ sIdx = g; break; }
          }
          if (sIdx >= 0) LOCATIONS[sIdx] = searchLoc;
          else { LOCATIONS.push(searchLoc); sIdx = LOCATIONS.length - 1; }

          locIndex = sIdx;
          renderDots();
          switchLocation("search");
          searchInput.value = "";
          closeSearchBox();
        }).catch(function(){
          searchInput.disabled = false;
          searchInput.placeholder = "City or zip...";
          alert("Search failed. Please try again.");
        });
      });
    }

    // GPS "Use My Location" button
    var gpsBtn = document.getElementById("loc-gps");
    if (gpsBtn){
      gpsBtn.addEventListener("click", function(){
        if (!navigator.geolocation){
          alert("Geolocation is not supported by your browser.");
          return;
        }
        gpsBtn.classList.add("loading");
        navigator.geolocation.getCurrentPosition(function(pos){
          gpsBtn.classList.remove("loading");
          gpsBtn.classList.add("active");
          var lat = Math.round(pos.coords.latitude * 10000) / 10000;
          var lon = Math.round(pos.coords.longitude * 10000) / 10000;
          resolveAndSwitch(lat, lon, "My Location");
        }, function(err){
          gpsBtn.classList.remove("loading");
          if (err.code === 1) alert("Location access denied. Please enable location permissions.");
          else alert("Could not get your location. Please try again.");
        }, { enableHighAccuracy: true, timeout: 10000 });
      });
    }

    // ======= LOCATION AUTOCOMPLETE =======
    var suggestionsEl = document.getElementById("loc-suggestions");
    var suggestDebounce = null;
    var suggestResults = [];
    var suggestIndex = -1;

    function showSuggestions(results){
      if (!suggestionsEl || !results || results.length === 0){ hideSuggestions(); return; }
      suggestResults = results.slice(0, 5);
      suggestIndex = -1;
      var html = '';
      suggestResults.forEach(function(r, i){
        var region = r.admin1 || '';
        var country = r.country_code || r.country || '';
        var sub = [region, country].filter(Boolean).join(', ');
        var fc = r.feature_code || '';
        var icon = '';
        if (fc.indexOf('PPL') === 0) icon = '';
        else if (fc.indexOf('PRK') >= 0 || fc === 'RESF' || fc === 'RESN') icon = '';
        else if (fc.indexOf('MT') >= 0 || fc === 'PK') icon = '';
        else if (fc.indexOf('LK') >= 0 || fc === 'RSV' || fc === 'STM') icon = '';
        else if (fc === 'AIRP' || fc === 'AIRF') icon = '';
        else if (fc.indexOf('SCH') >= 0 || fc === 'UNIV') icon = '';
        var isLast = i === suggestResults.length - 1;
        html += '<div class="loc-suggest-item" data-idx="' + i + '" style="padding:9px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;' + (isLast ? '' : 'border-bottom:1px solid rgba(255,255,255,.1);') + 'transition:background .15s ease;">';
        html += '<span style="font-size:.7rem;opacity:.7;flex-shrink:0;width:18px;text-align:center;">' + icon + '</span>';
        html += '<div style="min-width:0;flex:1;">';
        html += '<div style="font-size:.6rem;font-weight:700;color:rgba(255,255,255,.9);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.01em;">' + r.name + '</div>';
        if (sub) html += '<div style="font-size:.45rem;color:rgba(255,255,255,.45);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;letter-spacing:.02em;">' + sub + '</div>';
        html += '</div></div>';
      });
      suggestionsEl.innerHTML = html;
      suggestionsEl.style.display = 'block';
      suggestionsEl.querySelectorAll('.loc-suggest-item').forEach(function(el){
        el.addEventListener('mousedown', function(e){
          e.preventDefault();
          var idx = parseInt(this.getAttribute('data-idx'));
          if (suggestResults[idx]) pickSuggestion(suggestResults[idx]);
        });
        el.addEventListener('mouseenter', function(){ this.style.background = 'rgba(255,255,255,.15)'; });
        el.addEventListener('mouseleave', function(){ this.style.background = 'transparent'; });
      });
    }

    function hideSuggestions(){
      if (suggestionsEl){ suggestionsEl.style.display = 'none'; suggestionsEl.innerHTML = ''; }
      suggestResults = [];
      suggestIndex = -1;
    }

    function highlightSuggestion(idx){
      if (!suggestionsEl) return;
      suggestionsEl.querySelectorAll('.loc-suggest-item').forEach(function(el, i){
        el.style.background = i === idx ? 'rgba(255,255,255,.15)' : 'transparent';
      });
    }

    function pickSuggestion(r){
      hideSuggestions();
      searchInput.value = '';
      closeSearchBox();
      var tz = r.timezone || null;
      resolveAndSwitch(Math.round(r.latitude*10000)/10000, Math.round(r.longitude*10000)/10000, r.name || 'Custom', tz);
    }

    var searchInput = document.getElementById("loc-search-input");
    if (searchInput){
      searchInput.setAttribute('placeholder', 'City, zip, park, place...');
      searchInput.setAttribute('autocomplete', 'off');

      // Common city abbreviations/nicknames  full searchable names
      var cityAliases = {
        'la':'Los Angeles','nyc':'New York City','sf':'San Francisco','dc':'Washington DC',
        'nola':'New Orleans','philly':'Philadelphia','vegas':'Las Vegas','lv':'Las Vegas',
        'chi':'Chicago','atl':'Atlanta','bos':'Boston','dal':'Dallas','hou':'Houston',
        'sa':'San Antonio','sd':'San Diego','sj':'San Jose','sjc':'San Jose',
        'stl':'St Louis','kc':'Kansas City','nj':'Newark','det':'Detroit',
        'msp':'Minneapolis','mke':'Milwaukee','cle':'Cleveland','pit':'Pittsburgh',
        'pdx':'Portland','sea':'Seattle','den':'Denver','slc':'Salt Lake City',
        'phx':'Phoenix','abq':'Albuquerque','okc':'Oklahoma City','jax':'Jacksonville',
        'clt':'Charlotte','rdu':'Raleigh','ric':'Richmond','bwi':'Baltimore',
        'mia':'Miami','ftl':'Fort Lauderdale','tpa':'Tampa','orl':'Orlando',
        'msy':'New Orleans','mem':'Memphis','bna':'Nashville','sfo':'San Francisco',
        'lax':'Los Angeles','jfk':'New York City','ord':'Chicago','dfw':'Dallas',
        'iah':'Houston','phl':'Philadelphia','bklyn':'Brooklyn','queens':'Queens NY',
        'soho':'Manhattan New York','dtla':'Downtown Los Angeles',
        'the bay':'San Francisco Bay Area','twin cities':'Minneapolis Saint Paul',
        'Silicon Valley':'San Jose California','hamptons':'East Hampton New York',
        'cape cod':'Cape Cod Massachusetts','big island':'Hilo Hawaii',
        'dmv':'Washington DC','tristate':'New York City','socal':'Los Angeles',
        'norcal':'San Francisco','chiraq':'Chicago','hotlanta':'Atlanta',
        'bean town':'Boston','motor city':'Detroit','the big easy':'New Orleans',
        'mile high':'Denver','emerald city':'Seattle','windy city':'Chicago',
        'city of angels':'Los Angeles','big apple':'New York City',
        'charm city':'Baltimore','steel city':'Pittsburgh','space city':'Houston',
        'sin city':'Las Vegas','alamo city':'San Antonio','river city':'Sacramento',
        'indy':'Indianapolis','cincy':'Cincinnati','cbus':'Columbus Ohio',
        'reno':'Reno Nevada','tuscon':'Tucson','ftw':'Fort Worth','mcallen':'McAllen Texas',
        'anchorage':'Anchorage Alaska','honolulu':'Honolulu Hawaii',
        'london':'London England','paris':'Paris France','tokyo':'Tokyo Japan',
        'toronto':'Toronto Canada','montreal':'Montreal Canada','vancouver':'Vancouver Canada',
        'cdmx':'Mexico City','mexico city':'Ciudad de Mexico','sydney':'Sydney Australia',
        'melb':'Melbourne Australia','berlin':'Berlin Germany','madrid':'Madrid Spain',
        'rome':'Rome Italy','amsterdam':'Amsterdam Netherlands','dubai':'Dubai UAE',
        'hk':'Hong Kong','sg':'Singapore','bkk':'Bangkok Thailand'
      };
      
      function expandCityAlias(q){
        var lower = q.toLowerCase().trim();
        return cityAliases[lower] || q;
      }

      // Autocomplete on typing
      searchInput.addEventListener('input', function(){
        var q = expandCityAlias(searchInput.value.trim());
        clearTimeout(suggestDebounce);
        if (q.length < 2){ hideSuggestions(); return; }
        suggestDebounce = setTimeout(function(){
          fetch('https://geocoding-api.open-meteo.com/v1/search?name=' + encodeURIComponent(q) + '&count=4&language=en&format=json')
            .then(function(r){ return r.json(); })
            .then(function(data){
              if (data.results && data.results.length > 0) showSuggestions(data.results);
              else hideSuggestions();
            }).catch(function(){ hideSuggestions(); });
        }, 250);
      });

      // Keyboard nav + Enter
      searchInput.addEventListener("keydown", function(e){
        if (e.key === 'ArrowDown'){
          e.preventDefault();
          if (suggestResults.length > 0){
            suggestIndex = Math.min(suggestIndex + 1, suggestResults.length - 1);
            highlightSuggestion(suggestIndex);
          }
        } else if (e.key === 'ArrowUp'){
          e.preventDefault();
          if (suggestResults.length > 0){
            suggestIndex = Math.max(suggestIndex - 1, 0);
            highlightSuggestion(suggestIndex);
          }
        } else if (e.key === 'Escape'){
          hideSuggestions();
        } else if (e.key === 'Enter'){
          e.preventDefault();
          if (suggestIndex >= 0 && suggestResults[suggestIndex]){
            pickSuggestion(suggestResults[suggestIndex]);
          } else if (suggestResults.length > 0){
            pickSuggestion(suggestResults[0]);
          } else {
            var q = expandCityAlias(searchInput.value.trim());
            if (!q) return;
            searchInput.disabled = true;
            searchInput.placeholder = "Searching...";
            fetch("https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(q) + "&count=1&language=en&format=json")
              .then(function(r){ return r.json(); })
              .then(function(data){
                searchInput.disabled = false;
                searchInput.placeholder = "City, zip, park, place...";
                if (data.results && data.results.length > 0){
                  var r = data.results[0];
                  resolveAndSwitch(Math.round(r.latitude*10000)/10000, Math.round(r.longitude*10000)/10000, r.name || "Custom", r.timezone || null);
                  searchInput.value = "";
                } else {
                  alert("Location not found.");
                }
              }).catch(function(){
                searchInput.disabled = false;
                searchInput.placeholder = "City, zip, park, place...";
              });
          }
        }
      });

      // Hide suggestions on blur
      searchInput.addEventListener('blur', function(){
        setTimeout(hideSuggestions, 200);
      });
    }

    // Shared: resolve radar/GOES/tz and switch
    function resolveAndSwitch(lat, lon, name, tzOverride){
      var RADARS = [
        {id:"KENX",name:"NWS Albany",lat:42.59,lon:-73.99,region:"NORTHEAST"},
        {id:"KOKX",name:"NWS Upton",lat:40.87,lon:-72.86,region:"NORTHEAST"},
        {id:"KBOX",name:"NWS Taunton",lat:41.96,lon:-71.14,region:"NORTHEAST"},
        {id:"KDIX",name:"NWS Mt Holly",lat:39.95,lon:-74.41,region:"NORTHEAST"},
        {id:"KLWX",name:"NWS Sterling",lat:38.98,lon:-77.49,region:"NORTHEAST"},
        {id:"KBUF",name:"NWS Buffalo",lat:42.95,lon:-78.74,region:"NORTHEAST"},
        {id:"KCLX",name:"NWS Charleston",lat:32.66,lon:-81.04,region:"SOUTHEAST"},
        {id:"KFFC",name:"NWS Peachtree",lat:33.36,lon:-84.57,region:"SOUTHEAST"},
        {id:"KTBW",name:"NWS Tampa",lat:27.71,lon:-82.40,region:"SOUTHEAST"},
        {id:"KAMX",name:"NWS Miami",lat:25.61,lon:-80.41,region:"SOUTHEAST"},
        {id:"KJAX",name:"NWS Jacksonville",lat:30.48,lon:-81.70,region:"SOUTHEAST"},
        {id:"KBMX",name:"NWS Birmingham",lat:33.17,lon:-86.77,region:"SOUTHEAST"},
        {id:"KLOT",name:"NWS Chicago",lat:41.60,lon:-88.08,region:"UPPERMISSVLY"},
        {id:"KMKX",name:"NWS Milwaukee",lat:42.97,lon:-88.55,region:"UPPERMISSVLY"},
        {id:"KDTX",name:"NWS Detroit",lat:42.70,lon:-83.47,region:"UPPERMISSVLY"},
        {id:"KMPX",name:"NWS Minneapolis",lat:44.85,lon:-93.57,region:"UPPERMISSVLY"},
        {id:"KILX",name:"NWS Lincoln",lat:40.15,lon:-89.34,region:"UPPERMISSVLY"},
        {id:"KIND",name:"NWS Indianapolis",lat:39.71,lon:-86.28,region:"UPPERMISSVLY"},
        {id:"KLSX",name:"NWS St Louis",lat:38.70,lon:-90.68,region:"CENTGRTLAKES"},
        {id:"KEAX",name:"NWS Kansas City",lat:38.81,lon:-94.26,region:"CENTGRTLAKES"},
        {id:"KFWS",name:"NWS Dallas",lat:32.57,lon:-97.30,region:"SOUTHPLAINS"},
        {id:"KEWX",name:"NWS Austin",lat:29.70,lon:-98.03,region:"SOUTHPLAINS"},
        {id:"KHGX",name:"NWS Houston",lat:29.47,lon:-95.08,region:"SOUTHPLAINS"},
        {id:"KOUN",name:"NWS Norman",lat:35.24,lon:-97.46,region:"SOUTHPLAINS"},
        {id:"KUEX",name:"NWS Hastings",lat:40.32,lon:-98.44,region:"NORTHPLAINS"},
        {id:"KABR",name:"NWS Aberdeen",lat:45.46,lon:-98.41,region:"NORTHPLAINS"},
        {id:"KVTX",name:"NWS Los Angeles",lat:34.41,lon:-119.18,region:"PACSOUTHWEST"},
        {id:"KMUX",name:"NWS San Francisco",lat:37.16,lon:-121.90,region:"PACNORTHWEST"},
        {id:"KATX",name:"NWS Seattle",lat:48.19,lon:-122.50,region:"PACNORTHWEST"},
        {id:"KRTX",name:"NWS Portland",lat:45.72,lon:-122.97,region:"PACNORTHWEST"},
        {id:"KCBX",name:"NWS Boise",lat:43.49,lon:-116.24,region:"PACNORTHWEST"},
        {id:"KPUX",name:"NWS Pueblo",lat:38.46,lon:-104.18,region:"CENTGRTLAKES"},
        {id:"KSLC",name:"NWS Salt Lake",lat:40.97,lon:-111.93,region:"CENTGRTLAKES"},
        {id:"KFGZ",name:"NWS Flagstaff",lat:35.23,lon:-111.20,region:"PACSOUTHWEST"},
        {id:"KIWA",name:"NWS Phoenix",lat:33.29,lon:-111.67,region:"PACSOUTHWEST"},
        {id:"KLRX",name:"NWS Elko",lat:40.74,lon:-116.80,region:"PACNORTHWEST"},
        {id:"KREV",name:"NWS Reno",lat:39.51,lon:-119.46,region:"PACNORTHWEST"}
      ];
      var nearestRadar = RADARS[0];
      var minDist = 999999;
      for (var ri = 0; ri < RADARS.length; ri++){
        var dlat = lat - RADARS[ri].lat;
        var dlon = lon - RADARS[ri].lon;
        var d = dlat*dlat + dlon*dlon;
        if (d < minDist){ minDist = d; nearestRadar = RADARS[ri]; }
      }
      var goesSat = lon < -105 ? "G18" : "G19";
      var goesSector = lon < -105 ? "wus" : (lat > 38 ? "ne" : "se");
      var guessTz = tzOverride || "America/New_York";
      if (!tzOverride){
        if (lon < -115) guessTz = "America/Los_Angeles";
        else if (lon < -105) guessTz = "America/Denver";
        else if (lon < -90) guessTz = "America/Chicago";
      }
      var newLoc = {
        id: "custom",
        name: name,
        lat: lat,
        lon: lon,
        tz: guessTz,
        radar: nearestRadar.id,
        radarName: nearestRadar.name,
        radarRegion: nearestRadar.region,
        goes: { sat: goesSat, sector: goesSector }
      };
      var cIdx = -1;
      for (var g = 0; g < LOCATIONS.length; g++){
        if (LOCATIONS[g].id === "custom"){ cIdx = g; break; }
      }
      if (cIdx >= 0) LOCATIONS[cIdx] = newLoc;
      else { LOCATIONS.push(newLoc); cIdx = LOCATIONS.length - 1; }
      locIndex = cIdx;
      renderDots();
      switchLocation("custom");
    }

    // Swipe support
    var startX = null;
    var cyclerEl = document.getElementById("loc-cycler");
    if (cyclerEl){
      cyclerEl.addEventListener("touchstart", function(e){ startX = e.touches[0].clientX; }, {passive:true});
      cyclerEl.addEventListener("touchend", function(e){
        if (startX === null) return;
        var diff = e.changedTouches[0].clientX - startX;
        if (Math.abs(diff) > 40){
          cycleTo(locIndex + (diff < 0 ? 1 : -1));
        }
        startX = null;
      }, {passive:true});
    }
    
    function switchLocation(id){
      var newLoc = null;
      for (var i = 0; i < LOCATIONS.length; i++){
        if (LOCATIONS[i].id === id){
          newLoc = LOCATIONS[i];
          break;
        }
      }
      if (!newLoc) return;
      
      // Clear existing timers
      if (radarRefreshTimer) { clearInterval(radarRefreshTimer); radarRefreshTimer = null; }
      if (goesTimer) { clearInterval(goesTimer); goesTimer = null; }
      if (goesRefreshTimer) { clearInterval(goesRefreshTimer); goesRefreshTimer = null; }
      
      // Prevent rapid switching
      if (window.locationSwitching) return;
      window.locationSwitching = true;
      setTimeout(function(){ window.locationSwitching = false; }, 1000);
      
      LOCATION = newLoc;
      TZ = newLoc.tz;
      
      // Update location name display with loading state
      if (locNameEl) { locNameEl.textContent = newLoc.name; locNameEl.classList.remove("pulse-hint"); }
      if (locMetaEl) locMetaEl.textContent = "Loading...";
      if (tempEl) tempEl.style.opacity = "0.5";
      
      // Reload all data
      loadWeatherForLocation(LOCATION);
      loadAirQuality();
      loadWeatherAlerts();
      switchRadarMode("reflectivity");
      startRadarNwsLoop();
      startGoesAutoplay();
      updateSolarMini();
      buildSpaceInfoPanel();
      if (fireMap) {
        var fc = [45, -100], fz = 3;
        if (LOCATION.lon > -85 && LOCATION.lat > 38) { fc = [44, -74]; fz = 5; }
        else if (LOCATION.lon > -90 && LOCATION.lat <= 38 && LOCATION.lat > 25) { fc = [32, -82]; fz = 5; }
        else if (LOCATION.lon > -100 && LOCATION.lon <= -85 && LOCATION.lat > 36) { fc = [42, -90]; fz = 5; }
        else if (LOCATION.lon <= -110 && LOCATION.lat <= 42 && LOCATION.lat > 30) { fc = [36, -118]; fz = 5; }
        else if (LOCATION.lon <= -115 && LOCATION.lat > 42) { fc = [46, -122]; fz = 5; }
        else if (LOCATION.lon > -105 && LOCATION.lon <= -90 && LOCATION.lat <= 36) { fc = [31, -98]; fz = 5; }
        else if (LOCATION.lon <= -100 && LOCATION.lon > -115 && LOCATION.lat > 36) { fc = [42, -110]; fz = 5; }
        fireMap.setView(fc, fz);
      }
      if (quakeMap) quakeMap.setView([LOCATION.lat, LOCATION.lon], 6);
      if (lightningMap) lightningMap.setView([LOCATION.lat, LOCATION.lon], 3);
      
      // Update lightning iframe location
      var lIframe = document.getElementById('lightning-iframe');
      if (lIframe) {
        lIframe.src = 'https://map.blitzortung.org/index.php?interactive=1&NavigationControl=0&FullScreenControl=0&Ede=0&Menu=0&InfoStrike=0&InfoMuted=1&Cookies=0&CookieConsent=1#7/' + LOCATION.lat.toFixed(4) + '/' + LOCATION.lon.toFixed(4);
      }
      
      // Update location markers on maps
      if (hazardMap) {
        hazardMap.eachLayer(function(layer){ if (layer.options && layer.options.fillColor === '#2B22F4') hazardMap.removeLayer(layer); });
        // User location marker removed for cleaner map
      }
    }
  }

  /* =========================================================
     SUVI THEMATIC MAP (Animated)
     ========================================================= */
  var suviMapAnim = {
    frames: [],
    idx: 0,
    playing: true,
    timer: null,
    refreshTimer: null
  };
  
  function initPfss(){
    var img = document.getElementById("pfss-img");
    var live = document.getElementById("pfss-live");
    if (!img) return;
    
// Try AIA 171 first, fallback to SOHO, then PFSS
    var aiaUrl = "https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_0171.jpg";
    var sohoUrl = "https://soho.nascom.nasa.gov/data/realtime/eit_171/512/latest.jpg";
    var pfssUrl = "https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_PFSS_0171.jpg";
    var fallbackLevel = 1; // Start with AIA since PFSS is unreliable
    
    function loadImage(){
      var url = aiaUrl;
      if (fallbackLevel === 1) url = sohoUrl;
      if (fallbackLevel === 2) url = pfssUrl;
      
      img.src = url + "?cb=" + Date.now();
      if(live) live.textContent = " LIVE";
    }
    
    img.onerror = function(){
      fallbackLevel++;
      if (fallbackLevel <= 2) {
        loadImage();
      } else {
        if(live) live.textContent = " OFFLINE";
        img.style.opacity = "0.3";
      }
    };
    
    img.onload = function(){
      img.style.opacity = "1";
    };
    
    loadImage();
    setInterval(function(){
      fallbackLevel = 0; // Reset to try PFSS again each refresh
      loadImage();
    }, 300000);
  }

  function initSuviMap(){
    var suviMapImg = document.getElementById("suvi-map-img");
    var suviMapLive = document.getElementById("suvi-map-live");
    var suviMapBtn = document.getElementById("suvi-map-btn");
    
    if (!suviMapImg) return;
    
    var JSON_URL = "https://services.swpc.noaa.gov/products/animations/suvi-primary-map.json";
    var FALLBACK_URL = "https://services.swpc.noaa.gov/images/animations/suvi/primary/map/latest.png";
    
    function loadFrames(){
      if (suviMapLive) suviMapLive.textContent = " LOADING";
      
      fetchWithTimeout(JSON_URL, null, 15000)
        .then(function(r){ return r.json(); })
        .then(function(data){
          if (data && data.length > 0){
            suviMapAnim.frames = data.map(function(f){
              return "https://services.swpc.noaa.gov" + f.url;
            });
            suviMapAnim.idx = 0;
            if (suviMapLive) suviMapLive.textContent = " LIVE";
            if (suviMapBtn) suviMapBtn.style.display = "block";
            startSuviAnimation();
          } else {
            throw new Error("No frames");
          }
        })
        .catch(function(){
          // Fallback to static image
          suviMapImg.src = FALLBACK_URL + "?cb=" + Date.now();
          suviMapImg.onload = function(){ if (suviMapLive) suviMapLive.textContent = " LIVE"; };
          suviMapImg.onerror = function(){ if (suviMapLive) suviMapLive.textContent = " OFFLINE"; };
          if (suviMapBtn) suviMapBtn.style.display = "none";
        });
    }
    
    function startSuviAnimation(){
      if (suviMapAnim.timer) clearTimeout(suviMapAnim.timer);
      
      function step(){
        if (suviMapAnim.playing && suviMapAnim.frames.length > 0){
          suviMapImg.src = suviMapAnim.frames[suviMapAnim.idx];
          suviMapAnim.idx = (suviMapAnim.idx + 1) % suviMapAnim.frames.length;
        }
        suviMapAnim.timer = setTimeout(step, 150);
      }
      step();
    }
    
    
    loadFrames();
    
    if (suviMapAnim.refreshTimer) clearInterval(suviMapAnim.refreshTimer);
    suviMapAnim.refreshTimer = setInterval(loadFrames, 5 * 60 * 1000);
  }

  /* =========================================================
   MAIN WEATHER MICRO TABS (RESET TO SUMMARY ON REFRESH)
   ========================================================= */
function initNowMicroTabs(){
  var tabButtons = document.querySelectorAll(".now-tab[data-nowtab]");
  var panels = document.querySelectorAll(".now-tabpanel[data-nowtab-panel]");
  if (!tabButtons.length || !panels.length) return;

  function setActive(name){
    for (var i=0; i<tabButtons.length; i++){
      var b = tabButtons[i];
      var isOn = (b.getAttribute("data-nowtab") === name);
      if (isOn) b.classList.add("is-active");
      else b.classList.remove("is-active");
    }

    for (var p=0; p<panels.length; p++){
      var panel = panels[p];
      var isPanel = (panel.getAttribute("data-nowtab-panel") === name);
      panel.hidden = !isPanel;
    }
  }

  for (var j=0; j<tabButtons.length; j++){
    tabButtons[j].addEventListener("click", function(e){
      var name = this.getAttribute("data-nowtab");
      setActive(name);
    });
  }

  // Critical behavior: ALWAYS reset to Summary on refresh / load
  setActive("summary");
}



  /* =========================================================
     HAZARD MAPS (Lightning, Wildfires, Earthquakes) - Leaflet
     ========================================================= */
  var lightningMap = null;
  var fireMap = null;
  var quakeMap = null;
  var hazardMap = null;
  var hazardActiveTab = 'fire';

  /* Unified hazard map tab switching */
  function switchHazardTab(tab){
    hazardActiveTab = tab;
    var allTabs = document.querySelectorAll('#hazard-tabs .geo-tab');
    for(var i=0;i<allTabs.length;i++){
      if(allTabs[i].getAttribute('data-hazard')===tab) allTabs[i].classList.add('active');
      else allTabs[i].classList.remove('active');
    }
    // Show/hide overlay controls
    var fo = document.getElementById('hazard-fire-overlays');
    var to = document.getElementById('hazard-tornado-overlays');
    var qo = document.getElementById('hazard-quake-overlays');
    var ao = document.getElementById('hazard-alerts-overlays');
    var flo = document.getElementById('hazard-flood-overlays');
    if(fo) fo.style.display = tab==='fire' ? '' : 'none';
    if(to) to.style.display = tab==='tornado' ? '' : 'none';
    if(qo) qo.style.display = tab==='quake' ? '' : 'none';
    if(ao) ao.style.display = tab==='alerts' ? '' : 'none';
    if(flo) flo.style.display = tab==='flood' ? '' : 'none';

    if(!hazardMap) return;

    // Fire layer group
    if(window._fireLayerGroup){
      if(tab==='fire' && !hazardMap.hasLayer(window._fireLayerGroup)) window._fireLayerGroup.addTo(hazardMap);
      if(tab!=='fire' && hazardMap.hasLayer(window._fireLayerGroup)) hazardMap.removeLayer(window._fireLayerGroup);
    }
    // Smoke WMS layers
    if(typeof smokeLayers !== 'undefined'){
      ['sfc','col','pm25','dust','can'].forEach(function(k){
        if(smokeLayers[k] && smokeLayers[k].layer && smokeLayers[k].active){
          if(tab==='fire' && !hazardMap.hasLayer(smokeLayers[k].layer)) smokeLayers[k].layer.addTo(hazardMap);
          if(tab!=='fire' && hazardMap.hasLayer(smokeLayers[k].layer)) hazardMap.removeLayer(smokeLayers[k].layer);
        }
      });
      if(typeof smokeGeoJsonLayer !== 'undefined' && smokeGeoJsonLayer && smokeLayers.hms && smokeLayers.hms.active){
        if(tab==='fire' && !hazardMap.hasLayer(smokeGeoJsonLayer)) smokeGeoJsonLayer.addTo(hazardMap);
        if(tab!=='fire' && hazardMap.hasLayer(smokeGeoJsonLayer)) hazardMap.removeLayer(smokeGeoJsonLayer);
      }
    }

    // Tornado markers and outlook layers  these are added directly to the map
    if(typeof tornadoMarkers !== 'undefined'){
      tornadoMarkers.forEach(function(m){
        try {
          if(tab==='tornado'){ if(m._icon) m._icon.style.display=''; if(m._path) m._path.style.display=''; if(m.setStyle) m.setStyle({opacity:1,fillOpacity:0.85}); }
          else { if(m._icon) m._icon.style.display='none'; if(m._path) m._path.style.display='none'; if(m.setStyle) m.setStyle({opacity:0,fillOpacity:0}); }
        } catch(e){}
      });
    }
    if(typeof tornadoSevereMarkers !== 'undefined'){
      tornadoSevereMarkers.forEach(function(m){
        try {
          if(tab==='tornado'){ if(m._path) m._path.style.display=''; if(m.setStyle) m.setStyle({opacity:1,fillOpacity:0.85}); }
          else { if(m._path) m._path.style.display='none'; if(m.setStyle) m.setStyle({opacity:0,fillOpacity:0}); }
        } catch(e){}
      });
    }
    // Tornado outlook group  add/remove entire group
    if(window._tornadoOutlookGroup){
      if(tab==='tornado' && !hazardMap.hasLayer(window._tornadoOutlookGroup)) window._tornadoOutlookGroup.addTo(hazardMap);
      if(tab!=='tornado' && hazardMap.hasLayer(window._tornadoOutlookGroup)) hazardMap.removeLayer(window._tornadoOutlookGroup);
    }
    if(tornadoLayerGroup){
      if(tab==='tornado' && !hazardMap.hasLayer(tornadoLayerGroup)) tornadoLayerGroup.addTo(hazardMap);
      if(tab!=='tornado' && hazardMap.hasLayer(tornadoLayerGroup)) hazardMap.removeLayer(tornadoLayerGroup);
    }

    // Quake layer group
    if(window._quakeLayerGroup){
      if(tab==='quake' && !hazardMap.hasLayer(window._quakeLayerGroup)) window._quakeLayerGroup.addTo(hazardMap);
      if(tab!=='quake' && hazardMap.hasLayer(window._quakeLayerGroup)) hazardMap.removeLayer(window._quakeLayerGroup);
    }

    // Macrostrat geology
    if(window.quakeGeoTileLayer){
      if(tab==='quake' && window._quakeGeoVisible && !hazardMap.hasLayer(window.quakeGeoTileLayer)) window.quakeGeoTileLayer.addTo(hazardMap);
      if(tab!=='quake' && hazardMap.hasLayer(window.quakeGeoTileLayer)) hazardMap.removeLayer(window.quakeGeoTileLayer);
    }

    // Alert layer group
    if(window._alertLayerGroup){
      if(tab==='alerts' && !hazardMap.hasLayer(window._alertLayerGroup)) window._alertLayerGroup.addTo(hazardMap);
      if(tab!=='alerts' && hazardMap.hasLayer(window._alertLayerGroup)) hazardMap.removeLayer(window._alertLayerGroup);
    }

    // Flood layer group
    if(window._floodLayerGroup){
      if(tab==='flood' && !hazardMap.hasLayer(window._floodLayerGroup)) window._floodLayerGroup.addTo(hazardMap);
      if(tab!=='flood' && hazardMap.hasLayer(window._floodLayerGroup)) hazardMap.removeLayer(window._floodLayerGroup);
    }
    // Sig river flood outlook polygons
    if(window._sigFloodOutlookLayer){
      if(tab==='flood' && !hazardMap.hasLayer(window._sigFloodOutlookLayer)) window._sigFloodOutlookLayer.addTo(hazardMap);
      if(tab!=='flood' && hazardMap.hasLayer(window._sigFloodOutlookLayer)) hazardMap.removeLayer(window._sigFloodOutlookLayer);
    }

    // Outlook overlay layers  show only for active tab
    ['fire','tornado','flood'].forEach(function(hazType){
      if(outlookLayers[hazType]){
        if(tab === hazType && !hazardMap.hasLayer(outlookLayers[hazType])) outlookLayers[hazType].addTo(hazardMap);
        if(tab !== hazType && hazardMap.hasLayer(outlookLayers[hazType])) hazardMap.removeLayer(outlookLayers[hazType]);
      }
    });

    // Update title
    var titleEl = document.getElementById('hazard-title');
    if(titleEl){
      var titles = {fire:'WILDFIRES',quake:'EARTHQUAKES',tornado:'TORNADOES',flood:'FLOOD GAUGES',alerts:'ALERTS HUB'};
      titleEl.innerHTML = titles[tab] + ' <span class="live-tag"> LIVE</span>';
    }

    // Update accent line color
    var accent = document.getElementById('hazard-accent');
    if(accent){
      var gradients = {
        fire: 'linear-gradient(90deg,#f97316,#fb923c)',
        tornado: 'linear-gradient(90deg,#ef4444,#f87171)',
        quake: 'linear-gradient(90deg,#3b82f6,#60a5fa)',
        alerts: 'linear-gradient(90deg,#ef4444,#f87171)',
        flood: 'linear-gradient(90deg,#06b6d4,#22d3ee)'
      };
      accent.style.background = gradients[tab] || gradients.fire;
    }

    // Fly-to relevant region on tab switch
    if(hazardMap && !window._hazardTabInitializing){
      var flyTargets = {
        fire: { center: [38, -96], zoom: 4 },
        tornado: { center: [38, -96], zoom: 4 },
        quake: { center: [38, -96], zoom: 4 },
        alerts: { center: [LOCATION.lat, LOCATION.lon], zoom: 6 },
        flood: { center: [LOCATION.lat, LOCATION.lon], zoom: 7 }
      };
      var ft = flyTargets[tab];
      if(ft) hazardMap.flyTo(ft.center, ft.zoom, { duration: 0.8 });
    }

    // Toggle legends per tab
    document.querySelectorAll('.fire-legend').forEach(function(el){ el.style.display = tab==='fire' ? '' : 'none'; });
    document.querySelectorAll('.quake-legend').forEach(function(el){ el.style.display = tab==='quake' ? '' : 'none'; });

    // Compact non-active status pills
    var pillMap = {fire:'fire-status-pill',tornado:'tornado-status-pill',quake:'quake-status-pill',alerts:'alerts-status-pill',flood:'flood-status-pill'};
    Object.keys(pillMap).forEach(function(k){
      var el = document.getElementById(pillMap[k]);
      if(!el) return;
      var wrap = el.parentElement;
      if(!wrap) return;
      if(k === tab){
        wrap.style.opacity = '1';
        wrap.style.transform = 'scale(1)';
      } else {
        wrap.style.opacity = '.55';
        wrap.style.transform = 'scale(.9)';
      }
    });

    // Update insight panel
    try { updateHazardInsight(); } catch(e){ console.error('Insight update error:', e); }

    // Update unified status pills
    try { updateUnifiedPills(); } catch(e){}

  }

  /* Hazard tab badge counts  Today / Week / Year for each type */
  function updateHazardBadges(){
    var now = Date.now();
    var day = 86400000;

    // Historical daily averages by month (Feb index=1) for contextual coloring
    // Sources: NIFC 10-yr avg, USGS seismic catalog, SPC annual stats, NWS AHPS
    var hazardAverages = {
      fire: [800, 900, 1000, 1100, 1200, 1500, 2000, 2500, 2200, 1500, 1000, 800], // active fires nationwide
      quake: [180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180], // M0.5+ per 24h (fairly constant)
      tornado: [0, 1, 3, 8, 12, 10, 6, 4, 3, 2, 2, 1], // daily tornado reports
      flood: [3, 4, 6, 10, 12, 10, 6, 4, 3, 3, 3, 3] // gauges above flood stage
    };

    function getBadgeColor(hazard, count){
      var month = new Date().getMonth();
      var avg = hazardAverages[hazard] ? hazardAverages[hazard][month] : null;
      if(!avg || count === 0) return null; // default color
      var ratio = count / avg;
      if(ratio >= 1.5) return '#ef4444'; // well above normal  red
      if(ratio >= 1.15) return '#f97316'; // above normal  orange
      if(ratio >= 0.85) return '#4ade80'; // normal range  green
      if(ratio >= 0.5) return '#60a5fa'; // below normal  blue
      return '#60a5fa'; // well below  blue
    }

    function setBadge(id, count, hazard){
      var el = document.getElementById(id);
      if(!el) return;
      if(count > 0){
        el.textContent = count.toLocaleString();
        el.style.display = '';
        var c = getBadgeColor(hazard, count);
        if(c){
          el.style.color = c;
          el.style.background = c + '22';
        }
      } else {
        el.textContent = '';
        el.style.display = 'none';
      }
    }

    function setTabAlert(hazard, isAlert){
      var tab = document.querySelector('#hazard-tabs .geo-tab[data-hazard="' + hazard + '"]');
      if(!tab) return;
      if(isAlert) tab.classList.add('tab-alert');
      else tab.classList.remove('tab-alert');
    }

    // FIRES
    var fires = window._activeFires || [];
    var largeFires = fires.filter(function(f){ return ((f.properties && f.properties.DailyAcres) || (f.properties && f.properties.GISAcres) || 0) >= 10000; });
    setBadge('hazard-badge-fire', fires.length, 'fire');
    setTabAlert('fire', largeFires.length > 0);

    // QUAKES (24h feed)
    var quakes = window._quakeFeatures || [];
    var sigQuakes = quakes.filter(function(q){ return q.properties && q.properties.mag >= 5.0; });
    setBadge('hazard-badge-quake', quakes.length, 'quake');
    setTabAlert('quake', sigQuakes.length > 0);

    // TORNADOES
    var tCount = window._tornadoCount || (window._tornadoReports || []).length;
    var hasSPCOutlook = (typeof tornadoOutlookLayers !== 'undefined' && tornadoOutlookLayers.length > 0);
    setBadge('hazard-badge-tornado', tCount, 'tornado');
    setTabAlert('tornado', tCount > 0 || hasSPCOutlook);

    // ALERTS
    var alerts = window._hazardAlerts || [];
    var warningCount = alerts.filter(function(a){ return a.properties && a.properties.event && a.properties.event.toLowerCase().indexOf('warning') >= 0; }).length;
    setBadge('hazard-badge-alerts', alerts.length, 'alerts');
    setTabAlert('alerts', warningCount > 0);

    // FLOOD (show elevated gauge count)
    var floodCount = window._floodGaugesAboveNormal || 0;
    var floodMajor = window._floodGaugesMajor || 0;
    setBadge('hazard-badge-flood', floodCount, 'flood');
    setTabAlert('flood', floodMajor > 0 || floodCount >= 10);

    //  Sync unified status pills 
    updateUnifiedPills();
  }

  function updateUnifiedPills(){
    var tab = hazardActiveTab;
    // Show only the active tab's pill
    ['fire','quake','tornado','flood'].forEach(function(p){
      var el = document.getElementById('hz-pill-' + p);
      if(el) el.style.display = (p === tab) ? '' : 'none';
    });

    // Fire pill
    var firePill = document.getElementById('hz-pill-fire');
    if(firePill){
      var fires = window._activeFires || [];
      var rxCount = fires.filter(function(f){ var t = (f.properties.IncidentTypeCategory || f.properties.IncidentType || '').toString().toUpperCase(); return t.indexOf('RX') >= 0 || t.indexOf('PRESCRIBED') >= 0 || t.indexOf('USE') >= 0; }).length;
      var total = fires.length;
      var wf = total - rxCount;
      if(total > 0){
        firePill.querySelector('#hz-pill-fire-head').innerHTML = '<div style="font-size:.55rem;font-weight:800;color:#fb923c;">' + total.toLocaleString() + ' FIRES</div>' +
          '<div style="font-size:.38rem;color:rgba(255,255,255,.5);margin-top:1px;">' + wf + ' wildfire  ' + rxCount + ' prescribed</div>';
      } else {
        firePill.querySelector('#hz-pill-fire-head').textContent = 'FIRES: Loading...';
      }
    }

    // Quake pill
    var qPill = document.getElementById('hz-pill-quake');
    if(qPill){
      var qCount = (window._quakeFeatures || []).length;
      if(qCount > 0){
        var qHead = qPill.querySelector('#hz-pill-quake-head');
        if(qHead) qHead.innerHTML = '<div style="font-size:.55rem;font-weight:800;color:#60a5fa;">' + qCount.toLocaleString() + ' EARTHQUAKES</div>' +
          '<div style="font-size:.38rem;color:rgba(255,255,255,.5);margin-top:1px;">Past 24h  M0.5+</div>';
      } else {
        var qHead = qPill.querySelector('#hz-pill-quake-head');
        if(qHead) qHead.textContent = 'EARTHQUAKES: Loading...';
      }
    }

    // Tornado pill  updated directly by loadTornadoReports

    // Flood pill
    var fPill = document.getElementById('hz-pill-flood');
    if(fPill){
      var fc = window._floodGaugesAboveNormal || 0;
      var fHead = fPill.querySelector('#hz-pill-flood-head');
      if(fc > 0){
        if(fHead) fHead.innerHTML = '<div style="font-size:.55rem;font-weight:800;color:' + (fc >= 10 ? '#ef4444' : fc > 0 ? '#eab308' : '#22d3ee') + ';">' + fc + ' GAUGES</div>' +
          '<div style="font-size:.38rem;color:rgba(255,255,255,.5);margin-top:1px;">Above normal stage</div>';
      } else {
        if(fHead) fHead.innerHTML = '<div style="font-size:.55rem;font-weight:800;color:#22d3ee;">FLOOD</div>' +
          '<div style="font-size:.38rem;color:rgba(255,255,255,.5);margin-top:1px;">All gauges normal</div>';
      }
    }
  }

  // 
  //  NWS ALERTS TAB  All active watches, warnings, advisories
  //  Source: api.weather.gov/alerts/active
  //  Plotted as colored polygons on the shared hazard map
  // 
  window._alertLayerGroup = null;
  window._hazardAlerts = [];
  var alertFilters = { warning: true, watch: true, advisory: true };

  function initAlertsData(){
    if(!hazardMap) return;
    window._alertLayerGroup = L.layerGroup();
    loadNWSAlerts();
    setInterval(loadNWSAlerts, 3 * 60 * 1000); // refresh every 3 min
  }

  function classifyAlertSeverity(event){
    var e = (event || '').toLowerCase();
    if(e.indexOf('warning') >= 0) return 'warning';
    if(e.indexOf('watch') >= 0) return 'watch';
    if(e.indexOf('advisory') >= 0 || e.indexOf('statement') >= 0 || e.indexOf('outlook') >= 0) return 'advisory';
    return 'advisory';
  }

  function alertColor(severity){
    if(severity === 'warning') return { fill: '#ef4444', stroke: '#dc2626', opacity: 0.25 };
    if(severity === 'watch') return { fill: '#f97316', stroke: '#ea580c', opacity: 0.18 };
    return { fill: '#eab308', stroke: '#ca8a04', opacity: 0.12 };
  }

  function loadNWSAlerts(){
    var pill = document.getElementById('alerts-status-pill');
    // Get alerts for the visible area  use state-level for broader coverage
    var bounds = hazardMap.getBounds();
    var lat = LOCATION.lat, lon = LOCATION.lon;

    // Fetch regional alerts (wider area)
    var url = 'https://api.weather.gov/alerts/active?point=' + lat.toFixed(4) + ',' + lon.toFixed(4);
    // Also fetch state-wide for the map view
    var stateUrl = 'https://api.weather.gov/alerts/active?area=' + (window._userState || 'NY');

    var allAlerts = [];
    var fetched = 0;

    function processAlerts(data){
      if(!data || !data.features) return;
      data.features.forEach(function(f){
        var props = f.properties || {};
        var geom = f.geometry;
        // Some alerts don't have geometry  skip
        allAlerts.push({
          event: props.event || 'Alert',
          headline: props.headline || '',
          description: props.description || '',
          severity: classifyAlertSeverity(props.event),
          geometry: geom,
          areaDesc: props.areaDesc || '',
          onset: props.onset,
          expires: props.expires,
          senderName: props.senderName || 'NWS'
        });
      });
    }

    function finishAlerts(){
      // Deduplicate by headline
      var seen = {};
      var unique = [];
      allAlerts.forEach(function(a){
        var key = a.event + '|' + a.areaDesc;
        if(!seen[key]){ seen[key] = true; unique.push(a); }
      });

      window._hazardAlerts = unique;

      // Clear old layers
      if(window._alertLayerGroup) window._alertLayerGroup.clearLayers();

      var warnCount = 0, watchCount = 0, advCount = 0;

      unique.forEach(function(alert){
        if(alert.severity === 'warning') warnCount++;
        else if(alert.severity === 'watch') watchCount++;
        else advCount++;

        // Only plot alerts with geometry
        if(!alert.geometry) return;

        var colors = alertColor(alert.severity);
        try {
          var layer = L.geoJSON(alert.geometry, {
            style: {
              fillColor: colors.fill,
              fillOpacity: colors.opacity,
              color: colors.stroke,
              weight: 2,
              opacity: 0.7
            }
          });
          layer.bindPopup(
            '<div class="hz-card-head"><div class="hz-accent" style="background:' + colors.stroke + ';"></div><span style="color:' + colors.stroke + ';">' + alert.event.toUpperCase() + '</span></div>' +
            '<div class="hz-card-row"><span class="hz-label">Area</span><span class="hz-val" style="max-width:180px;text-align:right;font-size:9px;">' + alert.areaDesc + '</span></div>' +
            '<div style="margin-top:6px;font-size:9px;color:rgba(255,255,255,.6);max-height:120px;overflow-y:auto;line-height:1.4;">' + (alert.headline || alert.description.substring(0,300)) + '</div>' +
            '<div class="hz-card-footer">NWS  ' + (alert.senderName || 'National Weather Service') + '</div>',
            { maxWidth: 280, className: 'hz-popup' }
          );
          window._alertLayerGroup.addLayer(layer);
        } catch(e){ /* geometry parse error */ }
      });

      // Update pill
      if(pill){
        var total = unique.length;
        if(total === 0){
          pill.textContent = ' NO ACTIVE ALERTS';
          pill.style.color = '#4ade80';
        } else {
          var parts = [];
          if(warnCount) parts.push(warnCount + ' ');
          if(watchCount) parts.push(watchCount + ' ');
          if(advCount) parts.push(advCount + ' ');
          pill.textContent = ' ' + total + ' ALERTS  ' + parts.join(' ');
          pill.style.color = warnCount > 0 ? '#ef4444' : watchCount > 0 ? '#f97316' : '#eab308';
        }
      }

      updateHazardBadges(); try{updateUnifiedPills();}catch(e){}
    }

    // Fetch point alerts
    fetchWithTimeout(url, null, 10000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        processAlerts(data);
        fetched++;
        if(fetched >= 2) finishAlerts();
      })
      .catch(function(){ fetched++; if(fetched >= 2) finishAlerts(); });

    // Fetch state alerts for broader map view
    fetchWithTimeout(stateUrl, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        processAlerts(data);
        fetched++;
        if(fetched >= 2) finishAlerts();
      })
      .catch(function(){ fetched++; if(fetched >= 2) finishAlerts(); });
  }

  function toggleAlertFilter(type){
    alertFilters[type] = !alertFilters[type];
    var btn = document.getElementById('alert-filter-' + type);
    if(btn) btn.style.opacity = alertFilters[type] ? '1' : '.35';
    // Re-render alert layers
    if(!window._alertLayerGroup) return;
    window._alertLayerGroup.clearLayers();
    (window._hazardAlerts || []).forEach(function(alert){
      if(!alertFilters[alert.severity]) return;
      if(!alert.geometry) return;
      var colors = alertColor(alert.severity);
      try {
        var layer = L.geoJSON(alert.geometry, {
          style: { fillColor: colors.fill, fillOpacity: colors.opacity, color: colors.stroke, weight: 2, opacity: 0.7 }
        });
        layer.bindPopup(
          '<div style="font-weight:700;font-size:.6rem;color:' + colors.stroke + ';">' + alert.event + '</div>' +
          '<div style="font-size:.45rem;color:#999;margin:2px 0;">' + alert.areaDesc + '</div>' +
          '<div style="font-size:.42rem;color:#ccc;max-height:120px;overflow-y:auto;">' + (alert.headline || alert.description.substring(0,300)) + '</div>',
          { maxWidth: 280, className: 'fire-popup' }
        );
        window._alertLayerGroup.addLayer(layer);
      } catch(e){}
    });
  }

  // 
  //  FLOOD TAB  NWS AHPS River Gauges (National)
  //  Source: idpgis.ncep.noaa.gov AHPS MapServer
  //  Layer 0: Observed  1-14: Forecast 24h-336h  15: Full period
  //  + USGS IV as supplemental for nearby detail
  //  + WPC Significant River Flood Outlook polygons
  // 
  window._floodLayerGroup = null;
  window._floodGauges = [];
  window._floodGaugesAboveNormal = 0;
  window._floodStats = { total:0, major:0, moderate:0, minor:0, action:0, normal:0, noData:0 };
  var floodScope = 'nearby';
  var floodForecastHour = 'obs'; // obs, 24, 48, 72, 96, full
  var AHPS_BASE = 'https://idpgis.ncep.noaa.gov/arcgis/rest/services/NWS_Observations/ahps_riv_gauges/MapServer';
  var AHPS_LAYERS = { obs:0, '24':1, '48':2, '72':3, '96':4, '144':6, '192':8, '336':14, full:15 };
  var SIG_FLOOD_OUTLOOK = 'https://idpgis.ncep.noaa.gov/arcgis/rest/services/NWS_Forecasts_Guidance_Warnings/sig_riv_fld_outlk/MapServer/0/query';

  function initFloodData(){
    if(!hazardMap) return;
    window._floodLayerGroup = L.layerGroup();
    loadFloodGaugesAHPS('obs');
    loadSigRiverFloodOutlook();
    setInterval(function(){ loadFloodGaugesAHPS(floodForecastHour); }, 10 * 60 * 1000);
  }

  function switchFloodScope(scope){
    floodScope = scope;
    var nearbyBtn = document.getElementById('flood-scope-nearby');
    var stateBtn = document.getElementById('flood-scope-state');
    if(nearbyBtn){
      nearbyBtn.style.borderColor = scope==='nearby' ? 'rgba(59,130,246,.5)' : 'rgba(139,92,246,.3)';
      nearbyBtn.style.background = scope==='nearby' ? 'rgba(59,130,246,.2)' : 'rgba(139,92,246,.1)';
    }
    if(stateBtn){
      stateBtn.style.borderColor = scope==='state' ? 'rgba(59,130,246,.5)' : 'rgba(139,92,246,.3)';
      stateBtn.style.background = scope==='state' ? 'rgba(59,130,246,.2)' : 'rgba(139,92,246,.1)';
    }
    loadFloodGaugesAHPS(floodForecastHour);
  }

  window.switchFloodForecast = function(hr){
    floodForecastHour = hr;
    // Update toggle buttons
    document.querySelectorAll('.flood-fcst-btn').forEach(function(b){
      var isActive = b.getAttribute('data-fhr') === hr;
      b.style.borderColor = isActive ? 'rgba(6,182,212,.5)' : 'rgba(255,255,255,.1)';
      b.style.background = isActive ? 'rgba(6,182,212,.25)' : 'rgba(0,0,0,.3)';
      b.style.color = isActive ? '#22d3ee' : 'rgba(255,255,255,.5)';
    });
    loadFloodGaugesAHPS(hr);
  };

  function ahpsStatusColor(status){
    status = (status || '').toLowerCase().replace(/\s+/g,'_');
    if(status === 'major') return { color:'#9333ea', label:'MAJOR FLOOD', priority:5, bg:'rgba(147,51,234,.15)' };
    if(status === 'moderate') return { color:'#ef4444', label:'MODERATE FLOOD', priority:4, bg:'rgba(239,68,68,.12)' };
    if(status === 'minor') return { color:'#f97316', label:'MINOR FLOOD', priority:3, bg:'rgba(249,115,22,.1)' };
    if(status === 'action') return { color:'#eab308', label:'ACTION STAGE', priority:2, bg:'rgba(234,179,8,.1)' };
    if(status === 'no_flooding' || status === 'not_defined' || status === 'obs_not_current' || status === 'out_of_service' || status === 'low_threshold') return { color:'#22c55e', label:'NORMAL', priority:1, bg:'rgba(34,197,94,.06)' };
    return { color:'#64748b', label:'NO DATA', priority:0, bg:'rgba(100,116,139,.06)' };
  }

  function loadFloodGaugesAHPS(forecastHr){
    var layerId = AHPS_LAYERS[forecastHr] != null ? AHPS_LAYERS[forecastHr] : 0;
    var lat = LOCATION.lat, lon = LOCATION.lon;

    // Build spatial query based on scope
    var geomParam = '';
    if(floodScope === 'state'){
      // National view  get all gauges in flooding
      geomParam = '&where=status+IN+(\'major\',\'moderate\',\'minor\',\'action\')';
    } else {
      // Nearby  bounding box ~200mi
      var delta = 3.0;
      geomParam = '&geometry=' + (lon-delta).toFixed(2) + ',' + (lat-delta).toFixed(2) + ',' + (lon+delta).toFixed(2) + ',' + (lat+delta).toFixed(2) + '&geometryType=esriGeometryEnvelope&spatialRel=esriSpatialRelIntersects&inSR=4326&where=1%3D1';
    }

    var url = AHPS_BASE + '/' + layerId + '/query?outFields=gaugelid,location,waterbody,status,observed,units,action,flood,moderate,major,obstime,url' + geomParam + '&outSR=4326&f=json&resultRecordCount=3000';

    fetchWithTimeout(url, null, 20000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if(!data || !data.features) return;
        renderFloodGauges(data.features, forecastHr);
      })
      .catch(function(e){
        console.warn('AHPS fetch failed, falling back to USGS IV:', e);
        loadFloodGaugesUSGS();
      });
  }

  function renderFloodGauges(features, forecastHr){
    if(window._floodLayerGroup) window._floodLayerGroup.clearLayers();
    window._floodGauges = [];
    var stats = { total:0, major:0, moderate:0, minor:0, action:0, normal:0, noData:0 };

    features.forEach(function(f){
      var a = f.attributes || {};
      var g = f.geometry;
      if(!g) return;
      var sLat = g.y, sLon = g.x;
      if(isNaN(sLat) || isNaN(sLon)) return;

      var status = ahpsStatusColor(a.status);
      stats.total++;
      if(status.priority >= 5) stats.major++;
      else if(status.priority === 4) stats.moderate++;
      else if(status.priority === 3) stats.minor++;
      else if(status.priority === 2) stats.action++;
      else if(status.priority === 1) stats.normal++;
      else stats.noData++;

      var observed = a.observed != null ? parseFloat(a.observed) : null;
      var units = a.units || 'ft';
      var location = a.location || 'Unknown';
      var waterbody = a.waterbody || '';
      var gaugeId = a.gaugelid || '';

      // Build flood stage comparison string
      var stageInfo = '';
      if(observed != null){
        if(a.major && observed >= parseFloat(a.major)) stageInfo = '   Major (' + a.major + ')';
        else if(a.moderate && observed >= parseFloat(a.moderate)) stageInfo = '   Moderate (' + a.moderate + ')';
        else if(a.flood && observed >= parseFloat(a.flood)) stageInfo = '   Flood (' + a.flood + ')';
        else if(a.action && observed >= parseFloat(a.action)) stageInfo = '   Action (' + a.action + ')';
        else if(a.flood) stageInfo = '  Flood stage: ' + a.flood;
      }

      // Observation time
      var timeStr = '';
      if(a.obstime){
        try { timeStr = new Date(a.obstime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); } catch(e){}
      }

      var radius = status.priority >= 5 ? 9 : status.priority >= 4 ? 7 : status.priority >= 3 ? 6 : status.priority >= 2 ? 5 : 4;
      var marker = L.circleMarker([sLat, sLon], {
        radius: radius,
        fillColor: status.color,
        fillOpacity: status.priority >= 3 ? 0.9 : 0.7,
        color: status.priority >= 4 ? '#fff' : 'rgba(255,255,255,.4)',
        weight: status.priority >= 4 ? 2 : 1
      });

      // Pulsing effect for major flood
      if(status.priority >= 5){
        marker.setStyle({ className: 'flood-pulse' });
      }

      var ttip = '<div class="hz-card-head"><div class="hz-accent" style="background:' + status.color + ';"></div><span style="color:' + status.color + ';">' + status.label + '</span></div>' +
        '<div class="hz-card-row"><span class="hz-label">Station</span><span class="hz-val" style="color:#fff;max-width:150px;text-align:right;">' + location + '</span></div>' +
        (waterbody ? '<div class="hz-card-row"><span class="hz-label">River</span><span class="hz-val">' + waterbody + '</span></div>' : '') +
        (observed != null ? '<div class="hz-card-row"><span class="hz-label">Stage</span><span class="hz-val" style="color:' + status.color + ';">' + observed.toFixed(2) + ' ' + units + '</span></div>' : '') +
        (a.action ? '<div class="hz-card-row"><span class="hz-label">Thresholds</span><span class="hz-val" style="font-size:8.5px;">Act: ' + a.action + '  Fld: ' + (a.flood||'--') + '  Maj: ' + (a.major||'--') + '</span></div>' : '') +
        (forecastHr !== 'obs' ? '<div class="hz-card-row"><span class="hz-label">Forecast</span><span class="hz-val" style="color:#22d3ee;">' + (forecastHr === 'full' ? 'Full period' : forecastHr + 'h') + '</span></div>' : '') +
        '<div class="hz-card-footer">' + (timeStr ? timeStr + '  ' : '') + 'NWS AHPS' + (gaugeId ? '  ' + gaugeId : '') + '</div>';

      marker.bindTooltip(ttip, { permanent: false, direction: 'top', offset: [0, -6], className: 'hz-tooltip' });

      // Click  open AHPS hydrograph
      if(a.url || gaugeId){
        marker.on('click', function(){
          var hydrUrl = a.url || ('https://water.noaa.gov/gauges/' + gaugeId.toLowerCase());
          window.open(hydrUrl, '_blank');
        });
        marker.setStyle({ cursor: 'pointer' });
      }

      window._floodLayerGroup.addLayer(marker);
      window._floodGauges.push({
        lat: sLat, lon: sLon, gage: observed, name: location, waterbody: waterbody,
        status: status, gaugeId: gaugeId, action: a.action ? parseFloat(a.action) : null,
        flood: a.flood ? parseFloat(a.flood) : null, moderate: a.moderate ? parseFloat(a.moderate) : null,
        major: a.major ? parseFloat(a.major) : null
      });
    });

    window._floodStats = stats;
    window._floodGaugesAboveNormal = stats.major + stats.moderate + stats.minor;
    updateHazardBadges(); try{updateUnifiedPills();}catch(e){}
    try { updateHazardInsight(); } catch(e){}
  }

  // Fallback: original USGS IV endpoint (used if AHPS is down)
  function loadFloodGaugesUSGS(){
    var lat = LOCATION.lat, lon = LOCATION.lon;
    var delta = 1.5;
    var url = 'https://waterservices.usgs.gov/nwis/iv/?format=json&bBox=' +
      (lon - delta).toFixed(3) + ',' + (lat - delta).toFixed(3) + ',' +
      (lon + delta).toFixed(3) + ',' + (lat + delta).toFixed(3) +
      '&parameterCd=00065&siteType=ST&siteStatus=active';

    fetchWithTimeout(url, null, 20000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if(!data || !data.value || !data.value.timeSeries) return;
        var series = data.value.timeSeries;
        if(window._floodLayerGroup) window._floodLayerGroup.clearLayers();
        window._floodGauges = [];
        var aboveNormal = 0, totalGauges = 0;

        for(var i = 0; i < series.length; i++){
          var ts = series[i];
          var site = ts.sourceInfo;
          if(!site || !site.geoLocation || !site.geoLocation.geogLocation) continue;
          var geo = site.geoLocation.geogLocation;
          var sLat = parseFloat(geo.latitude), sLon = parseFloat(geo.longitude);
          if(isNaN(sLat) || isNaN(sLon)) continue;
          var vals = ts.values && ts.values[0] && ts.values[0].value;
          if(!vals || vals.length === 0) continue;
          var latest = vals[vals.length - 1];
          var gageHt = parseFloat(latest.value);
          if(isNaN(gageHt) || gageHt < 0) continue;
          var siteName = site.siteName || 'Unknown';
          totalGauges++;

          var status;
          if(gageHt > 20) { status = { color: '#ef4444', label: 'ELEVATED', priority: 4 }; aboveNormal++; }
          else if(gageHt > 12) { status = { color: '#f97316', label: 'ABOVE NORMAL', priority: 3 }; aboveNormal++; }
          else if(gageHt > 8) { status = { color: '#eab308', label: 'NEAR NORMAL', priority: 2 }; }
          else { status = { color: '#22c55e', label: 'NORMAL', priority: 1 }; }

          var marker = L.circleMarker([sLat, sLon], {
            radius: gageHt > 15 ? 7 : gageHt > 8 ? 5 : 4,
            fillColor: status.color, fillOpacity: 0.8, color: '#fff', weight: 1
          });
          marker.bindTooltip(
            '<div class="hz-card-head"><div class="hz-accent" style="background:' + status.color + ';"></div><span style="color:' + status.color + ';">' + status.label + '</span></div>' +
            '<div class="hz-card-row"><span class="hz-label">Station</span><span class="hz-val" style="max-width:140px;text-align:right;">' + siteName + '</span></div>' +
            '<div class="hz-card-row"><span class="hz-label">Stage</span><span class="hz-val">' + gageHt.toFixed(2) + ' ft</span></div>',
            { className: 'hz-tooltip' }
          );
          window._floodLayerGroup.addLayer(marker);
          window._floodGauges.push({ lat: sLat, lon: sLon, gage: gageHt, name: siteName, status: status });
        }

        window._floodGaugesAboveNormal = aboveNormal;
        window._floodStats = { total: totalGauges, major:0, moderate:0, minor: aboveNormal, action:0, normal: totalGauges - aboveNormal, noData:0 };
        updateHazardBadges(); try{updateUnifiedPills();}catch(e){}
      })
      .catch(function(e){ console.error('USGS flood fallback error:', e); });
  }

  // WPC Significant River Flood Outlook  polygon overlay
  window._sigFloodOutlookLayer = null;
  function loadSigRiverFloodOutlook(){
    var url = SIG_FLOOD_OUTLOOK + '?where=1%3D1&outFields=*&outSR=4326&f=geojson';
    fetchWithTimeout(url, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if(!data || !data.features || data.features.length === 0) return;
        if(window._sigFloodOutlookLayer && hazardMap.hasLayer(window._sigFloodOutlookLayer)){
          hazardMap.removeLayer(window._sigFloodOutlookLayer);
        }
        window._sigFloodOutlookLayer = L.geoJSON(data, {
          style: function(feature){
            return {
              fillColor: '#06b6d4',
              fillOpacity: 0.12,
              color: '#22d3ee',
              weight: 2,
              opacity: 0.7,
              dashArray: '6,4'
            };
          },
          onEachFeature: function(feature, layer){
            var p = feature.properties || {};
            layer.bindPopup(
              '<div class="hz-card-head"><div class="hz-accent" style="background:#22d3ee;"></div><span style="color:#22d3ee;">RIVER FLOOD OUTLOOK</span></div>' +
              '<div style="font-size:9px;color:rgba(255,255,255,.6);line-height:1.4;margin-top:2px;">' + (p.outlook || p.OUTLOOK || 'Significant flooding expected in this area') + '</div>' +
              '<div class="hz-card-footer">WPC  NWS</div>',
              { maxWidth: 280, className: 'hz-popup' }
            );
          }
        });
        // Only add if flood tab is active
        if(hazardActiveTab === 'flood' && hazardMap){
          window._sigFloodOutlookLayer.addTo(hazardMap);
        }
      })
      .catch(function(e){ console.log('Sig flood outlook not available:', e.message); });
  }

  // 
  //  HAZARD OUTLOOK OVERLAYS  1-3 Day forecast polygons
  //  Sources:
  //   SPC Fire Weather Outlooks (Elevated/Critical/Extreme)
  //   SPC Convective Categorical Outlooks (TSTM-HIGH)
  //   WPC Excessive Rainfall Outlooks (MRGL-HIGH)
  //  All from NOAA MapServer GeoJSON endpoints
  // 
  var outlookLayers = { fire: null, tornado: null, flood: null };
  var outlookActiveDay = { fire: 'off', tornado: 'off', flood: 'off' };

  // Layer ID mapping from NOAA MapServer docs
  var outlookEndpoints = {
    fire: {
      base: 'https://mapservices.weather.noaa.gov/vector/rest/services/fire_weather/SPC_firewx/MapServer/',
      d1: 1,   // Day 1 Categorical Fire Weather
      d2: 3,   // Day 2 Categorical Fire Weather
      d3: 5    // Day 3-8 Fire Weather
    },
    tornado: {
      base: 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/',
      d1: 1,   // Day 1 Categorical Outlook
      d2: 9,   // Day 2 Categorical Outlook
      d3: 17   // Day 3 Categorical Outlook
    },
    flood: {
      base: 'https://mapservices.weather.noaa.gov/vector/rest/services/hazards/wpc_precip_hazards/MapServer/',
      d1: 0,   // Day 1 Excessive Rainfall
      d2: 1,   // Day 2 Excessive Rainfall
      d3: 2    // Day 3 Excessive Rainfall
    }
  };

  // Color schemes for each outlook type
  var outlookColors = {
    fire: function(props){
      var dn = props.dn || props.DN || 0;
      var label = (props.LABEL || props.label || props.idp_source || '').toString().toLowerCase();
      if(dn >= 10 || label.indexOf('extreme') >= 0) return { fill:'#9333ea', stroke:'#7c3aed', opacity:0.35 };
      if(dn >= 8 || label.indexOf('critical') >= 0) return { fill:'#ef4444', stroke:'#dc2626', opacity:0.3 };
      if(dn >= 5 || label.indexOf('elevated') >= 0) return { fill:'#f97316', stroke:'#ea580c', opacity:0.2 };
      if(label.indexOf('dry') >= 0) return { fill:'#eab308', stroke:'#ca8a04', opacity:0.15 };
      return { fill:'#f97316', stroke:'#ea580c', opacity:0.15 };
    },
    tornado: function(props){
      var dn = props.dn || props.DN || 0;
      var label = (props.LABEL || props.label || props.idp_source || '').toString();
      if(dn >= 30 || label.indexOf('High') >= 0) return { fill:'#9333ea', stroke:'#7c3aed', opacity:0.35 };
      if(dn >= 20 || label.indexOf('MDT') >= 0 || label.indexOf('Moderate') >= 0) return { fill:'#ef4444', stroke:'#dc2626', opacity:0.3 };
      if(dn >= 10 || label.indexOf('ENH') >= 0 || label.indexOf('Enhanced') >= 0) return { fill:'#f97316', stroke:'#ea580c', opacity:0.25 };
      if(dn >= 5 || label.indexOf('SLGT') >= 0 || label.indexOf('Slight') >= 0) return { fill:'#eab308', stroke:'#ca8a04', opacity:0.2 };
      if(dn >= 3 || label.indexOf('MRGL') >= 0 || label.indexOf('Marginal') >= 0) return { fill:'#84cc16', stroke:'#65a30d', opacity:0.15 };
      if(dn >= 2) return { fill:'#22c55e', stroke:'#16a34a', opacity:0.1 }; // TSTM
      return { fill:'#60a5fa', stroke:'#3b82f6', opacity:0.1 };
    },
    flood: function(props){
      var label = (props.LABEL || props.label || props.idp_source || props.product || '').toString().toLowerCase();
      if(label.indexOf('high') >= 0) return { fill:'#9333ea', stroke:'#7c3aed', opacity:0.35 };
      if(label.indexOf('moderate') >= 0 || label.indexOf('mdt') >= 0) return { fill:'#ef4444', stroke:'#dc2626', opacity:0.3 };
      if(label.indexOf('slight') >= 0 || label.indexOf('slgt') >= 0) return { fill:'#f97316', stroke:'#ea580c', opacity:0.22 };
      if(label.indexOf('marginal') >= 0 || label.indexOf('mrgl') >= 0) return { fill:'#eab308', stroke:'#ca8a04', opacity:0.15 };
      return { fill:'#06b6d4', stroke:'#0891b2', opacity:0.12 };
    }
  };

  function switchHazardOutlook(hazType, day){
    outlookActiveDay[hazType] = day;

    // Update toggle button states
    ['off','d1','d2','d3'].forEach(function(d){
      var btn = document.getElementById(hazType + '-otlk-' + d);
      if(btn){
        if(d === day){
          btn.classList.add('otlk-active');
          btn.style.background = 'rgba(255,255,255,.12)';
          btn.style.borderColor = 'rgba(255,255,255,.3)';
        } else {
          btn.classList.remove('otlk-active');
          btn.style.background = 'rgba(0,0,0,.45)';
          btn.style.borderColor = d === 'off' ? 'rgba(255,255,255,.1)' : '';
        }
      }
    });

    // Clear existing outlook layer
    if(outlookLayers[hazType]){
      hazardMap.removeLayer(outlookLayers[hazType]);
      outlookLayers[hazType] = null;
    }

    if(day === 'off') return;

    // Fetch outlook GeoJSON
    var cfg = outlookEndpoints[hazType];
    if(!cfg) return;
    var layerId = cfg[day];
    if(layerId == null) return;

    var url = cfg.base + layerId + '/query?where=1%3D1&outFields=*&f=geojson';

    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      if(!data || !data.features || data.features.length === 0){
        console.log('No outlook features for', hazType, day);
        return;
      }

      var colorFn = outlookColors[hazType];
      var dayLabels = {d1:'Day 1', d2:'Day 2', d3:'Day 3'};
      var typeLabels = {fire:'Fire Weather', tornado:'Convective', flood:'Excessive Rainfall'};
      var typeEmoji = {fire:'', tornado:'', flood:''};

      var layer = L.geoJSON(data, {
        style: function(feature){
          var c = colorFn(feature.properties || {});
          return {
            fillColor: c.fill,
            fillOpacity: c.opacity,
            color: c.stroke,
            weight: 2,
            opacity: 0.8,
            dashArray: '6 3'
          };
        },
        onEachFeature: function(feature, lyr){
          var p = feature.properties || {};
          var label = p.LABEL || p.label || p.idp_source || p.product || '';
          var dn = p.dn || p.DN || '';
          var outlookColor = hazType === 'fire' ? '#f97316' : hazType === 'wind' ? '#76ff03' : '#eab308';
          lyr.bindTooltip(
            '<div class="hz-card-head"><div class="hz-accent" style="background:'+outlookColor+';"></div><span style="color:'+outlookColor+';">'+typeLabels[hazType].toUpperCase()+' OUTLOOK</span></div>' +
            '<div class="hz-card-row"><span class="hz-label">Risk</span><span class="hz-val">' + (label || 'Category ' + dn) + '</span></div>' +
            '<div class="hz-card-footer">' + dayLabels[day] + '  SPC</div>',
            { sticky: true, className: 'hz-tooltip' }
          );
        }
      });

      outlookLayers[hazType] = layer;

      // Only add to map if this tab is currently active
      if(hazardActiveTab === hazType || (hazType === 'tornado' && hazardActiveTab === 'tornado') ||
         (hazType === 'flood' && hazardActiveTab === 'flood') ||
         (hazType === 'fire' && hazardActiveTab === 'fire')){
        layer.addTo(hazardMap);
      }
    }).catch(function(e){
      console.error('Outlook fetch error:', hazType, day, e);
    });
  }
  // 
  //  HAZARD TOOLTIP DATABASE  deep educational content per tab
  //  Same pattern as radarInfoData + injectLiveProductContext
  // 
  var hazardInfoData = {
    fire: '<b>Wildfire Monitoring  NIFC + FIRMS + HMS + CWFIS</b>' +
      '<br><br><span class="k">What it shows:</span> Every active wildfire in the United States and Canada plotted in real-time. Marker size corresponds to acreage and color to fire size class: <b style="color:#fbbf24;">yellow</b> (<1K acres), <b style="color:#fb923c;">orange</b> (1K-10K), <b style="color:#ef4444;">red</b> (10K-50K), <b style="color:#7f1d1d;">dark red</b> (50K+).' +
      '<br><br><span class="k">Data sources:</span>' +
      '<br> <b>NIFC</b> (National Interagency Fire Center)  the authoritative US source. Updates ~every 30 min with fire perimeters, acreage, containment %, and managing agency.' +
      '<br> <b>FIRMS</b> (NASA Fire Information for Resource Management)  thermal anomaly detections from VIIRS instruments aboard Suomi NPP and NOAA-20/21 satellites. Detects heat signatures not yet in any agency database  potential new ignitions, prescribed burns, or industrial sources. These "unconfirmed" detections are often the earliest indication of a new fire, sometimes hours before ground reporting. Fire Radiative Power (FRP) in megawatts indicates burn intensity.' +
      '<br> <b>HMS</b> (NOAA Hazard Mapping System)  smoke plume analysis by trained NOAA analysts who hand-draw plume boundaries from satellite imagery every few hours. The SFC/COL toggles show surface smoke vs. column-integrated smoke.' +
      '<br> <b>CWFIS</b> (Canadian Wildland Fire Information System)  Canadian agency-reported fire data from Natural Resources Canada. Active MaySeptember; off-season, NASA FIRMS satellite detection covers Canadian territory.' +
      '<br><br><span class="k">Smoke overlays explained:</span>' +
      '<br> <b>SFC</b>  HRRR-Smoke surface-level smoke concentration. Shows where smoke is at ground level affecting breathing.' +
      '<br> <b>COL</b>  HRRR-Smoke column-integrated smoke. Total smoke in the atmosphere regardless of altitude. Affects visibility and solar radiation.' +
      '<br> <b>HMS</b>  NOAA analyst-drawn smoke plumes from satellite. Most reliable for large-scale plume tracking.' +
      '<br> <b>CAN</b>  Canadian smoke model (BlueSky/FireWork).' +
      '<br> <b>PM.</b>  NWS particulate matter forecast from the HRRR-Smoke model. Colored by AQI category.' +
      '<br> <b>DUST</b>  HRRR dust/sand concentration. Important for Saharan dust events in the Southeast.' +
      '<br><br><span class="k">Fire weather thresholds:</span>' +
      '<br> <b>Red Flag Warning</b>: sustained wind 25 mph + RH 15%, or wind 20 mph + RH 15% (varies by region).' +
      '<br> <b>Fire Weather Watch</b>: conditions expected within 12-72 hours.' +
      '<br> Wind + low humidity + dry fuels = exponential fire spread rate. A 10 mph increase in wind can double the rate of spread.' +
      '<br><br><span class="k">Cross-references:</span> The smoke intelligence engine automatically detects when satellite imagery, PM2.5 levels, and AQI data suggest smoke is impacting your location  even from fires hundreds of miles away. Check the AQI widget for health guidance.' +
      '<br><br><span class="k">Pro tip:</span> Toggle the labels () overlay to see city names for geographic context. Use the expand button to go full-screen for detailed fire perimeter analysis.',

    tornado: '<b>Severe Weather  SPC Storm Reports + Outlooks</b>' +
      '<br><br><span class="k">What it shows:</span> All confirmed tornado reports, significant hail reports (1" diameter), and damaging wind reports (58 mph) from the Storm Prediction Center (SPC), plotted at their exact coordinates. SPC convective outlook polygons show forecast risk areas.' +
      '<br><br><span class="k">Marker symbology:</span>' +
      '<br> <b>Tornado reports</b>  circles colored by Enhanced Fujita scale: <span style="color:#22c55e;">EF0</span> (65-85 mph), <span style="color:#84cc16;">EF1</span> (86-110), <span style="color:#eab308;">EF2</span> (111-135), <span style="color:#f97316;">EF3</span> (136-165), <span style="color:#ef4444;">EF4</span> (166-200), <span style="color:#7f1d1d;">EF5</span> (200+). Unknown ratings shown as gray.' +
      '<br> <b>Hail reports</b>  cyan markers, size scaled by diameter. Severe hail begins at 1" (quarter). Significant severe at 2" (baseball). Giant hail at 4"+ (grapefruit) is extremely destructive.' +
      '<br> <b>Wind reports</b>  teal markers for measured/estimated gusts 58 mph (severe threshold). Derecho events show as long linear swaths of wind reports.' +
      '<br><br><span class="k">SPC outlook polygons:</span>' +
      '<br> <b style="color:#22c55e;">TSTM</b> (General thunder)  10%+ probability of thunderstorms within 25 miles.' +
      '<br> <b style="color:#c6b80c;">MRGL</b> (Marginal, cat 1)  isolated severe possible.' +
      '<br> <b style="color:#eab308;">SLGT</b> (Slight, cat 2)  scattered severe.' +
      '<br> <b style="color:#f97316;">ENH</b> (Enhanced, cat 3)  numerous severe storms expected.' +
      '<br> <b style="color:#ef4444;">MDT</b> (Moderate, cat 4)  widespread severe, possible significant tornadoes/hail. Issued ~10-15 times per year.' +
      '<br> <b style="color:#a855f7;">HIGH</b> (High, cat 5)  major regional outbreak expected. Violent tornadoes likely. Issued ~3-5 times per year. Treat as life-threatening.' +
      '<br><br><span class="k">Time range tabs:</span> Today shows the current SPC day. 48H-1Y extends the report history. The Forecast tab shows the SPC convective outlook polygons for the upcoming period.' +
      '<br><br><span class="k">Key convective parameters:</span> The radar widget has CAPE, SRH (storm-relative helicity), and updraft helicity products that forecast the severe weather environment. Cross-reference: if CAPE >2000 J/kg AND SRH >200 m/s overlap near your location, tornado potential is significantly elevated.' +
      '<br><br><span class="k">Pro tip:</span> Click any report marker for detailed information including the exact EF rating, path length/width for tornadoes, and reporting source. SPC updates reports hourly during active severe weather days.',

    quake: '<b>Earthquake Monitoring  USGS + Macrostrat Geology</b>' +
      '<br><br><span class="k">What it shows:</span> All earthquakes detected worldwide in the past 24 hours from the USGS Earthquake Hazards Program. Markers are <b>diamond-shaped squares</b> (rotated 45) to distinguish them from fire circles and tornado circles.' +
      '<br><br><span class="k">Marker symbology:</span>' +
      '<br> <b>Size by magnitude:</b> Larger markers = stronger quakes. M6+ are 14px, scaling down to 5px for M<2.' +
      '<br> <b>Color by magnitude:</b> <span style="color:#7dd3fc;">M<1.5</span> (micro), <span style="color:#84cc16;">M2.5</span> (minor), <span style="color:#eab308;">M3.5</span> (light), <span style="color:#f97316;">M4.5</span> (moderate), <span style="color:#ef4444;">M5.5+</span> (strong), <span style="color:#7f1d1d;">M7+</span> (major/great).' +
      '<br><br><span class="k">Magnitude scale explained:</span> The Richter/moment magnitude scale is <b>logarithmic</b>  each whole number is 10 the amplitude and 31.6 the energy. An M5 releases 31.6 more energy than M4. An M7 releases ~1,000 more energy than M5. This is why M7+ events cause catastrophic damage while M5s are usually moderate.' +
      '<br><br><span class="k">Macrostrat geology overlay ():</span> Toggle ON to display bedrock geology from the Macrostrat database. Click anywhere on the map to identify the rock unit, age, and tectonic context. This provides geological context for seismicity  earthquakes cluster at plate boundaries, fault zones, and areas of tectonic stress.' +
      '<br><br><span class="k">EPA contamination overlay ():</span> Toggle ON to display EPA Superfund NPL sites (hazardous waste cleanup locations) and TRI Toxic Release Inventory facilities (650+ tracked chemicals). Available on Fire, Earthquake, and Flood tabs. Diamond markers = Superfund sites (color-coded by cleanup status), circles = TRI facilities (color-coded by industry). The insight panel automatically cross-references these sites with active hazards to flag contamination risks  fires near Superfund sites can release toxic fumes, flooding can mobilize hazardous materials, and earthquakes can breach containment.' +
      '<br><br><span class="k">Key tectonic context:</span>' +
      '<br> <b>Pacific Ring of Fire</b>  90% of the world\'s earthquakes. Subduction zones produce the largest quakes (M9+).' +
      '<br> <b>Mid-Atlantic Ridge</b>  divergent boundary producing frequent M4-6 events.' +
      '<br> <b>New Madrid Seismic Zone</b> (central US)  intraplate, produces M4-5 regularly. M7+ occurred in 1811-1812.' +
      '<br> <b>Cascadia Subduction Zone</b> (Pacific NW)  capable of M9+, last great earthquake 1700 AD.' +
      '<br> <b>San Andreas Fault</b>  transform boundary, M6-8 capable.' +
      '<br><br><span class="k">Tsunami cross-reference:</span> Submarine earthquakes M7+ with shallow focal depths (<70km) in subduction zones can generate tsunamis. The Pacific Tsunami Warning Center issues advisories within minutes. Coastal quakes M6.5+ warrant immediate tsunami awareness.' +
      '<br><br><span class="k">Data refresh:</span> USGS feed updates every 5 minutes. Preliminary magnitudes may be revised within 10-30 minutes as more seismic stations report data.',

    alerts: '<b>NWS Active Alerts  Watches, Warnings & Advisories</b>' +
      '<br><br><span class="k">What it shows:</span> All active National Weather Service (NWS) watches, warnings, and advisories plotted as colored polygons on the map. This is the same alert data used by NOAA Weather Radio and the Emergency Alert System (EAS).' +
      '<br><br><span class="k">Alert hierarchy:</span>' +
      '<br> <b style="color:#ef4444;"> WARNINGS</b> (red polygons)  A hazardous weather event is <b>occurring or imminent</b>. Take immediate action. Examples: Tornado Warning, Severe Thunderstorm Warning, Flash Flood Warning, Blizzard Warning.' +
      '<br> <b style="color:#f97316;"> WATCHES</b> (orange polygons)  Conditions are <b>favorable</b> for a hazardous event. Be prepared. Examples: Tornado Watch, Severe Thunderstorm Watch, Flash Flood Watch, Winter Storm Watch.' +
      '<br> <b style="color:#eab308;"> ADVISORIES</b> (yellow polygons)  A weather event is expected that may cause <b>inconvenience or minor hazard</b>. Exercise caution. Examples: Wind Advisory, Dense Fog Advisory, Winter Weather Advisory, Heat Advisory.' +
      '<br><br><span class="k">Filter toggles:</span> Use the WARNINGS / WATCHES / ADVISORIES buttons (top-right) to show/hide each severity level. During active severe weather, hide advisories to focus on the most critical alerts.' +
      '<br><br><span class="k">Alert coverage:</span> Data includes both your local alerts (point query for your exact coordinates) and state-wide alerts for broader situational awareness. Click any polygon to read the full alert text, area description, and issuing office.' +
      '<br><br><span class="k">Key alert types by season:</span>' +
      '<br> <b>Spring/Summer:</b> Tornado Warnings, Severe Thunderstorm Warnings, Flash Flood Warnings, Excessive Heat Warnings.' +
      '<br> <b>Fall/Winter:</b> Winter Storm Warnings, Ice Storm Warnings, Wind Chill Advisories, Lake Effect Snow Warnings.' +
      '<br> <b>Year-round:</b> Flash Flood Warnings, High Wind Warnings, Dense Fog Advisories, Red Flag Warnings (fire weather).' +
      '<br> <b>Rare but critical:</b> Tsunami Warnings, Extreme Wind Warnings (hurricane), Tornado Emergencies (confirmed violent tornado).' +
      '<br><br><span class="k">Cross-references:</span> Tornado warnings cross-reference with SPC storm reports on the SEVERE tab. Flash Flood Warnings cross-reference with USGS river gauges on the FLOOD tab. Red Flag Warnings cross-reference with active fires on the FIRES tab. Space weather alerts are available in the Geospace widget.' +
      '<br><br><span class="k">Data refresh:</span> Every 3 minutes. NWS issues new alerts within seconds of detection  tornado warnings typically have 10-15 minutes of lead time.',

    flood: '<b>Flood Intelligence  NWS AHPS + USGS + WPC</b>' +
      '<br><br><span class="k">What it shows:</span> River gauge flood status from the NWS <b>Advanced Hydrologic Prediction Service (AHPS)</b>. Each marker represents an official NWS river forecast point with <b>real flood stage thresholds</b> defined by local NWS offices based on historical flooding and local impacts.' +
      '<br><br><span class="k">Flood categories (NWS-defined):</span>' +
      '<br> <span style="color:#22c55e;"></span> <b>Normal</b>  river at typical levels. No flooding.' +
      '<br> <span style="color:#eab308;"></span> <b>Action stage</b>  river approaching levels where NWS begins monitoring and issuing River Flood Statements. Mitigation activities may begin.' +
      '<br> <span style="color:#f97316;"></span> <b>Minor flood</b>  some inundation of low-lying areas, minor road flooding, agricultural impacts. Minimal property damage expected.' +
      '<br> <span style="color:#ef4444;"></span> <b>Moderate flood</b>  inundation of secondary roads, some structures affected, evacuations may be needed. Significant agricultural/economic damage.' +
      '<br> <span style="color:#9333ea;"></span> <b>Major flood</b>  extensive inundation, many structures flooded, evacuations required, life-threatening conditions. Historical flood levels being approached or exceeded.' +
      '<br><br><span class="k">Forecast time toggle (top right):</span>' +
      '<br> <b>OBS</b>  current observed conditions (what\'s happening RIGHT NOW)' +
      '<br> <b>24H / 48H / 72H / 96H</b>  NWS River Forecast Center model predictions for each time window. Shows the <b>peak forecast status</b> within that period.' +
      '<br> <b>MAX</b>  worst-case flood status over the entire 14-day forecast period. Best for advance planning.' +
      '<br>Switch between observed and forecast to see rivers that aren\'t flooding yet but WILL BE.' +
      '<br><br><span class="k">Scope toggles:</span>' +
      '<br> <b> NEARBY</b>  all gauges within ~200 miles of your location.' +
      '<br> <b> FLOODING</b>  shows ONLY gauges currently at action stage or above across the ENTIRE country. Best for national flood awareness.' +
      '<br><br><span class="k">ERO Overlays (top center):</span> WPC Excessive Rainfall Outlooks  probability areas for rainfall exceeding flash flood guidance values. D1/D2/D3 = Days 1-3. These drive future flooding.' +
      '<br><br><span class="k">Sig River Flood Outlook:</span> Dashed cyan polygon overlay showing WPC/RFC areas expecting significant (moderate+) river flooding. This is the official NWS national river flood forecast.' +
      '<br><br><span class="k">Click any gauge</span> to open its NWS hydrograph showing detailed water level history and forecast curves.' +
      '<br><br><span class="k">Data sources:</span> NWS AHPS via NCEP ArcGIS MapServer (3,500+ forecast points), USGS NWIS (~10,000 real-time stream gauges), WPC Sig River Flood Outlook, WPC Excessive Rainfall Outlooks. Data refreshes every 10 minutes.'
  };

  var hazardTooltipEl = null;
  var hazardTooltipTimer = null;

  function showHazardTooltip(id, anchor){
    if(!hazardInfoData[id]) return;
    if(!hazardTooltipEl) hazardTooltipEl = document.getElementById('hazard-info-tooltip');
    if(!hazardTooltipEl) return;

    // Build content: static encyclopedia + live data injection
    var content = hazardInfoData[id];
    content = injectHazardLiveContext(id, content);

    hazardTooltipEl.innerHTML = content;
    hazardTooltipEl.style.display = 'block';

    // Position inside the widget-body container (absolute positioning)
    var widgetBody = hazardTooltipEl.parentElement;
    if(!widgetBody) return;
    var bodyRect = widgetBody.getBoundingClientRect();
    var anchorRect = anchor.getBoundingClientRect();
    var ttH = hazardTooltipEl.offsetHeight;
    var ttW = Math.min(380, bodyRect.width - 24);

    // Place below the tabs, aligned right inside the widget
    var top = anchorRect.bottom - bodyRect.top + 4;
    var right = 12;

    // If it would go below the widget, place at top
    if(top + ttH > bodyRect.height - 10) top = 8;

    hazardTooltipEl.style.top = top + 'px';
    hazardTooltipEl.style.right = right + 'px';
    hazardTooltipEl.style.left = 'auto';
    hazardTooltipEl.style.width = ttW + 'px';

    // Auto-hide logic
    clearTimeout(hazardTooltipTimer);
    hazardTooltipEl.onmouseleave = function(){
      hazardTooltipTimer = setTimeout(function(){ if(hazardTooltipEl) hazardTooltipEl.style.display = 'none'; }, 300);
    };
    hazardTooltipEl.onmouseenter = function(){
      clearTimeout(hazardTooltipTimer);
    };
  }

  // Close hazard tooltip on click outside
  document.addEventListener('click', function(e){
    if(hazardTooltipEl && !e.target.closest('.hazard-info') && !e.target.closest('#hazard-info-tooltip')){
      hazardTooltipEl.style.display = 'none';
    }
  });

  function injectHazardLiveContext(id, content){
    var wx = window._wxCurrent || {};
    var live = '';
    var S = function(label, color){ return '<div style="background:rgba(255,255,255,.04);border-radius:8px;padding:8px 10px;margin-top:10px;border-left:3px solid ' + color + ';">'; };
    var E = '</div>';

    if(id === 'fire'){
      var fires = window._activeFires || [];
      var smokeIntel = window._smokeIntel || null;
      live += S('CURRENT CONDITIONS', '#f97316');
      live += '<div style="font-weight:700;font-size:.48rem;color:#fb923c;margin-bottom:2px;"> LIVE FIRE CONDITIONS</div>';
      live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.50rem;">';
      live += '<span class="k">Active fires:</span><span>' + fires.length + ' tracked</span>';
      var large = fires.filter(function(f){ return (f.acres||0)>=10000; }).length;
      if(large) live += '<span class="k">Large fires:</span><span style="color:#ef4444;">' + large + ' (10K+ acres)</span>';
      if(wx.wind != null) live += '<span class="k">Wind:</span><span>' + Math.round(wx.wind) + ' mph' + (wx.wind >= 20 ? ' <span style="color:#f97316;"> fire spread risk elevated</span>' : '') + '</span>';
      if(wx.rh != null) live += '<span class="k">Humidity:</span><span>' + Math.round(wx.rh) + '%' + (wx.rh < 25 ? ' <span style="color:#ef4444;"> critically dry</span>' : wx.rh < 40 ? ' <span style="color:#f97316;"> dry</span>' : '') + '</span>';
      if(smokeIntel && smokeIntel.smokeEvent) live += '<span class="k">Smoke:</span><span style="color:#f97316;">' + smokeIntel.severity + '  ' + smokeIntel.smokeConfidence + '% confidence</span>';
      var pm25 = (window._aqData && window._aqData.current) ? window._aqData.current.pm2_5 : null;
      if(pm25 != null) live += '<span class="k">PM2.5:</span><span>' + pm25.toFixed(0) + ' g/m' + (pm25 >= 55 ? ' <span style="color:#ef4444;"> unhealthy</span>' : pm25 >= 35 ? ' <span style="color:#f97316;"> moderate</span>' : '') + '</span>';
      live += '</div>' + E;

    } else if(id === 'tornado'){
      live += S('CURRENT CONDITIONS', '#a855f7');
      live += '<div style="font-weight:700;font-size:.48rem;color:#c084fc;margin-bottom:2px;"> LIVE SEVERE ENVIRONMENT</div>';
      live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.50rem;">';
      var tCount = window._tornadoCount || 0;
      live += '<span class="k">Reports:</span><span>' + tCount + ' tornado report' + (tCount !== 1 ? 's' : '') + '</span>';
      if(wx.cape != null) live += '<span class="k">CAPE:</span><span>' + Math.round(wx.cape) + ' J/kg' + (wx.cape >= 3000 ? ' <span style="color:#ef4444;"> extreme instability</span>' : wx.cape >= 1500 ? ' <span style="color:#f97316;"> high instability</span>' : wx.cape >= 500 ? ' <span style="color:#eab308;"> moderate</span>' : '') + '</span>';
      if(wx.gust != null && wx.gust >= 20) live += '<span class="k">Gusts:</span><span>' + Math.round(wx.gust) + ' mph' + (wx.gust >= 40 ? ' <span style="color:#ef4444;"> strong shear indicator</span>' : '') + '</span>';
      if(wx.dewpoint != null) live += '<span class="k">Dewpoint:</span><span>' + Math.round(wx.dewpoint) + 'F' + (wx.dewpoint >= 65 ? ' <span style="color:#f97316;"> rich moisture, storm fuel</span>' : wx.dewpoint >= 55 ? '  adequate moisture' : '') + '</span>';
      if(wx.temp != null && wx.dewpoint != null) {
        var spread = wx.temp - wx.dewpoint;
        if(spread < 5) live += '<span class="k">T-Td spread:</span><span>' + spread.toFixed(0) + 'F  saturated boundary layer, low cloud bases</span>';
      }
      var alerts = window._nwsAlerts || [];
      var sevAlerts = alerts.filter(function(a){ return a.toLowerCase().indexOf('tornado') >= 0 || a.toLowerCase().indexOf('severe thunderstorm') >= 0; });
      if(sevAlerts.length > 0) live += '<span class="k">Active alerts:</span><span style="color:#ef4444;">' + sevAlerts.join(', ') + '</span>';
      live += '</div>' + E;

    } else if(id === 'quake'){
      var quakes = window._quakeFeatures || [];
      var maxMag = 0, maxPlace = '';
      quakes.forEach(function(q){ if((q.properties.mag||0) > maxMag){ maxMag = q.properties.mag; maxPlace = q.properties.place; } });
      live += S('CURRENT CONDITIONS', '#3b82f6');
      live += '<div style="font-weight:700;font-size:.48rem;color:#60a5fa;margin-bottom:2px;"> SEISMIC ACTIVITY (24H)</div>';
      live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.50rem;">';
      live += '<span class="k">Total quakes:</span><span>' + quakes.length + '</span>';
      live += '<span class="k">M4.5+:</span><span>' + quakes.filter(function(q){ return (q.properties.mag||0) >= 4.5; }).length + '</span>';
      if(maxMag > 0) live += '<span class="k">Largest:</span><span>M' + maxMag.toFixed(1) + '  ' + (maxPlace || 'unknown') + '</span>';
      live += '</div>' + E;

    } else if(id === 'alerts'){
      var ha = window._hazardAlerts || [];
      live += S('CURRENT CONDITIONS', '#ef4444');
      live += '<div style="font-weight:700;font-size:.48rem;color:#f87171;margin-bottom:2px;"> ACTIVE ALERT SUMMARY</div>';
      live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.50rem;">';
      live += '<span class="k">Total:</span><span>' + ha.length + ' active alert' + (ha.length !== 1 ? 's' : '') + '</span>';
      live += '<span class="k">Warnings:</span><span style="color:#ef4444;">' + ha.filter(function(a){ return a.severity==='warning'; }).length + '</span>';
      live += '<span class="k">Watches:</span><span style="color:#f97316;">' + ha.filter(function(a){ return a.severity==='watch'; }).length + '</span>';
      live += '<span class="k">Advisories:</span><span style="color:#eab308;">' + ha.filter(function(a){ return a.severity==='advisory'; }).length + '</span>';
      if(ha.length > 0){
        live += '</div><div style="margin-top:4px;font-size:.46rem;">';
        ha.filter(function(a){ return a.severity==='warning'; }).slice(0,3).forEach(function(a){
          live += '<div style="color:#f87171;margin:1px 0;"> ' + a.event + '</div>';
        });
      }
      live += '</div>' + E;

    } else if(id === 'flood'){
      var gauges = window._floodGauges || [];
      var elev = gauges.filter(function(g){ return g.status && g.status.priority >= 3; });
      live += S('CURRENT CONDITIONS', '#06b6d4');
      live += '<div style="font-weight:700;font-size:.48rem;color:#22d3ee;margin-bottom:2px;"> RIVER GAUGE STATUS</div>';
      live += '<div style="display:grid;grid-template-columns:auto 1fr;gap:2px 8px;font-size:.50rem;">';
      live += '<span class="k">Gauges monitored:</span><span>' + gauges.length + '</span>';
      live += '<span class="k">Elevated:</span><span style="color:' + (elev.length > 0 ? '#f97316' : '#4ade80') + ';">' + elev.length + '</span>';
      if(wx.precipProb != null) live += '<span class="k">Precip probability:</span><span>' + wx.precipProb + '%' + (wx.precipProb > 60 ? ' <span style="color:#f97316;"> monitor for rising levels</span>' : '') + '</span>';
      if(elev.length > 0){
        live += '</div><div style="margin-top:4px;font-size:.46rem;">';
        elev.sort(function(a,b){ return b.gage - a.gage; }).slice(0,3).forEach(function(g){
          live += '<div style="color:#f97316;margin:1px 0;"> ' + g.gage.toFixed(1) + ' ft  ' + g.name + '</div>';
        });
      }
      live += '</div>' + E;
    }

    return content + live;
  }
  var hazardInsightOpen = false;

  function toggleHazardInsight(){
    hazardInsightOpen = !hazardInsightOpen;
    var panel = document.getElementById('hazard-insight-panel');
    var btn = document.getElementById('hazard-insight-toggle');
    if(panel){
      panel.style.transform = hazardInsightOpen ? 'translateX(0)' : 'translateX(100%)';
      panel.style.transition = 'transform .3s ease';
    }
    if(btn){
      btn.textContent = hazardInsightOpen ? ' HIDE' : ' INSIGHT';
      btn.style.right = hazardInsightOpen ? '350px' : '10px';
      btn.style.transition = 'right .3s ease';
    }
    // Pre-load EPA data for cross-referencing when insight opens
    if(hazardInsightOpen && !window._epaLoaded && typeof loadEpaData === 'function'){
      loadEpaData().then(function(){
        updateHazardInsight(); // Re-render with EPA data now available
      });
    }
  }

  function updateHazardInsight(){
    var el = document.getElementById('hazard-insight-content');
    if(!el) return;
    var tab = hazardActiveTab;
    var wx = window._wxCurrent || {};
    var sw = window._swData || {};
    var h = '';
    var K = function(t){ return '<span style="color:rgba(120,160,255,.9);font-weight:600;">'+t+'</span>'; };
    var W = function(t){ return '<span style="color:#f97316;font-weight:600;">'+t+'</span>'; };
    var D = function(t){ return '<span style="color:#ef4444;font-weight:600;">'+t+'</span>'; };
    var G = function(t){ return '<span style="color:#4ade80;font-weight:600;">'+t+'</span>'; };
    // Compact bullet line
    var B = function(label, val, color){ return '<div style="display:flex;gap:5px;margin-bottom:2px;font-size:.44rem;line-height:1.45;"><span style="color:'+(color||'rgba(255,255,255,.4)')+';white-space:nowrap;font-weight:600;min-width:fit-content;">'+label+'</span><span style="color:rgba(255,255,255,.75);">'+val+'</span></div>'; };
    var SECT = function(title){ return '<div style="font-size:.36rem;font-weight:800;color:rgba(255,255,255,.25);letter-spacing:.1em;margin:8px 0 3px;border-top:1px solid rgba(255,255,255,.04);padding-top:5px;">'+title+'</div>'; };


    if(tab === 'fire'){
      var fires = window._activeFires || [];
      var usCount = fires.filter(function(f){ var c = f.properties && f.properties._country; return c === 'US'; }).length;
      var caCount = fires.filter(function(f){ var c = f.properties && f.properties._country; return c === 'CA'; }).length;
      var satCount = fires.filter(function(f){ var c = f.properties && f.properties._country; return c === 'SAT'; }).length;
      var rxCount = fires.filter(function(f){ var t = (f.properties.IncidentTypeCategory || f.properties.IncidentType || '').toString().toUpperCase(); return t.indexOf('RX') >= 0 || t.indexOf('PRESCRIBED') >= 0 || t.indexOf('USE') >= 0; }).length;
      var wfCount = usCount - rxCount;
      var largeCount = fires.filter(function(f){ return ((f.properties && f.properties.DailyAcres) || (f.properties && f.properties.GISAcres) || 0) >= 10000; }).length;
      var smokeIntel = window._smokeIntel || null;

      h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;margin-bottom:8px;">';
      h += '<div style="background:rgba(249,115,22,.08);border-radius:6px;padding:5px 6px;border-left:2px solid #f97316;"><div style="font-size:.35rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">WILDFIRE</div><div style="font-size:.6rem;font-weight:800;color:#fb923c;">'+wfCount+'</div></div>';
      h += '<div style="background:rgba(74,222,128,.08);border-radius:6px;padding:5px 6px;border-left:2px solid #4ade80;"><div style="font-size:.35rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">PRESCRIBED</div><div style="font-size:.6rem;font-weight:800;color:#4ade80;">'+rxCount+'</div></div>';
      var cwfisOffSeason = caCount === 0 && (new Date().getMonth() < 4 || new Date().getMonth() > 9);
      h += '<div style="background:rgba(239,68,68,.08);border-radius:6px;padding:5px 6px;border-left:2px solid #ef4444;"><div style="font-size:.35rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">CANADA</div><div style="font-size:.6rem;font-weight:800;color:#f87171;">'+caCount+'</div>'+(cwfisOffSeason ? '<div style="font-size:.3rem;color:rgba(255,255,255,.25);">CWFIS off-season</div>' : '')+'</div>';
      h += '<div style="background:rgba(251,146,60,.08);border-radius:6px;padding:5px 6px;border-left:2px solid #fb923c;"><div style="font-size:.35rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">UNCONFIRMED</div><div style="font-size:.6rem;font-weight:800;color:#fb923c;">'+satCount+'</div></div>';
      h += '</div>';

      //  SITUATIONAL AWARENESS SYNTHESIS 
      var fireThreat = 0; var fireNarr = [];
      var critFW = (wx.wind >= 25 && wx.rh < 15), elevFW = (wx.wind >= 20 && wx.rh < 25);
      if(critFW) fireThreat += 4;
      else if(elevFW) fireThreat += 2;
      if(wx.soilMoisture != null && wx.soilMoisture < 0.08) fireThreat += 2;
      else if(wx.soilMoisture != null && wx.soilMoisture < 0.15) fireThreat += 1;
      if(wx.dewpoint != null && wx.dewpoint < 20) fireThreat += 2;
      else if(wx.dewpoint != null && wx.dewpoint < 30) fireThreat += 1;
      if(wx.gustTrend3hr != null && wx.gustTrend3hr > 15) fireThreat += 2;
      else if(wx.gustTrend3hr != null && wx.gustTrend3hr > 8) fireThreat += 1;
      if(wx.windDirTrend3hr != null && Math.abs(wx.windDirTrend3hr) > 30) fireThreat += 1;
      if(wx.cape != null && wx.cape > 300 && wx.rh != null && wx.rh < 30) fireThreat += 2;
      if(wx.frontalSignature && wx.frontalSignature.indexOf('cold_front') >= 0) fireThreat += 1;
      if(wx.frontalSignature === 'dryline') fireThreat += 2;
      if(largeCount > 0) fireThreat += 2;
      if(fires.length > 5) fireThreat += 1;
      var fireAlertsCt = (window._hazardAlerts||[]).filter(function(a){ var e=(a.event||'').toLowerCase(); return e.indexOf('red flag')>=0||e.indexOf('fire')>=0; }).length;
      if(fireAlertsCt > 0) fireThreat += 3;
      if(wx.solarRad != null && wx.solarRad > 600 && wx.rh != null && wx.rh < 30) fireThreat += 1;
      if(wx.pblHeight != null && wx.pblHeight < 300 && fires.length > 0) fireThreat += 1;
      if(wx.precipProb != null && wx.precipProb > 60) fireThreat = Math.max(0, fireThreat - 2);
      // Score  level
      var ftLevel = fireThreat >= 12 ? 'EXTREME' : fireThreat >= 8 ? 'CRITICAL' : fireThreat >= 5 ? 'ELEVATED' : fireThreat >= 2 ? 'GUARDED' : 'LOW';
      var ftCol = fireThreat >= 12 ? '#dc2626' : fireThreat >= 8 ? '#ef4444' : fireThreat >= 5 ? '#f97316' : fireThreat >= 2 ? '#eab308' : '#4ade80';
      // Build narrative
      if(ftLevel === 'EXTREME' || ftLevel === 'CRITICAL'){
        var factors = [];
        if(critFW) factors.push('critical wind/humidity');
        if(wx.soilMoisture != null && wx.soilMoisture < 0.08) factors.push('bone-dry fuels');
        if(wx.dewpoint != null && wx.dewpoint < 20) factors.push('extremely dry airmass');
        if(fireAlertsCt > 0) factors.push(fireAlertsCt + ' NWS fire alert'+(fireAlertsCt>1?'s':''));
        if(largeCount > 0) factors.push(largeCount + ' large fire'+(largeCount>1?'s':''));
        if(wx.cape > 300 && wx.rh < 30) factors.push('dry lightning threat');
        if(wx.gustTrend3hr > 15) factors.push('rapidly increasing winds');
        fireNarr.push('Multiple compounding factors: ' + factors.join(', ') + '.');
        if(critFW && largeCount > 0) fireNarr.push('Active large fires under red-flag conditions  extreme spread rates and erratic fire behavior expected.');
        if(wx.gustTrend3hr > 15 && wx.windDirTrend3hr && Math.abs(wx.windDirTrend3hr) > 30) fireNarr.push('Wind speed increasing AND direction shifting  most dangerous condition for firefighters. Fire flanks become headfires on directional change.');
      } else if(ftLevel === 'ELEVATED'){
        if(elevFW) fireNarr.push('Fire weather parameters (wind '+Math.round(wx.wind||0)+' mph, RH '+Math.round(wx.rh||0)+'%) trending toward red flag thresholds.');
        if(fires.length > 0) fireNarr.push(fires.length + ' fire'+(fires.length>1?'s':'')+' actively burning. Monitor for growth under current conditions.');
      } else if(ftLevel === 'LOW'){
        fireNarr.push('No significant fire weather concerns. Humidity adequate and winds manageable.');
      }

      h += '<div style="margin-bottom:8px;padding:6px 8px;background:rgba(0,0,0,.3);border-radius:6px;border-left:3px solid '+ftCol+';">';
      h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">';
      h += '<span style="font-size:.52rem;font-weight:900;color:'+ftCol+';letter-spacing:.1em;">'+ftLevel+'</span>';
      h += '<span style="font-size:.40rem;color:rgba(255,255,255,.4);">FIRE THREAT LEVEL</span>';
      h += '<span style="font-size:.36rem;color:rgba(255,255,255,.25);margin-left:auto;">score '+fireThreat+'/20</span>';
      h += '</div>';
      if(fireNarr.length > 0) h += '<div style="font-size:.44rem;color:rgba(255,255,255,.8);line-height:1.4;">'+fireNarr.join(' ')+'</div>';
      h += '</div>';

      if(largeCount > 0) h += B(' LARGE', largeCount + ' fire'+(largeCount>1?'s':'')+' (10K+ acres) active  pyrocumulus risk', '#f97316');

      // Wind + RH + fire weather cross-reference
      h += SECT("FIRE WEATHER CONDITIONS");
      if(wx.wind != null && wx.rh != null){
        var criticalFW = wx.wind >= 25 && wx.rh < 15;
        var fireWeather = wx.wind >= 20 && wx.rh < 25;
        if(criticalFW) h += B(' CRITICAL FW', 'Wind ' + Math.round(wx.wind) + ' mph  RH ' + Math.round(wx.rh) + '%  red flag conditions', '#ef4444');
        else if(fireWeather) h += B(' ELEVATED FW', 'Wind ' + Math.round(wx.wind) + ' mph  RH ' + Math.round(wx.rh) + '%  approaching red flag', '#f97316');
      }

      // SOIL MOISTURE  fire fuel dryness
      if(wx.soilMoisture != null){
        if(wx.soilMoisture < 0.08) h += B(' FUEL MOISTURE', (wx.soilMoisture*100).toFixed(0) + '%  bone-dry, ignites easily', '#ef4444');
        else if(wx.soilMoisture < 0.15) h += B(' FUEL MOISTURE', (wx.soilMoisture*100).toFixed(0) + '%  dry fuels, increased receptivity', '#f97316');
      }

      // DEWPOINT  moisture recovery
      if(wx.dewpoint != null && wx.dewpoint < 25){
        h += B(' DEWPOINT', Math.round(wx.dewpoint) + 'F  extremely dry air, poor overnight RH recovery', 'rgba(120,160,255,.9)');
      }

      // PBL HEIGHT  smoke dispersion
      if(wx.pblHeight != null && fires.length > 0){
        if(wx.pblHeight < 300) h += '<div style="margin-bottom:2px;">'+W('Mixing height: ' + Math.round(wx.pblHeight) + 'm') + '  shallow boundary layer trapping smoke near the surface. Poor smoke dispersion.</div>';
        else if(wx.pblHeight > 2000) h += '<div style="margin-bottom:2px;">'+G('Mixing height: ' + Math.round(wx.pblHeight) + 'm') + '  deep mixing layer dispersing smoke aloft. Better surface air quality despite nearby fires.</div>';
      }

      // FRONTAL SIGNATURE  wind shift risk
      if(wx.frontalSignature){
        var fs = wx.frontalSignature;
        if(fs.indexOf('cold_front') >= 0) h += '<div style="margin-bottom:2px;">'+W(' Cold front ' + (fs.indexOf('approach')>=0?'approaching':'passage')) + '  expect sudden wind shift and gusty conditions. Fires can rapidly change direction and spread rate on frontal passage.</div>';
        else if(fs === 'dryline') h += '<div style="margin-bottom:2px;">'+W(' Dryline detected') + '  sharp moisture gradient. Dry side has extreme fire weather; convection along the dryline could produce dry lightning ignitions.</div>';
      }

      // CAPE  dry lightning risk
      if(wx.cape != null && wx.cape > 300 && wx.rh != null && wx.rh < 30){
        h += '<div style="margin-bottom:2px;">'+D(' Dry lightning risk') + '  CAPE ' + Math.round(wx.cape) + ' J/kg with RH ' + Math.round(wx.rh) + '%. Thunderstorms may produce lightning with little rain reaching the ground, igniting new fires.</div>';
      }

      // NWS ALERTS cross-reference  fire-related
      h += SECT("CROSS-HAZARD INTEL");
      var alerts = window._hazardAlerts || [];
      var fireAlerts = alerts.filter(function(a){ var e = (a.event || '').toLowerCase(); return e.indexOf('red flag') >= 0 || e.indexOf('fire') >= 0 || e.indexOf('wind') >= 0; });
      if(fireAlerts.length > 0){
        h += '<div style="margin-bottom:2px;">'+D(' ' + fireAlerts.length + ' active NWS alert'+(fireAlerts.length>1?'s':'')+' related to fire weather:') + '</div>';
        fireAlerts.slice(0,3).forEach(function(a){ h += '<div style="padding-left:8px;border-left:2px solid rgba(239,68,68,.3);margin-bottom:2px;font-size:.46rem;">' + a.event + '  ' + (a.areaDesc || '').substring(0,60) + '</div>'; });
      }

      // Smoke cross-reference
      if(smokeIntel && smokeIntel.smokeEvent){
        h += '<div style="margin-bottom:2px;">'+K('Smoke intelligence') + ': ' + (smokeIntel.severity || 'detected') + '  confidence ' + smokeIntel.smokeConfidence + '%' + (smokeIntel.probableSource ? ', probable source: ' + smokeIntel.probableSource : '') + '.</div>';
      }

      // AQI cross-reference  ENHANCED with individual pollutant analysis
      var aq = window._aqData || {};
      var aqCurrent = aq.current || {};
      var pm25 = aqCurrent.pm2_5;
      var pm10 = aqCurrent.pm10;
      var usAqi = aqCurrent.us_aqi;
      var o3 = aqCurrent.ozone;
      var no2 = aqCurrent.nitrogen_dioxide;
      var so2 = aqCurrent.sulphur_dioxide;
      var co = aqCurrent.carbon_monoxide;

      if(usAqi != null || pm25 != null){
        h += SECT('AIR QUALITY INTELLIGENCE');
        // Summary bar
        var aqiCol = usAqi > 300 ? '#7e1956' : usAqi > 200 ? '#8b1a1a' : usAqi > 150 ? '#dc2626' : usAqi > 100 ? '#f97316' : usAqi > 50 ? '#eab308' : '#4ade80';
        var aqiLabel = usAqi > 300 ? 'HAZARDOUS' : usAqi > 200 ? 'VERY UNHEALTHY' : usAqi > 150 ? 'UNHEALTHY' : usAqi > 100 ? 'USG' : usAqi > 50 ? 'MODERATE' : 'GOOD';
        h += '<div style="display:flex;align-items:center;gap:6px;padding:4px 6px;background:'+aqiCol+'15;border-left:2px solid '+aqiCol+';border-radius:4px;margin-bottom:4px;">';
        h += '<span style="font-size:.55rem;font-weight:900;color:'+aqiCol+';">'+(usAqi||'--')+'</span>';
        h += '<span style="font-size:.38rem;font-weight:700;color:'+aqiCol+';">US AQI  '+aqiLabel+'</span>';
        h += '</div>';

        // Individual pollutant grid
        var pollutants = [];
        if(pm25 != null) pollutants.push({name:'PM2.5',val:pm25,unit:'g/m',threshold:[12,35.4,55.4,150.4,250.4],note:'Fine particles penetrate deep into lungs'});
        if(pm10 != null) pollutants.push({name:'PM10',val:pm10,unit:'g/m',threshold:[54,154,254,354,424],note:'Coarse particles from dust and construction'});
        if(o3 != null) pollutants.push({name:'O',val:o3,unit:'g/m',threshold:[100,160,200,300,400],note:'Ground-level ozone, respiratory irritant'});
        if(no2 != null) pollutants.push({name:'NO',val:no2,unit:'g/m',threshold:[40,80,180,280,400],note:'Vehicle/industrial emissions'});
        if(so2 != null) pollutants.push({name:'SO',val:so2,unit:'g/m',threshold:[40,80,380,800,1600],note:'Coal/oil combustion byproduct'});
        if(co != null) pollutants.push({name:'CO',val:co,unit:'g/m',threshold:[4400,9400,12400,15400,30400],note:'Incomplete combustion product'});

        if(pollutants.length > 0){
          h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px;margin-bottom:4px;">';
          pollutants.forEach(function(p){
            var pCol = '#4ade80';
            for(var ti=p.threshold.length-1;ti>=0;ti--){
              if(p.val > p.threshold[ti]){ pCol = ['#eab308','#f97316','#dc2626','#8b1a1a','#7e1956'][ti]; break; }
            }
            h += '<div style="background:rgba(0,0,0,.2);border-radius:3px;padding:2px 4px;">';
            h += '<div style="font-size:.34rem;color:rgba(255,255,255,.4);">'+p.name+'</div>';
            h += '<div style="font-size:.44rem;font-weight:800;color:'+pCol+';">'+Math.round(p.val)+' <span style="font-size:.3rem;font-weight:400;">'+p.unit+'</span></div>';
            h += '</div>';
          });
          h += '</div>';
        }

        // Source attribution  connect AQI to fires
        if(pm25 != null && fires.length > 0){
          if(pm25 >= 55 && smokeIntel && smokeIntel.smokeEvent){
            h += '<div style="font-size:.42rem;color:rgba(255,255,255,.7);line-height:1.4;margin-bottom:2px;">';
            h += '<span style="color:#ef4444;font-weight:700;">HEALTH ALERT:</span> PM2.5 at '+Math.round(pm25)+' g/m with active smoke detected. ';
            h += 'Wildfire smoke contains fine particles, carbon monoxide, and volatile organic compounds (VOCs) including formaldehyde, acrolein, and benzene. ';
            h += 'Limit outdoor exposure. Use N95/P100 masks if outdoors. Run indoor air purifiers on high. Close windows and set HVAC to recirculate.';
            h += '</div>';
          } else if(pm25 >= 35){
            h += '<div style="font-size:.42rem;color:rgba(255,255,255,.6);line-height:1.4;">';
            h += '<span style="color:#f97316;font-weight:700;">USG:</span> PM2.5 elevated at '+Math.round(pm25)+' g/m. ';
            h += 'Sensitive groups (asthma, COPD, cardiovascular disease, elderly, children) should reduce prolonged outdoor exertion.';
            h += '</div>';
          }
        }

        // Ozone + heat compound risk
        if(o3 != null && o3 > 100 && wx.temp != null && wx.temp > 90){
          h += '<div style="font-size:.42rem;color:rgba(255,255,255,.6);">';
          h += '<span style="color:#f97316;font-weight:700;">OZONE + HEAT:</span> Ground-level ozone '+Math.round(o3)+' g/m during high heat ('+Math.round(wx.temp)+'F). ';
          h += 'UV-driven photochemical smog intensifies in afternoon heat. Peak risk 2-6 PM.';
          h += '</div>';
        }

        // Industrial source flag  NO2 or SO2 elevated without fire smoke
        if((no2 != null && no2 > 80) || (so2 != null && so2 > 80)){
          var indPollutant = no2 > 80 ? 'NO ('+Math.round(no2)+' g/m)' : 'SO ('+Math.round(so2)+' g/m)';
          if(!smokeIntel || !smokeIntel.smokeEvent){
            h += '<div style="font-size:.42rem;color:rgba(255,255,255,.6);">';
            h += '<span style="color:#eab308;font-weight:700;">INDUSTRIAL SOURCE:</span> Elevated '+indPollutant+' without smoke event suggests ';
            h += no2 > 80 ? 'traffic/vehicle emissions or industrial combustion as primary source.' : 'coal/oil combustion or industrial emissions as primary source.';
            h += '</div>';
          }
        }

        // 24h AQI trend from hourly data
        if(aq.hourly && aq.hourly.us_aqi && aq.hourly.us_aqi.length > 6){
          var hrs = aq.hourly.us_aqi;
          var recent = hrs.slice(-3).reduce(function(a,b){return a+(b||0);},0)/3;
          var earlier = hrs.slice(0,3).reduce(function(a,b){return a+(b||0);},0)/3;
          var trend = recent - earlier;
          if(Math.abs(trend) > 10){
            var tDir = trend > 0 ? 'WORSENING' : 'IMPROVING';
            var tCol = trend > 0 ? '#ef4444' : '#4ade80';
            h += '<div style="font-size:.40rem;color:rgba(255,255,255,.5);">Trend: <span style="color:'+tCol+';font-weight:700;">'+tDir+' ('+Math.round(Math.abs(trend))+' AQI pts over 24h)</span></div>';
          }
        }

        //  TRAFFIC  AIR QUALITY INTELLIGENCE 
        h += SECT(' TRAFFIC  AIR QUALITY');

        var now = new Date();
        var hour = now.getHours();
        var dayOfWeek = now.getDay(); // 0=Sun, 6=Sat
        var isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
        var dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

        // Rush hour detection
        var isMorningRush = isWeekday && hour >= 6 && hour <= 9;
        var isEveningRush = isWeekday && hour >= 16 && hour <= 19;
        var isRushHour = isMorningRush || isEveningRush;
        var isOvernight = hour >= 23 || hour <= 4;
        var isMidday = hour >= 11 && hour <= 14;

        // Traffic congestion estimation based on time patterns
        // Scale: 0-100 (0 = no traffic, 100 = maximum congestion)
        var trafficIndex;
        if(!isWeekday){
          // Weekend  reduced traffic, slight midday bump
          trafficIndex = isOvernight ? 5 : isMidday ? 35 : hour >= 10 && hour <= 17 ? 30 : 15;
        } else {
          // Weekday pattern
          if(isOvernight) trafficIndex = 5;
          else if(hour === 6) trafficIndex = 40;
          else if(hour === 7) trafficIndex = 75;
          else if(hour === 8) trafficIndex = 90;
          else if(hour === 9) trafficIndex = 70;
          else if(hour >= 10 && hour <= 15) trafficIndex = 35;
          else if(hour === 16) trafficIndex = 65;
          else if(hour === 17) trafficIndex = 95;
          else if(hour === 18) trafficIndex = 80;
          else if(hour === 19) trafficIndex = 55;
          else if(hour >= 20 && hour <= 22) trafficIndex = 25;
          else trafficIndex = 15;
        }

        // Traffic congestion bar
        var trafCol = trafficIndex >= 80 ? '#ef4444' : trafficIndex >= 60 ? '#f97316' : trafficIndex >= 40 ? '#eab308' : trafficIndex >= 20 ? '#4ade80' : '#22c55e';
        var trafLabel = trafficIndex >= 80 ? 'HEAVY' : trafficIndex >= 60 ? 'MODERATE-HEAVY' : trafficIndex >= 40 ? 'MODERATE' : trafficIndex >= 20 ? 'LIGHT' : 'MINIMAL';
        h += '<div style="display:flex;align-items:center;gap:6px;padding:3px 6px;background:'+trafCol+'10;border-left:2px solid '+trafCol+';border-radius:4px;margin-bottom:3px;">';
        h += '<span style="font-size:.48rem;font-weight:900;color:'+trafCol+';">'+trafficIndex+'</span>';
        h += '<div><div style="font-size:.36rem;font-weight:700;color:'+trafCol+';">'+trafLabel+' TRAFFIC</div>';
        h += '<div style="font-size:.32rem;color:rgba(255,255,255,.4);">'+dayNames[dayOfWeek]+' '+hour+':00 '+(isRushHour ? (isMorningRush ? ' AM RUSH' : ' PM RUSH') : isOvernight ? ' OVERNIGHT' : '')+'</div></div>';
        h += '</div>';

        // Traffic volume visualization (mini bar chart showing 24h pattern)
        if(aq.hourly && aq.hourly.us_aqi){
          var hrlyAqi = aq.hourly.us_aqi;
          var hrlyNO2 = aq.hourly && aq.hourly.nitrogen_dioxide ? aq.hourly.nitrogen_dioxide : null;
          var hrlyCO = aq.hourly && aq.hourly.carbon_monoxide ? aq.hourly.carbon_monoxide : null;

          // Traffic contribution estimate from hourly NO2/CO patterns
          if(hrlyNO2 && hrlyNO2.length > 12){
            // NO is the strongest traffic indicator
            // Calculate traffic-hour correlation: rush hour NO2 vs off-peak NO2
            var rushNO2 = [];
            var offNO2 = [];
            for(var hi=0; hi<hrlyNO2.length && hi<24; hi++){
              if(hrlyNO2[hi] == null) continue;
              var hh = hi; // hour index
              if((hh >= 7 && hh <= 9) || (hh >= 16 && hh <= 19)) rushNO2.push(hrlyNO2[hi]);
              else if(hh >= 1 && hh <= 5) offNO2.push(hrlyNO2[hi]);
            }
            var avgRushNO2 = rushNO2.length > 0 ? rushNO2.reduce(function(a,b){return a+b;},0)/rushNO2.length : 0;
            var avgOffNO2 = offNO2.length > 0 ? offNO2.reduce(function(a,b){return a+b;},0)/offNO2.length : 1;
            var rushRatio = avgOffNO2 > 0 ? (avgRushNO2 / avgOffNO2) : 1;

            // Traffic contribution percentage estimate
            // If rush-hour NO2 is 2x+ overnight, traffic is dominant source
            var trafficPct = Math.min(95, Math.max(5, Math.round((rushRatio - 1) / rushRatio * 100)));
            if(rushRatio < 1.1) trafficPct = Math.max(5, Math.min(20, trafficPct)); // low ratio = non-traffic source

            // Current hour traffic emission estimate
            var currentNO2 = no2 || 0;
            var trafficNO2 = currentNO2 * (trafficPct / 100);

            h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:3px;">';
            // Traffic contribution
            h += '<div style="background:rgba(0,0,0,.2);border-radius:3px;padding:3px 5px;">';
            h += '<div style="font-size:.32rem;color:rgba(255,255,255,.35);">TRAFFIC SHARE</div>';
            h += '<div style="font-size:.44rem;font-weight:800;color:'+trafCol+';">~'+trafficPct+'%</div>';
            h += '<div style="font-size:.30rem;color:rgba(255,255,255,.3);">of NO from vehicles</div>';
            h += '</div>';
            // Rush/off-peak ratio
            h += '<div style="background:rgba(0,0,0,.2);border-radius:3px;padding:3px 5px;">';
            h += '<div style="font-size:.32rem;color:rgba(255,255,255,.35);">RUSH vs OFF-PEAK</div>';
            h += '<div style="font-size:.44rem;font-weight:800;color:'+(rushRatio > 2 ? '#ef4444' : rushRatio > 1.5 ? '#f97316' : '#4ade80')+';">'+rushRatio.toFixed(1)+'</div>';
            h += '<div style="font-size:.30rem;color:rgba(255,255,255,.3);">NO rush/overnight ratio</div>';
            h += '</div>';
            h += '</div>';

            // Traffic emission breakdown
            if(currentNO2 > 20 && trafficPct > 30){
              h += '<div style="font-size:.40rem;color:rgba(255,255,255,.6);line-height:1.35;margin-bottom:2px;">';
              h += '<span style="color:'+trafCol+';font-weight:700;">TRAFFIC EMISSIONS:</span> ';
              h += 'NO ~'+Math.round(trafficNO2)+' g/m from vehicles';
              if(co != null && co > 2000) h += ', CO '+Math.round(co)+' g/m (exhaust)';
              h += '. ';

              // Contextual analysis
              if(isRushHour && rushRatio > 1.5){
                h += 'Active rush hour with clear traffic-driven pollution pattern. ';
                if(wx.wind != null && wx.wind < 5){
                  h += '<span style="color:#ef4444;font-weight:600;">Calm winds ('+Math.round(wx.wind)+' mph) trapping vehicle emissions at ground level.</span> ';
                  h += 'Poor atmospheric dispersion concentrating tailpipe pollutants near roadways.';
                } else if(wx.wind != null && wx.wind > 15){
                  h += 'Winds ('+Math.round(wx.wind)+' mph) providing good dispersion  readings would be higher without mixing.';
                }
              } else if(!isRushHour && currentNO2 > 40){
                h += 'Elevated NO outside rush hour suggests ';
                if(isWeekday) h += 'ongoing commercial vehicle activity, construction, or nearby industrial combustion.';
                else h += 'weekend event traffic, commercial/delivery operations, or industrial sources.';
              }
              h += '</div>';
            }
          }

          // Atmospheric trapping conditions
          var trapped = false;
          if(wx.wind != null && wx.wind < 5 && wx.tempTrend3hr != null && wx.tempTrend3hr > 0 && usAqi > 50){
            trapped = true;
            h += '<div style="font-size:.40rem;color:rgba(255,255,255,.6);line-height:1.35;margin-bottom:2px;">';
            h += '<span style="color:#f97316;font-weight:700;"> TEMPERATURE INVERSION:</span> ';
            h += 'Warming trend (+'+Math.round(wx.tempTrend3hr)+'F/3hr) with calm winds ('+Math.round(wx.wind)+' mph) ';
            h += 'indicates a temperature inversion or stable boundary layer. Pollutants from traffic, industry, and fires accumulate near the surface rather than dispersing vertically. ';
            h += 'Air quality typically worsens until winds increase or the inversion breaks (usually by afternoon solar heating).';
            h += '</div>';
          }

          // Canyon effect for urban areas
          if(currentNO2 > 30 && wx.wind != null && wx.wind < 8 && isRushHour){
            h += '<div style="font-size:.38rem;color:rgba(255,255,255,.5);line-height:1.3;">';
            h += '<span style="color:rgba(255,255,255,.6);font-weight:600;">Street canyon effect:</span> ';
            h += 'Light winds during rush hour allow vehicle emissions to accumulate in urban street canyons  pollution at street level may be 2-5 higher than rooftop monitoring stations report. ';
            h += 'Pedestrians, cyclists, and outdoor workers face highest exposure.';
            h += '</div>';
          }

          // Diesel vs gasoline signature
          if(no2 != null && pm25 != null && no2 > 25){
            var no2pm25ratio = no2 / Math.max(pm25, 1);
            if(no2pm25ratio > 3){
              h += '<div style="font-size:.38rem;color:rgba(255,255,255,.45);line-height:1.3;">';
              h += '<span style="color:rgba(255,255,255,.55);font-weight:600;">Diesel signature:</span> ';
              h += 'High NO:PM2.5 ratio ('+no2pm25ratio.toFixed(1)+':1) indicates diesel vehicle dominance  truck routes, bus corridors, construction equipment, or port/freight operations.';
              h += '</div>';
            } else if(no2pm25ratio < 1 && pm25 > 25 && (!smokeIntel || !smokeIntel.smokeEvent)){
              h += '<div style="font-size:.38rem;color:rgba(255,255,255,.45);line-height:1.3;">';
              h += '<span style="color:rgba(255,255,255,.55);font-weight:600;">Mixed source:</span> ';
              h += 'Low NO:PM2.5 ratio ('+no2pm25ratio.toFixed(1)+':1) with elevated PM2.5 suggests non-traffic particulate sources  road dust resuspension, nearby construction, agricultural burning, or industrial emissions mixed with vehicle exhaust.';
              h += '</div>';
            }
          }

          // Next rush hour forecast
          if(!isRushHour && isWeekday){
            var nextRush = hour < 7 ? '7-9 AM' : hour < 16 ? '4-7 PM' : 'tomorrow 7-9 AM';
            var rushWind = null;
            if(aq.hourly && aq.hourly.us_aqi){
              // Check if wind forecast suggests trapping during next rush
              var wxH = window._wxHourly;
              if(wxH && wxH.windspeed_10m){
                var nextRushHr = hour < 7 ? 8 : hour < 16 ? 17 : 8;
                if(nextRushHr < wxH.windspeed_10m.length) rushWind = wxH.windspeed_10m[nextRushHr];
              }
            }
            h += '<div style="font-size:.38rem;color:rgba(255,255,255,.4);">';
            h += 'Next rush: <span style="font-weight:600;">'+nextRush+'</span>';
            if(rushWind != null && rushWind < 5) h += '  <span style="color:#f97316;">calm winds forecast, poor dispersion expected</span>';
            else if(rushWind != null && rushWind > 15) h += '  <span style="color:#4ade80;">winds '+Math.round(rushWind)+' mph, good dispersion</span>';
            h += '</div>';
          } else if(!isWeekday){
            h += '<div style="font-size:.38rem;color:rgba(255,255,255,.4);">Weekend  reduced commuter traffic. Industrial and freight operations may continue.</div>';
          }
        }
      }

      // FLOOD cross-reference  post-fire debris flow
      if(largeCount > 0 && wx.precipProb != null && wx.precipProb > 40){
        h += '<div style="margin-top:4px;">'+W(' Post-fire flood risk') + ': ' + largeCount + ' large burn scar'+(largeCount>1?'s':'')+' + ' + wx.precipProb + '% precip chance. Burned terrain loses absorption capacity  even light rain can trigger debris flows and flash floods in recent burn areas.</div>';
      }

      // GUST TREND  worsening fire weather
      if(wx.gustTrend3hr != null && wx.gustTrend3hr > 10){
        h += '<div style="margin-bottom:2px;">'+W(' Gusts increasing +' + Math.round(wx.gustTrend3hr) + ' mph/3hr') + (wx.next6hrMaxGust ? '  expected peak: ' + Math.round(wx.next6hrMaxGust) + ' mph in next 6hr. ' : '. ') + 'Rising winds accelerate fire spread exponentially.</div>';
      }

      // WIND DIRECTION SHIFT  fire direction change
      if(wx.windDirTrend3hr != null && Math.abs(wx.windDirTrend3hr) > 30){
        h += '<div style="margin-bottom:2px;">'+W(' Wind shifting ' + Math.abs(Math.round(wx.windDirTrend3hr)) + '/3hr') + '  ' + (wx.windDirTrend3hr > 0 ? 'veering clockwise' : 'backing counter-clockwise') + '. Fire flanks become new headfires on wind shifts. Extremely dangerous for firefighters.</div>';
      }

      // VISIBILITY  smoke/haze impact on operations
      if(wx.visibility != null && fires.length > 0){
        var visMi = (wx.visibility * 0.000621371).toFixed(1);
        if(visMi < 3) h += '<div style="margin-bottom:2px;">'+D('Visibility: ' + visMi + ' mi') + '  severely degraded. Smoke or haze reducing visibility below safe thresholds. Aviation firefighting operations may be grounded.</div>';
        else if(visMi < 6) h += '<div style="margin-bottom:2px;">'+W('Visibility: ' + visMi + ' mi') + '  reduced. Smoke haze affecting air clarity and operations.</div>';
      }

      // SOLAR RADIATION  fire behavior intensification
      if(wx.solarRad != null && wx.solarRad > 600 && wx.rh != null && wx.rh < 30){
        h += '<div style="margin-bottom:2px;">'+W(' Solar flux: ' + Math.round(wx.solarRad) + ' W/m') + '  intense heating drying fuels and creating unstable surface layer. Peak fire behavior window 1-5 PM.</div>';
      }

      // UPSTREAM  what's coming from upwind
      var st = window._stormTrack || {};
      if(st.upstream && st.upstream.length > 0){
        var upRain = st.upstream.filter(function(u){ return u.isRaining; });
        var upDry = st.upstream.filter(function(u){ return u.rh != null && u.rh < 15; });
        if(upRain.length > 0){
          h += '<div style="margin-bottom:2px;">'+G(' Rain detected ' + upRain[0].dist + ' mi upwind') + '  may provide relief but dry lightning risk at storm leading edge.</div>';
        } else if(upDry.length > 0){
          h += '<div style="margin-bottom:2px;">'+D(' Very dry air (RH ' + upDry[0].rh + '%) approaching from ' + upDry[0].dist + ' mi upwind') + '  fire conditions may worsen.</div>';
        }
      }

      // EPA CONTAMINATION  FIRE cross-reference
      if(window._epaData && fires.length > 0){
        var sfSites = window._epaData.superfund || [];
        var triSites = window._epaData.tri || [];
        var contamFireRisks = [];

        fires.forEach(function(f){
          var fLat = f.geometry ? f.geometry.coordinates[1] : (f.latitude || f.lat);
          var fLon = f.geometry ? f.geometry.coordinates[0] : (f.longitude || f.lon);
          if(!fLat || !fLon) return;
          var fName = (f.properties && (f.properties.IncidentName || f.properties.FireDiscoveryDateTime || '')) || 'Fire';
          var fAcres = (f.properties && (f.properties.DailyAcres || f.properties.GISAcres)) || 0;

          sfSites.forEach(function(sf){
            var dist = Math.sqrt(Math.pow((sf.lat-fLat)*69,2)+Math.pow((sf.lon-fLon)*69*Math.cos(fLat*Math.PI/180),2));
            if(dist < 15){
              contamFireRisks.push({fire:fName,site:sf.name,type:'SUPERFUND',dist:dist.toFixed(1),acres:fAcres,severity:dist<2?'CRITICAL':dist<5?'HIGH':'MODERATE'});
            }
          });
          triSites.forEach(function(tr){
            var dist = Math.sqrt(Math.pow((tr.lat-fLat)*69,2)+Math.pow((tr.lon-fLon)*69*Math.cos(fLat*Math.PI/180),2));
            if(dist < 10){
              contamFireRisks.push({fire:fName,site:tr.name,type:'TRI',dist:dist.toFixed(1),acres:fAcres,severity:dist<1?'CRITICAL':dist<3?'HIGH':'MODERATE'});
            }
          });
        });

        if(contamFireRisks.length > 0){
          h += SECT(' CONTAMINATION  FIRE RISK');
          var crits = contamFireRisks.filter(function(r){ return r.severity === 'CRITICAL'; });
          var highs = contamFireRisks.filter(function(r){ return r.severity === 'HIGH'; });

          if(crits.length > 0){
            h += '<div style="margin-bottom:4px;">'+D(' '+crits.length+' CRITICAL toxic exposure risk'+(crits.length>1?'s':''))+':</div>';
            crits.slice(0,3).forEach(function(r){
              h += '<div style="padding:3px 6px;background:rgba(239,68,68,.08);border-left:2px solid rgba(239,68,68,.5);border-radius:0 4px 4px 0;margin-bottom:2px;font-size:.40rem;">';
              h += '<span style="color:#ef4444;font-weight:700;">'+r.type+'</span> <span style="color:#fff;font-weight:600;">'+r.site+'</span>';
              h += '<br><span style="color:rgba(255,255,255,.5);">'+r.dist+' mi from '+r.fire+(r.acres?' ('+r.acres.toLocaleString()+' ac)':'')+'</span>';
              h += '</div>';
            });
            h += '<div style="font-size:.38rem;color:rgba(255,255,255,.5);line-height:1.4;margin-bottom:2px;">Wildfire burning through or near contaminated sites can volatilize heavy metals, PCBs, dioxins, and other hazardous chemicals into smoke. Toxic plume may carry far beyond normal smoke advisory zones. Evacuate immediately if downwind.</div>';
          }
          if(highs.length > 0){
            h += '<div style="margin-bottom:2px;">'+W(highs.length+' contamination site'+(highs.length>1?'s':'')+' near active fires:')+'</div>';
            highs.slice(0,3).forEach(function(r){
              h += '<div style="padding-left:8px;border-left:2px solid rgba(249,115,22,.3);margin-bottom:2px;font-size:.40rem;">';
              h += '<span style="color:#f97316;font-weight:600;">'+r.type+'</span> '+r.site+'  '+r.dist+' mi from '+r.fire;
              h += '</div>';
            });
          }
          h += '<div style="font-size:.36rem;color:rgba(255,255,255,.35);">Toggle  EPA to see all contamination sites on map.</div>';
        }
      }

      // 3-DAY FIRE WEATHER PROJECTION from daily forecast
      h += SECT("3-DAY FIRE WEATHER PROJECTION");
      var daily = window._wxDaily;
      if(daily && daily.time && daily.windgusts_10m_max){

        h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">';
        for(var di=0; di<3 && di<daily.time.length; di++){
          var dGust = daily.windgusts_10m_max[di] || 0;
          var dPrecip = daily.precipitation_sum ? (daily.precipitation_sum[di] || 0) : 0;
          var dMaxT = daily.temperature_2m_max ? daily.temperature_2m_max[di] : null;
          var dayLabel = di===0?'Today':di===1?'Tomorrow':'Day 3';
          var fwRisk = (dGust >= 30 && dPrecip < 0.1) ? 'HIGH' : (dGust >= 20 && dPrecip < 0.2) ? 'ELEV' : dPrecip > 0.25 ? 'LOW' : 'MOD';
          var fwCol = fwRisk === 'HIGH' ? '#ef4444' : fwRisk === 'ELEV' ? '#f97316' : fwRisk === 'LOW' ? '#4ade80' : '#eab308';
          h += '<div style="background:rgba(255,255,255,.03);border-radius:4px;padding:3px 5px;border-top:2px solid '+fwCol+';font-size:.40rem;">';
          h += '<div style="font-weight:700;color:rgba(255,255,255,.5);">'+dayLabel+'</div>';
          h += '<div>Gusts: <b>'+Math.round(dGust)+'</b> mph</div>';
          if(dMaxT) h += '<div>High: <b>'+Math.round(dMaxT)+'</b>F</div>';
          h += '<div>Rain: <b>'+dPrecip.toFixed(2)+'</b>"</div>';
          h += '<div style="color:'+fwCol+';font-weight:700;">'+fwRisk+' RISK</div>';
          h += '</div>';
        }
        h += '</div>';
      }

      //  TOP FIRES  LARGEST ACTIVE 
      if(fires.length > 0){
        var sortedBySize = fires.slice().sort(function(a,b){
          return ((b.properties.DailyAcres||b.properties.GISAcres||0) - (a.properties.DailyAcres||a.properties.GISAcres||0));
        }).filter(function(f){ return f.properties._country !== 'SAT' && ((f.properties.DailyAcres||f.properties.GISAcres||0) > 0); }).slice(0,8);

        if(sortedBySize.length > 0){
          h += SECT('LARGEST ACTIVE FIRES');
          h += '<div style="display:flex;flex-direction:column;gap:1px;">';
          sortedBySize.forEach(function(f,i){
            var p = f.properties || {};
            var name = p.IncidentName || p._name || 'Unknown';
            var acres = p.DailyAcres || p.GISAcres || 0;
            var pct = p.PercentContained || 0;
            var country = p._country || 'US';
            var state = p.POOState || p.State || '';
            var stateCode = state ? state.substring(0,2).toUpperCase() : getStateFromCoords(lat,lon); var loc = country === 'CA' ? 'CA' : (stateCode || 'US');
            var acresStr = acres >= 1000 ? (acres/1000).toFixed(1)+'K' : Math.round(acres).toLocaleString();
            var acreCol = acres >= 50000 ? '#7f1d1d' : acres >= 10000 ? '#dc2626' : acres >= 1000 ? '#f97316' : '#fbbf24';
            var pctCol = pct >= 80 ? '#4ade80' : pct >= 40 ? '#eab308' : pct > 0 ? '#f97316' : 'rgba(255,255,255,.2)';
            var coords = f.geometry && f.geometry.coordinates;
            var lat = coords ? coords[1] : 0, lon = coords ? coords[0] : 0;

            h += '<div onclick="if(hazardMap)hazardMap.flyTo(['+lat+','+lon+'],9)" style="display:flex;align-items:center;gap:4px;padding:3px 4px;cursor:pointer;border-radius:4px;font-size:.42rem;" class="fire-item">';
            h += '<span style="color:rgba(255,255,255,.2);font-size:.36rem;width:10px;">'+(i+1)+'</span>';
            h += '<span style="color:'+acreCol+';font-weight:800;min-width:32px;text-align:right;">'+acresStr+'</span>';
            h += '<span style="color:rgba(255,255,255,.85);font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+name+'</span>';
            h += '<span style="color:rgba(255,255,255,.3);font-size:.36rem;">'+loc+'</span>';
            if(pct > 0) h += '<span style="color:'+pctCol+';font-weight:700;font-size:.38rem;">'+pct+'%</span>';
            h += '</div>';
          });
          h += '</div>';
        }

        //  MOST RECENT FIRES (by discovery date) 
        var sortedByRecent = fires.slice().filter(function(f){
          return f.properties._country !== 'SAT' && (f.properties.FireDiscoveryDateTime || f.properties.CreateDate);
        }).sort(function(a,b){
          var aD = new Date(a.properties.FireDiscoveryDateTime || a.properties.CreateDate || 0);
          var bD = new Date(b.properties.FireDiscoveryDateTime || b.properties.CreateDate || 0);
          return bD - aD;
        }).slice(0,5);

        if(sortedByRecent.length > 0){
          h += SECT('MOST RECENT');
          h += '<div style="display:flex;flex-direction:column;gap:1px;">';
          sortedByRecent.forEach(function(f){
            var p = f.properties || {};
            var name = p.IncidentName || p._name || 'Unknown';
            var acres = p.DailyAcres || p.GISAcres || 0;
            var acresStr = acres >= 1000 ? (acres/1000).toFixed(1)+'K' : acres > 0 ? Math.round(acres).toLocaleString() : '';
            var acreCol = acres >= 10000 ? '#dc2626' : acres >= 1000 ? '#f97316' : '#fbbf24';
            var disc = p.FireDiscoveryDateTime || p.CreateDate;
            var ago = '';
            if(disc){
              var mins = Math.floor((Date.now() - new Date(disc).getTime()) / 60000);
              if(mins < 60) ago = mins + 'm ago';
              else if(mins < 1440) ago = Math.floor(mins/60) + 'h ago';
              else ago = Math.floor(mins/1440) + 'd ago';
            }
            var coords = f.geometry && f.geometry.coordinates;
            var lat = coords ? coords[1] : 0, lon = coords ? coords[0] : 0;
            var country = p._country || 'US';
            var state = p.POOState || p.State || '';
            var stateCode = state ? state.substring(0,2).toUpperCase() : getStateFromCoords(lat,lon); var loc = country === 'CA' ? 'CA' : (stateCode || 'US');

            h += '<div onclick="if(hazardMap)hazardMap.flyTo(['+lat+','+lon+'],9)" style="display:flex;align-items:center;gap:4px;padding:3px 4px;cursor:pointer;border-radius:4px;font-size:.42rem;" class="fire-item">';
            h += '<span style="color:'+acreCol+';font-weight:800;min-width:32px;text-align:right;">'+acresStr+'</span>';
            h += '<span style="color:rgba(255,255,255,.85);font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+name+'</span>';
            h += '<span style="color:rgba(255,255,255,.3);font-size:.36rem;">'+loc+'</span>';
            h += '<span style="color:rgba(255,255,255,.3);font-size:.36rem;">'+ago+'</span>';
            h += '</div>';
          });
          h += '</div>';
        }
      }

      if(fires.length === 0) h += G(' No active fires detected') + ' in NIFC/CWFIS/FIRMS sources.';

    } else if(tab === 'tornado'){
      var tReports = window._tornadoReports || [];
      var tCount = window._tornadoCount || tReports.length;

      h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px;">';
      h += '<div style="background:rgba(168,85,247,.08);border-radius:6px;padding:5px 7px;border-left:2px solid #a855f7;"><div style="font-size:.38rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">TORNADO REPORTS</div><div style="font-size:.65rem;font-weight:800;color:#c084fc;">'+tCount+'</div></div>';
      var severeM = (typeof tornadoSevereMarkers !== 'undefined') ? tornadoSevereMarkers.length : 0;
      h += '<div style="background:rgba(6,182,212,.08);border-radius:6px;padding:5px 7px;border-left:2px solid #06b6d4;"><div style="font-size:.38rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">HAIL + WIND</div><div style="font-size:.65rem;font-weight:800;color:#22d3ee;">'+severeM+'</div></div>';
      h += '</div>';

      //  SITUATIONAL AWARENESS SYNTHESIS 
      var sevThreat = 0;
      if(wx.cape >= 3500) sevThreat += 4; else if(wx.cape >= 2000) sevThreat += 3; else if(wx.cape >= 1000) sevThreat += 2; else if(wx.cape >= 500) sevThreat += 1;
      if(wx.liftedIndex != null && wx.liftedIndex <= -6) sevThreat += 3; else if(wx.liftedIndex != null && wx.liftedIndex <= -2) sevThreat += 1;
      if(wx.gust >= 40) sevThreat += 3; else if(wx.gust >= 30) sevThreat += 2; else if(wx.gust >= 20) sevThreat += 1;
      if(wx.dewpoint >= 65) sevThreat += 2; else if(wx.dewpoint >= 55) sevThreat += 1;
      if(wx.pressureTrend != null && wx.pressureTrend <= -3) sevThreat += 2; else if(wx.pressureTrend != null && wx.pressureTrend <= -1.5) sevThreat += 1;
      if(wx.frontalSignature && (wx.frontalSignature.indexOf('cold_front_approach') >= 0 || wx.frontalSignature === 'dryline')) sevThreat += 2;
      if(wx.capeTrend3hr != null && wx.capeTrend3hr > 500) sevThreat += 2; else if(wx.capeTrend3hr != null && wx.capeTrend3hr > 200) sevThreat += 1;
      if(wx.capeTrend3hr != null && wx.capeTrend3hr < -300) sevThreat = Math.max(0, sevThreat - 2);
      if(wx.solarRad != null && wx.solarRad > 500 && wx.cape > 500) sevThreat += 1;
      var sevAlertsCt = (window._hazardAlerts||[]).filter(function(a){ var e=(a.event||'').toLowerCase(); return e.indexOf('tornado')>=0||e.indexOf('severe thunderstorm')>=0; }).length;
      if(sevAlertsCt > 0) sevThreat += 3;
      if(tCount > 0) sevThreat += 3;
      if(severeM > 3) sevThreat += 2; else if(severeM > 0) sevThreat += 1;
      var stormUpstream = (window._stormTrack && window._stormTrack.upstream) ? window._stormTrack.upstream.filter(function(u){ return u.isStormy; }).length : 0;
      if(stormUpstream > 0) sevThreat += 2;

      var stLevel = sevThreat >= 14 ? 'PARTICULARLY DANGEROUS' : sevThreat >= 10 ? 'HIGH' : sevThreat >= 6 ? 'ENHANCED' : sevThreat >= 3 ? 'SLIGHT' : 'MARGINAL';
      var stCol = sevThreat >= 14 ? '#dc2626' : sevThreat >= 10 ? '#ef4444' : sevThreat >= 6 ? '#f97316' : sevThreat >= 3 ? '#eab308' : '#4ade80';
      var sevNarr = [];

      if(stLevel === 'PARTICULARLY DANGEROUS' || stLevel === 'HIGH'){
        // Determine storm mode
        var hasShear = wx.gust >= 30;
        var hasMoisture = wx.dewpoint >= 60;
        var hasCAPE = wx.cape >= 2000;
        var hasTrigger = wx.frontalSignature && (wx.frontalSignature.indexOf('cold_front') >= 0 || wx.frontalSignature === 'dryline');
        if(hasCAPE && hasShear && hasMoisture) sevNarr.push('All three ingredients present for supercells: instability (CAPE '+Math.round(wx.cape)+'), shear (gusts '+Math.round(wx.gust)+' mph), and deep moisture (Td '+Math.round(wx.dewpoint)+'F). Discrete supercells with tornado potential.');
        else if(hasCAPE && hasShear) sevNarr.push('Strong instability + wind shear. Organized severe storms expected. Primary threats: large hail and damaging winds.');
        else if(hasCAPE && hasMoisture) sevNarr.push('Extreme instability with rich moisture but limited shear. Pulse-type severe storms with heavy rain and isolated damaging microbursts.');
        if(hasTrigger) sevNarr.push('Active forcing mechanism ('+(wx.frontalSignature==='dryline'?'dryline':'cold front')+') provides the trigger for storm initiation.');
        if(wx.pressureTrend <= -3) sevNarr.push('Explosive cyclogenesis ('+wx.pressureTrend.toFixed(1)+' hPa/3hr) enhancing low-level jet  tornado risk elevated when surface low is nearby.');
        if(tCount > 0) sevNarr.push(tCount + ' tornado report'+(tCount>1?'s':'')+' already confirmed today  ongoing tornado event.');
        if(stormUpstream > 0) sevNarr.push('Thunderstorms already firing upstream and heading this direction.');
      } else if(stLevel === 'ENHANCED'){
        if(wx.cape >= 1000) sevNarr.push('Moderate instability ('+Math.round(wx.cape)+' J/kg) supports strong thunderstorms.');
        if(wx.capeTrend3hr > 200) sevNarr.push('CAPE still building  peak instability window ahead.');
        if(!hasShear && wx.cape >= 1000) sevNarr.push('Limited shear keeps supercell risk low, but pulse storms capable of hail and downbursts.');
      } else if(sevThreat <= 2){
        if(wx.cape < 200 && (wx.liftedIndex == null || wx.liftedIndex > 0)) sevNarr.push('Stable atmosphere with minimal instability. No severe weather expected.');
        else if(wx.cape < 500) sevNarr.push('Weak instability insufficient for organized severe weather.');
      }

      h += '<div style="margin-bottom:8px;padding:6px 8px;background:rgba(0,0,0,.3);border-radius:6px;border-left:3px solid '+stCol+';">';
      h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">';
      h += '<span style="font-size:.52rem;font-weight:900;color:'+stCol+';letter-spacing:.1em;">'+stLevel+'</span>';
      h += '<span style="font-size:.40rem;color:rgba(255,255,255,.4);">SEVERE THREAT</span>';
      h += '<span style="font-size:.36rem;color:rgba(255,255,255,.25);margin-left:auto;">score '+sevThreat+'/24</span>';
      h += '</div>';
      if(sevNarr.length > 0) h += '<div style="font-size:.44rem;color:rgba(255,255,255,.8);line-height:1.4;">'+sevNarr.join(' ')+'</div>';
      h += '</div>';

      // CAPE + Lifted Index  dual instability assessment
      h += SECT("ATMOSPHERIC CONDITIONS");
      if(wx.cape != null && wx.cape > 0){
        var capeLevel = wx.cape >= 3500 ? 'EXTREME' : wx.cape >= 2000 ? 'HIGH' : wx.cape >= 1000 ? 'MODERATE' : 'MARGINAL';
        var capeColor = wx.cape >= 3500 ? D : wx.cape >= 2000 ? W : wx.cape >= 1000 ? K : G;
        h += '<div style="margin-bottom:2px;">'+K('Instability') + ': CAPE ' + Math.round(wx.cape) + ' J/kg  ' + capeColor(capeLevel);
        if(wx.liftedIndex != null) h += '  LI ' + wx.liftedIndex.toFixed(1) + (wx.liftedIndex <= -6 ? ' ('+D('very unstable')+')' : wx.liftedIndex <= -2 ? ' (unstable)' : '');
        h += '. ' + (wx.cape >= 2000 ? 'Supercell/tornado environment possible with sufficient shear.' : 'Thunderstorms possible but not likely severe without shear.') + '</div>';
      }

      // Wind shear + gust analysis
      if(wx.gust != null && wx.gust >= 30){
        h += '<div style="margin-bottom:2px;">'+K('Wind shear proxy') + ': Surface gusts ' + Math.round(wx.gust) + ' mph suggest significant low-level shear. Combined with instability, this supports rotating updrafts.</div>';
      }

      // DEWPOINT  moisture / storm fuel
      if(wx.dewpoint != null){
        if(wx.dewpoint >= 65) h += '<div style="margin-bottom:2px;">'+W('Dewpoint: ' + Math.round(wx.dewpoint) + 'F') + '  rich Gulf moisture feeding convection. Dewpoints in the upper 60s+ fuel explosive storm development.</div>';
        h += B(' DEWPOINT', Math.round(wx.dewpoint) + 'F  extremely dry air, poor overnight RH recovery', 'rgba(120,160,255,.9)');
      }

      // FRONTAL SIGNATURE  storm trigger
      if(wx.frontalSignature){
        var fs = wx.frontalSignature;
        if(fs.indexOf('cold_front_approach') >= 0) h += '<div style="margin-bottom:2px;">'+W(' Cold front approaching') + '  classic severe weather trigger. Convection often fires along and ahead of the front. Maximum severe risk in the warm sector ahead of the boundary.</div>';
        else if(fs === 'dryline') h += '<div style="margin-bottom:2px;">'+W(' Dryline detected') + '  sharp moisture gradient. Supercells frequently initiate along drylines in the afternoon. Watch for storms that form and rapidly intensify.</div>';
        else if(fs.indexOf('warm_front') >= 0) h += '<div style="margin-bottom:2px;">'+K('Warm front ' + (fs.indexOf('approach')>=0?'approaching':'passage')) + '  warm frontal zones produce elevated convection and can support strong tornadoes in a warm-front-parallel orientation.</div>';
      }

      // PRESSURE TREND  system dynamics
      if(wx.pressureTrend != null){
        if(wx.pressureTrend <= -3) h += '<div style="margin-bottom:2px;">'+D('Pressure crashing: ' + wx.pressureTrend.toFixed(1) + ' hPa/3hr') + '  deep cyclogenesis. Rapid pressure falls enhance low-level jet and storm-relative helicity. Elevated tornado risk.</div>';
        else if(wx.pressureTrend <= -1.5) h += '<div style="margin-bottom:2px;">'+W('Pressure falling: ' + wx.pressureTrend.toFixed(1) + ' hPa/3hr') + '  approaching weather system strengthening lift and shear.</div>';
      }

      // FREEZING LEVEL  hail size potential
      if(wx.freezingLevel != null && wx.cape != null && wx.cape > 500){
        var fzFt = Math.round(wx.freezingLevel * 3.28084);
        if(fzFt < 10000) h += '<div style="margin-bottom:2px;">'+K('Freezing level: ' + fzFt.toLocaleString() + ' ft') + '  low freezing level means hail has less distance to melt before reaching the surface. Large hail more likely to reach ground intact.</div>';
      }

      // NWS ALERTS cross-reference  severe-related
      h += SECT("CROSS-HAZARD INTEL");
      var alerts = window._hazardAlerts || [];
      var sevAlerts = alerts.filter(function(a){ var e = (a.event || '').toLowerCase(); return e.indexOf('tornado') >= 0 || e.indexOf('severe thunderstorm') >= 0 || e.indexOf('flash flood') >= 0; });
      if(sevAlerts.length > 0){
        h += '<div style="margin-bottom:2px;">'+D(' ' + sevAlerts.length + ' active severe alert'+(sevAlerts.length>1?'s':'')+':') + '</div>';
        sevAlerts.slice(0,3).forEach(function(a){ h += '<div style="padding-left:8px;border-left:2px solid rgba(168,85,247,.3);margin-bottom:2px;font-size:.46rem;">' + a.event + '  ' + (a.areaDesc || '').substring(0,60) + '</div>'; });
      }

      // FIRE cross-reference  dry lightning from severe storms
      var activeFires = window._activeFires || [];
      if(activeFires.length > 0 && wx.rh != null && wx.rh < 30 && wx.cape > 300){
        h += '<div style="margin-bottom:2px;">'+W(' Dry lightning risk') + ': ' + activeFires.length + ' active fires + low RH (' + Math.round(wx.rh) + '%) + convective instability. Thunderstorms may ignite new fires.</div>';
      }

      // FLOOD cross-reference  severe rain
      if(wx.precipTotal != null && wx.precipTotal > 1.0){
        h += '<div style="margin-bottom:2px;">'+W(' Flood risk from severe') + ': ' + wx.precipTotal.toFixed(2) + '" precip. Severe storms produce extreme rain rates (2-4"/hr) that overwhelm drainage. Flash flooding often accompanies severe outbreaks.</div>';
      }

      // SPACE WEATHER cross-reference  radio propagation
      if(sw.xrayClass && (sw.xrayClass.charAt(0) === 'M' || sw.xrayClass.charAt(0) === 'X')){
        h += '<div style="margin-bottom:2px;">'+K(' Solar flare: ' + sw.xrayClass) + '  HF radio blackout possible. Storm spotters and emergency comms on HF frequencies may be degraded during active severe weather.</div>';
      }

      // CAPE TREND  instability trajectory
      if(wx.capeTrend3hr != null && Math.abs(wx.capeTrend3hr) > 200){
        if(wx.capeTrend3hr > 500) h += '<div style="margin-bottom:2px;">'+D(' CAPE rapidly building +' + Math.round(wx.capeTrend3hr) + ' J/kg per 3hr') + '  instability increasing fast. Peak severe window ahead. Storms that form in the next few hours will be significantly stronger.</div>';
        else if(wx.capeTrend3hr > 200) h += '<div style="margin-bottom:2px;">'+W(' CAPE increasing +' + Math.round(wx.capeTrend3hr) + '/3hr') + '  instability building. Monitor for storm initiation.</div>';
        else if(wx.capeTrend3hr < -300) h += '<div style="margin-bottom:2px;">'+G(' CAPE declining ' + Math.round(wx.capeTrend3hr) + '/3hr') + '  instability waning. Severe window may be closing.</div>';
      }

      // SOLAR RADIATION  surface destabilization
      if(wx.solarRad != null && wx.solarRad > 500 && wx.cape != null && wx.cape > 500){
        h += '<div style="margin-bottom:2px;">'+K(' Solar heating: ' + Math.round(wx.solarRad) + ' W/m') + '  strong surface heating building instability from below. Peak convective window typically 3-7 PM local time.</div>';
      }

      // UPSTREAM  storms approaching
      var st = window._stormTrack || {};
      if(st.upstream && st.upstream.length > 0){
        var upStorms = st.upstream.filter(function(u){ return u.isStormy; });
        var upRain = st.upstream.filter(function(u){ return u.isRaining; });
        if(upStorms.length > 0){
          h += '<div style="margin-bottom:2px;">'+D(' Thunderstorms active ' + upStorms[0].dist + ' mi upwind') + '  convection already firing upstream. Storms may intensify as they approach, especially in higher-CAPE air.</div>';
        } else if(upRain.length > 0){
          var upPressureDelta = (st.upstream[0].pressure && wx.pressure) ? (wx.pressure - st.upstream[0].pressure) : 0;
          if(upPressureDelta > 4) h += '<div style="margin-bottom:2px;">'+W(' Low pressure center detected ' + st.upstream[0].dist + ' mi upwind') + ' (' + upPressureDelta.toFixed(1) + ' mb). Approaching system enhancing lift and shear.</div>';
        }
      }
      if(st.upstreamNarrative && st.upstreamNarrative.length > 0){
        var majorNarr = st.upstreamNarrative.filter(function(n){ return n.severity === 'major'; });
        majorNarr.slice(0,2).forEach(function(n){
          h += '<div style="margin-bottom:2px;">' + n.icon + ' ' + K(n.text) + '</div>';
        });
      }

      // VISIBILITY  storm-related impact
      if(wx.visibility != null && (wx.visibility * 0.000621371) < 3 && wx.weatherCode >= 95){
        h += '<div style="margin-bottom:2px;">'+D('Visibility: ' + (wx.visibility*0.000621371).toFixed(1) + ' mi') + '  severe thunderstorm reducing visibility. Hail core, heavy rain, or tornado may be obscured by rain curtains.</div>';
      }

      // EPA CONTAMINATION  TORNADO cross-reference
      if(window._epaData){
        var tornadoReports = (window._tornadoReports || []).filter(function(r){ return r.type === 'tornado'; });
        var sfSites = window._epaData.superfund || [];
        var triSites = window._epaData.tri || [];
        if(tornadoReports.length > 0 && (sfSites.length > 0 || triSites.length > 0)){
          var toxicDebrisRisks = [];
          tornadoReports.forEach(function(t){
            sfSites.forEach(function(sf){
              var dist = Math.sqrt(Math.pow((sf.lat-t.lat)*69,2)+Math.pow((sf.lon-t.lon)*69*Math.cos(t.lat*Math.PI/180),2));
              if(dist < 10) toxicDebrisRisks.push({report:'Tornado near '+t.location,site:sf.name,type:'SUPERFUND',dist:dist.toFixed(1)});
            });
            triSites.forEach(function(tr){
              var dist = Math.sqrt(Math.pow((tr.lat-t.lat)*69,2)+Math.pow((tr.lon-t.lon)*69*Math.cos(t.lat*Math.PI/180),2));
              if(dist < 5) toxicDebrisRisks.push({report:'Tornado near '+t.location,site:tr.name,type:'TRI',dist:dist.toFixed(1)});
            });
          });
          if(toxicDebrisRisks.length > 0){
            h += SECT(' CONTAMINATION  TORNADO RISK');
            h += '<div style="margin-bottom:2px;">'+D(toxicDebrisRisks.length+' contamination site'+(toxicDebrisRisks.length>1?'s':'')+' in tornado path area:')+'</div>';
            toxicDebrisRisks.slice(0,4).forEach(function(r){
              h += '<div style="padding-left:8px;border-left:2px solid rgba(168,85,247,.4);margin-bottom:2px;font-size:.40rem;">';
              h += '<span style="color:#a855f7;font-weight:600;">'+r.type+'</span> '+r.site+'  '+r.dist+' mi from report';
              h += '</div>';
            });
            h += '<div style="font-size:.38rem;color:rgba(255,255,255,.4);line-height:1.4;">Tornadoes striking industrial facilities or contaminated sites create toxic debris fields. Building materials, stored chemicals, and contaminated soils can be lofted and dispersed over wide areas. Avoid debris cleanup without proper PPE.</div>';
          }
        }
      }

      // 3-DAY SEVERE PROJECTION
      h += SECT("3-DAY SEVERE OUTLOOK");
      var daily = window._wxDaily;
      if(daily && daily.time && daily.windgusts_10m_max){
        h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">';
        for(var di=0; di<3 && di<daily.time.length; di++){
          var dGust = daily.windgusts_10m_max[di] || 0;
          var dPrecip = daily.precipitation_sum ? (daily.precipitation_sum[di] || 0) : 0;
          var dMaxT = daily.temperature_2m_max ? daily.temperature_2m_max[di] : null;
          var dMinT = daily.temperature_2m_min ? daily.temperature_2m_min[di] : null;
          var dayLabel = di===0?'Today':di===1?'Tomorrow':'Day 3';
          // Crude severe potential from max gust + high temp (proxy for CAPE) + precip probability
          var dPrecipProb = daily.precipitation_probability_max ? (daily.precipitation_probability_max[di] || 0) : 0;
          var sevPot = (dGust >= 50 && dPrecipProb > 50) ? 'HIGH' : (dGust >= 35 && dPrecipProb > 40 && dMaxT > 75) ? 'MOD' : (dGust >= 25 && dPrecipProb > 30) ? 'SLGT' : 'LOW';
          var sCol = sevPot === 'HIGH' ? '#ef4444' : sevPot === 'MOD' ? '#f97316' : sevPot === 'SLGT' ? '#eab308' : '#4ade80';
          h += '<div style="background:rgba(255,255,255,.03);border-radius:4px;padding:3px 5px;border-top:2px solid '+sCol+';font-size:.40rem;">';
          h += '<div style="font-weight:700;color:rgba(255,255,255,.5);">'+dayLabel+'</div>';
          h += '<div>Gusts: <b>'+Math.round(dGust)+'</b> mph</div>';
          if(dMaxT) h += '<div>High: <b>'+Math.round(dMaxT)+'</b>F</div>';
          h += '<div>Precip: <b>'+dPrecipProb+'</b>%</div>';
          h += '<div style="color:'+sCol+';font-weight:700;">'+sevPot+'</div>';
          h += '</div>';
        }
        h += '</div>';
      }

      if(tCount === 0 && (!wx.cape || wx.cape < 500) && (!wx.liftedIndex || wx.liftedIndex > 0)){
        h += G(' No severe reports') + ' and stable atmosphere. Quiet pattern.';
      }

    } else if(tab === 'quake'){
      var quakes = window._quakeFeatures || [];
      var sig = quakes.filter(function(q){ return (q.properties.mag || 0) >= 4.5; }).length;
      var strong = quakes.filter(function(q){ return (q.properties.mag || 0) >= 5.5; }).length;
      var major = quakes.filter(function(q){ return (q.properties.mag || 0) >= 6.5; }).length;

      h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px;">';
      h += '<div style="background:rgba(59,130,246,.08);border-radius:6px;padding:5px 7px;border-left:2px solid #3b82f6;"><div style="font-size:.38rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">TOTAL (24H)</div><div style="font-size:.65rem;font-weight:800;color:#60a5fa;">'+quakes.length+'</div></div>';
      h += '<div style="background:rgba(249,115,22,.08);border-radius:6px;padding:5px 7px;border-left:2px solid #f97316;"><div style="font-size:.38rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">M4.5+</div><div style="font-size:.65rem;font-weight:800;color:#fb923c;">'+sig+'</div></div>';
      h += '<div style="background:rgba(239,68,68,.08);border-radius:6px;padding:5px 7px;border-left:2px solid #ef4444;"><div style="font-size:.38rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">M6.5+</div><div style="font-size:.65rem;font-weight:800;color:#f87171;">'+major+'</div></div>';
      h += '</div>';

      //  SITUATIONAL AWARENESS SYNTHESIS 
      var qkThreat = 0;
      if(major > 0) qkThreat += 5 * major; if(strong > 0) qkThreat += 3 * Math.min(strong, 3); if(sig > 0) qkThreat += 1 * Math.min(sig, 5);
      if(nearestDist < 50 && nearestMag >= 4.0) qkThreat += 3; else if(nearestDist < 200 && nearestMag >= 5.0) qkThreat += 2;
      var tsunamiAlertsCt = (window._hazardAlerts||[]).filter(function(a){ return (a.event||'').toLowerCase().indexOf('tsunami')>=0; }).length;
      if(tsunamiAlertsCt > 0) qkThreat += 5;
      if(wx.soilMoisture != null && wx.soilMoisture > 0.3 && sig > 0) qkThreat += 1;
      if(quakes.length > 50) qkThreat += 1;

      var qLevel = qkThreat >= 10 ? 'MAJOR EVENT' : qkThreat >= 6 ? 'SIGNIFICANT' : qkThreat >= 3 ? 'ELEVATED' : qkThreat >= 1 ? 'MINOR' : 'BACKGROUND';
      var qCol = qkThreat >= 10 ? '#dc2626' : qkThreat >= 6 ? '#ef4444' : qkThreat >= 3 ? '#f97316' : qkThreat >= 1 ? '#eab308' : '#4ade80';
      var qkNarr = [];

      if(qLevel === 'MAJOR EVENT'){
        if(major > 0) qkNarr.push('M6.5+ earthquake detected  expect strong shaking, potential structural damage, and secondary hazards (landslides, liquefaction).');
        if(tsunamiAlertsCt > 0) qkNarr.push('TSUNAMI ADVISORY ACTIVE  coastal areas should monitor for unusual wave activity and follow evacuation guidance.');
        if(nearestDist < 100 && nearestMag >= 5.0) qkNarr.push('Significant quake within '+Math.round(nearestDist)+' mi of your location. Check for damage to structures, gas leaks, and water main breaks.');
        // Aftershock pattern
        if(sig > 2) qkNarr.push('Multiple M4.5+ events suggest active aftershock sequence. Expect continued strong shaking for days to weeks.');
      } else if(qLevel === 'SIGNIFICANT'){
        if(strong > 0) qkNarr.push(strong + ' M5.5+ quake'+(strong>1?'s':'')+'  moderate damage possible near epicenter. Aftershocks likely.');
        if(nearestDist < 200) qkNarr.push('Nearest significant event '+Math.round(nearestDist)+' mi away.');
      } else if(qLevel === 'BACKGROUND'){
        qkNarr.push(quakes.length + ' events in 24h  normal background seismicity. Earth averages ~55 earthquakes/day worldwide.');
      }

      // Compound hazard narrative
      var compoundFactors = [];
      if(wx.soilMoisture != null && wx.soilMoisture > 0.3 && sig > 0) compoundFactors.push('saturated soils amplify landslide risk');
      if((wx.weatherCode||0) >= 61 && sig > 0) compoundFactors.push('active precipitation + seismic shaking = slope failure concern');
      var elevGauges = (window._floodGauges || []).filter(function(g){ return g.status && g.status.priority >= 3; });
      if(elevGauges.length > 0 && strong > 0) compoundFactors.push('elevated river levels + strong quakes = dam/levee vulnerability');
      var activeFires = window._activeFires || [];
      if(activeFires.length > 0 && sig > 0) compoundFactors.push(activeFires.length+' active fires during seismic activity  gas line/water infrastructure risk');
      if(compoundFactors.length > 0) qkNarr.push('Compound hazards: ' + compoundFactors.join('; ') + '.');

      h += '<div style="margin-bottom:8px;padding:6px 8px;background:rgba(0,0,0,.3);border-radius:6px;border-left:3px solid '+qCol+';">';
      h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">';
      h += '<span style="font-size:.52rem;font-weight:900;color:'+qCol+';letter-spacing:.1em;">'+qLevel+'</span>';
      h += '<span style="font-size:.40rem;color:rgba(255,255,255,.4);">SEISMIC LEVEL</span>';
      h += '<span style="font-size:.36rem;color:rgba(255,255,255,.25);margin-left:auto;">score '+qkThreat+'</span>';
      h += '</div>';
      if(qkNarr.length > 0) h += '<div style="font-size:.44rem;color:rgba(255,255,255,.8);line-height:1.4;">'+qkNarr.join(' ')+'</div>';
      h += '</div>';

      // Proximity analysis  find nearest quake to user
      var userLat = LOCATION ? LOCATION.lat : 40;
      var userLon = LOCATION ? LOCATION.lon : -74;
      var nearestDist = Infinity, nearestMag = 0, nearestPlace = '';
      quakes.forEach(function(q){
        var coords = q.geometry && q.geometry.coordinates;
        if(!coords) return;
        var dLat = (coords[1] - userLat) * 69;
        var dLon = (coords[0] - userLon) * 69 * Math.cos(userLat * Math.PI / 180);
        var dist = Math.sqrt(dLat*dLat + dLon*dLon);
        if(dist < nearestDist){ nearestDist = dist; nearestMag = q.properties.mag || 0; nearestPlace = q.properties.place || ''; }
      });
      if(nearestDist < Infinity){
        var distColor = nearestDist < 100 ? D : nearestDist < 300 ? W : K;
        h += '<div style="margin-bottom:2px;">'+K('Nearest quake') + ': M' + nearestMag.toFixed(1) + ' at ~' + distColor(Math.round(nearestDist) + ' mi') + '  ' + nearestPlace;
        if(nearestDist < 50 && nearestMag >= 4.0) h += '. '+D('FELT RANGE')+'  this quake was likely felt at your location.';
        else if(nearestDist < 200 && nearestMag >= 5.0) h += '. Shaking possible at your distance for this magnitude.';
        h += '</div>';
      }

      if(major > 0){
        var majorQ = quakes.filter(function(q){ return (q.properties.mag || 0) >= 6.5; });
        majorQ.forEach(function(q){
          h += '<div style="margin-bottom:2px;">'+D(' M'+q.properties.mag.toFixed(1)) + '  ' + (q.properties.place || 'Unknown') + '. Major earthquake.</div>';
        });
      } else if(strong > 0){
        h += '<div style="margin-bottom:2px;">'+W(strong + ' significant quake'+(strong>1?'s':'')+' (M5.5+)') + ' in the past 24 hours.</div>';
      }

      // NWS ALERTS cross-reference  tsunami-related
      h += SECT("CROSS-HAZARD INTEL");
      var alerts = window._hazardAlerts || [];
      var tsunamiAlerts = alerts.filter(function(a){ return (a.event || '').toLowerCase().indexOf('tsunami') >= 0; });
      if(tsunamiAlerts.length > 0){
        h += '<div style="margin-bottom:2px;">'+D(' TSUNAMI ALERT ACTIVE') + ': ';
        tsunamiAlerts.forEach(function(a){ h += a.event + '  ' + (a.areaDesc || '').substring(0,60) + '. '; });
        h += 'Move to high ground if in a coastal area.</div>';
      } else if(major > 0){
        h += '<div style="margin-bottom:2px;">'+K('Tsunami check') + ': No tsunami advisories currently active. Submarine M7+ quakes with shallow depth can generate tsunamis  monitor the ALERTS tab.</div>';
      }

      // SOIL MOISTURE + PRECIP  earthquake-triggered landslide risk
      if(sig > 0 && wx.soilMoisture != null && wx.soilMoisture > 0.3){
        h += '<div style="margin-bottom:2px;">'+W(' Landslide risk elevated') + ': Saturated soils (' + (wx.soilMoisture*100).toFixed(0) + '% moisture) + seismic shaking = increased landslide/rockfall potential in mountainous terrain near epicenters.</div>';
      }
      if(sig > 0 && wx.precipTotal != null && wx.precipTotal > 0.5){
        h += '<div style="margin-bottom:2px;">'+K('Recent precipitation') + ': ' + wx.precipTotal.toFixed(2) + '" recorded. Wet ground amplifies shaking-induced slope failure. Monitor hillside areas near quake zones.</div>';
      }

      // FIRE cross-reference  quake near active fire areas
      var activeFires = window._activeFires || [];
      if(activeFires.length > 0 && sig > 0){
        h += '<div style="margin-bottom:2px;">'+K(' Fire infrastructure') + ': ' + activeFires.length + ' active fires during seismic activity. Earthquakes can rupture gas lines, damage water infrastructure, and hamper firefighting operations.</div>';
      }

      // FLOOD cross-reference  dam/levee risk from strong quakes
      var elevGauges = (window._floodGauges || []).filter(function(g){ return g.status && g.status.priority >= 3; });
      if(elevGauges.length > 0 && strong > 0){
        h += '<div style="margin-bottom:2px;">'+W(' Dam/levee concern') + ': ' + elevGauges.length + ' gauges already elevated + M5.5+ seismic activity. Strong shaking can weaken levees and earthen dams, especially when water levels are high.</div>';
      }

      // SPACE WEATHER cross-reference  ionospheric disturbance detection
      if(sw.kp != null && sw.kp >= 5 && quakes.length > 20){
        h += '<div style="margin-bottom:2px;">'+K(' Geomagnetic note') + ': Kp=' + sw.kp + ' geomagnetic storm active. Some research suggests ionospheric coupling with seismic activity, though this remains debated in the scientific community.</div>';
      }

      // WEATHER  rescue operations impact (for strong quakes)
      if(strong > 0){
        h += '<div style="margin-top:4px;margin-bottom:2px;font-weight:700;font-size:.44rem;color:rgba(255,255,255,.5);letter-spacing:.08em;">RESCUE CONDITIONS ASSESSMENT</div>';
        var rescueGood = true;
        if(wx.visibility != null && (wx.visibility * 0.000621371) < 3){
          h += '<div style="margin-bottom:2px;font-size:.46rem;">'+D(' Visibility: ' + (wx.visibility*0.000621371).toFixed(1) + ' mi') + '  poor. Aerial search and rescue hampered.</div>';
          rescueGood = false;
        }
        if(wx.wind != null && wx.wind >= 25){
          h += '<div style="margin-bottom:2px;font-size:.46rem;">'+W(' Wind: ' + Math.round(wx.wind) + ' mph') + '  helicopter operations may be restricted.</div>';
          rescueGood = false;
        }
        if(wx.weatherCode != null && wx.weatherCode >= 61){
          h += '<div style="margin-bottom:2px;font-size:.46rem;">'+W(' Active precipitation') + '  complicates search operations and increases secondary hazard risk (landslides, structure collapse).</div>';
          rescueGood = false;
        }
        if(wx.temp != null && (wx.temp < 20 || wx.temp > 100)){
          var tempIssue = wx.temp < 20 ? 'hypothermia risk for trapped survivors' : 'heat exposure risk for rescuers';
          h += '<div style="margin-bottom:2px;font-size:.46rem;">'+W(' Temp: ' + Math.round(wx.temp) + 'F') + '  ' + tempIssue + '.</div>';
          rescueGood = false;
        }
        if(rescueGood) h += '<div style="font-size:.46rem;">'+G(' Weather conditions favorable for rescue operations.')+'</div>';
      }

      // EPA INFRASTRUCTURE  EARTHQUAKE cross-reference
      if(window._epaData && sig > 0){
        var sfSites = window._epaData.superfund || [];
        var triSites = window._epaData.tri || [];
        var epicenters = quakes.filter(function(q){ return (q.properties.mag||0) >= 4.0; })
          .map(function(q){ return { lat: q.geometry.coordinates[1], lon: q.geometry.coordinates[0], mag: q.properties.mag, place: q.properties.place }; });

        if(epicenters.length > 0 && (sfSites.length > 0 || triSites.length > 0)){
          var sfNearQuake = [];
          var triNearQuake = [];
          epicenters.forEach(function(eq){
            sfSites.forEach(function(sf){
              var dist = Math.sqrt(Math.pow((sf.lat-eq.lat)*69,2)+Math.pow((sf.lon-eq.lon)*69*Math.cos(eq.lat*Math.PI/180),2));
              if(dist < 30) sfNearQuake.push({site:sf.name,dist:dist.toFixed(1),mag:eq.mag,status:sf.status});
            });
            triSites.forEach(function(tr){
              var dist = Math.sqrt(Math.pow((tr.lat-eq.lat)*69,2)+Math.pow((tr.lon-eq.lon)*69*Math.cos(eq.lat*Math.PI/180),2));
              if(dist < 15) triNearQuake.push({site:tr.name,dist:dist.toFixed(1),mag:eq.mag});
            });
          });

          if(sfNearQuake.length > 0 || triNearQuake.length > 0){
            h += SECT(' CONTAMINATION  SEISMIC RISK');
            if(sfNearQuake.length > 0){
              h += '<div style="margin-bottom:2px;">'+W(sfNearQuake.length+' Superfund site'+(sfNearQuake.length>1?'s':'')+' within shaking radius:')+'</div>';
              sfNearQuake.slice(0,3).forEach(function(r){
                h += '<div style="padding-left:8px;border-left:2px solid rgba(168,85,247,.4);margin-bottom:2px;font-size:.40rem;">';
                h += '<span style="color:#a855f7;font-weight:600;">'+r.site+'</span>  '+r.dist+' mi from M'+r.mag.toFixed(1);
                h += '</div>';
              });
              h += '<div style="font-size:.38rem;color:rgba(255,255,255,.4);margin-bottom:2px;">Seismic shaking can breach containment at Superfund sites, rupture underground storage tanks, and release hazardous materials into soil and groundwater.</div>';
            }
            if(triNearQuake.length > 0){
              h += '<div style="margin-bottom:2px;">'+K(triNearQuake.length+' TRI chemical facilit'+(triNearQuake.length>1?'ies':'y')+' near epicenters  industrial infrastructure at risk of chemical release from structural damage.')+'</div>';
            }
            h += '<div style="font-size:.36rem;color:rgba(255,255,255,.35);">Toggle  EPA overlay to visualize all contamination sites.</div>';
          }
        }
      }

      h += '<div style="margin-top:2px;">'+K('Macrostrat geology') + ': Toggle  to explore bedrock and tectonic context for any location.</div>';

      //  INDUCED SEISMICITY DETECTION 
      // Known injection well zones with detailed parameters
      // [name, lat, lon, radius_deg, pre-fracking_baseline_per_year, typical_depth_km, formation, peak_year_rate, primary_mechanism]
      var injectionZones = [
        ['Oklahoma  Central (Arbuckle)', 35.6, -97.2, 1.8, 2, 5, 'Arbuckle Group', 903, 'Wastewater disposal'],
        ['Oklahoma  N/NW (Anadarko)', 36.3, -98.2, 1.5, 1, 5, 'Arbuckle Group', 400, 'Wastewater disposal'],
        ['Oklahoma  South', 34.5, -97.0, 1.2, 0.5, 6, 'Arbuckle Group', 120, 'Hydraulic fracturing'],
        ['W. Texas (Permian/Delaware)', 31.8, -103.5, 2.0, 0.3, 8, 'Delaware Basin', 180, 'Wastewater disposal'],
        ['W. Texas (Midland Basin)', 32.0, -101.5, 1.5, 0.2, 8, 'Midland Basin', 90, 'Wastewater disposal'],
        ['S. Texas (Eagle Ford Shale)', 29.0, -98.5, 1.5, 0.5, 6, 'Eagle Ford', 45, 'Hydraulic fracturing'],
        ['N. Texas (Barnett Shale)', 32.8, -97.3, 1.0, 0.1, 5, 'Barnett/Ellenburger', 30, 'Wastewater disposal'],
        ['S. Kansas (Sedgwick/Harper)', 37.2, -97.5, 1.2, 0.5, 5, 'Arbuckle Group', 150, 'Wastewater disposal'],
        ['Colorado (RMA/DJ Basin)', 39.8, -104.8, 0.8, 0.3, 5, 'Denver-Julesburg', 25, 'Wastewater disposal'],
        ['Colorado (Raton Basin)', 37.2, -104.8, 0.8, 0.1, 4, 'Raton Basin', 15, 'Coal-bed methane'],
        ['Ohio (Youngstown)', 41.1, -80.7, 0.5, 0.1, 4, 'Mt. Simon/Knox', 12, 'Wastewater disposal'],
        ['Ohio (E. Canton)', 40.8, -81.2, 0.4, 0.05, 4, 'Knox Dolomite', 8, 'Hydraulic fracturing'],
        ['Arkansas (Guy-Greenbrier)', 35.3, -92.3, 0.4, 0.1, 5, 'Ozark Aquifer', 20, 'Wastewater disposal'],
        ['W. Virginia (Marcellus)', 38.5, -80.5, 1.0, 0.2, 3, 'Marcellus Shale', 10, 'Hydraulic fracturing'],
        ['Pennsylvania (Marcellus)', 41.0, -77.5, 1.2, 0.3, 3, 'Marcellus Shale', 15, 'Hydraulic fracturing'],
        ['New Mexico (Delaware Basin)', 32.3, -104.0, 1.5, 0.2, 8, 'Delaware Basin', 120, 'Wastewater disposal'],
        ['Wyoming (Powder River)', 44.5, -106.0, 0.8, 0.1, 4, 'Powder River', 8, 'Coal-bed methane'],
        ['Louisiana (Haynesville)', 32.5, -93.5, 0.8, 0.1, 4, 'Haynesville Shale', 10, 'Hydraulic fracturing'],
        ['N. Dakota (Bakken)', 48.0, -103.5, 1.5, 0.1, 4, 'Bakken/Three Forks', 12, 'Wastewater disposal'],
        ['Alberta (Fox Creek)', 54.4, -116.8, 0.8, 0.3, 4, 'Duvernay Shale', 40, 'Hydraulic fracturing'],
        ['BC (Montney Play)', 56.5, -121.0, 1.2, 0.2, 4, 'Montney Formation', 30, 'Hydraulic fracturing'],
        ['California (Geysers)', 38.8, -122.8, 0.3, 5, 3, 'Franciscan Complex', 200, 'Geothermal injection'],
        ['Illinois (Mt. Carmel)', 38.4, -87.8, 0.5, 0.1, 3, 'Mt. Simon Sandstone', 5, 'Wastewater disposal'],
        // Mining-induced seismicity zones (from USGS mining seismicity catalog + HiQuake database)
        ['Alabama (Bessemer coal)', 33.4, -87.0, 0.3, 0.5, 0.5, 'Coal (longwall)', 15, 'Mining collapse'],
        ['Colorado (Montrose coal)', 38.7, -107.8, 0.4, 0.3, 0.5, 'Coal (longwall)', 10, 'Mining collapse'],
        ['Colorado (Steamboat Springs coal)', 40.5, -107.0, 0.4, 0.3, 0.5, 'Coal (longwall)', 8, 'Mining collapse'],
        ['Kentucky (Hazard coal)', 37.3, -83.2, 0.5, 0.2, 0.3, 'Coal (surface)', 12, 'Mining blast'],
        ['Idaho (Coeur d\'Alene mining)', 47.5, -115.9, 0.3, 0.3, 0.3, 'Hard rock (silver)', 10, 'Rockburst'],
        ['Wyoming (Gillette coal)', 44.3, -105.5, 0.5, 0.2, 0.3, 'Coal (surface)', 15, 'Mining blast'],
        ['Utah (Trail Mountain coal)', 39.3, -111.3, 0.3, 0.2, 0.3, 'Coal (underground)', 5, 'Mining collapse'],
        ['West Virginia (southern coal)', 37.8, -81.2, 0.5, 0.3, 0.3, 'Coal (surface/longwall)', 20, 'Mining blast'],
        // Reservoir-triggered seismicity
        ['California (Oroville Dam)', 39.5, -121.5, 0.3, 0.1, 5, 'Reservoir fill', 5, 'Dam impoundment']
      ];

      //  SWARM DETECTION 
      // Cluster quakes in space+time: induced sequences show tight spatial clustering
      var swarms = [];
      var usedInSwarm = {};
      quakes.forEach(function(q, qi){
        if(usedInSwarm[qi]) return;
        var c = q.geometry && q.geometry.coordinates;
        if(!c) return;
        var cluster = [qi];
        quakes.forEach(function(q2, q2i){
          if(q2i === qi || usedInSwarm[q2i]) return;
          var c2 = q2.geometry && q2.geometry.coordinates;
          if(!c2) return;
          var spatialDist = Math.sqrt(Math.pow(c[1]-c2[1],2)+Math.pow(c[0]-c2[0],2)) * 111; // km
          var timeDiff = Math.abs((q.properties.time||0)-(q2.properties.time||0)) / 3600000; // hours
          if(spatialDist < 15 && timeDiff < 48) cluster.push(q2i);
        });
        if(cluster.length >= 4){
          cluster.forEach(function(idx){ usedInSwarm[idx] = true; });
          var avgLat = 0, avgLon = 0, avgDepth = 0, maxMag = 0;
          cluster.forEach(function(idx){
            var cc = quakes[idx].geometry.coordinates;
            avgLat += cc[1]; avgLon += cc[0]; avgDepth += (cc[2]||0);
            if((quakes[idx].properties.mag||0) > maxMag) maxMag = quakes[idx].properties.mag||0;
          });
          avgLat /= cluster.length; avgLon /= cluster.length; avgDepth /= cluster.length;
          swarms.push({count:cluster.length, lat:avgLat, lon:avgLon, depth:avgDepth, maxMag:maxMag});
        }
      });

      var inducedQuakes = [];
      var zoneCounts = {};
      quakes.forEach(function(q){
        var c = q.geometry && q.geometry.coordinates;
        if(!c) return;
        var lon = c[0], lat = c[1], depth = c[2] || 99;
        var mag = q.properties.mag || 0;
        for(var zi=0; zi<injectionZones.length; zi++){
          var z = injectionZones[zi];
          var dLat = lat - z[1], dLon = lon - z[2];
          var dist = Math.sqrt(dLat*dLat + dLon*dLon);
          if(dist <= z[3]){
            var typDepth = z[5]; // typical induced depth for this zone
            var score = 0;
            // Depth scoring  closer to typical injection depth = higher score
            if(depth <= typDepth + 2) score += 3;
            else if(depth <= typDepth + 5) score += 2;
            else if(depth <= 15) score += 1;
            score += 2; // in known zone
            if(mag < 4.0) score += 1; // typical induced magnitude range
            // Bonus: very shallow in deep-injection zone = very suspicious
            if(depth <= 3 && typDepth <= 5) score += 1;
            // Check if quake is in a detected swarm
            var inSwarm = swarms.some(function(s){
              return Math.sqrt(Math.pow(lat-s.lat,2)+Math.pow(lon-s.lon,2))*111 < 20;
            });
            if(inSwarm) score += 1;
            var label = score >= 5 ? 'LIKELY INDUCED' : score >= 3 ? 'POSSIBLY INDUCED' : 'IN INJECTION ZONE';
            var labelCol = score >= 5 ? '#f97316' : score >= 3 ? '#eab308' : 'rgba(255,255,255,.4)';
            inducedQuakes.push({ q:q, zone:z[0], depth:depth, score:score, label:label, labelCol:labelCol, formation:z[6], mechanism:z[8] });
            if(!zoneCounts[z[0]]) zoneCounts[z[0]] = {count:0, maxMag:0, baseline:z[4], name:z[0], formation:z[6], mechanism:z[8], peakRate:z[7]};
            zoneCounts[z[0]].count++;
            if(mag > zoneCounts[z[0]].maxMag) zoneCounts[z[0]].maxMag = mag;
            break;
          }
        }
      });

      if(inducedQuakes.length > 0){
        h += SECT('INDUCED SEISMICITY ANALYSIS');
        h += '<div style="font-size:.42rem;color:rgba(255,255,255,.6);margin-bottom:4px;line-height:1.4;">Earthquakes detected in known wastewater injection / hydraulic fracturing zones. Shallow depth + injection zone + clustering pattern = higher probability of human-caused seismicity.</div>';

        // Swarm alert
        if(swarms.length > 0){
          h += '<div style="margin-bottom:5px;padding:4px 6px;background:rgba(249,115,22,.08);border-left:2px solid #f97316;border-radius:4px;font-size:.42rem;">';
          h += '<span style="color:#f97316;font-weight:800;"> '+swarms.length+' SWARM'+(swarms.length>1?'S':'')+' DETECTED</span>  ';
          swarms.forEach(function(s,si){
            // Check if swarm is in an injection zone
            var swarmZone = '';
            for(var zi=0;zi<injectionZones.length;zi++){
              var z = injectionZones[zi];
              if(Math.sqrt(Math.pow(s.lat-z[1],2)+Math.pow(s.lon-z[2],2)) <= z[3]){ swarmZone = z[0]; break; }
            }
            if(si > 0) h += '  ';
            h += '<span style="color:rgba(255,255,255,.8);">'+s.count+' events</span>';
            h += ' (M'+s.maxMag.toFixed(1)+', avg depth '+s.depth.toFixed(0)+'km)';
            if(swarmZone) h += ' <span style="color:#f97316;">in '+swarmZone+'</span>';
          });
          h += '</div>';
        }

        // Zone summary
        var zoneKeys = Object.keys(zoneCounts).sort(function(a,b){ return zoneCounts[b].count - zoneCounts[a].count; });
        h += '<div style="display:flex;flex-direction:column;gap:2px;margin-bottom:6px;">';
        zoneKeys.forEach(function(zk){
          var zd = zoneCounts[zk];
          var ratio = zd.count / (zd.baseline / 365); // daily baseline
          var ratioCol = ratio > 5 ? '#ef4444' : ratio > 2 ? '#f97316' : ratio > 1 ? '#eab308' : '#4ade80';
          var ratioLabel = ratio > 5 ? 'EXTREME' : ratio > 2 ? 'ELEVATED' : ratio > 1 ? 'ABOVE AVG' : 'NORMAL';
          h += '<div style="padding:3px 5px;background:rgba(249,115,22,.06);border-radius:4px;font-size:.42rem;">';
          h += '<div style="display:flex;align-items:center;gap:4px;">';
          h += '<span style="color:#fb923c;font-weight:800;min-width:16px;text-align:right;">'+zd.count+'</span>';
          h += '<span style="color:rgba(255,255,255,.8);font-weight:600;flex:1;">'+zd.name+'</span>';
          h += '<span style="font-size:.34rem;padding:1px 4px;border-radius:3px;background:'+ratioCol+'22;color:'+ratioCol+';font-weight:700;">'+ratioLabel+'</span>';
          h += '</div>';
          h += '<div style="display:flex;gap:6px;margin-top:1px;font-size:.36rem;color:rgba(255,255,255,.35);">';
          h += '<span>'+zd.formation+'</span>';
          h += '<span></span>';
          h += '<span>'+zd.mechanism+'</span>';
          if(zd.maxMag >= 2.5) h += '<span> Max M'+zd.maxMag.toFixed(1)+'</span>';
          h += '</div></div>';
        });
        h += '</div>';

        // Individual flagged quakes (top 5 by score then magnitude)
        var topInduced = inducedQuakes.sort(function(a,b){
          return b.score - a.score || (b.q.properties.mag||0) - (a.q.properties.mag||0);
        }).slice(0,5);
        h += '<div style="font-size:.38rem;font-weight:700;color:rgba(255,255,255,.3);letter-spacing:.06em;margin-bottom:2px;">FLAGGED EVENTS</div>';
        topInduced.forEach(function(iq){
          var p = iq.q.properties;
          var c = iq.q.geometry.coordinates;
          var place = p.place || 'Unknown';
          if(place.indexOf(' of ') > -1) place = place.split(' of ')[1] || place;
          h += '<div onclick="if(hazardMap)hazardMap.flyTo(['+c[1]+','+c[0]+'],10)" style="display:flex;align-items:center;gap:4px;padding:2px 4px;cursor:pointer;border-radius:4px;font-size:.40rem;" class="quake-item">';
          h += '<span style="color:#60a5fa;font-weight:800;min-width:22px;text-align:right;">'+p.mag.toFixed(1)+'</span>';
          h += '<span style="color:rgba(255,255,255,.7);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+place+'</span>';
          h += '<span style="color:rgba(255,255,255,.3);font-size:.36rem;">'+iq.depth.toFixed(0)+'km</span>';
          h += '<span style="font-size:.32rem;padding:1px 3px;border-radius:3px;background:'+iq.labelCol+'22;color:'+iq.labelCol+';font-weight:700;white-space:nowrap;">'+iq.label+'</span>';
          h += '</div>';
          // Show mechanism under the event
          if(iq.formation) h += '<div style="padding-left:30px;font-size:.34rem;color:rgba(255,255,255,.3);margin-top:-1px;">'+iq.formation+'  '+iq.mechanism+'</div>';
        });

        var totalInduced = inducedQuakes.filter(function(iq){ return iq.score >= 4; }).length;
        var totalPossible = inducedQuakes.filter(function(iq){ return iq.score >= 3 && iq.score < 4; }).length;
        if(totalInduced > 0 || totalPossible > 0){
          h += '<div style="margin-top:4px;font-size:.42rem;color:rgba(255,255,255,.6);line-height:1.4;">';
          h += '<span style="color:#f97316;font-weight:700;">'+totalInduced+'</span> likely induced  <span style="color:#eab308;font-weight:700;">'+totalPossible+'</span> possibly induced out of <span style="font-weight:700;">'+quakes.length+'</span> total events (24h)';
          h += '</div>';
        }
      }

      //  STRONGEST QUAKES (24H) 
      if(quakes.length > 0){
        var topByMag = quakes.slice().sort(function(a,b){ return (b.properties.mag||0) - (a.properties.mag||0); }).slice(0,8);
        h += SECT('STRONGEST EVENTS (24H)');
        h += '<div style="display:flex;flex-direction:column;gap:1px;">';
        topByMag.forEach(function(q,i){
          var p = q.properties;
          var c = q.geometry && q.geometry.coordinates;
          var mag = p.mag || 0;
          var place = p.place || 'Unknown';
          if(place.indexOf(' of ') > -1) place = place.split(' of ')[1] || place;
          var depth = c ? c[2] : 0;
          var magCol = mag >= 6 ? '#dc2626' : mag >= 5 ? '#ef4444' : mag >= 4 ? '#f97316' : mag >= 3 ? '#eab308' : '#4ade80';
          var timeStr = '';
          if(p.time){
            var mins = Math.floor((Date.now() - p.time) / 60000);
            if(mins < 60) timeStr = mins + 'm';
            else if(mins < 1440) timeStr = Math.floor(mins/60) + 'h';
            else timeStr = Math.floor(mins/1440) + 'd';
          }
          // Check if this one is in an injection zone
          var inZone = inducedQuakes.find(function(iq){ return iq.q === q; });
          var lat = c ? c[1] : 0, lon = c ? c[0] : 0;

          h += '<div onclick="if(hazardMap)hazardMap.flyTo(['+lat+','+lon+'],9)" style="display:flex;align-items:center;gap:4px;padding:3px 4px;cursor:pointer;border-radius:4px;font-size:.42rem;" class="quake-item">';
          h += '<span style="color:rgba(255,255,255,.2);font-size:.36rem;width:10px;">'+(i+1)+'</span>';
          h += '<span style="color:'+magCol+';font-weight:800;min-width:22px;text-align:right;">'+mag.toFixed(1)+'</span>';
          h += '<span style="color:rgba(255,255,255,.85);font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+place+'</span>';
          h += '<span style="color:rgba(255,255,255,.3);font-size:.36rem;">'+depth.toFixed(0)+'km</span>';
          if(inZone) h += '<span style="font-size:.3rem;padding:1px 3px;border-radius:3px;background:'+inZone.labelCol+'22;color:'+inZone.labelCol+';font-weight:700;"></span>';
          h += '<span style="color:rgba(255,255,255,.3);font-size:.36rem;">'+timeStr+'</span>';
          h += '</div>';
        });
        h += '</div>';
      }

      if(major === 0 && strong === 0 && sig === 0) h += '<div style="margin-top:4px;">'+G(' No significant earthquakes') + ' (M4.5+) in the past 24 hours. Normal background seismicity.</div>';

    } else if(tab === 'alerts'){
      var alerts = window._hazardAlerts || [];
      var warnings = alerts.filter(function(a){ return a.severity === 'warning'; });
      var watches = alerts.filter(function(a){ return a.severity === 'watch'; });
      var advisories = alerts.filter(function(a){ return a.severity === 'advisory'; });

      h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px;">';
      h += '<div style="background:rgba(239,68,68,.08);border-radius:6px;padding:5px 7px;border-left:2px solid #ef4444;"><div style="font-size:.38rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">WARNINGS</div><div style="font-size:.65rem;font-weight:800;color:#f87171;">'+warnings.length+'</div></div>';
      h += '<div style="background:rgba(249,115,22,.08);border-radius:6px;padding:5px 7px;border-left:2px solid #f97316;"><div style="font-size:.38rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">WATCHES</div><div style="font-size:.65rem;font-weight:800;color:#fb923c;">'+watches.length+'</div></div>';
      h += '<div style="background:rgba(234,179,8,.08);border-radius:6px;padding:5px 7px;border-left:2px solid #eab308;"><div style="font-size:.38rem;color:rgba(255,255,255,.4);letter-spacing:.08em;">ADVISORIES</div><div style="font-size:.65rem;font-weight:800;color:#fbbf24;">'+advisories.length+'</div></div>';
      h += '</div>';

      //  SITUATIONAL AWARENESS SYNTHESIS 
      var alThreat = 0;
      alThreat += warnings.length * 3;
      alThreat += watches.length * 2;
      alThreat += advisories.length * 1;
      // Weight by type
      var torWarn = alerts.filter(function(a){ return a.severity==='warning' && (a.event||'').toLowerCase().indexOf('tornado')>=0; }).length;
      var tsunWarn = alerts.filter(function(a){ return (a.event||'').toLowerCase().indexOf('tsunami')>=0; }).length;
      if(torWarn > 0) alThreat += 4;
      if(tsunWarn > 0) alThreat += 5;
      // Approaching conditions
      var stNarr = window._stormTrack && window._stormTrack.upstreamNarrative ? window._stormTrack.upstreamNarrative.filter(function(n){return n.severity==='major';}) : [];
      if(stNarr.length > 0) alThreat += 2;

      var alLevel = alThreat >= 12 ? 'EXTREME' : alThreat >= 8 ? 'HIGH' : alThreat >= 4 ? 'MODERATE' : alThreat >= 1 ? 'LOW' : 'CLEAR';
      var alCol = alThreat >= 12 ? '#dc2626' : alThreat >= 8 ? '#ef4444' : alThreat >= 4 ? '#f97316' : alThreat >= 1 ? '#eab308' : '#4ade80';
      var alNarr = [];

      if(alLevel === 'EXTREME' || alLevel === 'HIGH'){
        if(torWarn > 0) alNarr.push(torWarn + ' TORNADO WARNING'+(torWarn>1?'S':'')+'  take shelter immediately in an interior room on the lowest floor. Avoid windows.');
        if(tsunWarn > 0) alNarr.push('TSUNAMI ADVISORY  move away from coastline and follow local evacuation routes.');
        if(warnings.length > 3) alNarr.push(warnings.length + ' concurrent warnings indicate a multi-hazard event. Prioritize life-safety actions for the most immediate threat.');
        // Count distinct hazard types in warnings
        var wTypes = {};
        warnings.forEach(function(a){ var e = (a.event||'').split(' ')[0]; wTypes[e] = (wTypes[e]||0)+1; });
        var distinctTypes = Object.keys(wTypes).length;
        if(distinctTypes >= 3) alNarr.push('Compound event: '+distinctTypes+' different warning types active simultaneously  indicates a complex, multi-threat scenario.');
      } else if(alLevel === 'MODERATE'){
        if(warnings.length > 0) alNarr.push(warnings.length + ' warning'+(warnings.length>1?'s':'')+' active. Monitor conditions and be ready to take protective action.');
        if(watches.length > 0) alNarr.push(watches.length + ' watch'+(watches.length>1?'es':'')+'  conditions are favorable for hazardous weather development.');
      } else if(alLevel === 'CLEAR'){
        alNarr.push('No active alerts. All clear for your area.');
      }

      h += '<div style="margin-bottom:8px;padding:6px 8px;background:rgba(0,0,0,.3);border-radius:6px;border-left:3px solid '+alCol+';">';
      h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">';
      h += '<span style="font-size:.52rem;font-weight:900;color:'+alCol+';letter-spacing:.1em;">'+alLevel+'</span>';
      h += '<span style="font-size:.40rem;color:rgba(255,255,255,.4);">ALERT LEVEL</span>';
      h += '<span style="font-size:.36rem;color:rgba(255,255,255,.25);margin-left:auto;">'+(warnings.length?warnings.length+'W ':'')+(watches.length?watches.length+'Wt ':'')+(advisories.length?advisories.length+'A':'')+'</span>';
      h += '</div>';
      if(alNarr.length > 0) h += '<div style="font-size:.44rem;color:rgba(255,255,255,.8);line-height:1.4;">'+alNarr.join(' ')+'</div>';
      h += '</div>';

      // List active warnings
      if(warnings.length > 0){
        h += '<div style="margin-bottom:6px;font-weight:700;color:#f87171;font-size:.46rem;">ACTIVE WARNINGS:</div>';
        warnings.slice(0, 5).forEach(function(a){
          h += '<div style="margin-bottom:3px;padding-left:8px;border-left:2px solid rgba(239,68,68,.3);">' + D(a.event) + '  ' + (a.areaDesc || '').substring(0, 80) + '</div>';
        });
        if(warnings.length > 5) h += '<div style="opacity:.5;font-size:.42rem;">+' + (warnings.length - 5) + ' more warnings</div>';
      }

      // CROSS-POLLINATION: Categorize alerts and link to other tabs
      var alertTypes = { tornado:0, severe:0, flood:0, fire:0, winter:0, heat:0, wind:0, marine:0, other:0 };
      alerts.forEach(function(a){
        var e = (a.event || '').toLowerCase();
        if(e.indexOf('tornado') >= 0) alertTypes.tornado++;
        else if(e.indexOf('severe thunderstorm') >= 0 || e.indexOf('hail') >= 0) alertTypes.severe++;
        else if(e.indexOf('flood') >= 0 || e.indexOf('hydrologic') >= 0) alertTypes.flood++;
        else if(e.indexOf('fire') >= 0 || e.indexOf('red flag') >= 0) alertTypes.fire++;
        else if(e.indexOf('winter') >= 0 || e.indexOf('ice') >= 0 || e.indexOf('blizzard') >= 0 || e.indexOf('snow') >= 0 || e.indexOf('freeze') >= 0 || e.indexOf('frost') >= 0 || e.indexOf('wind chill') >= 0) alertTypes.winter++;
        else if(e.indexOf('heat') >= 0 || e.indexOf('excessive heat') >= 0) alertTypes.heat++;
        else if(e.indexOf('wind') >= 0 || e.indexOf('gust') >= 0) alertTypes.wind++;
        else if(e.indexOf('marine') >= 0 || e.indexOf('coastal') >= 0 || e.indexOf('rip') >= 0 || e.indexOf('surf') >= 0 || e.indexOf('tsunami') >= 0) alertTypes.marine++;
        else alertTypes.other++;
      });

      if(alerts.length > 0){
        h += '<div style="margin-top:4px;margin-bottom:2px;font-size:.46rem;">';
        // Route to other tabs
        if(alertTypes.tornado > 0 || alertTypes.severe > 0) h += K(' ' + (alertTypes.tornado + alertTypes.severe) + ' severe/tornado') + '  see SEVERE tab for SPC reports + convective outlook. ';
        if(alertTypes.flood > 0) h += K(' ' + alertTypes.flood + ' flood') + '  see FLOOD tab for real-time river gauges + WPC ERO outlook. ';
        if(alertTypes.fire > 0) h += K(' ' + alertTypes.fire + ' fire weather') + '  see FIRES tab for active fires + SPC fire weather outlook. ';
        h += '</div>';
      }

      // WEATHER cross-reference  do current conditions match alert type?
      if(alertTypes.tornado > 0 || alertTypes.severe > 0){
        h += '<div style="margin-bottom:2px;">';
        if(wx.cape != null) h += K('CAPE: ' + Math.round(wx.cape) + ' J/kg') + (wx.cape >= 2000 ? '  '+W('confirms severe environment')+'. ' : wx.cape >= 500 ? '  supports thunderstorms. ' : '  marginal instability. ');
        if(wx.gust != null && wx.gust >= 30) h += W('Gusts: ' + Math.round(wx.gust) + ' mph  shear present. ');
        h += '</div>';
      }

      if(alertTypes.flood > 0){
        var elevGauges = (window._floodGauges || []).filter(function(g){ return g.status && g.status.priority >= 3; });
        h += '<div style="margin-bottom:2px;">';
        if(elevGauges.length > 0) h += W(' ' + elevGauges.length + ' gauges already elevated') + ' during active flood alerts. ';
        if(wx.soilMoisture != null && wx.soilMoisture > 0.3) h += W('Saturated soils (' + (wx.soilMoisture*100).toFixed(0) + '%)') + '  reduced absorption capacity amplifies flood risk. ';
        if(wx.precipProb != null && wx.precipProb > 50) h += K('Precip probability: ' + wx.precipProb + '%') + '  more rain incoming. ';
        h += '</div>';
      }

      if(alertTypes.fire > 0){
        var activeFires = window._activeFires || [];
        h += '<div style="margin-bottom:2px;">';
        if(activeFires.length > 0) h += W(' ' + activeFires.length + ' active fires') + ' during fire weather alerts. ';
        if(wx.rh != null) h += K('RH: ' + Math.round(wx.rh) + '%') + (wx.rh < 15 ? '  '+D('critical')+'. ' : wx.rh < 25 ? '  elevated fire risk. ' : '. ');
        h += '</div>';
      }

      if(alertTypes.winter > 0){
        h += '<div style="margin-bottom:2px;">';
        if(wx.freezingLevel != null) h += K('Freezing level: ' + Math.round(wx.freezingLevel * 3.28084).toLocaleString() + ' ft') + (wx.freezingLevel < 500 ? '  '+D('near surface')+'. Snow/ice to ground. ' : '. ');
        if(wx.temp != null) h += K('Temp: ' + Math.round(wx.temp) + 'F') + (wx.temp <= 32 ? '  at/below freezing. ' : '  above freezing, possible rain/snow line issues. ');
        h += '</div>';
      }

      // SPACE WEATHER cross-reference
      if(sw.xrayClass && (sw.xrayClass.charAt(0) === 'M' || sw.xrayClass.charAt(0) === 'X')){
        h += '<div style="margin-bottom:2px;">'+K(' Solar flare active: ' + sw.xrayClass) + '  HF radio degradation possible. NOAA Weather Radio and emergency communications may experience interference during active alerts.</div>';
      }

      // UPSTREAM  what's approaching that could trigger new alerts
      var st = window._stormTrack || {};
      if(st.upstreamNarrative && st.upstreamNarrative.length > 0){
        h += '<div style="margin-top:4px;margin-bottom:2px;font-weight:700;font-size:.44rem;color:rgba(255,255,255,.5);letter-spacing:.08em;">APPROACHING CONDITIONS</div>';
        st.upstreamNarrative.slice(0,3).forEach(function(n){
          var col = n.severity === 'major' ? '#ef4444' : n.severity === 'significant' ? '#f97316' : 'rgba(255,255,255,.7)';
          h += '<div style="margin-bottom:2px;font-size:.46rem;color:'+col+';">' + n.icon + ' ' + n.text + '</div>';
        });
      }

      // 3-DAY HAZARD PROJECTION from daily forecast
      var daily = window._wxDaily;
      if(daily && daily.time){
        h += '<div style="margin-top:6px;margin-bottom:2px;font-weight:700;font-size:.44rem;color:rgba(255,255,255,.5);letter-spacing:.08em;">3-DAY HAZARD PROJECTION</div>';
        h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">';
        for(var di=0; di<3 && di<daily.time.length; di++){
          var dGust = daily.windgusts_10m_max ? (daily.windgusts_10m_max[di] || 0) : 0;
          var dPrecip = daily.precipitation_sum ? (daily.precipitation_sum[di] || 0) : 0;
          var dPrecipProb = daily.precipitation_probability_max ? (daily.precipitation_probability_max[di] || 0) : 0;
          var dMaxT = daily.temperature_2m_max ? daily.temperature_2m_max[di] : null;
          var dMinT = daily.temperature_2m_min ? daily.temperature_2m_min[di] : null;
          var dayLabel = di===0?'Today':di===1?'Tomorrow':'Day 3';
          // Determine primary hazard type for each day
          var hazards = [];
          if(dGust >= 50 && dPrecipProb > 40) hazards.push(' SVR');
          else if(dGust >= 35) hazards.push(' WIND');
          if(dPrecip > 1.5) hazards.push(' FLOOD');
          if(dMinT != null && dMinT < 20) hazards.push(' COLD');
          if(dMaxT != null && dMaxT > 100) hazards.push(' HEAT');
          if(dGust >= 25 && dPrecip < 0.05 && dMaxT > 80) hazards.push(' FIRE');
          if(hazards.length === 0) hazards.push(' LOW');
          var hasDanger = hazards[0].indexOf('') < 0;
          var hCol = hasDanger ? '#f97316' : '#4ade80';
          h += '<div style="background:rgba(255,255,255,.03);border-radius:4px;padding:3px 5px;border-top:2px solid '+hCol+';font-size:.40rem;">';
          h += '<div style="font-weight:700;color:rgba(255,255,255,.5);">'+dayLabel+'</div>';
          h += '<div>Gusts: <b>'+Math.round(dGust)+'</b></div>';
          h += '<div>Rain: <b>'+dPrecip.toFixed(2)+'</b>"</div>';
          h += '<div style="color:'+hCol+';font-weight:700;">'+hazards.join(' ')+'</div>';
          h += '</div>';
        }
        h += '</div>';
      }

      if(alerts.length === 0) h += G(' No active NWS alerts') + ' for your area. Clear conditions.';
      else h += '<div style="margin-top:4px;opacity:.6;font-size:.42rem;">Click any colored polygon on the map to read the full NWS alert text.</div>';

    } else if(tab === 'flood'){
      var gauges = window._floodGauges || [];
      var fs = window._floodStats || {};
      var elevated = gauges.filter(function(g){ return g.status && g.status.priority >= 3; });
      var action = gauges.filter(function(g){ return g.status && g.status.priority === 2; });

      // Forecast time indicator
      var fhr = typeof floodForecastHour !== 'undefined' ? floodForecastHour : 'obs';
      var fhrLabel = fhr === 'obs' ? 'OBSERVED (NOW)' : fhr === 'full' ? 'FULL FORECAST PERIOD (MAX)' : fhr + '-HOUR FORECAST';

      h += '<div style="margin-bottom:6px;font-size:.40rem;color:rgba(6,182,212,.8);letter-spacing:.08em;font-weight:700;"> ' + fhrLabel + '</div>';

      h += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin-bottom:8px;">';
      h += '<div style="background:rgba(147,51,234,.1);border-radius:6px;padding:4px 6px;border-left:2px solid #9333ea;text-align:center;"><div style="font-size:.34rem;color:rgba(255,255,255,.4);letter-spacing:.06em;">MAJOR</div><div style="font-size:.58rem;font-weight:800;color:#a855f7;">'+(fs.major||0)+'</div></div>';
      h += '<div style="background:rgba(239,68,68,.08);border-radius:6px;padding:4px 6px;border-left:2px solid #ef4444;text-align:center;"><div style="font-size:.34rem;color:rgba(255,255,255,.4);letter-spacing:.06em;">MODERATE</div><div style="font-size:.58rem;font-weight:800;color:#f87171;">'+(fs.moderate||0)+'</div></div>';
      h += '<div style="background:rgba(249,115,22,.08);border-radius:6px;padding:4px 6px;border-left:2px solid #f97316;text-align:center;"><div style="font-size:.34rem;color:rgba(255,255,255,.4);letter-spacing:.06em;">MINOR</div><div style="font-size:.58rem;font-weight:800;color:#fb923c;">'+(fs.minor||0)+'</div></div>';
      h += '<div style="background:rgba(234,179,8,.08);border-radius:6px;padding:4px 6px;border-left:2px solid #eab308;text-align:center;"><div style="font-size:.34rem;color:rgba(255,255,255,.4);letter-spacing:.06em;">ACTION</div><div style="font-size:.58rem;font-weight:800;color:#fbbf24;">'+(fs.action||0)+'</div></div>';
      h += '<div style="background:rgba(34,197,94,.06);border-radius:6px;padding:4px 6px;border-left:2px solid #22c55e;text-align:center;"><div style="font-size:.34rem;color:rgba(255,255,255,.4);letter-spacing:.06em;">NORMAL</div><div style="font-size:.58rem;font-weight:800;color:#4ade80;">'+(fs.normal||0)+'</div></div>';
      h += '</div>';

      h += '<div style="font-size:.38rem;color:rgba(255,255,255,.3);margin-bottom:8px;">' + (fs.total||0) + ' gauges monitored  Source: NWS AHPS + USGS</div>';

      //  SITUATIONAL AWARENESS SYNTHESIS 
      var flThreat = 0;
      // Score from AHPS real flood categories
      flThreat += (fs.major||0) * 5;
      flThreat += (fs.moderate||0) * 3;
      flThreat += (fs.minor||0) * 2;
      flThreat += (fs.action||0) * 1;
      if(wx.soilMoisture != null && wx.soilMoisture > 0.4) flThreat += 3; else if(wx.soilMoisture != null && wx.soilMoisture > 0.25) flThreat += 1;
      if(wx.precipTotal != null && wx.precipTotal > 1.5) flThreat += 3; else if(wx.precipTotal != null && wx.precipTotal > 0.5) flThreat += 1;
      if(wx.precipProb != null && wx.precipProb > 80) flThreat += 2; else if(wx.precipProb != null && wx.precipProb > 50) flThreat += 1;
      if(wx.cape != null && wx.cape > 1500 && wx.precipProb > 40) flThreat += 2;
      if(wx.pressureTrend != null && wx.pressureTrend <= -2) flThreat += 1;
      var flAlertsCt = (window._hazardAlerts||[]).filter(function(a){ return (a.event||'').toLowerCase().indexOf('flood')>=0; }).length;
      if(flAlertsCt > 0) flThreat += 3;
      if(wx.weatherCode >= 95) flThreat += 2;
      if(wx.next6hrMaxPrecipProb != null && wx.next6hrMaxPrecipProb > 80) flThreat += 1;
      var moonPhaseG = window._moonPhase;
      var isSpringTide = moonPhaseG && moonPhaseG.phase != null && (moonPhaseG.phase < 0.06 || moonPhaseG.phase > 0.94 || (moonPhaseG.phase > 0.44 && moonPhaseG.phase < 0.56));
      if(isSpringTide && elevated.length > 0) flThreat += 1;
      var largeFires = (window._activeFires||[]).filter(function(f){ return (f.acres||0) >= 5000; });
      if(largeFires.length > 0 && wx.precipProb > 30) flThreat += 1;

      var flLevel = flThreat >= 12 ? 'MAJOR FLOOD' : flThreat >= 8 ? 'MODERATE FLOOD' : flThreat >= 5 ? 'MINOR FLOOD' : flThreat >= 2 ? 'WATCH' : 'NORMAL';
      var flCol = flThreat >= 12 ? '#dc2626' : flThreat >= 8 ? '#ef4444' : flThreat >= 5 ? '#f97316' : flThreat >= 2 ? '#eab308' : '#4ade80';
      var flNarr = [];

      if(flLevel === 'MAJOR FLOOD'){
        if((fs.major||0) > 0) flNarr.push((fs.major) + ' gauge'+(fs.major>1?'s':'')+' at MAJOR flood stage  life-threatening flooding in progress. Evacuations likely ordered.');
        if((fs.moderate||0) > 0) flNarr.push((fs.moderate) + ' gauge'+(fs.moderate>1?'s':'')+' at moderate flood  significant property damage and road closures.');
        if(wx.soilMoisture > 0.4 && wx.precipProb > 50) flNarr.push('Saturated soils ('+(wx.soilMoisture*100).toFixed(0)+'%) + continued rainfall expected ('+wx.precipProb+'% chance). All additional rain becomes surface runoff.');
        if(wx.cape > 1500 && wx.precipProb > 40) flNarr.push('Thunderstorms can produce extreme rain rates (2-4\"/hr) on top of already-flooded conditions  catastrophic flash flooding possible.');
        if(flAlertsCt > 0) flNarr.push(flAlertsCt+' NWS flood alert'+(flAlertsCt>1?'s':'')+' active.');
      } else if(flLevel === 'MODERATE FLOOD' || flLevel === 'MINOR FLOOD'){
        var floodingCount = (fs.major||0) + (fs.moderate||0) + (fs.minor||0);
        if(floodingCount > 0) flNarr.push(floodingCount + ' gauge'+(floodingCount>1?'s':'')+' above flood stage. River crests may still be hours away.');
        if(wx.precipTotal > 0.5) flNarr.push('Recent precipitation ('+wx.precipTotal.toFixed(2)+'\") contributing to rising water levels.');
        if(wx.soilMoisture > 0.25 && wx.precipProb > 50) flNarr.push('Wet soils + more rain coming  flooding conditions likely to worsen before improving.');
      } else if(flLevel === 'WATCH'){
        if(wx.precipProb > 60) flNarr.push('Significant precipitation expected ('+wx.precipProb+'%). Monitoring river gauges for response.');
        if(wx.soilMoisture > 0.3) flNarr.push('Pre-saturated soils reduce drainage capacity  even moderate rain can cause localized flooding.');
      } else {
        flNarr.push('All gauges at normal levels. No flood threats at this time.');
      }

      // Compound assessment
      if(largeFires.length > 0 && wx.precipProb > 30 && (flLevel !== 'NORMAL')){
        flNarr.push(' Burn scar factor: '+largeFires.length+' large fire'+(largeFires.length>1?'s':'')+' created debris-flow-prone terrain. Even moderate rain over burn scars can produce deadly mudslides.');
      }

      h += '<div style="margin-bottom:8px;padding:6px 8px;background:rgba(0,0,0,.3);border-radius:6px;border-left:3px solid '+flCol+';">';
      h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">';
      h += '<span style="font-size:.52rem;font-weight:900;color:'+flCol+';letter-spacing:.1em;">'+flLevel+'</span>';
      h += '<span style="font-size:.40rem;color:rgba(255,255,255,.4);">FLOOD LEVEL</span>';
      h += '<span style="font-size:.36rem;color:rgba(255,255,255,.25);margin-left:auto;">score '+flThreat+'</span>';
      h += '</div>';
      if(flNarr.length > 0) h += '<div style="font-size:.44rem;color:rgba(255,255,255,.8);line-height:1.4;">'+flNarr.join(' ')+'</div>';
      h += '</div>';

      if(elevated.length > 0){
        h += '<div style="margin-bottom:6px;font-weight:700;color:#f97316;font-size:.46rem;">FLOODING GAUGES:</div>';
        elevated.sort(function(a,b){ return (b.status?b.status.priority:0) - (a.status?a.status.priority:0) || (b.gage||0) - (a.gage||0); }).slice(0, 8).forEach(function(g){
          var statusCol = g.status ? g.status.color : '#f97316';
          var statusLbl = g.status ? g.status.label : 'ELEVATED';
          var stageDetail = '';
          if(g.gage != null && g.flood != null && g.flood > 0){
            var pctAbove = ((g.gage - g.flood) / g.flood * 100).toFixed(0);
            if(g.gage >= g.flood) stageDetail = '  <b>+' + pctAbove + '% above flood</b>';
            else stageDetail = '  ' + ((g.flood - g.gage)).toFixed(1) + ' ft below flood';
          }
          h += '<div style="margin-bottom:3px;padding:3px 8px;border-left:3px solid '+statusCol+';background:rgba(255,255,255,.02);border-radius:0 4px 4px 0;">';
          h += '<span style="color:'+statusCol+';font-weight:700;font-size:.42rem;">'+statusLbl+'</span> ';
          h += '<span style="font-weight:600;">' + g.name + '</span>';
          if(g.waterbody) h += ' <span style="opacity:.5;font-size:.42rem;">(' + g.waterbody + ')</span>';
          h += '<div style="font-size:.42rem;opacity:.8;">' + (g.gage != null ? g.gage.toFixed(2) + ' ft' : '--') + stageDetail + '</div>';
          h += '</div>';
        });
        if(elevated.length > 8) h += '<div style="opacity:.4;font-size:.40rem;padding-left:8px;">+ ' + (elevated.length - 8) + ' more flooding gauges</div>';
      }

      // SOIL MOISTURE  absorption capacity
      h += SECT("HYDROLOGIC CONDITIONS");
      if(wx.soilMoisture != null){
        if(wx.soilMoisture > 0.4) h += '<div style="margin-bottom:2px;">'+D('Soil moisture: ' + (wx.soilMoisture*100).toFixed(0) + '%') + '  saturated ground. Virtually all additional rainfall becomes runoff. Flash flood risk is significantly amplified.</div>';
        else if(wx.soilMoisture > 0.25) h += '<div style="margin-bottom:2px;">'+W('Soil moisture: ' + (wx.soilMoisture*100).toFixed(0) + '%') + '  wet soils with reduced absorption capacity. Moderate-to-heavy rain will produce above-normal runoff.</div>';
        else if(wx.soilMoisture < 0.08) h += '<div style="margin-bottom:2px;">'+K('Soil moisture: ' + (wx.soilMoisture*100).toFixed(0) + '%') + '  very dry. Hydrophobic soils can paradoxically increase flash flood risk  water sheets off baked ground instead of soaking in.</div>';
      }

      // PRECIP cross-reference  current + forecast
      if(wx.precipTotal != null && wx.precipTotal > 0.5){
        h += '<div style="margin-bottom:2px;">'+W('Recent precipitation: ' + wx.precipTotal.toFixed(2) + '"') + '  monitor gauges for delayed rise. River crests lag rainfall by 6-24 hours depending on basin size.</div>';
      }
      if(wx.precipProb != null && wx.precipProb > 60){
        h += '<div style="margin-bottom:2px;">'+W('Precip probability: ' + wx.precipProb + '%') + '  additional rainfall may push borderline gauges above action stage.</div>';
      }

      // PRESSURE TREND  incoming system
      if(wx.pressureTrend != null && wx.pressureTrend <= -2){
        h += '<div style="margin-bottom:2px;">'+K('Pressure falling: ' + wx.pressureTrend.toFixed(1) + ' hPa/3hr') + '  approaching weather system. Expect increased precipitation and rising water levels in the next 6-24 hours.</div>';
      }

      // FRONTAL SIGNATURE  rainfall pattern
      if(wx.frontalSignature){
        var fs = wx.frontalSignature;
        if(fs.indexOf('warm_front') >= 0) h += '<div style="margin-bottom:2px;">'+K('Warm front detected') + '  warm fronts produce widespread, sustained rainfall over large areas. River basins can accumulate significant totals from prolonged moderate rain.</div>';
        else if(fs.indexOf('cold_front_approach') >= 0) h += '<div style="margin-bottom:2px;">'+K('Cold front approaching') + '  pre-frontal squall lines can dump intense short-duration rain. Primary flash flood concern for urban areas and small streams.</div>';
      }

      // FREEZING LEVEL + TEMP  snowmelt flood risk
      if(wx.freezingLevel != null && wx.temp != null && wx.temp > 40){
        var fzFt = Math.round(wx.freezingLevel * 3.28084);
        if(fzFt > 8000) h += '<div style="margin-bottom:2px;">'+W(' Snowmelt contribution') + ': Freezing level at ' + fzFt.toLocaleString() + ' ft with temp ' + Math.round(wx.temp) + 'F. High snowline + warm temps = active snowmelt adding to river flows, especially in mountain basins.</div>';
      }

      // CAPE  severe rain potential
      if(wx.cape != null && wx.cape > 1000){
        h += '<div style="margin-bottom:2px;">'+K('Convective instability') + ': CAPE ' + Math.round(wx.cape) + ' J/kg  thunderstorms capable of extreme rain rates (2-4"/hr). Flash flood risk elevated in any storms that develop.</div>';
      }

      // FIRE cross-reference  burn scar flash flood
      var activeFires = window._activeFires || [];
      var largeFires = activeFires.filter(function(f){ return (f.acres || 0) >= 5000; });
      if(largeFires.length > 0){
        h += '<div style="margin-bottom:2px;">'+W(' Burn scar risk') + ': ' + largeFires.length + ' large fire'+(largeFires.length>1?'s':'')+' (5K+ acres). Burned watersheds lose 50-80% of their water absorption capacity. Even moderate rain (<0.5"/hr) over burn scars can produce devastating debris flows.</div>';
      }

      // NWS ALERTS cross-reference  flood-related
      h += SECT("CROSS-HAZARD INTEL");
      var alerts = window._hazardAlerts || [];
      var floodAlerts = alerts.filter(function(a){ var e = (a.event || '').toLowerCase(); return e.indexOf('flood') >= 0 || e.indexOf('hydrologic') >= 0; });
      if(floodAlerts.length > 0){
        h += '<div style="margin-bottom:2px;">'+D(' ' + floodAlerts.length + ' flood-related NWS alert'+(floodAlerts.length>1?'s':'')+':') + '</div>';
        floodAlerts.slice(0,3).forEach(function(a){ h += '<div style="padding-left:8px;border-left:2px solid rgba(6,182,212,.3);margin-bottom:2px;font-size:.46rem;">' + a.event + '  ' + (a.areaDesc || '').substring(0,60) + '</div>'; });
      }

      // QUAKE cross-reference  dam/infrastructure risk
      var quakes = window._quakeFeatures || [];
      var sigQuakes = quakes.filter(function(q){ return (q.properties.mag || 0) >= 4.5; });
      if(sigQuakes.length > 0 && elevated.length > 0){
        h += '<div style="margin-bottom:2px;">'+K(' Seismic note') + ': ' + sigQuakes.length + ' M4.5+ earthquake'+(sigQuakes.length>1?'s':'')+' in 24h during elevated river levels. Seismic activity can damage levees, dams, and flood control infrastructure.</div>';
      }

      // ACTIVE SNOWMELT  flow contribution
      if(wx.snow != null && wx.snow > 0){
        h += '<div style="margin-bottom:2px;">'+K(' Active snowfall: ' + wx.snow.toFixed(2) + ' in/hr') + '  accumulating snow now means delayed snowmelt flood risk when temperatures rise. Watch for rapid warming events.</div>';
      } else if(wx.temp != null && wx.temp > 50 && wx.freezingLevel != null && (wx.freezingLevel * 3.28084) > 6000){
        var daily = window._wxDaily;
        var recentSnow = daily && daily.snowfall_sum ? daily.snowfall_sum.slice(0,3).reduce(function(a,b){ return a+(b||0); }, 0) : 0;
        if(recentSnow > 2){
          h += '<div style="margin-bottom:2px;">'+W(' Rain-on-snow risk') + ': ' + recentSnow.toFixed(1) + '" snow in forecast + warm temps (' + Math.round(wx.temp) + 'F) + high freezing level (' + Math.round(wx.freezingLevel*3.28084).toLocaleString() + ' ft). Rapid snowmelt adds to river flows.</div>';
        }
      }

      // UPSTREAM  precipitation approaching
      var st = window._stormTrack || {};
      if(st.upstream && st.upstream.length > 0){
        var upRain = st.upstream.filter(function(u){ return u.isRaining; });
        if(upRain.length > 0){
          h += '<div style="margin-bottom:2px;">'+W(' Rain active ' + upRain[0].dist + ' mi upwind') + '  precipitation heading this direction. River levels may begin rising before rain arrives locally as upstream runoff flows downstream.</div>';
        }
        // Cold air approaching  possible freeze/thaw cycle
        var upCold = st.upstream.filter(function(u){ return u.temp != null && wx.temp != null && (wx.temp - u.temp) > 15; });
        if(upCold.length > 0){
          h += '<div style="margin-bottom:2px;">'+K(' Cold air ' + (wx.temp - upCold[0].temp).toFixed(0) + 'F colder approaching from ' + upCold[0].dist + ' mi upwind') + '  rapid cooling may freeze flooded areas, creating ice jams on rivers.</div>';
        }
      }

      // MOON PHASE  tidal flooding context
      var moonPhase = window._moonPhase;
      if(moonPhase){
        var isSpringTide = (moonPhase.phase != null && (moonPhase.phase < 0.06 || moonPhase.phase > 0.94 || (moonPhase.phase > 0.44 && moonPhase.phase < 0.56)));
        if(isSpringTide){
          h += '<div style="margin-bottom:2px;">'+W(' Spring tide period') + '  near new/full moon. Coastal and tidal river flooding risk amplified. Tidal ranges are 20-40% above normal during spring tides.</div>';
        }
      }

      // WEATHER CODE  active precipitation type
      if(wx.weatherCode != null){
        if(wx.weatherCode >= 95) h += '<div style="margin-bottom:2px;">'+D(' Thunderstorm active') + '  extreme rain rates possible (2-4"/hr). Flash flood conditions imminent in urban and low-lying areas.</div>';
        else if(wx.weatherCode >= 61 && wx.weatherCode <= 67) h += '<div style="margin-bottom:2px;">'+W(' Continuous rain') + '  sustained precipitation adding to river levels. Prolonged rain causes more widespread flooding than brief intense storms.</div>';
      }

      // NEXT 6HR  incoming precipitation
      if(wx.next6hrMaxPrecipProb != null && wx.next6hrMaxPrecipProb > 60 && (wx.precipProb || 0) < 30){
        h += '<div style="margin-bottom:2px;">'+W(' Precip probability jumps to ' + wx.next6hrMaxPrecipProb + '% in next 6hr') + '  rain arriving soon. Pre-position awareness around flood-prone areas.</div>';
      }

      // 3-DAY FLOOD PROJECTION
      // EPA CONTAMINATION  FLOOD cross-reference
      if(window._epaData && (window._epaData.superfund.length > 0 || window._epaData.tri.length > 0)){
        var floodingSites = elevated.concat(minor).concat(moderate).concat(major);
        if(floodingSites.length > 0){
          var sfSites = window._epaData.superfund;
          var triSites = window._epaData.tri;
          var contamFloodRisks = [];

          floodingSites.forEach(function(gauge){
            var gLat = gauge.lat || (gauge.geometry && gauge.geometry.coordinates ? gauge.geometry.coordinates[1] : null);
            var gLon = gauge.lon || (gauge.geometry && gauge.geometry.coordinates ? gauge.geometry.coordinates[0] : null);
            if(!gLat || !gLon) return;

            // Check Superfund within 10km
            sfSites.forEach(function(sf){
              var dist = Math.sqrt(Math.pow((sf.lat-gLat)*69,2) + Math.pow((sf.lon-gLon)*69*Math.cos(gLat*Math.PI/180),2));
              if(dist < 6.2){ // ~10km in miles
                contamFloodRisks.push({
                  gauge: gauge.name || gauge.lid || 'Unknown gauge',
                  site: sf.name, type: 'SUPERFUND', dist: dist.toFixed(1), status: sf.status || 'NPL',
                  severity: dist < 1 ? 'CRITICAL' : dist < 3 ? 'HIGH' : 'MODERATE'
                });
              }
            });

            // Check TRI chemical facilities within 5km
            triSites.forEach(function(tr){
              var dist = Math.sqrt(Math.pow((tr.lat-gLat)*69,2) + Math.pow((tr.lon-gLon)*69*Math.cos(gLat*Math.PI/180),2));
              if(dist < 3.1){ // ~5km
                contamFloodRisks.push({
                  gauge: gauge.name || gauge.lid || 'Unknown gauge',
                  site: tr.name, type: 'TRI', dist: dist.toFixed(1),
                  severity: dist < 0.5 ? 'CRITICAL' : dist < 1.5 ? 'HIGH' : 'MODERATE'
                });
              }
            });
          });

          if(contamFloodRisks.length > 0){
            h += SECT(' CONTAMINATION  FLOOD RISK');
            var crits = contamFloodRisks.filter(function(r){ return r.severity === 'CRITICAL'; });
            var highs = contamFloodRisks.filter(function(r){ return r.severity === 'HIGH'; });

            if(crits.length > 0){
              h += '<div style="margin-bottom:4px;">'+D(' '+crits.length+' CRITICAL contamination-flood intersection'+(crits.length>1?'s':''))+':</div>';
              crits.slice(0,3).forEach(function(r){
                h += '<div style="padding:3px 6px;background:rgba(239,68,68,.08);border-left:2px solid rgba(239,68,68,.5);border-radius:0 4px 4px 0;margin-bottom:2px;font-size:.40rem;">';
                h += '<span style="color:#ef4444;font-weight:700;">'+r.type+'</span> <span style="color:#fff;font-weight:600;">'+r.site+'</span>';
                h += '<br><span style="color:rgba(255,255,255,.5);">'+r.dist+' mi from flooding gauge: '+r.gauge+'</span>';
                h += '</div>';
              });
              h += '<div style="font-size:.38rem;color:rgba(255,255,255,.5);line-height:1.4;margin-bottom:2px;">Floodwater inundating Superfund/TRI sites can mobilize hazardous chemicals, heavy metals, and industrial waste into waterways and residential areas. Contaminated floodwater poses serious health risks  avoid contact, do not use for drinking or bathing.</div>';
            }

            if(highs.length > 0){
              h += '<div style="margin-bottom:2px;">'+W(highs.length+' nearby contamination site'+(highs.length>1?'s':'')+' within flood zone:')+'</div>';
              highs.slice(0,3).forEach(function(r){
                h += '<div style="padding-left:8px;border-left:2px solid rgba(249,115,22,.3);margin-bottom:2px;font-size:.40rem;">';
                h += '<span style="color:#f97316;font-weight:600;">'+r.type+'</span> '+r.site+'  '+r.dist+' mi from '+r.gauge;
                h += '</div>';
              });
            }

            h += '<div style="font-size:.36rem;color:rgba(255,255,255,.35);margin-top:2px;">Toggle  EPA overlay to see all Superfund/TRI sites on map.</div>';
          }
        }
      }

      h += SECT("3-DAY PRECIPITATION OUTLOOK");
      var daily = window._wxDaily;
      if(daily && daily.time && daily.precipitation_sum){
        h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;">';
        var totalPrecip3d = 0;
        for(var di=0; di<3 && di<daily.time.length; di++){
          var dPrecip = daily.precipitation_sum[di] || 0;
          var dSnow = daily.snowfall_sum ? (daily.snowfall_sum[di] || 0) : 0;
          var dPrecipProb = daily.precipitation_probability_max ? (daily.precipitation_probability_max[di] || 0) : 0;
          totalPrecip3d += dPrecip;
          var dayLabel = di===0?'Today':di===1?'Tomorrow':'Day 3';
          var fldRisk = dPrecip > 1.5 ? 'HIGH' : dPrecip > 0.75 ? 'MOD' : dPrecip > 0.25 ? 'SLGT' : 'LOW';
          var fCol = fldRisk === 'HIGH' ? '#ef4444' : fldRisk === 'MOD' ? '#f97316' : fldRisk === 'SLGT' ? '#eab308' : '#4ade80';
          h += '<div style="background:rgba(255,255,255,.03);border-radius:4px;padding:3px 5px;border-top:2px solid '+fCol+';font-size:.40rem;">';
          h += '<div style="font-weight:700;color:rgba(255,255,255,.5);">'+dayLabel+'</div>';
          h += '<div>Rain: <b>'+dPrecip.toFixed(2)+'</b>"</div>';
          if(dSnow > 0) h += '<div>Snow: <b>'+dSnow.toFixed(1)+'</b>"</div>';
          h += '<div>Prob: <b>'+dPrecipProb+'</b>%</div>';
          h += '<div style="color:'+fCol+';font-weight:700;">'+fldRisk+'</div>';
          h += '</div>';
        }
        h += '</div>';
        if(totalPrecip3d > 2 && wx.soilMoisture != null && wx.soilMoisture > 0.25){
          h += '<div style="margin-top:4px;">'+D(' 3-day total: ' + totalPrecip3d.toFixed(2) + '" on already-wet soils (' + (wx.soilMoisture*100).toFixed(0) + '%)') + '  cumulative flood risk is significant. Monitor river gauge trends.</div>';
        }
      }

      if(elevated.length === 0 && action.length === 0) h += G(' All gauges at normal levels') + '. No flood concerns.';
      h += '<div style="margin-top:4px;opacity:.6;font-size:.42rem;">Hover any gauge marker for station name, gage height, and latest reading time.</div>';
    }

    el.innerHTML = h;
  }

  var lightningMarkers = [];
  var fireMarkers = [];
  var quakeMarkers = [];

  // Light map tiles
  var DARK_TILES = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
  var TILE_ATTRIB = '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>';

  // ============ NATIONAL RADAR MAP (CONUS) ============
  var nationalRadarMap = null;
  var nationalRadarLayer = null;
  var nationalRadarFrames = [];
  var nationalRadarIndex = 0;
  var nationalRadarTimer = null;
  var nationalRadarHost = '';

  function initNationalRadarMap(){
    var container = document.getElementById("national-radar-map");
    var liveEl = document.getElementById("national-radar-live");
    
    if (!container || typeof L === "undefined") return;

    if (nationalRadarMap) nationalRadarMap.remove();
    nationalRadarMap = L.map(container, {
      center: [39.0, -98.0],
      zoom: 3,
      zoomControl: false,
      attributionControl: false,
      minZoom: 2,
      maxZoom: 10
    });

    // Pure black background
    nationalRadarMap.getContainer().style.background = '#000';
    
    // Dark base layer (no features, just black tiles)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(nationalRadarMap);

    // Add CSS for smooth radar transitions
    var style = document.createElement('style');
    style.textContent = '#national-radar-map .leaflet-layer { transition: opacity 0.25s ease-in-out; }';
    document.head.appendChild(style);

    // Add radar legend with precip types
    var radarLegend = L.control({ position: 'bottomleft' });
    radarLegend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'radar-legend');
      div.style.background = 'rgba(0,0,0,.7)';
      div.style.backdropFilter = 'blur(8px)';
      div.style.padding = '5px 10px';
      div.style.borderRadius = '6px';
      div.style.fontSize = '.45rem';
      div.style.fontWeight = '700';
      div.style.fontFamily = 'system-ui,sans-serif';
      div.style.color = 'rgba(255,255,255,.85)';
      div.style.boxShadow = '0 2px 8px rgba(0,0,0,.3)';
      div.style.letterSpacing = '.04em';
      div.style.textTransform = 'uppercase';
      div.innerHTML = 
        '<div style="display:flex;align-items:center;gap:10px;">' +
          '<div style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;background:linear-gradient(135deg,#02fd02,#fdf802,#fd0000);border-radius:2px;display:inline-block;"></span><span>Rain</span></div>' +
          '<div style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;background:linear-gradient(135deg,#04e9e7,#019ff4,#ff80ff);border-radius:2px;display:inline-block;"></span><span>Snow</span></div>' +
          '<div style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;background:#f800fd;border-radius:2px;display:inline-block;"></span><span>Mix</span></div>' +
          '<div style="display:flex;gap:1px;align-items:center;margin-left:6px;">' +
            '<span style="width:10px;height:5px;background:#04e9e7;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#02fd02;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#fdf802;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#fd9500;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#fd0000;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#f800fd;display:inline-block;"></span>' +
          '</div>' +
        '</div>';
      return div;
    };
    radarLegend.addTo(nationalRadarMap);

    // Setup scrubber interaction
    var slider = document.getElementById("national-radar-slider");
    if (slider){
      slider.addEventListener("input", function(){
        nationalRadarIndex = parseInt(this.value);
        showNationalRadarFrame(nationalRadarIndex);
      });
      slider.addEventListener("mousedown", function(){ stopNationalRadarLoop(); });
      slider.addEventListener("touchstart", function(){ stopNationalRadarLoop(); });
      slider.addEventListener("mouseup", function(){ startNationalRadarLoop(); });
      slider.addEventListener("touchend", function(){ startNationalRadarLoop(); });
    }

    loadNationalRadarFrames();
    setInterval(loadNationalRadarFrames, 5 * 60 * 1000);

    if (liveEl) liveEl.textContent = " LIVE";
  }

  function loadNationalRadarFrames(){
    if (!nationalRadarMap) return;

    fetch('https://api.rainviewer.com/public/weather-maps.json')
      .then(function(response){ return response.json(); })
      .then(function(apiData){
        if (!apiData.radar || !apiData.radar.past || apiData.radar.past.length === 0) return;
        
        nationalRadarHost = apiData.host;
        
        // Combine past + nowcast for max coverage (~2.5 hours)
        var allFrames = apiData.radar.past.slice();
        if (apiData.radar.nowcast && apiData.radar.nowcast.length > 0){
          allFrames = allFrames.concat(apiData.radar.nowcast);
        }
        nationalRadarFrames = allFrames;
        
        var slider = document.getElementById("national-radar-slider");
        if (slider){
          slider.max = nationalRadarFrames.length - 1;
          slider.value = apiData.radar.past.length - 1;
        }
        
        // Remove old layers
        nationalRadarLayers.forEach(function(layer){
          if (layer && nationalRadarMap.hasLayer(layer)) nationalRadarMap.removeLayer(layer);
        });
        nationalRadarLayers = [];
        
        // Pre-load all frame layers (hidden initially)
        nationalRadarFrames.forEach(function(frame, i){
          var radarUrl = nationalRadarHost + frame.path + '/256/{z}/{x}/{y}/4/1_1.png';
          var layer = L.tileLayer(radarUrl, {
            opacity: 0,
            maxZoom: 10
          }).addTo(nationalRadarMap);
          nationalRadarLayers.push(layer);
        });
        
        nationalRadarIndex = apiData.radar.past.length - 1;
        showNationalRadarFrame(nationalRadarIndex);
        startNationalRadarLoop();
      })
      .catch(function(err){
        console.log('RainViewer API error:', err);
      });
  }

  var nationalRadarLayers = []; // Pre-loaded layers for smooth animation

  function showNationalRadarFrame(index){
    if (!nationalRadarMap || nationalRadarFrames.length === 0) return;
    if (index < 0 || index >= nationalRadarFrames.length) return;
    
    // Crossfade: show current frame, hide others
    nationalRadarLayers.forEach(function(layer, i){
      if (layer) layer.setOpacity(i === index ? 0.85 : 0);
    });
    
    var frame = nationalRadarFrames[index];
    
    // Update timestamp (local time)
    var tsEl = document.getElementById("national-radar-timestamp");
    if (tsEl && frame.time){
      var d = new Date(frame.time * 1000);
      var h = d.getHours();
      var m = d.getMinutes();
      var ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12; if (h === 0) h = 12;
      var timeStr = h + ':' + (m < 10 ? '0' + m : m) + ' ' + ampm;
      tsEl.textContent = timeStr;
    }
    
    // Update slider
    var slider = document.getElementById("national-radar-slider");
    if (slider) slider.value = index;
  }

  function startNationalRadarLoop(){
    stopNationalRadarLoop();
    var loopDelay = 350; // ms between frames
    var endPause = 2000; // ms pause at most recent frame
    
    nationalRadarTimer = setInterval(function(){
      nationalRadarIndex = (nationalRadarIndex + 1) % nationalRadarFrames.length;
      showNationalRadarFrame(nationalRadarIndex);
      
      // Pause longer at the end (most recent frame)
      if (nationalRadarIndex === nationalRadarFrames.length - 1){
        stopNationalRadarLoop();
        setTimeout(startNationalRadarLoop, endPause);
      }
    }, loopDelay);
  }

  function stopNationalRadarLoop(){
    if (nationalRadarTimer){
      clearInterval(nationalRadarTimer);
      nationalRadarTimer = null;
    }
  }


  function initHazardMaps(){
    initLightningMap();
    initNationalRadarMap();
    initUnifiedHazardMap();
    initGeologyMaps();
  }

  function initUnifiedHazardMap(){
    var container = document.getElementById('hazard-map');
    if (!container || typeof L === 'undefined') return;

    if (hazardMap){ hazardMap.remove(); hazardMap = null; }

    // Determine best initial view from location
    var mapCenter = [38, -96], mapZoom = 4;
    if (LOCATION && LOCATION.lat && LOCATION.lon) {
      if (LOCATION.lon > -85 && LOCATION.lat > 38) { mapCenter = [44, -74]; mapZoom = 5; }
      else if (LOCATION.lon > -90 && LOCATION.lat <= 38 && LOCATION.lat > 25) { mapCenter = [32, -82]; mapZoom = 5; }
      else if (LOCATION.lon > -100 && LOCATION.lon <= -85 && LOCATION.lat > 36) { mapCenter = [42, -90]; mapZoom = 5; }
      else if (LOCATION.lon <= -110 && LOCATION.lat <= 42 && LOCATION.lat > 30) { mapCenter = [36, -118]; mapZoom = 5; }
      else if (LOCATION.lon <= -115 && LOCATION.lat > 42) { mapCenter = [46, -122]; mapZoom = 5; }
      else if (LOCATION.lon > -105 && LOCATION.lon <= -90 && LOCATION.lat <= 36) { mapCenter = [31, -98]; mapZoom = 5; }
      else if (LOCATION.lon <= -100 && LOCATION.lon > -115 && LOCATION.lat > 36) { mapCenter = [42, -110]; mapZoom = 5; }
    }

    hazardMap = L.map(container, {
      center: mapCenter,
      zoom: mapZoom,
      zoomControl: false,
      attributionControl: false,
      minZoom: 2,
      maxZoom: 14,
      worldCopyJump: true
    });

    // Satellite basemap
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; Esri'
    }).addTo(hazardMap);

    // Labels on top
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
      attribution: TILE_ATTRIB,
      pane: 'shadowPane'
    }).addTo(hazardMap);

    // Create layer groups for each hazard type
    window._fireLayerGroup = L.layerGroup().addTo(hazardMap);
    window._tornadoLayerGroup = L.layerGroup().addTo(hazardMap);
    window._tornadoOutlookGroup = L.layerGroup();
    window._quakeLayerGroup = L.layerGroup();

    // Alias all three map variables to the shared map
    fireMap = hazardMap;
    tornadoMap = hazardMap;
    quakeMap = hazardMap;

    // Macrostrat geology overlay (hidden by default, shown with quake tab)
    window._quakeGeoVisible = false;
    window.quakeGeoTileLayer = L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png', {
      attribution: '&copy; Macrostrat',
      opacity: 0.6
    }); // NOT added to map  user toggles on with  button

    // Click handler for geology popup (only active in quake mode)
    hazardMap.on('click', function(e){
      if (hazardActiveTab === 'quake' && window._quakeGeoVisible) {
        fetchGeologyForQuakeMap(e.latlng.lat, e.latlng.lng, e.latlng);
      }
    });

    // Location marker removed for cleaner map

    // Init all data loaders
    initFireData();
    initTornadoData();
    initQuakeData();
    initAlertsData();
    initFloodData();

    // Set initial tab state
    window._hazardTabInitializing = true;
    switchHazardTab('fire');
    setTimeout(function(){ window._hazardTabInitializing = false; }, 2000);
    // Re-apply after data loads (markers load async)
    setTimeout(function(){ switchHazardTab(hazardActiveTab); }, 5000);
    setTimeout(function(){ switchHazardTab(hazardActiveTab); }, 12000);
  }

  function destroyHazardMaps(){
    if (lightningMap){ lightningMap.remove(); lightningMap = null; }
    if (hazardMap){ hazardMap.remove(); hazardMap = null; fireMap = null; tornadoMap = null; quakeMap = null; }
    if (bedrockMap){ bedrockMap.remove(); bedrockMap = null; }
    if (lithologyMap){ lithologyMap.remove(); lithologyMap = null; }
    if (stratMap){ stratMap.remove(); stratMap = null; }
    lightningMarkers = [];
    fireMarkers = [];
    quakeMarkers = [];
    tornadoMarkers = [];
    tornadoSevereMarkers = [];
    tornadoOutlookLayers = [];
    window._alertLayerGroup = null;
    window._floodLayerGroup = null;
    window._hazardAlerts = [];
    window._floodGauges = [];
    blitzortungStrikes = [];
    if (blitzortungWs){ try { blitzortungWs.close(); } catch(e){} blitzortungWs = null; }
    if (blitzortungReconnectTimer){ clearTimeout(blitzortungReconnectTimer); blitzortungReconnectTimer = null; }
  }
// ============ LIGHTNING MAP ============
  var blitzortungWs = null;
  var blitzortungReconnectTimer = null;
  var blitzortungStrikes = [];
  var lightningStrikeCount = 0;

  // Lightning now uses Blitzortung iframe - these are no-ops
  function initLightningMap(){
    var iframe = document.getElementById('lightning-iframe');
    if (iframe) {
      iframe.src = 'https://map.blitzortung.org/index.php?interactive=1&NavigationControl=0&FullScreenControl=0&Ede=0&Menu=0&InfoStrike=0&InfoMuted=1&Cookies=0&CookieConsent=1#7/' + LOCATION.lat.toFixed(4) + '/' + LOCATION.lon.toFixed(4);
    }
  }
  function connectBlitzortung(){ }
  function scheduleBlitzReconnect(){ }
  function addLightningStrike(){ }

  // Global toggle function called by buttons
  

  // ============ TORNADO MAP ============
  var tornadoMap = null;
  var tornadoMarkers = [];
  var tornadoReports = [];
  var tornadoCurrentRange = 'today';
  var tornadoSevereMarkers = [];
  var tornadoOutlookLayers = [];
  var tornadoLayerGroup = null;

  function clearTornadoMarkers(){
    if(tornadoLayerGroup) tornadoLayerGroup.clearLayers();
    tornadoMarkers = [];
    tornadoSevereMarkers = [];
    tornadoOutlookLayers.forEach(function(l){ try { tornadoMap.removeLayer(l); } catch(e){} });
    tornadoOutlookLayers = [];
    tornadoReports = [];
  }

  function switchTornadoRange(range){
    tornadoCurrentRange = range;
    // Update tab styles
    var tabs = ['today','48h','7d','1m','6m','1y','forecast'];
    tabs.forEach(function(t){
      var el = document.getElementById('torn-tab-' + t);
      if (!el) return;
      if (t === range){
        if (t === 'forecast'){
          el.style.borderColor = 'rgba(255,165,0,.6)';
          el.style.background = 'rgba(255,100,0,.25)';
          el.style.color = 'rgba(255,200,100,1)';
        } else {
          el.style.borderColor = 'transparent';
          el.style.background = 'rgba(255,140,0,.15)';
          el.style.color = 'rgba(255,140,0,.95)';
        }
      } else {
        if (t === 'forecast'){
          el.style.borderColor = 'rgba(255,165,0,.4)';
          el.style.background = 'rgba(255,100,0,.15)';
          el.style.color = 'rgba(255,180,80,.9)';
        } else {
          el.style.borderColor = 'transparent';
          el.style.background = 'rgba(200,200,210,.25)';
          el.style.color = 'rgba(43,34,244,.65)';
        }
      }
    });
    // Clear and reload
    clearTornadoMarkers();
    if (range === 'forecast'){
      loadSPCForecast();
    } else {
      loadTornadoReports();
      if (range === 'today'){
        loadSPCTornadoOutlook();
        loadSevereReports();
      }
    }
  }
  window.switchTornadoRange = switchTornadoRange;

  function getDaysForRange(range){
    switch(range){
      case 'today': return 1;
      case '48h': return 2;
      case '7d': return 7;
      case '1m': return 30;
      case '6m': return 180;
      case '1y': return 365;
      default: return 1;
    }
  }

  function initTornadoData(){
    if (!hazardMap) return;

    // Dedicated layer group for SPC outlook polygons  only shown on tornado tab
    window._tornadoOutlookGroup = L.layerGroup();
    // Only add to map if tornado tab is active
    if(typeof hazardActiveTab !== 'undefined' && hazardActiveTab === 'tornado'){
      window._tornadoOutlookGroup.addTo(hazardMap);
    }

    checkTornadoLocalZoom();
    loadSPCTornadoOutlook();
    loadSevereReports();
    loadTornadoReports();
  }

  // Keep old name for compat
  function initTornadoMap(){ initTornadoData(); }

  function checkTornadoLocalZoom(){
    if (!tornadoMap) return;
    var url = 'https://api.weather.gov/alerts/active?point=' + LOCATION.lat + ',' + LOCATION.lon;
    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features) return;
      var tornadoAlert = null;
      var severeAlert = null;
      for (var i = 0; i < data.features.length; i++){
        var ev = (data.features[i].properties.event || '').toLowerCase();
        if (ev.indexOf('tornado') >= 0 && ev.indexOf('warning') >= 0){
          tornadoAlert = data.features[i];
          break; // highest priority
        }
        if (ev.indexOf('tornado') >= 0 && ev.indexOf('watch') >= 0){
          tornadoAlert = data.features[i];
        }
        if (ev.indexOf('severe thunderstorm') >= 0 && !severeAlert){
          severeAlert = data.features[i];
        }
      }

      var alertToZoom = tornadoAlert || severeAlert;
      if (!alertToZoom) {
        // Also check SPC outlook for local risk
        checkSPCLocalZoom();
        return;
      }

      // Zoom level based on alert type
      var ev = (alertToZoom.properties.event || '').toLowerCase();
      var zoom = 8; // default for watches
      if (ev.indexOf('warning') >= 0) zoom = 10; // tighter for active warnings

      // If alert has geometry, fit to it
      if (alertToZoom.geometry && alertToZoom.geometry.coordinates){
        try {
          var geoLayer = L.geoJSON(alertToZoom.geometry);
          tornadoMap.fitBounds(geoLayer.getBounds().pad(0.3));
        } catch(e){
          tornadoMap.setView([LOCATION.lat, LOCATION.lon], zoom);
        }
      } else {
        tornadoMap.setView([LOCATION.lat, LOCATION.lon], zoom);
      }

      // Pulse ring removed for cleaner map

    }).catch(function(){});
  }

  function checkSPCLocalZoom(){
    // If SPC has tornado risk >= 5% for user's area, zoom in moderately
    if (!tornadoMap) return;
    var url = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/3/query?where=1%3D1&outFields=*&f=geojson';
    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features) return;
      for (var i = 0; i < data.features.length; i++){
        var label = (data.features[i].properties.LABEL || '').toString();
        var pct = parseFloat(label) || 0;
        if (pct >= 5 && pointInGeoJSON(LOCATION.lat, LOCATION.lon, data.features[i].geometry)){
          tornadoMap.setView([LOCATION.lat, LOCATION.lon], 7);
          return;
        }
      }
    }).catch(function(){});
  }

  function loadSPCTornadoOutlook(){
    if (!tornadoMap) return;
    // Layer 3 = Day 1 Probabilistic Tornado Outlook
    var url = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/3/query?where=1%3D1&outFields=*&f=geojson';
    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features || data.features.length === 0) return;
      L.geoJSON(data, {
        style: function(feature){
          var label = (feature.properties.LABEL || feature.properties.label || '').toString();
          var color, fillOpacity;
          if (label.indexOf('SIGN') >= 0 || label.indexOf('10') >= 0){ color = '#ff1744'; fillOpacity = 0.25; }
          else if (label.indexOf('5') >= 0){ color = '#ff6d00'; fillOpacity = 0.2; }
          else if (label.indexOf('2') >= 0){ color = '#ffd600'; fillOpacity = 0.15; }
          else { color = '#66bb6a'; fillOpacity = 0.1; }
          return { color: color, weight: 2, fillColor: color, fillOpacity: fillOpacity, dashArray: '4 2' };
        },
        onEachFeature: function(feature, layer){
          var p = feature.properties;
          var label = (p.LABEL || p.label || 'General').toString();
          var pct, severity, action;
          if (label.indexOf('SIGN') >= 0) { pct = '10%+'; severity = 'SIGNIFICANT'; action = 'EF2+ tornadoes possible<br>Violent/destructive potential'; }
          else if (label.indexOf('10') >= 0) { pct = '10%'; severity = 'HIGH'; action = 'Tornadoes likely within 25 mi'; }
          else if (label.indexOf('5') >= 0) { pct = '5%'; severity = 'MODERATE'; action = 'Tornadoes possible within 25 mi'; }
          else if (label.indexOf('2') >= 0) { pct = '2%'; severity = 'LOW'; action = 'Isolated tornado threat within 25 mi'; }
          else { pct = label + '%'; severity = 'MARGINAL'; action = 'Weak tornado not ruled out'; }
          var tt = '<div style="min-width:170px;font-size:.5rem;line-height:1.6;">';
          tt += '<div style="font-weight:800;font-size:.55rem;color:#ef4444;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:3px;margin-bottom:3px;">SPC TORNADO ALERT</div>';
          tt += '<div><b>Probability:</b> ' + pct + '</div>';
          tt += '<div><b>Severity:</b> ' + severity + '</div>';
          tt += '<div><b>Threat:</b> ' + action + '</div>';
          tt += '<div style="font-size:.42rem;opacity:.6;margin-top:2px;">Day 1  Valid today  Storm Prediction Center</div>';
          tt += '</div>';
          layer.bindTooltip(tt, {sticky: true});
          layer.on('add', function(){ if(layer._path) layer._path.classList.add('spc-pulse'); });
        }
      }).addTo(window._tornadoOutlookGroup || tornadoMap);
    }).catch(function(){});

    // Also load Day 1 Significant Tornado (layer 2)
    var sigUrl = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/2/query?where=1%3D1&outFields=*&f=geojson';
    fetch(sigUrl).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features || data.features.length === 0) return;
      L.geoJSON(data, {
        style: function(){
          return { color: '#d50000', weight: 3, fillColor: '#d50000', fillOpacity: 0.15, dashArray: '6 3' };
        },
        onEachFeature: function(feature, layer){
          layer.bindTooltip('<span style="font-size:.55rem;"><b> SIGNIFICANT TORNADO RISK</b><br>EF2+ potential</span>', {sticky: true});
        }
      }).addTo(window._tornadoOutlookGroup || tornadoMap);
    }).catch(function(){});
  }

  function loadSevereReports(){
    if (!tornadoMap) return;
    // Load today's hail reports
    fetch('https://www.spc.noaa.gov/climo/reports/today_hail.csv')
      .then(function(r){ return r.text(); })
      .then(function(csv){
        var lines = csv.trim().split('\n');
        for (var i = 1; i < lines.length; i++){
          var parts = lines[i].split(',');
          if (parts.length < 7) continue;
          var lat = parseFloat(parts[5]);
          var lon = parseFloat(parts[6]);
          var size = parts[1].trim(); // hail size in inches
          if (isNaN(lat) || isNaN(lon)) continue;
          var sizeNum = parseFloat(size) || 1;
          L.circleMarker([lat, lon], {
            radius: Math.min(3 + sizeNum * 1.5, 8),
            fillColor: '#00e5ff',
            fillOpacity: 0.6,
            color: '#fff',
            weight: 0.5
          }).addTo(tornadoLayerGroup||tornadoMap).bindTooltip(
            '<div class="hz-card-head"><div class="hz-accent" style="background:#00e5ff;"></div><span style="color:#00e5ff;">HAIL REPORT</span></div>' +
            '<div class="hz-card-row"><span class="hz-label">Size</span><span class="hz-val" style="color:#00e5ff;">' + size + '"</span></div>' +
            '<div class="hz-card-row"><span class="hz-label">Location</span><span class="hz-val">' + parts[2].trim() + ', ' + parts[4].trim() + '</span></div>' +
            '<div class="hz-card-footer">SPC Storm Report  Today</div>',
            { className: 'hz-tooltip' }
          );
        }
      }).catch(function(){});

    // Load today's wind reports
    fetch('https://www.spc.noaa.gov/climo/reports/today_wind.csv')
      .then(function(r){ return r.text(); })
      .then(function(csv){
        var lines = csv.trim().split('\n');
        for (var i = 1; i < lines.length; i++){
          var parts = lines[i].split(',');
          if (parts.length < 7) continue;
          var lat = parseFloat(parts[5]);
          var lon = parseFloat(parts[6]);
          var speed = parts[1].trim(); // knots
          if (isNaN(lat) || isNaN(lon)) continue;
          L.circleMarker([lat, lon], {
            radius: 3,
            fillColor: '#76ff03',
            fillOpacity: 0.5,
            color: '#fff',
            weight: 0.5
          }).addTo(tornadoLayerGroup||tornadoMap).bindTooltip(
            '<div class="hz-card-head"><div class="hz-accent" style="background:#76ff03;"></div><span style="color:#76ff03;">WIND REPORT</span></div>' +
            '<div class="hz-card-row"><span class="hz-label">Speed</span><span class="hz-val" style="color:#76ff03;">' + speed + ' kt</span></div>' +
            '<div class="hz-card-row"><span class="hz-label">Location</span><span class="hz-val">' + parts[2].trim() + ', ' + parts[4].trim() + '</span></div>' +
            '<div class="hz-card-footer">SPC Storm Report  Today</div>',
            { className: 'hz-tooltip' }
          );
        }
      }).catch(function(){});
  }

  function parseTornadoCSV(csv){
    var lines = csv.trim().split('\n');
    var reports = [];
    // Skip header line
    for (var i = 1; i < lines.length; i++){
      var line = lines[i];
      if (!line.trim()) continue;
      // Format: Time,F_Scale,Location,County,State,Lat,Lon,Comments
      var parts = line.split(',');
      if (parts.length < 7) continue;
      var time = parts[0].trim();
      var scale = parts[1].trim();
      var location = parts[2].trim();
      var county = parts[3].trim();
      var state = parts[4].trim();
      var lat = parseFloat(parts[5]);
      var lon = parseFloat(parts[6]);
      var comment = parts.slice(7).join(',').trim();
      if (!isNaN(lat) && !isNaN(lon)){
        reports.push({
          time: time,
          scale: scale,
          location: location,
          county: county,
          state: state,
          lat: lat,
          lon: lon,
          comment: comment
        });
      }
    }
    return reports;
  }

  function efColor(scale){
    switch(scale){
      case 'EF0': return '#66bb6a';
      case 'EF1': return '#fdd835';
      case 'EF2': return '#ffa726';
      case 'EF3': return '#ef5350';
      case 'EF4': return '#ab47bc';
      case 'EF5': return '#ec407a';
      default: return '#90caf9'; // UNK
    }
  }

  function efRadius(scale){
    switch(scale){
      case 'EF0': return 5;
      case 'EF1': return 6;
      case 'EF2': return 8;
      case 'EF3': return 10;
      case 'EF4': return 12;
      case 'EF5': return 14;
      default: return 5;
    }
  }

  function plotTornadoes(reports, dateLabel){
    if (!tornadoMap) return;
    reports.forEach(function(r){
      var color = efColor(r.scale);
      var radius = efRadius(r.scale);
      var marker = L.circleMarker([r.lat, r.lon], {
        radius: radius,
        fillColor: color,
        fillOpacity: 0.95,
        color: '#000',
        weight: 2
      }).addTo(tornadoLayerGroup||tornadoMap);
      marker.bindTooltip(
        '<div class="hz-card-head"><div class="hz-accent" style="background:' + color + ';"></div><span style="color:' + color + ';">TORNADO' + (r.scale !== 'UNK' ? '  ' + r.scale : '') + '</span></div>' +
        '<div class="hz-card-row"><span class="hz-label">Location</span><span class="hz-val">' + r.location + ', ' + r.state + '</span></div>' +
        '<div class="hz-card-row"><span class="hz-label">County</span><span class="hz-val">' + r.county + '</span></div>' +
        '<div class="hz-card-row"><span class="hz-label">Time</span><span class="hz-val">' + r.time + ' UTC</span></div>' +
        (r.comment ? '<div style="margin-top:4px;font-size:8.5px;color:rgba(255,255,255,.4);max-width:180px;line-height:1.3;">' + r.comment.substring(0,120) + '</div>' : '') +
        '<div class="hz-card-footer">' + dateLabel + '  SPC</div>',
        {className: 'hz-tooltip'}
      );
      tornadoMarkers.push(marker);
    });
  }

  function loadTornadoReports(){
    if(!tornadoLayerGroup && tornadoMap){
      tornadoLayerGroup = L.layerGroup().addTo(tornadoMap);
    }
    var statusEl = document.getElementById('tornado-status-pill');
    var liveEl = document.getElementById('tornado-live');
    var yearCountEl = document.getElementById('tornado-year-count');
    var listEl = document.getElementById('hz-pill-tornado-list');
    var totalCount = 0;
    var allReports = [];
    var numDays = getDaysForRange(tornadoCurrentRange);
    var rangeLabel = tornadoCurrentRange.toUpperCase();

    // Generate date strings
    var dates = [];
    var now = new Date();
    for (var d = 0; d < numDays; d++){
      var dt = new Date(now);
      dt.setDate(dt.getDate() - d);
      var yy = String(dt.getFullYear()).slice(-2);
      var mm = String(dt.getMonth()+1).padStart(2,'0');
      var dd = String(dt.getDate()).padStart(2,'0');
      dates.push({str: yy+mm+dd, label: (dt.getMonth()+1)+'/'+dt.getDate()+'/'+dt.getFullYear()});
    }

    var fetched = 0;
    dates.forEach(function(dateObj){
      var url = 'https://www.spc.noaa.gov/climo/reports/' + dateObj.str + '_rpts_torn.csv';
      // Today uses a different URL
      if (dateObj.str === dates[0].str){
        url = 'https://www.spc.noaa.gov/climo/reports/today_torn.csv';
      }
      fetch(url).then(function(r){ return r.text(); }).then(function(csv){
        var reports = parseTornadoCSV(csv);
        totalCount += reports.length;
        reports.forEach(function(r){ r.dateLabel = dateObj.label; });
        allReports = allReports.concat(reports);
        plotTornadoes(reports, dateObj.label);
        fetched++;
        if (fetched === dates.length){
          finalizeTornado(allReports, totalCount, statusEl, liveEl, yearCountEl, listEl, rangeLabel);
        }
      }).catch(function(){
        fetched++;
        if (fetched === dates.length){
          finalizeTornado(allReports, totalCount, statusEl, liveEl, yearCountEl, listEl, rangeLabel);
        }
      });
    });

    // Also fetch yearly total from SPC filtered reports (Jan 1 to now)
    loadTornadoYearCount(yearCountEl);
  }

  var tornadoTopReports = [];

  function efRank(scale){
    switch(scale){
      case 'EF5': return 6;
      case 'EF4': return 5;
      case 'EF3': return 4;
      case 'EF2': return 3;
      case 'EF1': return 2;
      case 'EF0': return 1;
      default: return 0;
    }
  }

  function loadTornadoYearCount(yearCountEl){
    var now = new Date();
    var totalYear = 0;
    tornadoTopReports = [];
    var totalMonths = now.getMonth() + 1;

    for (var m = 1; m <= totalMonths; m++){
      var daysInMonth = new Date(2026, m, 0).getDate();
      var endDay = (m === totalMonths) ? now.getDate() : daysInMonth;
      
      for (var d = 1; d <= endDay; d++){
        var yy = '26';
        var mm = String(m).padStart(2,'0');
        var dd = String(d).padStart(2,'0');
        var dateStr = yy + mm + dd;
        var dateLabel = m + '/' + d + '/2026';
        var today = String(now.getFullYear()).slice(-2) + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
        
        var url;
        if (dateStr === today){
          url = 'https://www.spc.noaa.gov/climo/reports/today_torn.csv';
        } else {
          url = 'https://www.spc.noaa.gov/climo/reports/' + dateStr + '_rpts_torn.csv';
        }
        
        (function(u, dl){
          fetch(u).then(function(r){ return r.text(); }).then(function(csv){
            var reports = parseTornadoCSV(csv);
            totalYear += reports.length;
            if (yearCountEl) yearCountEl.textContent = totalYear.toLocaleString();
            // Update status pill year portion
            var sp = document.getElementById('tornado-status-pill');
            if (sp && sp.innerHTML.indexOf('2026:') >= 0){
              sp.innerHTML = sp.innerHTML.replace(/2026: [^<]+/, '2026: ' + totalYear.toLocaleString());
            }
            // Track biggest
            reports.forEach(function(r){
              r.dateLabel = dl;
              var rank = efRank(r.scale);
              if (tornadoTopReports.length < 5){
                tornadoTopReports.push(r);
                tornadoTopReports.sort(function(a,b){ return efRank(b.scale) - efRank(a.scale); });
              } else if (rank > efRank(tornadoTopReports[4].scale)){
                tornadoTopReports[4] = r;
                tornadoTopReports.sort(function(a,b){ return efRank(b.scale) - efRank(a.scale); });
              }
            });
            updateTop5Dropdown();
          }).catch(function(){});
        })(url, dateLabel);
      }
    }
  }

  function updateTop5Dropdown(){
    var list = document.getElementById('hz-pill-tornado-list');
    if (!list) return;
    if (tornadoTopReports.length === 0){
      list.innerHTML = '<div style="padding:6px;color:#888;font-size:.55rem;text-align:center;">No rated tornadoes yet</div>';
      return;
    }
    list.innerHTML = '<div style="padding:4px 6px;font-size:.5rem;font-weight:700;color:#ff6b6b;opacity:.7;text-transform:uppercase;letter-spacing:.05em;">Top 5 Strongest  2026</div>';
    tornadoTopReports.forEach(function(r, i){
      var color = efColor(r.scale);
      var item = document.createElement('div');
      item.style.cssText = 'padding:4px 6px;border-top:1px solid rgba(255,255,255,.06);cursor:pointer;font-size:.55rem;color:#eee;display:flex;align-items:center;gap:5px;';
      item.innerHTML = '<span style="font-weight:800;color:' + color + ';min-width:28px;">' + (r.scale === 'UNK' ? '?' : r.scale) + '</span>' +
        '<span style="flex:1;opacity:.85;">' + r.location + ', ' + r.state + '</span>' +
        '<span style="opacity:.4;font-size:.48rem;">' + r.dateLabel + '</span>';
      item.onclick = function(){ if (tornadoMap) tornadoMap.setView([r.lat, r.lon], 10); };
      list.appendChild(item);
    });
  }

  function finalizeTornado(reports, count, statusEl, liveEl, yearCountEl, listEl, rangeLabel){
    window._tornadoReports = reports;
    window._tornadoCount = count;
    updateHazardBadges(); try{updateUnifiedPills();}catch(e){}
    if (statusEl){
      var yearText = yearCountEl ? yearCountEl.textContent : '--';
      statusEl.innerHTML = count + ' TORNADOES (' + rangeLabel + ')  <span style="color:#ff6b6b;">2026: ' + yearText + '</span>';
      // Also update unified pill
      var uPill = document.getElementById('hz-pill-tornado');
      if(uPill){
        var tHead = uPill.querySelector('#hz-pill-tornado-head');
        if(tHead) tHead.innerHTML = '<div style="font-size:.55rem;font-weight:800;color:#f87171;">' + count + ' TORNADOES</div>' +
          '<div style="font-size:.38rem;color:rgba(255,255,255,.5);margin-top:1px;">' + rangeLabel + '  2026: ' + yearText + '</div>';
      }
    }
    if (liveEl) liveEl.textContent = count > 0 ? ' LIVE' : ' QUIET';
    if (liveEl && count === 0) liveEl.style.color = '#888';

    // Populate list
    if (listEl){
      listEl.innerHTML = '';
      if (reports.length === 0){
        listEl.innerHTML = '<div style="padding:8px;color:#888;font-size:.55rem;text-align:center;">No tornado reports (' + rangeLabel + ')</div>';
      } else {
        listEl.innerHTML = '<div style="padding:4px 6px;font-size:.5rem;font-weight:700;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.05em;">Recent Reports  ' + rangeLabel + '</div>';
        // Sort by most recent first
        reports.sort(function(a,b){ return (b.dateLabel + b.time).localeCompare(a.dateLabel + a.time); });
        reports.slice(0, 30).forEach(function(r){
          var color = efColor(r.scale);
          var item = document.createElement('div');
          item.style.cssText = 'padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer;font-size:.62rem;color:#eee;display:flex;align-items:center;gap:6px;';
          item.innerHTML = '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + color + ';flex-shrink:0;"></span>' +
            '<span style="flex:1;"><b>' + (r.scale === 'UNK' ? 'Tornado' : r.scale) + '</b>  ' + r.location + ', ' + r.state + '<br><span style="opacity:.5">' + r.dateLabel + ' ' + r.time + ' UTC</span></span>';
          item.onclick = function(){
            if (tornadoMap) tornadoMap.setView([r.lat, r.lon], 10);
          };
          listEl.appendChild(item);
        });
      }
    }
  }

  // ============ SPC FORECAST MODE ============
  var spcBaseUrl = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/';

  // Hide outlook polygons if not currently on tornado tab
  function hideOutlookIfNotTornado(layer){
    if(typeof hazardActiveTab !== 'undefined' && hazardActiveTab !== 'tornado'){
      if(layer.eachLayer) layer.eachLayer(function(sub){ if(sub._path){ sub._path.style.display='none'; sub._path.style.visibility='hidden'; } });
      else if(layer._path){ layer._path.style.display='none'; layer._path.style.visibility='hidden'; }
    }
  }

  function loadSPCForecast(){
    if (!tornadoMap) return;
    var statusEl = document.getElementById('tornado-status-pill');
    if (statusEl) statusEl.textContent = 'SPC FORECAST: Loading...';

    var catColors = {
      'TSTM': {color:'#76ff03', fill:0.08},
      'MRGL': {color:'#66bb6a', fill:0.12},
      'SLGT': {color:'#fdd835', fill:0.18},
      'ENH':  {color:'#ffa726', fill:0.22},
      'MDT':  {color:'#ef5350', fill:0.28},
      'HIGH': {color:'#ec407a', fill:0.35}
    };

    var tornProb = {
      '0.02': {color:'#66bb6a', fill:0.12},
      '0.05': {color:'#fdd835', fill:0.18},
      '0.10': {color:'#ffa726', fill:0.22},
      '0.15': {color:'#ef5350', fill:0.28},
      '0.30': {color:'#ab47bc', fill:0.32},
      '0.45': {color:'#ec407a', fill:0.38},
      '0.60': {color:'#d50000', fill:0.42}
    };

    // Day 1 Categorical (layer 1)
    fetchSPCLayer(1, function(data){
      var layer = L.geoJSON(data, {
        style: function(f){
          var cat = (f.properties.LABEL || f.properties.label || '').toUpperCase().trim();
          var s = catColors[cat] || {color:'#aaa', fill:0.1};
          return {color:s.color, weight:1.5, fillColor:s.color, fillOpacity:s.fill, dashArray:'6 3'};
        },
        onEachFeature: function(f,l){
          var cat = (f.properties.LABEL || f.properties.label || '').toUpperCase().trim();
          var catDesc = {TSTM:'Thunderstorms expected',MRGL:'Marginal  isolated severe',SLGT:'Slight  scattered severe',ENH:'Enhanced  numerous severe',MDT:'Moderate  widespread severe likely',HIGH:'High  rare, intense severe outbreak'};
          var tt = '<div style="min-width:160px;font-size:.5rem;line-height:1.6;">';
          tt += '<div style="font-weight:800;font-size:.55rem;color:#ef4444;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:3px;margin-bottom:3px;">SPC SEVERE WEATHER ALERT</div>';
          tt += '<div><b>Risk:</b> ' + cat + '</div>';
          tt += '<div><b>Means:</b> ' + (catDesc[cat] || 'Severe weather possible') + '</div>';
          tt += '<div style="font-size:.42rem;opacity:.6;margin-top:2px;">Day 1  Valid today</div>';
          tt += '</div>';
          l.bindTooltip(tt,{sticky:true}); l.on("add",function(){if(l._path)l._path.classList.add("spc-pulse");});
        }
      }).addTo(window._tornadoOutlookGroup || tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 1 Tornado Probability (layer 3)
    fetchSPCLayer(3, function(data){
      var layer = L.geoJSON(data, {
        style: function(f){
          var label = (f.properties.LABEL || f.properties.label || '').toString();
          var pct = parseFloat(label) || 0;
          var key = (pct/100).toFixed(2);
          var s = tornProb[key] || {color:'#ffa726', fill:0.15};
          return {color:s.color, weight:2, fillColor:s.color, fillOpacity:s.fill};
        },
        onEachFeature: function(f,l){
          var label = (f.properties.LABEL || f.properties.label || '').toString();
          var pct, severity, action;
          if (label.indexOf('SIGN') >= 0) { pct = '10%+'; severity = 'SIGNIFICANT'; action = 'EF2+ tornadoes possible'; }
          else { var n = parseFloat(label)||0; pct = n+'%'; severity = n>=10?' HIGH':n>=5?'MODERATE':'LOW'; action = 'Tornadoes within 25 mi'; }
          var tt = '<div style="min-width:160px;font-size:.5rem;line-height:1.6;">';
          tt += '<div style="font-weight:800;font-size:.55rem;color:#ef4444;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:3px;margin-bottom:3px;">SPC TORNADO ALERT  Day 1</div>';
          tt += '<div><b>Probability:</b> ' + pct + '</div>';
          tt += '<div><b>Level:</b> ' + severity + '</div>';
          tt += '<div><b>Threat:</b> ' + action + '</div>';
          tt += '</div>';
          l.bindTooltip(tt,{sticky:true}); l.on("add",function(){if(l._path)l._path.classList.add("spc-pulse");});
        }
      }).addTo(window._tornadoOutlookGroup || tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 1 Significant Tornado (layer 2)
    fetchSPCLayer(2, function(data){
      var layer = L.geoJSON(data, {
        style: function(){
          return {color:'#d50000', weight:3, fillColor:'#d50000', fillOpacity:0.15, dashArray:'4 2'};
        },
        onEachFeature: function(f,l){
          l.bindTooltip('<span style="font-size:.5rem;"><b> SIGNIFICANT TORNADO</b><br>EF2+ potential</span>',{sticky:true});
        }
      }).addTo(window._tornadoOutlookGroup || tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 2 Tornado Probability (layer 11)
    fetchSPCLayer(11, function(data){
      var layer = L.geoJSON(data, {
        style: function(f){
          var label = (f.properties.LABEL || f.properties.label || '').toString();
          return {color:'#ce93d8', weight:1.5, fillColor:'#ce93d8', fillOpacity:0.1, dashArray:'8 4'};
        },
        onEachFeature: function(f,l){
          var label = f.properties.LABEL || f.properties.label || '';
          var pct2=label.indexOf('SIGN')>=0?'10%+':label+'%'; var sev2=label.indexOf('SIGN')>=0?'SIGNIFICANT':(parseFloat(label)>=5?'MODERATE':'LOW'); l.bindTooltip('<div style="min-width:160px;font-size:.5rem;line-height:1.6;"><div style="font-weight:800;font-size:.55rem;color:#ef4444;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:3px;margin-bottom:3px;">SPC TORNADO ALERT  Day 2</div><div><b>Probability:</b> '+pct2+'</div><div><b>Level:</b> '+sev2+'</div><div style="font-size:.42rem;opacity:.6;margin-top:2px;">Day 2  Valid tomorrow</div></div>',{sticky:true}); l.on("add",function(){if(l._path)l._path.classList.add("spc-pulse");});
        }
      }).addTo(window._tornadoOutlookGroup || tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 2 Significant Tornado (layer 10)
    fetchSPCLayer(10, function(data){
      var layer = L.geoJSON(data, {
        style: function(){
          return {color:'#9c27b0', weight:2.5, fillColor:'#9c27b0', fillOpacity:0.1, dashArray:'4 2'};
        },
        onEachFeature: function(f,l){
          l.bindTooltip('<div style="min-width:160px;font-size:.5rem;line-height:1.6;"><div style="font-weight:800;font-size:.55rem;color:#ef4444;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:3px;margin-bottom:3px;">SPC SIGNIFICANT TORNADO ALERT  Day 2</div><div><b>Probability:</b> 10%+</div><div><b>Level:</b> SIGNIFICANT</div><div><b>Threat:</b> EF2+ tornadoes possible</div><div style="font-size:.42rem;opacity:.6;margin-top:2px;">Day 2  Valid tomorrow</div></div>',{sticky:true}); l.on("add",function(){if(l._path)l._path.classList.add("spc-pulse");});
        }
      }).addTo(window._tornadoOutlookGroup || tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 3 Probabilistic (layer 19)
    fetchSPCLayer(19, function(data){
      var layer = L.geoJSON(data, {
        style: function(){
          return {color:'#4fc3f7', weight:1, fillColor:'#4fc3f7', fillOpacity:0.06, dashArray:'10 5'};
        },
        onEachFeature: function(f,l){
          var label = f.properties.LABEL || f.properties.label || '';
          var pct3=label.indexOf('SIGN')>=0?'SIGNIFICANT':label+'%'; l.bindTooltip('<div style="min-width:160px;font-size:.5rem;line-height:1.6;"><div style="font-weight:800;font-size:.55rem;color:#ef4444;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:3px;margin-bottom:3px;">SPC SEVERE ALERT  Day 3</div><div><b>Probability:</b> '+pct3+'</div><div style="font-size:.42rem;opacity:.6;margin-top:2px;">Day 3</div></div>',{sticky:true}); l.on("add",function(){if(l._path)l._path.classList.add("spc-pulse");});
        }
      }).addTo(window._tornadoOutlookGroup || tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Days 4-8 Probabilistic (layers 21-25)
    for (var day = 4; day <= 8; day++){
      (function(d){
        fetchSPCLayer(17 + d, function(data){
          var layer = L.geoJSON(data, {
            style: function(){
              var op = Math.max(0.03, 0.08 - (d-4)*0.01);
              return {color:'#90a4ae', weight:1, fillColor:'#90a4ae', fillOpacity:op, dashArray:'12 6'};
            },
            onEachFeature: function(f,l){
              var label = f.properties.LABEL || f.properties.label || '';
              var pctX=label.indexOf('SIGN')>=0?'SIGNIFICANT':label+'%'; l.bindTooltip('<div style="min-width:140px;font-size:.5rem;line-height:1.6;"><div style="font-weight:800;font-size:.55rem;color:#ef4444;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:3px;margin-bottom:3px;">SPC SEVERE ALERT  Day '+d+'</div><div><b>Probability:</b> '+pctX+'</div></div>',{sticky:true}); l.on("add",function(){if(l._path)l._path.classList.add("spc-pulse");});
            }
          }).addTo(window._tornadoOutlookGroup || tornadoMap);
          tornadoOutlookLayers.push(layer);
        });
      })(day);
    }

    // Update status when done
    setTimeout(function(){
      if (statusEl) statusEl.textContent = ' SPC Days 1-8 Forecast';
    }, 2000);
  }

  function fetchSPCLayer(layerId, callback){
    var url = spcBaseUrl + layerId + '/query?where=1%3D1&outFields=*&f=geojson';
    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      if (data.features && data.features.length > 0) callback(data);
    }).catch(function(){});
  }

  // ============ FIRE MAP ============
  var smokeLayer = null;
  var smokeVisible = true;
  var fireLabelsLayer = null;
  var fireLabelsVisible = false;
  var aqiStations = [];
  var aqiPillVisible = false;
  
  function initFireData(){
    if (!hazardMap) return;

    // Fire legend + smoke status (combined Leaflet control)
    var fireLegend = L.control({ position: 'bottomleft' });
    fireLegend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'fire-legend');
      div.style.cssText = 'background:rgba(0,0,0,.7); backdrop-filter:blur(8px); padding:5px 8px; border-radius:6px; font-size:8px; font-weight:600; font-family:system-ui,sans-serif; box-shadow:0 2px 8px rgba(0,0,0,.3); pointer-events:auto; cursor:pointer;';
      div.onclick = function(){ if(typeof openSmokeDetail === 'function') openSmokeDetail(); };
      div.innerHTML =
        '<div id="fire-legend-smoke" style="margin-bottom:3px;padding-bottom:3px;border-bottom:1px solid rgba(255,255,255,.08);font-size:8px;line-height:1.3;"></div>' +
        '<div style="display:flex; flex-direction:column; gap:1px;">' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">&lt;1K</span><span style="width:5px;height:5px;border-radius:50%;background:#fbbf24;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">1K</span><span style="width:6px;height:6px;border-radius:50%;background:#f97316;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">10K</span><span style="width:7px;height:7px;border-radius:50%;background:#dc2626;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">50K+</span><span style="width:8px;height:8px;border-radius:50%;background:#7f1d1d;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px; margin-top:2px; border-top:1px solid rgba(255,255,255,.1); padding-top:2px;"><span style="color:#4ade80;font-size:7px;">Rx</span><span style="width:5px;height:5px;border-radius:50%;background:#4ade80;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#fb923c;font-size:7px;">Sat</span><span style="width:4px;height:4px;border-radius:50%;background:#fb923c;opacity:.6;"></span></div>' +
        '</div>';
      return div;
    };
    fireLegend.addTo(hazardMap);

    // Load smoke and fire data
    loadSmokeLayer();
    loadHRRRSmokeOverlay();
    loadFireData();
    setInterval(loadFireData, 24 * 60 * 60 * 1000);
  }

  // Keep old function name for backward compat
  function initFireMap(){ initFireData(); }

  function loadFireData(){
    var statusPill = document.getElementById("fire-status-pill");

    // 
    // MULTI-SOURCE FIRE DATA LOADER
    // Source 1: NIFC (US wildfires via ArcGIS)
    // Source 2: CWFIS (Canadian wildfires via NRCan CSV)
    // Source 3: NASA FIRMS (VIIRS satellite hotspots, N. America)
    // All sources merged into window._activeFires with country tag
    // 

    // Clear old markers
    if(window._fireLayerGroup) window._fireLayerGroup.clearLayers();
    fireMarkers = [];

    var allFires = [];
    var sourcesLoaded = 0;
    var totalSources = 3;

    function onSourceComplete() {
      sourcesLoaded++;
      if (sourcesLoaded < totalSources) return;

      //  All sources loaded  merge and display 
      var rxCount = allFires.filter(function(f){ var t = (f.properties.IncidentTypeCategory || f.properties.IncidentType || '').toString().toUpperCase(); return t.indexOf('RX') >= 0 || t.indexOf('PRESCRIBED') >= 0 || t.indexOf('USE') >= 0; }).length;
      var usCount = allFires.filter(function(f){ return f.properties._country === 'US'; }).length;
      var caCount = allFires.filter(function(f){ return f.properties._country === 'CA'; }).length;
      var satCount = allFires.filter(function(f){ return f.properties._country === 'SAT'; }).length;
      var wfCount = usCount - rxCount;
      // Track satellite-only Canadian detections separately for UI context
      var caSatCount = allFires.filter(function(f){ return f.properties._country === 'CA' && f.properties._satellite; }).length;
      window._caSatOnlyCount = caSatCount;

      allFires.forEach(function(fire) {
        var coords = fire.geometry && fire.geometry.coordinates;
        var props = fire.properties || {};
        if (!coords) return;

        var lat = coords[1], lon = coords[0];
        var name = props.IncidentName || props.FireName || props._name || 'Unknown';
        var acres = props.DailyAcres || props.GISAcres || props._acres || 0;
        var contained = props.PercentContained || props._contained || 0;
        var country = props._country || 'US';
        var fireType = (props.IncidentTypeCategory || props.IncidentType || '').toString().toUpperCase();
        var fireCause = (props.FireCause || '').toString();
        var isPrescribed = fireType.indexOf('RX') >= 0 || fireType.indexOf('PRESCRIBED') >= 0 || fireType.indexOf('USE') >= 0;

        var dLat = lat - LOCATION.lat, dLon = lon - LOCATION.lon;
        var dist = Math.sqrt(dLat * dLat + dLon * dLon) * 69;

        // Size/color by acres + country distinction + prescribed vs wildfire
        var radius, color;
        if (isPrescribed) {
          // Prescribed/controlled burns: green tones
          if (acres >= 10000) { radius = 5.5; color = '#15803d'; }
          else if (acres >= 1000) { radius = 4; color = '#22c55e'; }
          else { radius = 2.5; color = '#4ade80'; }
        } else if (country === 'CA') {
          // Canadian fires: red tones with maple leaf distinction
          if (acres >= 50000) { radius = 7; color = '#991b1b'; }
          else if (acres >= 10000) { radius = 5.5; color = '#b91c1c'; }
          else if (acres >= 1000) { radius = 4; color = '#ef4444'; }
          else { radius = 2.5; color = '#f87171'; }
        } else if (country === 'SAT') {
          // FIRMS satellite hotspots: small orange dots
          radius = 1.8; color = '#fb923c';
        } else {
          // US fires: existing orange/amber scheme
          if (acres >= 50000) { radius = 7; color = '#7f1d1d'; }
          else if (acres >= 10000) { radius = 5.5; color = '#dc2626'; }
          else if (acres >= 1000) { radius = 4; color = '#f97316'; }
          else { radius = 2.5; color = '#fbbf24'; }
        }

        var marker = L.circleMarker([lat, lon], {
          radius: radius,
          fillColor: color,
          fillOpacity: country === 'SAT' ? 0.6 : 0.85,
          color: country === 'CA' ? '#fecaca' : '#fff',
          weight: country === 'CA' ? 1.5 : 1
        });
        if(window._fireLayerGroup) window._fireLayerGroup.addLayer(marker);
        else marker.addTo(fireMap);

        var acresStr = acres > 0 ? (props._unit === 'ha' ? acres.toLocaleString() + ' ha (' + Math.round(acres * 2.471).toLocaleString() + ' acres)' : acres.toLocaleString() + ' acres') : 'Size unknown';
        var typeLabel = isPrescribed ? 'PRESCRIBED BURN' : (country === 'SAT' ? 'THERMAL DETECTION' : 'WILDFIRE');
        var accentColor = isPrescribed ? '#4ade80' : country === 'SAT' ? '#fb923c' : '#f97316';

        var fHtml = '<div class="hz-card-head"><div class="hz-accent" style="background:'+accentColor+';"></div><span style="color:'+accentColor+';">'+typeLabel+'</span></div>';
        fHtml += '<div class="hz-card-row"><span class="hz-label">Name</span><span class="hz-val" style="color:#fff;">'+name+'</span></div>';
        fHtml += '<div class="hz-card-row"><span class="hz-label">Size</span><span class="hz-val">'+acresStr+'</span></div>';
        if(contained > 0) fHtml += '<div class="hz-card-row"><span class="hz-label">Contained</span><span class="hz-val" style="color:'+(contained >= 80 ? '#4ade80' : contained >= 40 ? '#eab308' : '#ef4444')+';">'+contained+'%</span></div>';
        if(props._status) fHtml += '<div class="hz-card-row"><span class="hz-label">Status</span><span class="hz-val">'+props._status+'</span></div>';
        if(fireCause) fHtml += '<div class="hz-card-row"><span class="hz-label">Cause</span><span class="hz-val">'+fireCause+'</span></div>';

        if (country === 'SAT') {
          fHtml += '<div style="margin-top:6px;padding:4px 6px;background:rgba(251,146,60,.08);border-radius:4px;border-left:2px solid #fb923c;font-size:8.5px;color:rgba(255,255,255,.5);line-height:1.4;">Unconfirmed  heat detected by NASA VIIRS that does not match agency-reported fires</div>';
          if(props._frp > 0) fHtml += '<div class="hz-card-row"><span class="hz-label">FRP</span><span class="hz-val">'+Math.round(props._frp)+' MW</span></div>';
        }

        var src = country === 'CA' ? (props._satellite ? 'NASA FIRMS' : 'CWFIS/NRCan') : country === 'SAT' ? 'NASA FIRMS VIIRS' : 'NIFC';
        fHtml += '<div class="hz-card-footer">Source: '+src+'</div>';
        marker.bindPopup(fHtml, { closeButton: false, className: 'hz-popup', maxWidth: 260 });

        fireMarkers.push(marker);
      });

      // Update status pill
      if (statusPill) {
        var total = allFires.length;
        var total = usCount + caCount + satCount;
        var pillText = total.toLocaleString() + ' ACTIVE FIRES';
        var details = [];
        if (wfCount > 0) details.push(wfCount + ' WILDFIRE');
        if (rxCount > 0) details.push(rxCount + ' PRESCRIBED');
        if (caCount > 0) details.push(caCount + ' CA');
        if (satCount > 0) details.push(satCount + ' UNCONFIRMED');
        if (details.length > 1) pillText += ' (' + details.join('  ') + ')';
        if(statusPill){
          statusPill.textContent = pillText;
          var hasLarge = allFires.some(function(f) { return (f.properties.DailyAcres || f.properties.GISAcres || f.properties._acres || 0) > 1000; });
          statusPill.style.color = caCount > 5 || hasLarge ? '#dc2626' : total > 0 ? '#f97316' : '#22c55e';
        }
      }

      // Store globally
      window._activeFires = allFires;
      updateHazardBadges(); try{updateUnifiedPills();}catch(e){}

      // Run smoke intelligence engine
      setTimeout(buildSmokeIntelligence, 500);

      // Create smoke heatmap
      createSmokeHeatmap();

      // Build top fires dropdown (combined US + CA, sorted by size)
      buildFireDropdown(allFires);

      console.log('Fire data loaded: ' + usCount + ' US, ' + caCount + ' CA, ' + satCount + ' FIRMS hotspots');
    }

    //  SOURCE 1: NIFC (US) 
    var nifcUrl = "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/USA_Wildfires_v1/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=geojson";
    fetchWithTimeout(nifcUrl, null, 15000)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var fires = data && data.features || [];
        fires.forEach(function(f) {
          if (f.properties) f.properties._country = 'US';
        });
        allFires = allFires.concat(fires);
        onSourceComplete();
      })
      .catch(function(err) { console.log('NIFC error:', err); onSourceComplete(); });

    //  SOURCE 2: CWFIS (Canada) 
    var cwfisUrl = "https://cwfis.cfs.nrcan.gc.ca/downloads/activefires/activefires.csv";
    fetchWithTimeout(cwfisUrl, null, 15000)
      .then(function(r) { return r.text(); })
      .then(function(csvText) {
        var lines = csvText.trim().split('\n');
        if (lines.length < 2) { onSourceComplete(); return; }
        var headers = lines[0].split(',');
        var latIdx = headers.indexOf('lat');
        var lonIdx = headers.indexOf('lon');
        var nameIdx = headers.indexOf('firename');
        var sizeIdx = headers.indexOf('hectares');
        var statusIdx = headers.indexOf('stage_of_control');
        var agencyIdx = headers.indexOf('agency');
        var startIdx = headers.indexOf('startdate');

        if (latIdx < 0) latIdx = headers.indexOf('latitude');
        if (lonIdx < 0) lonIdx = headers.indexOf('longitude');
        if (sizeIdx < 0) sizeIdx = headers.indexOf('ha');
        if (nameIdx < 0) nameIdx = headers.indexOf('fire_name');

        for (var ci = 1; ci < lines.length; ci++) {
          var cols = lines[ci].split(',');
          var lat = parseFloat(cols[latIdx]);
          var lon = parseFloat(cols[lonIdx]);
          if (isNaN(lat) || isNaN(lon)) continue;

          var ha = sizeIdx >= 0 ? parseFloat(cols[sizeIdx]) : 0;
          if (isNaN(ha)) ha = 0;
          var name = nameIdx >= 0 && cols[nameIdx] ? cols[nameIdx].replace(/"/g, '') : 'Unknown';
          var status = statusIdx >= 0 && cols[statusIdx] ? cols[statusIdx].replace(/"/g, '') : '';
          var agency = agencyIdx >= 0 && cols[agencyIdx] ? cols[agencyIdx].replace(/"/g, '') : '';

          // Status code mapping
          var statusLabel = '';
          if (status === 'OC') statusLabel = 'Out of Control';
          else if (status === 'BH') statusLabel = 'Being Held';
          else if (status === 'UC') statusLabel = 'Under Control';
          else if (status === 'EX') statusLabel = 'Out';

          // Skip extinguished fires
          if (status === 'EX') continue;

          allFires.push({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [lon, lat] },
            properties: {
              _country: 'CA',
              _name: name + (agency ? ' (' + agency + ')' : ''),
              _acres: ha,       // stored in hectares
              _unit: 'ha',
              _contained: status === 'UC' ? 90 : status === 'BH' ? 50 : 0,
              _status: statusLabel,
              IncidentName: name,
              DailyAcres: Math.round(ha * 2.471), // convert ha to acres for compatibility
              GISAcres: Math.round(ha * 2.471),
              PercentContained: status === 'UC' ? 90 : status === 'BH' ? 50 : 0
            }
          });
        }
        console.log('CWFIS: parsed ' + (lines.length - 1) + ' Canadian fire records');
        onSourceComplete();
      })
      .catch(function(err) { console.log('CWFIS error:', err); onSourceComplete(); });

    //  SOURCE 3: NASA FIRMS VIIRS (satellite hotspots) 
    // FIRMS provides VIIRS thermal hotspots  375m resolution, detects
    // fires within ~1 minute of satellite overpass (Ultra Real-Time for US/Canada)
    // Covers all of North America including remote Canadian boreal forest
    //
    // GET YOUR FREE KEY: https://firms.modaps.eosdis.nasa.gov/api/map_key/
    // Paste it below to enable direct FIRMS VIIRS data:
    var FIRMS_MAP_KEY = '6320c2dedab61aca90d5469bec834fdf'; // NASA FIRMS VIIRS hotspot key
    
    var firmsBbox = '-140,25,-50,75'; // US + Canada bounding box

    function parseFirmsHotspots(features, source) {
      var added = 0;
      features.forEach(function(hs) {
        var coords = hs.geometry && hs.geometry.coordinates;
        if (!coords) return;
        var hsLat = coords[1], hsLon = coords[0];

        // Deduplicate: skip hotspots within 20mi of existing NIFC/CWFIS fire
        var nearExisting = allFires.some(function(f) {
          var fc = f.geometry && f.geometry.coordinates;
          if (!fc || f.properties._country === 'SAT') return false;
          var d = Math.sqrt(Math.pow(fc[1] - hsLat, 2) + Math.pow(fc[0] - hsLon, 2)) * 69;
          return d < 20;
        });
        if (nearExisting) return;

        var props = hs.properties || {};
        // FIRMS CSV fields: brightness, frp (fire radiative power), confidence
        var frp = props.frp || props.FRP || 0;
        var conf = props.confidence || props.Confidence || '';
        var bright = props.brightness || props.Brightness || props.bright_ti4 || 0;
        var acq = props.acq_date || props.ACQ_DATE || '';

        allFires.push({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [hsLon, hsLat] },
          properties: {
            _country: hsLat >= 49.0 ? 'CA' : 'SAT',
            _name: source + ' Hotspot' + (frp > 0 ? ' (FRP: ' + Math.round(frp) + ' MW)' : '') + (conf ? ' [' + conf + ']' : ''),
            _acres: 0,
            _unit: 'acres',
            _contained: 0,
            _frp: frp,           // Fire Radiative Power in MW  proxy for fire intensity
            _confidence: conf,    // nominal/high/low
            _brightness: bright,  // brightness temperature in Kelvin
            _satellite: true,     // flag: satellite-detected (not agency-reported)
            IncidentName: source + ' Hotspot',
            DailyAcres: frp > 100 ? Math.round(frp * 5) : 0, // rough FRP-to-area estimate for large fires
            GISAcres: 0,
            PercentContained: 0
          }
        });
        added++;
      });
      return added;
    }

    if (FIRMS_MAP_KEY) {
      //  Primary: NASA FIRMS VIIRS SNPP + NOAA-20 (last 24hr) 
      var firmsSnppUrl = 'https://firms.modaps.eosdis.nasa.gov/api/area/csv/' + FIRMS_MAP_KEY + '/VIIRS_SNPP_NRT/' + firmsBbox + '/1';
      var firmsN20Url = 'https://firms.modaps.eosdis.nasa.gov/api/area/csv/' + FIRMS_MAP_KEY + '/VIIRS_NOAA20_NRT/' + firmsBbox + '/1';

      var firmsDone = 0;
      function onFirmsDone() {
        firmsDone++;
        if (firmsDone >= 2) onSourceComplete();
      }

      // VIIRS S-NPP
      fetchWithTimeout(firmsSnppUrl, null, 20000)
        .then(function(r) { return r.text(); })
        .then(function(csv) {
          var features = parseFirmsCsv(csv);
          var added = parseFirmsHotspots(features, 'VIIRS-SNPP');
          console.log('FIRMS SNPP: ' + added + ' unique hotspots');
          onFirmsDone();
        })
        .catch(function(err) { console.log('FIRMS SNPP error:', err); onFirmsDone(); });

      // VIIRS NOAA-20
      fetchWithTimeout(firmsN20Url, null, 20000)
        .then(function(r) { return r.text(); })
        .then(function(csv) {
          var features = parseFirmsCsv(csv);
          var added = parseFirmsHotspots(features, 'VIIRS-N20');
          console.log('FIRMS NOAA-20: ' + added + ' unique hotspots');
          onFirmsDone();
        })
        .catch(function(err) { console.log('FIRMS N20 error:', err); onFirmsDone(); });

    } else {
      //  Fallback: NOAA HMS Fire Detections (no key required) 
      // Quality-controlled by NOAA analysts, removes false positives
      var hmsFireUrl = 'https://services9.arcgis.com/RGao6tMQSJKyNRvN/arcgis/rest/services/NOAA_HMS_Fire_Detection/FeatureServer/0/query?where=1%3D1&outFields=*&returnGeometry=true&outSR=4326&resultType=tile&f=geojson';
      fetchWithTimeout(hmsFireUrl, null, 15000)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var added = parseFirmsHotspots(data.features || [], 'HMS');
          console.log('HMS Fire Detection: ' + added + ' unique hotspots (FIRMS key not set  add your free key for VIIRS data)');
          onSourceComplete();
        })
        .catch(function(err) { console.log('HMS fire detection error:', err); onSourceComplete(); });
    }
  }

  // Parse FIRMS CSV into GeoJSON-like features
  function parseFirmsCsv(csvText) {
    var lines = csvText.trim().split('\n');
    if (lines.length < 2) return [];
    var headers = lines[0].split(',');
    var latIdx = headers.indexOf('latitude');
    var lonIdx = headers.indexOf('longitude');
    var frpIdx = headers.indexOf('frp');
    var confIdx = headers.indexOf('confidence');
    var brightIdx = headers.indexOf('bright_ti4');
    if (brightIdx < 0) brightIdx = headers.indexOf('brightness');
    var dateIdx = headers.indexOf('acq_date');

    var features = [];
    for (var i = 1; i < lines.length; i++) {
      var cols = lines[i].split(',');
      var lat = parseFloat(cols[latIdx]);
      var lon = parseFloat(cols[lonIdx]);
      if (isNaN(lat) || isNaN(lon)) continue;

      features.push({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [lon, lat] },
        properties: {
          frp: frpIdx >= 0 ? parseFloat(cols[frpIdx]) || 0 : 0,
          confidence: confIdx >= 0 ? cols[confIdx] : '',
          brightness: brightIdx >= 0 ? parseFloat(cols[brightIdx]) || 0 : 0,
          acq_date: dateIdx >= 0 ? cols[dateIdx] : ''
        }
      });
    }
    return features;
  }

  //  Build fire dropdown from merged data 
  // Simple lat/lon to US state abbreviation (approximate centroids + radius)
  var _usStates = [
    ['AL',32.8,-86.8],['AK',64.2,-152.5],['AZ',34.3,-111.7],['AR',34.8,-92.2],['CA',37.2,-119.5],
    ['CO',39.0,-105.5],['CT',41.6,-72.7],['DE',39.0,-75.5],['FL',28.6,-82.5],['GA',32.7,-83.5],
    ['HI',20.5,-157.5],['ID',44.4,-114.7],['IL',40.0,-89.4],['IN',39.9,-86.3],['IA',42.0,-93.5],
    ['KS',38.5,-98.3],['KY',37.8,-85.8],['LA',31.0,-92.0],['ME',45.4,-69.2],['MD',39.0,-76.8],
    ['MA',42.3,-72.0],['MI',44.3,-85.4],['MN',46.3,-94.3],['MS',32.7,-89.7],['MO',38.4,-92.5],
    ['MT',47.0,-109.6],['NE',41.5,-99.8],['NV',39.3,-117.0],['NH',43.7,-71.6],['NJ',40.1,-74.7],
    ['NM',34.5,-106.0],['NY',42.9,-75.5],['NC',35.5,-79.8],['ND',47.5,-100.5],['OH',40.4,-82.8],
    ['OK',35.5,-97.5],['OR',43.9,-120.6],['PA',40.9,-77.8],['RI',41.7,-71.5],['SC',34.0,-81.0],
    ['SD',44.4,-100.2],['TN',35.8,-86.4],['TX',31.5,-99.3],['UT',39.3,-111.7],['VT',44.1,-72.6],
    ['VA',37.5,-78.9],['WA',47.4,-120.7],['WV',38.6,-80.6],['WI',44.6,-90.0],['WY',43.0,-107.6]
  ];
  function getStateFromCoords(lat,lon){
    if(!lat||!lon) return '';
    var best='',bestD=999;
    for(var i=0;i<_usStates.length;i++){
      var s=_usStates[i];
      var d=Math.sqrt(Math.pow(lat-s[1],2)+Math.pow(lon-s[2],2));
      if(d<bestD){bestD=d;best=s[0];}
    }
    return bestD < 4 ? best : '';
  }

  function buildFireDropdown(allFires) {
    var fireListEl = document.getElementById("hz-pill-fire-list");
    if (!fireListEl || allFires.length === 0) return;

    var sorted = allFires.slice().sort(function(a, b) {
      var aAcres = (a.properties.DailyAcres || a.properties.GISAcres || a.properties._acres || 0);
      var bAcres = (b.properties.DailyAcres || b.properties.GISAcres || b.properties._acres || 0);
      return bAcres - aAcres;
    }).filter(function(f) { return f.properties._country !== 'SAT'; }).slice(0, 5);

    var listHtml = "";
    for (var fi = 0; fi < sorted.length; fi++) {
      var f = sorted[fi];
      var props = f.properties || {};
      var coords = f.geometry && f.geometry.coordinates;
      var fName = props.IncidentName || props._name || 'Unknown Fire';
      var fAcres = props.DailyAcres || props.GISAcres || 0;
      var fContained = props.PercentContained || 0;
      var lat = coords ? coords[1] : 0;
      var lon = coords ? coords[0] : 0;
      var country = props._country || 'US';
      var state = props.POOState || props.State || '';
      var stateCode = state ? state.substring(0,2).toUpperCase() : getStateFromCoords(lat,lon); var loc = country === 'CA' ? 'CA' : (stateCode || 'US');

      var acresStr = fAcres >= 1000 ? (fAcres / 1000).toFixed(1) + 'K' : Math.round(fAcres).toLocaleString();
      var acreColor = fAcres >= 50000 ? '#7f1d1d' : fAcres >= 10000 ? '#dc2626' : fAcres >= 1000 ? '#f97316' : '#fbbf24';

      listHtml += '<div class="fire-item" onclick="window.flyToFire(' + lat + ',' + lon + ')" style="padding:2px 0;cursor:pointer;display:flex;align-items:center;gap:3px;font-size:.4rem;">' +
        '<span style="color:' + acreColor + ';font-weight:800;min-width:28px;text-align:right;">' + acresStr + '</span>' +
        '<span style="color:rgba(255,255,255,.8);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + fName + '</span>' +
        '<span style="color:rgba(255,255,255,.25);font-weight:600;margin-left:auto;white-space:nowrap;">' + loc + (fContained > 0 ? ' ' + fContained + '%' : '') + '</span>' +
      '</div>';
    }

    fireListEl.innerHTML = listHtml;

    // Global function for fire click
    window.flyToFire = function(lat, lon) {
      if (fireMap && !isNaN(lat) && !isNaN(lon)) {
        fireMap.flyTo([lat, lon], 8, { duration: 1 });
      }
    };
  }

  // ============ SMOKE FORECAST LAYER ============
  var smokeGeoJsonLayer = null;
  var goesOverlay = null;
  var aqiHeatLayer = null;
  var aqiBlobMarkers = [];

  // 
  // SMOKE INTELLIGENCE ENGINE
  // Runs after fire data loads and periodically.
  // Correlates PM2.5 trends with wind + fires to detect smoke events,
  // forecast smoke arrival/clearing, and build evidence-based source
  // attribution. Results stored in window._smokeIntel for cross-use.
  // 
  function buildSmokeIntelligence() {
    var fires = window._activeFires || [];
    var aq = window._aqData;
    var wx = window._wxCurrent;
    var hourly = window._wxHourly;
    var ni = window._wxNearestIdx;
    if (!wx || !hourly || ni == null) return;

    var lat = LOCATION.lat, lon = LOCATION.lon;
    var now = new Date();
    var wDirs16 = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
    var windDeg = hourly.wind_direction_10m ? hourly.wind_direction_10m[ni] : null;
    var windSpd = wx.wind || 0;
    var pm25now = wx.pm25 || (aq && aq.current ? aq.current.pm2_5 : null) || 0;
    var pm10now = aq && aq.current ? aq.current.pm10 : null;
    var pblH = wx.pblHeight || null;

    var intel = {
      timestamp: now,
      smokeEvent: false,
      smokeConfidence: 0,        // 0-100
      probableSource: null,       // fire name
      transportActive: false,
      upwindFires: [],
      crosswindFires: [],
      smokeArrivalTimeline: [],   // {hr, pm25est, source, event}
      pm25Trend: null,            // 'rising','falling','stable','spike'
      pm25TrendCorrelation: null, // 'correlates_with_wind', 'no_correlation'
      windShiftAlerts: [],
      surfaceMixdown: false,
      inversionsTrapping: false,
      evidenceChain: [],          // array of evidence strings
      severity: 'none'            // 'none','advisory','warning','emergency'
    };

    //  1. CLASSIFY EVERY FIRE BY WIND RELATIONSHIP 
    fires.forEach(function(fire) {
      var coords = fire.geometry && fire.geometry.coordinates;
      if (!coords) return;
      var props = fire.properties || {};
      var fLat = coords[1], fLon = coords[0];
      var dLat = fLat - lat, dLon = fLon - lon;
      var dist = Math.sqrt(dLat * dLat + dLon * dLon) * 69;
      // Extended range for Canadian long-distance smoke transport
      // Canadian boreal fires are often 1200-1800mi from East Coast
      if (dist > 1500) return;
      var country = props._country || 'US';

      var bearing = Math.atan2(dLon, dLat) * 180 / Math.PI;
      if (bearing < 0) bearing += 360;

      var isUpwind = false, alignment = 'far';
      if (windDeg != null) {
        var diff = Math.abs(bearing - windDeg);
        if (diff > 180) diff = 360 - diff;
        if (diff <= 30) { isUpwind = true; alignment = 'direct'; }
        else if (diff <= 60) { isUpwind = true; alignment = 'partial'; }
        else if (diff < 135) { alignment = 'cross'; }
        else { alignment = 'downwind'; }
      }

      var acres = props.DailyAcres || props.GISAcres || props.CalculatedAcres || 0;
      var name = props.IncidentName || props.FireName || 'Unknown';
      var contained = props.PercentContained || 0;
      var transportHrs = windSpd > 2 ? dist / windSpd : null;

      // Smoke production estimate (tons/hr rough) based on acres + containment
      var smokeRate = acres > 50000 ? 'extreme' : acres > 10000 ? 'heavy' : acres > 1000 ? 'moderate' : 'light';
      if (contained > 80) smokeRate = 'light'; // mostly contained = less active burning

      var fireObj = {
        name: name, dist: Math.round(dist), bearing: Math.round(bearing),
        bearingDir: wDirs16[Math.round(bearing / 22.5) % 16],
        acres: acres, contained: contained, alignment: alignment,
        isUpwind: isUpwind, transportHrs: transportHrs, smokeRate: smokeRate,
        country: country
      };

      if (isUpwind) intel.upwindFires.push(fireObj);
      else if (alignment === 'cross') intel.crosswindFires.push(fireObj);
    });

    intel.upwindFires.sort(function(a, b) { return a.dist - b.dist; });
    intel.transportActive = intel.upwindFires.length > 0;

    //  2. PM2.5 TREND ANALYSIS (past 12 hours) 
    if (aq && aq.hourly && aq.hourly.pm2_5 && aq.hourly.time) {
      var pm25series = aq.hourly.pm2_5;
      var timeSeries = aq.hourly.time;
      var windDirSeries = hourly.wind_direction_10m || [];

      // Get last 12 hours of PM2.5
      var recentPm25 = [];
      var recentWindDir = [];
      for (var ri = Math.max(0, pm25series.length - 12); ri < pm25series.length; ri++) {
        if (pm25series[ri] != null) recentPm25.push({ val: pm25series[ri], time: new Date(timeSeries[ri]), idx: ri });
      }
      // Get matching wind dirs from wx hourly
      for (var rwi = Math.max(0, ni - 12); rwi <= ni; rwi++) {
        if (windDirSeries[rwi] != null) recentWindDir.push({ deg: windDirSeries[rwi], idx: rwi });
      }

      if (recentPm25.length >= 6) {
        var first3 = recentPm25.slice(0, 3).reduce(function(s, p) { return s + p.val; }, 0) / 3;
        var last3 = recentPm25.slice(-3).reduce(function(s, p) { return s + p.val; }, 0) / 3;
        var maxPm25 = Math.max.apply(null, recentPm25.map(function(p) { return p.val; }));
        var minPm25 = Math.min.apply(null, recentPm25.map(function(p) { return p.val; }));
        var delta = last3 - first3;

        if (delta > 20 && last3 > 35) { intel.pm25Trend = 'spike'; intel.evidenceChain.push('PM2.5 spiked +' + Math.round(delta) + ' g/m over 12hr'); }
        else if (delta > 8) { intel.pm25Trend = 'rising'; intel.evidenceChain.push('PM2.5 rising trend (+' + Math.round(delta) + ')'); }
        else if (delta < -15) { intel.pm25Trend = 'falling'; intel.evidenceChain.push('PM2.5 falling (-' + Math.round(Math.abs(delta)) + ')'); }
        else { intel.pm25Trend = 'stable'; }

        //  3. WIND-PM2.5 CORRELATION 
        // Check if PM2.5 rises correlate with wind pointing toward fires
        if (intel.upwindFires.length > 0 && recentPm25.length >= 6 && recentWindDir.length >= 6) {
          var upwindHrsCount = 0, upwindPm25Sum = 0;
          var otherHrsCount = 0, otherPm25Sum = 0;

          recentPm25.forEach(function(pm, idx) {
            // Find closest wind dir reading
            var closestWind = recentWindDir.reduce(function(best, w) {
              return Math.abs(w.idx - pm.idx) < Math.abs(best.idx - pm.idx) ? w : best;
            }, recentWindDir[0]);

            var wasUpwind = false;
            intel.upwindFires.forEach(function(f) {
              var diff = Math.abs(f.bearing - closestWind.deg);
              if (diff > 180) diff = 360 - diff;
              if (diff <= 45) wasUpwind = true;
            });

            if (wasUpwind) { upwindHrsCount++; upwindPm25Sum += pm.val; }
            else { otherHrsCount++; otherPm25Sum += pm.val; }
          });

          var upwindAvg = upwindHrsCount > 0 ? upwindPm25Sum / upwindHrsCount : 0;
          var otherAvg = otherHrsCount > 0 ? otherPm25Sum / otherHrsCount : 0;

          if (upwindAvg > otherAvg * 1.5 && upwindAvg > 20) {
            intel.pm25TrendCorrelation = 'correlates_with_wind';
            intel.evidenceChain.push('PM2.5 ' + Math.round(upwindAvg) + ' g/m avg when wind aimed at fires vs ' + Math.round(otherAvg) + ' otherwise');
          }
        }
      }
    }

    //  4. SOURCE FINGERPRINTING 
    var pm25_pm10_ratio = (pm25now > 0 && pm10now && pm10now > 0) ? pm25now / pm10now : null;
    var no2Val = aq && aq.current ? aq.current.nitrogen_dioxide : null;
    var no2Low = no2Val != null && no2Val < 15;

    if (pm25_pm10_ratio != null && pm25_pm10_ratio > 0.65 && no2Low && pm25now > 20) {
      intel.evidenceChain.push('Smoke signature: PM2.5:PM10 ratio ' + pm25_pm10_ratio.toFixed(2) + ', low NO');
    }

    //  5. INVERSION / SURFACE MIXDOWN DETECTION 
    if (pblH != null && pblH < 300) {
      intel.inversionsTrapping = true;
      intel.evidenceChain.push('Shallow PBL (' + Math.round(pblH) + 'm) trapping smoke at surface');
    }

    // Check if elevated smoke could mix down at sunrise
    var sunRise = wx.sunrise ? new Date(wx.sunrise) : null;
    var sunAltNow = 0;
    try {
      var _sd = daysSinceJ2000(now);
      var _se = sunEcliptic(_sd);
      var _sq = eclToEqu(_se.x, _se.y, _se.z, _sd);
      var _sr = raDecFromEqu(_sq);
      var _sa = altAz(_sr.ra, _sr.dec, now, lat, lon);
      sunAltNow = deg(_sa.alt);
    } catch(e) {}

    if (sunAltNow < -6 && intel.upwindFires.length > 0 && pm25now < 25 && sunRise) {
      var hrsToSunrise = (sunRise - now) / 3600000;
      if (hrsToSunrise > 0 && hrsToSunrise < 8) {
        intel.surfaceMixdown = true;
        intel.evidenceChain.push('Nighttime: smoke may be aloft. Sunrise mixing (' + Math.round(hrsToSunrise) + 'hr) could bring it to surface');
      }
    }

    //  6. SMOKE ARRIVAL TIMELINE (next 24hr) 
    // Uses SURFACE wind for fires within 300mi
    // Uses UPPER-LEVEL wind (700mb/500mb) for fires 300-1500mi
    // Canadian smoke at altitude rides the jet stream, not surface wind
    var has500 = hourly.winddirection_500hPa && hourly.windspeed_500hPa;
    var has700 = hourly.winddirection_700hPa && hourly.windspeed_700hPa;
    var has300 = hourly.winddirection_300hPa && hourly.windspeed_300hPa;

    // Store upper-level wind analysis for display
    intel.upperWindAnalysis = null;
    if (has500 || has700) {
      var w500dir = has500 ? hourly.winddirection_500hPa[ni] : null;
      var w500spd = has500 ? hourly.windspeed_500hPa[ni] : null;
      var w700dir = has700 ? hourly.winddirection_700hPa[ni] : null;
      var w700spd = has700 ? hourly.windspeed_700hPa[ni] : null;
      var w300dir = has300 ? hourly.winddirection_300hPa[ni] : null;
      var w300spd = has300 ? hourly.windspeed_300hPa[ni] : null;

      // Check which fires are upwind at upper levels (for long-distance transport)
      var upperUpwindFires = [];
      fires.forEach(function(fire) {
        var coords = fire.geometry && fire.geometry.coordinates;
        if (!coords) return;
        var props = fire.properties || {};
        var fLat = coords[1], fLon = coords[0];
        var dLat = fLat - lat, dLon = fLon - lon;
        var dist = Math.sqrt(dLat * dLat + dLon * dLon) * 69;
        if (dist < 300 || dist > 1500) return; // only distant fires
        var bearing = Math.atan2(dLon, dLat) * 180 / Math.PI;
        if (bearing < 0) bearing += 360;
        var acres = props.DailyAcres || props.GISAcres || 0;
        if (acres < 500) return; // only significant fires

        // Check 700mb (~10,000ft)  primary smoke transport level
        if (w700dir != null) {
          var diff700 = Math.abs(bearing - w700dir);
          if (diff700 > 180) diff700 = 360 - diff700;
          if (diff700 <= 45) {
            var transit700 = w700spd > 5 ? dist / (w700spd * 1.15) : null; // mph, slight speed correction for altitude
            upperUpwindFires.push({
              name: props.IncidentName || props._name || 'Unknown',
              dist: Math.round(dist), acres: acres,
              level: '700mb (~10,000ft)', windSpd: Math.round(w700spd),
              windDir: wDirs16[Math.round(w700dir / 22.5) % 16],
              transitHrs: transit700 ? Math.round(transit700) : null,
              country: props._country || 'US'
            });
            return; // don't double-count
          }
        }

        // Check 500mb (~18,000ft)  jet stream level, long-range transport
        if (w500dir != null) {
          var diff500 = Math.abs(bearing - w500dir);
          if (diff500 > 180) diff500 = 360 - diff500;
          if (diff500 <= 45) {
            var transit500 = w500spd > 10 ? dist / (w500spd * 1.15) : null;
            upperUpwindFires.push({
              name: props.IncidentName || props._name || 'Unknown',
              dist: Math.round(dist), acres: acres,
              level: '500mb (~18,000ft)', windSpd: Math.round(w500spd),
              windDir: wDirs16[Math.round(w500dir / 22.5) % 16],
              transitHrs: transit500 ? Math.round(transit500) : null,
              country: props._country || 'US'
            });
          }
        }
      });

      if (upperUpwindFires.length > 0 || has500) {
        intel.upperWindAnalysis = {
          w300: w300dir != null ? { dir: wDirs16[Math.round(w300dir / 22.5) % 16], spd: Math.round(w300spd) } : null,
          w500: w500dir != null ? { dir: wDirs16[Math.round(w500dir / 22.5) % 16], spd: Math.round(w500spd) } : null,
          w700: w700dir != null ? { dir: wDirs16[Math.round(w700dir / 22.5) % 16], spd: Math.round(w700spd) } : null,
          surface: windDeg != null ? { dir: wDirs16[Math.round(windDeg / 22.5) % 16], spd: Math.round(windSpd) } : null,
          upperUpwindFires: upperUpwindFires,
          detail: ''
        };

        if (upperUpwindFires.length > 0) {
          var caUpper = upperUpwindFires.filter(function(f) { return f.country === 'CA'; });
          intel.upperWindAnalysis.detail = upperUpwindFires.length + ' distant fire(s) upwind at altitude' + (caUpper.length > 0 ? ' (' + caUpper.length + ' Canadian)' : '') + '. ';
          var nearest = upperUpwindFires.sort(function(a,b) { return (a.transitHrs || 999) - (b.transitHrs || 999); })[0];
          if (nearest.transitHrs) {
            intel.upperWindAnalysis.detail += 'Nearest: ' + nearest.name + ' (' + nearest.dist + 'mi) on ' + nearest.level + ' winds from ' + nearest.windDir + ' at ' + nearest.windSpd + 'mph  estimated ' + nearest.transitHrs + 'hr transit. ';
          }
          intel.upperWindAnalysis.detail += 'Smoke at altitude may not appear in surface PM2.5 readings until it descends  watch COL vs SFC layers.';
          intel.evidenceChain.push('Upper-level transport: ' + upperUpwindFires.length + ' fires upwind at altitude');
          intel.transportActive = true;
        }
      }
    }

    if (hourly.wind_direction_10m && hourly.windspeed_10m) {
      for (var ti = ni; ti < Math.min(ni + 24, hourly.wind_direction_10m.length); ti++) {
        var futWindDeg = hourly.wind_direction_10m[ti];
        var futWindSpd = hourly.windspeed_10m[ti] || 0;
        if (futWindDeg == null) continue;
        var futTime = new Date(hourly.time[ti]);
        var hrsOut = Math.round((futTime - now) / 3600000);
        if (hrsOut < 0) continue;

        // Use upper-level wind for distant fires in timeline too
        var futW700dir = has700 ? hourly.winddirection_700hPa[ti] : null;
        var futW700spd = has700 ? hourly.windspeed_700hPa[ti] : null;

        // Check which fires are upwind at this future time
        var futUpwind = [];
        fires.forEach(function(fire) {
          var coords = fire.geometry && fire.geometry.coordinates;
          if (!coords) return;
          var fLat = coords[1], fLon = coords[0];
          var dLat = fLat - lat, dLon = fLon - lon;
          var dist = Math.sqrt(dLat * dLat + dLon * dLon) * 69;
          if (dist > 1500) return;
          var bearing = Math.atan2(dLon, dLat) * 180 / Math.PI;
          if (bearing < 0) bearing += 360;

          // Surface wind for nearby, upper wind for distant
          var checkDir, checkSpd;
          if (dist <= 300) {
            checkDir = futWindDeg; checkSpd = futWindSpd;
          } else if (futW700dir != null) {
            checkDir = futW700dir; checkSpd = futW700spd || 0;
          } else {
            checkDir = futWindDeg; checkSpd = futWindSpd;
          }

          var diff = Math.abs(bearing - checkDir);
          if (diff > 180) diff = 360 - diff;
          if (diff <= 40) {
            var tHrs = checkSpd > 2 ? dist / checkSpd : null;
            var acres = (fire.properties || {}).DailyAcres || (fire.properties || {}).GISAcres || 0;
            futUpwind.push({ name: (fire.properties || {}).IncidentName || 'Unknown', dist: Math.round(dist), acres: acres, transitHrs: tHrs });
          }
        });

        // Estimate PM2.5 impact based on upwind fire size + distance + wind speed
        var pm25est = 0;
        futUpwind.forEach(function(f) {
          // Rough model: bigger fires + closer + faster wind = more PM2.5
          var sizeContrib = f.acres > 50000 ? 40 : f.acres > 10000 ? 20 : f.acres > 1000 ? 8 : 2;
          var distDecay = Math.max(0.1, 1 - (f.dist / 500)); // decay with distance
          var windTransport = futWindSpd > 5 ? 1 : 0.5; // calm wind = less transport
          pm25est += sizeContrib * distDecay * windTransport;
        });

        var event = null;
        var prevSlot = intel.smokeArrivalTimeline.length > 0 ? intel.smokeArrivalTimeline[intel.smokeArrivalTimeline.length - 1] : null;
        if (futUpwind.length > 0 && (!prevSlot || prevSlot.upwindCount === 0)) event = 'smoke_arrives';
        else if (futUpwind.length === 0 && prevSlot && prevSlot.upwindCount > 0) event = 'smoke_clears';

        intel.smokeArrivalTimeline.push({
          hr: hrsOut, time: futTime,
          windDeg: futWindDeg, windSpd: Math.round(futWindSpd),
          windDir: wDirs16[Math.round(futWindDeg / 22.5) % 16],
          upwindCount: futUpwind.length,
          upwindFires: futUpwind,
          pm25est: Math.round(pm25est),
          event: event
        });
      }
    }

    //  7. WIND SHIFT ALERTS 
    var currentUpwindCount = intel.upwindFires.length;
    intel.smokeArrivalTimeline.forEach(function(slot) {
      if (slot.event === 'smoke_arrives') {
        intel.windShiftAlerts.push({
          type: 'incoming', hr: slot.hr, time: slot.time,
          dir: slot.windDir, fires: slot.upwindFires,
          msg: 'Wind shifts to ' + slot.windDir + ' in ~' + slot.hr + 'hr  ' + slot.upwindCount + ' fire(s) enter smoke path'
        });
      }
      if (slot.event === 'smoke_clears') {
        intel.windShiftAlerts.push({
          type: 'clearing', hr: slot.hr, time: slot.time,
          dir: slot.windDir,
          msg: 'Wind shifts to ' + slot.windDir + ' in ~' + slot.hr + 'hr  fires rotate out of transport path'
        });
      }
    });

    //  8. SMOKE EVENT DETECTION + CONFIDENCE 
    var confidence = 0;
    if (intel.transportActive) confidence += 25;
    if (intel.pm25Trend === 'spike') confidence += 25;
    else if (intel.pm25Trend === 'rising') confidence += 15;
    if (intel.pm25TrendCorrelation === 'correlates_with_wind') confidence += 25;
    if (pm25_pm10_ratio != null && pm25_pm10_ratio > 0.65 && no2Low) confidence += 15;
    if (intel.inversionsTrapping) confidence += 10;
    if (pm25now > 35 && intel.upwindFires.length > 0) confidence += 10;

    intel.smokeConfidence = Math.min(100, confidence);
    intel.smokeEvent = confidence >= 50;

    if (intel.smokeEvent && intel.upwindFires.length > 0) {
      // Name the most probable source
      var sorted = intel.upwindFires.slice().sort(function(a, b) {
        var scoreA = (a.acres > 10000 ? 50 : a.acres > 1000 ? 20 : 5) + (100 - Math.min(100, a.dist)) + (a.alignment === 'direct' ? 30 : 10);
        var scoreB = (b.acres > 10000 ? 50 : b.acres > 1000 ? 20 : 5) + (100 - Math.min(100, b.dist)) + (b.alignment === 'direct' ? 30 : 10);
        return scoreB - scoreA;
      });
      intel.probableSource = sorted[0].name;
    }

    // Severity level
    if (pm25now > 150 && intel.smokeEvent) intel.severity = 'emergency';
    else if (pm25now > 55 && intel.smokeEvent) intel.severity = 'warning';
    else if ((pm25now > 35 && intel.transportActive) || intel.smokeEvent) intel.severity = 'advisory';
    else intel.severity = 'none';

    //  Store globally 
    window._smokeIntel = intel;

    //  Update fire map AQI pill if smoke event 
    var aqiPill = document.getElementById('fire-aqi-pill');
    var aqiVal = document.getElementById('fire-aqi-value');
    if (aqiPill && aqiVal && pm25now > 0) {
      aqiVal.textContent = Math.round(pm25now);
      aqiPill.style.display = intel.smokeEvent || pm25now > 35 ? 'block' : 'none';
      aqiPill.style.background = pm25now > 150 ? 'rgba(127,29,29,.9)' : pm25now > 55 ? 'rgba(239,68,68,.85)' : pm25now > 35 ? 'rgba(249,115,22,.85)' : 'rgba(0,0,0,.75)';
    }

    console.log('Smoke Intel:', intel.smokeEvent ? 'EVENT (confidence ' + intel.smokeConfidence + '%, source: ' + intel.probableSource + ')' : 'Clear', intel.severity);

    // Trigger surface vs column comparison with fresh data
    if (typeof checkSmokeComparison === 'function') checkSmokeComparison();

    //  MODEL VALIDATION: Compare NWS PM2.5 forecast vs actual 
    // When the model predicts clean air but reality shows elevated PM2.5,
    // that's a "model miss"  usually an unexpected smoke or dust event
    try {
      var fcastPm25 = null;
      // Open-Meteo provides PM2.5 forecast  compare 'current' vs what was forecast
      if (aq && aq.hourly && aq.hourly.pm2_5 && aq.hourly.time) {
        var pm25Arr = aq.hourly.pm2_5;
        // Current actual reading
        var actualPm25 = pm25now;
        // Forecast was made at the start of the data  check what was predicted for now
        // The forecast array includes both historical (observed) and future (predicted) values
        // We compare against the running average to detect sudden deviations
        var recent6 = [];
        for (var mi = Math.max(0, pm25Arr.length - 6); mi < pm25Arr.length; mi++) {
          if (pm25Arr[mi] != null) recent6.push(pm25Arr[mi]);
        }
        var avgRecent = recent6.length > 0 ? recent6.reduce(function(s, v) { return s + v; }, 0) / recent6.length : 0;
        
        // Model miss detection: if actual PM2.5 is 2x the recent average and >25
        if (actualPm25 > 25 && avgRecent > 0 && actualPm25 > avgRecent * 2) {
          intel.modelMiss = true;
          intel.modelMissDetail = 'PM2.5 at ' + Math.round(actualPm25) + ' g/m is ' + (actualPm25 / avgRecent).toFixed(1) + ' the recent 6hr average (' + Math.round(avgRecent) + '). This sudden deviation suggests an unexpected pollution source the forecast models didn\'t predict  likely wildfire smoke transport or a dust event.';
          intel.evidenceChain.push('Model miss: actual PM2.5 ' + Math.round(actualPm25) + ' vs avg ' + Math.round(avgRecent));
        } else {
          intel.modelMiss = false;
          intel.modelMissDetail = null;
        }
      }
    } catch(e) { console.log('Model validation error:', e); }

    //  DUST vs SMOKE DISCRIMINATION 
    // Uses PM2.5:PM10 ratio + NOx to definitively classify
    // With dust forecast layer available, we can add another signal
    try {
      var pm10now = aq && aq.current ? aq.current.pm10 : null;
      var no2now = aq && aq.current ? aq.current.nitrogen_dioxide : null;
      if (pm25now > 10 && pm10now > 10) {
        var ratio = pm25now / pm10now;
        intel.dustVsSmoke = {
          ratio: ratio,
          pm25: pm25now,
          pm10: pm10now,
          no2: no2now,
          classification: 'unknown',
          confidence: 'low',
          detail: ''
        };

        if (ratio > 0.7 && (no2now == null || no2now < 15)) {
          intel.dustVsSmoke.classification = 'wildfire_smoke';
          intel.dustVsSmoke.confidence = ratio > 0.8 ? 'high' : 'medium';
          intel.dustVsSmoke.detail = 'PM2.5:PM10 ratio of ' + ratio.toFixed(2) + ' with low NO (' + (no2now != null ? Math.round(no2now) : '?') + ' g/m) strongly indicates wildfire smoke  fine particles dominate, characteristic of biomass combustion.';
        } else if (ratio < 0.4) {
          intel.dustVsSmoke.classification = 'dust';
          intel.dustVsSmoke.confidence = ratio < 0.3 ? 'high' : 'medium';
          intel.dustVsSmoke.detail = 'PM2.5:PM10 ratio of ' + ratio.toFixed(2) + ' indicates coarse particles dominate  likely Saharan dust, regional dust storm, or construction/agricultural dust. Health advice differs from smoke: coarse particles don\'t penetrate as deeply into lungs.';
        } else if (no2now != null && no2now > 30) {
          intel.dustVsSmoke.classification = 'urban_pollution';
          intel.dustVsSmoke.confidence = 'medium';
          intel.dustVsSmoke.detail = 'Mixed PM ratio (' + ratio.toFixed(2) + ') with elevated NO (' + Math.round(no2now) + ' g/m) points to vehicle/industrial emissions rather than wildfire or dust sources.';
        } else {
          intel.dustVsSmoke.classification = 'mixed';
          intel.dustVsSmoke.confidence = 'low';
          intel.dustVsSmoke.detail = 'Mixed signal  PM2.5:PM10 ratio of ' + ratio.toFixed(2) + ' could indicate blended sources. Toggle the DUST and SFC smoke layers on the map to compare forecasts visually.';
        }
      }
    } catch(e) { console.log('Dust discrimination error:', e); }

    //  PM2.5 HISTORY TRACKING (localStorage) 
    // Store hourly readings for multi-day event detection
    try {
      var histKey = 'smokeIntel_pm25History';
      var history = [];
      try { history = JSON.parse(localStorage.getItem(histKey)) || []; } catch(e) {}
      
      // Add current reading
      if (pm25now > 0) {
        history.push({
          t: now.getTime(),
          pm25: Math.round(pm25now * 10) / 10,
          wind: windDeg,
          event: intel.smokeEvent ? 1 : 0
        });
      }
      
      // Keep only last 72 hours (288 readings at 15min intervals max)
      var cutoff72h = now.getTime() - 72 * 60 * 60 * 1000;
      history = history.filter(function(h) { return h.t > cutoff72h; });
      
      localStorage.setItem(histKey, JSON.stringify(history));
      
      // Analyze multi-day patterns
      intel.pm25History = { readings: history.length, hours: 0 };
      if (history.length > 6) {
        var firstTs = history[0].t;
        var lastTs = history[history.length - 1].t;
        intel.pm25History.hours = Math.round((lastTs - firstTs) / 3600000);
        
        // Count hours with elevated PM2.5 (>35)
        var elevatedHours = 0;
        var smokeEventHours = 0;
        var maxPm25 = 0;
        var dayBuckets = {}; // group by date for multi-day detection
        
        history.forEach(function(h) {
          if (h.pm25 > 35) elevatedHours++;
          if (h.event) smokeEventHours++;
          if (h.pm25 > maxPm25) maxPm25 = h.pm25;
          var dayKey = new Date(h.t).toDateString();
          if (!dayBuckets[dayKey]) dayBuckets[dayKey] = { count: 0, elevated: 0, maxPm25: 0 };
          dayBuckets[dayKey].count++;
          if (h.pm25 > 35) dayBuckets[dayKey].elevated++;
          if (h.pm25 > dayBuckets[dayKey].maxPm25) dayBuckets[dayKey].maxPm25 = h.pm25;
        });
        
        var daysWithElevated = Object.keys(dayBuckets).filter(function(d) { return dayBuckets[d].elevated > 0; }).length;
        
        intel.pm25History.elevatedHours = elevatedHours;
        intel.pm25History.smokeEventHours = smokeEventHours;
        intel.pm25History.maxPm25 = maxPm25;
        intel.pm25History.daysWithElevated = daysWithElevated;
        intel.pm25History.multiDay = daysWithElevated >= 2;
        
        if (daysWithElevated >= 2) {
          intel.pm25History.detail = 'Multi-day smoke event: elevated PM2.5 detected on ' + daysWithElevated + ' days over the past ' + intel.pm25History.hours + 'hr. Peak: ' + Math.round(maxPm25) + ' g/m. ' + elevatedHours + ' readings above 35 g/m. Persistent events indicate a large fire complex with sustained transport  conditions unlikely to clear until wind pattern shifts.';
          intel.evidenceChain.push('Multi-day event: ' + daysWithElevated + ' days elevated');
        }
      }
    } catch(e) { console.log('PM2.5 history error:', e); }
  }

  // Run smoke intelligence after fire data loads and periodically
  setInterval(buildSmokeIntelligence, 5 * 60 * 1000); // every 5 minutes
  
  function loadSmokeLayer(){
    if (!fireMap) return;
    
    // Remove existing layers
    if (smokeGeoJsonLayer && fireMap.hasLayer(smokeGeoJsonLayer)){
      fireMap.removeLayer(smokeGeoJsonLayer);
    }
    
    // Fetch real HMS smoke polygons from NOAA via ArcGIS Feature Service
    var hmsUrl = "https://services9.arcgis.com/RGao6tMQSJKyNRvN/arcgis/rest/services/NOAA_HMS_Smoke_Detection/FeatureServer/0/query?where=1%3D1&outFields=Density&returnGeometry=true&outSR=4326&resultType=tile&f=geojson";
    
    fetchWithTimeout(hmsUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (!data || !data.features || data.features.length === 0){
          console.log("HMS Smoke: No smoke polygons found");
          updateSmokePill("clear");
          return;
        }
        
        var densityStyles = {
          "Light":  { color: "#fbbf24", fillColor: "#fbbf24", fillOpacity: 0.15, weight: 1, opacity: 0.4 },
          "Medium": { color: "#f97316", fillColor: "#f97316", fillOpacity: 0.25, weight: 1, opacity: 0.5 },
          "Heavy":  { color: "#dc2626", fillColor: "#dc2626", fillOpacity: 0.40, weight: 1.5, opacity: 0.6 }
        };
        
        smokeGeoJsonLayer = L.geoJSON(data, {
          style: function(feature){
            var density = feature.properties.Density || "Light";
            return densityStyles[density] || densityStyles["Light"];
          },
          onEachFeature: function(feature, layer){
            var d = feature.properties.Density || "Unknown";
            var smokeColor = d === 'Heavy' ? '#ef4444' : d === 'Medium' ? '#f97316' : '#eab308';
            layer.bindPopup(
              '<div class="hz-card-head"><div class="hz-accent" style="background:'+smokeColor+';"></div><span style="color:'+smokeColor+';">HMS SMOKE PLUME</span></div>' +
              '<div class="hz-card-row"><span class="hz-label">Density</span><span class="hz-val"><span class="hz-tag" style="background:'+smokeColor+'22;color:'+smokeColor+';">'+d+'</span></span></div>' +
              '<div class="hz-card-footer">NOAA Satellite Analysis Branch</div>',
              { className: 'hz-popup', maxWidth: 220 }
            );
          }
        }).addTo(fireMap);
        
        console.log("HMS Smoke: Loaded " + data.features.length + " real smoke polygons");
        updateSmokePill("hms");
      })
      .catch(function(err){
        console.log("HMS Smoke fetch error:", err);
      });
  }
  
  function createSmokeHeatmap(){
    // Deprecated  using real NOAA HRRR smoke forecast overlay
  }
  
  var hrrrSmokeLayer = null;
  var smokePill = null;

  // 
  // NWS SMOKE FORECAST LAYER SYSTEM
  // Three distinct layers with different purposes:
  //   SFC  = Near-surface smoke (g/m)  what you breathe
  //   COL  = Vertically integrated smoke (column total to ~25km)
  //   HMS  = Satellite-detected smoke polygons (GOES/VIIRS observed)
  //
  // Professional technique: When COL >> SFC, smoke is aloft and
  // hasn't mixed down yet. When they converge, smoke is at surface.
  // 

  var smokeLayers = {
    sfc: { layer: null, active: false, url: null, timeExtent: null, label: 'Surface' },
    col: { layer: null, active: false, url: null, timeExtent: null, label: 'Column' },
    hms: { layer: null, active: true, url: null, label: 'HMS Satellite' }, // HMS managed separately via smokeGeoJsonLayer
    can: { layer: null, active: false, url: null, label: 'Canada FireWork' },
    pm25: { layer: null, active: false, url: null, timeExtent: null, label: 'PM2.5 Forecast' },
    dust: { layer: null, active: false, url: null, timeExtent: null, label: 'Dust Forecast' }
  };

  // NWS WMS endpoints
  var NWS_SMOKE_SFC_WMS = "https://mapservices.weather.noaa.gov/raster/services/air_quality/ndgd_smoke_sfc_1hr_avg_time/ImageServer/WMSServer?";
  var NWS_SMOKE_COL_WMS = "https://mapservices.weather.noaa.gov/raster/services/air_quality/ndgd_smoke_vert_1hr_avg_time/ImageServer/WMSServer?";
  var NWS_SMOKE_SFC_INFO = "https://mapservices.weather.noaa.gov/raster/rest/services/air_quality/ndgd_smoke_sfc_1hr_avg_time/ImageServer?f=json";
  var NWS_SMOKE_COL_INFO = "https://mapservices.weather.noaa.gov/raster/rest/services/air_quality/ndgd_smoke_vert_1hr_avg_time/ImageServer?f=json";
  var NWS_PM25_FCAST_WMS = "https://mapservices.weather.noaa.gov/raster/services/air_quality/ndgd_apm25_hr01_bc/ImageServer/WMSServer?";
  var NWS_PM25_FCAST_INFO = "https://mapservices.weather.noaa.gov/raster/rest/services/air_quality/ndgd_apm25_hr01_bc/ImageServer?f=json";
  var NWS_DUST_SFC_WMS = "https://mapservices.weather.noaa.gov/raster/services/air_quality/ndgd_dust_sfc_1hr_avg_time/ImageServer/WMSServer?";
  var NWS_DUST_SFC_INFO = "https://mapservices.weather.noaa.gov/raster/rest/services/air_quality/ndgd_dust_sfc_1hr_avg_time/ImageServer?f=json";

  function loadNWSSmokeForecasts() {
    if (!fireMap) return;

    //  Load Surface Smoke (SFC) 
    fetchWithTimeout(NWS_SMOKE_SFC_INFO, null, 12000)
      .then(function(r) { return r.json(); })
      .then(function(info) {
        var timeInfo = info && info.timeInfo;
        if (timeInfo && timeInfo.timeExtent && timeInfo.timeExtent.length === 2) {
          smokeLayers.sfc.timeExtent = {
            start: new Date(timeInfo.timeExtent[0]),
            end: new Date(timeInfo.timeExtent[1])
          };
          var ageMins = (new Date() - smokeLayers.sfc.timeExtent.end) / 60000;
          console.log('NWS Smoke SFC: ends ' + smokeLayers.sfc.timeExtent.end.toISOString() + ' (age: ' + Math.round(ageMins) + 'min)');

          // Always load  WMS server returns valid imagery regardless
          smokeLayers.sfc.layer = L.tileLayer.wms(NWS_SMOKE_SFC_WMS, {
              layers: "0",
              format: "image/png",
              transparent: true,
              opacity: 0.7,
              attribution: "NWS NAQFC Surface Smoke"
            });
            // Auto-show surface smoke by default
            smokeLayers.sfc.layer.addTo(fireMap);
            smokeLayers.sfc.active = true;
            // btn removed
        }
        checkSmokeComparison();
      })
      .catch(function(err) { console.log('NWS Smoke SFC error:', err); });

    //  Load Column Smoke (COL) 
    fetchWithTimeout(NWS_SMOKE_COL_INFO, null, 12000)
      .then(function(r) { return r.json(); })
      .then(function(info) {
        var timeInfo = info && info.timeInfo;
        if (timeInfo && timeInfo.timeExtent && timeInfo.timeExtent.length === 2) {
          smokeLayers.col.timeExtent = {
            start: new Date(timeInfo.timeExtent[0]),
            end: new Date(timeInfo.timeExtent[1])
          };
          var ageMins = (new Date() - smokeLayers.col.timeExtent.end) / 60000;
          var isCurrent = ageMins < 1440 || ageMins < 0;
          console.log('NWS Smoke COL: ' + (isCurrent ? 'CURRENT' : 'STALE') + '  ends ' + smokeLayers.col.timeExtent.end.toISOString());

          if (isCurrent) {
            smokeLayers.col.layer = L.tileLayer.wms(NWS_SMOKE_COL_WMS, {
              layers: "0",
              format: "image/png",
              transparent: true,
              opacity: 0.45,
              attribution: "NWS NAQFC Column Smoke"
            });
            // Column off by default  user toggles on to compare
            smokeLayers.col.active = false;
            // btn removed
          }
        }
        checkSmokeComparison();
      })
      .catch(function(err) { console.log('NWS Smoke COL error:', err); });

    //  Load NWS PM2.5 Forecast (bias-corrected) 
    fetchWithTimeout(NWS_PM25_FCAST_INFO, null, 12000)
      .then(function(r) { return r.json(); })
      .then(function(info) {
        var timeInfo = info && info.timeInfo;
        if (timeInfo && timeInfo.timeExtent && timeInfo.timeExtent.length === 2) {
          smokeLayers.pm25.timeExtent = { start: new Date(timeInfo.timeExtent[0]), end: new Date(timeInfo.timeExtent[1]) };
          var ageMins = (new Date() - smokeLayers.pm25.timeExtent.end) / 60000;
          if (ageMins < 1440 || ageMins < 0) {
            smokeLayers.pm25.layer = L.tileLayer.wms(NWS_PM25_FCAST_WMS, {
              layers: "0", format: "image/png", transparent: true, opacity: 0.45,
              attribution: "NWS NAQFC PM2.5 Forecast"
            });
            console.log('NWS PM2.5 Forecast layer ready');
          }
        }
        // btn removed
      })
      .catch(function(err) { console.log('NWS PM2.5 Forecast error:', err); });

    //  Load NWS Dust Surface Forecast 
    fetchWithTimeout(NWS_DUST_SFC_INFO, null, 12000)
      .then(function(r) { return r.json(); })
      .then(function(info) {
        var timeInfo = info && info.timeInfo;
        if (timeInfo && timeInfo.timeExtent && timeInfo.timeExtent.length === 2) {
          smokeLayers.dust.timeExtent = { start: new Date(timeInfo.timeExtent[0]), end: new Date(timeInfo.timeExtent[1]) };
          var ageMins = (new Date() - smokeLayers.dust.timeExtent.end) / 60000;
          if (ageMins < 1440 || ageMins < 0) {
            smokeLayers.dust.layer = L.tileLayer.wms(NWS_DUST_SFC_WMS, {
              layers: "0", format: "image/png", transparent: true, opacity: 0.5,
              attribution: "NWS NAQFC Dust Forecast"
            });
            console.log('NWS Dust Forecast layer ready');
          }
        }
        // btn removed
      })
      .catch(function(err) { console.log('NWS Dust Forecast error:', err); });

    // HMS polygons already loaded by loadSmokeLayer()
    smokeLayers.hms.active = true;
    // btn removed

    //  Load Environment Canada RAQDPS-FireWork 72hr smoke 
    // This shows PM2.5 contribution from wildfire smoke only (DIFF layer)
    // 72-hour forecast range, 10km resolution, covers all of North America
    var ECCC_GEOMET_WMS = "https://geo.weather.gc.ca/geomet?";
    smokeLayers.can.layer = L.tileLayer.wms(ECCC_GEOMET_WMS, {
      layers: "RAQDPS-FW.SFC_PM2.5-DIFF",
      format: "image/png",
      transparent: true,
      opacity: 0.7,
      version: "1.3.0",
      crs: L.CRS.EPSG3857,
      attribution: "ECCC RAQDPS-FireWork"
    });
    // Always on  Canadian smoke model
    smokeLayers.can.active = true;
    if(smokeLayers.can.layer) smokeLayers.can.layer.addTo(fireMap);
    console.log('ECCC FireWork 72hr smoke layer ready');
  }

  //  Toggle individual smoke layers 
  window.toggleSmokeLayer = function(type) {
    var sl = smokeLayers[type];
    if (!sl || !fireMap) return;

    if (type === 'hms') {
      // HMS is the GeoJSON polygon layer
      if (sl.active && smokeGeoJsonLayer) {
        fireMap.removeLayer(smokeGeoJsonLayer);
        sl.active = false;
      } else if (!sl.active && smokeGeoJsonLayer) {
        smokeGeoJsonLayer.addTo(fireMap);
        sl.active = true;
      }
    } else {
      // SFC, COL, CAN are all WMS tile layers
      if (!sl.layer) {
        // Layer not loaded yet  flash the button to indicate not available
        var btnEl = document.getElementById('smoke-' + type + '-btn');
        if (btnEl) {
          var origText = btnEl.textContent;
          btnEl.textContent = ' LOADING';
          setTimeout(function(){ btnEl.textContent = origText; }, 2000);
        }
        return;
      }
      if (sl.active) {
        fireMap.removeLayer(sl.layer);
        sl.active = false;
      } else {
        sl.layer.addTo(fireMap);
        sl.active = true;
      }
    }
    // btn removed
    checkSmokeComparison();
  };

  function updateSmokeBtn(type, active) {
    var btnId = 'smoke-' + type + '-btn';
    var btn = document.getElementById(btnId);
    if (!btn) return;
    var colors = { sfc: '#f97316', col: '#8b5cf6', hms: '#fbbf24', can: '#ef4444', pm25: '#3b82f6', dust: '#d9a963' };
    var c = colors[type] || '#888';
    if (active) {
      btn.style.background = c + '30';
      btn.style.borderColor = c + '80';
      btn.style.color = c;
    } else {
      btn.style.background = 'rgba(0,0,0,.3)';
      btn.style.borderColor = 'rgba(255,255,255,.1)';
      btn.style.color = 'rgba(255,255,255,.35)';
    }
  }

  // 
  // SURFACE vs COLUMN SMOKE COMPARISON
  // The key professional technique: when column smoke is present
  // but surface smoke is absent, smoke is ALOFT  it hasn't mixed
  // down to the breathing zone yet. This is critical for Canadian
  // smoke events where plumes travel at 5,000-15,000ft.
  //
  // The smoke intelligence engine uses this to set:
  //   window._smokeIntel.smokeAloft = true/false
  //   window._smokeIntel.aloftDetail = explanation string
  // 

  function checkSmokeComparison() {
    var intel = window._smokeIntel;
    if (!intel) {
      window._smokeIntel = {};
      intel = window._smokeIntel;
    }

    // We can't directly read WMS pixel values, so we infer from:
    // 1. HMS shows smoke polygons over our area  column smoke present
    // 2. PM2.5 at ground level is still low  surface smoke absent
    // 3. PBL height context  determines when mixdown will occur
    var hmsActive = smokeGeoJsonLayer && smokeLayers.hms.active;
    var pm25 = 0;
    var aq = window._aqData;
    if (aq && aq.current && aq.current.pm2_5 != null) pm25 = aq.current.pm2_5;

    var wx = window._wxCurrent || {};
    var pbl = wx.pblHeight || null;

    // Smoke aloft detection: satellite sees smoke but ground-level PM2.5 is clean
    var hmsOverUs = false;
    if (hmsActive && smokeGeoJsonLayer) {
      // Check if any HMS polygon covers our location
      try {
        var pt = L.latLng(LOCATION.lat, LOCATION.lon);
        smokeGeoJsonLayer.eachLayer(function(layer) {
          if (hmsOverUs) return;
          try {
            var bounds = layer.getBounds ? layer.getBounds() : null;
            if (bounds && bounds.contains(pt)) hmsOverUs = true;
          } catch(e) {}
        });
      } catch(e) {}
    }

    // Also check upwind fires from fire analysis
    var upwindFires = intel.upwindFires || [];
    var hasUpwind = upwindFires.length > 0;

    if ((hmsOverUs || hasUpwind) && pm25 < 25) {
      intel.smokeAloft = true;
      var detail = '';
      if (hmsOverUs) detail += 'HMS satellite detects smoke over this area. ';
      if (hasUpwind) detail += upwindFires.length + ' fire(s) upwind. ';
      detail += 'But surface PM2.5 is only ' + Math.round(pm25) + ' g/m  smoke is likely at altitude, not at surface level. ';

      if (pbl != null) {
        if (pbl < 500) {
          detail += 'PBL is shallow (' + Math.round(pbl) + 'm)  a stable cap is keeping smoke aloft. ';
          // Check when PBL will deepen
          var sunAlt = 0;
          try {
            var _sd = daysSinceJ2000(new Date());
            var _se = sunEcliptic(_sd);
            var _sq = eclToEqu(_se.x, _se.y, _se.z, _sd);
            var _sr = raDecFromEqu(_sq);
            var _sa = altAz(_sr.ra, _sr.dec, new Date(), LOCATION.lat, LOCATION.lon);
            sunAlt = deg(_sa.alt);
          } catch(e) {}

          if (sunAlt < 0) {
            detail += 'Overnight: boundary layer will remain stable. Smoke stays aloft until morning solar heating deepens the mixed layer. ';
            detail += 'EXPECT PM2.5 INCREASE AFTER SUNRISE as convective mixing brings smoke to surface.';
          } else if (sunAlt > 15) {
            detail += 'Daytime heating should deepen PBL  smoke may begin mixing down to surface within 1-3 hours.';
          }
        } else {
          detail += 'PBL is deep (' + Math.round(pbl) + 'm)  smoke should be mixing. Low PM2.5 suggests plume is still upstream or very high altitude.';
        }
      }
      intel.aloftDetail = detail;
    } else if (pm25 > 35 && (hmsOverUs || hasUpwind)) {
      intel.smokeAloft = false;
      intel.aloftDetail = 'Smoke has reached surface level. PM2.5 at ' + Math.round(pm25) + ' g/m confirms active surface-level smoke impact.';
    } else {
      intel.smokeAloft = false;
      intel.aloftDetail = null;
    }

    // Update smoke pill with comparison info
    updateSmokePillAdvanced();
  }

  function updateSmokePillAdvanced() {
    if (!fireMap) return;

    if (!smokePill) {
      // Smoke status is embedded in the fire legend
      smokePill = { getContainer: function(){ return document.getElementById('fire-legend-smoke'); } };
    }

    var el = smokePill.getContainer();
    if (!el) return;

    var intel = window._smokeIntel || {};
    var pm25 = 0;
    var aq = window._aqData;
    if (aq && aq.current && aq.current.pm2_5 != null) pm25 = aq.current.pm2_5;

    var layerStr = '';

    if (intel.smokeEvent) {
      var sevCol = intel.severity === 'emergency' ? '#f44' : intel.severity === 'warning' ? '#f97316' : '#fbbf24';
      el.innerHTML = '<div style="line-height:1.3;"><span style="color:' + sevCol + ';font-weight:800;font-size:9px;">SMOKE</span><br><span style="color:' + sevCol + ';font-size:8px;">' + intel.severity.toUpperCase() + '</span>';
      if (pm25 > 0) el.innerHTML += '<br><span style="color:#aaa;font-size:7px;">PM2.5: ' + Math.round(pm25) + '</span>';
      el.innerHTML += '</div>';
    } else if (intel.smokeAloft) {
      el.innerHTML = '<div style="line-height:1.3;"><span style="color:#8b5cf6;font-size:9px;">SMOKE</span><br><span style="color:#8b5cf6;font-size:7px;">ALOFT</span></div>';
    } else if (smokeGeoJsonLayer || pm25 > 20) {
      el.innerHTML = '<div style="line-height:1.3;"><span style="color:#fbbf24;font-size:9px;">SMOKE</span>';
      if (pm25 > 0) el.innerHTML += '<br><span style="color:#aaa;font-size:7px;">PM2.5: ' + Math.round(pm25) + '</span>';
      el.innerHTML += '</div>';
    } else {
      var sources = [];
      if (smokeLayers.sfc.active) sources.push('NWS');
      if (smokeLayers.hms.active) sources.push('HMS');
      if (smokeLayers.can.active) sources.push('ECCC');
      var srcStr = sources.length > 0 ? sources.join('/') : 'No data';
      var aqiStr = pm25 > 0 ? 'PM2.5: ' + Math.round(pm25) + 'g/m' : '';
      el.innerHTML = '<div style="line-height:1.3;"><span style="color:#4ade80;font-size:9px;">CLEAR</span>' + (aqiStr ? '<br><span style="color:#888;font-size:7px;">' + aqiStr + '</span>' : '') + '</div>';
    }
  }

  //  Smoke detail panel (click pill to open) 
  function openSmokeDetail() {
    var intel = window._smokeIntel || {};
    var h = '';
    h += '<div style="font-size:.52rem;font-weight:800;color:#f97316;margin-bottom:6px;"> SMOKE LAYER ANALYSIS</div>';

    // Layer status
    h += '<div style="display:flex;gap:6px;margin-bottom:6px;">';
    var layerInfo = [
      { key:'sfc', label:'Surface Smoke', desc:'NWS NAQFC 48hr forecast  near-surface smoke concentration. What you breathe.', color:'#f97316' },
      { key:'col', label:'Column Smoke', desc:'NWS NAQFC 48hr forecast  vertically integrated from ground to 25km. Shows smoke aloft.', color:'#8b5cf6' },
      { key:'hms', label:'HMS Satellite', desc:'NOAA GOES/VIIRS satellite-detected smoke polygons. Observed, not modeled.', color:'#fbbf24' },
      { key:'can', label:'Canada FireWork', desc:'ECCC RAQDPS-FW 72hr forecast  PM2.5 from Canadian wildfire smoke only. Models transboundary transport into the US. 10km resolution.', color:'#ef4444' },
      { key:'pm25', label:'PM2.5 Forecast', desc:'NWS NAQFC 48hr bias-corrected total PM2.5 prediction. Compare to actual readings to detect model misses  a sudden gap means unexpected smoke or dust.', color:'#3b82f6' },
      { key:'dust', label:'Dust Forecast', desc:'NWS NAQFC 48hr dust surface concentration. Identifies Saharan dust plumes and regional dust storms. When PM10 is elevated but this layer shows dust, it\'s not smoke.', color:'#d9a963' }
    ];
    layerInfo.forEach(function(li) {
      var sl = smokeLayers[li.key];
      var available = li.key === 'hms' ? !!smokeGeoJsonLayer : !!sl.layer;
      var on = sl.active;
      h += '<div style="flex:1;padding:4px 5px;background:rgba(255,255,255,.02);border-radius:4px;border:1px solid ' + (on ? li.color + '40' : 'transparent') + ';cursor:pointer;" onclick="toggleSmokeLayer(\'' + li.key + '\');openSmokeDetail();">';
      h += '<div style="font-size:.34rem;font-weight:700;color:' + (on ? li.color : '#555') + ';">' + (on ? ' ' : ' ') + li.label + '</div>';
      h += '<div style="font-size:.26rem;color:#666;line-height:1.2;margin-top:1px;">' + li.desc + '</div>';
      if (sl.timeExtent) {
        var hrs = Math.round((sl.timeExtent.end - new Date()) / 3600000);
        h += '<div style="font-size:.24rem;color:#444;margin-top:1px;">Forecast range: ' + (hrs > 0 ? hrs + 'hr ahead' : 'expired') + '</div>';
      }
      if (!available) h += '<div style="font-size:.24rem;color:#f44;">Data unavailable</div>';
      h += '</div>';
    });
    h += '</div>';

    // Surface vs Column comparison
    h += '<div style="padding:5px 7px;background:rgba(139,92,246,.04);border-radius:5px;border-left:2px solid #8b5cf6;margin-bottom:6px;">';
    h += '<div style="font-size:.40rem;font-weight:700;color:#8b5cf6;margin-bottom:2px;"> SURFACE vs COLUMN COMPARISON</div>';
    h += '<div style="font-size:.34rem;color:#aaa;line-height:1.35;">';
    h += 'Professional smoke forecasters compare surface and column smoke to determine smoke altitude. ';
    h += '<b>Column only</b> = smoke at altitude, not yet impacting ground level. ';
    h += '<b>Both surface + column</b> = smoke has mixed down to breathing zone. ';
    h += '<b>Surface only</b> = shallow, locally-trapped smoke (inversion).</div>';

    if (intel.smokeAloft && intel.aloftDetail) {
      h += '<div style="margin-top:4px;padding:3px 5px;background:rgba(139,92,246,.06);border-radius:3px;">';
      h += '<div style="font-size:.36rem;color:#8b5cf6;font-weight:700;"> SMOKE ALOFT DETECTED</div>';
      h += '<div style="font-size:.32rem;color:#aaa;line-height:1.3;">' + intel.aloftDetail + '</div>';
      h += '</div>';
    } else if (intel.aloftDetail) {
      h += '<div style="margin-top:4px;font-size:.32rem;color:#aaa;">' + intel.aloftDetail + '</div>';
    } else {
      h += '<div style="margin-top:4px;font-size:.32rem;color:#555;">No smoke aloft vs surface discrepancy detected. Enable both SFC and COL layers on the map to visually compare.</div>';
    }
    h += '</div>';

    // How to use
    h += '<div style="padding:4px 7px;background:rgba(255,255,255,.02);border-radius:4px;margin-bottom:2px;">';
    h += '<div style="font-size:.36rem;font-weight:700;color:#ddd;margin-bottom:2px;"> HOW TO READ SMOKE LAYERS</div>';
    h += '<div style="font-size:.32rem;color:#888;line-height:1.35;">';
    h += '<b style="color:#f97316;">SFC (orange)</b>  Toggle on to see where smoke is at ground level right now. This is the layer that affects your air quality and health.<br>';
    h += '<b style="color:#8b5cf6;">COL (purple)</b>  Toggle on to see total smoke in the atmosphere from ground to 25km altitude. Compare with SFC: areas where COL is visible but SFC is not have smoke aloft that hasn\'t descended yet.<br>';
    h += '<b style="color:#fbbf24;">HMS (yellow outlines)</b>  Satellite-observed smoke plume boundaries from NOAA analysts. Confirms where smoke actually is, vs model predictions.<br>';
    h += '<b style="color:#ef4444;">CAN (red, )</b>  Environment Canada\'s RAQDPS-FireWork model. 72-hour forecast of PM2.5 specifically from wildfire smoke. This model specifically tracks Canadian fire emissions and their transport into the US  invaluable during cross-border smoke events. Compare with NWS SFC to see where US and Canadian models agree.<br>';
    h += 'When Canadian smoke arrives, it often appears in COL, HMS, and CAN 12-24 hours before NWS SFC  giving you advance warning before air quality deteriorates.';
    h += '</div></div>';

    // Sources
    h += '<div style="font-size:.26rem;color:#444;padding:2px 5px;">';
    h += 'Sources: <a href="https://airquality.weather.gov/" target="_blank" rel="noopener" style="color:#555;">NWS NAQFC</a>  ';
    h += '<a href="https://www.ospo.noaa.gov/products/land/hms.html" target="_blank" rel="noopener" style="color:#555;">NOAA HMS</a>  ';
    h += '<a href="https://rapidrefresh.noaa.gov/hrrr/HRRRsmoke/" target="_blank" rel="noopener" style="color:#555;">HRRR-Smoke</a>  ';
    h += '<a href="https://weather.gc.ca/firework/" target="_blank" rel="noopener" style="color:#555;">ECCC FireWork</a>  ';
    h += '<a href="https://cwfis.cfs.nrcan.gc.ca/" target="_blank" rel="noopener" style="color:#555;">CWFIS</a>';
    h += '</div>';

    openSmokeModal(h);
  }

  function openSmokeModal(bodyHtml) {
    var existing = document.getElementById('smoke-detail-modal');
    if (existing) existing.remove();
    var modal = document.createElement('div');
    modal.id = 'smoke-detail-modal';
    modal.innerHTML = '<div style="margin:auto;background:linear-gradient(145deg,rgba(30,30,35,0.98),rgba(20,20,25,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:16px;max-width:520px;width:90vw;max-height:85vh;overflow:auto;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.7);">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.2);">' +
        '<span style="font-size:15px;font-weight:700;color:#f97316;"> SMOKE LAYERS</span>' +
        '<button onclick="var m=document.getElementById(\'smoke-detail-modal\');if(m)m.remove();document.body.style.overflow=\'\';" style="background:none;border:none;color:#888;font-size:24px;cursor:pointer;padding:0 6px;line-height:1;">&times;</button>' +
      '</div>' +
      '<div style="padding:14px 16px;overflow-y:auto;flex:1;color:#e0e0e0;font-size:13px;line-height:1.5;">' + bodyHtml + '</div>' +
    '</div>';
    modal.setAttribute('style', 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:999999;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;overflow:auto;');
    modal.onclick = function(e) { if (e.target === modal) { modal.remove(); document.body.style.overflow = ''; } };
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
  }

  //  Replace old loadHRRRSmokeOverlay with new system 
  function loadHRRRSmokeOverlay() {
    loadNWSSmokeForecasts();
  }
  
  // ============ CITY/STATE LABELS TOGGLE ============
  function toggleFireLabels(){
    var btn = document.getElementById("fire-labels-toggle");
    fireLabelsVisible = !fireLabelsVisible;
    
    if (fireLabelsVisible){
      if (!fireLabelsLayer){
        fireLabelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap, &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 12
        }).addTo(fireMap);
      } else {
        fireMap.addLayer(fireLabelsLayer);
      }
      if (btn) {
        btn.innerHTML = ' ON';
        btn.style.color = '#22c55e';
        btn.style.borderColor = 'rgba(34,197,94,.4)';
      }
    } else {
      if (fireLabelsLayer && fireMap.hasLayer(fireLabelsLayer)){
        fireMap.removeLayer(fireLabelsLayer);
      }
      if (btn) {
        btn.innerHTML = ' OFF';
        btn.style.color = 'rgba(255,255,255,.4)';
        btn.style.borderColor = 'rgba(255,255,255,.15)';
      }
    }
  }
  
  window.toggleFireLabels = toggleFireLabels;
  window.switchHazardTab = switchHazardTab;
  window.showHazardTooltip = showHazardTooltip;
  window.toggleHazardInsight = toggleHazardInsight;
  window.switchHazardOutlook = switchHazardOutlook;
  window.switchFloodScope = switchFloodScope;
  window.toggleAlertFilter = toggleAlertFilter;
  
  // ============ AQI CURSOR TRACKING ============
  
  
  
  
  

  // ============ MACROSTRAT GEOLOGY MAPS ============
  var bedrockMap = null;
  var lithologyMap = null;
  var stratMap = null;
  
  // Macrostrat tile and API endpoints
  var MACROSTRAT_TILES = 'https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png';
  var MACROSTRAT_API = 'https://macrostrat.org/api/v2/geologic_units/map';
  
  // Cache for geology data to avoid repeated API calls
  var geologyCache = {};
  
  function initGeologyMaps(){
    initBedrockMap();
    initLithologyMap();
    initStratMap();
  }
  
  // ============ BEDROCK GEOLOGY MAP ============
  function initBedrockMap(){
    var container = document.getElementById("bedrock-map");
    var infoPill = document.getElementById("bedrock-info-pill");
    
    if (!container || typeof L === "undefined") return;

    if (bedrockMap) bedrockMap.remove();
    bedrockMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 8,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 14
    });

    // Base layer - light map
    L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(bedrockMap);
    
    // Macrostrat geology overlay
    L.tileLayer(MACROSTRAT_TILES, {
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
      opacity: 0.75
    }).addTo(bedrockMap);
    
    // Location marker removed for cleaner map

    // Click handler for geology info
    bedrockMap.on('click', function(e){
      fetchGeologyAtPoint(e.latlng.lat, e.latlng.lng, 'bedrock', infoPill);
    });
    
    // Load initial geology for current location
    fetchGeologyAtPoint(LOCATION.lat, LOCATION.lon, 'bedrock', infoPill);
  }
  
  // ============ LITHOLOGY MAP ============
  function initLithologyMap(){
    var container = document.getElementById("lithology-map");
    var infoPill = document.getElementById("lithology-info-pill");
    
    if (!container || typeof L === "undefined") return;

    if (lithologyMap) lithologyMap.remove();
    lithologyMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 9,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 14
    });

    // Base layer
    L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(lithologyMap);
    
    // Macrostrat geology overlay with higher opacity for lithology focus
    L.tileLayer(MACROSTRAT_TILES, {
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
      opacity: 0.85
    }).addTo(lithologyMap);
    


    // Click handler
    lithologyMap.on('click', function(e){
      fetchGeologyAtPoint(e.latlng.lat, e.latlng.lng, 'lithology', infoPill);
    });
    
    // Load initial
    fetchGeologyAtPoint(LOCATION.lat, LOCATION.lon, 'lithology', infoPill);
  }
  
  // ============ STRATIGRAPHY MAP ============
  function initStratMap(){
    var container = document.getElementById("strat-map");
    var infoPill = document.getElementById("strat-info-pill");
    
    if (!container || typeof L === "undefined") return;

    if (stratMap) stratMap.remove();
    stratMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 7,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 14
    });

    // Base layer
    L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(stratMap);
    
    // Macrostrat geology overlay
    L.tileLayer(MACROSTRAT_TILES, {
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
      opacity: 0.70
    }).addTo(stratMap);
    
    // Location marker removed for cleaner map

    // Click handler
    stratMap.on('click', function(e){
      fetchGeologyAtPoint(e.latlng.lat, e.latlng.lng, 'strat', infoPill);
    });
    
    // Load initial
    fetchGeologyAtPoint(LOCATION.lat, LOCATION.lon, 'strat', infoPill);
  }
  
  // ============ FETCH GEOLOGY DATA FROM MACROSTRAT ============
  function fetchGeologyAtPoint(lat, lng, mapType, infoPill){
    var cacheKey = lat.toFixed(4) + ',' + lng.toFixed(4);
    
    // Check cache first
    if (geologyCache[cacheKey]){
      displayGeologyInfo(geologyCache[cacheKey], mapType, infoPill);
      return;
    }
    
    var url = MACROSTRAT_API + '?lat=' + lat + '&lng=' + lng;
    
    fetchWithTimeout(url, null, 10000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.success && data.success.data && data.success.data.length > 0){
          geologyCache[cacheKey] = data.success.data;
          displayGeologyInfo(data.success.data, mapType, infoPill);
        } else {
          hideGeologyInfo(mapType, infoPill);
        }
      })
      .catch(function(err){
        console.log("Macrostrat API error:", err);
        hideGeologyInfo(mapType, infoPill);
      });
  }
  
  function displayGeologyInfo(units, mapType, infoPill){
    if (!infoPill || !units || units.length === 0) return;
    
    var unit = units[0]; // Primary unit at surface
    
    if (mapType === 'bedrock'){
      var nameEl = document.getElementById("bedrock-unit-name");
      var ageEl = document.getElementById("bedrock-age");
      var lithEl = document.getElementById("bedrock-lith");
      
      if (nameEl) nameEl.textContent = unit.strat_name || unit.name || "Unknown Unit";
      if (ageEl){
        var ageStr = "";
        if (unit.b_int_name && unit.t_int_name){
          if (unit.b_int_name === unit.t_int_name){
            ageStr = unit.b_int_name;
          } else {
            ageStr = unit.t_int_name + "  " + unit.b_int_name;
          }
        } else if (unit.b_age && unit.t_age){
          ageStr = unit.t_age.toFixed(1) + "  " + unit.b_age.toFixed(1) + " Ma";
        }
        ageEl.textContent = ageStr ? " " + ageStr : "";
      }
      if (lithEl){
        var liths = unit.lith ? unit.lith.map(function(l){ return l.name || l; }).join(", ") : "";
        lithEl.textContent = liths ? " " + liths : "";
      }
    } else if (mapType === 'lithology'){
      var primaryEl = document.getElementById("lithology-primary");
      var descEl = document.getElementById("lithology-desc");
      
      var primaryLith = "";
      var lithDesc = "";
      
      if (unit.lith && unit.lith.length > 0){
        // Sort by proportion if available
        var sorted = unit.lith.slice().sort(function(a,b){
          return (b.prop || 0) - (a.prop || 0);
        });
        primaryLith = sorted[0].name || sorted[0];
        
        // Build description with proportions
        lithDesc = sorted.map(function(l){
          var pct = l.prop ? Math.round(l.prop * 100) + "%" : "";
          return (l.name || l) + (pct ? " (" + pct + ")" : "");
        }).join(", ");
      }
      
      if (primaryEl) primaryEl.textContent = primaryLith ? " " + primaryLith : "Unknown Lithology";
      if (descEl) descEl.textContent = lithDesc || (unit.descrip || "");
    } else if (mapType === 'strat'){
      var columnEl = document.getElementById("strat-column");
      var unitsEl = document.getElementById("strat-units");
      var thickEl = document.getElementById("strat-thickness");
      
      if (columnEl) columnEl.textContent = unit.col_name || unit.strat_name || "Stratigraphic Column";
      
      // Show all units at this location
      var unitNames = units.map(function(u){ return u.strat_name || u.name || "Unnamed"; });
      if (unitsEl) unitsEl.textContent = " " + unitNames.slice(0, 5).join("  ") + (units.length > 5 ? " +" + (units.length - 5) + " more" : "");
      
      // Total thickness
      var totalThick = 0;
      units.forEach(function(u){
        if (u.max_thick) totalThick += u.max_thick;
      });
      if (thickEl) thickEl.textContent = totalThick > 0 ? " ~" + Math.round(totalThick) + " m total thickness" : "";
    }
    
    infoPill.style.display = "block";
  }
  
  function hideGeologyInfo(mapType, infoPill){
    if (infoPill){
      infoPill.style.display = "none";
    }
  }

  // ============ EARTHQUAKE MAP ============
  function initQuakeData(){
    if (!hazardMap) return;

    // Add magnitude legend (square markers for earthquakes)
    var legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'quake-legend');
      div.style.cssText = 'background:rgba(0,0,0,.7); backdrop-filter:blur(8px); padding:5px 8px; border-radius:6px; font-size:8px; font-weight:600; font-family:system-ui,sans-serif; box-shadow:0 2px 8px rgba(0,0,0,.3); ';
      div.innerHTML =
        '<div style="display:flex; flex-direction:column; gap:1px;">' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">&lt;1.5</span><span style="width:5px;height:5px;background:#7dd3fc;transform:rotate(45deg);"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">2.5</span><span style="width:5px;height:5px;background:#84cc16;transform:rotate(45deg);"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">3.5</span><span style="width:6px;height:6px;background:#eab308;transform:rotate(45deg);"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">4.5</span><span style="width:6px;height:6px;background:#f97316;transform:rotate(45deg);"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">5.5+</span><span style="width:7px;height:7px;background:#ef4444;transform:rotate(45deg);"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">7+</span><span style="width:8px;height:8px;background:#7f1d1d;transform:rotate(45deg);"></span></div>' +
        '</div>';
      return div;
    };
    legend.addTo(hazardMap);

    // Load USGS earthquake data
    loadQuakeData();
    setInterval(loadQuakeData, 5 * 60 * 1000);
  }

  function loadQuakeData(){
    var liveEl = document.getElementById("quake-live");
    var url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson";

    fetchWithTimeout(url, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        var quakes = data && data.features;
        
        if (!quakes || quakes.length === 0){
          if (liveEl) liveEl.textContent = " LIVE";
          var statusPill = document.getElementById("quake-status-pill");
          if (statusPill){
            statusPill.textContent = "0 EARTHQUAKES (24H)";
            statusPill.style.color = "#4ade80";
          }
          return;
        }

        var nearbyCount = 0;
        var significantCount = 0;
        var totalCount = 0;

        // Plot ALL global quakes M0.5+
        for (var i = 0; i < quakes.length; i++){
          var q = quakes[i];
          var coords = q.geometry && q.geometry.coordinates;
          var props = q.properties || {};
          
          if (!coords) continue;

          var mag = props.mag || 0;
          var lat = coords[1];
          var lon = coords[0];

          // Only show M0.5+
          if (mag < 0.5) continue;

          totalCount++;

          // Calculate distance
          var dLat = lat - LOCATION.lat;
          var dLon = lon - LOCATION.lon;
          var dist = Math.sqrt(dLat*dLat + dLon*dLon) * 69;

          if (dist < 500) nearbyCount++;
          if (mag >= 5.5) significantCount++;

          // Color by magnitude
          var color;
          if (mag >= 7) color = "#7f1d1d";
          else if (mag >= 6.5) color = "#dc2626";
          else if (mag >= 5.5) color = "#ef4444";
          else if (mag >= 4.5) color = "#f97316";
          else if (mag >= 3.5) color = "#eab308";
          else if (mag >= 2.5) color = "#84cc16";
          else if (mag >= 1.5) color = "#4ade80";
          else color = "#7dd3fc";

          // Size by magnitude - more consistent scaling
          var sz;
          if (mag >= 6) sz = 14;
          else if (mag >= 5) sz = 11;
          else if (mag >= 4) sz = 9;
          else if (mag >= 3) sz = 7;
          else if (mag >= 2) sz = 6;
          else sz = 5;

          var marker = L.marker([lat, lon], {
            icon: L.divIcon({
              className: '',
              html: '<div style="width:'+sz+'px;height:'+sz+'px;background:'+color+';border:1px solid rgba(255,255,255,.7);transform:rotate(45deg);box-shadow:0 0 4px '+color+';"></div>',
              iconSize: [sz, sz],
              iconAnchor: [sz/2, sz/2]
            })
          });
          if(window._quakeLayerGroup) window._quakeLayerGroup.addLayer(marker);
          else marker.addTo(quakeMap);

          var place = props.place || "Unknown";
          var time = props.time ? timeAgo(new Date(props.time)) : "";
          var distMi = Math.round(dist);
          var depth = coords[2] ? coords[2].toFixed(1) : null;
          var depthNum = coords[2] || 99;
          var magLabel = mag >= 7 ? 'MAJOR' : mag >= 5.5 ? 'STRONG' : mag >= 4.5 ? 'MODERATE' : mag >= 2.5 ? 'MINOR' : 'MICRO';

          // Induced seismicity check
          // [lat, lon, radius, name, typDepth, formation, mechanism]
          var _izones = [
            [35.6,-97.2,1.8,'Oklahoma Central',5,'Arbuckle Group','Wastewater disposal'],
            [36.3,-98.2,1.5,'Oklahoma NW',5,'Arbuckle Group','Wastewater disposal'],
            [34.5,-97.0,1.2,'Oklahoma South',6,'Arbuckle Group','Hydraulic fracturing'],
            [31.8,-103.5,2.0,'Permian/Delaware TX',8,'Delaware Basin','Wastewater disposal'],
            [32.0,-101.5,1.5,'Midland Basin TX',8,'Midland Basin','Wastewater disposal'],
            [29.0,-98.5,1.5,'Eagle Ford TX',6,'Eagle Ford','Hydraulic fracturing'],
            [32.8,-97.3,1.0,'Barnett Shale TX',5,'Barnett/Ellenburger','Wastewater disposal'],
            [37.2,-97.5,1.2,'S. Kansas',5,'Arbuckle Group','Wastewater disposal'],
            [39.8,-104.8,0.8,'Denver-Julesburg CO',5,'DJ Basin','Wastewater disposal'],
            [37.2,-104.8,0.8,'Raton Basin CO',4,'Raton Basin','Coal-bed methane'],
            [41.1,-80.7,0.5,'Youngstown OH',4,'Mt. Simon/Knox','Wastewater disposal'],
            [40.8,-81.2,0.4,'E. Canton OH',4,'Knox Dolomite','Hydraulic fracturing'],
            [35.3,-92.3,0.4,'Guy-Greenbrier AR',5,'Ozark Aquifer','Wastewater disposal'],
            [38.5,-80.5,1.0,'Marcellus WV',3,'Marcellus Shale','Hydraulic fracturing'],
            [41.0,-77.5,1.2,'Marcellus PA',3,'Marcellus Shale','Hydraulic fracturing'],
            [32.3,-104.0,1.5,'Delaware Basin NM',8,'Delaware Basin','Wastewater disposal'],
            [44.5,-106.0,0.8,'Powder River WY',4,'Powder River','Coal-bed methane'],
            [32.5,-93.5,0.8,'Haynesville LA',4,'Haynesville Shale','Hydraulic fracturing'],
            [48.0,-103.5,1.5,'Bakken ND',4,'Bakken/Three Forks','Wastewater disposal'],
            [54.4,-116.8,0.8,'Fox Creek AB',4,'Duvernay Shale','Hydraulic fracturing'],
            [56.5,-121.0,1.2,'Montney BC',4,'Montney Formation','Hydraulic fracturing'],
            [38.8,-122.8,0.3,'Geysers CA',3,'Franciscan Complex','Geothermal injection'],
            [38.4,-87.8,0.5,'Mt. Carmel IL',3,'Mt. Simon Sandstone','Wastewater disposal'],
            // Mining-induced seismicity zones (USGS mining seismicity catalog)
            [33.4,-87.0,0.3,'Bessemer AL',0.5,'Coal (longwall)','Mining collapse'],
            [38.7,-107.8,0.4,'Montrose CO',0.5,'Coal (longwall)','Mining collapse'],
            [40.5,-107.0,0.4,'Steamboat Springs CO',0.5,'Coal (longwall)','Mining collapse'],
            [37.3,-83.2,0.5,'Hazard KY',0.3,'Coal (surface)','Mining blast'],
            [47.5,-115.9,0.3,'Wallace/Coeur d\'Alene ID',0.3,'Hard rock (silver)','Rockburst'],
            [44.3,-105.5,0.5,'Gillette WY',0.3,'Coal (surface)','Mining blast'],
            [39.3,-111.3,0.3,'Trail Mountain UT',0.3,'Coal (underground)','Mining collapse'],
            [37.8,-81.2,0.5,'S. West Virginia',0.3,'Coal (surface)','Mining blast'],
            // Reservoir-triggered seismicity zones
            [35.5,-119.0,0.5,'Oroville CA',0.2,'Reservoir fill','Dam impoundment'],
            [38.8,-122.8,0.3,'Geysers CA',3,'Franciscan Complex','Geothermal injection']
          ];
          var inducedTag = '';
          for(var iz=0; iz<_izones.length; iz++){
            var zn = _izones[iz];
            var zDist = Math.sqrt(Math.pow(lat-zn[0],2)+Math.pow(lon-zn[1],2));
            if(zDist <= zn[2]){
              var typD = zn[4];
              var iScore = 2 + (depthNum <= typD+2 ? 3 : depthNum <= typD+5 ? 2 : depthNum <= 15 ? 1 : 0) + (mag < 4 ? 1 : 0);
              var iLabel = iScore >= 5 ? 'LIKELY INDUCED' : iScore >= 3 ? 'POSSIBLY INDUCED' : 'INJECTION ZONE';
              var iCol = iScore >= 5 ? '#f97316' : iScore >= 3 ? '#eab308' : 'rgba(255,255,255,.4)';
              inducedTag = '<div class="hz-card-row"><span class="hz-label">Origin</span><span class="hz-val"><span class="hz-tag" style="background:'+iCol+'22;color:'+iCol+';">'+iLabel+'</span></span></div>';
              inducedTag += '<div class="hz-card-row"><span class="hz-label">Zone</span><span class="hz-val" style="color:rgba(255,255,255,.5);font-size:9px;">'+zn[3]+'</span></div>';
              inducedTag += '<div class="hz-card-row"><span class="hz-label">Cause</span><span class="hz-val" style="color:rgba(255,255,255,.5);font-size:9px;">'+zn[6]+'  '+zn[5]+'</span></div>';
              break;
            }
          }

          var qtt = '<div class="hz-card-head"><div class="hz-accent" style="background:'+color+';"></div><span style="color:'+color+';">M'+mag.toFixed(1)+' EARTHQUAKE</span></div>';
          qtt += '<div class="hz-card-row"><span class="hz-label">Location</span><span class="hz-val" style="text-align:right;max-width:140px;">'+place+'</span></div>';
          qtt += '<div class="hz-card-row"><span class="hz-label">Severity</span><span class="hz-val"><span class="hz-tag" style="background:'+color+'22;color:'+color+';">'+magLabel+'</span></span></div>';
          if(depth) qtt += '<div class="hz-card-row"><span class="hz-label">Depth</span><span class="hz-val">'+depth+' km</span></div>';
          qtt += inducedTag;
          if(distMi < 10000) qtt += '<div class="hz-card-row"><span class="hz-label">Distance</span><span class="hz-val">'+distMi.toLocaleString()+' mi away</span></div>';
          if(time) qtt += '<div class="hz-card-footer">'+time+'  USGS</div>';
          marker.bindTooltip(qtt, { permanent: false, className: 'hz-tooltip', direction: 'top', offset: [0, -4] });

          quakeMarkers.push(marker);
        }

        // Store globally for badge counts
        window._quakeFeatures = quakes;
        window._quakeCount24h = totalCount;
        updateHazardBadges(); try{updateUnifiedPills();}catch(e){}

        // Update status pill
        var statusPill = document.getElementById("quake-status-pill");
        if (statusPill){
          statusPill.textContent = totalCount.toLocaleString() + " EARTHQUAKES (24H)";
          statusPill.style.color = significantCount > 0 ? "#f97316" : "#4ade80";
        }

        // Build dropdown list of top 10 recent quakes sorted by magnitude
        var quakeListEl = document.getElementById("hz-pill-quake-list");
        if (quakeListEl && quakes.length > 0){
          var sorted = quakes.slice().sort(function(a,b){
            return (b.properties.mag || 0) - (a.properties.mag || 0);
          }).slice(0, 5);
          
          var listHtml = "";
          for (var qi = 0; qi < sorted.length; qi++){
            var q = sorted[qi];
            var props = q.properties || {};
            var coords = q.geometry && q.geometry.coordinates;
            var mag = props.mag || 0;
            var place = props.place || "Unknown";
            var lat = coords ? coords[1] : 0;
            var lon = coords ? coords[0] : 0;
            
            // Parse place to get city, state format
            var shortPlace = place;
            if (place.indexOf(" of ") > -1){
              shortPlace = place.split(" of ")[1] || place;
            }
            var parts = shortPlace.split(", ");
            if (parts.length >= 2){
              shortPlace = parts[0] + ", " + parts[1].substring(0,2).toUpperCase();
            }
            
            // Time ago condensed
            var timeStr = "";
            if (props.time){
              var mins = Math.floor((Date.now() - props.time) / 60000);
              if (mins < 60) timeStr = mins + "m";
              else if (mins < 1440) timeStr = Math.floor(mins/60) + "h";
              else timeStr = Math.floor(mins/1440) + "d";
            }
            
            var magColor;
            if (mag >= 6) magColor = "#dc2626";
            else if (mag >= 5) magColor = "#ef4444";
            else if (mag >= 4) magColor = "#f97316";
            else if (mag >= 3) magColor = "#eab308";
            else magColor = "#4ade80";
            
            listHtml += '<div class="quake-item" onclick="window.flyToQuake('+lat+','+lon+','+mag+')" style="padding:2px 0;cursor:pointer;display:flex;align-items:center;gap:4px;font-size:.42rem;">' +
              '<span style="color:'+magColor+';font-weight:800;min-width:22px;text-align:right;">'+mag.toFixed(1)+'</span>' +
              '<span style="color:rgba(255,255,255,.8);font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+shortPlace+'</span>' +
              '<span style="color:rgba(255,255,255,.35);font-weight:600;">'+timeStr+'</span>' +
            '</div>';
          }
          
          quakeListEl.innerHTML = listHtml;
        }
        
        // Global function for quake click
        window.flyToQuake = function(lat, lon, mag){
          if (quakeMap && !isNaN(lat) && !isNaN(lon)){
            var zoom = mag >= 6 ? 6 : (mag >= 4 ? 7 : 8);
            quakeMap.flyTo([lat, lon], zoom, { duration: 1 });
          }
        };

        if (liveEl) liveEl.textContent = " LIVE";
      })
      .catch(function(){
        if (liveEl) liveEl.textContent = " OFFLINE";
      });
  }

  // Keep old name for compat
  function initQuakeMap(){ initQuakeData(); }

  // Fetch geology for earthquake map clicks - shows popup at click location
  function fetchGeologyForQuakeMap(lat, lng, latlng){
    var cacheKey = lat.toFixed(4) + ',' + lng.toFixed(4);
    
    // Check cache first
    if (geologyCache[cacheKey]){
      showQuakeGeologyPopup(geologyCache[cacheKey], latlng || L.latLng(lat, lng));
      return;
    }
    
    var url = MACROSTRAT_API + '?lat=' + lat + '&lng=' + lng;
    
    fetchWithTimeout(url, null, 10000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.success && data.success.data && data.success.data.length > 0){
          geologyCache[cacheKey] = data.success.data;
          if (latlng) showQuakeGeologyPopup(data.success.data, latlng);
        }
      })
      .catch(function(err){});
  }
  
  var quakeGeoLayer = null;
  var quakeGeoVisible = false;
  
  window.toggleQuakeGeology = function(){
    var toggleEl = document.getElementById('quake-geo-toggle');
    if (!hazardMap) return;
    
    quakeGeoVisible = !quakeGeoVisible;
    window._quakeGeoVisible = quakeGeoVisible;
    
    if (quakeGeoVisible){
      if(window.quakeGeoTileLayer && !hazardMap.hasLayer(window.quakeGeoTileLayer)){
        window.quakeGeoTileLayer.addTo(hazardMap);
      }
      quakeGeoLayer = window.quakeGeoTileLayer;
      if (toggleEl) {
        toggleEl.style.color = '#22c55e';
        toggleEl.style.borderColor = 'rgba(34,197,94,.4)';
        toggleEl.innerHTML = ' ON';
      }
    } else {
      if(window.quakeGeoTileLayer && hazardMap.hasLayer(window.quakeGeoTileLayer)){
        hazardMap.removeLayer(window.quakeGeoTileLayer);
      }
      quakeGeoLayer = null;
      if (toggleEl) {
        toggleEl.style.color = 'rgba(255,255,255,.4)';
        toggleEl.style.borderColor = 'rgba(255,255,255,.15)';
        toggleEl.innerHTML = ' OFF';
      }
    }
  };

  // 
  // EPA ENVIRONMENTAL HAZARD LAYERS  Superfund + TRI + OpenAQ
  // 
  window._epaLayerGroup = L.layerGroup();
  window._epaVisible = {};
  window._epaData = { superfund: [], tri: [], openaq: [] };
  window._epaLoaded = false;

  function loadEpaData(){
    if(window._epaLoaded) return Promise.resolve();
    window._epaLoaded = true;

    var bounds = hazardMap.getBounds();
    var bbox = bounds.getSouth()+','+bounds.getWest()+','+bounds.getNorth()+','+bounds.getEast();

    // EPA Envirofacts  Superfund NPL sites (layer 0)
    var sfUrl = 'https://geopub.epa.gov/arcgis/rest/services/EMEF/efpoints/MapServer/0/query?where=1%3D1&outFields=PRIMARY_NAME,LATITUDE83,LONGITUDE83,EPA_ID,STREET_ADDR,CITY_NAME,STATE_CODE,POSTAL_CODE,NPL_STATUS,FEDERAL_FACILITY&geometryType=esriGeometryEnvelope&geometry='+encodeURIComponent(JSON.stringify({xmin:bounds.getWest(),ymin:bounds.getSouth(),xmax:bounds.getEast(),ymax:bounds.getNorth(),spatialReference:{wkid:4326}}))+
      '&inSR=4326&outSR=4326&f=json&resultRecordCount=500';

    // EPA Envirofacts  TRI Toxic Releases (layer 1)
    var triUrl = 'https://geopub.epa.gov/arcgis/rest/services/EMEF/efpoints/MapServer/1/query?where=1%3D1&outFields=PRIMARY_NAME,LATITUDE83,LONGITUDE83,EPA_ID,STREET_ADDR,CITY_NAME,STATE_CODE,NAICS_CODES,SIC_CODES,facility_url&geometryType=esriGeometryEnvelope&geometry='+encodeURIComponent(JSON.stringify({xmin:bounds.getWest(),ymin:bounds.getSouth(),xmax:bounds.getEast(),ymax:bounds.getNorth(),spatialReference:{wkid:4326}}))+
      '&inSR=4326&outSR=4326&f=json&resultRecordCount=500';

    var p1 = fetchWithTimeout(sfUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if(data && data.features){
          window._epaData.superfund = data.features.map(function(f){
            var a = f.attributes;
            return { lat: a.LATITUDE83, lon: a.LONGITUDE83, name: a.PRIMARY_NAME, id: a.EPA_ID,
              addr: a.STREET_ADDR, city: a.CITY_NAME, state: a.STATE_CODE, zip: a.POSTAL_CODE,
              status: a.NPL_STATUS, federal: a.FEDERAL_FACILITY, type:'superfund' };
          }).filter(function(s){ return s.lat && s.lon; });
        }
      }).catch(function(e){ console.warn('EPA Superfund load error', e); });

    var p2 = fetchWithTimeout(triUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if(data && data.features){
          window._epaData.tri = data.features.map(function(f){
            var a = f.attributes;
            return { lat: a.LATITUDE83, lon: a.LONGITUDE83, name: a.PRIMARY_NAME, id: a.EPA_ID,
              addr: a.STREET_ADDR, city: a.CITY_NAME, state: a.STATE_CODE,
              naics: a.NAICS_CODES, sic: a.SIC_CODES, url: a.facility_url, type:'tri' };
          }).filter(function(s){ return s.lat && s.lon; });
        }
      }).catch(function(e){ console.warn('EPA TRI load error', e); });

    return Promise.all([p1, p2]).then(function(){
      console.log('[EPA] Loaded ' + window._epaData.superfund.length + ' Superfund + ' + window._epaData.tri.length + ' TRI sites');
    });
  }

  function renderEpaMarkers(){
    window._epaLayerGroup.clearLayers();

    // NAICS code  industry lookup
    var naicsMap = {'211':'Oil & Gas Extraction','212':'Mining','221':'Utilities','311':'Food Mfg',
      '322':'Paper Mfg','324':'Petroleum & Coal','325':'Chemical Mfg','326':'Plastics & Rubber',
      '327':'Nonmetallic Mineral','331':'Primary Metal','332':'Fabricated Metal','333':'Machinery',
      '334':'Computer/Electronic','335':'Electrical Equipment','336':'Transportation Equipment',
      '337':'Furniture Mfg','339':'Misc Manufacturing','562':'Waste Management','486':'Pipeline Transport'};

    function getIndustry(naics){
      if(!naics) return 'Industrial Facility';
      var codes = naics.split(',');
      for(var i=0;i<codes.length;i++){
        var c3 = codes[i].trim().substring(0,3);
        if(naicsMap[c3]) return naicsMap[c3];
      }
      return 'Industrial Facility';
    }

    // Superfund markers  larger,  biohazard style
    window._epaData.superfund.forEach(function(s){
      var statusCol = '#a855f7'; // purple default
      var statusLabel = s.status || 'NPL Site';
      if(s.status && s.status.indexOf('Final') >= 0){ statusCol = '#ef4444'; statusLabel = 'NPL FINAL'; }
      else if(s.status && s.status.indexOf('Proposed') >= 0){ statusCol = '#f97316'; statusLabel = 'PROPOSED'; }
      else if(s.status && s.status.indexOf('Deleted') >= 0){ statusCol = '#22c55e'; statusLabel = 'DELETED (Cleaned)'; }

      var icon = L.divIcon({
        className:'',
        html:'<div style="width:14px;height:14px;background:'+statusCol+'25;border:2px solid '+statusCol+';border-radius:2px;transform:rotate(45deg);display:flex;align-items:center;justify-content:center;"><div style="width:4px;height:4px;background:'+statusCol+';border-radius:50%;transform:rotate(-45deg);"></div></div>',
        iconSize:[14,14], iconAnchor:[7,7]
      });

      var m = L.marker([s.lat,s.lon],{icon:icon}).addTo(window._epaLayerGroup);
      m.bindTooltip(
        '<div style="background:rgba(8,8,20,.94);backdrop-filter:blur(16px);border:1px solid rgba(168,85,247,.3);border-radius:8px;padding:8px 10px;min-width:180px;max-width:260px;font-family:system-ui,sans-serif;">' +
        '<div style="border-left:3px solid '+statusCol+';padding-left:6px;margin-bottom:4px;">' +
        '<div style="font-size:.52rem;font-weight:800;color:#fff;letter-spacing:.3px;"> SUPERFUND SITE</div>' +
        '<div style="font-size:.42rem;color:rgba(255,255,255,.5);">EPA National Priorities List</div></div>' +
        '<div style="display:flex;flex-direction:column;gap:2px;">' +
        '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;white-space:nowrap;flex-shrink:0;">Site</span><span style="color:#fff;font-size:.4rem;font-weight:700;text-align:right;overflow:hidden;text-overflow:ellipsis;">'+s.name+'</span></div>' +
        '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;white-space:nowrap;flex-shrink:0;">Status</span><span style="color:'+statusCol+';font-size:.4rem;font-weight:700;">'+statusLabel+'</span></div>' +
        '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;white-space:nowrap;flex-shrink:0;">EPA ID</span><span style="color:rgba(255,255,255,.7);font-size:.4rem;">'+s.id+'</span></div>' +
        (s.addr ? '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;white-space:nowrap;flex-shrink:0;">Address</span><span style="color:rgba(255,255,255,.6);font-size:.38rem;text-align:right;overflow:hidden;text-overflow:ellipsis;">'+s.addr+', '+s.city+' '+s.state+'</span></div>' : '') +
        (s.federal === 'Y' ? '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;">Type</span><span style="color:#f97316;font-size:.4rem;font-weight:700;">FEDERAL FACILITY</span></div>' : '') +
        '<div style="font-size:.34rem;color:rgba(255,255,255,.3);margin-top:2px;line-height:1.3;">Superfund sites are contaminated locations requiring long-term cleanup of hazardous materials  may contain heavy metals, solvents, radioactive waste, or industrial chemicals.</div>' +
        '</div></div>',
        { permanent:false, direction:'top', offset:[0,-10], className:'leaflet-tooltip-dark' }
      );
    });

    // TRI markers  smaller circles
    window._epaData.tri.forEach(function(t){
      var industry = getIndustry(t.naics);
      var triCol = '#eab308'; // yellow for TRI
      if(industry === 'Chemical Mfg') triCol = '#ef4444';
      else if(industry === 'Oil & Gas Extraction' || industry === 'Petroleum & Coal') triCol = '#f97316';
      else if(industry === 'Waste Management') triCol = '#a855f7';
      else if(industry === 'Primary Metal' || industry === 'Mining') triCol = '#dc2626';

      var icon = L.divIcon({
        className:'',
        html:'<div style="width:8px;height:8px;background:'+triCol+'40;border:1.5px solid '+triCol+';border-radius:50%;"></div>',
        iconSize:[8,8], iconAnchor:[4,4]
      });

      var m = L.marker([t.lat,t.lon],{icon:icon}).addTo(window._epaLayerGroup);
      m.bindTooltip(
        '<div style="background:rgba(8,8,20,.94);backdrop-filter:blur(16px);border:1px solid rgba(234,179,8,.3);border-radius:8px;padding:8px 10px;min-width:180px;max-width:260px;font-family:system-ui,sans-serif;">' +
        '<div style="border-left:3px solid '+triCol+';padding-left:6px;margin-bottom:4px;">' +
        '<div style="font-size:.52rem;font-weight:800;color:#fff;letter-spacing:.3px;"> TRI FACILITY</div>' +
        '<div style="font-size:.42rem;color:rgba(255,255,255,.5);">Toxic Release Inventory  650+ chemicals</div></div>' +
        '<div style="display:flex;flex-direction:column;gap:2px;">' +
        '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;white-space:nowrap;flex-shrink:0;">Facility</span><span style="color:#fff;font-size:.4rem;font-weight:700;text-align:right;overflow:hidden;text-overflow:ellipsis;">'+t.name+'</span></div>' +
        '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;white-space:nowrap;flex-shrink:0;">Industry</span><span style="color:'+triCol+';font-size:.4rem;font-weight:700;">'+industry+'</span></div>' +
        '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;white-space:nowrap;flex-shrink:0;">EPA ID</span><span style="color:rgba(255,255,255,.7);font-size:.4rem;">'+t.id+'</span></div>' +
        (t.addr ? '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;white-space:nowrap;flex-shrink:0;">Location</span><span style="color:rgba(255,255,255,.6);font-size:.38rem;text-align:right;overflow:hidden;text-overflow:ellipsis;">'+t.city+', '+t.state+'</span></div>' : '') +
        (t.naics ? '<div style="display:flex;justify-content:space-between;gap:8px;"><span style="color:rgba(255,255,255,.4);font-size:.38rem;white-space:nowrap;flex-shrink:0;">NAICS</span><span style="color:rgba(255,255,255,.5);font-size:.38rem;">'+t.naics+'</span></div>' : '') +
        '<div style="font-size:.34rem;color:rgba(255,255,255,.3);margin-top:2px;line-height:1.3;">TRI facilities report annual releases of 650+ toxic chemicals to air, water, and land. Reports include disposal quantities, pollution prevention activities, and chemical-specific data.</div>' +
        '</div></div>',
        { permanent:false, direction:'top', offset:[0,-6], className:'leaflet-tooltip-dark' }
      );
    });
  }

  window.toggleEpaLayer = function(tab){
    var toggleId = tab + '-epa-toggle';
    var toggleEl = document.getElementById(toggleId);
    if(!hazardMap) return;

    var isVis = !!window._epaVisible[tab];
    window._epaVisible[tab] = !isVis;

    if(!isVis){
      // Show  load data if needed, then render
      if(toggleEl){
        toggleEl.style.color = '#a855f7';
        toggleEl.style.borderColor = 'rgba(168,85,247,.5)';
        toggleEl.style.background = 'rgba(168,85,247,.15)';
        toggleEl.innerHTML = ' ON';
      }
      loadEpaData().then(function(){
        renderEpaMarkers();
        if(!hazardMap.hasLayer(window._epaLayerGroup)){
          window._epaLayerGroup.addTo(hazardMap);
        }
      });
    } else {
      // Hide
      if(toggleEl){
        toggleEl.style.color = tab==='flood' ? 'rgba(168,85,247,.6)' : 'rgba(255,255,255,.4)';
        toggleEl.style.borderColor = tab==='flood' ? 'rgba(168,85,247,.3)' : 'rgba(255,255,255,.15)';
        toggleEl.style.background = tab==='flood' ? 'rgba(168,85,247,.1)' : 'rgba(0,0,0,.3)';
        toggleEl.innerHTML = ' '+(tab==='flood'?'EPA':'OFF');
      }
      if(hazardMap.hasLayer(window._epaLayerGroup)){
        hazardMap.removeLayer(window._epaLayerGroup);
      }
    }
  };

  // Hide EPA layer on tab switch (unless that tab also has it on)
  (function(){
    var origSwitch = window.switchHazardTab;
    if(origSwitch){
      window.switchHazardTab = function(tab){
        // Hide EPA layer unless new tab has it toggled on
        if(hazardMap && hazardMap.hasLayer(window._epaLayerGroup) && !window._epaVisible[tab]){
          hazardMap.removeLayer(window._epaLayerGroup);
        }
        // Show EPA layer if new tab has it toggled on
        if(window._epaVisible[tab] && !hazardMap.hasLayer(window._epaLayerGroup) && window._epaLoaded){
          window._epaLayerGroup.addTo(hazardMap);
        }
        origSwitch(tab);
      };
    }
  })();

  function showQuakeGeologyPopup(units, latlng){
    if (!quakeMap || !units || units.length === 0) return;
    
    var unit = units[0];
    var name = unit.strat_name || unit.name || "Unknown";
    
    // Build compact content
    var unitNames = units.slice(0, 3).map(function(u){ return u.strat_name || u.name || "Unnamed"; });
    var moreText = units.length > 3 ? " +" + (units.length - 3) : "";
    
    // Age info
    var ageStr = "";
    if (unit.b_int_name && unit.t_int_name){
      if (unit.b_int_name === unit.t_int_name){
        ageStr = unit.b_int_name;
      } else {
        ageStr = unit.t_int_name + " - " + unit.b_int_name;
      }
    }
    var numericAge = "";
    if (unit.t_age != null && unit.b_age != null){
      numericAge = Math.round(unit.t_age) + " - " + Math.round(unit.b_age) + " Ma";
    }
    
    var content = '<div style="font-size:11px; max-width:180px;">' +
      '<div style="color:#2563eb; font-weight:700; margin-bottom:2px;">' + name + '</div>' +
      (ageStr ? '<div style="color:#059669; font-size:10px; font-weight:600;">' + ageStr + '</div>' : '') +
      (numericAge ? '<div style="color:#888; font-size:9px;">' + numericAge + '</div>' : '') +
      '<div style="color:#555; font-size:10px; margin-top:2px;">' + unitNames.join(" > ") + moreText + '</div>' +
    '</div>';
    
    L.popup({ closeButton: false, offset: [0, -5], className: 'quake-geo-popup' })
      .setLatLng(latlng)
      .setContent(content)
      .openOn(quakeMap);
  }

  // Helper: time ago
  function timeAgo(date){
    var now = new Date();
    var diff = now - date;
    var mins = Math.floor(diff / 60000);
    var hours = Math.floor(diff / 3600000);
    var days = Math.floor(diff / 86400000);

    if (mins < 60) return mins + "m ago";
    if (hours < 24) return hours + "h ago";
    return days + "d ago";
  }

  initHazardMaps();

  /* =========================================================
     WEATHER ALERTS (NWS API)
     ========================================================= */
  var DEMO_ALERTS = false; // Set to true to see sample alerts
  
  var alertGeometries = [];
  
  // Check if user location is within SPC tornado outlook polygons
  function checkSPCTornadoRisk(callback){
    var spcUrl = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/3/query?where=1%3D1&outFields=*&f=geojson';
    fetch(spcUrl).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features || data.features.length === 0){ callback(null); return; }
      
      var userLat = LOCATION.lat;
      var userLon = LOCATION.lon;
      var highestRisk = null;
      var highestPct = 0;
      
      data.features.forEach(function(f){
        var label = (f.properties.LABEL || f.properties.label || '').toString();
        var pct = parseFloat(label) || 0;
        if (pointInGeoJSON(userLat, userLon, f.geometry) && pct > highestPct){
          highestPct = pct;
          highestRisk = f;
        }
      });
      
      if (highestRisk && highestPct >= 2){
        // Also check categorical outlook
        var catUrl = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/1/query?where=1%3D1&outFields=*&f=geojson';
        fetch(catUrl).then(function(r2){ return r2.json(); }).then(function(catData){
          var catLevel = '';
          if (catData.features){
            catData.features.forEach(function(f){
              if (pointInGeoJSON(userLat, userLon, f.geometry)){
                catLevel = (f.properties.LABEL || f.properties.label || '').toUpperCase().trim();
              }
            });
          }
          
          var riskDesc = highestPct + '% tornado probability';
          if (catLevel && catLevel !== 'TSTM') riskDesc += ' (' + catLevel + ' risk)';
          
          var syntheticAlert = {
            _synthetic: true,
            properties: {
              event: 'SPC Tornado Outlook',
              headline: 'SPC Day 1 Tornado Outlook  ' + riskDesc,
              severity: highestPct >= 10 ? 'Extreme' : (highestPct >= 5 ? 'Severe' : 'Moderate'),
              description: 'The Storm Prediction Center has issued a Day 1 outlook indicating a ' + highestPct + '% probability of a tornado within 25 miles of your location.' + (catLevel ? ' Overall convective risk level: ' + catLevel + '.' : '') + ' Monitor local conditions and have a safety plan ready.',
              instruction: 'Stay weather-aware today. Monitor NOAA Weather Radio or local media for watches and warnings. Know your shelter location.',
              areaDesc: 'Your area',
              senderName: 'NOAA Storm Prediction Center',
              expires: new Date(new Date().setHours(23,59,59)).toISOString(),
              effective: new Date().toISOString(),
              onset: new Date().toISOString()
            }
          };
          callback(syntheticAlert);
        }).catch(function(){ callback(null); });
      } else {
        callback(null);
      }
    }).catch(function(){ callback(null); });
  }
  
  // Ray-casting point-in-polygon for GeoJSON
  function pointInGeoJSON(lat, lon, geometry){
    if (!geometry) return false;
    var polys = [];
    if (geometry.type === 'Polygon'){
      polys = [geometry.coordinates];
    } else if (geometry.type === 'MultiPolygon'){
      polys = geometry.coordinates;
    } else { return false; }
    
    for (var p = 0; p < polys.length; p++){
      var ring = polys[p][0]; // outer ring
      if (pointInRing(lat, lon, ring)) return true;
    }
    return false;
  }
  
  function pointInRing(lat, lon, ring){
    var inside = false;
    for (var i = 0, j = ring.length - 1; i < ring.length; j = i++){
      var xi = ring[i][0], yi = ring[i][1];
      var xj = ring[j][0], yj = ring[j][1];
      if ((yi > lat) !== (yj > lat) && lon < (xj - xi) * (lat - yi) / (yj - yi) + xi){
        inside = !inside;
      }
    }
    return inside;
  }

  function loadWeatherAlerts(){
    var alertsEl = document.getElementById("weather-alerts");
    if (!alertsEl) return;
    
    alertGeometries = []; // Reset
    
    // Demo mode to preview alert styles
    if (DEMO_ALERTS){
      var demoHtml = 
        '<div class="weather-alert warning">' +
          '<span class="weather-alert-icon"></span>' +
          '<span class="weather-alert-text">' +
            '<span class="weather-alert-title">Winter Storm Warning</span>' +
            '<span class="weather-alert-expires"> Expires in 8h</span>' +
          '</span>' +
        '</div>' +
        '<div class="weather-alert watch">' +
          '<span class="weather-alert-icon"></span>' +
          '<span class="weather-alert-text">' +
            '<span class="weather-alert-title">Flood Watch</span>' +
            '<span class="weather-alert-expires"> Expires in 24h</span>' +
          '</span>' +
        '</div>' +
        '<div class="weather-alert advisory">' +
          '<span class="weather-alert-icon"></span>' +
          '<span class="weather-alert-text">' +
            '<span class="weather-alert-title">Wind Advisory</span>' +
            '<span class="weather-alert-expires"> Expires in 6h</span>' +
          '</span>' +
        '</div>';
      alertsEl.innerHTML = demoHtml;
      return;
    }
    
    var url = "https://api.weather.gov/alerts/active?point=" + LOCATION.lat + "," + LOCATION.lon;
    
    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        var features = data && data.features;
        if (!features) features = [];
        
        // Sort: life-threatening alerts first, then by severity
        function alertPriority(f){
          var ev = (f.properties.event || '').toLowerCase();
          var sev = (f.properties.severity || '').toLowerCase();
          // TIER 1: Immediate life threat
          if (ev.indexOf('tornado') >= 0 && ev.indexOf('warning') >= 0) return 0;
          if (ev.indexOf('hurricane') >= 0 && ev.indexOf('warning') >= 0) return 1;
          if (ev.indexOf('flash flood') >= 0 && ev.indexOf('warning') >= 0) return 2;
          if (ev.indexOf('tsunami') >= 0 && ev.indexOf('warning') >= 0) return 3;
          if (ev.indexOf('earthquake') >= 0) return 4;
          if (ev.indexOf('fire') >= 0 && ev.indexOf('warning') >= 0) return 5;
          if (ev.indexOf('extreme wind') >= 0) return 6;
          if (ev.indexOf('storm surge') >= 0 && ev.indexOf('warning') >= 0) return 7;
          // TIER 2: Watches for life-threatening events
          if (ev.indexOf('tornado') >= 0 && ev.indexOf('watch') >= 0) return 10;
          if (ev.indexOf('hurricane') >= 0 && ev.indexOf('watch') >= 0) return 11;
          if (ev.indexOf('flash flood') >= 0 && ev.indexOf('watch') >= 0) return 12;
          if (ev.indexOf('tsunami') >= 0 && ev.indexOf('watch') >= 0) return 13;
          if (ev.indexOf('fire') >= 0 && ev.indexOf('watch') >= 0) return 14;
          if (ev.indexOf('storm surge') >= 0 && ev.indexOf('watch') >= 0) return 15;
          // TIER 3: Severe weather warnings
          if (ev.indexOf('severe thunderstorm') >= 0 && ev.indexOf('warning') >= 0) return 20;
          if (ev.indexOf('blizzard') >= 0 && ev.indexOf('warning') >= 0) return 21;
          if (ev.indexOf('ice storm') >= 0) return 22;
          if (ev.indexOf('flood') >= 0 && ev.indexOf('warning') >= 0) return 23;
          if (ev.indexOf('winter storm') >= 0 && ev.indexOf('warning') >= 0) return 24;
          if (ev.indexOf('high wind') >= 0 && ev.indexOf('warning') >= 0) return 25;
          // TIER 4: Watches
          if (ev.indexOf('severe thunderstorm') >= 0 && ev.indexOf('watch') >= 0) return 30;
          if (ev.indexOf('flood') >= 0 && ev.indexOf('watch') >= 0) return 31;
          if (ev.indexOf('winter storm') >= 0 && ev.indexOf('watch') >= 0) return 32;
          if (ev.indexOf('watch') >= 0) return 35;
          // TIER 5: By severity
          if (sev === 'extreme') return 40;
          if (sev === 'severe') return 45;
          // TIER 6: Advisories and statements
          if (ev.indexOf('warning') >= 0) return 50;
          if (sev === 'moderate') return 55;
          if (ev.indexOf('advisory') >= 0) return 60;
          if (ev.indexOf('statement') >= 0) return 70;
          return 80;
        }
        features.sort(function(a, b){ return alertPriority(a) - alertPriority(b); });
        
        //  Cache alerts globally for tooltip live insights 
        window._nwsAlerts = features.map(function(f){ return f.properties.event || 'Alert'; });
        
        // Also check SPC tornado outlook for user's location
        checkSPCTornadoRisk(function(spcAlert){
          if (!features.length && !spcAlert){
            alertsEl.innerHTML = '';
            return;
          }
          
          // Build combined list: SPC outlook first if exists and no active tornado warning
          var hasTornadoWarning = features.some(function(f){
            var ev = (f.properties.event || '').toLowerCase();
            return ev.indexOf('tornado') >= 0 && ev.indexOf('warning') >= 0;
          });
          
          var allAlerts = [];
          if (spcAlert && !hasTornadoWarning){
            allAlerts.push(spcAlert);
          }
          features.forEach(function(f){ allAlerts.push(f); });
          
          var html = "";
          var shown = allAlerts.length;
        
          for (var i = 0; i < shown; i++){
            var isSynthetic = allAlerts[i]._synthetic;
            var alert = isSynthetic ? allAlerts[i].properties : allAlerts[i].properties;
          var event = alert.event || "Alert";
          var headline = alert.headline || event;
          var severity = (alert.severity || "").toLowerCase();
          var urgency = alert.urgency || "";
          var expires = alert.expires ? new Date(alert.expires) : null;
          var effective = alert.effective ? new Date(alert.effective) : null;
          var onset = alert.onset ? new Date(alert.onset) : effective;
          
          // Sanity check: if onset is after expires, swap them or use effective
          if (onset && expires && onset > expires) {
            onset = effective || expires;
          }
        
          var description = alert.description || "";
          var instruction = alert.instruction || "";
          var areaDesc = alert.areaDesc || "";
          var senderName = alert.senderName || "";
          
          // Get first sentence of description for summary
          var summary = "";
          if (description){
            // Extract snow/rain amounts from description
            var precipAmount = "";
            
            // Look for snow amounts (e.g., "6 to 10 inches", "4-8 inches of snow")
            var snowMatch = description.match(/(\d+\.?\d*)\s*to\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?(?:snow|accumulation)/i) ||
                           description.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?(?:snow|accumulation)/i) ||
                           description.match(/(?:snow|accumulation)[^\d]*(\d+\.?\d*)\s*to\s*(\d+\.?\d*)\s*inch/i);
            
            if (snowMatch){
              precipAmount = " " + snowMatch[1] + "-" + snowMatch[2] + '"';
            } else {
              // Try single amount
              var singleSnow = description.match(/(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?snow/i) ||
                              description.match(/snow[^\d]*(\d+\.?\d*)\s*inch/i);
              if (singleSnow){
                precipAmount = " " + singleSnow[1] + '"';
              }
            }
            
            // Look for rain amounts if no snow found
            if (!precipAmount){
              var rainMatch = description.match(/(\d+\.?\d*)\s*to\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?rain/i) ||
                             description.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?rain/i);
              if (rainMatch){
                precipAmount = " " + rainMatch[1] + "-" + rainMatch[2] + '"';
              } else {
                var singleRain = description.match(/(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?rain/i);
                if (singleRain){
                  precipAmount = " " + singleRain[1] + '"';
                }
              }
            }
            
            // Look for wind speeds
            var windAmount = "";
            var windMatch = description.match(/wind[^\d]*(\d+)\s*to\s*(\d+)\s*mph/i) ||
                           description.match(/(\d+)\s*to\s*(\d+)\s*mph\s*wind/i);
            if (windMatch){
              windAmount = " " + windMatch[1] + "-" + windMatch[2] + " mph";
            }
            
            // Clean up NWS formatting (remove * WHAT..., * WHERE..., etc)
            var cleanDesc = description
              .replace(/\*\s*WHAT\.\.\./gi, '')
              .replace(/\*\s*WHERE\.\.\./gi, '')
              .replace(/\*\s*WHEN\.\.\./gi, '')
              .replace(/\*\s*IMPACTS\.\.\./gi, '')
              .replace(/\*\s*ADDITIONAL DETAILS\.\.\./gi, '')
              .replace(/^\s*[\*\-]\s*/gm, '')
              .trim();
            
            var firstSentence = cleanDesc.split(/\.(?:\s|$)/)[0];
            if (firstSentence && firstSentence.length > 10){
              summary = firstSentence.length > 120 ? firstSentence.substring(0, 117) + "..." : firstSentence + ".";
            }
            
            // Add precip/wind amounts to summary
            var amounts = [precipAmount, windAmount].filter(function(a){ return a; }).join("  ");
            if (amounts){
              summary = amounts + (summary ? "    " + summary : "");
            }
          }
          
          // Format areas (truncate if too long)
          var areasStr = "";
          if (areaDesc){
            areasStr = areaDesc.length > 80 ? areaDesc.substring(0, 77) + "..." : areaDesc;
          }
          
          // Determine alert class
          var alertClass = "statement";
          var icon = "";
          var evLower = event.toLowerCase();
          var isTornado = evLower.indexOf("tornado") >= 0;
          var isSevereTS = evLower.indexOf("severe thunderstorm") >= 0;
          var isHurricane = evLower.indexOf("hurricane") >= 0 || evLower.indexOf("typhoon") >= 0 || evLower.indexOf("tropical") >= 0;
          var isFlashFlood = evLower.indexOf("flash flood") >= 0;
          var isFlood = evLower.indexOf("flood") >= 0;
          var isFire = evLower.indexOf("fire") >= 0 || evLower.indexOf("red flag") >= 0;
          var isEarthquake = evLower.indexOf("earthquake") >= 0;
          var isTsunami = evLower.indexOf("tsunami") >= 0;
          
          if (isTornado){
            alertClass = "tornado";
            icon = "";
          } else if (isHurricane){
            alertClass = "warning";
            icon = "";
          } else if (isTsunami){
            alertClass = "warning";
            icon = "";
          } else if (isEarthquake){
            alertClass = "warning";
            icon = "";
          } else if (isFire){
            alertClass = "warning";
            icon = "";
          } else if (isFlashFlood){
            alertClass = "warning";
            icon = "";
          } else if (evLower.indexOf("warning") >= 0 || severity === "extreme" || severity === "severe"){
            alertClass = "warning";
            icon = "";
          } else if (evLower.indexOf("watch") >= 0 || severity === "moderate"){
            alertClass = "watch";
            icon = "";
          } else if (evLower.indexOf("advisory") >= 0){
            alertClass = "advisory";
            icon = "";
          }
          
          // Helper for 12-hour time with AM/PM
          function fmt12WithAMPM(d){
            if (!d || !isFinite(d.getTime())) return "--:--";
            var h = d.getHours();
            var m = d.getMinutes();
            var ampm = h >= 12 ? "PM" : "AM";
            var hh = h % 12; if (hh === 0) hh = 12;
            return String(hh) + ":" + (m < 10 ? "0"+m : m) + " " + ampm;
          }
          
          // Format time window
          var timeWindow = "";
          var now = new Date();
          
          if (onset && expires){
            var onsetTime = fmt12WithAMPM(onset);
            var expiresTime = fmt12WithAMPM(expires);
            var onsetDay = fmtMonthDay(onset);
            var expiresDay = fmtMonthDay(expires);
            var todayStr = fmtMonthDay(now);
            var tomorrowDate = new Date(now);
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            var tomorrowStr = fmtMonthDay(tomorrowDate);
            
            // Check if already in effect
            var hasStarted = onset <= now;
            
            if (hasStarted){
              // Already in effect - show when it ends
              if (expiresDay === todayStr){
                timeWindow = "In effect until " + expiresTime + " today";
              } else if (expiresDay === tomorrowStr){
                timeWindow = "In effect until " + expiresTime + " tomorrow";
              } else {
                timeWindow = "In effect until " + expiresDay + " at " + expiresTime;
              }
            } else {
              // Not started yet - show full window
              if (onsetDay === todayStr && expiresDay === todayStr){
                timeWindow = "Today " + onsetTime + " to " + expiresTime;
              } else if (onsetDay === todayStr && expiresDay === tomorrowStr){
                timeWindow = "Today " + onsetTime + " to tomorrow " + expiresTime;
              } else if (onsetDay === tomorrowStr && expiresDay === tomorrowStr){
                timeWindow = "Tomorrow " + onsetTime + " to " + expiresTime;
              } else if (onsetDay === tomorrowStr){
                timeWindow = "Tomorrow " + onsetTime + " to " + expiresDay + " " + expiresTime;
              } else {
                timeWindow = onsetDay + " at " + onsetTime + " to " + expiresDay + " at " + expiresTime;
              }
            }
          } else if (expires){
            var expiresTime = fmt12WithAMPM(expires);
            var expiresDay = fmtMonthDay(expires);
            var todayStr = fmtMonthDay(now);
            var tomorrowStr = fmtMonthDay(new Date(now.getTime() + 86400000));
            
            if (expiresDay === todayStr){
              timeWindow = "Until " + expiresTime + " today";
            } else if (expiresDay === tomorrowStr){
              timeWindow = "Until " + expiresTime + " tomorrow";
            } else {
              timeWindow = "Until " + expiresDay + " at " + expiresTime;
            }
          }
          
          // Severity badge
          var severityBadge = "";
          if (severity === "extreme"){
            severityBadge = '<span class="weather-alert-severity extreme">Extreme</span>';
          } else if (severity === "severe"){
            severityBadge = '<span class="weather-alert-severity severe">Severe</span>';
          } else if (severity === "moderate"){
            severityBadge = '<span class="weather-alert-severity moderate">Moderate</span>';
          }
          
          html += '<div class="weather-alert ' + alertClass + '" data-alert-index="' + i + '" style="cursor:pointer;" title="Click for full details">' +
            '<span class="weather-alert-icon">' + icon + '</span>' +
            '<span class="weather-alert-text">' +
              '<span class="weather-alert-title">' + event + '</span>' +
              (timeWindow ? '<span class="weather-alert-time"> ' + timeWindow + '</span>' : '') +
              (summary ? '<span class="weather-alert-summary">' + summary + '</span>' : '') +
            '</span>' +
            severityBadge +
          '</div>';
          
          // Store alert geometry for radar overlay
          if (features[i].geometry){
            alertGeometries.push({
              geometry: features[i].geometry,
              event: event,
              severity: severity,
              alertClass: alertClass
            });
          }
        }
        
        alertsEl.innerHTML = html;
        
        // Scroll indicator: hide fade when scrolled to bottom, update fade color
        alertsEl.removeEventListener('scroll', alertsEl._scrollHandler);
        alertsEl._scrollHandler = function(){
          var atBottom = alertsEl.scrollHeight - alertsEl.scrollTop - alertsEl.clientHeight < 8;
          alertsEl.classList.toggle('scrolled-bottom', atBottom);
        };
        alertsEl.addEventListener('scroll', alertsEl._scrollHandler);
        
        // Toggle classes based on alert count
        alertsEl.classList.remove("single-alert", "many-alerts", "alerts-overflowing");
        if (shown === 1){
          alertsEl.classList.add("single-alert");
        } else if (shown >= 2){
          alertsEl.classList.add("many-alerts");
        }
        
        // Only add fade mask if content actually overflows
        setTimeout(function(){
          if (alertsEl.scrollHeight > alertsEl.clientHeight + 8){
            alertsEl.classList.add("alerts-overflowing");
          }
          alertsEl._scrollHandler();
        }, 100);

        // Store features globally for modal access
        window.alertFeatures = allAlerts;
        
        // Add click handlers to open alert detail modal
        var alertDivs = alertsEl.querySelectorAll('.weather-alert[data-alert-index]');
        alertDivs.forEach(function(div){
          div.addEventListener('click', function(){
            var idx = parseInt(this.getAttribute('data-alert-index'));
            if (!isNaN(idx) && window.alertFeatures && window.alertFeatures[idx]) {
              openAlertModal(window.alertFeatures[idx]);
            }
          });
        });
        
        // Draw alert zones on radar if map exists
        setTimeout(drawAlertPolygonsOnRadar, 1000);
        }); // end checkSPCTornadoRisk callback
      })
      .catch(function(err){
        console.log("Weather alerts error:", err);
        alertsEl.innerHTML = '';
      });
  }

  // Draw alert polygons on radar map
  function drawAlertPolygonsOnRadar(){
    if (typeof L === 'undefined' || !window.radarMap) return;
    
    // Remove existing alert layers
    if (window.radarAlertLayers){
      window.radarAlertLayers.forEach(function(layer){
        window.radarMap.removeLayer(layer);
      });
    }
    window.radarAlertLayers = [];
    
    if (alertGeometries.length === 0) return;
    
    alertGeometries.forEach(function(alert){
      var color = '#3b82f6'; // default blue
      var fillOpacity = 0.15;
      
      if (alert.alertClass === 'warning'){
        color = '#ef4444'; // red
        fillOpacity = 0.2;
      } else if (alert.alertClass === 'watch'){
        color = '#f97316'; // orange
        fillOpacity = 0.18;
      } else if (alert.alertClass === 'advisory'){
        color = '#eab308'; // yellow
        fillOpacity = 0.15;
      }
      
      try {
        var geoJsonLayer = L.geoJSON(alert.geometry, {
          style: {
            color: color,
            weight: 2,
            opacity: 0.8,
            fillColor: color,
            fillOpacity: fillOpacity
          }
        }).addTo(window.radarMap);
        
        geoJsonLayer.bindTooltip(
          '<div class="hz-card-head"><div class="hz-accent" style="background:'+color+';"></div><span style="color:'+color+';">'+alert.event.toUpperCase()+'</span></div>' +
          (alert.areaDesc ? '<div class="hz-card-row"><span class="hz-label">Area</span><span class="hz-val" style="max-width:160px;text-align:right;font-size:9px;">'+alert.areaDesc+'</span></div>' : '') +
          '<div class="hz-card-footer">NWS</div>',
          { sticky: true, className: 'hz-tooltip' }
        );
        window.radarAlertLayers.push(geoJsonLayer);
      } catch(e){
        console.log("Error drawing alert polygon:", e);
      }
    });
  }
  
  // Update TODAY Timeline NOW marker every minute
  setInterval(function(){
    var tlNowMarker = document.getElementById("today-tl-now-marker");
    var tlNowTime = document.getElementById("today-tl-now-time");
    
    if (tlNowMarker && tlNowMarker.style.display !== "none"){
      var now = new Date();
      var dayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
      var timelineStart = dayLocal.getTime();
      var timelineEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999).getTime();
      var timelineSpan = timelineEnd - timelineStart;
      
      var nowPct = ((now.getTime() - timelineStart) / timelineSpan) * 100;
      
      if (nowPct >= 0 && nowPct <= 100){
        tlNowMarker.style.left = nowPct + "%";
        if (tlNowTime) tlNowTime.textContent = fmt12NoSuffixFromDate(now);
      }
    }
  }, 60 * 1000);

  /* =========================================================
     UNIFIED WIDGET POPUP MODAL SYSTEM
     ========================================================= */
  var widgetModal = document.getElementById("widget-modal");
  var widgetModalBody = document.getElementById("widget-modal-body");
  var widgetModalClose = document.getElementById("widget-modal-close");
  var modalAnimationTimers = [];

  var MODAL_CONTENT_TYPES = { IMAGE: 'image', CARD: 'card', MAP: 'map' };

  var WIDGET_CONFIG = {
    'radar-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'LOCAL RADAR',
      subtitle: function(){ return LOCATION.radarName || 'NWS'; },
      getFrames: function(){ 
        var STATION = LOCATION.radar || "KENX";
        return ["https://radar.weather.gov/ridge/standard/" + STATION + "_loop.gif?cb=" + Date.now()];
      }
    },
    'goes-canvas': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GOES SATELLITE',
      subtitle: 'GEOCOLOR',
      getFrames: function(){ return goesFrames; },
      fps: 3.3
    },
    'aurora-canvas': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'AURORA FORECAST',
      subtitle: 'SWPC OVATION',
      getFrames: function(){ return auroraAnim.frames; },
      fps: 5
    },
    'enlil-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'SOLAR WIND',
      subtitle: 'WSA-ENLIL',
      getFrames: function(){ return animations.enlil.frames; },
      fps: 8
    },
    'lasco-c3-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'LASCO C3 CORONAGRAPH',
      subtitle: 'NASA/ESA SOHO',
      getFrames: function(){ return animations.lascoC3.frames; },
      fps: 6
    },
    'lasco-c2-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'LASCO C2 CORONAGRAPH',
      subtitle: 'NASA/ESA SOHO',
      getFrames: function(){ return animations.lascoC2.frames; },
      fps: 6
    },
    'suvi-map-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'SUVI THEMATIC MAP',
      subtitle: 'NOAA GOES',
      getFrames: function(){ return suviMapAnim.frames; },
      fps: 6.7
    },
    'pfss-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'SOLAR MAGNETIC FIELD',
      subtitle: 'NASA SDO PFSS',
      getFrames: function(){ var el = document.getElementById('pfss-img'); return el ? [el.src] : []; }
    },
    'geo-vel-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GEOSPACE VELOCITY',
      subtitle: 'SWPC',
      getFrames: function(){ var el = document.getElementById('geo-vel-img'); return el ? [el.src] : []; }
    },
    'geo-den-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GEOSPACE DENSITY',
      subtitle: 'SWPC',
      getFrames: function(){ var el = document.getElementById('geo-den-img'); return el ? [el.src] : []; }
    },
    'geo-pre-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GEOSPACE PRESSURE',
      subtitle: 'SWPC',
      getFrames: function(){ var el = document.getElementById('geo-pre-img'); return el ? [el.src] : []; }
    },
    'fcast-radar-img': {
      type: MODAL_CONTENT_TYPES.IMAGE,
      get title(){ 
        var p = fcastState.product;
        var titleMap = {'500mb':'GFS 500MB VORTICITY & HEIGHTS','10mb':'10MB STRATOSPHERIC TEMPERATURE','precip_type':'GFS PRECIP TYPE','snow_accum':'GFS SNOW ACCUMULATION','temperature':'GFS 1000-500MB THICKNESS & PRECIP','precip_total':'GFS TOTAL PRECIPITATION','wind':'GFS WIND & MSLP','cape':'GFS CAPE & CIN','jet_stream':'GFS JET STREAM 250MB','humidity':'GFS 700MB HUMIDITY'};
        return titleMap[p] || 'GFS SIM RADAR';
      },
      get subtitle(){ 
        var p = fcastState.product;
        if (p === '500mb') return 'NCEP MAG  North America';
        if (p === '10mb') return 'CPC  Northern Hemisphere';
        return 'NCEP MAG  CONUS';
      },
      getFrames: function(){
        var fhrs = getActiveFhrs();
        var frames = [];
        for (var i = 0; i < fhrs.length; i++){
          frames.push(buildFcastUrl(i));
        }
        return frames;
      },
      fps: 3
    },
    'gfs-500mb-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      get title(){ return gfsState.activeTab === '10mb' ? '10mb STRATOSPHERIC TEMPERATURE' : 'GFS 500mb VORTICITY & HEIGHTS'; },
      get subtitle(){ return gfsState.activeTab === '10mb' ? 'CPC  Northern Hemisphere' : 'NCEP MAG  North America'; },
      getFrames: function(){ 
        var frames = [];
        if(gfsState.activeTab === '10mb'){
          for(var i = 0; i < gfsState.fhrs10.length; i++){
            frames.push(buildGfsUrl('10mb', i));
          }
        } else {
          for(var i = 0; i < gfsState.fhrs500.length; i += 2){
            frames.push(buildGfsUrl('500mb', i));
          }
        }
        return frames;
      },
      get fps(){ return gfsState.activeTab === '10mb' ? 2 : 4; }
    }
  };

  var CARD_CONFIG = {
    'nightsky': { title: 'NIGHT SKY', subtitle: 'Planet Visibility' }
  };

  var MAP_CONFIG = {
    'lightning-map': { title: 'LIGHTNING', subtitle: 'Blitzortung + Macrostrat', sourceUrl: 'https://www.blitzortung.org/en/live_lightning_maps.php', sourceMap: function(){ return lightningMap; }, markers: function(){ return lightningMarkers; } },
    'national-radar-map': { title: 'NATIONAL RADAR', subtitle: 'IEM NEXRAD', sourceUrl: 'https://mesonet.agron.iastate.edu/GIS/ridge.phtml', sourceMap: function(){ return nationalRadarMap; }, markers: function(){ return []; } }
  };

  function clearModalAnimations(){
    modalAnimationTimers.forEach(function(t){ clearInterval(t); clearTimeout(t); });
    modalAnimationTimers = [];
    if (window.modalMap) { window.modalMap.remove(); window.modalMap = null; }
  }

  function updateModalHeader(title, subtitle, sourceUrl){
    var titleEl = document.getElementById("modal-title");
    var subtitleEl = document.getElementById("modal-subtitle");
    if (titleEl) titleEl.textContent = title || '--';
    if (subtitleEl) subtitleEl.textContent = typeof subtitle === 'function' ? subtitle() : (subtitle || '');
    // Make header clickable to source
    var headerEl = document.querySelector(".widget-modal-header");
    if (headerEl){
      headerEl.style.cursor = sourceUrl ? 'pointer' : 'default';
      headerEl.onclick = sourceUrl ? function(e){
        if(e.target.classList.contains('widget-modal-close'))return;
        window.open(sourceUrl,'_blank');
      } : null;
      if(subtitleEl && sourceUrl) subtitleEl.style.textDecoration = 'underline';
      else if(subtitleEl) subtitleEl.style.textDecoration = 'none';
    }
  }

  function positionModalAtViewport(el){
    el.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.88);z-index:99999;padding:24px;box-sizing:border-box;overflow:auto;';
    if (el.parentNode !== document.body) document.body.appendChild(el);
    el.classList.add("active");
    el.scrollIntoView({behavior:'smooth', block:'center'});
  }

  function openImageModal(config, imgId){
    if (!widgetModal || !widgetModalBody) return;
    clearModalAnimations();
    
    updateModalHeader(config.title, config.subtitle, config.sourceUrl);
    widgetModalBody.className = 'widget-modal-body content-image is-loading';
    widgetModalBody.innerHTML = '';
    
    positionModalAtViewport(widgetModal);
    
    var frames = config.getFrames ? config.getFrames() : [];
    if (!frames || frames.length === 0) {
      var srcEl = document.getElementById(imgId);
      if (srcEl && srcEl.src) frames = [srcEl.src];
    }
    
    if (frames && frames.length > 0) {
      var img = document.createElement('img');
      img.onload = function(){ widgetModalBody.classList.remove('is-loading'); };
      img.onerror = function(){ 
        widgetModalBody.classList.remove('is-loading'); 
        widgetModalBody.innerHTML = '<div style="color:#888;font-size:14px;">Image unavailable</div>'; 
      };
      img.src = frames[0] + (frames[0].indexOf('?') >= 0 ? '&' : '?') + 'modal=1&cb=' + Date.now();
      img.alt = config.title || 'Enlarged view';
      if (imgId === 'radar-img' || imgId === 'fcast-radar-img') {
        img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.4) saturate(1.8)';
        widgetModalBody.style.background = '#000';
      }
      widgetModalBody.appendChild(img);
      
      if (frames.length > 1 && config.fps) {
        var idx = 0;
        var interval = 1000 / config.fps;
        var timer = setInterval(function(){
          idx = (idx + 1) % frames.length;
          img.src = frames[idx];
        }, interval);
        modalAnimationTimers.push(timer);
      }
    } else {
      widgetModalBody.classList.remove('is-loading');
      widgetModalBody.innerHTML = '<div style="color:#888;font-size:14px;">Content unavailable</div>';
    }
  }

  function openCardModalUnified(cardEl, config){
    if (!widgetModal || !widgetModalBody) return;
    clearModalAnimations();
    
    updateModalHeader(config.title, config.subtitle, config.sourceUrl);
    widgetModalBody.className = 'widget-modal-body content-card';
    widgetModalBody.innerHTML = '';
    
    var clone = cardEl.cloneNode(true);
    clone.classList.remove('clickable-card');
    clone.style.cursor = 'default';
    clone.style.margin = '0';
    clone.style.padding = '0';
    
    var btns = clone.querySelectorAll('button');
    btns.forEach(function(btn){ if (btn.textContent === '' || btn.textContent === '') btn.style.display = 'none'; });
    
    widgetModalBody.appendChild(clone);
    positionModalAtViewport(widgetModal);
  }

  function openMapModal(config, containerId){
    if (!widgetModal || !widgetModalBody) return;
    clearModalAnimations();
    
    updateModalHeader(config.title, config.subtitle, config.sourceUrl);
    widgetModalBody.className = 'widget-modal-body content-map';
    widgetModalBody.innerHTML = '<div class="modal-map-container" id="modal-map-container" style="position:relative;"></div>';
    
    positionModalAtViewport(widgetModal);
    
    setTimeout(function(){
      var mapContainer = document.getElementById('modal-map-container');
      if (!mapContainer || typeof L === 'undefined') return;
      
      var sourceMap = config.sourceMap ? config.sourceMap() : null;
      var markers = config.markers ? config.markers() : [];
      if (!sourceMap) return;
      
      var center = sourceMap.getCenter();
      var zoom = sourceMap.getZoom();
      
      window.modalMap = L.map(mapContainer, { center: center, zoom: zoom, zoomControl: true, attributionControl: false });
      
      // Add base layers based on map type
      if (containerId === 'fire-map') {
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' }).addTo(window.modalMap);
        // Add smoke heatmap if available
        if (typeof L.heatLayer === 'function' && fireMarkers.length > 0) {
          var smokePoints = [];
          fireMarkers.forEach(function(marker) {
            var latlng = marker.getLatLng();
            var radius = marker.options.radius || 3;
            var intensity = (radius <= 2.5) ? 0.05 : Math.min(radius / 10, 0.7);
            smokePoints.push([latlng.lat, latlng.lng, intensity]);
          });
          L.heatLayer(smokePoints, {
            radius: 6, blur: 3, maxZoom: 4, max: 1.0, minOpacity: 0.25,
            gradient: { 0.0: 'rgba(255,255,200,0)', 0.15: 'rgba(255,240,150,0.55)', 0.3: 'rgba(255,200,80,0.7)', 0.5: 'rgba(255,140,40,0.8)', 0.7: 'rgba(240,80,20,0.88)', 0.85: 'rgba(200,30,30,0.92)', 1.0: 'rgba(140,20,60,0.97)' }
          }).addTo(window.modalMap);
        }
      } else if (containerId === 'national-radar-map') {
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { opacity: 0.7 }).addTo(window.modalMap);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.5 }).addTo(window.modalMap);
        L.tileLayer('https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png?_=' + Date.now(), { opacity: 0.75 }).addTo(window.modalMap);
      } else if (containerId === 'lightning-map') {
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { attribution: TILE_ATTRIB }).addTo(window.modalMap);
      } else {
        L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(window.modalMap);
        L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png', { opacity: containerId === 'quake-map' ? 0.70 : 0.35 }).addTo(window.modalMap);
      }
      
      // Add location marker (except for national radar which shows whole country)
      if (containerId !== 'national-radar-map') {
        L.circleMarker([LOCATION.lat, LOCATION.lon], { radius: 8, fillColor: '#2B22F4', fillOpacity: 0.9, color: '#fff', weight: 2 }).addTo(window.modalMap).bindTooltip(" " + LOCATION.name, { permanent: false });
      }
      
      // Clone markers with popups
      markers.forEach(function(marker){
        var latlng = marker.getLatLng();
        var options = marker.options;
        var newMarker = L.circleMarker(latlng, { radius: options.radius || 5, fillColor: options.fillColor || '#f00', fillOpacity: options.fillOpacity || 0.8, color: options.color || '#fff', weight: options.weight || 1 }).addTo(window.modalMap);
        var tooltip = marker.getTooltip();
        var popup = marker.getPopup();
        if (tooltip) newMarker.bindTooltip(tooltip.getContent(), { permanent: false });
        if (popup) newMarker.bindPopup(popup.getContent(), { closeButton: false });
      });
      
      // Move UI overlays (pills, toggles, legends) into modal map  preserves event handlers
      var sourceWidget = document.getElementById(containerId);
      window._modalOverlaySources = [];
      if (sourceWidget) {
        var parent = sourceWidget.closest('.widget-body');
        if (parent) {
          var overlays = parent.querySelectorAll('[id$="-pill"], [id$="-status-pill"], [id$="-toggle"], .fire-status-wrap, .quake-status-wrap, .smoke-status-pill, .fire-legend, .radar-legend, [id$="-aqi-pill"], [id$="-labels-toggle"]');
          overlays.forEach(function(overlay) {
            window._modalOverlaySources.push({ el: overlay, parent: parent, next: overlay.nextSibling });
            overlay.style.zIndex = '1000';
            overlay.style.pointerEvents = 'auto';
            mapContainer.appendChild(overlay);
          });
        }
      }
      
      setTimeout(function(){ if (window.modalMap) window.modalMap.invalidateSize(); }, 100);
      setTimeout(function(){ if (window.modalMap) window.modalMap.invalidateSize(); }, 300);
    }, 50);
  }

  function restoreModalOverlays(){
    if (window._modalOverlaySources) {
      window._modalOverlaySources.forEach(function(item) {
        if (item.next) {
          item.parent.insertBefore(item.el, item.next);
        } else {
          item.parent.appendChild(item.el);
        }
      });
      window._modalOverlaySources = [];
    }
  }
  function closeWidgetModal(){
    if (!widgetModal) return;
    restoreModalOverlays();
    clearModalAnimations();
    widgetModal.classList.remove("active");
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
    setTimeout(function(){ if (widgetModalBody) { widgetModalBody.innerHTML = ""; widgetModalBody.className = "widget-modal-body"; } }, 300);
  }

  if (widgetModalClose) widgetModalClose.addEventListener("click", closeWidgetModal);
  if (widgetModal) widgetModal.addEventListener("click", function(e){ if (e.target === widgetModal) closeWidgetModal(); });
  document.addEventListener("keydown", function(e){ if (e.key === "Escape" && widgetModal && widgetModal.classList.contains("active")) closeWidgetModal(); });

  function initWidgetPopups(){
    var widgets = document.querySelectorAll(".widget");
    
    widgets.forEach(function(widget){
      // Skip solo/full-width row widgets
      var parentRow = widget.closest('.widgets-row, .widgets-row-two');
      if (parentRow) {
        var widgetChildren = parentRow.querySelectorAll(':scope > .widget');
        if (widgetChildren.length <= 1) return; // Skip popup for solo widgets
      }
      var img = widget.querySelector(".widget-body img");
      var canvas = widget.querySelector(".widget-body canvas");
      var isMapWidget = widget.classList.contains("map-widget");
      var imgId = img ? img.id : (canvas ? canvas.id : null);
      var config = imgId ? WIDGET_CONFIG[imgId] : null;
      
      if (isMapWidget) {
        widget.classList.add("clickable-widget");
        var header = widget.querySelector(".widget-head");
        if (header) {
          header.style.cursor = "pointer";
          var mapContainer = widget.querySelector("[id$='-map']");
          if (!mapContainer) mapContainer = widget.querySelector("iframe[id$='-iframe']");
          var mapId = mapContainer ? mapContainer.id.replace('-iframe', '-map') : null;
          var mapConfig = mapId ? MAP_CONFIG[mapId] : null;
          if (mapConfig) {
            header.addEventListener("click", function(e){
              if (e.target.closest("a")) return;
              openMapModal(mapConfig, mapId);
            });
          }
        }
        return;
      }
      
      if (config) {
        widget.classList.add("clickable-widget");
        widget.addEventListener("click", function(e){
          if (e.target.closest("button") || e.target.closest("a") || e.target.closest("input")) return;
          openImageModal(config, imgId);
        });
      } else if (img || canvas) {
        widget.classList.add("clickable-widget");
        widget.addEventListener("click", function(e){
          if (e.target.closest("button") || e.target.closest("a") || e.target.closest("input")) return;
          var genericConfig = {
            type: MODAL_CONTENT_TYPES.IMAGE,
            title: widget.querySelector(".widget-title") ? widget.querySelector(".widget-title").textContent.replace(' LIVE', '').trim() : 'Image',
            subtitle: '',
            getFrames: function(){
              var el = img || canvas;
              if (el && el.src) return [el.src];
              if (canvas && auroraAnim.frames && auroraAnim.frames.length > 0) return auroraAnim.frames;
              return [];
            }
          };
          openImageModal(genericConfig, imgId);
        });
      }
    });
    
    Object.keys(CARD_CONFIG).forEach(function(cardId){
      var card = document.getElementById(cardId) || document.querySelector("." + cardId);
      if (card) {
        card.classList.add("clickable-card");
        card.addEventListener("click", function(e){
          if (e.target.closest("button") || e.target.closest("a")) return;
          openCardModalUnified(card, CARD_CONFIG[cardId]);
        });
      }
    });
  }

  initWidgetPopups();


  // Voyager 1 live distance updater (every 1 second for real-time counting)
  setInterval(function(){
    var bullets = document.querySelectorAll('.bullet');
    var voyagerBullet = null;
    bullets.forEach(function(b){
      var name = b.querySelector('.bname');
      if (name && name.textContent.indexOf('VOYAGER 1') > -1) voyagerBullet = b;
    });
    if (!voyagerBullet) return;
    var bsub = voyagerBullet.querySelector('.bsub');
    if (!bsub) return;
      var now = new Date();
      var refDate = new Date(Date.UTC(2025, 0, 1, 0, 0, 0));
      var refDistanceMiles = 15215899826.1;
      var speedMph = 38210.55;
      var msSinceRef = now.getTime() - refDate.getTime();
      var hoursSinceRef = msSinceRef / (1000 * 60 * 60);
      var currentMiles = refDistanceMiles + (hoursSinceRef * speedMph);
      var milesFormatted = Math.floor(currentMiles).toLocaleString();
      var currentAU = currentMiles / 92955807.3;
      var lightSeconds = currentAU * 499.004784;
      var lightHours = Math.floor(lightSeconds / 3600);
      var lightMins = Math.floor((lightSeconds % 3600) / 60);
      var lightTimeStr = lightHours + "h " + lightMins + "m";
      var launchDate = new Date(Date.UTC(1977, 8, 5, 12, 56, 0));
      var missionMs = now.getTime() - launchDate.getTime();
      var missionYears = Math.floor(missionMs / (1000 * 60 * 60 * 24 * 365.25));
      var missionMonths = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 365.25)) / (1000 * 60 * 60 * 24 * 30.44));
      var missionDays = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 30.44)) / (1000 * 60 * 60 * 24));
      var missionStr = missionYears + "y " + missionMonths + "m " + missionDays + "d";
      bsub.textContent = "Interstellar space  Local Interstellar Cloud  " + milesFormatted + " mi  Light delay " + lightTimeStr + "  " + speedMph.toLocaleString() + " mph";
      
      // Update mission time in btime
      var voyagerTime = voyagerBullet.querySelector('.btime');
      if (voyagerTime) voyagerTime.textContent = missionStr + " in flight";
    
  }, 1000);

  // ISS live distance updater (interpolates between API refreshes)
  (function(){
    var issState = { lat:0, lon:0, alt:0, speed:0, vis:'', lastFetch:0, speedMph:0,
                     velLat:0, velLon:0 };
    
    function haversineMi(lat1,lon1,lat2,lon2){
      var R=3959,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
      var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    function bearingDir(lat1,lon1,lat2,lon2){
      var y=Math.sin((lon2-lon1)*Math.PI/180)*Math.cos(lat2*Math.PI/180);
      var x=Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180)-Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos((lon2-lon1)*Math.PI/180);
      var b=Math.atan2(y,x)*180/Math.PI; if(b<0)b+=360;
      var dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
      return dirs[Math.round(b/22.5)%16];
    }
    
    function fetchISS(){
      fetch("https://api.wheretheiss.at/v1/satellites/25544")
        .then(function(r){ return r.json(); })
        .then(function(data){
          var prevLat = issState.lat, prevLon = issState.lon;
          issState.lat = data.latitude;
          issState.lon = data.longitude;
          issState.alt = Math.round(data.altitude * 0.621371);
          issState.speedMph = Math.round(data.velocity * 0.621371);
          issState.vis = data.visibility;
          issState.lastFetch = Date.now();
          // Estimate velocity in deg/sec based on orbital speed
          // ISS completes 360 degrees longitude in ~92.68 min
          var orbitPeriodSec = 92.68 * 60;
          issState.velLon = -360 / orbitPeriodSec; // westward drift per sec (due to earth rotation)
          // Lat oscillates sinusoidally with 51.6 deg inclination
          var phase = Math.asin(Math.max(-1, Math.min(1, issState.lat / 51.6)));
          issState.velLat = 51.6 * Math.cos(phase) * (2 * Math.PI / orbitPeriodSec);
        })
        .catch(function(){});
    }
    
    // Fetch every 30 seconds
    fetchISS();
    setInterval(fetchISS, 30000);
    
    // Update display every 1 second by interpolating
    setInterval(function(){
      if (!issState.lastFetch) return;
      var bullets = document.querySelectorAll('.bullet');
      var issBullet = null;
      bullets.forEach(function(b){
        var name = b.querySelector('.bname');
        if (name && name.textContent.indexOf('ISS TRACKER') > -1) issBullet = b;
      });
      if (!issBullet) return;
      
      var elapsed = (Date.now() - issState.lastFetch) / 1000;
      var curLat = issState.lat + issState.velLat * elapsed;
      var curLon = issState.lon + issState.velLon * elapsed;
      while(curLon > 180) curLon -= 360;
      while(curLon < -180) curLon += 360;
      
      var groundDist = Math.round(haversineMi(LOCATION.lat, LOCATION.lon, curLat, curLon));
      var totalDist = Math.round(Math.sqrt(groundDist*groundDist + issState.alt*issState.alt));
      var dirStr = bearingDir(LOCATION.lat, LOCATION.lon, curLat, curLon);
      
      var isNearby = groundDist < 500;
      var btime = issBullet.querySelector('.btime');
      if (btime) {
        btime.textContent = isNearby ? " NEARBY!" : (totalDist.toLocaleString() + " mi " + dirStr);
      }
      
      var bsub = issBullet.querySelector('.bsub');
      if (bsub) {
        // Preserve the next pass info if it exists
        var existing = bsub.textContent;
        var passIdx = existing.indexOf('NEXT PASS');
        var passStr = passIdx > -1 ? '  ' + existing.substring(passIdx) : '';
        bsub.textContent = "Alt " + issState.alt + " mi  " + issState.speedMph.toLocaleString() + " mph  " + issState.vis + passStr;
      }
    }, 1000);
  })();

  // refresh cadences
  setInterval(function(){ loadWeatherForLocation(LOCATION); }, 10 * 60 * 1000);
  setInterval(updateSolarMini, 5 * 60 * 1000);
  setInterval(loadAirQuality, 15 * 60 * 1000);
  setInterval(loadWeatherAlerts, 5 * 60 * 1000);
  setInterval(function(){ if (tornadoMap) loadTornadoReports(); }, 10 * 60 * 1000);
  loadWeatherForLocation(LOCATION);
  loadWeatherAlerts();
  loadAirQuality();

  // ============ INTRO SCREEN ============
  (function initIntroScreen(){
    var ls = document.getElementById('site-loading-screen');
    if (!ls) return;

    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
    window.scrollTo(0, 0);

    var bluishEl = document.getElementById('intro-bluish');
    var voidContainer = document.getElementById('intro-void-container');
    var voidCount = 0;
    var dataReady = false;
    var introStartTime = Date.now();

    // Video crossfade
    // VOID cascades below BLUISH, centered. 7 VOIDs, dismiss when last one appears.
    var maxVoids = 12;
    var voidSpeed = 250;
    var voidFilled = false;

    function addVoid(){
      if (!voidContainer || voidCount >= maxVoids) { voidFilled = true; return false; }
      voidCount++;
      var d = document.createElement('div');
      var op = Math.max(0.35, 0.8 - (voidCount * 0.008));
      d.style.cssText = 'font-family:QelliaRegular,Bodoni Moda,Georgia,serif;font-size:clamp(1.8rem, 6vw, 3.5rem);font-weight:700;letter-spacing:clamp(0.2em, 1.5vw, 0.5em);padding-right:clamp(0.2em, 1.5vw, 0.5em);line-height:1.7;color:rgba(74,158,255,' + op + ');white-space:nowrap';
      d.textContent = 'VOID';
      voidContainer.appendChild(d);
      if (voidCount >= maxVoids) { voidFilled = true; return false; }
      return true;
    }

    var voidTimer = setInterval(function(){
      if (!addVoid()) clearInterval(voidTimer);
    }, voidSpeed);

    // Watch for data ready
    var checkInterval = setInterval(function(){
      var ct = document.querySelector('.cond-text');
      if (ct && ct.textContent && ct.textContent !== '--' && ct.textContent !== ''){
        dataReady = true;
      }
    }, 200);

    function dismissLoading(){
      var dash = document.getElementById('dashboard-content');
      if (dash) dash.style.opacity = '1';
      ls.style.transition = 'opacity 0.3s ease-out';
      ls.style.opacity = '0';
      ls.style.pointerEvents = 'none';
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      setTimeout(function(){
        if (ls && ls.parentNode) ls.parentNode.removeChild(ls);
      }, 400);
    }

    // When VOIDs have filled the viewport, dismiss immediately
    (function waitToDismiss(){
      var recheck = setInterval(function(){
        if (voidFilled){
          clearInterval(recheck);
          clearInterval(checkInterval);
          clearInterval(voidTimer);
          dismissLoading();
        }
      }, 100);
    })();
  })();
  
  // Alert modal close handlers (after DOM ready)
  var alertModalClose = document.getElementById('alert-modal-close');
  var alertModal = document.getElementById('alert-modal');
  if (alertModalClose) alertModalClose.addEventListener('click', closeAlertModal);
  if (alertModal) alertModal.addEventListener('click', function(e){ if (e.target === alertModal) closeAlertModal(); });
  document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && document.getElementById('alert-modal') && document.getElementById('alert-modal').classList.contains('active')) closeAlertModal(); });
  startRadarNwsLoop();
  startAuroraBlackBackground();
  startGoesAutoplay();
  updateSolarMini();
  initSpaceWeatherAnimations();
  initSuviMap();
  initPfss();
  initNowMicroTabs();
  initLocationSwitcher();
  initGfsWidget();
  initFcastWidgets();

  // Auto-detect user location on page load
  (function autoLocate(){
    if (!navigator.geolocation) return; // Fall back to default (NYC)
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = Math.round(pos.coords.latitude * 10000) / 10000;
      var lon = Math.round(pos.coords.longitude * 10000) / 10000;

      // Find nearest radar
      var nearestRadar = { id: "KOKX", name: "NWS Upton", region: "NORTHEAST" };
      if (typeof RADAR_SITES !== "undefined"){
        var bestDist = Infinity;
        for (var r = 0; r < RADAR_SITES.length; r++){
          var rlat = RADAR_SITES[r].lat, rlon = RADAR_SITES[r].lon;
          var d = Math.sqrt(Math.pow(lat - rlat, 2) + Math.pow(lon - rlon, 2));
          if (d < bestDist){ bestDist = d; nearestRadar = RADAR_SITES[r]; }
        }
      }

      var goesSat = lon < -105 ? "G18" : "G19";
      var goesSector;
      if (lon < -105) goesSector = "wus";
      else if (lat > 38) goesSector = "ne";
      else goesSector = "se";

      var guessTz = "America/New_York";
      if (lon < -115) guessTz = "America/Los_Angeles";
      else if (lon < -105) guessTz = "America/Denver";
      else if (lon < -90) guessTz = "America/Chicago";

      fetch("https://api.open-meteo.com/v1/forecast?latitude=" + lat + "&longitude=" + lon + "&current=temperature_2m&timezone=auto")
        .then(function(r){ return r.json(); })
        .then(function(data){
          if (data && data.timezone) guessTz = data.timezone;

          var gpsLoc = {
            id: "gps",
            name: "My Location",
            lat: lat,
            lon: lon,
            tz: guessTz,
            radar: nearestRadar.id,
            radarName: nearestRadar.name,
            radarRegion: nearestRadar.region,
            goes: { sat: goesSat, sector: goesSector }
          };

          var gpsIdx = -1;
          for (var g = 0; g < LOCATIONS.length; g++){
            if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
          }
          if (gpsIdx >= 0) LOCATIONS[gpsIdx] = gpsLoc;
          else LOCATIONS.push(gpsLoc);

          switchLocation("gps");

          // Mark GPS button as active
          var gpsBtn = document.getElementById("loc-gps");
          if (gpsBtn) gpsBtn.classList.add("active");
        })
        .catch(function(){
          // Timezone detection failed, use guess
          var gpsLoc = {
            id: "gps",
            name: "My Location",
            lat: lat,
            lon: lon,
            tz: guessTz,
            radar: nearestRadar.id,
            radarName: nearestRadar.name,
            radarRegion: nearestRadar.region,
            goes: { sat: goesSat, sector: goesSector }
          };

          var gpsIdx = -1;
          for (var g = 0; g < LOCATIONS.length; g++){
            if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
          }
          if (gpsIdx >= 0) LOCATIONS[gpsIdx] = gpsLoc;
          else LOCATIONS.push(gpsLoc);

          switchLocation("gps");
        });
    }, function(){
      // Geolocation denied or failed  stay on default location (NYC)
      // User can still use search or GPS button manually
    }, { enableHighAccuracy: false, timeout: 8000 });
  })();

  // Expose radar mode switcher globally for onclick handlers
  window.switchRadarMode = switchRadarMode;

  // Ensure modals are direct children of body, after all other content
  var alertM = document.getElementById('alert-modal');
  var widgetM = document.getElementById('widget-modal');
  if (alertM) document.body.appendChild(alertM);
  if (widgetM) document.body.appendChild(widgetM);

})();

// Global alert modal functions (outside IIFE for click handler access)
function openAlertModal(feature){
  var existingModal = document.getElementById('dynamic-alert-modal');
  if (existingModal) existingModal.remove();
  
  var alert = feature.properties;
  var event = alert.event || "Weather Alert";
  var severity = (alert.severity || "").toLowerCase();
  var headline = alert.headline || "";
  var description = alert.description || "";
  var instruction = alert.instruction || "";
  var areaDesc = alert.areaDesc || "";
  var senderName = alert.senderName || "";
  var effective = alert.effective ? new Date(alert.effective) : null;
  var onset = alert.onset ? new Date(alert.onset) : null;
  var expires = alert.expires ? new Date(alert.expires) : null;
  
  var icon = "";
  var alertColor = "#3b82f6";
  if (event.toLowerCase().indexOf("tornado") >= 0){
    icon = ""; alertColor = "#ef4444";
  } else if (event.toLowerCase().indexOf("warning") >= 0 || severity === "extreme" || severity === "severe"){
    icon = ""; alertColor = "#ef4444";
  } else if (event.toLowerCase().indexOf("watch") >= 0 || severity === "moderate"){
    icon = ""; alertColor = "#f97316";
  } else if (event.toLowerCase().indexOf("advisory") >= 0){
    icon = ""; alertColor = "#eab308";
  }
  
  function fmtDateTime(d){
    if (!d || !isFinite(d.getTime())) return "--";
    var days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    var h = d.getHours(); var m = d.getMinutes();
    var ampm = h >= 12 ? "PM" : "AM";
    var hh = h % 12; if (hh === 0) hh = 12;
    return days[d.getDay()] + " " + months[d.getMonth()] + " " + d.getDate() + ", " + hh + ":" + (m < 10 ? "0"+m : m) + " " + ampm;
  }
  
  var severityBadge = "";
  if (severity === "extreme") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(220,38,38,0.3);color:#fca5a5;">Extreme</span>';
  else if (severity === "severe") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(239,68,68,0.25);color:#fca5a5;">Severe</span>';
  else if (severity === "moderate") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(249,115,22,0.25);color:#fdba74;">Moderate</span>';
  else if (severity === "minor") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(234,179,8,0.25);color:#fde047;">Minor</span>';
  
  var bodyContent = '';
  if (headline) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:15px;color:' + alertColor + ';">' + headline + severityBadge + '</div></div>';
  bodyContent += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:20px;"><div style="text-align:center;"><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#666;margin-top:8px;margin-bottom:3px;">Effective</div><div style="font-size:14px;color:#fff;font-weight:500;">' + fmtDateTime(effective || onset) + '</div></div><div style="text-align:center;"><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:2px;">Expires</div><div style="font-size:14px;color:#fff;font-weight:500;">' + fmtDateTime(expires) + '</div></div></div>';
  if (description) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Description</div><div style="white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;border-left:3px solid rgba(255,255,255,0.1);">' + description.replace(/\n/g, '<br>') + '</div></div>';
  if (instruction) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Instructions</div><div style="white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;border-left:3px solid rgba(255,255,255,0.1);">' + instruction.replace(/\n/g, '<br>') + '</div></div>';
  if (areaDesc) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Affected Areas</div><div style="font-size:13px;color:#aaa;line-height:1.5;">' + areaDesc + '</div></div>';
  if (senderName) bodyContent += '<div><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Issued By</div><div style="color:#aaa;">' + senderName + '</div></div>';
  
  var modal = document.createElement('div');
  modal.id = 'dynamic-alert-modal';
  modal.innerHTML = '<div style="margin:auto;background:linear-gradient(145deg,rgba(30,30,35,0.98),rgba(20,20,25,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:16px;max-width:600px;width:90vw;max-height:85vh;overflow:auto;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.7);">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.2);">' +
      '<div style="display:flex;align-items:center;gap:12px;">' +
        '<span style="font-size:24px;">' + icon + '</span>' +
        '<span style="font-size:18px;font-weight:600;color:#fff;">' + event + '</span>' +
      '</div>' +
      '<button onclick="closeAlertModal()" style="background:none;border:none;color:#888;font-size:28px;cursor:pointer;padding:0 8px;line-height:1;">&times;</button>' +
    '</div>' +
    '<div style="padding:24px;overflow-y:auto;flex:1;color:#e0e0e0;font-size:14px;line-height:1.6;">' + bodyContent + '</div>' +
  '</div>';
  
  modal.setAttribute('style', 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:999999;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;overflow:auto;');
  modal.onclick = function(e){ if(e.target === modal) closeAlertModal(); };
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  modal.scrollIntoView({behavior:'smooth', block:'center'});
}

function closeAlertModal(){
  var modal = document.getElementById('dynamic-alert-modal');
  if (modal){ modal.remove(); document.documentElement.style.overflow = ''; document.body.style.overflow = ''; }
}

document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeAlertModal(); });

// ============ UNIFIED DROPDOWN SYSTEM ============
(function(){
  var allDropdowns = ['fire-dropdown', 'tornado-dropdown', 'quake-dropdown'];
  var pillMap = {
    'fire-status-pill': 'fire-dropdown',
    'tornado-status-pill': 'tornado-dropdown',
    'quake-status-pill': 'quake-dropdown'
  };

  function closeAllDropdowns(except){
    allDropdowns.forEach(function(id){
      if (id === except) return;
      var dd = document.getElementById(id);
      if (dd){
        dd.style.opacity = '0';
        dd.style.visibility = 'hidden';
        dd.style.pointerEvents = 'none';
      }
    });
  }

  function toggleDropdown(ddId){
    var dd = document.getElementById(ddId);
    if (!dd) return;
    var isOpen = dd.style.opacity === '1';
    closeAllDropdowns(isOpen ? null : ddId);
    dd.style.opacity = isOpen ? '0' : '1';
    dd.style.visibility = isOpen ? 'hidden' : 'visible';
    dd.style.pointerEvents = isOpen ? 'none' : 'auto';
  }

  // Attach click handlers to all pills
  Object.keys(pillMap).forEach(function(pillId){
    var pill = document.getElementById(pillId);
    if (pill){
      pill.style.cursor = 'pointer';
      pill.addEventListener('click', function(e){
        e.stopPropagation();
        toggleDropdown(pillMap[pillId]);
      });
    }
  });

  // Close all dropdowns when clicking outside
  document.addEventListener('click', function(e){
    var insideDropdown = allDropdowns.some(function(id){
      var dd = document.getElementById(id);
      return dd && dd.contains(e.target);
    });
    var insidePill = Object.keys(pillMap).some(function(id){
      var pill = document.getElementById(id);
      return pill && pill.contains(e.target);
    });
    if (!insideDropdown && !insidePill){
      closeAllDropdowns();
    }
  });

  // Close on Escape
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') closeAllDropdowns();
  });
})();
</script>
</div><!-- /dashboard-content -->
</body>
</html>
