<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BLUISH</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,100;1,6..96,400&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,100;1,6..96,400&display=swap" rel="stylesheet"></noscript>
<style>
@font-face {
  font-family: "QelliaRegular";
  src: url('data:font/woff2;base64,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') format('woff2');
  font-display: swap;
}
</style>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
  @import url('https://api.fontshare.com/v2/css?f[]=neue-montreal@200,300,400,500,600,700&display=swap');

  :root{
  /* Core brand blue */
  --panel-blue:#2B22F4;

  /* Text */
  --ink:#2B22F4;
  --ink-dim:rgba(43,34,244,.68);

  /* MORE transparent heavenly whites */
  --paper-strong:rgba(255,255,255,.62);
  --paper:rgba(255,255,255,.48);
  --paper-soft:rgba(255,255,255,.38);

  /* Barely-there structure */
  --stroke:transparent;
  --stroke-2:transparent;


  /* Heavenly glow system */
  --glow-main:
  0 0 160px rgba(43,34,244,.05),
  0 0 300px rgba(43,34,244,.03),
  0 20px 80px rgba(15,23,42,.22);

--glow-mid:
  0 0 100px rgba(43,34,244,.04),
  0 14px 60px rgba(15,23,42,.20);

--glow-soft:
  0 0 70px rgba(43,34,244,.035),
  0 10px 40px rgba(15,23,42,.18);



  --radius-xl:30px;
  --radius-lg:22px;
  --radius-md:16px;
  --radius-sm:12px;

  /* Mobile-first spacing scale */
  --space-xs:4px;
  --space-sm:8px;
  --space-md:12px;
  --space-lg:16px;
  --space-xl:24px;
    
      /* ========= Fog / Haze tuning ========= */
  --fog-white-1: rgba(255,255,255,.18);
  --fog-white-2: rgba(255,255,255,.10);
  --fog-white-3: rgba(255,255,255,.06);

  --fog-blue-1: rgba(43,34,244,.10);
  --fog-blue-2: rgba(43,34,244,.06);
  --fog-blue-3: rgba(43,34,244,.03);

  --fog-blur-strong: blur(34px) saturate(125%);
  --fog-blur-mid:    blur(26px) saturate(120%);
  --fog-blur-soft:   blur(20px) saturate(115%);

}

  *{box-sizing:border-box}
  
  *::before,
  *::after{
    backdrop-filter:none !important;
    -webkit-backdrop-filter:none !important;
  }

  html,
  body{
    margin:0;
    padding:0;
    border:none;
    outline:none;
    box-shadow:none;
    background:transparent;
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
    overflow-x:hidden;
    transform:none !important;
    filter:none !important;
    perspective:none !important;
    contain:none !important;
    will-change:auto !important;
  }

  html{
    height:100%;
  }

  body{
    min-height:100%;
    font-family:'Neue Montreal',system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    color:var(--ink);
  }


  #cloud-soundscape-root{position:relative;min-height:100%;width:100%;transform:none !important;filter:none !important;will-change:auto !important;perspective:none !important;isolation:isolate;contain:layout style;}

  /* =========================
     Layout shell
     ========================= */
  #cloud-soundscape-root main{
    position:relative;
    min-height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:18px;
    z-index:1;
    background:transparent;
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
  }

  #cloud-soundscape-root main::before,
  #cloud-soundscape-root main::after{
    display:none !important;
    content:none !important;
  }

  .panel{
    width:100%;
    max-width:1160px;
    background:none;
    border:none;
    box-shadow:none;
    outline:none;
    display:flex;
    flex-direction:column;
    gap:10px;
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
  }

  .panel::before,
  .panel::after{
    display:none !important;
    content:none !important;
  }

  .content-stack{
    display:flex;
    flex-direction:column;
    gap:10px;
    width:100%;
    background:none;
    box-shadow:none;
  }

  /* =========================
     WEATHER CARD (primary)
     ========================= */
  .weather-card{
  position:relative;
  width:100%;
  background:transparent;
  border:none;
  box-shadow:none;
  overflow:visible;
}

.weather-card > *{ position:relative; z-index:1; }


  /* =========================
     Top grid
     ========================= */
  .top-grid{
    display:block;
    width:100%;
    background:none;
    box-shadow:none;
  }

  /* =========================
     Main Weather Card (Compact)
     ========================= */
  .left-now{
    position:relative;
    padding:14px;
    border-radius:20px;
    background: rgba(255,255,255,.06);
    border:none;
    box-shadow:none;
    backdrop-filter:blur(18px);
    -webkit-backdrop-filter:blur(18px);
  }

  .weather-top-row{
    position:relative;
    display:flex;
    justify-content:flex-start;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    padding-right:100px;
    min-height:120px;
  }

  .weather-main{
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    margin-top:6px;
  }

  .weather-temp-block{
    display:flex;
    flex-direction:column;
  }

  .weather-temp-block .temp{
    font-size:4rem;
    font-weight:740;
    letter-spacing:-.04em;
    line-height:1;
    transition: opacity 0.3s ease;
  }

  .weather-temp-block .feels{
    font-size:.95rem;
    color:var(--ink-dim);
    margin-top:4px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.06em;
  }

  .weather-cond-block{
    display:flex;
    align-items:center;
    gap:8px;
  }

  .weather-cond-block .cond-icon-img{
    width:120px;
    height:120px;
    object-fit:contain;
  }

  .weather-cond-block .cond-text{
    font-size:1rem;
    font-weight:700;
    color:var(--ink);
  }

  .weather-moon-block{
    position:absolute;
    top:-5px;
    right:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:0;
    padding:0;
    background:transparent;
    box-shadow:none;
    z-index:10;
  }

  .weather-moon-block .moon-img{
  width:250px;
  height:250px;
  border-radius:50%;
  object-fit:cover;
  transform:scale(1.15);
  clip-path:circle(42%) !important;
  -webkit-clip-path:circle(42%) !important;
  filter: drop-shadow(0 0 15px rgba(255,255,255,.45)) drop-shadow(0 0 35px rgba(200,210,255,.25));
}

  .weather-moon-block .moon-text{
    font-size:.82rem;
    font-weight:500;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:var(--ink-dim);
    text-align:center;
    margin-top:6px;
    position:relative;
    z-index:2;
    transform:scaleY(1.2);
  }

  .weather-moon-block .moon-illum{
    font-weight:700;
  }

  .weather-moon-block .moon-phase{
    font-weight:400;
  }

  .weather-details-row{
    margin-top:8px;
    padding-top:8px;
  }

  .weather-details-row:last-child{
    padding-bottom:4px;
  }

  .weather-hilo{
    font-size:.88rem;
    font-weight:700;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:var(--ink);
    margin-bottom:10px;
  }

  .feels-inline{
    color:var(--ink);
    opacity:.7;
  }

  .hilo-sep{
    opacity:.3;
    margin:0 2px;
  }

  .weather-stats-grid{
    display:flex;
    flex-wrap:wrap;
    gap:6px 14px;
  }

  .weather-stat{
    display:flex;
    align-items:baseline;
    gap:5px;
  }

  .weather-stat .k{
    font-size:.68rem;
    color:var(--ink-dim);
    font-weight:600;
    letter-spacing:.06em;
    text-transform:uppercase;
  }

  .weather-stat .v{
    font-size:.72rem;
    color:var(--ink);
    font-weight:700;
    letter-spacing:.06em;
    text-transform:uppercase;
  }

  .weather-stat .pollen-val{
    font-size:.74rem;
    font-weight:800;
    padding:2px 8px;
    border-radius:6px;
  }

  .weather-stat .pollen-val.none{
    background:rgba(150,150,150,.20);
    color:rgba(100,100,100,1);
  }

  .weather-stat .pollen-val.low{
    background:rgba(34,197,94,.18);
    color:rgba(22,163,74,1);
  }

  .weather-stat .pollen-val.moderate{
    background:rgba(234,179,8,.18);
    color:rgba(180,130,8,1);
  }

  .weather-stat .pollen-val.high{
    background:rgba(249,115,22,.18);
    color:rgba(220,90,15,1);
  }

  .weather-stat .pollen-val.very-high{
    background:rgba(239,68,68,.18);
    color:rgba(220,50,50,1);
  }

  .weather-stat .ap-val{
    font-size:.78rem;
    font-weight:850;
  }

  .weather-left-stack{
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .loc-cycler{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    z-index:100;
    position:relative;
  }

  .loc-arrow{
    display:none;
  }

  .loc-arrow:hover{
    opacity:.8;
  }

  .loc-arrow:active{
    transform:scale(0.85);
  }

  .loc-cycler-center{
    text-align:left;
    width:280px;
    display:flex;
    flex-direction:column;
    align-items:flex-start;
  }

  .loc-name-row{
    display:flex;
    align-items:center;
    gap:8px;
    position:relative;
  }

  .loc-dots-row{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    margin-top:3px;
    position:relative;
  }

  .loc-name{
    font-weight:820;
    font-size:1.4rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    transition:opacity .18s ease;
  }

  .loc-dots{
    display:none;
  }

  .loc-dot{
    width:4px;
    height:4px;
    border-radius:50%;
    background:rgba(43,34,244,.15);
    transition:all .25s ease;
  }

  .loc-dot.active{
    background:rgba(43,34,244,.5);
    width:14px;
    border-radius:2px;
  }

  .loc-gps-btn{
    width:16px;
    height:16px;
    border-radius:50%;
    border:1px solid rgba(43,34,244,.3);
    background:rgba(43,34,244,.06);
    font-size:.55rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    margin-left:4px;
    opacity:.5;
    transition:all .2s ease;
    flex-shrink:0;
    color:var(--ink);
  }

  .loc-gps-btn:hover{
    opacity:.9;
  }

  .loc-gps-btn.active{
    opacity:1;
    background:rgba(43,34,244,.12);
  }

  .loc-gps-btn.loading{
    animation:gps-pulse 1s ease infinite;
  }

  @keyframes gps-pulse{
    0%,100%{ opacity:.4; }
    50%{ opacity:1; }
  }

  /* Search toggle button - matches GPS button style */
  .loc-search-toggle{
    position:relative;
    width:auto;
    height:auto;
    border-radius:0;
    border:none;
    background:none;
    font-size:2.8rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    opacity:.85;
    transition:all .25s ease;
    flex-shrink:0;
    color:#fff;
    text-shadow:0 0 12px rgba(255,255,255,.3), 0 0 30px rgba(255,255,255,.1);
    line-height:1;
  }
  .loc-search-toggle:hover{
    opacity:1;
    transform:scale(1.08);
    text-shadow:0 0 18px rgba(255,255,255,.45), 0 0 40px rgba(255,255,255,.2);
  }
  .loc-search-toggle.active{
    opacity:1;
  }

  /* Search dropdown - opens to the right over location name */
  .loc-search-box{
    position:absolute;
    top:50%;
    left:42px;
    transform:translateY(-50%) scale(.92);
    transform-origin:left center;
    display:flex;
    align-items:center;
    gap:4px;
    background:rgba(255,255,255,.15);
    backdrop-filter:blur(20px) saturate(120%);
    -webkit-backdrop-filter:blur(20px) saturate(120%);
    border-radius:12px;
    padding:8px 10px 8px 14px;
    box-shadow:0 0 30px rgba(255,255,255,.12), inset 0 0 20px rgba(255,255,255,.22);
    z-index:200;
    opacity:0;
    pointer-events:none;
    transition:all .18s cubic-bezier(.4,0,.2,1);
    white-space:nowrap;
  }
  .loc-search-box.open{
    opacity:1;
    pointer-events:auto;
    transform:translateY(-50%) scale(1);
  }
  .loc-search-box.open ~ .loc-dots,
  .loc-search-box.open ~ .loc-arrow{
    opacity:0;
    pointer-events:none;
  }

  .loc-search-input{
    border:none;
    background:none;
    outline:none;
    font-size:.72rem;
    font-weight:600;
   color:rgba(255,255,255,.9);
    width:130px;
    font-family:inherit;
  }

  .loc-search-input::placeholder{
    color:rgba(255,255,255,.5);
    font-weight:500;
  }

  .loc-search-close{
    border:none;
    background:none;
    cursor:pointer;
    font-size:.65rem;
    color:rgba(255,255,255,.5);
    padding:2px 5px;
    line-height:1;
    border-radius:50%;
    transition:all .15s ease;
  }

  .loc-search-close:hover{
    color:rgba(255,255,255,.9);
    background:rgba(255,255,255,.15);
  }

  /* Earthquake geology popup */
  .quake-geo-popup .leaflet-popup-content-wrapper {
    background: rgba(255,255,255,.95);
    backdrop-filter: blur(8px);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
    padding: 0;
  }
  .quake-geo-popup .leaflet-popup-content {
    margin: 8px 10px;
  }
  .quake-geo-popup .leaflet-popup-tip {
    background: rgba(255,255,255,.95);
  }

  /* Wildfire popup */
  .fire-popup .leaflet-popup-content-wrapper {
    background: rgba(20,20,25,.92);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    border: 1px solid rgba(255,100,50,.3);
    box-shadow: 0 4px 16px rgba(0,0,0,.4);
    padding: 0;
  }
  .fire-popup .leaflet-popup-content {
    margin: 6px 10px;
    font-size: 11px;
    line-height: 1.4;
    color: #eee;
    font-family: system-ui, sans-serif;
  }
  .fire-popup .leaflet-popup-content .fire-name {
    font-weight: 700;
    font-size: 12px;
    color: #ff8c42;
    margin-bottom: 2px;
  }
  .fire-popup .leaflet-popup-content .fire-stat {
    color: rgba(255,255,255,.7);
    font-size: 10px;
  }
  .fire-popup .leaflet-popup-tip {
    background: rgba(20,20,25,.92);
    border-top: 1px solid rgba(255,100,50,.3);
  }

  /* Dropdowns controlled by JS click */

  .fire-item:hover{
    background:rgba(255,255,255,.15);
  }

  .quake-option{
    padding:8px 10px;
    border-radius:8px;
    font-size:.72rem;
    font-weight:600;
    color:var(--ink);
    cursor:pointer;
    transition:background .15s ease;
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .quake-option:hover,
  .quake-item:hover{
    background:rgba(255,255,255,.15);
  }

  .quake-mag{
    font-weight:800;
    font-size:.78rem;
  }

  .quake-place{
    font-size:.68rem;
    color:var(--ink-dim);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .quake-time{
    font-size:.58rem;
    color:rgba(43,34,244,.5);
    text-transform:uppercase;
    letter-spacing:.04em;
  }

  .loc-meta{font-size:.82rem;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.06em}

  .weather-alerts-block{
    position:absolute;
    top:10px;
    left:280px;
    right:360px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    z-index:5;
    pointer-events:none;
    max-height:180px;
    overflow-y:auto;
    overflow-x:hidden;
    scrollbar-width:none;
    -ms-overflow-style:none;
  }
  .weather-alerts-block::-webkit-scrollbar{
    display:none;
  }
  /* Scroll indicator glow for many alerts */
  .weather-alerts-block.many-alerts{
    position:relative;
  }
  .weather-alerts-block.many-alerts::after{
    content:'';
    position:sticky;
    bottom:0;
    left:0;
    right:0;
    height:12px;
    flex-shrink:0;
    background:linear-gradient(to top, rgba(220,38,38,.7) 0%, rgba(220,38,38,.3) 40%, transparent 100%);
    pointer-events:none;
    z-index:10;
    transition:opacity .3s;
  }
  .weather-alerts-block.many-alerts.scrolled-bottom::after{
    opacity:0;
  }
  .weather-alerts-block.many-alerts:hover{
  }
  
  .weather-alert{
    pointer-events:auto;
    position:relative;
    max-width:420px;
    width:100%;
    display:flex;
    align-items:flex-start;
    gap:8px;
    padding:6px 12px;
    padding-right:85px;
    border-radius:10px;
    font-size:.65rem;
    font-weight:600;
    letter-spacing:.04em;
    text-transform:uppercase;
    backdrop-filter:blur(12px);
    -webkit-backdrop-filter:blur(12px);
    flex-shrink:0;
  }

  /* Single alert  larger and more prominent */
  .weather-alerts-block.single-alert{
    max-height:none;
    -webkit-mask-image:none;
    mask-image:none;
  }
  .weather-alerts-block.single-alert .weather-alert{
    max-width:100%;
    padding:12px 16px;
    padding-right:95px;
    font-size:.72rem;
    border-radius:12px;
  }
  .weather-alerts-block.single-alert .weather-alert-title{
    font-size:.8rem;
  }
  .weather-alerts-block.single-alert .weather-alert-time{
    font-size:.66rem;
  }
  .weather-alerts-block.single-alert .weather-alert-summary{
    font-size:.68rem;
  }
  
  .weather-alert.warning{
    background:rgba(220,38,38,1);
    color:#fff;
    border-left:3px solid rgba(180,20,20,1);
  }
  
  .weather-alert.tornado{
    background:rgba(220,20,20,1);
    color:#fff;
    border-left:4px solid #ff0000;
    animation: tornado-alert-pulse 1.5s ease-in-out infinite;
    box-shadow: 0 0 12px rgba(255,0,0,.3);
  }
  @keyframes tornado-alert-pulse {
    0%, 100% { box-shadow: 0 0 8px rgba(255,0,0,.2); }
    50% { box-shadow: 0 0 16px rgba(255,0,0,.5); }
  }
  
  .weather-alert.watch{
    background:rgba(234,88,12,1);
    color:#fff;
    border-left:3px solid rgba(194,65,12,1);
  }
  
  .weather-alert.advisory{
    background:rgba(202,138,4,1);
    color:#fff;
    border-left:3px solid rgba(161,98,7,1);
  }
  
  .weather-alert.statement{
    background:rgba(59,130,246,1);
    color:#fff;
    border-left:3px solid rgba(37,99,235,1);
  }
  
  .weather-alert-icon{
    flex-shrink:0;
    font-size:.9rem;
  }
  
  .weather-alert-text{
    flex:1;
    line-height:1.4;
  }
  
  .weather-alert-title{
    font-weight:800;
  }
  
  .weather-alert-expires{
    font-weight:500;
    opacity:.7;
    margin-left:6px;
  }
  
  .weather-alert-time{
    display:block;
    font-size:.6rem;
    font-weight:500;
    text-transform:none;
    opacity:.9;
    margin-top:3px;
    letter-spacing:0;
  }
  
  .weather-alert-severity{
    position:absolute;
    top:6px;
    right:8px;
    padding:2px 8px;
    border-radius:4px;
    font-size:.55rem;
    font-weight:700;
    text-transform:uppercase;
    background:rgba(255,255,255,.25);
    color:#fff;
  }
  
  .weather-alert-summary{
    display:block;
    font-size:.62rem;
    font-weight:500;
    text-transform:none;
    opacity:.9;
    margin-top:4px;
    line-height:1.3;
    letter-spacing:0;
    color:#fff;
  }
  
  .weather-alert-areas{
    display:block;
    font-size:.55rem;
    font-weight:500;
    text-transform:none;
    opacity:.6;
    margin-top:2px;
    letter-spacing:0;
  }

  .big-temp-row{
    margin-top:10px;
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
    padding-right:92px; /* reserves for moon mini */
  }

  .temp{font-size:4rem;font-weight:740;letter-spacing:-.04em;line-height:1;text-transform:uppercase}

  .cond{display:flex;gap:10px;align-items:center}
  .cond-icon{
    width:30px;height:30px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:rgba(43,34,244,.10);
    border:1px solid rgba(43,34,244,.18);
  }
  .cond-text{font-size:.92rem;color:var(--ink);font-weight:650}

  /* Moon mini */
  #moon-mini{
    position:absolute;
    top:12px;right:12px;
    width:92px;height:92px;
    border-radius:26px;
    background:rgba(255,255,255,.52);
  	border:none;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:4px;
  }
  #moon-mini-icon{font-size:3.1rem;line-height:1}
  #moon-mini-text{font-size:.68rem;font-weight:850;color:var(--ink);text-align:center;padding:0 8px}

  /* Today mini block */
  .today-mini{
    margin-top:12px;
    background:var(--paper-soft);
  	border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
  }
  /* =========================
   Main Weather micro tabs (Summary / Metrics)
   ========================= */
.now-tabs{
  margin-top:12px;
  display:flex;
  gap:8px;
}

.now-tab{
  appearance:none;
  border:none;
  cursor:pointer;

  padding:8px 12px;
  border-radius:999px;

  background: rgba(255,255,255,.06);
  box-shadow: var(--glow-soft);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);

  font-size:.60rem;
  letter-spacing:.16em;
  text-transform:uppercase;
  font-weight:900;
  color:rgba(43,34,244,.72);

  transition: transform .12s ease, box-shadow .18s ease, background .18s ease;
}

.now-tab:hover{
  transform: translateY(-1px);
  box-shadow: 0 0 70px rgba(255,255,255,.18), inset 0 0 34px rgba(255,255,255,.26);
}

.now-tab.is-active{
  background: rgba(255,255,255,.48);
  color: rgba(43,34,244,.92);
  box-shadow: var(--glow-mid);
}

.now-tabpanel{
  margin-top:10px;
}


  .today-mini-top{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
    padding-bottom:6px;
    border-bottom:1px solid rgba(43,34,244,.10);
  }
  .tlabel{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:750;
  }
  .tvalue{font-size:.86rem;font-weight:750;color:var(--ink)}
  .today-mini-sub{margin-top:8px;display:flex;flex-direction:column;gap:6px}
  .row{display:flex;justify-content:space-between;gap:10px}
  .row .k{font-size:.74rem;color:var(--ink-dim);font-weight:700}
  .row .v{font-size:.74rem;color:var(--ink);font-weight:750}

  /* =========================
     Middle stack / metrics
     ========================= */
    /* =========================
     Move metrics into LEFT card (compact grid)
     ========================= */
  .now-stats{
    margin-top:12px;
    display:grid;
    grid-template-columns:repeat(4, minmax(0,1fr));
    gap:10px;
  }
  @media (max-width:1100px){
    .now-stats{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  }

  .now-stat{
    background: rgba(255,255,255,.06);
    border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
    min-width:0;
  }
  .now-stat .k{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:800;
  }
  .now-stat .v{
    margin-top:6px;
    font-size:1.05rem;
    font-weight:820;
    color:var(--ink);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

    .mid-stack{
    display:flex;
    flex-direction:column;
    gap:12px;
    min-width:0;
    height:100%;
  }


  .metric-grid{
    display:grid;
    grid-template-columns:repeat(4, minmax(0,1fr));
    gap:10px;
  }
  @media (max-width:1100px){
    .metric-grid{grid-template-columns:repeat(2, minmax(0,1fr))}
  }

  .mcard{
  	background: rgba(255,255,255,.06);
  	border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
    min-width:0;
  }
  .mk{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:800;
  }
  .mv{
    margin-top:6px;
    font-size:1.05rem;
    font-weight:820;
    color:var(--ink);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
/* =========================
     Air & Pollen Section
     ========================= */
  .air-pollen-section{
    margin-top:12px;
    background:var(--paper-soft);
    border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
  }

  .air-pollen-top{
    padding-bottom:6px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:8px;
  }

  .ap-label{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:850;
  }

  .air-pollen-grid{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:10px;
  }

  .ap-item{
    display:flex;
    align-items:baseline;
    gap:6px;
  }

  .ap-key{
    font-size:.68rem;
    color:var(--ink-dim);
    font-weight:700;
  }

  .ap-val{
    font-size:.82rem;
    font-weight:850;
    color:var(--ink);
  }

  .ap-val.good{ color:rgba(34,197,94,1); }
  .ap-val.moderate{ color:rgba(234,179,8,1); }
  .ap-val.unhealthy-sensitive{ color:rgba(249,115,22,1); }
  .ap-val.unhealthy{ color:rgba(239,68,68,1); }
  .ap-val.very-unhealthy{ color:rgba(168,85,247,1); }
  .ap-val.hazardous{ color:rgba(127,29,29,1); }

  .pollen-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  .pollen-item{
    display:flex;
    align-items:center;
    gap:4px;
    padding:4px 8px;
    border-radius:10px;
    background:rgba(255,255,255,.06);
    box-shadow:0 0 20px rgba(255,255,255,.08), inset 0 0 12px rgba(255,255,255,.12);
  }

  .pollen-icon{
    font-size:.9rem;
  }

  .pollen-type{
    font-size:.64rem;
    font-weight:700;
    color:var(--ink-dim);
  }

  .pollen-val{
    font-size:.72rem;
    font-weight:850;
    padding:2px 6px;
    border-radius:6px;
  }

  .pollen-val.none{
    background:rgba(150,150,150,.20);
    color:rgba(100,100,100,1);
    padding:2px 8px;
    border-radius:6px;
  }

  .pollen-val.low{
    background:rgba(34,197,94,.15);
    color:rgba(22,163,74,1);
  }

  .pollen-val.moderate{
    background:rgba(234,179,8,.15);
    color:rgba(180,130,8,1);
  }

  .pollen-val.high{
    background:rgba(249,115,22,.15);
    color:rgba(220,90,15,1);
  }

  .pollen-val.very-high{
    background:rgba(239,68,68,.15);
    color:rgba(220,50,50,1);
  }
/* =========================
     TODAY Timeline Widget (v4/v5 integrated)
     ========================= */
  .today-timeline-card{
    position:relative;
    width:100%;
    background: rgba(255,255,255,.06);
    border:none;
    border-radius:20px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px) saturate(125%);
    -webkit-backdrop-filter:blur(18px) saturate(125%);
    padding:14px;
    margin-top:10px;
  }

  /* TODAY Timeline Header */
  .today-tl-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:16px;
    padding-bottom:10px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:8px;
  }

  .today-tl-title{
    font-size:.62rem;
    font-weight:900;
    letter-spacing:.16em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
  }

  .today-tl-meta{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:18px;
  }

  .today-tl-meta .meta-item{
    display:flex;
    align-items:center;
    gap:4px;
  }

  .today-tl-meta .meta-key{
    font-size:.50rem;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:rgba(43,34,244,.55);
    font-weight:700;
  }

  .today-tl-meta .meta-val{
    font-size:.70rem;
    font-weight:750;
    color:var(--ink);
  }

  .today-tl-meta .meta-val.orange{ color:#f97316; }
  .today-tl-meta .meta-val.green{ color:#22c55e; }

  .today-tl-stats{
    display:flex;
    gap:20px;
    align-items:center;
  }

  .today-tl-stat{
    text-align:center;
  }

  .today-tl-stat .stat-label{
    font-size:.48rem;
    font-weight:700;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:rgba(43,34,244,.50);
  }

  .today-tl-stat .stat-value{
    font-size:.68rem;
    font-weight:800;
    color:var(--ink);
  }

  /* TODAY Timeline Body */
  .today-tl-body{
    position:relative;
    padding-bottom:12px;
  }

  /* Top Bars: Kp and Cloud */
  .today-tl-top-bars{
    display:flex;
    flex-direction:column;
    gap:1px;
    margin-bottom:0;
    margin-left:0;
  }

  .today-tl-bar-row{
    display:flex;
    align-items:center;
    gap:0;
    height:18px;
    margin-left:0;
    position:relative;
  }

  .today-tl-bar-label{
    position:absolute;
    left:6px;
    font-size:.52rem;
    font-weight:700;
    letter-spacing:.02em;
    text-transform:uppercase;
    color:rgba(255,255,255,.95);
    text-shadow:0 1px 3px rgba(0,0,0,.55);
    z-index:2;
  }

  .today-tl-bar-track{
    width:100%;
    height:18px;
    background:rgba(43,34,244,.06);
    border-radius:14px 14px 0 0;
    display:flex;
    overflow:hidden;
  }

  .today-tl-bar-track.cloud{
    border-radius:0;
  }

  .today-tl-bar-segment{
    height:100%;
  }

  /* Sky Bar Container */
  .today-tl-sky-bar{
    position:relative;
    border-radius:0 0 14px 14px;
    overflow:hidden;
    min-height:180px;
    margin-left:0;
    margin-right:0;
  }

  /* Sky gradient bands */
  .today-tl-sky-bands{
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
    display:flex;
    z-index:0;
  }

  .today-tl-sky-band{
    height:100%;
  }

  .today-tl-sky-band.night{
    background:linear-gradient(180deg, 
      rgba(15,20,45,.88) 0%, 
      rgba(22,30,65,.80) 40%,
      rgba(30,45,85,.70) 100%);
  }

  .today-tl-sky-band.astro-twilight{
    background:linear-gradient(180deg, 
      rgba(25,35,75,.75) 0%, 
      rgba(40,55,110,.65) 50%,
      rgba(55,75,140,.55) 100%);
  }

  .today-tl-sky-band.blue-hour{
    background:linear-gradient(180deg, 
      rgba(55,80,150,.55) 0%, 
      rgba(75,110,175,.45) 50%,
      rgba(100,140,195,.35) 100%);
  }

  .today-tl-sky-band.golden{
    background:linear-gradient(180deg, 
      rgba(255,160,80,.65) 0%, 
      rgba(255,190,110,.45) 50%,
      rgba(255,220,150,.30) 100%);
  }

  .today-tl-sky-band.golden-am{
    background:linear-gradient(90deg, 
      rgba(200,140,100,.50) 0%,
      rgba(240,160,80,.58) 20%,
      rgba(255,170,70,.65) 40%,
      rgba(255,195,110,.48) 60%,
      rgba(255,215,150,.30) 80%,
      rgba(255,230,185,.15) 100%);
  }

  .today-tl-sky-band.golden-pm{
    background:linear-gradient(90deg, 
      rgba(255,230,185,.15) 0%,
      rgba(255,215,150,.30) 20%,
      rgba(255,195,110,.48) 40%,
      rgba(255,170,70,.65) 60%,
      rgba(240,160,80,.58) 80%,
      rgba(200,140,100,.50) 100%);
  }

  .today-tl-sky-band.golden-peak{
    background:linear-gradient(180deg, 
      rgba(255,100,30,.90) 0%, 
      rgba(255,130,50,.75) 50%,
      rgba(255,160,80,.60) 100%);
  }

  .today-tl-sky-band.day{
    background:linear-gradient(180deg, 
      rgba(135,195,250,.40) 0%, 
      rgba(175,215,255,.25) 50%,
      rgba(210,235,255,.15) 100%);
  }

  /* Planet Tracks */
  .today-tl-planet-tracks{
    position:relative;
    z-index:2;
    padding:10px 0 8px 0;
    margin-left:0;
  }

  .today-tl-planet-row{
    display:flex;
    align-items:center;
    height:10px;
    margin-bottom:3px;
    padding-left:6px;
  }

  .today-tl-planet-row:last-child{
    margin-bottom:0;
  }

  .today-tl-planet-indicator{
    width:8px;
    height:8px;
    border-radius:50%;
    flex-shrink:0;
    margin-right:6px;
    margin-left:2px;
  }

  .today-tl-planet-dir{
    width:18px;
    font-size:.48rem;
    font-weight:700;
    letter-spacing:.02em;
    color:rgba(255,255,255,.55);
    text-align:center;
    flex-shrink:0;
    text-shadow:0 1px 2px rgba(0,0,0,.40);
  }

  .today-tl-planet-bar{
    flex:1;
    height:5px;
    position:relative;
  }

  .today-tl-planet-vis{
    position:absolute;
    height:100%;
    border-radius:2px;
    box-shadow:0 0 6px currentColor;
  }

  .today-tl-planet-vis.solid{
    opacity:0.90;
  }

  .today-tl-planet-vis.dashed{
    opacity:0.40;
  }

  /* Weather Row */
  .today-tl-weather-row{
    position:relative;
    z-index:2;
    display:flex;
    padding:12px 0 16px 0;
    margin-left:0;
    border-top:1px solid rgba(255,255,255,.10);
  }

  .today-tl-weather-hour{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    min-width:0;
  }

  .today-tl-weather-time{
    font-size:.64rem;
    font-weight:700;
    color:rgba(255,255,255,.55);
    text-shadow:0 1px 2px rgba(0,0,0,.50);
    margin-bottom:2px;
  }

  .today-tl-weather-icon{
    font-size:26px;
    line-height:1;
    filter:drop-shadow(0 1px 2px rgba(0,0,0,.30));
    display:flex;
    align-items:center;
    justify-content:center;
    height:36px;
    flex-shrink:0;
    overflow:hidden;
    margin:3px 0;
  }

  .today-tl-weather-temp{
    font-size:.82rem;
    font-weight:800;
    color:#fff;
    text-shadow:0 1px 3px rgba(0,0,0,.50);
    margin-top:2px;
  }

  .today-tl-weather-precip{
    font-size:.62rem;
    font-weight:700;
    color:rgba(255,255,255,.5);
    text-shadow:0 1px 2px rgba(0,0,0,.30);
    margin-top:1px;
  }

  .today-tl-weather-precip.active{
    color:rgba(100,180,255,.95);
  }

  /* Day hours - white text on blue sky */
  .today-tl-weather-hour.day-hour .today-tl-weather-time{
    color:rgba(255,255,255,.7);
    text-shadow:0 1px 3px rgba(0,40,120,.3);
  }

  .today-tl-weather-hour.day-hour .today-tl-weather-temp{
    color:#fff;
    text-shadow:0 1px 4px rgba(0,40,120,.35);
  }

  .today-tl-weather-hour.day-hour .today-tl-weather-precip{
    color:rgba(255,255,255,.55);
    text-shadow:none;
  }

  /* Golden hour text - warm amber */
  .today-tl-weather-hour.golden-hour .today-tl-weather-time{
    color:rgba(255,180,80,.75);
    text-shadow:0 1px 2px rgba(0,0,0,.4);
  }
  .today-tl-weather-hour.golden-hour .today-tl-weather-temp{
    color:rgba(255,200,100,1);
    text-shadow:0 0 8px rgba(255,150,40,.2);
  }
  .today-tl-weather-hour.golden-hour .today-tl-weather-precip{
    color:rgba(255,180,80,.55);
    text-shadow:none;
  }

  /* Golden peak text - intense warm */
  .today-tl-weather-hour.golden-peak-hour .today-tl-weather-time{
    color:rgba(255,160,50,.85);
    text-shadow:0 1px 2px rgba(0,0,0,.4);
  }
  .today-tl-weather-hour.golden-peak-hour .today-tl-weather-temp{
    color:rgba(255,180,60,1);
    text-shadow:0 0 12px rgba(255,120,20,.3);
  }
  .today-tl-weather-hour.golden-peak-hour .today-tl-weather-precip{
    color:rgba(255,160,50,.6);
    text-shadow:none;
  }

  /* Golden peak icon glow */
  .today-tl-weather-hour.golden-peak-hour .today-tl-weather-icon{
    filter:drop-shadow(0 0 8px rgba(255,140,40,.35));
  }

  /* Golden hour cloud warm tint */
  .today-tl-weather-hour.golden-hour .today-tl-weather-icon{
    filter:sepia(.12) saturate(1.2) brightness(1.05) drop-shadow(0 2px 6px rgba(255,120,30,.2));
  }

  /* Blue hour text */
  .today-tl-weather-hour.blue-hour-col .today-tl-weather-time{
    color:rgba(150,180,240,.6);
    text-shadow:0 1px 2px rgba(0,0,0,.4);
  }
  .today-tl-weather-hour.blue-hour-col .today-tl-weather-temp{
    color:rgba(200,220,255,.95);
    text-shadow:0 1px 3px rgba(0,0,0,.4);
  }
  .today-tl-weather-hour.blue-hour-col .today-tl-weather-precip{
    color:rgba(150,180,255,.55);
    text-shadow:none;
  }

  /* Twilight text */
  .today-tl-weather-hour.twilight-hour .today-tl-weather-time{
    color:rgba(200,210,255,.5);
    text-shadow:0 1px 2px rgba(0,0,0,.5);
  }
  .today-tl-weather-hour.twilight-hour .today-tl-weather-temp{
    color:rgba(220,230,255,.9);
    text-shadow:0 1px 3px rgba(0,0,0,.5);
  }
  .today-tl-weather-hour.twilight-hour .today-tl-weather-precip{
    color:rgba(180,200,255,.45);
    text-shadow:none;
  }

  /* =============================================
     WEATHER ICON ANIMATIONS (Complete v5 set)
     ============================================= */

  /* SUN - gentle pulse/glow (code 0 day) */
  @keyframes today-sun-pulse {
    0%, 100% { 
      transform: scale(1); 
      filter: drop-shadow(0 0 3px rgba(255,200,0,0.6));
    }
    50% { 
      transform: scale(1.06); 
      filter: drop-shadow(0 0 8px rgba(255,200,0,0.90));
    }
  }

  .today-tl-weather-icon.sun {
    animation: today-sun-pulse 3s ease-in-out infinite;
  }

  /* MOON / CLEAR NIGHT - twinkle (code 0 night) */
  @keyframes today-night-twinkle {
    0%, 100% { 
      filter: drop-shadow(0 0 2px rgba(200,220,255,0.5)); 
    }
    50% { 
      filter: drop-shadow(0 0 6px rgba(200,220,255,0.90)); 
    }
  }

  .today-tl-weather-icon.night {
    animation: today-night-twinkle 2.5s ease-in-out infinite;
  }

  /* PARTLY CLOUDY - subtle wobble (codes 1, 2) */
  @keyframes today-partly-wobble {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    25% { transform: translateX(1px) rotate(1deg); }
    75% { transform: translateX(-1px) rotate(-1deg); }
  }

  .today-tl-weather-icon.partly {
    animation: today-partly-wobble 5s ease-in-out infinite;
  }

  /* OVERCAST / CLOUDY - gentle drift (code 3) */
  @keyframes today-cloud-drift {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(2px); }
  }

  .today-tl-weather-icon.cloud {
    animation: today-cloud-drift 4s ease-in-out infinite;
  }

  /* FOG / MIST - slow fade pulse (codes 45, 48) */
  @keyframes today-fog-fade {
    0%, 100% { opacity: 1; transform: scaleX(1); }
    50% { opacity: 0.65; transform: scaleX(1.02); }
  }

  .today-tl-weather-icon.fog {
    animation: today-fog-fade 4s ease-in-out infinite;
  }

  /* DRIZZLE - light bounce (codes 51, 53, 55) */
  @keyframes today-drizzle-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(1px); }
  }

  .today-tl-weather-icon.drizzle {
    animation: today-drizzle-bounce 2s ease-in-out infinite;
  }

  /* FREEZING DRIZZLE - bounce + shimmer (codes 56, 57) */
  @keyframes today-freezing-drizzle {
    0%, 100% { 
      transform: translateY(0); 
      filter: drop-shadow(0 0 2px rgba(150,200,255,0.4));
    }
    50% { 
      transform: translateY(1px); 
      filter: drop-shadow(0 0 5px rgba(150,200,255,0.75));
    }
  }

  .today-tl-weather-icon.freezing-drizzle {
    animation: today-freezing-drizzle 2s ease-in-out infinite;
  }

  /* RAIN - bounce like drops (codes 61, 63, 65, 80, 81, 82) */
  @keyframes today-rain-bounce {
    0%, 100% { transform: translateY(0); }
    25% { transform: translateY(-1px); }
    50% { transform: translateY(1px); }
    75% { transform: translateY(-0.5px); }
  }

  .today-tl-weather-icon.rain {
    animation: today-rain-bounce 1.5s ease-in-out infinite;
  }

  /* FREEZING RAIN - bounce + icy shimmer (codes 66, 67) */
  @keyframes today-freezing-rain {
    0%, 100% { 
      transform: translateY(0); 
      filter: drop-shadow(0 0 2px rgba(100,180,255,0.5));
    }
    25% { transform: translateY(-1px); }
    50% { 
      transform: translateY(1px); 
      filter: drop-shadow(0 0 6px rgba(100,180,255,0.85));
    }
    75% { transform: translateY(-0.5px); }
  }

  .today-tl-weather-icon.freezing-rain {
    animation: today-freezing-rain 1.8s ease-in-out infinite;
  }

  /* SNOW - gentle float (codes 71, 73, 75, 85, 86) */
  @keyframes today-snow-float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-1px) rotate(2deg); }
    50% { transform: translateY(1px) rotate(0deg); }
    75% { transform: translateY(-0.5px) rotate(-2deg); }
  }

  .today-tl-weather-icon.snow {
    animation: today-snow-float 3s ease-in-out infinite;
  }

  /* SLEET / ICE PELLETS - sharp bounce (code 77) */
  @keyframes today-sleet-bounce {
    0%, 100% { transform: translateY(0) scale(1); }
    15% { transform: translateY(-2px) scale(1); }
    30% { transform: translateY(2px) scale(0.96); }
    45% { transform: translateY(-1px) scale(1); }
    60% { transform: translateY(1px) scale(0.98); }
  }

  .today-tl-weather-icon.sleet {
    animation: today-sleet-bounce 1.2s ease-in-out infinite;
  }

  /* HAIL - aggressive bounce with shake (codes 96, 99 without thunder) */
  @keyframes today-hail-bounce {
    0%, 100% { transform: translateY(0) translateX(0); }
    10% { transform: translateY(-2px) translateX(1px); }
    20% { transform: translateY(2px) translateX(-1px); }
    30% { transform: translateY(-1px) translateX(0); }
    40% { transform: translateY(1px) translateX(1px); }
    50% { transform: translateY(-1px) translateX(-1px); }
  }

  .today-tl-weather-icon.hail {
    animation: today-hail-bounce 0.8s ease-in-out infinite;
  }

  /* THUNDERSTORM - flash effect (code 95) */
  @keyframes today-storm-flash {
    0%, 88%, 100% { 
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); 
    }
    90%, 94% { 
      filter: drop-shadow(0 0 12px rgba(255,255,150,1)) brightness(1.35); 
    }
  }

  .today-tl-weather-icon.storm {
    animation: today-storm-flash 3.5s ease-in-out infinite;
  }

  /* THUNDERSTORM WITH HAIL - flash + shake (codes 96, 99 with thunder) */
  @keyframes today-storm-hail {
    0%, 85%, 100% { 
      transform: translateY(0) translateX(0);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); 
    }
    88%, 92% { 
      transform: translateY(0) translateX(0);
      filter: drop-shadow(0 0 12px rgba(255,255,150,1)) brightness(1.35); 
    }
    10% { transform: translateY(-2px) translateX(1px); }
    20% { transform: translateY(2px) translateX(-1px); }
    30% { transform: translateY(-1px) translateX(0); }
  }

  .today-tl-weather-icon.storm-hail {
    animation: today-storm-hail 2s ease-in-out infinite;
  }

  /* WIND - sway motion */
  @keyframes today-wind-sway {
    0%, 100% { transform: rotate(-4deg) translateX(0); }
    50% { transform: rotate(4deg) translateX(2px); }
  }

  .today-tl-weather-icon.wind {
    animation: today-wind-sway 2s ease-in-out infinite;
  }

  /* MIXED RAIN/SNOW - alternating bounce (winter mix) */
  @keyframes today-mix-bounce {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    20% { transform: translateY(-1px) rotate(2deg); }
    40% { transform: translateY(1px) rotate(-1deg); }
    60% { transform: translateY(-0.5px) rotate(1deg); }
    80% { transform: translateY(1px) rotate(-2deg); }
  }

  .today-tl-weather-icon.mix {
    animation: today-mix-bounce 2s ease-in-out infinite;
  }

  /* Stagger animations */
  .today-tl-weather-hour:nth-child(2n) .today-tl-weather-icon { animation-delay: 0.3s; }
  .today-tl-weather-hour:nth-child(3n) .today-tl-weather-icon { animation-delay: 0.6s; }
  .today-tl-weather-hour:nth-child(4n) .today-tl-weather-icon { animation-delay: 0.9s; }
  .today-tl-weather-hour:nth-child(5n) .today-tl-weather-icon { animation-delay: 1.2s; }
  .today-tl-weather-hour:nth-child(6n) .today-tl-weather-icon { animation-delay: 0.15s; }
  .today-tl-weather-hour:nth-child(7n) .today-tl-weather-icon { animation-delay: 0.45s; }

  /* NOW Marker */
  .today-tl-now-marker{
    position:absolute;
    top:0;
    bottom:-40px;
    width:3px;
    background:rgba(255,140,0,.9);
    border-radius:2px;
    z-index:100;
    box-shadow:0 0 10px rgba(255,140,0,.6), 0 0 20px rgba(255,100,0,.3);
  }

  .today-tl-now-label{
    display:none;
  }

  .today-tl-now-bubble{
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,140,0,.95);
    color:#fff;
    padding:5px 8px;
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:1px;
    box-shadow:0 3px 10px rgba(255,100,0,.4);
  }

  .today-tl-now-temp{
    font-size:.80rem;
    font-weight:900;
  }

  .today-tl-now-time{
    font-size:.46rem;
    font-weight:700;
    opacity:0.70;
    letter-spacing:.06em;
  }

  /* TODAY Timeline Legend */
  .today-tl-legend{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
    gap:10px;
    padding-top:6px;
    margin-top:2px;
    border-top:1px solid rgba(43,34,244,.08);
  }

  .today-tl-legend-item{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:2px;
    padding:6px 10px;
    background:rgba(255,255,255,.06);
    border-radius:12px;
    font-size:.62rem;
    font-weight:700;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:rgba(43,34,244,.65);
    box-shadow:0 0 16px rgba(255,255,255,.08), inset 0 0 10px rgba(255,255,255,.12);
  }

  .today-tl-legend-top{
    display:flex;
    align-items:center;
    gap:6px;
  }

  .today-tl-legend-dir{
    font-size:.42rem;
    font-weight:700;
    color:rgba(43,34,244,.40);
    letter-spacing:.08em;
  }

  .today-tl-legend-dot{
    width:10px;
    height:10px;
    border-radius:50%;
  }

  .today-tl-legend-moon{
    width:14px;
    height:14px;
    border-radius:50%;
    background:linear-gradient(135deg, #f5f5f5 0%, #ccc 100%);
    box-shadow:inset -1px -1px 3px rgba(0,0,0,.12);
  }

  .today-tl-kp-scale{
    display:flex;
    align-items:center;
    gap:2px;
  }

  .today-tl-kp-scale span{
    font-size:.56rem;
    font-weight:700;
    color:rgba(43,34,244,.50);
    margin:0 3px;
  }

  .today-tl-kp-box{
    width:10px;
    height:10px;
    border-radius:2px;
  }

  /* Mobile responsive for TODAY Timeline */
  @media (max-width: 768px) {
    .today-timeline-card {
      padding: 10px;
      border-radius: 16px;
    }
    
    .today-tl-header {
      flex-direction: column;
      gap: 8px;
      padding-bottom: 8px;
      margin-bottom: 8px;
    }
    
    .today-tl-meta {
      gap: 8px 12px;
    }
    
    .today-tl-meta .meta-key {
      font-size: .44rem;
    }
    
    .today-tl-meta .meta-val {
      font-size: .62rem;
    }
    
    .today-tl-stats {
      gap: 12px;
    }
    
    .today-tl-stat .stat-label {
      font-size: .42rem;
    }
    
    .today-tl-stat .stat-value {
      font-size: .58rem;
    }
    
    .today-tl-sky-bar {
      min-height: 110px;
    }
    
    .today-tl-weather-time {
      font-size: .48rem;
    }
    
    .today-tl-weather-icon {
      font-size: 14px;
    }
    
    .today-tl-weather-temp {
      font-size: .58rem;
    }
    
    .today-tl-weather-precip {
      font-size: .38rem;
    }
    
    .today-tl-planet-tracks {
      margin-left: 20px;
    }
    
    .today-tl-weather-row {
      margin-left: 20px;
    }
    
    .today-tl-legend {
      gap: 5px;
    }
    
    .today-tl-legend-item {
      padding: 2px 5px;
      font-size: .46rem;
    }
  }

  @media (max-width: 480px) {
    .today-tl-sky-bar {
      min-height: 95px;
    }
  }

  /* =========================
     Sun Timeline (Combined hourly + sun events)
     ========================= */
  .sun-timeline{
    position:relative;
    margin-top:10px;
    background:var(--paper);
    border:none;
    border-radius:18px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px) saturate(125%);
    -webkit-backdrop-filter:blur(18px) saturate(125%);
    padding:14px;
    min-height:180px;
  }

  .sun-timeline-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:8px;
    padding-bottom:8px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:10px;
  }

  .sun-timeline-title{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .sun-timeline-title .sun-label-text{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.74);
    font-weight:900;
  }

  .sun-timeline-meta{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }

  .meta-item{
    display:flex;
    align-items:baseline;
    gap:6px;
  }

  .meta-key{
    font-size:.52rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:rgba(43,34,244,.60);
    font-weight:700;
  }

  .meta-val{
    font-size:.72rem;
    font-weight:750;
    color:var(--ink);
  }

  /* Main timeline bar container */
  .sun-timeline-bar{
    position:relative;
    height:90px;
    background:rgba(43,34,244,.04);
    border-radius:14px;
  }

  /* Colored bands (golden/blue hour) */
  .tl-bands{
    position:absolute;
    inset:0;
    border-radius:14px;
    overflow:hidden;
    pointer-events:none;
  }

  .tl-band{
    position:absolute;
    top:0;
    bottom:0;
    pointer-events:none;
  }

  .tl-band.night{
    background:linear-gradient(180deg, 
      rgba(10,10,35,.85) 0%, 
      rgba(15,20,50,.75) 50%,
      rgba(20,25,60,.65) 100%);
  }

  .tl-band.astro{
    background:linear-gradient(180deg, 
      rgba(25,30,80,.70) 0%, 
      rgba(40,50,120,.55) 50%,
      rgba(60,70,140,.40) 100%);
  }

  .tl-band.blue{
    background:linear-gradient(180deg, 
      rgba(80,100,180,.65) 0%, 
      rgba(100,130,200,.50) 50%,
      rgba(140,170,220,.35) 100%);
  }

  .tl-band.golden{
    background:linear-gradient(180deg, 
      rgba(255,140,50,.75) 0%, 
      rgba(255,170,80,.60) 50%,
      rgba(255,200,120,.45) 100%);
  }

  .tl-band.golden-peak{
    background:linear-gradient(180deg, 
      rgba(255,100,30,.85) 0%, 
      rgba(255,130,50,.75) 50%,
      rgba(255,160,80,.60) 100%);
  }

  .tl-band.day{
    background:linear-gradient(180deg, 
      rgba(135,206,250,.30) 0%, 
      rgba(176,224,255,.20) 50%,
      rgba(200,235,255,.15) 100%);
  }

  /* Hour markers */
  .tl-hours{
    position:absolute;
    inset:0;
    display:flex;
    pointer-events:none;
    overflow:hidden;
  }

  .tl-hour{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-end;
    padding-bottom:6px;
    border-left:1px solid rgba(43,34,244,.08);
    min-width:0;
  }

  .tl-hour:first-child{
    border-left:none;
  }

  .tl-hour-time{
    font-size:.58rem;
    font-weight:800;
    color:rgba(43,34,244,.50);
    letter-spacing:.02em;
    margin-bottom:2px;
    transition:color .2s ease;
  }

  .tl-hour-icon{
    max-width:36px;
    max-height:36px;
    object-fit:contain;
    margin:0;
  }

  .tl-hour-temp{
    font-size:.82rem;
    font-weight:850;
    color:var(--ink);
    transition:color .2s ease, text-shadow .2s ease;
  }

  .tl-hour-precip{
    font-size:.62rem;
    font-weight:700;
    margin-top:1px;
    transition:color .2s ease;
  }

  .tl-hour-precip.low{
    color:rgba(255,255,255,.5);
  }

  .tl-hour-precip.med{
    color:rgba(70,130,220,1);
    font-weight:800;
  }

  .tl-hour-precip.high{
    color:rgba(30,100,220,1);
    font-weight:900;
    text-shadow:0 0 6px rgba(50,120,240,.40);
  }

  /* Light text for dark backgrounds (night hours) */
  .tl-hour.night-hour .tl-hour-time{
    color:rgba(180,190,220,.70);
  }

  .tl-hour.night-hour .tl-hour-temp{
    color:rgba(230,235,255,.95);
    text-shadow:0 0 8px rgba(0,0,0,.50);
  }

  .tl-hour.night-hour .tl-hour-precip.low{
    color:rgba(150,170,210,.60);
  }

  .tl-hour.night-hour .tl-hour-precip.med{
    color:rgba(130,180,255,.90);
  }

  .tl-hour.night-hour .tl-hour-precip.high{
    color:rgba(100,170,255,1);
    text-shadow:0 0 6px rgba(80,150,255,.50);
  }

  /* Sun event ticks */
  .tl-events{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  .tl-event-tick{
    position:absolute;
    top:0;
    bottom:0;
    width:2px;
    transform:translateX(-50%);
    border-radius:2px;
  }

  .tl-event-tick.sunrise,
  .tl-event-tick.sunset{
    background:linear-gradient(180deg, rgba(255,120,30,1), rgba(255,180,60,1));
    box-shadow:0 0 16px rgba(255,140,40,.70), 0 0 30px rgba(255,100,20,.40);
  }

  .tl-event-tick.noon{
    background:linear-gradient(180deg, rgba(255,220,80,1), rgba(255,240,150,1));
    box-shadow:0 0 14px rgba(255,220,100,.60), 0 0 25px rgba(255,200,50,.35);
  }

  .tl-event-tick.golden{
    background:linear-gradient(180deg, rgba(255,140,30,1), rgba(255,180,70,1));
    box-shadow:0 0 12px rgba(255,150,50,.55), 0 0 20px rgba(255,120,30,.30);
  }

  .tl-event-tick.blue{
    background:linear-gradient(180deg, rgba(80,100,200,1), rgba(130,150,230,1));
    box-shadow:0 0 12px rgba(100,120,220,.55), 0 0 20px rgba(80,100,200,.30);
  }

  .tl-event-tick.astro{
    background:linear-gradient(180deg, rgba(40,50,100,1), rgba(70,80,140,1));
    box-shadow:0 0 10px rgba(50,60,120,.50), 0 0 18px rgba(30,40,90,.30);
  }

  /* NOW marker */
  .tl-now{
    position:absolute;
    top:-6px;
    bottom:-6px;
    width:3px;
    transform:translateX(-50%);
    z-index:10;
    pointer-events:none;
  }

  .tl-now-line{
    position:absolute;
    inset:0;
    background:var(--ink);
    border-radius:3px;
    box-shadow:0 0 14px rgba(43,34,244,.40);
  }

  .tl-now-bubble{
    position:absolute;
    bottom:-32px;
    left:50%;
    transform:translateX(-50%);
    background:var(--ink);
    color:#fff;
    padding:5px 9px;
    border-radius:10px;
    display:flex;
    flex-direction:column-reverse;
    align-items:center;
    gap:1px;
    box-shadow:0 -4px 16px rgba(43,34,244,.35);
  }

  .tl-now-temp{
    font-size:.78rem;
    font-weight:900;
  }

  .tl-now-label{
    font-size:.44rem;
    font-weight:800;
    letter-spacing:.12em;
    opacity:.75;
  }

  /* Event labels below bar */
  .tl-event-labels{
    display:none;
  }

  .tl-event-label{
    position:absolute;
    transform:translateX(-50%);
    font-size:.54rem;
    font-weight:500;
    letter-spacing:.08em;
    text-transform:uppercase;
    white-space:nowrap;
    color:var(--ink-dim);
  }

  .tl-event-label.level-1{ top:16px; }
  .tl-event-label.level-2{ top:12px; }
  .tl-event-label.level-3{ top:8px; }
  .tl-event-label.level-4{ top:4px; }
  .tl-event-label.level-5{ top:0px; }

  .tl-event-label.sunrise,
  .tl-event-label.sunset{
    color:rgba(230,100,20,1);
    text-shadow:0 0 8px rgba(255,140,50,.35);
  }

  .tl-event-label.golden{
    color:rgba(220,120,20,1);
    text-shadow:0 0 6px rgba(255,150,50,.30);
  }

  .tl-event-label.blue{
    color:rgba(70,90,180,1);
    text-shadow:0 0 6px rgba(100,130,220,.25);
  }

  .tl-event-label.astro{
    color:rgba(50,60,120,1);
    text-shadow:0 0 5px rgba(60,70,140,.20);
  }

  .tl-event-label.noon{
    color:rgba(210,160,30,1);
    text-shadow:0 0 8px rgba(255,200,50,.30);
  }

  /* Responsive */
  @media (max-width:900px){
    .sun-timeline-bar{
      height:80px;
    }
    .tl-hour-time{
      font-size:.44rem;
    }
    .tl-hour-icon{
      width:20px;
      height:20px;
    }
    .tl-hour-temp{
      font-size:.60rem;
    }
    .tl-hour-precip{
      font-size:.48rem;
    }
  }

  @media (max-width:600px){
    .sun-timeline-header{
      flex-direction:column;
      align-items:flex-start;
    }
    .tl-hour:nth-child(odd) .tl-hour-time{
      visibility:hidden;
    }
  }

  /* =========================
     7-day (horizontal chips inside main card)
     ========================= */
  .forecast7-section{
    margin-top:12px;
    background:var(--paper-soft);
    border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
  }

  .forecast7-top{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:10px;
    padding-bottom:6px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:10px;
  }

  .forecast7-label{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:850;
  }

  .forecast7-chips{
    display:flex;
    gap:8px;
    padding-bottom:4px;
    overflow-x:auto;
    overflow-y:hidden;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  .forecast7-chips::-webkit-scrollbar{
    display:none;
  }

  .forecast7-chip{
    flex:1 0 0%;
    min-width:80px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:2px;
    padding:4px 12px 8px 12px;
    border-radius:14px;
    background:rgba(255,255,255,.06);
    box-shadow:0 0 30px rgba(255,255,255,.10), inset 0 0 20px rgba(255,255,255,.18);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
  }

  .forecast7-chip .day{
    font-size:.74rem;
    font-weight:850;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:var(--ink-dim);
  }

  .forecast7-chip .forecast7-date{
    font-size:.64rem;
    font-weight:600;
    color:rgba(100,100,140,.8);
    margin-top:-2px;
  }

  .forecast7-chip .icon{
    width:52px;
    height:52px;
    object-fit:contain;
  }

  .forecast7-chip .temps{
    font-size:.85rem;
    font-weight:800;
    color:var(--ink);
    text-transform:uppercase;
  }

  .forecast7-bar-wrap{
    width:100%;
    height:7px;
    background:rgba(43,34,244,.08);
    border-radius:3px;
    position:relative;
    margin:2px 0;
  }

  .forecast7-bar{
    position:absolute;
    top:0;
    height:100%;
    border-radius:3px;
    transition:width .3s ease, left .3s ease;
    box-shadow:0 0 6px rgba(255,255,255,.15);
  }

  .forecast7-chip .forecast7-bar-block{
    width:100%;
    display:flex;
    flex-direction:column;
    overflow:visible;
  }
  .forecast7-chip .bar-hi{
    display:flex;
    align-items:baseline;
    justify-content:flex-end;
    gap:3px;
    white-space:nowrap;
    overflow:visible;
  }
  .forecast7-chip .bar-lo{
    display:flex;
    align-items:baseline;
    justify-content:flex-start;
    gap:3px;
    white-space:nowrap;
    overflow:visible;
  }
  .forecast7-chip .bar-lo .forecast7-lo{
    font-size:.85rem;
    font-weight:700;
    color:var(--ink);
  }
  .forecast7-chip .feels-hi,
  .forecast7-chip .feels-lo{
    font-size:.5rem;
    font-weight:400;
    color:var(--ink-dim);
    letter-spacing:.02em;
    white-space:nowrap;
  }
  .forecast7-chip .forecast7-lo{
    font-size:.68rem;
    font-weight:600;
    color:var(--ink-dim);
  }

  .forecast7-chip .precip{
    font-size:.65rem;
    font-weight:700;
    color:rgba(70,130,220,.90);
    text-transform:uppercase;
    text-align:center;
  }

  .forecast7-chip .forecast7-wind{
    font-size:.60rem;
    font-weight:600;
    color:var(--ink-dim);
    margin-top:2px;
    text-align:center;
  }

  .forecast7-chip .forecast7-accum{
    font-size:.60rem;
    font-weight:700;
    color:var(--ink);
    margin-top:2px;
    text-align:center;
  }
  .forecast7-chip .forecast7-precip{
    font-size:.60rem;
    font-weight:700;
    color:rgba(70,150,255,.95);
    margin-top:4px;
    text-align:center;
    letter-spacing:.02em;
  }
  .forecast7-chip .forecast7-uv{
    font-size:.55rem;
    font-weight:600;
    margin-top:2px;
    text-align:center;
  }
  .forecast7-chip .forecast7-uv.uv-low{ color:rgba(120,180,120,.95); }
  .forecast7-chip .forecast7-uv.uv-mod{ color:rgba(200,170,60,.95); }
  .forecast7-chip .forecast7-uv.uv-high{ color:rgba(240,130,40,.95); }
  .forecast7-chip .forecast7-uv.uv-vhigh{ color:rgba(230,60,60,.95); }
  .forecast7-chip .forecast7-uv.uv-extreme{ color:rgba(180,50,200,.95); }

  @media (max-width:600px){
    .forecast7-chips{
      gap:6px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x mandatory;
      padding-bottom:6px;
    }
    .forecast7-chip{
      min-width:72px;
      flex:0 0 auto;
      padding:8px 6px;
      scroll-snap-align:start;
    }
    .forecast7-chip .icon{
    width:90px;
    height:90px;
    margin:-10px 0 -10px 0;
    margin:0;
    padding:0;
    }
    .forecast7-chip .temps{
      font-size:.78rem;
    }
    .forecast7-chip .feels-hi{
    font-size:.55rem;
    font-weight:600;
    color:var(--ink-dim);
  }
  .forecast7-chip .forecast7-lo{
      font-size:.62rem;
    }
    .forecast7-chip .forecast7-wind{
      font-size:.55rem;
    }
    .forecast7-chip .forecast7-accum{
      font-size:.55rem;
    }
  }

  /* =========================
     Astro / Space events / Night sky
     ========================= */
  .astro-row{margin-top:12px}
  .astro-pill{
    background:var(--paper);
  	border:none;
    border-radius:18px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px);
    -webkit-backdrop-filter:blur(18px);
    padding:10px;
  }

  .moon-sky{display:block}
  .moon-sky-main{display:flex;flex-direction:column;gap:10px}

  .skygrid{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }

  .skcard{
  	background: rgba(255,255,255,.06);
  	border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    padding:10px;
  }
  .skk{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:850;
  }
  .skv{
    margin-top:8px;
    font-size:1.0rem;
    font-weight:900;
    color:var(--ink);
  }

  .bullets{margin-top:6px;display:flex;flex-direction:column;gap:5px}
  .bullet{
  background: rgba(255,255,255,.06);
  border: none;
  border-radius:12px;
  padding:6px 10px;

  box-shadow:
    0 0 56px rgba(255,255,255,.14),
    inset 0 0 34px rgba(255,255,255,.28);

  backdrop-filter: blur(26px) saturate(118%);
  -webkit-backdrop-filter: blur(26px) saturate(118%);
}

  .btop{
  display:flex;
  align-items:baseline;
  gap:10px;
}
.bname{
  flex:1 1 auto;
  min-width:0;

  font-size:.56rem;          /* smaller category titles */
  font-weight:520;           /* explicitly NOT bold */
  letter-spacing:.18em;
  text-transform:uppercase;

  color:var(--ink);
}



.btime{
  flex:0 0 auto;
  min-width:72px;
  text-align:right;
  font-weight:650;
  color:var(--ink-dim);
  white-space:nowrap;
  font-size:.74rem;
  text-transform:uppercase;
  letter-spacing:.06em;
}

  .bsub{margin-top:2px;color:var(--ink-dim);font-size:.74rem;font-weight:650;text-transform:uppercase;letter-spacing:.04em}

  .nightsky{
    margin-top:10px;
    background:var(--paper);
  	border:none;
    border-radius:18px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px) saturate(125%);
    -webkit-backdrop-filter:blur(18px) saturate(125%);
    padding:14px;
  }
  .nightsky-top{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:10px;
    padding-bottom:8px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:10px;
  }
  .nightsky-top .k{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:850;
  }
  .nightsky-top .v{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:850;
  }
  .nightsky-svgwrap{
    width:100%;
    height:170px;
    border-radius:14px;
    background:rgba(43,34,244,.06);
    border:none;
  }
  #night-sky-svg{width:100%;height:100%}

  .nightsky-legend{
    margin-top:10px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .nightsky-item{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;

  background: rgba(255,255,255,.06);
  border: none;
  box-shadow:
    0 0 46px rgba(255,255,255,.12),
    inset 0 0 26px rgba(255,255,255,.24);

  backdrop-filter: blur(22px) saturate(118%);
  -webkit-backdrop-filter: blur(22px) saturate(118%);

  color:var(--ink);
  font-weight:500;
  font-size:.68rem;
  letter-spacing:.12em;
  text-transform:uppercase;
}

  .nightsky-dot{
    width:10px;height:10px;border-radius:50%;
    box-shadow:0 0 14px rgba(255,255,255,.35);
  }

  /* =========================
     Widgets (cards)
     ========================= */
  .widgets-row,
  .widgets-row-two{
    margin-top:10px;
    display:grid;
    gap:10px;
  }
  .widgets-row{grid-template-columns:repeat(3,1fr)}
  .widgets-row-two{grid-template-columns:repeat(2,1fr)}

  @media (max-width:980px){
    .widgets-row,
    .widgets-row-two{grid-template-columns:1fr}
  }

  .widget{
  	background: rgba(255,255,255,.06);
  	border:none;
    border-radius:18px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    min-width:0;
  }

  .widget-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 12px;
  	background: rgba(255,255,255,.06);
    border-bottom:1px solid rgba(43,34,244,.12);
  }

  .widget-title{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.74);
    font-weight:850;
  }
  /* Small LIVE tag inside widget title */
.widget-title .live-tag{
  font-size:.56rem;
  letter-spacing:.16em;
  font-weight:850;
  color:rgba(43,34,244,.64);
  margin-left:6px;
  white-space:nowrap;
}


  .widget-sub{
    font-size:.72rem;
    color:var(--ink-dim);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:60%;
    text-align:right;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.06em;
    transition: opacity .15s ease;
  }
  
  a.widget-sub:hover{
    opacity: 0.6;
  }

  .widget-body{
    position:relative;
    aspect-ratio:16/10;
  	background: rgba(255,255,255,.06);
  }

  /* Allow popups to overflow map widget containers */
  .map-widget .widget-body {
    overflow: visible !important;
  }
  
  .map-widget {
    overflow: visible !important;
  }
  
  /* Ensure Leaflet popups appear on top and escape clipping */
  .leaflet-popup-pane {
    z-index: 9999 !important;
  }
  
  .leaflet-pane {
    z-index: 400 !important;
  }
  
  .leaflet-top,
  .leaflet-bottom {
    z-index: 1000 !important;
  }
  
  .quake-geo-popup {
    z-index: 9999 !important;
  }
  
  .quake-geo-popup .leaflet-popup-content-wrapper {
    z-index: 9999 !important;
  }
  
  /* Status pill should not block popup */
  .quake-status-wrap {
    z-index: 800 !important;
  }

  /* Clean earthquake markers */
  .quake-marker-pulse {
    filter: none;
  }

  .widget-body img,
  .widget-body iframe{
    width:100%;
    height:100%;
    object-fit:cover;
    border:none;
    display:block;
  }

  /* Fix Leaflet tile seams */
  .leaflet-tile-container img {
    outline: none !important;
    border: none !important;
  }
  .leaflet-container {
    background: #f5f5f5 !important;
  }
  .leaflet-tile {
    filter: none !important;
    image-rendering: auto !important;
  }

  .badge{
    display:none;
  }

  /* Mini solar pills (Aurora + GOES overlays) */
  .mini-solar{
    position:absolute;
    top:10px;left:10px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    z-index:3;
    pointer-events:none;
  }
  .mini-pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.46);
  	border:none;
    box-shadow:0 0 18px rgba(43,34,244,.10), inset 0 0 16px rgba(255,255,255,.28);
    backdrop-filter:blur(12px);
    -webkit-backdrop-filter:blur(12px);
    color:var(--ink);
    font-weight:900;
    font-size:.74rem;
  }
  .mini-key{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:950;
  }
  .mini-val{color:var(--ink);font-weight:950}

  /* Preserve true-black widget bodies */
  #aurora-body,
  #aurora-canvas,
  #aurora-img-fallback{
    background:#000 !important;
  }
  .widget-body[style*="background:#000"]{
    background:#000 !important;
  }

  /* Canvas + fallback sizing */
  #aurora-canvas,
  #aurora-img-fallback{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }

  /* =========================
     Audio section
     ========================= */
  .audio-section{
    background:var(--paper-strong);
  	border:none;
    border-radius:22px;
    padding:14px;
    box-shadow:var(--glow-main);
    backdrop-filter:blur(22px) saturate(130%);
    -webkit-backdrop-filter:blur(22px) saturate(130%);
  }

  .audio-header-title{
    font-size:.78rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.74);
    font-weight:900;
  }
  .audio-sub{
    margin-top:6px;
    font-size:.86rem;
    color:var(--ink-dim);
    font-weight:650;
    text-transform:uppercase;
    letter-spacing:.06em;
  }

  .play-all{
    margin-top:10px;
    padding:8px 14px;
    border-radius:999px;
  	border:none;
    background:rgba(255,255,255,.46);
    color:var(--ink);
    cursor:pointer;
    font-size:.74rem;
    font-weight:950;
    letter-spacing:.16em;
    text-transform:uppercase;
    box-shadow:0 0 26px rgba(43,34,244,.14), inset 0 0 18px rgba(255,255,255,.26);
  }
  .play-all:hover{
    box-shadow:0 0 34px rgba(43,34,244,.18), inset 0 0 22px rgba(255,255,255,.30);
  }

  /* Spectrum bars (so your audio block doesn't look broken) */
  .spectrum{
    margin-top:12px;
    height:22px;
    display:flex;
    align-items:flex-end;
    gap:6px;
  }
  .spectrum-bar{
    width:10px;
    height:8px;
    border-radius:6px;
    background:rgba(43,34,244,.22);
  	border:none;
    box-shadow:0 0 16px rgba(43,34,244,.10), inset 0 0 12px rgba(255,255,255,.22);
    transition:height .18s ease;
  }
  .spectrum.playing .spectrum-bar:nth-child(1){height:18px}
  .spectrum.playing .spectrum-bar:nth-child(2){height:12px}
  .spectrum.playing .spectrum-bar:nth-child(3){height:20px}
  .spectrum.playing .spectrum-bar:nth-child(4){height:14px}
  .spectrum.playing .spectrum-bar:nth-child(5){height:17px}

  .channels{margin-top:12px;display:flex;flex-direction:column;gap:10px}
  .channel{
    background:var(--paper-soft);
  	border:none;
    border-radius:16px;
    padding:10px;
    box-shadow:var(--glow-soft);
  }
  .channel-name{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:900;
  }
  #a-status{margin-top:6px;color:var(--ink-dim);font-weight:700;font-size:.86rem;text-transform:uppercase;letter-spacing:.06em}
  .slider-row{margin-top:10px}
  input[type="range"]{width:100%}

  #cloud-soundscape-root,
  #cloud-soundscape-root main,
  .panel,
  .content-stack,
  .weather-card{
    background:none !important;
    box-shadow:none !important;
    border:none !important;
    outline:none !important;
  }

  /* Removed transform properties that break position:fixed on modals */

  .sun-timeline,
  .nightsky,
  .widget,
  .forecast7-section,
  .audio-section,
  .bullet,
  .nightsky-item,
  .forecast7-chip{
    -webkit-mask-image: -webkit-radial-gradient(white, black);
    mask-image: radial-gradient(white, black);
    isolation: isolate;
  }

  /* =========================
     MOBILE RESPONSIVE STYLES
     ========================= */
  
  /* Tablet breakpoint */
  @media (max-width: 1024px) {
    .widgets-row {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .weather-alerts-block {
      position: relative;
      top: auto;
      left: auto;
      right: auto;
      margin-top: 12px;
      padding-right: 0;
    }
    
    .weather-top-row {
      padding-right: 120px;
    }
    
    .weather-moon-block .moon-img {
      width: 200px;
      height: 200px;
    }
  }

  /* Mobile breakpoint */
  @media (max-width: 768px) {
    #cloud-soundscape-root main {
      padding: 10px;
      overflow-x: hidden;
    }
    
    .panel {
      gap: 8px;
      overflow: visible;
    }
    
    .content-stack {
      gap: 8px;
      overflow: visible;
    }

    /* Main weather card mobile */
    .left-now {
      padding: 12px;
      border-radius: 16px;
    }
    
    .weather-top-row {
      flex-direction: column;
      align-items: center;
      padding-right: 0;
      min-height: auto;
      gap: 8px;
    }
    
    .weather-left-stack {
      width: 100%;
      align-items: center;
    }
    
    .weather-main {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
    }
    
    .weather-temp-block .temp {
      font-size: 2.6rem;
    }
    
    .weather-temp-block .feels {
      font-size: 0.82rem;
    }
    
    .weather-cond-block .cond-icon-img {
      width: 70px;
      height: 70px;
    }
    
    /* Moon repositioned for mobile */
    .weather-moon-block {
      position: relative;
      top: auto;
      right: auto;
      width: 100%;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      margin-top: 8px;
      border-top: 1px solid rgba(43,34,244,.10);
    }
    
    .weather-moon-block .moon-img {
      width: 80px;
      height: 80px;
      transform: scale(1.19);
    }
    
    .weather-moon-block .moon-text {
      margin-top: 0;
      text-align: left;
    }
    
    /* Alerts mobile */
    .weather-alerts-block {
      position: relative;
      top: auto;
      left: auto;
      right: auto;
      width: 100%;
      align-items: stretch;
      margin-top: 8px;
    }
    
    .weather-alert {
      max-width: 100%;
    }
    
    /* Details rows mobile */
    .weather-details-row {
      margin-top: 10px;
      padding-top: 10px;
    }
    
    .weather-hilo {
      font-size: 0.78rem;
      margin-bottom: 10px;
    }
    
    .weather-stats-grid {
      gap: 4px 10px;
    }
    
    .weather-stat .k {
      font-size: 0.58rem;
    }
    
    .weather-stat .v {
      font-size: 0.62rem;
    }
    
    /* 7-day forecast mobile */
    .forecast7-section {
      padding: 10px;
      border-radius: 14px;
    }
    
    .forecast7-chips {
      gap: 6px;
      padding-bottom: 6px;
      margin: 0;
      padding-left: 0;
      padding-right: 0;
      flex-wrap: nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
    }
    
    .forecast7-chip {
      min-width: 72px;
      flex: 0 0 auto;
      padding: 6px 4px;
      border-radius: 12px;
    }
    
    .forecast7-chip .day {
      font-size: 0.58rem;
    }
    
    .forecast7-chip .icon {
      width: 34px;
      height: 34px;
    }
    
    .forecast7-chip .temps {
      font-size: 0.66rem;
    }
    
    .forecast7-chip .precip {
      font-size: 0.54rem;
    }

    /* Timeline mobile */
    .sun-timeline {
      padding: 10px;
      border-radius: 14px;
      min-height: 140px;
    }
    
    .sun-timeline-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      padding-bottom: 6px;
      margin-bottom: 8px;
    }
    
    .sun-timeline-meta {
      flex-wrap: wrap;
      gap: 8px 12px;
    }
    
    .meta-item {
      gap: 4px;
    }
    
    .meta-key {
      font-size: 0.48rem;
    }
    
    .meta-val {
      font-size: 0.66rem;
    }
    
    .sun-timeline-bar {
      height: 75px;
      min-width: 0;
      width: 100%;
    }
    
    .tl-hour-time {
      font-size: 0.38rem;
    }
    
    .tl-hour-icon {
      width: 14px;
      height: 14px;
    }
    
    .tl-hour-temp {
      font-size: 0.48rem;
    }
    
    .tl-hour-precip {
      font-size: 0.38rem;
    }
    
    .tl-now-bubble {
      bottom: -28px;
      padding: 4px 7px;
      border-radius: 8px;
    }
    
    .tl-now-temp {
      font-size: 0.68rem;
    }
    
    .tl-now-label {
      font-size: 0.40rem;
    }

    /* Night sky mobile */
    .nightsky {
      padding: 10px;
      border-radius: 14px;
    }
    
    .nightsky-top {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      padding-bottom: 6px;
      margin-bottom: 8px;
    }
    
    .nightsky-top .k,
    .nightsky-top .v {
      font-size: 0.54rem;
    }
    
    .nightsky-svgwrap {
      height: 140px;
    }
    
    #night-sky-svg {
      min-width: 0;
      width: 100%;
    }
    
    .nightsky-legend {
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .nightsky-item {
      padding: 4px 8px;
      font-size: 0.60rem;
      gap: 6px;
    }
    
    .nightsky-dot {
      width: 8px;
      height: 8px;
    }
    
    /* Space events mobile */
    .skygrid {
      gap: 8px;
    }
    
    .skcard {
      padding: 8px;
      border-radius: 12px;
    }
    
    .skk {
      font-size: 0.54rem;
    }
    
    .skv {
      font-size: 0.88rem;
    }
    
    .bullets {
      gap: 4px;
    }
    
    .bullet {
      padding: 6px 8px;
      border-radius: 10px;
    }
    
    .bname {
      font-size: 0.52rem;
    }
    
    .btime {
      font-size: 0.66rem;
      min-width: 60px;
    }
    
    .bsub {
      font-size: 0.66rem;
      margin-top: 2px;
    }

    /* Widget grids mobile */
    .widgets-row,
    .widgets-row-two {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    .widget {
      border-radius: 14px;
    }
    
    .widget-head {
      padding: 8px 10px;
    }
    
    .widget-title {
      font-size: 0.54rem;
      letter-spacing: 0.10em;
    }
    
    .widget-title .live-tag {
      font-size: 0.50rem;
    }
    
    .widget-sub {
      font-size: 0.64rem;
      max-width: 50%;
    }
    
    .widget-body {
      aspect-ratio: 16/9;
      min-height: 200px;
      overflow: hidden;
    }
    
    /* Mini pills on widgets mobile */
    .mini-solar {
      top: 6px;
      left: 6px;
      gap: 4px;
    }
    
    .mini-pill {
      padding: 4px 8px;
      gap: 4px;
      font-size: 0.66rem;
    }
    
    .mini-key {
      font-size: 0.56rem;
    }

    /* Location dropdown mobile */
    .loc-name {
      font-size: 1.0rem;
    }
    
    .loc-meta {
      font-size: 0.74rem;
    }
    
    .loc-cycler {
      gap: 0;
    }

    .loc-arrow {
      width: 20px;
      height: 20px;
      opacity: .5;
      min-height: 32px;
    }

    .loc-cycler-center {
      width: 220px;
    }

    /* Hazard map status pills mobile */
    #lightning-status-pill,
    #fire-status-pill,
    #quake-status-pill {
      font-size: 0.60rem;
      padding: 5px 10px;
    }
    
    #glm-toggle-btn {
      font-size: 0.54rem;
      padding: 4px 8px;
    }

    /* Audio section mobile */
    .audio-section {
      padding: 12px;
      border-radius: 16px;
    }
    
    .audio-header-title {
      font-size: 0.70rem;
    }
    
    .audio-sub {
      font-size: 0.78rem;
    }
    
    .play-all {
      padding: 10px 16px;
      font-size: 0.68rem;
    }
    
    .channel {
      padding: 10px;
      border-radius: 12px;
    }
    
    .channel-name {
      font-size: 0.58rem;
    }
  }

  /* Small mobile breakpoint */
  @media (max-width: 480px) {
    #cloud-soundscape-root main {
      padding: 8px;
    }
    
    .left-now {
      padding: 10px;
    }
    
    .weather-temp-block .temp {
      font-size: 2.2rem;
    }
    
    .weather-cond-block .cond-icon-img {
      width: 56px;
      height: 56px;
    }
    
    .weather-moon-block .moon-img {
      width: 65px;
      height: 65px;
    }
    
    .weather-stats-grid {
      gap: 3px 8px;
    }
    
    .weather-stat .k {
      font-size: 0.52rem;
    }
    
    .weather-stat .v {
      font-size: 0.56rem;
    }
    
    .forecast7-chip {
      min-width: 0;
      flex: 1;
      padding: 4px 2px;
    }
    
    .forecast7-chip .icon {
      width: 28px;
      height: 28px;
    }
    
    .forecast7-chip .temps {
      font-size: 0.60rem;
    }
    
    .sun-timeline-bar {
      height: 68px;
    }
    
    .widget-body {
      aspect-ratio: 4/3;
      min-height: 180px;
      overflow: hidden;
    }
    
    .nightsky-svgwrap {
      height: 120px;
    }
    
    #night-sky-svg {
      min-width: 0;
      width: 100%;
    }
    
    .bsub {
      font-size: 0.60rem;
      line-height: 1.3;
    }
  }

  /* Touch-friendly tap targets */
  @media (hover: none) and (pointer: coarse) {
    .loc-arrow {
      min-height: 32px;
      min-width: 32px;
    }
    
    .forecast7-chip {
      min-width: 68px;
    }
    
    .nightsky-item {
      min-height: 36px;
    }
    
    .quake-item,
    .fire-item {
      min-height: 44px;
    }
    
    .play-all {
      min-height: 48px;
    }
    
    }

  /* Landscape mobile */
  @media (max-width: 900px) and (orientation: landscape) {
    .weather-top-row {
      flex-direction: row;
      flex-wrap: wrap;
      padding-right: 100px;
    }
    
    .weather-moon-block {
      position: absolute;
      top: 0;
      right: 10px;
      width: auto;
      flex-direction: column;
      border-top: none;
      padding: 0;
      margin-top: 0;
    }
    
    .weather-moon-block .moon-img {
      width: 90px;
      height: 90px;
    }
    
    .widgets-row,
    .widgets-row-two {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .widget-body {
      aspect-ratio: 16/10;
    }
  }

  /* Safe area insets for notched devices */
  @supports (padding: max(0px)) {
    #cloud-soundscape-root main {
      padding-left: max(10px, env(safe-area-inset-left));
      padding-right: max(10px, env(safe-area-inset-right));
      padding-bottom: max(18px, env(safe-area-inset-bottom));
    }
  }

  /* Fix mobile scroll */
  @media (max-width: 768px) {
    .left-now {
      overflow: hidden !important;
    }
    
    .forecast7-section {
      overflow: hidden !important;
    }
    
    .forecast7-chips {
      overflow: hidden !important;
    }
  }

/* =========================================================
     UNIFIED WIDGET POPUP MODAL SYSTEM
     ========================================================= */
  .alert-modal-overlay{position:absolute;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:99999;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;opacity:0;visibility:hidden;transition:opacity 0.3s ease,visibility 0.3s ease;overflow:auto;}
.alert-modal-overlay.active{opacity:1;visibility:visible;}
.alert-modal-content{position:relative;background:linear-gradient(145deg,rgba(30,30,35,0.98),rgba(20,20,25,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:16px;max-width:600px;width:90vw;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.7);transform:scale(0.92);transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1);}
.alert-modal-overlay.active .alert-modal-content{transform:scale(1);}
.alert-modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.2);}
.alert-modal-title-wrap{display:flex;align-items:center;gap:12px;}
.alert-modal-icon{font-size:24px;}
.alert-modal-title{font-size:18px;font-weight:600;color:#fff;letter-spacing:0.5px;}
.alert-modal-close{background:none;border:none;color:#888;font-size:28px;cursor:pointer;padding:0 8px;line-height:1;transition:color 0.2s;}
.alert-modal-close:hover{color:#fff;}
.alert-modal-body{padding:24px;overflow-y:auto;flex:1;color:#e0e0e0;font-size:14px;line-height:1.6;}
.alert-detail-section{margin-bottom:20px;}
.alert-detail-section:last-child{margin-bottom:0;}
.alert-detail-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;font-weight:500;}
.alert-detail-value{color:#fff;}
.alert-detail-value.warning{color:#f87171;}
.alert-detail-value.watch{color:#fb923c;}
.alert-detail-value.advisory{color:#facc15;}
.alert-timing{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:20px;}
.alert-timing-item{text-align:center;}
.alert-timing-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:4px;}
.alert-timing-value{font-size:14px;color:#fff;font-weight:500;}
.alert-description{white-space:pre-wrap;font-family:inherit;background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;border-left:3px solid rgba(255,255,255,0.1);}
.alert-areas{font-size:13px;color:#aaa;line-height:1.5;}
.alert-severity-badge{display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-left:8px;}
.alert-severity-badge.extreme{background:rgba(220,38,38,0.3);color:#fca5a5;}
.alert-severity-badge.severe{background:rgba(239,68,68,0.25);color:#fca5a5;}
.alert-severity-badge.moderate{background:rgba(249,115,22,0.25);color:#fdba74;}
.alert-severity-badge.minor{background:rgba(234,179,8,0.25);color:#fde047;}

.widget-modal-overlay{
    position: absolute;
    inset: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.94);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    box-sizing: border-box;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    overflow: auto;
  }

  .widget-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .widget-modal-content {
    position: relative;
    background: rgba(255,255,255,0.98);
    border-radius: 20px;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255,255,255,0.1);
    overflow: hidden;
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    width: 90vw;
    max-width: 900px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    transform: scale(0.92);
  }

  .widget-modal-overlay.active .widget-modal-content {
    transform: scale(1);
  }

  .widget-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: rgba(43, 34, 244, 0.04);
    border-bottom: 1px solid rgba(43, 34, 244, 0.08);
    flex-shrink: 0;
  }

  .widget-modal-title {
    font-size: 0.72rem;
    font-weight: 850;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: rgba(43, 34, 244, 0.75);
  }

  .widget-modal-subtitle {
    font-size: 0.65rem;
    font-weight: 600;
    color: rgba(43, 34, 244, 0.5);
    margin-left: 12px;
  }

  .widget-modal-close {
    width: 32px;
    height: 32px;
    background: rgba(43, 34, 244, 0.08);
    border: none;
    border-radius: 50%;
    color: rgba(43, 34, 244, 0.6);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .widget-modal-close:hover {
    background: rgba(220, 50, 50, 0.12);
    color: rgba(220, 50, 50, 0.9);
    transform: rotate(90deg);
  }

  .widget-modal-body {
    flex: 1;
    overflow: auto;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
  }

  .widget-modal-body.content-image {
    padding: 16px;
    background: #000;
  }

  .widget-modal-body.content-image img {
    display: block;
    max-width: 100%;
    max-height: calc(85vh - 120px);
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 8px;
    margin: 0 auto;
  }

  .widget-modal-body.content-card {
    padding: 24px;
    background: rgba(255, 255, 255, 1);
    align-items: flex-start;
    justify-content: flex-start;
  }

  .widget-modal-body.content-card > * {
    width: 100%;
    max-width: 100%;
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
  }

  .widget-modal-body .forecast7-chips {
    gap: 12px;
  }

  .widget-modal-body .forecast7-chip {
    padding: 14px 12px;
    min-width: 85px;
  }

  .widget-modal-body .forecast7-chip .icon {
    width: 52px;
    height: 52px;
  }

  .widget-modal-body .forecast7-chip .day {
    font-size: 0.68rem;
  }

  .widget-modal-body .forecast7-chip .temps {
    font-size: 0.82rem;
  }

  .widget-modal-body .today-tl-sky-bar {
    min-height: 220px;
  }

  .widget-modal-body .today-tl-weather-icon {
    font-size: 30px;
  }

  .widget-modal-body .today-tl-weather-temp {
    font-size: 0.92rem;
  }

  .widget-modal-body .nightsky-svgwrap {
    height: 220px;
  }

  .widget-modal-body .nightsky-legend {
    gap: 10px;
  }

  .widget-modal-body .nightsky-item {
    padding: 6px 10px;
    font-size: 0.66rem;
  }

  .widget-modal-body.content-map {
    padding: 0;
    background: #f5f5f5;
  }

  .widget-modal-body.content-map .modal-map-container {
    width: 100%;
    height: calc(85vh - 80px);
    min-height: 400px;
  }

  .widget-modal-body.is-loading {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .widget-modal-body.is-loading::after {
    content: "";
    width: 40px;
    height: 40px;
    border: 3px solid rgba(43, 34, 244, 0.15);
    border-top-color: rgba(43, 34, 244, 0.7);
    border-radius: 50%;
    animation: modal-spin 0.8s linear infinite;
  }

  @keyframes modal-spin {
    to { transform: rotate(360deg); }
  }

  .widget.clickable-widget {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--glow-mid);
  }

  .clickable-card {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--glow-mid);
  }

  .widget.clickable-widget .widget-head {
    position: relative;
  }

  .widget.clickable-widget .widget-head::after {
    content: "";
    position: absolute;
    top: 50%;
    right: 40px;
    transform: translateY(-50%);
    font-size: 14px;
    color: rgba(43, 34, 244, 0.25);
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
  }

  .widget.clickable-widget:hover .widget-head::after {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .widget-modal-overlay {
      padding: 12px;
    }
    
    .widget-modal-content {
      width: 100%;
      max-width: 100%;
      max-height: 92vh;
      border-radius: 16px;
    }
    
    .widget-modal-header {
      padding: 12px 16px;
    }
    
    .widget-modal-title {
      font-size: 0.64rem;
    }
    
    .widget-modal-body {
      padding: 12px;
      min-height: 200px;
    }
    
    .widget-modal-body.content-image img {
      max-height: calc(92vh - 100px);
    }
    
    .widget-modal-body.content-map .modal-map-container {
      height: calc(92vh - 70px);
    }

    .widget.clickable-widget .widget-head::after {
      display: none;
    }
  }

  #widget-modal,
  #alert-modal,
  #dynamic-alert-modal {
    transform: none !important;
    contain: none !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    overflow: auto !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .tl-now-line,
    .spectrum-bar,
    * {
      transition: none !important;
      animation: none !important;
    }
  }

  /* Hide all scrollbars on mobile */
  @media (max-width: 768px) {
    * {
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }
    
    *::-webkit-scrollbar {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
      background: transparent !important;
    }
  }

  /* Force modals to viewport center */
  #alert-modal,
  #widget-modal {
    transform: none !important;
    contain: none !important;
    filter: none !important;
    perspective: none !important;
    will-change: auto !important;
    isolation: auto !important;
  }

  /* Ensure body doesn't create containing block */
  body.modal-open {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
body > #dynamic-alert-modal {
  transform: none !important;
  contain: none !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  overflow: auto !important;
}
  @keyframes goes-spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>

<!-- SITE LOADING SCREEN -->
<div id="site-loading-screen" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:999999;overflow:hidden;pointer-events:none;">
  <!-- BLUISH at top -->
  <div id="intro-bluish" style="position:absolute;top:5%;left:0;right:0;z-index:3;text-align:center;font-size:clamp(2rem, 10vw, 5rem);font-weight:400;letter-spacing:clamp(0.15em, 2vw, 0.4em);color:#4a9eff;font-family:'QelliaRegular','Bodoni Moda',Georgia,serif;text-shadow:0 0 60px rgba(74,158,255,.5),0 0 120px rgba(74,158,255,.25),0 0 180px rgba(74,158,255,.1);padding-left:clamp(0.15em, 2vw, 0.4em);text-transform:uppercase;">BLUISH</div>
  <!-- VOID stacks down right side -->
  <div id="intro-void-container" style="position:absolute;top:0;right:0;bottom:0;z-index:2;display:flex;flex-direction:column;align-items:flex-end;gap:0;overflow:hidden;pointer-events:none;padding-right:clamp(0.75rem, 2vw, 1.5rem);"></div>
</div>
<style>
  @keyframes void-in {
    from { opacity:0; transform:translateY(-4px); }
    to { opacity:1; transform:translateY(0); }
  }
  .void-line {
    font-family:'QelliaRegular','Bodoni Moda',Georgia,serif;
    font-size:0.7rem;
    font-weight:400;
    letter-spacing:.5em;
    color:rgba(74,158,255,0.25);
    animation: void-in 0.25s ease-out forwards;
    line-height:1.6;
    padding-left:.5em;
  }
</style>

<!-- Alert Detail Modal -->
<div id="dashboard-content" style="opacity:0;transition:opacity 0.4s ease;">
<div class="alert-modal-overlay" id="alert-modal">
  <div class="alert-modal-content">
    <div class="alert-modal-header">
      <div class="alert-modal-title-wrap">
        <span class="alert-modal-icon" id="alert-modal-icon"></span>
        <span class="alert-modal-title" id="alert-modal-title">Alert</span>
      </div>
      <button class="alert-modal-close" id="alert-modal-close">&times;</button>
    </div>
    <div class="alert-modal-body" id="alert-modal-body"></div>
  </div>
</div>

<!-- Widget Popup Modal (outside root to avoid backdrop-filter issues) -->
<div class="widget-modal-overlay" id="widget-modal">
  <div class="widget-modal-content">
    <div class="widget-modal-header">
      <div style="display:flex;align-items:baseline;">
        <span class="widget-modal-title" id="modal-title">--</span>
        <span class="widget-modal-subtitle" id="modal-subtitle"></span>
      </div>
      <button class="widget-modal-close" id="widget-modal-close">&times;</button>
    </div>
    <div class="widget-modal-body" id="widget-modal-body"></div>
  </div>
</div>

<div id="cloud-soundscape-root">

  <!-- Screen reader announcements -->
  <div id="sr-announcements" aria-live="polite" aria-atomic="true" style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;"></div>

  <main>
    <section class="panel">
      <div class="content-stack">

        <div class="weather-card">
          <div class="top-grid">

            <!-- Main Weather Section -->
<div class="left-now">
  
  <!-- Top Row: Location, Temp, Condition, Moon -->
  <div class="weather-top-row">
    <div class="weather-left-stack">
      <div class="loc-cycler" id="loc-cycler">
        <div class="loc-cycler-center">
          <div class="loc-name-row">
            <button class="loc-search-toggle" id="loc-search-toggle" aria-label="Search location" title="Search for a location"></button>
            <div class="loc-name" id="loc-name">NYC</div>
            <div class="loc-search-box" id="loc-search-box">
              <input type="text" class="loc-search-input" id="loc-search-input" placeholder="City, zip, park, place..." maxlength="60" autocomplete="off" />
              <button class="loc-search-close" id="loc-search-close" aria-label="Close search"></button>
              <div id="loc-suggestions" style="position:absolute; top:calc(100% + 4px); left:0; right:0; z-index:10000; background:rgba(255,255,255,.15); backdrop-filter:blur(20px) saturate(120%); -webkit-backdrop-filter:blur(20px) saturate(120%); border-radius:12px; max-height:220px; overflow-y:auto; display:none; box-shadow:0 0 30px rgba(255,255,255,.12), inset 0 0 20px rgba(255,255,255,.22);"></div>
            </div>
          </div>
          <div id="loc-meta" style="font-size:.52rem;opacity:.6;text-transform:uppercase;letter-spacing:.08em;color:rgba(255,255,255,.5);padding:0 0 0 4px;margin-top:1px;line-height:1;font-weight:600;">---</div>
          <div class="loc-dots-row">
            <button class="loc-arrow" id="loc-prev" aria-label="Previous location"></button>
            <div class="loc-dots" id="loc-dots"></div>
            <button class="loc-arrow" id="loc-next" aria-label="Next location"></button>
          </div>
        </div>
      </div>
    
      <div class="weather-main">
        <div class="weather-temp-block">
          <div class="temp" id="temp">--</div>
        </div>
        <div class="weather-cond-block">
          <img class="cond-icon-img" id="cond-icon" src="https://basmilius.github.io/weather-icons/production/fill/all/clear-day.svg" alt="Weather condition" />
        </div>
      </div>
    </div>
    
    <!-- Weather Alerts Area (center-right) -->
    <div class="weather-alerts-block" id="weather-alerts"></div>
    
    <div class="weather-moon-block">
      <img class="moon-img" id="moon-mini-img" src="" alt="Current moon phase" />
    </div>
  </div>

  <!-- Details Row -->
  <div class="weather-details-row">
    <div class="weather-hilo" id="today-hi-lo"><span class="feels-inline" id="feels-inline">Feels --</span> <span class="hilo-sep"></span> <span id="hilo-text">High -- | Low --</span></div>
    <div class="weather-stats-grid">
      <div class="weather-stat"><span class="k">Rain</span><span class="v" id="precip-amt">--</span></div>
      <div class="weather-stat"><span class="k">Next hrs</span><span class="v" id="forecast-row">--</span></div>
      <div class="weather-stat"><span class="k">Wind</span><span class="v" id="wind">--</span></div>
      <div class="weather-stat"><span class="k">Gusts</span><span class="v" id="gusts">--</span></div>
      <div class="weather-stat"><span class="k">Humidity</span><span class="v" id="humidity">--</span></div>
      <div class="weather-stat"><span class="k">Pressure</span><span class="v" id="pressure">--</span></div>
      <div class="weather-stat"><span class="k">UV</span><span class="v" id="uv">--</span></div>
    </div>
  </div>

  <!-- Air & Pollen Row -->
  <div class="weather-details-row">
    <div class="weather-stats-grid">
      <div class="weather-stat"><span class="k">AQI</span><span class="ap-val" id="aqi-val">--</span></div>
      <div class="weather-stat"><span class="k">PM2.5</span><span class="v" id="pm25-val">--</span></div>
      <div class="weather-stat"><span class="k">PM10</span><span class="v" id="pm10-val">--</span></div>
      <div class="weather-stat"><span class="k"> Tree</span><span class="pollen-val" id="pollen-tree">--</span></div>
      <div class="weather-stat"><span class="k"> Grass</span><span class="pollen-val" id="pollen-grass">--</span></div>
      <div class="weather-stat"><span class="k"> Weed</span><span class="pollen-val" id="pollen-weed">--</span></div>
      <div class="weather-stat"><span class="k"> Ragweed</span><span class="pollen-val" id="pollen-ragweed">--</span></div>
    </div>
  </div>
<!-- 7-Day Forecast -->
  <div class="forecast7-section">
    <div class="forecast7-top">
      <div class="forecast7-label" id="forecast-label">7 DAY FORECAST</div>
    </div>
    <div class="forecast7-chips" id="forecast7"></div>
  </div>
</div>
            
<!-- /Left -->

          </div>

          <!-- TODAY Timeline Widget (v4/v5 integrated) -->
          <div class="today-timeline-card" id="today-timeline-card">
            
            <!-- Main timeline body -->
            <div class="today-tl-body">
              
              <!-- Top bars: Kp and Cloud -->
              <div class="today-tl-top-bars">
                <div class="today-tl-bar-row">
                  <div class="today-tl-bar-label">Kp <span id="today-tl-kp-val" style="font-size:.52rem;font-weight:700;opacity:.85"></span></div>
                  <div class="today-tl-bar-track" id="today-tl-kp-track"></div>
                </div>
                <div class="today-tl-bar-row">
                  <div class="today-tl-bar-label"> <span id="today-tl-cloud-pct" style="font-size:.52rem;font-weight:700;opacity:.85"></span></div>
                  <div class="today-tl-bar-track cloud" id="today-tl-cloud-track"></div>
                </div>
              </div>
              
              <!-- Sky bar with planets + weather -->
              <div class="today-tl-sky-bar" id="today-tl-sky-bar">
                
                <!-- Sky gradient bands -->
                <div class="today-tl-sky-bands" id="today-tl-sky-bands"></div>
                
                <!-- Planet visibility tracks -->
                <div class="today-tl-planet-tracks" id="today-tl-planet-tracks"></div>
                
                <!-- Weather row with animated icons -->
                <div class="today-tl-weather-row" id="today-tl-weather-row"></div>
                
                <!-- NOW marker -->
                <div class="today-tl-now-marker" id="today-tl-now-marker" style="display:none;">
                  <div class="today-tl-now-label">NOW</div>
                  <div class="today-tl-now-bubble">
                    <span class="today-tl-now-temp" id="today-tl-now-temp">--</span>
                    <span class="today-tl-now-time" id="today-tl-now-time">--:--</span>
                  </div>
                </div>
                
              </div>
            </div>
            
            <!-- Legend -->
            <div class="today-tl-legend" id="today-tl-legend">
              <!-- Sun times: Sunrise/Sunset + Golden Hours -->
              <div class="today-tl-legend-item" style="gap:2px;">
                <div style="display:flex;align-items:center;gap:4px;font-size:.55rem;font-weight:700;color:var(--ink);">
                  <span id="today-tl-sunrise" style="color:#e8a954;">--:--</span>
                  <span style="color:rgba(var(--ink-rgb),.3);">|</span>
                  <span id="today-tl-sunset" style="color:#e8a954;">--:--</span>
                </div>
                <div style="font-size:.48rem;font-weight:600;color:rgba(var(--ink-rgb),.5);">AM <span id="today-tl-golden-am" style="color:#e8a954;">--</span></div>
                <div style="font-size:.48rem;font-weight:600;color:rgba(var(--ink-rgb),.5);">PM <span id="today-tl-golden-pm" style="color:#e8a954;">--</span></div>
              </div>
              <!-- Daylight -->
              <div class="today-tl-legend-item" style="gap:2px;">
                <div style="font-size:.55rem;font-weight:700;color:var(--ink);" id="today-tl-daylight">--</div>
                <div style="font-size:.48rem;font-weight:600;color:#4ecdc4;" id="today-tl-daylight-change">--</div>
              </div>
              <!-- Moon -->
              <div class="today-tl-legend-item" style="gap:1px;">
                <div style="font-size:.5rem;font-weight:700;color:var(--ink);" id="today-tl-moon-name">--</div>
                <div style="font-size:.48rem;font-weight:600;color:rgba(var(--ink-rgb),.5);" id="today-tl-moon-illum">--%</div>
              </div>
              <div class="today-tl-legend-item" id="today-tl-legend-moon-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-moon" id="today-tl-legend-moon"></div>Moon</div>
                <span class="today-tl-legend-dir" id="legend-dir-moon"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#9A9A9A;"></div>Mercury</div>
                <span class="today-tl-legend-dir" id="legend-dir-mercury"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#FFE5B4;"></div>Venus</div>
                <span class="today-tl-legend-dir" id="legend-dir-venus"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#C44D2A;"></div>Mars</div>
                <span class="today-tl-legend-dir" id="legend-dir-mars"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#E8A954;"></div>Jupiter</div>
                <span class="today-tl-legend-dir" id="legend-dir-jupiter"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#F0C75E;"></div>Saturn</div>
                <span class="today-tl-legend-dir" id="legend-dir-saturn"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#8ECAE6;"></div>Uranus</div>
                <span class="today-tl-legend-dir" id="legend-dir-uranus"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#4AA3DF;"></div>Neptune</div>
                <span class="today-tl-legend-dir" id="legend-dir-neptune"></span>
              </div>
              <!-- Kp scale -->
              <div class="today-tl-legend-item">
                <div class="today-tl-kp-scale">
                  <span>Kp 0</span>
                  <div class="today-tl-kp-box" style="background:#009933;"></div>
                  <div class="today-tl-kp-box" style="background:#33cc33;"></div>
                  <div class="today-tl-kp-box" style="background:#66cc33;"></div>
                  <div class="today-tl-kp-box" style="background:#99cc33;"></div>
                  <div class="today-tl-kp-box" style="background:#cccc33;"></div>
                  <div class="today-tl-kp-box" style="background:#ffff00;"></div>
                  <div class="today-tl-kp-box" style="background:#ffcc00;"></div>
                  <div class="today-tl-kp-box" style="background:#ff9900;"></div>
                  <div class="today-tl-kp-box" style="background:#ff3333;"></div>
                  <div class="today-tl-kp-box" style="background:#cc0033;"></div>
                  <span>9</span>
                </div>
              </div>
              <!-- Cloud scale -->
              <div class="today-tl-legend-item">
                <div class="today-tl-kp-scale">
                  <span></span>
                  <div class="today-tl-kp-box" style="background:#ffffff;border:1px solid rgba(0,0,0,0.1);"></div>
                  <div class="today-tl-kp-box" style="background:#c8c8c8;"></div>
                  <div class="today-tl-kp-box" style="background:#8c8c8c;"></div>
                  <div class="today-tl-kp-box" style="background:#5a5a5a;"></div>
                  <span></span>
                </div>
              </div>
            </div>
            
            <!-- Space Events -->
            <div class="skygrid" style="margin-top:12px;">
              <div class="skcard" style="min-height:auto;background:transparent;box-shadow:none;padding:10px 0 0 0;">
                <div class="skk">Space events</div>
                <div class="skv" id="space-events">--</div>
                <div class="bullets" id="space-events-bullets"></div>
              </div>
            </div>
            
          </div>

          <!-- Full-width Timeline (existing - kept for compatibility) -->
          <div class="sun-timeline" id="sun-timeline" aria-label="daily sun and weather timeline" style="display:none;">
            
            <!-- Header row -->
            <div class="sun-timeline-header">
              <div class="sun-timeline-title">
                <span class="sun-label-text">TODAY'S TIMELINE</span>
              </div>
              <div class="sun-timeline-meta">
                <span class="meta-item"><span class="meta-key">Sunrise</span> <span class="meta-val" id="tl-sunrise">--:--</span></span>
                <span class="meta-item"><span class="meta-key">Sunset</span> <span class="meta-val" id="tl-sunset">--:--</span></span>
                <span class="meta-item"><span class="meta-key">Golden AM</span> <span class="meta-val" id="tl-golden-am">--</span></span>
                <span class="meta-item"><span class="meta-key">Golden PM</span> <span class="meta-val" id="tl-golden-pm">--</span></span>
                <span class="meta-item"><span class="meta-key">Daylight</span> <span class="meta-val" id="tl-daylight">--</span></span>
                <span class="meta-item"><span class="meta-val" id="tl-daylight-change">--</span></span>
              </div>
            </div>

            <!-- Main timeline bar -->
            <div class="sun-timeline-bar" id="sun-timeline-bar">
              
              <!-- Background bands (golden hour, blue hour shading) -->
              <div class="tl-bands" id="tl-bands"></div>
              
              <!-- Hour markers and weather data -->
              <div class="tl-hours" id="tl-hours"></div>
              
              <!-- Sun event ticks -->
              <div class="tl-events" id="tl-events"></div>
              
              <!-- NOW marker -->
              <div class="tl-now" id="tl-now">
                <div class="tl-now-line"></div>
                <div class="tl-now-bubble">
                  <span class="tl-now-temp" id="tl-now-temp">--</span>
                  <span class="tl-now-label">NOW</span>
                </div>
              </div>

            </div>

            <!-- Event labels below bar -->
            <div class="tl-event-labels" id="tl-event-labels"></div>

          </div>

          <!-- WIDGETS -->
          
          <!-- ROW 1B: RADAR -->
          <div class="widgets-row" style="grid-template-columns:1fr;margin-top:12px;margin-bottom:12px;">

            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">RADAR</div>
                <a id="fcast-source-link" href="https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=gfs&area=conus" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;display:none;">GFS NCEP</a>
              </div>
              <div class="widget-body" style="background:#0a0a1a;position:relative;overflow:hidden;">
                <div id="fcast-img-container" style="position:absolute;top:0;left:0;right:0;bottom:55px;overflow:hidden;">
                  <img id="fcast-radar-img" alt="GFS Forecast Radar" style="width:106%;height:106%;object-fit:contain;filter:invert(1) hue-rotate(180deg) contrast(1.2) saturate(1.5);position:absolute;top:47%;left:50%;transform:translate(-50%,-50%);z-index:1;" />
                </div>
                <div id="fcast-live-map" style="display:none;width:100%;height:100%;position:absolute;top:0;left:0;z-index:1;background:#0a0a1a;"></div>
                <!-- Left panel controls -->
                <div style="position:absolute;top:10px;left:0;bottom:60px;z-index:10;display:flex;flex-direction:column;align-items:flex-start;gap:3px;overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none;padding:6px 8px;background:linear-gradient(to right, rgba(0,0,0,.65) 0%, rgba(0,0,0,.4) 80%, transparent 100%);border-radius:0 8px 8px 0;">
                  <!-- LIVE -->
                  <button onclick="switchFcastRange('live')" id="fcast-range-live" style="padding:4px 10px;border-radius:6px;border:1px solid rgba(34,197,94,.5);background:rgba(34,197,94,.2);backdrop-filter:blur(8px);color:#22c55e;font-size:.45rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;"> LIVE</button>
                  <div style="width:40px;border-top:1px solid rgba(255,255,255,.12);margin:2px 0;"></div>
                  <!-- FORECAST label -->
                  <div id="fcast-forecast-label" style="font-size:.38rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-left:2px;">FORECAST</div>
                  <div id="fcast-range-area" style="display:flex;flex-direction:column;align-items:flex-start;gap:3px;">
                    <button onclick="switchFcastRange('tomorrow')" id="fcast-range-tomorrow" style="padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Tomorrow</button>
                    <button onclick="switchFcastRange('48h')" id="fcast-range-48h" style="padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">48 HOUR | 2 DAY</button>
                    <button onclick="switchFcastRange('72h')" id="fcast-range-72h" style="padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">72 HOUR | 3 DAY</button>
                    <button onclick="switchFcastRange('7d')" id="fcast-range-7d" style="padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">7 DAY | WEEK</button>
                    <button onclick="switchFcastRange('16d')" id="fcast-range-16d" style="padding:3px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">16 DAY | MAX</button>
                  </div>
                  <!-- MODELS -->
                  <div id="fcast-models-label" style="font-size:.38rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-left:2px;margin-top:3px;">MODELS</div>
                  <button onclick="switchFcastModel('gfs')" id="fcast-model-gfs" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(74,158,255,.5);background:rgba(74,158,255,.3);backdrop-filter:blur(8px);color:#4a9eff;font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">GFS 16D</button>
                  <button onclick="switchFcastModel('nam')" id="fcast-model-nam" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">NAM 84H</button>
                  <button onclick="switchFcastModel('nam_hires')" id="fcast-model-nam_hires" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">NAM 3KM 60H</button>
                  <button onclick="switchFcastModel('hrrr')" id="fcast-model-hrrr" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">HRRR 3KM 48H</button>
                  <button onclick="switchFcastModel('href')" id="fcast-model-href" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">HREF ENS 48H</button>
                  <button onclick="switchFcastModel('nbm')" id="fcast-model-nbm" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">NBM BLEND</button>
                  <button onclick="switchFcastModel('gefs')" id="fcast-model-gefs" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">GEFS SPREAD</button>
                  <!-- AREAS label -->
                  <div style="font-size:.38rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-left:2px;margin-top:3px;">AREAS</div>
                  <!-- Area selector -->
                  <div id="fcast-area-selector" style="display:flex;flex-direction:column;gap:3px;max-width:150px;">
                    <button onclick="switchFcastArea('conus')" id="fcast-area-conus" style="padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">CONTINENTAL US</button>
                    <button onclick="switchFcastArea('namer')" id="fcast-area-namer" style="padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">NORTH AMERICA</button>
                    <button onclick="switchFcastArea('us-ne')" id="fcast-area-us-ne" style="padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">NORTHEAST</button>
                    <button onclick="switchFcastArea('us-se')" id="fcast-area-us-se" style="padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTHEAST</button>
                    <button onclick="switchFcastArea('us-nc')" id="fcast-area-us-nc" style="padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">GREAT LAKES</button>
                    <button onclick="switchFcastArea('us-sc')" id="fcast-area-us-sc" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTH CENTRAL</button>
                    <button onclick="switchFcastArea('us-nw')" id="fcast-area-us-nw" style="padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">PACIFIC NW</button>
                    <button onclick="switchFcastArea('us-sw')" id="fcast-area-us-sw" style="padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">PACIFIC SW</button>
                    <button onclick="switchFcastArea('upper-ms')" id="fcast-area-upper-ms" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">UPPER MISS VALLEY</button>
                    <button onclick="switchFcastArea('south-ms')" id="fcast-area-south-ms" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTH MISS VALLEY</button>
                    <button onclick="switchFcastArea('n-rockies')" id="fcast-area-n-rockies" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">NORTH ROCKIES</button>
                    <button onclick="switchFcastArea('s-rockies')" id="fcast-area-s-rockies" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTH ROCKIES</button>
                    <button onclick="switchFcastArea('s-plains')" id="fcast-area-s-plains" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">SOUTH PLAINS</button>
                    <button onclick="switchFcastArea('alaska')" id="fcast-area-alaska" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">ALASKA</button>
                    <button onclick="switchFcastArea('hawaii')" id="fcast-area-hawaii" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">HAWAII</button>
                    <button onclick="switchFcastArea('pr')" id="fcast-area-pr" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">PUERTO RICO</button>
                    <button onclick="switchFcastArea('guam')" id="fcast-area-guam" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">GUAM</button>
                    <button onclick="switchFcastArea('north-pac')" id="fcast-area-north-pac" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">NORTH PACIFIC</button>
                    <button onclick="switchFcastArea('east-pac')" id="fcast-area-east-pac" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">EAST PACIFIC</button>
                    <button onclick="switchFcastArea('west-atl')" id="fcast-area-west-atl" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">WEST ATLANTIC</button>
                    <button onclick="switchFcastArea('atlantic')" id="fcast-area-atlantic" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">ATLANTIC</button>
                    <button onclick="switchFcastArea('arctic')" id="fcast-area-arctic" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">ARCTIC</button>
                    <button onclick="switchFcastArea('europe')" id="fcast-area-europe" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">EUROPE</button>
                    <button onclick="switchFcastArea('asia')" id="fcast-area-asia" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">ASIA</button>
                    <button onclick="switchFcastArea('africa')" id="fcast-area-africa" style="display:none;padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.42rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;text-align:left;">AFRICA</button>
                  </div>
                </div>
                <div style="position:absolute;top:10px;right:6px;bottom:60px;z-index:10;display:none;flex-direction:column;align-items:flex-end;gap:3px;overflow-y:auto;overflow-x:hidden;scrollbar-width:none;-ms-overflow-style:none;padding-right:2px;">
                  <!-- PRECIPITATION -->
                  <div style="font-size:.35rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;">PRECIPITATION</div>
                  <button onclick="switchFcastProduct('sim_radar')" id="fcast-tab-sim" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Reflectivity</button>
                  <button onclick="switchFcastProduct('max_ref')" id="fcast-tab-maxref" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Max Refl</button>
                  <button onclick="switchFcastProduct('radar_1km')" id="fcast-tab-radar1km" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1km Refl</button>
                  <button onclick="switchFcastProduct('echo_top')" id="fcast-tab-echotop" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Echo Tops</button>
                  <button onclick="switchFcastProduct('precip_type')" id="fcast-tab-ptype" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Precip Type</button>
                  <button onclick="switchFcastProduct('precip_total')" id="fcast-tab-ptot" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.5);backdrop-filter:blur(8px);color:#fff;font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Precip Totals</button>
                  <button onclick="switchFcastProduct('precip_1hr')" id="fcast-tab-precip1hr" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1hr Precip</button>
                  <button onclick="switchFcastProduct('precip_6hr')" id="fcast-tab-precip6hr" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">6hr Precip</button>
                  <button onclick="switchFcastProduct('precip_24hr')" id="fcast-tab-precip24hr" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">24hr Precip</button>
                  <button onclick="switchFcastProduct('snow_accum')" id="fcast-tab-snow" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Snow Accum</button>
                  <button onclick="switchFcastProduct('cape')" id="fcast-tab-cape" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Precip Water</button>
                  <div style="width:30px;border-top:1px solid rgba(255,255,255,.12);margin:2px 0;"></div>
                  <!-- TEMPERATURE & THICKNESS -->
                  <div style="font-size:.35rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;">TEMPERATURE</div>
                  <button onclick="switchFcastProduct('temperature')" id="fcast-tab-temp" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Temp & Precip</button>
                  <button onclick="switchFcastProduct('wnd_temp')" id="fcast-tab-wndtemp" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Wind & 2m Temp</button>
                  <button onclick="switchFcastProduct('low_thick')" id="fcast-tab-lowthick" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1000-850 Thick</button>
                  <button onclick="switchFcastProduct('mid_thick')" id="fcast-tab-midthick" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">850-700 Thick</button>
                  <button onclick="switchFcastProduct('gfs_850temp')" id="fcast-tab-gfs850temp" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">850mb Temp</button>
                  <button onclick="switchFcastProduct('850temp')" id="fcast-tab-850temp" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">850mb Temp</button>
                  <div style="width:30px;border-top:1px solid rgba(255,255,255,.12);margin:2px 0;"></div>
                  <!-- WIND & DYNAMICS -->
                  <div style="font-size:.35rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;">WIND & DYNAMICS</div>
                  <button onclick="switchFcastProduct('wind')" id="fcast-tab-wind" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Wind & MSLP</button>
                  <button onclick="switchFcastProduct('max_wind')" id="fcast-tab-maxwind" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Max Wind</button>
                  <button onclick="switchFcastProduct('jet_stream')" id="fcast-tab-jet" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Jet Stream</button>
                  <button onclick="switchFcastProduct('gfs_500wind')" id="fcast-tab-gfs500wind" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">500mb Wind</button>
                  <button onclick="switchFcastProduct('250wind')" id="fcast-tab-250wind" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">250mb Jets</button>
                  <button onclick="switchFcastProduct('gfs_fourpanel')" id="fcast-tab-gfs4panel" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">4-Panel</button>
                  <div style="width:30px;border-top:1px solid rgba(255,255,255,.12);margin:2px 0;"></div>
                  <!-- SEVERE WEATHER -->
                  <div id="fcast-severe-label" style="display:none;font-size:.35rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;">SEVERE</div>
                  <button onclick="switchFcastProduct('best_cape')" id="fcast-tab-bestcape" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Best CAPE</button>
                  <button onclick="switchFcastProduct('helicity')" id="fcast-tab-helicity" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Helicity</button>
                  <button onclick="switchFcastProduct('updraft')" id="fcast-tab-updraft" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Updraft Hlcy</button>
                  <button onclick="switchFcastProduct('lightning')" id="fcast-tab-lightning" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Lightning</button>
                  <div id="fcast-hrrr-divider" style="display:none;width:30px;border-top:1px solid rgba(255,255,255,.12);margin:2px 0;"></div>
                  <!-- UPPER AIR -->
                  <div style="font-size:.35rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;">UPPER AIR</div>
                  <button onclick="switchFcastProduct('humidity')" id="fcast-tab-rh" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">700mb Humidity</button>
                  <button onclick="switchFcastProduct('gfs_500rh')" id="fcast-tab-gfs500rh" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">500mb RH</button>
                  <button onclick="switchFcastProduct('gfs_850vort')" id="fcast-tab-gfs850vort" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">850mb Vort</button>
                  <button onclick="switchFcastProduct('500vort')" id="fcast-tab-500vort" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">500mb Vort</button>
                  <button onclick="switchFcastProduct('500mb')" id="fcast-tab-500mb" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">500mb Vort & Ht</button>
                  <div style="width:30px;border-top:1px solid rgba(255,255,255,.12);margin:2px 0;"></div>
                  <!-- AVIATION -->
                  <div id="fcast-aviation-label" style="display:none;font-size:.35rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;">AVIATION</div>
                  <button onclick="switchFcastProduct('visibility')" id="fcast-tab-vis" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Visibility</button>
                  <button onclick="switchFcastProduct('ceiling')" id="fcast-tab-ceiling" style="display:none;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Ceiling</button>
                  <!-- STRATOSPHERE -->
                  <div style="font-size:.35rem;font-weight:700;color:rgba(255,255,255,.3);font-family:system-ui,sans-serif;letter-spacing:.08em;text-transform:uppercase;padding-right:2px;">STRATOSPHERE</div>
                  <button onclick="switchFcastProduct('10mb')" id="fcast-tab-10mb" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">10mb Strato</button>
                </div>
                <!-- Forecast hour stepper -->
                <div style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:10;display:flex;align-items:center;gap:10px;padding:6px 14px;border-radius:16px;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);">
                  <button onclick="fcastRadarStep(-1)" style="background:none;border:none;color:#fff;font-size:1.1rem;cursor:pointer;padding:4px 8px;font-family:system-ui;"></button>
                  <span id="fcast-radar-label" style="font-size:.65rem;font-weight:700;color:#fff;font-family:system-ui,sans-serif;min-width:220px;text-align:center;letter-spacing:.03em;">F003  +3H</span>
                  <button onclick="fcastRadarStep(1)" style="background:none;border:none;color:#fff;font-size:1.1rem;cursor:pointer;padding:4px 8px;font-family:system-ui;"></button>
                  <button onclick="fcastRadarTogglePlay()" id="fcast-radar-play-btn" style="background:none;border:none;color:#fff;font-size:.9rem;cursor:pointer;padding:4px 8px;font-family:system-ui;"></button>
                </div>
                <div class="badge" id="fcast-badge">LIVE RADAR</div>
              </div>
            </div>

          </div>

          <!-- ROW 2: CLOUDS -->
          <div class="widgets-row" style="grid-template-columns:1fr">

            <!-- GOES CLOUDS -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">CLOUDS <span class="live-tag" id="goes-live"> LIVE</span></div>
                <a href="https://www.star.nesdis.noaa.gov/goes/index.php" target="_blank" rel="noopener" class="widget-sub" id="goes-sub" style="text-decoration:none;color:inherit;">NESDIS/STAR GOES</a>
              </div>
              <div class="widget-body">
                <!-- Duration selector -->
                <div style="position:absolute;top:10px;right:10px;z-index:10;display:flex;gap:3px;">
                  <button onclick="switchGoesLength('1h')" id="goes-len-1h" style="padding:3px 7px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1h</button>
                  <button onclick="switchGoesLength('6h')" id="goes-len-6h" style="padding:3px 7px;border-radius:8px;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.5);backdrop-filter:blur(8px);color:#fff;font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">6h</button>
                  <button onclick="switchGoesLength('12h')" id="goes-len-12h" style="padding:3px 7px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">12h</button>
                  <button onclick="switchGoesLength('24h')" id="goes-len-24h" style="padding:3px 7px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">24h</button>
                  <button onclick="switchGoesLength('48h')" id="goes-len-48h" style="padding:3px 7px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.48rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">48 HOUR | 2 DAY</button>
                </div>
                <canvas id="goes-canvas" style="width:100%;height:100%;display:block;"></canvas>
                <div id="goes-loading-overlay" style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:5;transition:opacity .6s;">
                  <div style="width:28px;height:28px;border:3px solid rgba(255,255,255,.15);border-top-color:#4ecdc4;border-radius:50%;animation:goes-spin .8s linear infinite;"></div>
                  <div id="goes-loading-text" style="margin-top:8px;font-size:.55rem;font-weight:700;color:rgba(255,255,255,.7);font-family:system-ui,sans-serif;letter-spacing:.05em;">CHASING CLOUDS...</div>
                </div>
                <div class="badge">NESDIS/STAR</div>
              </div>
            </div>

          </div>

          <!-- ROW 3: HAZARD MAPS - Lightning / Wildfires / Earthquakes -->
          <div class="widgets-row">

            <!-- LIGHTNING -->
<div class="widget map-widget">
  <div class="widget-head">
    <div class="widget-title">LIGHTNING <span class="live-tag" id="lightning-live"> LIVE</span></div>
    <a href="https://www.blitzortung.org/en/live_lightning_maps.php" target="_blank" rel="noopener" class="widget-sub" id="lightning-sub" style="text-decoration:none;color:inherit;">Blitzortung</a>
  </div>
  <div class="widget-body" style="position:relative;overflow:hidden;border-radius:0 0 8px 8px;">
    <iframe id="lightning-iframe" src="" style="width:100%;height:100%;border:none;border-radius:8px;" loading="lazy" allow="geolocation" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>
</div>

            <!-- WILDFIRES -->
            <div class="widget map-widget">
              <div class="widget-head">
                <div class="widget-title">WILDFIRES <span class="live-tag" id="fire-live"> LIVE</span></div>
                <span class="widget-sub" style="display:inline-flex;gap:0;"><a href="https://livingatlas.arcgis.com/en/home/" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">ESRI</a><span style="opacity:.5;margin:0 4px;">+</span><a href="https://www.ospo.noaa.gov/products/land/hms.html" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">NOAA HMS</a></span>
              </div>
              <div class="widget-body" style="position:relative;">
                <div id="fire-map" style="width:100%; height:100%; background:#f5f5f5;"></div>
                <div id="fire-labels-toggle" onclick="toggleFireLabels()" style="position:absolute; top:10px; right:10px; z-index:1000; padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.5rem; font-weight:700; color:rgba(255,255,255,.5); cursor:pointer; user-select:none; font-family:system-ui,sans-serif; text-transform:uppercase; letter-spacing:.5px;"> OFF</div>
                <div id="fire-aqi-pill" style="position:absolute; bottom:10px; left:10px; z-index:1000; padding:6px 12px; border-radius:16px; background:rgba(0,0,0,.75); backdrop-filter:blur(8px); font-size:1rem; font-weight:700; color:#fff; box-shadow:0 2px 8px rgba(0,0,0,.2); display:none; pointer-events:none;"><span id="fire-aqi-value">--</span> AQI</div>
                <div class="fire-status-wrap" style="position:absolute; top:10px; left:10px; z-index:1000;">
                  <div id="fire-status-pill" style="padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.5rem; font-weight:700; color:rgba(255,255,255,.7); cursor:pointer; font-family:system-ui,sans-serif; letter-spacing:.3px;"> Loading...</div>
                  <div id="fire-dropdown" style="position:absolute; top:100%; left:0; padding-top:6px; opacity:0; visibility:hidden; transition: opacity .2s ease, visibility .2s ease; pointer-events:none;">
                    <div id="fire-list" style="background:rgba(0,0,0,.85); backdrop-filter:blur(12px); border-radius:10px; padding:6px; min-width:220px; max-height:220px; overflow-y:auto;"></div>
                  </div>
                </div>
                <!-- Smoke layer always on -->
              </div>
            </div>

            <!-- TORNADOES -->
            <div class="widget map-widget">
              <div class="widget-head">
                <div class="widget-title">TORNADOES <span class="live-tag" id="tornado-live"> LIVE</span></div>
                <a href="https://www.spc.noaa.gov/climo/reports/today.html" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NOAA SPC Reports</a>
              </div>
              <div class="widget-body" style="position:relative;">
                <!-- Time range tabs -->
                <div style="position:absolute; top:10px; right:10px; z-index:500; display:flex; gap:3px;">
                  <button onclick="switchTornadoRange('today')" id="torn-tab-today" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.4);background:rgba(0,0,0,.5);backdrop-filter:blur(8px);color:rgba(255,255,255,.9);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">Today</button>
                  <button onclick="switchTornadoRange('48h')" id="torn-tab-48h" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">48H</button>
                  <button onclick="switchTornadoRange('7d')" id="torn-tab-7d" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">7D</button>
                  <button onclick="switchTornadoRange('1m')" id="torn-tab-1m" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1M</button>
                  <button onclick="switchTornadoRange('6m')" id="torn-tab-6m" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">6M</button>
                  <button onclick="switchTornadoRange('1y')" id="torn-tab-1y" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.15);background:rgba(0,0,0,.3);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">1Y</button>
                  <button onclick="switchTornadoRange('forecast')" id="torn-tab-forecast" style="padding:4px 8px;border-radius:8px;border:1px solid rgba(255,165,0,.4);background:rgba(255,100,0,.15);backdrop-filter:blur(8px);color:rgba(255,180,80,.9);font-size:.5rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;"> Forecast</button>
                </div>
                <div id="tornado-map" style="width:100%; height:100%; background:#1a1a2e;"></div>
                <div class="tornado-status-wrap" style="position:absolute; bottom:10px; left:10px; z-index:400;">
                  <div id="tornado-status-pill" style="padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.5rem; font-weight:700; color:rgba(255,255,255,.7); cursor:pointer; font-family:system-ui,sans-serif; letter-spacing:.3px;"> Loading...  2026: <span id="tornado-year-count">--</span></div>
                  <div id="tornado-dropdown" style="position:absolute; bottom:100%; left:0; padding-bottom:6px; opacity:0; visibility:hidden; transition: opacity .2s ease, visibility .2s ease; pointer-events:none;">
                    <div id="tornado-combo-list" style="background:rgba(0,0,0,.85); backdrop-filter:blur(12px); border-radius:10px; padding:6px; min-width:240px; max-height:320px; overflow-y:auto;">
                      <div id="tornado-top5-list"></div>
                      <div id="tornado-list" style="border-top:1px solid rgba(255,255,255,.1); margin-top:4px; padding-top:4px;"></div>
                    </div>
                  </div>
                </div>
                <div style="position:absolute; bottom:10px; right:10px; z-index:400; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); border-radius:8px; padding:5px 7px; font-size:.45rem; color:#ccc; line-height:1.6;">
                  <span style="color:#90caf9;"></span>UNK
                  <span style="color:#66bb6a;"></span>EF0
                  <span style="color:#fdd835;"></span>EF1
                  <span style="color:#ffa726;"></span>EF2
                  <span style="color:#ef5350;"></span>EF3
                  <span style="color:#ab47bc;"></span>EF4
                  <span style="color:#ec407a;"></span>EF5<br>
                  <span style="color:#00e5ff;"></span> Hail &nbsp;
                  <span style="color:#76ff03;"></span> Wind &nbsp;
                  <span style="border:1px dashed #ffd600;padding:0 3px;font-size:.4rem;"></span> SPC
                </div>
              </div>
            </div>

          </div>

          <!-- ROW: EARTHQUAKES (solo) -->
          <div class="widgets-row" style="grid-template-columns:1fr;">
            <!-- EARTHQUAKES -->
            <div class="widget map-widget">
              <div class="widget-head">
                <div class="widget-title">EARTHQUAKES <span class="live-tag" id="quake-live"> LIVE</span></div>
                <span class="widget-sub" style="display:inline-flex;gap:0;"><a href="https://earthquake.usgs.gov/earthquakes/map/" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">USGS</a><span style="opacity:.5;margin:0 4px;">+</span><a href="https://macrostrat.org" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;">Macrostrat</a></span>
              </div>
              <div class="widget-body" style="position:relative;">
                <div id="quake-map" style="width:100%; height:100%; background:#f5f5f5;"></div>
                <div class="quake-status-wrap" style="position:absolute; top:10px; left:10px; z-index:400;">
                  <div id="quake-status-pill" style="padding:4px 8px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.5rem; font-weight:700; color:rgba(255,255,255,.7); cursor:pointer; font-family:system-ui,sans-serif; letter-spacing:.3px;"> Loading...</div>
                  <div id="quake-dropdown" style="position:absolute; top:100%; left:0; padding-top:6px; opacity:0; visibility:hidden; transition: opacity .2s ease, visibility .2s ease; pointer-events:none;">
                    <div id="quake-list" style="background:rgba(0,0,0,.85); backdrop-filter:blur(12px); border-radius:10px; padding:6px; min-width:200px; max-height:220px; overflow-y:auto;"></div>
                  </div>
                </div>
                <div id="quake-geo-toggle" onclick="toggleQuakeGeology()" style="position:absolute; top:10px; right:10px; z-index:1000; padding:4px 8px; border-radius:8px; border:1px solid rgba(34,197,94,.4); background:rgba(0,0,0,.3); backdrop-filter:blur(8px); font-size:.5rem; font-weight:700; color:#22c55e; cursor:pointer; user-select:none; font-family:system-ui,sans-serif; text-transform:uppercase; letter-spacing:.5px;"> ON</div>
              </div>
            </div>
          </div>

          <!-- ROW: LASCO C3 / LASCO C2 -->
          <div class="widgets-row" style="grid-template-columns:1fr 1fr;">

            <!-- LASCO C3 -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">LASCO C3 <span style="font-weight:500;opacity:0.7;">OUTER</span> <span class="live-tag" id="lasco-c3-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/lasco-coronagraph" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NASA/ESA SOHO</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;overflow:hidden;">
                <img id="lasco-c3-img" alt="LASCO C3 Coronagraph" style="width:115%;height:115%;object-fit:cover;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);" />
                <div class="badge">SOHO LASCO</div>
                
              </div>
            </div>

            <!-- LASCO C2 -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">LASCO C2 <span style="font-weight:500;opacity:0.7;">INNER</span> <span class="live-tag" id="lasco-c2-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/lasco-coronagraph" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NASA/ESA SOHO</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="lasco-c2-img" alt="LASCO C2 Coronagraph" style="width:100%;height:100%;object-fit:cover;" />
                <div class="badge">SOHO LASCO</div>
                
              </div>
            </div>

          </div>

          <!-- ROW: SOLAR MAGNETIC FIELD / SUVI -->
          <div class="widgets-row" style="grid-template-columns:1fr 1fr;">

            <!-- SDO PFSS MAGNETIC FIELD -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">SOLAR MAGNETIC FIELD <span class="live-tag" id="pfss-live"> LIVE</span></div>
                <a href="https://sdo.gsfc.nasa.gov/data/" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NASA SDO PFSS</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="pfss-img" alt="SDO AIA 171 with PFSS magnetic field lines" style="width:100%;height:100%;object-fit:contain;background:#000;" />
                <div class="badge">NASA SDO</div>
              </div>
            </div>

            <!-- SUVI THEMATIC MAP -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">SUVI THEMATIC MAP <span class="live-tag" id="suvi-map-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/goes-solar-ultraviolet-imager-suvi" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NOAA GOES</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="suvi-map-img" alt="SUVI Thematic Map" style="width:100%;height:100%;object-fit:cover;" />
                <div class="badge">GOES SUVI</div>
                
              </div>
            </div>

          </div>

          <!-- ROW: AURORA / ENLIL -->
          <div class="widgets-row" style="grid-template-columns:1fr 1fr;">

            <!-- AURORA -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">AURORA FORECAST <span class="live-tag" id="aurora-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/aurora-30-minute-forecast" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC OVATION</a>
              </div>
              <div class="widget-body" id="aurora-body">
                <div class="mini-solar" aria-label="solar weather summary">
                  <span class="mini-pill"><span class="mini-key">Kp</span><span class="mini-val" id="sw-kp">--</span></span>
                  <span class="mini-pill"><span class="mini-key">G</span><span class="mini-val" id="sw-g">--</span></span>
                  <span class="mini-pill"><span class="mini-key">Bz</span><span class="mini-val" id="sw-bz">--</span></span>
                  <span class="mini-pill"><span class="mini-key">Wind</span><span class="mini-val" id="sw-wind">--</span></span>
                  <span class="mini-pill"><span class="mini-key">Vis</span><span class="mini-val" id="sw-vis">--</span></span>
                </div>

                <canvas id="aurora-canvas"></canvas>
                <img id="aurora-img-fallback" alt="Aurora 30-minute outlook fallback" />
                <div class="badge">SWPC Ovation</div>
              </div>
            </div>

            <!-- ENLIL -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">SOLAR WIND <span class="live-tag" id="enlil-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/wsa-enlil-solar-wind-prediction" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC WSA-ENLIL</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="enlil-img" alt="WSA-ENLIL solar wind prediction" style="width:100%;height:100%;object-fit:cover;" />
                <div class="badge">SWPC WSA-ENLIL</div>
                
              </div>
            </div>

          </div>

          <!-- ROW 4: GEOSPACE MAGNETOSPHERE -->
          <div class="widgets-row">

            <!-- GEOSPACE VELOCITY -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">GEOSPACE MAGNETOSPHERE | VELOCITY <span class="live-tag" id="geo-vel-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/geospace-magnetosphere-movies" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC</a>
              </div>
              <div class="widget-body" style="background:#000;">
                <img id="geo-vel-img" alt="Geospace Magnetosphere - Velocity" style="width:100%;height:100%;object-fit:cover;" />
              </div>
            </div>

            <!-- GEOSPACE DENSITY -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">GEOSPACE MAGNETOSPHERE | DENSITY <span class="live-tag" id="geo-den-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/geospace-magnetosphere-movies" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC</a>
              </div>
              <div class="widget-body" style="background:#000;">
                <img id="geo-den-img" alt="Geospace Magnetosphere - Density" style="width:100%;height:100%;object-fit:cover;" />
              </div>
            </div>

            <!-- GEOSPACE PRESSURE -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">GEOSPACE MAGNETOSPHERE | PRESSURE <span class="live-tag" id="geo-pre-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/geospace-magnetosphere-movies" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC</a>
              </div>
              <div class="widget-body" style="background:#000;">
                <img id="geo-pre-img" alt="Geospace Magnetosphere - Pressure" style="width:100%;height:100%;object-fit:cover;" />
              </div>
            </div>

          </div>

          </div>

        <!-- AUDIO -->
        <div class="audio-section">
          <div class="audio-header-title">Ambient</div>
          <div class="audio-sub">Single channel  add your stream URL to play.</div>

          <button id="play-all" class="play-all"> Play</button>

          <div id="spectrum" class="spectrum">
            <div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div>
          </div>

          <div class="channels">
            <div class="channel">
              <div class="channel-name">Stream</div>
              <div id="a-status">No source set</div>
              <div class="slider-row">
                <input id="vol-a" type="range" min="0" max="1" step="0.01" value="0.8" />
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <audio id="audio-a" loop crossorigin="anonymous"></audio>
</div>

<script>
(function () {
  "use strict";

  /* =========================================================
     CONFIG
     ========================================================= */
  var LOCATIONS = [
    { id: "nyc", name: "NYC", lat: 40.7411, lon: -73.9897, tz: "America/New_York", radar: "KOKX", radarName: "NWS Upton", radarRegion: "NORTHEAST", goes: { sat: "G19", sector: "ne" } },
    { id: "la", name: "LA", lat: 34.0195, lon: -118.4912, tz: "America/Los_Angeles", radar: "KVTX", radarName: "NWS Los Angeles", radarRegion: "PACSOUTHWEST", goes: { sat: "G18", sector: "wus" } },
    { id: "chicago", name: "Chicago", lat: 42.3175, lon: -89.0937, tz: "America/Chicago", radar: "KLOT", radarName: "NWS Chicago", radarRegion: "UPPERMISSVLY", goes: { sat: "G19", sector: "umv" } },
    { id: "sf", name: "SF", lat: 37.7559, lon: -122.5108, tz: "America/Los_Angeles", radar: "KMUX", radarName: "NWS San Francisco", radarRegion: "PACNORTHWEST", goes: { sat: "G18", sector: "wus" } },
    { id: "charleston", name: "Charleston", lat: 32.8141, lon: -79.9295, tz: "America/New_York", radar: "KCLX", radarName: "NWS Charleston", radarRegion: "SOUTHEAST", goes: { sat: "G19", sector: "se" } },
    { id: "pv", name: "Pleasant Valley", lat: 41.7340, lon: -73.8212, tz: "America/New_York", radar: "KENX", radarName: "NWS Albany", radarRegion: "NORTHEAST", goes: { sat: "G19", sector: "ne" } },
    { id: "stephenson", name: "Stephenson", lat: 39.2148, lon: -78.0594, tz: "America/New_York", radar: "KLWX", radarName: "NWS Sterling", radarRegion: "NORTHEAST", goes: { sat: "G19", sector: "ne" } }
  ];
  
  var LOCATION = LOCATIONS[0];
  var TZ = LOCATION.tz;

  /* =========================================================
     UTILITIES
     ========================================================= */
  function fetchWithTimeout(url, opts, ms){
    ms = ms || 12000;
    opts = opts || {};
    var ctrl = null;
    try{ ctrl = new AbortController(); opts.signal = ctrl.signal; } catch(e){}
    var t = null;
    if (ctrl){
      t = setTimeout(function(){ try{ ctrl.abort(); }catch(e){} }, ms);
    }
    return fetch(url, opts).then(function(r){
      if (t) clearTimeout(t);
      return r;
    }, function(err){
      if (t) clearTimeout(t);
      throw err;
    });
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function setText(el, txt){ if (el) el.textContent = (txt == null ? "" : String(txt)); }

  /* =========================================================
     TIME HELPERS (12-hour, no AM/PM)
     ========================================================= */
  function fmt12NoSuffixFromDate(d){
    if (!d || !isFinite(d.getTime())) return "--:--";
    var h = d.getHours();
    var m = d.getMinutes();
    var hh = h % 12; if (hh === 0) hh = 12;
    return String(hh) + ":" + (m < 10 ? "0"+m : m);
  }
  function fmt12NoSuffix(iso){ return fmt12NoSuffixFromDate(new Date(iso)); }
  
  function fmtMonthDay(d){
    if (!d || !isFinite(d.getTime())) return "--";
    var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return months[d.getMonth()] + " " + d.getDate();
  }

  /* =========================================================
     AUDIO
     ========================================================= */
  var CHANNEL_A_URL = ""; // Put your stream URL here (optional)
  var audioA   = document.getElementById("audio-a");
  var volA     = document.getElementById("vol-a");
  var aStatus  = document.getElementById("a-status");
  var playBtn  = document.getElementById("play-all");
  var spectrum = document.getElementById("spectrum");

  (function initAudio(){
    if (!audioA || !volA || !aStatus || !playBtn || !spectrum) return;

    if (CHANNEL_A_URL){
      audioA.src = CHANNEL_A_URL;
      aStatus.textContent = "Ready";
    } else {
      aStatus.textContent = "No source set";
    }

    audioA.volume = parseFloat(volA.value || "0.8");
    volA.addEventListener("input", function(){
      audioA.volume = parseFloat(volA.value || "0.8");
    });

    var playing = false;
    playBtn.onclick = function(){
      if (!playing){
        if (audioA.src){
          audioA.play().catch(function(){});
        }
        playBtn.textContent = " Pause";
        spectrum.classList.add("playing");
        playing = true;
      } else {
        audioA.pause();
        playBtn.textContent = " Play";
        spectrum.classList.remove("playing");
        playing = false;
      }
    };
  })();

  /* =========================================================
     DOM REFS
     ========================================================= */
  var tempEl        = document.getElementById("temp");
  var feelsInlineEl = document.getElementById("feels-inline");
  var condTextEl    = document.getElementById("cond-text");
  var condIconEl    = document.getElementById("cond-icon");
  var locNameEl     = document.getElementById("loc-name");
  var locMetaEl     = document.getElementById("loc-meta");

  var windEl      = document.getElementById("wind");
  var gustsEl     = document.getElementById("gusts");
  var humidityEl  = document.getElementById("humidity");
  var pressureEl  = document.getElementById("pressure");
  var uvEl        = document.getElementById("uv");

  var hiLoEl        = document.getElementById("today-hi-lo");
  var precipAmtEl   = document.getElementById("precip-amt");
  var forecastRowEl = document.getElementById("forecast-row");

  var forecast7El    = document.getElementById("forecast7");

  var moonMiniIconEl = document.getElementById("moon-mini-icon");
  var moonMiniTextEl = document.getElementById("moon-mini-text");

  var nightSkyTitleEl = document.getElementById("night-sky-title");

  var spaceEventsEl        = document.getElementById("space-events");
  var spaceEventsBulletsEl = document.getElementById("space-events-bullets");

  var nightSkySvg    = document.getElementById("night-sky-svg");
  var nightSkyLegend = document.getElementById("night-sky-legend");

  var radarImg    = document.getElementById("radar-img");
  var radarLiveEl = document.getElementById("radar-live");

  var auroraCanvas      = document.getElementById("aurora-canvas");
  var auroraLiveEl      = document.getElementById("aurora-live");
  var auroraFallbackImg = document.getElementById("aurora-img-fallback");
  var auroraBtn         = document.getElementById("aurora-btn");

  var goesCanvas   = document.getElementById("goes-canvas");
  var goesLiveEl   = document.getElementById("goes-live");
  var goesFrameEl  = document.getElementById("goes-frame");

  var enlilImg    = document.getElementById("enlil-img");
  var enlilLiveEl = document.getElementById("enlil-live");

  // sunliveImg removed - replaced by SUVI Thematic Map

  // SWPC Geospace images (animated)
  var swpcGeoVelImg = document.getElementById("swpc-geo-vel-img");
  var swpcGeoDenImg = document.getElementById("swpc-geo-den-img");
  var swpcGeoPreImg = document.getElementById("swpc-geo-pre-img");

  var geoVelLiveEl = document.getElementById("geo-vel-live");
  var geoDenLiveEl = document.getElementById("geo-den-live");
  var geoPreLiveEl = document.getElementById("geo-pre-live");

  // Solar mini pills
  var swKp   = document.getElementById("sw-kp");
  var swG    = document.getElementById("sw-g");
  var swBz   = document.getElementById("sw-bz");
  var swWind = document.getElementById("sw-wind");
  var swVis  = document.getElementById("sw-vis");

  /* =========================================================
     ICONS (Open-Meteo weathercode) - COMPLETE MAPPING
     ========================================================= */
  var METEO_BASE = "https://basmilius.github.io/weather-icons/production/fill/all/";

  var ICONS_URL = {
    clearDay: METEO_BASE + "clear-day.svg",
    clearNight: METEO_BASE + "clear-night.svg",
    partlyDay: METEO_BASE + "partly-cloudy-day.svg",
    partlyNight: METEO_BASE + "partly-cloudy-night.svg",
    overcast: METEO_BASE + "overcast.svg",
    fogDay: METEO_BASE + "fog-day.svg",
    fogNight: METEO_BASE + "fog-night.svg",
    fog: METEO_BASE + "fog.svg",
    drizzle: METEO_BASE + "drizzle.svg",
    rain: METEO_BASE + "rain.svg",
    partlyRainDay: METEO_BASE + "partly-cloudy-day-rain.svg",
    partlyRainNight: METEO_BASE + "partly-cloudy-night-rain.svg",
    sleet: METEO_BASE + "sleet.svg",
    snow: METEO_BASE + "snow.svg",
    partlySnowDay: METEO_BASE + "partly-cloudy-day-snow.svg",
    partlySnowNight: METEO_BASE + "partly-cloudy-night-snow.svg",
    thunderstormsDay: METEO_BASE + "thunderstorms-day.svg",
    thunderstormsNight: METEO_BASE + "thunderstorms-night.svg",
    thunderstormsRain: METEO_BASE + "thunderstorms-rain.svg",
    unknown: METEO_BASE + "not-available.svg"
  };

  function isNightTime(){
    var hour = new Date().getHours();
    return hour < 6 || hour >= 20;
  }

  /* =========================================================
     WEATHER CODE TO ANIMATION CLASS MAPPING (v5 complete)
     ========================================================= */
  function getWeatherAnimClass(code, isNight){
    // Returns: { emoji, animClass, label }
    if (code === 0) return { emoji: isNight ? "" : "", animClass: isNight ? "night" : "sun", label: "Clear" };
    if (code === 1) return { emoji: isNight ? "" : "", animClass: "partly", label: "Mainly Clear" };
    if (code === 2) return { emoji: "", animClass: "partly", label: "Partly Cloudy" };
    if (code === 3) return { emoji: "", animClass: "cloud", label: "Overcast" };
    if (code === 45) return { emoji: "", animClass: "fog", label: "Fog" };
    if (code === 48) return { emoji: "", animClass: "fog", label: "Rime Fog" };
    if (code === 51) return { emoji: "", animClass: "drizzle", label: "Light Drizzle" };
    if (code === 53) return { emoji: "", animClass: "drizzle", label: "Drizzle" };
    if (code === 55) return { emoji: "", animClass: "drizzle", label: "Dense Drizzle" };
    if (code === 56) return { emoji: "", animClass: "freezing-drizzle", label: "Freezing Drizzle" };
    if (code === 57) return { emoji: "", animClass: "freezing-drizzle", label: "Dense Freezing Drizzle" };
    if (code === 61) return { emoji: "", animClass: "rain", label: "Light Rain" };
    if (code === 63) return { emoji: "", animClass: "rain", label: "Rain" };
    if (code === 65) return { emoji: "", animClass: "rain", label: "Heavy Rain" };
    if (code === 66) return { emoji: "", animClass: "freezing-rain", label: "Light Freezing Rain" };
    if (code === 67) return { emoji: "", animClass: "freezing-rain", label: "Heavy Freezing Rain" };
    if (code === 71) return { emoji: "", animClass: "snow", label: "Light Snow" };
    if (code === 73) return { emoji: "", animClass: "snow", label: "Snow" };
    if (code === 75) return { emoji: "", animClass: "snow", label: "Heavy Snow" };
    if (code === 77) return { emoji: "", animClass: "sleet", label: "Sleet" };
    if (code === 80) return { emoji: "", animClass: "rain", label: "Rain Showers" };
    if (code === 81) return { emoji: "", animClass: "rain", label: "Moderate Showers" };
    if (code === 82) return { emoji: "", animClass: "rain", label: "Violent Showers" };
    if (code === 85) return { emoji: "", animClass: "snow", label: "Snow Showers" };
    if (code === 86) return { emoji: "", animClass: "snow", label: "Heavy Snow Showers" };
    if (code === 95) return { emoji: "", animClass: "storm", label: "Thunderstorm" };
    if (code === 96) return { emoji: "", animClass: "storm-hail", label: "T-Storm + Hail" };
    if (code === 99) return { emoji: "", animClass: "storm-hail", label: "T-Storm + Heavy Hail" };
    return { emoji: "", animClass: "", label: "Weather" };
  }

  function iconForCode(code){
  var night = isNightTime();
  if (code === 0) return {t:"Clear", i: night ? ICONS_URL.clearNight : ICONS_URL.clearDay};
  if (code === 1) return {t:"Mainly Clear", i: night ? ICONS_URL.partlyNight : ICONS_URL.partlyDay};
  if (code === 2) return {t:"Partly Cloudy", i: night ? ICONS_URL.partlyNight : ICONS_URL.partlyDay};
  if (code === 3) return {t:"Overcast", i: ICONS_URL.overcast};
  if (code === 45) return {t:"Fog", i: night ? ICONS_URL.fogNight : ICONS_URL.fogDay};
  if (code === 48) return {t:"Rime Fog", i: ICONS_URL.fog};
  if (code === 51) return {t:"Light Drizzle", i: ICONS_URL.drizzle};
  if (code === 53) return {t:"Drizzle", i: ICONS_URL.drizzle};
  if (code === 55) return {t:"Dense Drizzle", i: ICONS_URL.drizzle};
  if (code === 56) return {t:"Light Freezing Drizzle", i: ICONS_URL.sleet};
  if (code === 57) return {t:"Freezing Drizzle", i: ICONS_URL.sleet};
  if (code === 61) return {t:"Light Rain", i: ICONS_URL.rain};
  if (code === 63) return {t:"Rain", i: ICONS_URL.rain};
  if (code === 65) return {t:"Heavy Rain", i: ICONS_URL.rain};
  if (code === 66) return {t:"Light Freezing Rain", i: ICONS_URL.sleet};
  if (code === 67) return {t:"Freezing Rain", i: ICONS_URL.sleet};
  if (code === 71) return {t:"Light Snow", i: ICONS_URL.snow};
  if (code === 73) return {t:"Snow", i: ICONS_URL.snow};
  if (code === 75) return {t:"Heavy Snow", i: ICONS_URL.snow};
  if (code === 77) return {t:"Snow Grains", i: ICONS_URL.sleet};
  if (code === 80) return {t:"Light Showers", i: night ? ICONS_URL.partlyRainNight : ICONS_URL.partlyRainDay};
  if (code === 81) return {t:"Showers", i: night ? ICONS_URL.partlyRainNight : ICONS_URL.partlyRainDay};
  if (code === 82) return {t:"Heavy Showers", i: ICONS_URL.rain};
  if (code === 85) return {t:"Light Snow Showers", i: night ? ICONS_URL.partlySnowNight : ICONS_URL.partlySnowDay};
  if (code === 86) return {t:"Snow Showers", i: ICONS_URL.snow};
  if (code === 95) return {t:"Thunderstorm", i: night ? ICONS_URL.thunderstormsNight : ICONS_URL.thunderstormsDay};
  if (code === 96) return {t:"T-Storm + Hail", i: ICONS_URL.thunderstormsRain};
  if (code === 99) return {t:"T-Storm + Heavy Hail", i: ICONS_URL.thunderstormsRain};
  return {t:"Weather", i: ICONS_URL.unknown};
}

  /* =========================================================
     MOON (approx)
     ========================================================= */
  function moonInfo(phase){
    var icon, name;
    if (phase < 0.03 || phase > 0.97){ icon=""; name="New Moon"; }
    else if (phase < 0.22)          { icon=""; name="Waxing Crescent"; }
    else if (phase < 0.28)          { icon=""; name="First Quarter"; }
    else if (phase < 0.45)          { icon=""; name="Waxing Gibbous"; }
    else if (phase < 0.55)          { icon=""; name="Full Moon"; }
    else if (phase < 0.72)          { icon=""; name="Waning Gibbous"; }
    else if (phase < 0.78)          { icon=""; name="Last Quarter"; }
    else                            { icon=""; name="Waning Crescent"; }

    var illum = Math.round((1 - Math.cos(2 * Math.PI * phase)) / 2 * 100);
if (illum >= 98) illum = 100;
if (illum <= 2) illum = 0;
    return { icon:icon, name:name, illum:illum };
  }

  function approximateMoonPhase(date){
  var lp = 2551442.8; // lunar period in seconds (29.53059 days)
  var newMoon = new Date(Date.UTC(2026,0,18,19,52,0)); // Jan 18, 2026 new moon
  var phaseSec = ((date.getTime() - newMoon.getTime())/1000) % lp;
  if (phaseSec < 0) phaseSec += lp;
  return phaseSec / lp;
}

  function findNextMoonEvent(now, targetPhase, daysAhead){
    var best = null;
    var bestErr = Infinity;
    var start = now.getTime();
    var end = start + (daysAhead*86400000);
    var prevErr = null;
    for (var t=start; t<=end; t+=3600000){
      var d = new Date(t);
      var ph = approximateMoonPhase(d);
      var err = Math.abs(ph - targetPhase);
      err = Math.min(err, 1-err);
      if (err < bestErr){
        bestErr = err;
        best = d;
      }
      // If error was decreasing and now increasing, we passed a local minimum  stop
      if (prevErr !== null && bestErr < 0.02 && err > prevErr){
        break;
      }
      prevErr = err;
    }
    return best;
  }

  /* =========================================================
     NIGHT CLOUD SUMMARY (used for #night-sky-title)
     ========================================================= */
  function classifyCloud(avg){
    if (avg >= 85) return "Cloudy";
    if (avg >= 60) return "Mostly Cloudy";
    if (avg >= 35) return "Partly Cloudy";
    return "Clear";
  }

  function nightCloudLine(hourly, sunsetLocal, sunriseLocal){
    if (!hourly || !hourly.time || !hourly.cloudcover) return "--";
    var sum = 0, n = 0;

    for (var i=0; i<hourly.time.length; i++){
      var dt = new Date(hourly.time[i]);
      if (!isFinite(dt.getTime())) continue;
      if (dt >= sunsetLocal && dt <= sunriseLocal){
        var cc = hourly.cloudcover[i];
        if (typeof cc === "number" && isFinite(cc)){
          sum += cc; n++;
        }
      }
    }
    if (!n) return "--";
    var avg = Math.round(sum / n);
    var label = classifyCloud(avg);
    return label + "  Cloud Coverage : " + avg + "%";
  }

  /* =========================================================
     SPACE EVENTS (simple built-ins)
     ========================================================= */
  var METEOR_SHOWERS = [
    { name:"Quadrantids", peakStart:{m:1,d:3}, peakEnd:{m:1,d:4}, zhr:120, speed:91700, radiant:"Botes", direction:"NE", radiantRise:"1am", bestView:"Pre-dawn 4-6am", ra:230, dec:49 },
    { name:"Lyrids", peakStart:{m:4,d:22}, peakEnd:{m:4,d:22}, zhr:18, speed:109600, radiant:"Lyra", direction:"E", radiantRise:"9pm", bestView:"After midnight", ra:271, dec:34 },
    { name:"Eta Aquariids", peakStart:{m:5,d:5}, peakEnd:{m:5,d:6}, zhr:50, speed:147600, radiant:"Aquarius", direction:"SE", radiantRise:"2am", bestView:"Pre-dawn 3-5am", ra:338, dec:-1 },
    { name:"Delta Aquariids", peakStart:{m:7,d:29}, peakEnd:{m:7,d:30}, zhr:25, speed:91700, radiant:"Aquarius", direction:"S", radiantRise:"10pm", bestView:"After midnight 1-3am", ra:340, dec:-16 },
    { name:"Perseids", peakStart:{m:8,d:12}, peakEnd:{m:8,d:13}, zhr:100, speed:132000, radiant:"Perseus", direction:"NE", radiantRise:"10pm", bestView:"After midnight 2-4am", ra:48, dec:58 },
    { name:"Draconids", peakStart:{m:10,d:8}, peakEnd:{m:10,d:9}, zhr:10, speed:44700, radiant:"Draco", direction:"NW", radiantRise:"Circumpolar", bestView:"Evening 9pm-midnight", ra:262, dec:54 },
    { name:"Orionids", peakStart:{m:10,d:21}, peakEnd:{m:10,d:21}, zhr:20, speed:147600, radiant:"Orion", direction:"SE", radiantRise:"11pm", bestView:"After midnight 2-4am", ra:95, dec:16 },
    { name:"Leonids", peakStart:{m:11,d:17}, peakEnd:{m:11,d:18}, zhr:15, speed:158800, radiant:"Leo", direction:"E", radiantRise:"midnight", bestView:"Pre-dawn 4-6am", ra:152, dec:22 },
    { name:"Geminids", peakStart:{m:12,d:13}, peakEnd:{m:12,d:14}, zhr:150, speed:78300, radiant:"Gemini", direction:"E", radiantRise:"7pm", bestView:"All night, peak 2am", ra:112, dec:33 },
    { name:"Ursids", peakStart:{m:12,d:22}, peakEnd:{m:12,d:23}, zhr:10, speed:73800, radiant:"Ursa Minor", direction:"N", radiantRise:"Circumpolar", bestView:"After midnight", ra:217, dec:76 }
  ];

  function dateInYear(y, m, d){ return new Date(y, m-1, d, 12, 0, 0, 0); }
  function inDays(from, to){ return Math.round((to - from)/86400000); }

  function nextMeteorPeak(now){
    var y = now.getFullYear();
    var best = null;
    for (var i=0;i<METEOR_SHOWERS.length;i++){
      var s = METEOR_SHOWERS[i];
      var ps = dateInYear(y, s.peakStart.m, s.peakStart.d);
      var pe = dateInYear(y, s.peakEnd.m, s.peakEnd.d);
      if (pe < now){
        ps = dateInYear(y+1, s.peakStart.m, s.peakStart.d);
        pe = dateInYear(y+1, s.peakEnd.m, s.peakEnd.d);
      }
      var days = inDays(now, ps);
      if (!best || days < best.days){
        best = { name:s.name, start:ps, end:pe, days:days };
      }
    }
    return best;
  }

  // Lightweight static list (your original behavior)
  var ECLIPSES = [
    { date:"2026-02-17", type:"Solar (Annular)", note:"Path crosses Antarctica. Not visible from North America.", visible:false },
    { date:"2026-03-03", type:"Lunar (Total)", note:"Visible from Americas, Europe, Africa. Totality 00:58 UTC, duration 58 min.", visible:true },
    { date:"2026-08-12", type:"Solar (Total)", note:"Path crosses Arctic, Greenland, Iceland, Spain. Partial visible from NE USA at sunrise.", visible:"partial" },
    { date:"2026-08-28", type:"Lunar (Partial)", note:"Visible from Pacific, Americas, Europe, Africa. Max eclipse 04:13 UTC, 93% coverage.", visible:true }
  ];

  function nextEclipse(now){
    for (var i=0;i<ECLIPSES.length;i++){
      var d = new Date(ECLIPSES[i].date + "T00:00:00");
      if (isFinite(d.getTime()) && d >= now){
        return { d:d, type:ECLIPSES[i].type, note:ECLIPSES[i].note };
      }
    }
    return null;
  }

  // Planetary conjunctions 2026 (within 1 or notable)
  var CONJUNCTIONS = [
    { date:"2026-01-25", bodies:"Saturn + Mercury", separation:"0.5", direction:"SW", time:"Dusk", note:"Very low on horizon, challenging" },
    { date:"2026-02-13", bodies:"Venus + Saturn", separation:"0.8", direction:"SW", time:"Dusk", note:"Bright pair after sunset" },
    { date:"2026-02-28", bodies:"Venus + Mercury", separation:"1.2", direction:"W", time:"Dusk", note:"Mercury at max elongation" },
    { date:"2026-03-16", bodies:"Mars + Moon", separation:"0.5", direction:"E", time:"Evening", note:"Close pass, Mars bright at magnitude +0.8" },
    { date:"2026-06-04", bodies:"Jupiter + Mercury", separation:"0.9", direction:"E", time:"Dawn", note:"Low in morning twilight" },
    { date:"2026-07-12", bodies:"Venus + Mars", separation:"1.0", direction:"W", time:"Dusk", note:"Striking color contrast" },
    { date:"2026-08-20", bodies:"Moon + Saturn", separation:"0.3", direction:"SE", time:"Night", note:"Very close, possible occultation" },
    { date:"2026-10-26", bodies:"Venus + Saturn", separation:"0.6", direction:"SW", time:"Dusk", note:"Brilliant pair" },
    { date:"2026-11-17", bodies:"Jupiter + Moon", separation:"0.8", direction:"E", time:"Night", note:"Bright pair all night" },
    { date:"2026-12-08", bodies:"Mars + Jupiter", separation:"0.9", direction:"E", time:"Night", note:"Two bright planets, easy target" }
  ];

  function nextConjunction(now){
    for (var i=0;i<CONJUNCTIONS.length;i++){
      var d = new Date(CONJUNCTIONS[i].date + "T00:00:00");
      if (isFinite(d.getTime()) && d >= now){
        var c = CONJUNCTIONS[i];
        return { d:d, bodies:c.bodies, separation:c.separation, direction:c.direction, time:c.time, note:c.note };
      }
    }
    return null;
  }

  // Planetary oppositions 2026 (outer planets closest/brightest)
  var OPPOSITIONS = [
    { date:"2026-02-19", planet:"Mars", magnitude:"-1.2", constellation:"Leo", note:"Closest approach, 63 million mi (0.68 AU), visible all night" },
    { date:"2026-09-21", planet:"Saturn", magnitude:"+0.4", constellation:"Pisces", note:"Rings visible in small telescope, 8.9 AU (827 million mi)" },
    { date:"2026-10-03", planet:"Neptune", magnitude:"+7.8", constellation:"Pisces", note:"Requires binoculars or telescope, 28.9 AU" },
    { date:"2026-11-09", planet:"Uranus", magnitude:"+5.6", constellation:"Taurus", note:"Barely naked-eye from dark sites, 17.2 AU" },
    { date:"2026-12-12", planet:"Jupiter", magnitude:"-2.8", constellation:"Taurus", note:"Brightest object after Moon, 4.0 AU (372 million mi)" }
  ];

  function nextOpposition(now){
    for (var i=0;i<OPPOSITIONS.length;i++){
      var d = new Date(OPPOSITIONS[i].date + "T00:00:00");
      if (isFinite(d.getTime()) && d >= now){
        var o = OPPOSITIONS[i];
        return { d:d, planet:o.planet, magnitude:o.magnitude, constellation:o.constellation, note:o.note };
      }
    }
    return null;
  }

  function bulletHtml(title, time, sub){
    return (
      '<div class="bullet">' +
        '<div class="btop"><span class="bname">'+title+'</span><span class="btime">'+time+'</span></div>' +
        (sub ? ('<div class="bsub">'+sub+'</div>') : '') +
      '</div>'
    );
  }

function daysUntil(from, to){
  if (!from || !to || !isFinite(from.getTime()) || !isFinite(to.getTime())) return 0;
  return Math.max(0, Math.round((to.getTime() - from.getTime()) / 86400000));
}

function dayRangeAround(d, days){
  if (!d || !isFinite(d.getTime())) return days + " days";
  var now = new Date();
  var diff = Math.round((d.getTime() - now.getTime()) / 86400000);
  var start = diff - days;
  var end = diff + days;
  if (start < 0) start = 0;
  return start + "-" + end + " days";
}

  /* =========================================================
     SVG HELPERS (Night sky bar)
     ========================================================= */
  /* Planet colors for TODAY Timeline */
  var TODAY_TL_PLANET_COLORS = {
    Moon:    "rgba(255,255,255,0.90)",
    Mercury: "#9A9A9A",
    Venus:   "#FFE5B4",
    Mars:    "#C44D2A",
    Jupiter: "#E8A954",
    Saturn:  "#F0C75E",
    Uranus:  "#8ECAE6",
    Neptune: "#4AA3DF"
  };

  var SKY_COLORS = {
    Moon:    "rgba(255,255,255,0.95)",
    Mercury: "#9A9A9A",
    Venus:   "#FFE5B4",
    Mars:    "#C44D2A",
    Jupiter: "#E8A954",
    Saturn:  "#F0C75E",
    Uranus:  "#8ECAE6",
    Neptune: "#4AA3DF"
  };

  function svgEl(tag){
    return document.createElementNS("http://www.w3.org/2000/svg", tag);
  }
  function clearSvg(svg){
    while (svg && svg.firstChild) svg.removeChild(svg.firstChild);
  }

  // Kp index color scale (matches SWPC official colors exactly)
  function getKpColor(kp){
    // Round to nearest level for color selection
    var level = Math.round(kp);
    
    switch(level){
      case 0:  return "rgba(0,153,51,0.90)";
      case 1:  return "rgba(51,204,51,0.90)";
      case 2:  return "rgba(102,204,51,0.90)";
      case 3:  return "rgba(153,204,51,0.90)";
      case 4:  return "rgba(204,204,51,0.90)";
      case 5:  return "rgba(255,255,0,0.90)";
      case 6:  return "rgba(255,204,0,0.90)";
      case 7:  return "rgba(255,153,0,0.90)";
      case 8:  return "rgba(255,51,51,0.90)";
      case 9:  return "rgba(204,0,51,0.90)";
      default: return "rgba(102,204,51,0.90)";
    }
  }

  function drawNightSkyBar(svg, legendEl, sunsetLocal, sunriseLocal, windowsByBody, cloudSeries, kpSeries){
    if (!svg) return;

    clearSvg(svg);

    var W = 1000, H = 170;
    var padL = 22, padR = 22, padT = 28, padB = 38;
    var x0 = padL, x1 = W - padR;
    var y0 = padT, y1 = H - padB;

    var total = Math.max(1, sunriseLocal.getTime() - sunsetLocal.getTime());
    function xForTime(dt){
      var t = clamp(dt.getTime() - sunsetLocal.getTime(), 0, total);
      return x0 + (t / total) * (x1 - x0);
    }

    // Aurora/Kp bar (top bar)
    var kpBarH = 12;
    var kpBarY = 4;
    var kpBarX = x0;
    var kpBarW = (x1 - x0);

    function makeKpBarFrame(){
      var r = svgEl("rect");
      r.setAttribute("x", String(kpBarX));
      r.setAttribute("y", String(kpBarY));
      r.setAttribute("width", String(kpBarW));
      r.setAttribute("height", String(kpBarH));
      r.setAttribute("fill", "rgba(43,34,244,0.06)");
      r.setAttribute("fill-opacity", "1");
      r.setAttribute("stroke", "rgba(43,34,244,0.12)");
      r.setAttribute("stroke-opacity", "1");
      r.setAttribute("stroke-width", "1");
      r.setAttribute("rx", "5");
      return r;
    }

    svg.appendChild(makeKpBarFrame());

    // Draw Kp data segments
    if (kpSeries && kpSeries.length){
      kpSeries.sort(function(a,b){ return a.t - b.t; });

      for (var k=0; k<kpSeries.length; k++){
        var a = kpSeries[k];
        var b = (k < kpSeries.length-1) ? kpSeries[k+1] : null;

        var xa = xForTime(a.t);
        var xb = b ? xForTime(b.t) : x1;
        if (xa < x0) xa = x0;
        if (xb > x1) xb = x1;
        if (xb - xa < 1) continue;

        var kp = clamp(a.kp, 0, 9);

        var seg = svgEl("rect");
        seg.setAttribute("x", String(xa));
        seg.setAttribute("y", String(kpBarY));
        seg.setAttribute("width", String(xb - xa));
        seg.setAttribute("height", String(kpBarH));
        seg.setAttribute("fill", getKpColor(kp));
        seg.setAttribute("fill-opacity", "1");
        seg.setAttribute("shape-rendering", "crispEdges");
        svg.appendChild(seg);
      }

      // Re-draw frame on top
      svg.appendChild(makeKpBarFrame());
    }

    // Add Kp label
    var kpLabel = svgEl("text");
    kpLabel.textContent = "Kp";
    kpLabel.setAttribute("x", String(x0 - 6));
    kpLabel.setAttribute("y", String(kpBarY + kpBarH/2 + 3));
    kpLabel.setAttribute("fill", "rgba(43,34,244,0.50)");
    kpLabel.setAttribute("font-size", "9");
    kpLabel.setAttribute("font-weight", "700");
    kpLabel.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
    kpLabel.setAttribute("text-anchor", "end");
    svg.appendChild(kpLabel);

    // cloud bar frame (shifted down)
    var barH = 12;
    var barY = kpBarY + kpBarH + 4;
    var barX = x0;
    var barW = (x1 - x0);

    function makeBarFrame(){
      var r = svgEl("rect");
      r.setAttribute("x", String(barX));
      r.setAttribute("y", String(barY));
      r.setAttribute("width", String(barW));
      r.setAttribute("height", String(barH));
      r.setAttribute("fill", "rgba(43,34,244,0.06)");
      r.setAttribute("fill-opacity", "1");
      r.setAttribute("stroke", "rgba(43,34,244,0.12)");
      r.setAttribute("stroke-opacity", "1");
      r.setAttribute("stroke-width", "1");
      r.setAttribute("rx", "5");
      return r;
    }

    svg.appendChild(makeBarFrame());

    // Add Cloud label
    var cloudLabel = svgEl("text");
    cloudLabel.textContent = "";
    cloudLabel.setAttribute("x", String(x0 - 6));
    cloudLabel.setAttribute("y", String(barY + barH/2 + 4));
    cloudLabel.setAttribute("fill", "rgba(43,34,244,0.50)");
    cloudLabel.setAttribute("font-size", "10");
    cloudLabel.setAttribute("font-weight", "400");
    cloudLabel.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
    cloudLabel.setAttribute("text-anchor", "end");
    svg.appendChild(cloudLabel);

    if (cloudSeries && cloudSeries.length){
      cloudSeries.sort(function(a,b){ return a.t - b.t; });

      function cloudColor(cc){
        if (cc < 10) return "rgba(255,255,255,0.90)";   // White - clear skies
        if (cc < 30) return "rgba(200,200,200,0.70)";   // Light grey
        if (cc < 55) return "rgba(140,140,140,0.65)";   // Grey
        if (cc < 80) return "rgba(90,90,90,0.60)";      // Dark grey
        return "rgba(45,45,45,0.55)";                    // Dark dark grey
      }
    

      for (var c=0; c<cloudSeries.length; c++){
        var a = cloudSeries[c];
        var b = (c < cloudSeries.length-1) ? cloudSeries[c+1] : null;

        var xa = xForTime(a.t);
        var xb = b ? xForTime(b.t) : x1;
        if (xb - xa < 1) xb = xa + 1;

        var cc = clamp(a.cc, 0, 100);

        var seg = svgEl("rect");
        seg.setAttribute("x", String(xa));
        seg.setAttribute("y", String(barY));
        seg.setAttribute("width", String(xb - xa));
        seg.setAttribute("height", String(barH));
        seg.setAttribute("fill", cloudColor(cc));
        seg.setAttribute("shape-rendering", "crispEdges");
        svg.appendChild(seg);
      }

      svg.appendChild(makeBarFrame());
    }

    // Adjust body area to account for bars
    y0 = barY + barH + 8;

    // grid
    var steps = 8;
    for (var i=0;i<=steps;i++){
      var gx = x0 + (i/steps)*(x1-x0);
      var line = svgEl("line");
      line.setAttribute("x1", gx); line.setAttribute("x2", gx);
      line.setAttribute("y1", y0); line.setAttribute("y2", y1);
      line.setAttribute("stroke", "rgba(43,34,244,0.12)");
      line.setAttribute("stroke-opacity", "1");
      line.setAttribute("stroke-width", "1");
      svg.appendChild(line);
    }

    function addLabel(txt, x, anchor){
      var t = svgEl("text");
      t.textContent = txt;
      t.setAttribute("x", String(x));
      t.setAttribute("y", String(H-10));
      t.setAttribute("fill", "rgba(43,34,244,0.50)");
      t.setAttribute("fill-opacity", "1");
      t.setAttribute("font-size", "13");
      t.setAttribute("font-weight", "500");
      t.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
      t.setAttribute("text-anchor", anchor || "middle");
      svg.appendChild(t);
    }

    // Hourly labels
    var startHour = new Date(sunsetLocal);
    startHour.setMinutes(0, 0, 0);
    if (startHour < sunsetLocal) startHour.setHours(startHour.getHours() + 1);
    
    for (var labelTime = startHour.getTime(); labelTime <= sunriseLocal.getTime(); labelTime += 3600000) {
      var labelDate = new Date(labelTime);
      var labelX = xForTime(labelDate);
      if (labelX >= x0 && labelX <= x1) {
        var anchor = "middle";
        if (labelX < x0 + 30) anchor = "start";
        if (labelX > x1 - 30) anchor = "end";
        addLabel(fmt12NoSuffixFromDate(labelDate), labelX, anchor);
      }
    }

    // Bodies in fixed order
    var ORDER = ["Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune"];
    var bodies = [];
    for (var oi=0; oi<ORDER.length; oi++){
      var k = ORDER[oi];
      if (windowsByBody && windowsByBody[k]) bodies.push(k);
    }

    var rows = bodies.length;
    var rowH = (y1 - y0) / Math.max(1, rows);
    var arcAmp = Math.min(46, rowH * 0.85);

    for (var r=0;r<bodies.length;r++){
      var body = bodies[r];
      var w = windowsByBody[body];

      var baseY = y0 + (r + 0.5)*rowH;
      var color = SKY_COLORS[body] || "#d8dee9";

      if (!w || !w.any || !w.first || !w.last){
        // Not visible - thin dashed line
        var off = svgEl("line");
        off.setAttribute("x1", String(x0));
        off.setAttribute("x2", String(x1));
        off.setAttribute("y1", String(baseY));
        off.setAttribute("y2", String(baseY));
        off.setAttribute("stroke", color);
        off.setAttribute("stroke-width", "2");
        off.setAttribute("stroke-dasharray", "4 6");
        off.setAttribute("opacity", "0.15");
        svg.appendChild(off);
        continue;
      }

      // Draw segmented bar based on altitude thresholds
      var segments = w.segments || [];
      
      for (var s = 0; s < segments.length; s++){
        var seg = segments[s];
        var sx1 = xForTime(seg.start);
        var sx2 = xForTime(seg.end);
        if (sx2 - sx1 < 2) sx2 = sx1 + 2;
        
        var segLine = svgEl("line");
        segLine.setAttribute("x1", String(sx1));
        segLine.setAttribute("x2", String(sx2));
        segLine.setAttribute("y1", String(baseY));
        segLine.setAttribute("y2", String(baseY));
        segLine.setAttribute("stroke", color);
        segLine.setAttribute("stroke-width", "6");
        segLine.setAttribute("stroke-linecap", "round");
        
        if (seg.belowTreeline){
          // Below 15 - dashed/textured
          segLine.setAttribute("stroke-dasharray", "3 4");
          segLine.setAttribute("opacity", "0.45");
        } else {
          // Above 15 - solid
          segLine.setAttribute("opacity", "0.85");
        }
        
        svg.appendChild(segLine);
      }
    }

    // NOW marker
    var now = new Date();
    if (now >= sunsetLocal && now <= sunriseLocal){
      var nowX = xForTime(now);
      var nowLine = svgEl("line");
      nowLine.setAttribute("x1", String(nowX));
      nowLine.setAttribute("x2", String(nowX));
      nowLine.setAttribute("y1", String(kpBarY));
      nowLine.setAttribute("y2", String(y1));
      nowLine.setAttribute("stroke", "rgba(43,34,244,0.7)");
      nowLine.setAttribute("stroke-width", "2");
      nowLine.setAttribute("stroke-dasharray", "4 3");
      svg.appendChild(nowLine);
      
      // Small "NOW" label at top
      var nowLabel = svgEl("text");
      nowLabel.textContent = "NOW";
      nowLabel.setAttribute("x", String(nowX));
      nowLabel.setAttribute("y", String(barY - 2));
      nowLabel.setAttribute("fill", "rgba(43,34,244,0.7)");
      nowLabel.setAttribute("font-size", "9");
      nowLabel.setAttribute("font-weight", "700");
      nowLabel.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
      nowLabel.setAttribute("text-anchor", "middle");
      svg.appendChild(nowLabel);
    }

    // Legend
    if (legendEl){
      var legHtml = "";
      
      // Kp scale legend (all 10 levels with SWPC colors)
      legHtml += '<span class="nightsky-item" style="gap:2px;padding:4px 8px;">' +
        '<span style="font-size:.58rem;font-weight:800;color:rgba(43,34,244,.65);margin-right:3px;">Kp</span>' +
        '<span style="font-size:.5rem;font-weight:700;color:rgba(43,34,244,.45);margin-right:2px;">0</span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(0,153,51,0.90);" title="Kp 0"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(51,204,51,0.90);" title="Kp 1"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(102,204,51,0.90);" title="Kp 2"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(153,204,51,0.90);" title="Kp 3"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(204,204,51,0.90);" title="Kp 4"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,255,0,0.90);" title="Kp 5 (G1)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,204,0,0.90);" title="Kp 6 (G2)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,153,0,0.90);" title="Kp 7 (G3)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,51,51,0.90);" title="Kp 8 (G4)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(204,0,51,0.90);" title="Kp 9 (G5)"></span>' +
        '<span style="font-size:.5rem;font-weight:700;color:rgba(43,34,244,.45);margin-left:2px;">9</span>' +
        '</span>';
      
      // Get moon image URL for legend
      var now = new Date();
      var year = now.getFullYear();
      var startOfYear = new Date(year, 0, 1);
      var hourOfYear = Math.floor((now - startOfYear) / (1000 * 60 * 60)) + 1;
      var yearDiff = year - 2024;
      var offsetHours = Math.round(yearDiff * 264);
      var adjustedHour = ((hourOfYear - offsetHours) % 8760);
      if (adjustedHour <= 0) adjustedHour += 8760;
      var frameNum = String(Math.max(1, Math.min(8760, adjustedHour))).padStart(4, '0');
      var moonLegendUrl = "https://svs.gsfc.nasa.gov/vis/a000000/a005000/a005048/frames/730x730_1x1_30p/moon." + frameNum + ".jpg";
      
      for (var li=0; li<bodies.length; li++){
        var b2 = bodies[li];
        var c2 = SKY_COLORS[b2] || "#d8dee9";
        var w2 = windowsByBody[b2];
        var offClass = (!w2 || !w2.any) ? " is-off" : "";
        
        if (b2 === "Moon"){
          // Use moon image instead of dot with clip-path to remove black border
          // Wrap in container to prevent pill from growing
          legHtml +=
            '<span class="nightsky-item'+offClass+'">' +
              '<span style="width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;border-radius:50%;">' +
                '<img src="'+moonLegendUrl+'" style="width:34px;height:34px;border-radius:50%;object-fit:cover;transform:scale(1.19);clip-path:circle(42%);" alt="Moon" />' +
              '</span>' +
              '<span>'+b2+'</span>' +
            '</span>';
        } else {
          legHtml +=
            '<span class="nightsky-item'+offClass+'">' +
              '<span class="nightsky-dot" style="background:'+c2+'"></span>' +
              '<span>'+b2+'</span>' +
            '</span>';
        }
      }
      legendEl.innerHTML = legHtml;
    }
  }

  /* =========================================================
     PLANET / MOON ALT-AZ (minimal)
     ========================================================= */
  function rad(d){ return d*Math.PI/180; }
  function deg(r){ return r*180/Math.PI; }
  function fixAngle(a){ a = a % 360; if (a<0) a+=360; return a; }

  function julianDay(date){
    var y = date.getUTCFullYear();
    var m = date.getUTCMonth()+1;
    var D = date.getUTCDate() + (date.getUTCHours() + date.getUTCMinutes()/60 + date.getUTCSeconds()/3600)/24;
    if (m <= 2){ y -= 1; m += 12; }
    var A = Math.floor(y/100);
    var B = 2 - A + Math.floor(A/4);
    return Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + D + B - 1524.5;
  }
  function daysSinceJ2000(date){ return julianDay(date) - 2451545.0; }

  var ORB = {
    sun:     { w:[282.9404,4.70935E-5], a:[1,0],        e:[0.016709,-1.151E-9], M:[356.0470,0.9856002585] },
    mercury: { N:[48.3313,3.24587E-5], i:[7.0047,5.00E-8], w:[29.1241,1.01444E-5], a:[0.387098,0], e:[0.205635,5.59E-10], M:[168.6562,4.0923344368] },
    venus:   { N:[76.6799,2.46590E-5], i:[3.3946,2.75E-8], w:[54.8910,1.38374E-5], a:[0.723330,0], e:[0.006773,-1.302E-9], M:[48.0052,1.6021302244] },
    mars:    { N:[49.5574,2.11081E-5], i:[1.8497,-1.78E-8], w:[286.5016,2.92961E-5], a:[1.523688,0], e:[0.093405,2.516E-9], M:[18.6021,0.5240207766] },
    jupiter: { N:[100.4542,2.76854E-5], i:[1.3030,-1.557E-7], w:[273.8777,1.64505E-5], a:[5.20256,0],  e:[0.048498,4.469E-9], M:[19.8950,0.0830853001] },
    saturn:  { N:[113.6634,2.38980E-5], i:[2.4886,-1.081E-7], w:[339.3939,2.97661E-5], a:[9.55475,0],  e:[0.055546,-9.499E-9], M:[316.9670,0.0334442282] },
    uranus:  { N:[74.0005,1.3978E-5],  i:[0.7733,1.9E-8],    w:[96.6612,3.0565E-5],   a:[19.18171,-1.55E-8], e:[0.047318,7.45E-9],  M:[142.5905,0.011725806] },
    neptune: { N:[131.7806,3.0173E-5], i:[1.7700,-2.55E-7], w:[272.8461,-6.027E-6],  a:[30.05826,3.313E-8], e:[0.008606,2.15E-9],  M:[260.2471,0.005995147] }
  };

  function kepler(M, e){
    var E = M;
    for (var i=0;i<10;i++){
      var dE = (E - e*Math.sin(E) - M) / (1 - e*Math.cos(E));
      E -= dE;
      if (Math.abs(dE) < 1e-6) break;
    }
    return E;
  }

  function heliocentricEcliptic(body, d){
    var el = ORB[body];
    var N = rad(fixAngle(el.N[0] + el.N[1]*d));
    var i = rad(el.i[0] + el.i[1]*d);
    var w = rad(fixAngle(el.w[0] + el.w[1]*d));
    var a = el.a[0] + el.a[1]*d;
    var e = el.e[0] + el.e[1]*d;
    var M = rad(fixAngle(el.M[0] + el.M[1]*d));
    var E = kepler(M, e);

    var xv = a*(Math.cos(E) - e);
    var yv = a*(Math.sqrt(1 - e*e) * Math.sin(E));
    var v = Math.atan2(yv, xv);
    var r = Math.sqrt(xv*xv + yv*yv);

    var xh = r*(Math.cos(N)*Math.cos(v+w) - Math.sin(N)*Math.sin(v+w)*Math.cos(i));
    var yh = r*(Math.sin(N)*Math.cos(v+w) + Math.cos(N)*Math.sin(v+w)*Math.cos(i));
    var zh = r*(Math.sin(v+w)*Math.sin(i));
    return { x:xh, y:yh, z:zh, r:r };
  }

  function sunEcliptic(d){
    var el = ORB.sun;
    var w = rad(fixAngle(el.w[0] + el.w[1]*d));
    var e = el.e[0] + el.e[1]*d;
    var M = rad(fixAngle(el.M[0] + el.M[1]*d));
    var E = kepler(M, e);
    var xv = (Math.cos(E) - e);
    var yv = (Math.sqrt(1 - e*e) * Math.sin(E));
    var v = Math.atan2(yv, xv);
    var r = Math.sqrt(xv*xv + yv*yv);
    var lon = v + w;
    return { x:r*Math.cos(lon), y:r*Math.sin(lon), z:0, r:r, lon:lon };
  }

  function eclToEqu(x, y, z, d){
    var eps = rad(23.4393 - 3.563E-7*d);
    return {
      x:x,
      y:y*Math.cos(eps) - z*Math.sin(eps),
      z:y*Math.sin(eps) + z*Math.cos(eps)
    };
  }

  function raDecFromEqu(eq){
    var ra = Math.atan2(eq.y, eq.x);
    if (ra < 0) ra += 2*Math.PI;
    var dec = Math.atan2(eq.z, Math.sqrt(eq.x*eq.x + eq.y*eq.y));
    return { ra:ra, dec:dec };
  }

  function localSiderealTime(date, lonDeg){
    var JD = julianDay(date);
    var T = (JD - 2451545.0)/36525.0;
    var GMST = 280.46061837 + 360.98564736629*(JD - 2451545.0) + 0.000387933*T*T - (T*T*T)/38710000.0;
    GMST = fixAngle(GMST);
    return rad(fixAngle(GMST + lonDeg));
  }

  function altAz(ra, dec, date, latDeg, lonDeg){
    var lst = localSiderealTime(date, lonDeg);
    var H = lst - ra;
    while (H < -Math.PI) H += 2*Math.PI;
    while (H >  Math.PI) H -= 2*Math.PI;

    var lat = rad(latDeg);
    var sinAlt = Math.sin(dec)*Math.sin(lat) + Math.cos(dec)*Math.cos(lat)*Math.cos(H);
    var alt = Math.asin(sinAlt);

    var cosAz = (Math.sin(dec) - Math.sin(alt)*Math.sin(lat)) / (Math.cos(alt)*Math.cos(lat));
    cosAz = Math.max(-1, Math.min(1, cosAz));
    var az = Math.acos(cosAz);
    if (Math.sin(H) > 0) az = 2*Math.PI - az;

    return { alt:alt, az:az };
  }

  function planetRaDec(body, date){
    var d = daysSinceJ2000(date);
    var sun = sunEcliptic(d);
    var xe = -sun.x, ye = -sun.y, ze = -sun.z;
    var p = heliocentricEcliptic(body, d);
    var xg = p.x - xe;
    var yg = p.y - ye;
    var zg = p.z - ze;
    return raDecFromEqu(eclToEqu(xg, yg, zg, d));
  }

  function moonRaDec(date){
    var d = daysSinceJ2000(date);
    var N = rad(fixAngle(125.1228 - 0.0529538083 * d));
    var i = rad(5.1454);
    var w = rad(fixAngle(318.0634 + 0.1643573223 * d));
    var a = 60.2666, e = 0.054900;
    var M = rad(fixAngle(115.3654 + 13.0649929509 * d));
    var E = kepler(M, e);

    var xv = a * (Math.cos(E) - e);
    var yv = a * (Math.sqrt(1 - e*e) * Math.sin(E));
    var v  = Math.atan2(yv, xv);
    var r  = Math.sqrt(xv*xv + yv*yv);

    var xh = r * (Math.cos(N)*Math.cos(v+w) - Math.sin(N)*Math.sin(v+w)*Math.cos(i));
    var yh = r * (Math.sin(N)*Math.cos(v+w) + Math.cos(N)*Math.sin(v+w)*Math.cos(i));
    var zh = r * (Math.sin(v+w) * Math.sin(i));

    return raDecFromEqu(eclToEqu(xh, yh, zh, d));
  }

  function computeVisibilityWindows(dateStartLocal, dateEndLocal, bodies, lat, lon){
    var stepMs = 15*60*1000; // 15 min steps for smoother segments
    var minAltDeg = 5;
    var treelineAlt = 15;
    var windows = {};
    
    for (var b=0;b<bodies.length;b++){
      windows[bodies[b]] = { any:false, maxAlt:-999, first:null, last:null, segments:[], altData:[] };
    }

    // First pass: collect altitude data
    for (var t=dateStartLocal.getTime(); t<=dateEndLocal.getTime(); t+=stepMs){
      var dtLocal = new Date(t);
      for (var i=0;i<bodies.length;i++){
        var body = bodies[i];
        var rd = (body === "moon") ? moonRaDec(dtLocal) : planetRaDec(body, dtLocal);
        var aa = altAz(rd.ra, rd.dec, dtLocal, lat, lon);
        var altD = deg(aa.alt);
        var w = windows[body];
        
        if (altD > w.maxAlt) w.maxAlt = altD;
        
        if (altD >= minAltDeg){
          if (!w.any){ w.any = true; w.first = new Date(t); }
          w.last = new Date(t);
          w.altData.push({ time: new Date(t), alt: altD, belowTreeline: altD < treelineAlt });
        }
      }
    }

    // Second pass: build segments from altitude data
    for (var b=0;b<bodies.length;b++){
      var body = bodies[b];
      var w = windows[body];
      
      if (!w.altData.length) continue;
      
      var currentSeg = null;
      
      for (var d=0; d<w.altData.length; d++){
        var pt = w.altData[d];
        
        if (!currentSeg){
          currentSeg = { start: pt.time, end: pt.time, belowTreeline: pt.belowTreeline };
        } else if (pt.belowTreeline === currentSeg.belowTreeline){
          currentSeg.end = pt.time;
        } else {
          w.segments.push(currentSeg);
          currentSeg = { start: pt.time, end: pt.time, belowTreeline: pt.belowTreeline };
        }
      }
      
      if (currentSeg){
        w.segments.push(currentSeg);
      }
    }
    
    return windows;
  }

  /* =========================================================
     SOLAR MATH (NOAA-style approx) for sunbar
     ========================================================= */
  

  function _dayOfYearLocal(d){
    var start = new Date(d.getFullYear(), 0, 1);
    return Math.floor((d - start) / 86400000) + 1;
  }

  function _solarTerms(dLocal){
    var doy = _dayOfYearLocal(dLocal);
    var hr  = dLocal.getHours() + dLocal.getMinutes()/60 + dLocal.getSeconds()/3600;
    var gamma = 2 * Math.PI / 365 * (doy - 1 + (hr - 12) / 24);

    var eqtime =
      229.18 * (
        0.000075 +
        0.001868 * Math.cos(gamma) -
        0.032077 * Math.sin(gamma) -
        0.014615 * Math.cos(2 * gamma) -
        0.040849 * Math.sin(2 * gamma)
      );

    var decl =
      0.006918 -
      0.399912 * Math.cos(gamma) +
      0.070257 * Math.sin(gamma) -
      0.006758 * Math.cos(2 * gamma) +
      0.000907 * Math.sin(2 * gamma) -
      0.002697 * Math.cos(3 * gamma) +
      0.00148  * Math.sin(3 * gamma);

    return { eqtime:eqtime, decl:decl };
  }

  function _minsLocal(d){ return d.getHours()*60 + d.getMinutes() + d.getSeconds()/60; }
  function _tzOffsetMinutes(dLocal){ return dLocal.getTimezoneOffset(); }

  function solarNoonLocal(dayLocal, latDeg, lonDeg){
    var terms = _solarTerms(dayLocal);
    var tzMin = _tzOffsetMinutes(dayLocal);
    var tzHr  = -tzMin / 60;

    var timeOffset = terms.eqtime + 4*lonDeg - 60*tzHr;
    var solarNoonMin = 720 - timeOffset;

    var base = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0,0,0,0);
    return new Date(base.getTime() + solarNoonMin * 60000);
  }

  function solarEventTimeLocal(dayLocal, latDeg, lonDeg, altitudeDeg, isDawn){
    var terms = _solarTerms(dayLocal);
    var decl = terms.decl;

    var lat = rad(latDeg);
    var alt = rad(altitudeDeg);

    var cosH =
      (Math.sin(alt) - Math.sin(lat)*Math.sin(decl)) /
      (Math.cos(lat)*Math.cos(decl));

    if (!isFinite(cosH) || cosH < -1 || cosH > 1) return null;

    cosH = clamp(cosH, -1, 1);
    var H = Math.acos(cosH);

    var Hdeg = deg(H);
    var deltaMin = 4 * Hdeg;

    var noon = solarNoonLocal(dayLocal, latDeg, lonDeg);
    var noonMin = _minsLocal(noon);

    var eventMin = isDawn ? (noonMin - deltaMin) : (noonMin + deltaMin);

    var base = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0,0,0,0);
    return new Date(base.getTime() + eventMin * 60000);
  }

  /* =========================================================
     TODAY TIMELINE RENDER (v4/v5 integrated widget)
     ========================================================= */
  function renderTodayTimeline(hourly, daily, nearestIndex, kpData){
    // DOM refs
    var tlSunrise = document.getElementById("today-tl-sunrise");
    var tlSunset = document.getElementById("today-tl-sunset");
    var tlGoldenAm = document.getElementById("today-tl-golden-am");
    var tlGoldenPm = document.getElementById("today-tl-golden-pm");
    var tlDaylight = document.getElementById("today-tl-daylight");
    var tlDaylightChange = document.getElementById("today-tl-daylight-change");
    var tlSky = document.getElementById("today-tl-sky");
    var tlCloud = document.getElementById("today-tl-cloud-pct");
    var tlMoon = null; // replaced by today-tl-moon-name and today-tl-moon-illum
    var tlKpTrack = document.getElementById("today-tl-kp-track");
    var tlCloudTrack = document.getElementById("today-tl-cloud-track");
    var tlSkyBands = document.getElementById("today-tl-sky-bands");
    var tlPlanetTracks = document.getElementById("today-tl-planet-tracks");
    var tlWeatherRow = document.getElementById("today-tl-weather-row");
    var tlNowMarker = document.getElementById("today-tl-now-marker");
    var tlNowTemp = document.getElementById("today-tl-now-temp");
    var tlNowTime = document.getElementById("today-tl-now-time");

    if (!daily || !daily.sunrise || !daily.sunset) return;

    var srIso = daily.sunrise[0];
    var ssIso = daily.sunset[0];
    var srDate = new Date(srIso);
    var ssDate = new Date(ssIso);

    // Calculate solar events
    var dayLocal = new Date(srDate.getFullYear(), srDate.getMonth(), srDate.getDate(), 12, 0, 0, 0);
    
    var astroDawn = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, true);
    var astroDusk = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, false);
    var blueAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, true);
    var blueAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var bluePmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var bluePmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, false);
    var goldenAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var goldenAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, true);
    var goldenPmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, false);
    var goldenPmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var noon = solarNoonLocal(dayLocal, LOCATION.lat, LOCATION.lon);

    // Update header metadata
    if (tlSunrise) tlSunrise.textContent = fmt12NoSuffix(srIso);
    if (tlSunset) tlSunset.textContent = fmt12NoSuffix(ssIso);
    if (tlGoldenAm) {
      if (goldenAmStart && goldenAmEnd) {
        tlGoldenAm.textContent = fmt12NoSuffixFromDate(goldenAmStart) + "  " + fmt12NoSuffixFromDate(goldenAmEnd);
      } else {
        tlGoldenAm.textContent = "--";
      }
    }
    if (tlGoldenPm) {
      if (goldenPmStart && goldenPmEnd) {
        tlGoldenPm.textContent = fmt12NoSuffixFromDate(goldenPmStart) + "  " + fmt12NoSuffixFromDate(goldenPmEnd);
      } else {
        tlGoldenPm.textContent = "--";
      }
    }

    // Calculate daylight duration
    var daylightMs = ssDate.getTime() - srDate.getTime();
    var daylightHours = Math.floor(daylightMs / (1000 * 60 * 60));
    var daylightMins = Math.floor((daylightMs % (1000 * 60 * 60)) / (1000 * 60));
    if (tlDaylight) tlDaylight.textContent = daylightHours + "h " + daylightMins + "m";

    // Calculate daylight change from yesterday
    if (tlDaylightChange){
      var yesterdayLocal = new Date(dayLocal.getTime() - 86400000);
      var srYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, true);
      var ssYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, false);
      
      if (srYesterday && ssYesterday){
        var yesterdayMs = ssYesterday.getTime() - srYesterday.getTime();
        var diffMs = daylightMs - yesterdayMs;
        var diffSecs = Math.round(diffMs / 1000);
        var diffMins = Math.floor(Math.abs(diffSecs) / 60);
        var remainSecs = Math.abs(diffSecs) % 60;
        
        var sign = diffSecs >= 0 ? "+" : "-";
        var timeStr = diffMins > 0 ? (sign + diffMins + "m " + remainSecs + "s") : (sign + remainSecs + "s");
        
        if (diffSecs > 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(80,180,80,1)";
        } else if (diffSecs < 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(200,100,80,1)";
        } else {
          tlDaylightChange.textContent = "(+0s)";
          tlDaylightChange.style.color = "rgba(43,34,244,.60)";
        }
      }
    }

    // Sky condition and cloud %
    var weatherInfo = getWeatherAnimClass(daily.weathercode[0], false);
    if (tlSky) tlSky.textContent = weatherInfo.label;
    
    // Calculate average cloud cover for today
    if (tlCloud && hourly && hourly.cloudcover){
      var todayStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0, 0);
      var todayEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59, 999);
      var cloudSum = 0, cloudCount = 0;
      for (var ci = 0; ci < hourly.time.length; ci++){
        var dt = new Date(hourly.time[ci]);
        if (dt >= todayStart && dt <= todayEnd && typeof hourly.cloudcover[ci] === "number"){
          cloudSum += hourly.cloudcover[ci];
          cloudCount++;
        }
      }
      var avgCloud = cloudCount > 0 ? Math.round(cloudSum / cloudCount) : 0;
      tlCloud.textContent = avgCloud + "%";
    }

    // Moon info
    var phaseFrac = approximateMoonPhase(new Date());
    var mi = moonInfo(phaseFrac);
    if (document.getElementById("today-tl-moon-name")) document.getElementById("today-tl-moon-name").textContent = mi.name;
    if (document.getElementById("today-tl-moon-illum")) document.getElementById("today-tl-moon-illum").textContent = mi.illum + "%";

    // Timeline range: midnight to midnight
    var timelineStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0, 0).getTime();
    var timelineEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59, 999).getTime();
    var timelineSpan = timelineEnd - timelineStart;

    function pctForTime(d){
      if (!d || !d.getTime) return -1;
      var t = d.getTime();
      if (t < timelineStart || t > timelineEnd) return -1;
      return ((t - timelineStart) / timelineSpan) * 100;
    }

    // Render Kp track
    if (tlKpTrack){
      var kpHtml = "";
      if (kpData && kpData.length > 0){
        // Sort by time
        kpData.sort(function(a, b){ return a.t - b.t; });
        
        for (var ki = 0; ki < kpData.length; ki++){
          var kpPoint = kpData[ki];
          var nextPoint = kpData[ki + 1];
          
          var startPct = pctForTime(kpPoint.t);
          var endPct = nextPoint ? pctForTime(nextPoint.t) : 100;
          
          if (startPct < 0) startPct = 0;
          if (endPct < 0 || endPct > 100) endPct = 100;
          
          var widthPct = endPct - startPct;
          if (widthPct <= 0) continue;
          
          var kpColorVal = getKpColor(kpPoint.kp);
          kpHtml += '<div class="today-tl-bar-segment" style="width:' + widthPct + '%;background:' + kpColorVal + ';"></div>';
        }
      } else {
        // Default quiet Kp
        kpHtml = '<div class="today-tl-bar-segment" style="width:100%;background:#33cc33;"></div>';
      }
      tlKpTrack.innerHTML = kpHtml;
      // Show current Kp value in bar label
      var kpValEl = document.getElementById("today-tl-kp-val");
      if (kpValEl && kpData && kpData.length > 0) {
        var nowT = Date.now();
        var closestKp = kpData[0];
        for (var ck = 0; ck < kpData.length; ck++) {
          if (kpData[ck].t.getTime() <= nowT) closestKp = kpData[ck];
        }
        kpValEl.textContent = closestKp.kp.toFixed(1);
      }
    }

    // Render cloud track
    if (tlCloudTrack && hourly && hourly.cloudcover){
      var cloudHtml = "";
      var hoursPerSegment = 3;
      
      for (var h = 0; h < 24; h += hoursPerSegment){
        var segStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h, 0, 0, 0);
        var segEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h + hoursPerSegment, 0, 0, 0);
        
        // Average cloud cover for this segment
        var segSum = 0, segCount = 0;
        for (var chi = 0; chi < hourly.time.length; chi++){
          var dt = new Date(hourly.time[chi]);
          if (dt >= segStart && dt < segEnd && typeof hourly.cloudcover[chi] === "number"){
            segSum += hourly.cloudcover[chi];
            segCount++;
          }
        }
        
        var segCloud = segCount > 0 ? Math.round(segSum / segCount) : 0;
        var widthPct = (hoursPerSegment / 24) * 100;
        
        // Cloud color: white (clear) to dark grey (overcast)
        var cloudColor;
        if (segCloud < 10) cloudColor = "rgba(255,255,255,0.90)";
        else if (segCloud < 30) cloudColor = "rgba(220,220,220,0.85)";
        else if (segCloud < 50) cloudColor = "rgba(180,180,180,0.80)";
        else if (segCloud < 70) cloudColor = "rgba(140,140,140,0.75)";
        else if (segCloud < 85) cloudColor = "rgba(100,100,100,0.70)";
        else cloudColor = "rgba(70,70,70,0.65)";
        
        cloudHtml += '<div class="today-tl-bar-segment" style="width:' + widthPct + '%;background:' + cloudColor + ';"></div>';
      }
      tlCloudTrack.innerHTML = cloudHtml;
    }

    // Render sky gradient bands  continuous gradient based on sunrise/sunset position
    // Enhanced with: seasonal intensity, humidity tinting, cloud-aware golden hour
    if (tlSkyBands){
      var srPct = pctForTime(srDate);
      var ssPct = pctForTime(ssDate);
      
      if (srPct < 0) srPct = 25;
      if (ssPct < 0) ssPct = 75;
      
      // === SEASONAL SKY INTENSITY ===
      // Calculate solar noon max altitude to scale midday blue
      // Higher sun = deeper blue, lower sun = paler sky
      var terms = _solarTerms(dayLocal);
      var latRad = rad(LOCATION.lat);
      var noonAltRad = Math.asin(Math.sin(latRad) * Math.sin(terms.decl) + Math.cos(latRad) * Math.cos(terms.decl));
      var noonAltDeg = deg(noonAltRad);
      // Scale: 20 (winter)  0.65 intensity, 73 (summer)  1.0 intensity
      var seasonalFactor = clamp((noonAltDeg - 15) / (70 - 15), 0.55, 1.0);
      
      // === HUMIDITY / VISIBILITY TINTING ===
      // Average humidity during daylight hours  high humidity washes out colors
      var avgHumidity = 50;
      if (hourly && hourly.relativehumidity_2m){
        var humSum = 0, humCount = 0;
        for (var hi2 = 0; hi2 < hourly.time.length; hi2++){
          var dt2 = new Date(hourly.time[hi2]);
          if (dt2 >= srDate && dt2 <= ssDate && typeof hourly.relativehumidity_2m[hi2] === "number"){
            humSum += hourly.relativehumidity_2m[hi2];
            humCount++;
          }
        }
        if (humCount > 0) avgHumidity = humSum / humCount;
      }
      // Scale: <40% RH  1.0 (crisp), >85% RH  0.7 (washed out)
      var humidityFactor = clamp(1.0 - (avgHumidity - 40) / (85 - 40) * 0.3, 0.7, 1.0);
      
      // Combined sky clarity factor
      var skyClarity = seasonalFactor * humidityFactor;
      
      // Adjusted midday blue opacity based on sky clarity
      var midBlueOp = (0.38 + 0.24 * skyClarity).toFixed(2);
      var midBlueEdgeOp = (0.32 + 0.20 * skyClarity).toFixed(2);
      var dayEdgeOp = (0.30 + 0.15 * skyClarity).toFixed(2);
      
      // Midday blue RGB shifts slightly paler in winter/humid conditions
      var midBlueR = Math.round(65 + (1 - skyClarity) * 60);
      var midBlueG = Math.round(140 + (1 - skyClarity) * 40);
      var midBlueB = Math.round(230 + (1 - skyClarity) * 15);
      
      // === CLOUD-AWARE GOLDEN HOUR ===
      // Check if cloud cover during golden hours is in the "vivid" range (30-70%)
      var amGoldenCloud = 0, pmGoldenCloud = 0;
      if (hourly && hourly.cloudcover){
        var amCSum = 0, amCCnt = 0, pmCSum = 0, pmCCnt = 0;
        for (var ci2 = 0; ci2 < hourly.time.length; ci2++){
          var cdt = new Date(hourly.time[ci2]);
          if (goldenAmStart && goldenAmEnd && cdt >= goldenAmStart && cdt <= goldenAmEnd){
            amCSum += hourly.cloudcover[ci2]; amCCnt++;
          }
          if (goldenPmStart && goldenPmEnd && cdt >= goldenPmStart && cdt <= goldenPmEnd){
            pmCSum += hourly.cloudcover[ci2]; pmCCnt++;
          }
        }
        if (amCCnt > 0) amGoldenCloud = amCSum / amCCnt;
        if (pmCCnt > 0) pmGoldenCloud = pmCSum / pmCCnt;
      }
      // Vivid factor: peaks at 40-60% cloud cover, drops at 0% or 100%
      function vividFactor(cloud){
        if (cloud >= 30 && cloud <= 70) return 1.0 + (1.0 - Math.abs(cloud - 50) / 20) * 0.15;
        return 1.0;
      }
      var amVivid = vividFactor(amGoldenCloud);
      var pmVivid = vividFactor(pmGoldenCloud);
      
      // Apply vivid boost to golden hour opacity
      var amGoldenPeakOp = clamp(0.62 * amVivid, 0.55, 0.78).toFixed(2);
      var pmGoldenPeakOp = clamp(0.68 * pmVivid, 0.60, 0.82).toFixed(2);
      
      // Spread widths (in percentage points)
      var amGoldenInner = 3.5;
      var amGoldenOuter = 5.5;
      var amBlueW = 2.5;
      var amNautW = 3.0;
      var amAstroW = 4.0;
      var amDayEdgeW = 3.5;
      
      var pmGoldenInner = 4.0;
      var pmGoldenOuter = 6.0;
      var pmBlueW = 3.0;
      var pmNautW = 3.5;
      var pmAstroW = 4.5;
      var pmDayEdgeW = 3.5;
      
      // AM anchor points
      var amAstroStart = Math.max(0, srPct - amGoldenInner - amBlueW - amNautW - amAstroW);
      var amNautStart  = Math.max(0, srPct - amGoldenInner - amBlueW - amNautW);
      var amBlueStart  = Math.max(0, srPct - amGoldenInner - amBlueW);
      var amGoldenStart= Math.max(0, srPct - amGoldenInner);
      var amSunrise    = srPct;
      var amGoldenEnd  = srPct + amGoldenOuter;
      var amDayEdge    = srPct + amGoldenOuter + amDayEdgeW;
      
      // PM anchor points
      var pmDayEdge    = Math.min(100, ssPct - pmGoldenInner - pmDayEdgeW);
      var pmGoldenStart= Math.min(100, ssPct - pmGoldenInner);
      var pmSunset     = ssPct;
      var pmGoldenEnd  = Math.min(100, ssPct + pmGoldenOuter);
      var pmBlueEnd    = Math.min(100, ssPct + pmGoldenOuter + pmBlueW);
      var pmNautEnd    = Math.min(100, ssPct + pmGoldenOuter + pmBlueW + pmNautW);
      var pmAstroEnd   = Math.min(100, ssPct + pmGoldenOuter + pmBlueW + pmNautW + pmAstroW);
      
      var midday = (amDayEdge + pmDayEdge) / 2;
      
      var gradientStr = "linear-gradient(90deg, " +
        "rgba(15,20,45,.92) 0%, " +
        "rgba(15,20,45,.92) " + Math.max(0, amAstroStart - 2).toFixed(1) + "%, " +
        "rgba(20,28,60,.88) " + amAstroStart.toFixed(1) + "%, " +
        "rgba(28,38,80,.80) " + amNautStart.toFixed(1) + "%, " +
        "rgba(42,55,115,.65) " + ((amNautStart + amBlueStart) / 2).toFixed(1) + "%, " +
        "rgba(55,70,140,.55) " + amBlueStart.toFixed(1) + "%, " +
        "rgba(70,95,170,.48) " + amGoldenStart.toFixed(1) + "%, " +
        "rgba(160,120,75,.45) " + (amSunrise - 2.5).toFixed(1) + "%, " +
        "rgba(220,155,70,.52) " + (amSunrise - 1.2).toFixed(1) + "%, " +
        "rgba(255,145,55," + amGoldenPeakOp + ") " + amSunrise.toFixed(1) + "%, " +
        "rgba(255,185,95,.42) " + (amSunrise + 2).toFixed(1) + "%, " +
        "rgba(240,210,160,.35) " + (amSunrise + 3.5).toFixed(1) + "%, " +
        "rgba(210,220,240,.35) " + amGoldenEnd.toFixed(1) + "%, " +
        "rgba(170,205,248," + dayEdgeOp + ") " + amDayEdge.toFixed(1) + "%, " +
        "rgba(" + Math.round(midBlueR + 35) + "," + Math.round(midBlueG + 30) + "," + midBlueB + "," + midBlueEdgeOp + ") " + (midday - 8).toFixed(1) + "%, " +
        "rgba(" + midBlueR + "," + midBlueG + "," + midBlueB + "," + midBlueOp + ") " + (midday - 3).toFixed(1) + "%, " +
        "rgba(" + midBlueR + "," + midBlueG + "," + midBlueB + "," + midBlueOp + ") " + (midday + 3).toFixed(1) + "%, " +
        "rgba(" + Math.round(midBlueR + 35) + "," + Math.round(midBlueG + 30) + "," + midBlueB + "," + midBlueEdgeOp + ") " + (midday + 8).toFixed(1) + "%, " +
        "rgba(170,205,248," + dayEdgeOp + ") " + pmDayEdge.toFixed(1) + "%, " +
        "rgba(210,220,240,.35) " + pmGoldenStart.toFixed(1) + "%, " +
        "rgba(240,200,140,.38) " + (pmSunset - 3.5).toFixed(1) + "%, " +
        "rgba(255,180,80,.45) " + (pmSunset - 2).toFixed(1) + "%, " +
        "rgba(255,150,50,.58) " + (pmSunset - 0.8).toFixed(1) + "%, " +
        "rgba(240,105,30," + pmGoldenPeakOp + ") " + pmSunset.toFixed(1) + "%, " +
        "rgba(220,85,25,.64) " + (pmSunset + 1.5).toFixed(1) + "%, " +
        "rgba(190,65,30,.58) " + (pmSunset + 3).toFixed(1) + "%, " +
        "rgba(140,50,40,.52) " + (pmSunset + 4.5).toFixed(1) + "%, " +
        "rgba(100,45,50,.48) " + pmGoldenEnd.toFixed(1) + "%, " +
        "rgba(60,45,80,.55) " + ((pmGoldenEnd + pmBlueEnd) / 2).toFixed(1) + "%, " +
        "rgba(50,50,100,.60) " + pmBlueEnd.toFixed(1) + "%, " +
        "rgba(38,42,85,.72) " + pmNautEnd.toFixed(1) + "%, " +
        "rgba(25,32,65,.82) " + pmAstroEnd.toFixed(1) + "%, " +
        "rgba(15,20,45,.92) " + Math.min(100, pmAstroEnd + 3).toFixed(1) + "%, " +
        "rgba(15,20,45,.92) 100%" +
      ")";
      
      tlSkyBands.innerHTML = '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:' + gradientStr + ';"></div>';
    }

    // Render planet tracks
    if (tlPlanetTracks){
      // Compute visibility windows for today
      var bodies = ["moon", "mercury", "venus", "mars", "jupiter", "saturn", "uranus", "neptune"];
      var todayStartDate = new Date(timelineStart);
      var todayEndDate = new Date(timelineEnd);
      
      var windows = computeVisibilityWindows(todayStartDate, todayEndDate, bodies, LOCATION.lat, LOCATION.lon);
      
      var planetOrder = ["Moon", "Mercury", "Venus", "Mars", "Jupiter", "Saturn", "Uranus", "Neptune"];
      var nameMap = { moon: "Moon", mercury: "Mercury", venus: "Venus", mars: "Mars", jupiter: "Jupiter", saturn: "Saturn", uranus: "Uranus", neptune: "Neptune" };
      
      var planetsHtml = "";
      
      // Calculate average azimuth for each body to determine direction
      function getDirectionAbbrev(azDeg){
        if (azDeg >= 337.5 || azDeg < 22.5) return "NORTH";
        if (azDeg >= 22.5 && azDeg < 67.5) return "NORTHEAST";
        if (azDeg >= 67.5 && azDeg < 112.5) return "EAST";
        if (azDeg >= 112.5 && azDeg < 157.5) return "SOUTHEAST";
        if (azDeg >= 157.5 && azDeg < 202.5) return "SOUTH";
        if (azDeg >= 202.5 && azDeg < 247.5) return "SOUTHWEST";
        if (azDeg >= 247.5 && azDeg < 292.5) return "WEST";
        if (azDeg >= 292.5 && azDeg < 337.5) return "NORTHWEST";
        return "";
      }
      
      function getPlanetDirection(body, windows){
        // Calculate azimuth for RIGHT NOW (real-time position)
        var now = new Date();
        var rd = (body === "moon") ? moonRaDec(now) : planetRaDec(body, now);
        var aa = altAz(rd.ra, rd.dec, now, LOCATION.lat, LOCATION.lon);
        var altD = deg(aa.alt);
        var azDeg = deg(aa.az);
        
        // If below horizon, show "Below" instead of direction
        if (altD < 0) return "Below";
        
        return getDirectionAbbrev(azDeg);
      }
      
      // Store directions for legend
      window.planetDirections = {};
      
      for (var pi = 0; pi < bodies.length; pi++){
        var body = bodies[pi];
        var w = windows[body];
        var displayName = nameMap[body];
        var color = TODAY_TL_PLANET_COLORS[displayName] || "rgba(200,200,200,0.8)";
        var direction = getPlanetDirection(body, windows);
        
        // Store for legend
        window.planetDirections[displayName] = direction;
        
        planetsHtml += '<div class="today-tl-planet-row">';
        planetsHtml += '<div class="today-tl-planet-indicator" style="background:' + color + ';box-shadow:0 0 6px ' + color + ';"></div>';
        planetsHtml += '<div class="today-tl-planet-bar">';
        
        if (w && w.segments && w.segments.length > 0){
          for (var si = 0; si < w.segments.length; si++){
            var seg = w.segments[si];
            var startPct = pctForTime(seg.start);
            var endPct = pctForTime(seg.end);
            
            if (startPct < 0) startPct = 0;
            if (endPct < 0) endPct = 0;
            if (endPct > 100) endPct = 100;
            
            var widthPct = endPct - startPct;
            if (widthPct < 0.5) widthPct = 0.5;
            
            var visClass = seg.belowTreeline ? "dashed" : "solid";
            planetsHtml += '<div class="today-tl-planet-vis ' + visClass + '" style="left:' + startPct + '%;width:' + widthPct + '%;background:' + color + ';color:' + color + ';"></div>';
          }
        }
        
        planetsHtml += '</div></div>';
      }
      
      tlPlanetTracks.innerHTML = planetsHtml;
    }

    // Render weather row with animated icons (every 3 hours)
    if (tlWeatherRow && hourly && hourly.time){
      var weatherHtml = "";
      
      var isMobile = window.innerWidth <= 768;
      var hStep = isMobile ? 3 : 1;
      for (var h = 0; h < 24; h += hStep){
        var targetHour = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h, 0, 0, 0);
        
        // Find matching index in hourly data
        var matchIdx = -1;
        for (var hi = 0; hi < hourly.time.length; hi++){
          var dt = new Date(hourly.time[hi]);
          if (dt.getFullYear() === targetHour.getFullYear() &&
              dt.getMonth() === targetHour.getMonth() &&
              dt.getDate() === targetHour.getDate() &&
              dt.getHours() === targetHour.getHours()){
            matchIdx = hi;
            break;
          }
        }
        
        var timeLabel = h === 0 ? "12AM" : (h < 12 ? h + "AM" : (h === 12 ? "12PM" : (h - 12) + "PM"));
        var temp = "--";
        var precip = 0;
        var weatherCode = 0;
        
        // Determine sky state for this hour using actual sun altitude
        var isNightHour = (targetHour < srDate || targetHour > ssDate);
        var isDayHour = !isNightHour;
        
        // Calculate sun altitude at this hour for continuous classification
        var hourTerms = _solarTerms(targetHour);
        var hourLatRad = rad(LOCATION.lat);
        var hourNoon = solarNoonLocal(dayLocal, LOCATION.lat, LOCATION.lon);
        var hourAngle = (targetHour.getTime() - hourNoon.getTime()) / 3600000 * 15; // degrees
        var hourAngleRad = rad(hourAngle);
        var sinAlt = Math.sin(hourLatRad) * Math.sin(hourTerms.decl) + Math.cos(hourLatRad) * Math.cos(hourTerms.decl) * Math.cos(hourAngleRad);
        var sunAltDeg = deg(Math.asin(clamp(sinAlt, -1, 1)));
        
        // Classify sky state based on sun altitude (continuous)
        var skyState = "night";
        if (sunAltDeg > 6) {
          skyState = "day";
        } else if (sunAltDeg > 1) {
          skyState = "golden";
        } else if (sunAltDeg > -2) {
          skyState = "golden-peak";
        } else if (sunAltDeg > -4) {
          skyState = "golden";
        } else if (sunAltDeg > -6) {
          skyState = "blue-hour";
        } else if (sunAltDeg > -12) {
          skyState = "twilight";
        }
        
        if (matchIdx >= 0){
          temp = Math.round(hourly.temperature_2m[matchIdx]) + "";
          precip = hourly.precipitation_probability ? (hourly.precipitation_probability[matchIdx] || 0) : 0;
          weatherCode = hourly.weathercode ? (hourly.weathercode[matchIdx] || 0) : 0;
        }
        
        var weatherInfo = getWeatherAnimClass(weatherCode, isNightHour);
        var precipClass = precip >= 50 ? "active" : "";
        
        // Build class list based on sky state
        var hourClass = "today-tl-weather-hour";
        if (skyState === "golden-peak") hourClass += " golden-peak-hour";
        else if (skyState === "golden") hourClass += " golden-hour";
        else if (skyState === "blue-hour") hourClass += " blue-hour-col";
        else if (skyState === "twilight") hourClass += " twilight-hour";
        else if (skyState === "day") hourClass += " day-hour";
        // night hours get no extra class (default white-on-dark)
        
        var feelsLike = (matchIdx >= 0 && hourly.apparent_temperature) ? Math.round(hourly.apparent_temperature[matchIdx]) + "" : "";
        var windSpd = (matchIdx >= 0 && hourly.windspeed_10m) ? Math.round(hourly.windspeed_10m[matchIdx]) : "";
        var gustSpd = (matchIdx >= 0 && hourly.windgusts_10m) ? Math.round(hourly.windgusts_10m[matchIdx]) : "";
        var windStr = windSpd !== "" ? "" + windSpd + (gustSpd && gustSpd > windSpd ? " " + gustSpd : "") : "";
        var windDeg = (matchIdx >= 0 && hourly.wind_direction_10m) ? (hourly.wind_direction_10m[matchIdx] || 0) : 0;
        var wDirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
        var windDirStr = windSpd !== "" ? wDirs[Math.round(windDeg / 22.5) % 16] : "";
        
        // Inline color styles for feels-like, wind, wind-dir based on sky state
        var feelsColor = "rgba(255,255,255,.45)";
        var windColor = "rgba(255,255,255,.35)";
        var windDirColor = "rgba(255,255,255,.3)";
        if (skyState === "golden-peak"){
          feelsColor = "rgba(255,160,50,.55)";
          windColor = "rgba(255,160,50,.45)";
          windDirColor = "rgba(255,160,50,.4)";
        } else if (skyState === "golden"){
          feelsColor = "rgba(255,180,80,.5)";
          windColor = "rgba(255,180,80,.4)";
          windDirColor = "rgba(255,180,80,.35)";
        } else if (skyState === "blue-hour"){
          feelsColor = "rgba(150,180,240,.5)";
          windColor = "rgba(150,180,240,.4)";
          windDirColor = "rgba(150,180,240,.35)";
        } else if (skyState === "twilight"){
          feelsColor = "rgba(180,195,240,.45)";
          windColor = "rgba(180,195,240,.35)";
          windDirColor = "rgba(180,195,240,.3)";
        } else if (skyState === "day"){
          feelsColor = "rgba(255,255,255,.55)";
          windColor = "rgba(255,255,255,.45)";
          windDirColor = "rgba(255,255,255,.4)";
        }
        
        weatherHtml += '<div class="' + hourClass + '">' +
          '<span class="today-tl-weather-time">' + timeLabel + '</span>' +
          '<span class="today-tl-weather-icon ' + weatherInfo.animClass + '">' + weatherInfo.emoji + '</span>' +
          '<span class="today-tl-weather-temp">' + temp + '</span>' +
          '<span style="font-size:1rem;font-weight:400;color:' + feelsColor + ';">' + feelsLike + '</span>' +
          '<span style="font-size:.55rem;font-weight:600;color:' + windColor + ';display:block;text-align:center;width:100%;text-transform:uppercase;letter-spacing:.3px;">' + windStr + '</span>' +
          '<span style="font-size:.5rem;font-weight:600;color:' + windDirColor + ';display:block;text-align:center;width:100%;letter-spacing:.3px;">' + windDirStr + '</span>' +
          '<span class="today-tl-weather-precip ' + precipClass + '">' + precip + '%</span>' +
        '</div>';
      }
      
      tlWeatherRow.innerHTML = weatherHtml;
    }

    // Position NOW marker
    if (tlNowMarker){
      var now = new Date();
      var nowPct = pctForTime(now);
      
      if (nowPct >= 0 && nowPct <= 100){
        tlNowMarker.style.left = nowPct + "%";
        tlNowMarker.style.display = "block";
        
        // Update NOW temp and time
        if (tlNowTemp && hourly && hourly.temperature_2m){
          var nowTemp = Math.round(hourly.temperature_2m[nearestIndex]);
          tlNowTemp.textContent = nowTemp + "";
        }
        if (tlNowTime){
          tlNowTime.textContent = fmt12NoSuffixFromDate(now);
        }
      } else {
        tlNowMarker.style.display = "none";
      }
    }

    // Update planet directions in legend
    if (window.planetDirections){
      var dirIds = ['moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune'];
      var dirNames = ['Moon', 'Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn', 'Uranus', 'Neptune'];
      for (var di = 0; di < dirIds.length; di++){
        var dirEl = document.getElementById('legend-dir-' + dirIds[di]);
        if (dirEl && window.planetDirections[dirNames[di]]){
          dirEl.textContent = window.planetDirections[dirNames[di]];
        }
      }
    }

    // Update moon image in legend (same logic as large moon)
    var legendMoonEl = document.getElementById("today-tl-legend-moon");
    if (legendMoonEl){
      var legendPhaseFrac = approximateMoonPhase(new Date());
      var legendMi = moonInfo(legendPhaseFrac);
      var legendNewMoonFrame = 946;
      var legendLunarCycleFrames = 709;
      var legendFrameOffset = Math.round(legendPhaseFrac * legendLunarCycleFrames);
      var legendFrame = legendNewMoonFrame + legendFrameOffset;
      if (legendFrame > 8760) legendFrame -= 8760;
      var legendFrameStr = String(legendFrame).padStart(4, '0');
      var legendMoonUrl = "https://svs.gsfc.nasa.gov/vis/a000000/a005100/a005187/frames/730x730_1x1_30p/moon." + legendFrameStr + ".jpg";
      
      legendMoonEl.style.background = "url('" + legendMoonUrl + "') center/cover";
      legendMoonEl.style.boxShadow = "inset -1px -1px 3px rgba(0,0,0,.15)";
    }
  }

  /* =========================================================
     TIMELINE RENDER (Combined sun events + hourly weather)
     ========================================================= */
  function renderTimeline(hourly, daily, nearestIndex){
    var tlSunrise = document.getElementById("tl-sunrise");
    var tlSunset = document.getElementById("tl-sunset");
    var tlGolden = document.getElementById("tl-golden");
    var tlBands = document.getElementById("tl-bands");
    var tlHours = document.getElementById("tl-hours");
    var tlEvents = document.getElementById("tl-events");
    var tlNow = document.getElementById("tl-now");
    var tlNowTemp = document.getElementById("tl-now-temp");
    var tlEventLabels = document.getElementById("tl-event-labels");

    if (!tlHours || !daily || !daily.sunrise || !daily.sunset) return;

    var srIso = daily.sunrise[0];
    var ssIso = daily.sunset[0];
    var srDate = new Date(srIso);
    var ssDate = new Date(ssIso);

    // Detect mobile
    var isMobile = window.innerWidth <= 768;

    // Calculate solar events (must be before golden hour calculations)
    var dayLocal = new Date(srDate.getFullYear(), srDate.getMonth(), srDate.getDate(), 12, 0, 0, 0);

    // Update header
    if (tlSunrise) tlSunrise.textContent = fmt12NoSuffix(srIso);
    if (tlSunset) tlSunset.textContent = fmt12NoSuffix(ssIso);
    
    var tlGoldenAm = document.getElementById("tl-golden-am");
    var tlGoldenPm = document.getElementById("tl-golden-pm");
    
    var goldenAmStartTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var goldenAmEndTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, true);
    var goldenPmStartTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, false);
    var goldenPmEndTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    
    if (tlGoldenAm) {
      if (goldenAmStartTime && goldenAmEndTime) {
        tlGoldenAm.textContent = fmt12NoSuffixFromDate(goldenAmStartTime) + "  " + fmt12NoSuffixFromDate(goldenAmEndTime);
      } else {
        tlGoldenAm.textContent = "--";
      }
    }
    if (tlGoldenPm) {
      if (goldenPmStartTime && goldenPmEndTime) {
        tlGoldenPm.textContent = fmt12NoSuffixFromDate(goldenPmStartTime) + "  " + fmt12NoSuffixFromDate(goldenPmEndTime);
      } else {
        tlGoldenPm.textContent = "--";
      }
    }

    // Calculate daylight length
    var tlDaylight = document.getElementById("tl-daylight");
    var tlDaylightChange = document.getElementById("tl-daylight-change");
    
    var daylightMs = ssDate.getTime() - srDate.getTime();
    var daylightHours = Math.floor(daylightMs / (1000 * 60 * 60));
    var daylightMins = Math.floor((daylightMs % (1000 * 60 * 60)) / (1000 * 60));
    
    if (tlDaylight) tlDaylight.textContent = daylightHours + "h " + daylightMins + "m";
    
    // Calculate yesterday's daylight for comparison
    if (tlDaylightChange){
      var yesterdayLocal = new Date(dayLocal.getTime() - 86400000);
      var srYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, true);
      var ssYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, false);
      
      if (srYesterday && ssYesterday){
        var yesterdayMs = ssYesterday.getTime() - srYesterday.getTime();
        var diffMs = daylightMs - yesterdayMs;
        var diffSecs = Math.round(diffMs / 1000);
        var diffMins = Math.floor(Math.abs(diffSecs) / 60);
        var remainSecs = Math.abs(diffSecs) % 60;
        
        var sign = diffSecs >= 0 ? "+" : "-";
        var timeStr;
        if (diffMins > 0){
          timeStr = sign + diffMins + "m " + remainSecs + "s";
        } else {
          timeStr = sign + remainSecs + "s";
        }
        
        if (diffSecs > 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(80,180,80,1)";
        } else if (diffSecs < 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(200,100,80,1)";
        } else {
          tlDaylightChange.textContent = "(+0s)";
          tlDaylightChange.style.color = "rgba(43,34,244,.60)";
        }
      }
    }
    
    var astroDawn = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, true);
    var astroDusk = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, false);
    var blueAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, true);
    var blueAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var bluePmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var bluePmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, false);
    var goldenAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var goldenAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, true);
    var goldenPmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, false);
    var goldenPmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var noon = solarNoonLocal(dayLocal, LOCATION.lat, LOCATION.lon);

    // Timeline range: full 24 hours on desktop, golden hour to golden hour on mobile
    var todayStart, todayEnd;
    
    // Always use full 24 hours  hourStep handles density
    todayStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0, 0);
    todayEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59, 999);
    
    var timelineStart = todayStart.getTime();
    var timelineEnd = todayEnd.getTime();
    var timelineSpan = timelineEnd - timelineStart;

    function pctForTime(d){
      if (!d || !d.getTime) return -1;
      var t = d.getTime();
      if (t < timelineStart || t > timelineEnd) return -1;
      return ((t - timelineStart) / timelineSpan) * 100;
    }

    // Render bands  continuous gradient matching today timeline
    if (tlBands){
      var srPctTl = pctForTime(srDate);
      var ssPctTl = pctForTime(ssDate);
      if (srPctTl < 0) srPctTl = 25;
      if (ssPctTl < 0) ssPctTl = 75;
      
      // Seasonal + humidity factors (same logic as today timeline)
      var termsTl = _solarTerms(dayLocal);
      var latRadTl = rad(LOCATION.lat);
      var noonAltRadTl = Math.asin(Math.sin(latRadTl) * Math.sin(termsTl.decl) + Math.cos(latRadTl) * Math.cos(termsTl.decl));
      var noonAltDegTl = deg(noonAltRadTl);
      var seasonalTl = clamp((noonAltDegTl - 15) / (70 - 15), 0.55, 1.0);
      
      var avgHumTl = 50;
      if (hourly && hourly.relativehumidity_2m){
        var hS = 0, hC = 0;
        for (var hhi = 0; hhi < hourly.time.length; hhi++){
          var hdt = new Date(hourly.time[hhi]);
          if (hdt >= srDate && hdt <= ssDate && typeof hourly.relativehumidity_2m[hhi] === "number"){
            hS += hourly.relativehumidity_2m[hhi]; hC++;
          }
        }
        if (hC > 0) avgHumTl = hS / hC;
      }
      var humTl = clamp(1.0 - (avgHumTl - 40) / (85 - 40) * 0.3, 0.7, 1.0);
      var skyClarityTl = seasonalTl * humTl;
      
      var mbOp = (0.38 + 0.24 * skyClarityTl).toFixed(2);
      var mbEOp = (0.32 + 0.20 * skyClarityTl).toFixed(2);
      var deOp = (0.30 + 0.15 * skyClarityTl).toFixed(2);
      var mbR = Math.round(65 + (1 - skyClarityTl) * 60);
      var mbG = Math.round(140 + (1 - skyClarityTl) * 40);
      var mbB = Math.round(230 + (1 - skyClarityTl) * 15);
      
      // Spreads
      var s = srPctTl, e = ssPctTl;
      var aAS = Math.max(0, s - 13), aNS = Math.max(0, s - 9), aBS = Math.max(0, s - 6), aGS = Math.max(0, s - 3.5);
      var aGE = s + 5.5, aDE = s + 9;
      var pDE = Math.min(100, e - 7.5), pGS = Math.min(100, e - 4);
      var pGE = Math.min(100, e + 6), pBE = Math.min(100, e + 9), pNE = Math.min(100, e + 12.5), pAE = Math.min(100, e + 17);
      var mid = (aDE + pDE) / 2;
      
      var gStr = "linear-gradient(90deg, " +
        "rgba(15,20,45,.92) 0%, rgba(15,20,45,.92) " + Math.max(0, aAS - 2).toFixed(1) + "%, " +
        "rgba(20,28,60,.88) " + aAS.toFixed(1) + "%, rgba(28,38,80,.80) " + aNS.toFixed(1) + "%, " +
        "rgba(42,55,115,.65) " + ((aNS + aBS) / 2).toFixed(1) + "%, rgba(55,70,140,.55) " + aBS.toFixed(1) + "%, " +
        "rgba(70,95,170,.48) " + aGS.toFixed(1) + "%, " +
        "rgba(160,120,75,.45) " + (s - 2.5).toFixed(1) + "%, rgba(220,155,70,.52) " + (s - 1.2).toFixed(1) + "%, " +
        "rgba(255,145,55,.62) " + s.toFixed(1) + "%, " +
        "rgba(255,185,95,.42) " + (s + 2).toFixed(1) + "%, rgba(240,210,160,.35) " + (s + 3.5).toFixed(1) + "%, " +
        "rgba(210,220,240,.35) " + aGE.toFixed(1) + "%, " +
        "rgba(170,205,248," + deOp + ") " + aDE.toFixed(1) + "%, " +
        "rgba(" + (mbR + 35) + "," + (mbG + 30) + "," + mbB + "," + mbEOp + ") " + (mid - 8).toFixed(1) + "%, " +
        "rgba(" + mbR + "," + mbG + "," + mbB + "," + mbOp + ") " + (mid - 3).toFixed(1) + "%, " +
        "rgba(" + mbR + "," + mbG + "," + mbB + "," + mbOp + ") " + (mid + 3).toFixed(1) + "%, " +
        "rgba(" + (mbR + 35) + "," + (mbG + 30) + "," + mbB + "," + mbEOp + ") " + (mid + 8).toFixed(1) + "%, " +
        "rgba(170,205,248," + deOp + ") " + pDE.toFixed(1) + "%, " +
        "rgba(210,220,240,.35) " + pGS.toFixed(1) + "%, " +
        "rgba(240,200,140,.38) " + (e - 3.5).toFixed(1) + "%, rgba(255,180,80,.45) " + (e - 2).toFixed(1) + "%, " +
        "rgba(255,150,50,.58) " + (e - 0.8).toFixed(1) + "%, rgba(240,105,30,.68) " + e.toFixed(1) + "%, " +
        "rgba(220,85,25,.64) " + (e + 1.5).toFixed(1) + "%, rgba(190,65,30,.58) " + (e + 3).toFixed(1) + "%, " +
        "rgba(140,50,40,.52) " + (e + 4.5).toFixed(1) + "%, rgba(100,45,50,.48) " + pGE.toFixed(1) + "%, " +
        "rgba(60,45,80,.55) " + ((pGE + pBE) / 2).toFixed(1) + "%, rgba(50,50,100,.60) " + pBE.toFixed(1) + "%, " +
        "rgba(38,42,85,.72) " + pNE.toFixed(1) + "%, rgba(25,32,65,.82) " + pAE.toFixed(1) + "%, " +
        "rgba(15,20,45,.92) " + Math.min(100, pAE + 3).toFixed(1) + "%, rgba(15,20,45,.92) 100%)";
      
      tlBands.innerHTML = '<div style="position:absolute;top:0;left:0;right:0;bottom:0;background:' + gStr + ';"></div>';
    }

    // Render hourly weather
    if (tlHours && hourly && hourly.time){
      var hoursHtml = "";
      
      // Find hours within timeline range
      var startHour = todayStart.getHours();
      var endHour = todayEnd.getHours();
      
      // Show every 3 hours for cleaner display
      var hourStep = 3;
      console.log('[TL] hourStep=' + hourStep + ', startHour=' + startHour + ', endHour=' + endHour + ', items=' + Math.floor((endHour - startHour) / hourStep + 1));
      
      for (var h = startHour; h <= endHour; h += hourStep){
        var targetHour = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h, 0, 0, 0);
        
        // Find matching index in hourly data
        var matchIdx = -1;
        for (var i = 0; i < hourly.time.length; i++){
          var dt = new Date(hourly.time[i]);
          if (dt.getFullYear() === targetHour.getFullYear() &&
              dt.getMonth() === targetHour.getMonth() &&
              dt.getDate() === targetHour.getDate() &&
              dt.getHours() === targetHour.getHours()){
            matchIdx = i;
            break;
          }
        }
        
        var timeLabel = h === 0 ? "12AM" : (h < 12 ? h + "AM" : (h === 12 ? "12PM" : (h - 12) + "PM"));
        var temp = "--";
        var precip = 0;
        var icon = "";
        
        // Determine if this hour is during night/twilight
        var isNight = (targetHour < srDate || targetHour > ssDate);
        var isDeepNight = (astroDawn && targetHour < astroDawn) || (astroDusk && targetHour > astroDusk);
        var isTwilight = isNight && !isDeepNight;
        
        if (matchIdx >= 0){
          temp = Math.round(hourly.temperature_2m[matchIdx]) + "";
          precip = hourly.precipitation_probability[matchIdx] || 0;
          
          // Determine icon based on conditions
          var cc = hourly.cloudcover ? hourly.cloudcover[matchIdx] : 0;
          
          if (precip >= 60){
            icon = METEO_BASE + "rain.svg";
          } else if (precip >= 30){
            icon = METEO_BASE + "drizzle.svg";
          } else if (cc >= 70){
            icon = METEO_BASE + "overcast.svg";
          } else if (cc >= 30){
            icon = isNight ? METEO_BASE + "partly-cloudy-night.svg" : METEO_BASE + "partly-cloudy-day.svg";
          } else if (isDeepNight){
            icon = METEO_BASE + "clear-night.svg";
          } else if (isTwilight){
            icon = METEO_BASE + "clear-night.svg";
          } else {
            icon = METEO_BASE + "clear-day.svg";
          }
        }
        
        var precipClass = "low";
        if (precip >= 60) precipClass = "high";
        else if (precip >= 30) precipClass = "med";
        
        // Add night-hour class for dark background styling
        var hourClass = "tl-hour";
        if (isDeepNight || isTwilight) hourClass += " night-hour";
        
        hoursHtml += '<div class="' + hourClass + '">' +
          '<span class="tl-hour-time">' + timeLabel + '</span>' +
          '<div style="width:36px;height:36px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><img class="tl-hour-icon" src="' + icon + '" alt="" /></div>' +
          '<span class="tl-hour-temp">' + temp + '</span>' +
          (precip > 0 ? '<span class="tl-hour-precip ' + precipClass + '">' + precip + '%</span>' : '') +
        '</div>';;
      }
      
      tlHours.innerHTML = hoursHtml;
    }

    // Render sun event ticks
    if (tlEvents){
      var eventsHtml = "";
      
      var events = [
        { time: astroDawn, cls: "astro" },
        { time: blueAmStart, cls: "blue" },
        { time: srDate, cls: "sunrise" },
        { time: goldenAmEnd, cls: "golden" },
        { time: noon, cls: "noon" },
        { time: goldenPmStart, cls: "golden" },
        { time: ssDate, cls: "sunset" },
        { time: bluePmEnd, cls: "blue" },
        { time: astroDusk, cls: "astro" }
      ];
      
      for (var e = 0; e < events.length; e++){
        var ev = events[e];
        var p = pctForTime(ev.time);
        if (p >= 0 && p <= 100){
          eventsHtml += '<div class="tl-event-tick ' + ev.cls + '" style="left:' + p + '%"></div>';
        }
      }
      
      tlEvents.innerHTML = eventsHtml;
    }

    // Render event labels with hill pattern
    if (tlEventLabels){
      var labelsHtml = "";
      
      // Labels with assigned levels (1=lowest, 5=highest like a hill)
      var labels = [
        { time: astroDawn, text: "AST DAWN", cls: "astro", level: 1 },
        { time: blueAmStart, text: "BLUE", cls: "blue", level: 2 },
        { time: srDate, text: "SUNRISE", cls: "sunrise", level: 3 },
        { time: goldenAmEnd, text: "GOLDEN", cls: "golden", level: 4 },
        { time: noon, text: "NOON", cls: "noon", level: 5 },
        { time: goldenPmStart, text: "GOLDEN", cls: "golden", level: 4 },
        { time: ssDate, text: "SUNSET", cls: "sunset", level: 3 },
        { time: bluePmEnd, text: "BLUE", cls: "blue", level: 2 },
        { time: astroDusk, text: "AST DARK", cls: "astro", level: 1 }
      ];
      
      for (var j = 0; j < labels.length; j++){
        var lb = labels[j];
        var p = pctForTime(lb.time);
        if (p >= 0 && p <= 100){
          labelsHtml += '<span class="tl-event-label ' + lb.cls + ' level-' + lb.level + '" style="left:' + p + '%">' + lb.text + '</span>';
        }
      }
      
      tlEventLabels.innerHTML = labelsHtml;
    }

    // Position NOW marker
    if (tlNow){
      var now = new Date();
      var nowPct = pctForTime(now);
      
      if (nowPct >= 0 && nowPct <= 100){
        tlNow.style.left = nowPct + "%";
        tlNow.style.display = "block";
        
        // Update NOW temp
        if (tlNowTemp && hourly && hourly.temperature_2m){
          var nowTemp = Math.round(hourly.temperature_2m[nearestIndex]);
          tlNowTemp.textContent = nowTemp + "";
        }
      } else {
        tlNow.style.display = "none";
      }
    }
  }
/* =========================================================
     AIR QUALITY & POLLEN (Open-Meteo)
     ========================================================= */
  function classifyAqi(aqi){
    if (aqi == null || isNaN(aqi)) return { label: "--", cls: "" };
    if (aqi <= 50) return { label: "Good (" + Math.round(aqi) + ")", cls: "good" };
    if (aqi <= 100) return { label: "Moderate (" + Math.round(aqi) + ")", cls: "moderate" };
    if (aqi <= 150) return { label: "Sensitive (" + Math.round(aqi) + ")", cls: "unhealthy-sensitive" };
    if (aqi <= 200) return { label: "Unhealthy (" + Math.round(aqi) + ")", cls: "unhealthy" };
    if (aqi <= 300) return { label: "Very Unhealthy (" + Math.round(aqi) + ")", cls: "very-unhealthy" };
    return { label: "Hazardous (" + Math.round(aqi) + ")", cls: "hazardous" };
  }

  function classifyPollen(val){
    if (val == null || isNaN(val) || val <= 0) return { label: "None", cls: "none" };
    if (val <= 20) return { label: "Low", cls: "low" };
    if (val <= 80) return { label: "Moderate", cls: "moderate" };
    if (val <= 200) return { label: "High", cls: "high" };
    return { label: "Very High", cls: "very-high" };
  }

  function loadAirQuality(){
    var aqiEl = document.getElementById("aqi-val");
    var pm25El = document.getElementById("pm25-val");
    var pm10El = document.getElementById("pm10-val");
    var pollenTreeEl = document.getElementById("pollen-tree");
    var pollenGrassEl = document.getElementById("pollen-grass");
    var pollenWeedEl = document.getElementById("pollen-weed");
    var pollenRagweedEl = document.getElementById("pollen-ragweed");

    var url = 
      "https://air-quality-api.open-meteo.com/v1/air-quality" +
      "?latitude=" + LOCATION.lat +
      "&longitude=" + LOCATION.lon +
      "&current=us_aqi,us_aqi_pm2_5,us_aqi_pm10,us_aqi_nitrogen_dioxide,us_aqi_ozone,us_aqi_sulphur_dioxide,us_aqi_carbon_monoxide,pm10,pm2_5,carbon_monoxide,nitrogen_dioxide,sulphur_dioxide,ozone" +
      "&current=alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen" +
      "&hourly=us_aqi,pm2_5,pm10,ozone,nitrogen_dioxide,sulphur_dioxide,carbon_monoxide" +
      "&forecast_hours=24";

    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try{
          var current = data && data.current;
          if (!current) return;

          // Store full AQ data for detail modal
          window._aqData = { current: current, hourly: data.hourly, time: data.current_units };

          // AQI
          if (aqiEl){
            var aqiInfo = classifyAqi(current.us_aqi);
            aqiEl.textContent = aqiInfo.label;
            aqiEl.className = "ap-val " + aqiInfo.cls;
            aqiEl.style.cursor = "pointer";
            aqiEl.onclick = function(){ openAqiDetail(); };
          }

          // PM2.5
          var pm25 = current.pm2_5 || 0;
          if (pm25El){
            pm25El.textContent = (pm25 != null ? Math.round(pm25) + " g/m" : "--");
          }

          // PM10
          if (pm10El){
            var pm10 = current.pm10;
            pm10El.textContent = (pm10 != null ? Math.round(pm10) + " g/m" : "--");
          }

          // Tree pollen (combine alder + birch)
          if (pollenTreeEl){
            var treePollen = Math.max(current.alder_pollen || 0, current.birch_pollen || 0);
            var treeInfo = classifyPollen(treePollen);
            pollenTreeEl.textContent = treeInfo.label;
            pollenTreeEl.className = "pollen-val " + treeInfo.cls;
          }

          // Grass pollen
          if (pollenGrassEl){
            var grassInfo = classifyPollen(current.grass_pollen);
            pollenGrassEl.textContent = grassInfo.label;
            pollenGrassEl.className = "pollen-val " + grassInfo.cls;
          }

          // Weed pollen (mugwort + olive)
          if (pollenWeedEl){
            var weedPollen = Math.max(current.mugwort_pollen || 0, current.olive_pollen || 0);
            var weedInfo = classifyPollen(weedPollen);
            pollenWeedEl.textContent = weedInfo.label;
            pollenWeedEl.className = "pollen-val " + weedInfo.cls;
          }

          // Ragweed
          if (pollenRagweedEl){
            var ragweedInfo = classifyPollen(current.ragweed_pollen);
            pollenRagweedEl.textContent = ragweedInfo.label;
            pollenRagweedEl.className = "pollen-val " + ragweedInfo.cls;
          }

        } catch(e){
          console.error("Air quality parse error", e);
        }
      })
      .catch(function(err){
        console.error("Air quality load error", err);
      });
  }
  function openAqiDetail(){
    var d=window._aqData;if(!d||!d.current)return;
    var c=d.current,hr=d.hourly;
    function ac(v){if(v==null||isNaN(v))return"#666";if(v<=50)return"#22c55e";if(v<=100)return"#eab308";if(v<=150)return"#f97316";if(v<=200)return"#ef4444";if(v<=300)return"#9333ea";return"#7f1d1d";}
    function al(v){if(v==null||isNaN(v))return"--";if(v<=50)return"Good";if(v<=100)return"Moderate";if(v<=150)return"USG";if(v<=200)return"Unhealthy";if(v<=300)return"V.Unhealthy";return"Hazardous";}
    function hg(a){
      if(a==null)return{i:"",w:"",a:""};
      if(a<=50)return{i:"",w:"",a:"Satisfactory. Great for all outdoor activities."};
      if(a<=100)return{i:"",w:"Asthma, COPD, heart disease, children, elderly",a:"Acceptable. Sensitive individuals should limit prolonged heavy exertion."};
      if(a<=150)return{i:"",w:"Children, elderly, respiratory/cardiac conditions",a:"Sensitive groups reduce outdoor exertion. Move indoors if symptoms occur."};
      if(a<=200)return{i:"",w:"Everyone  especially sensitive groups",a:"Reduce outdoor exertion. Sensitive groups avoid outdoor activity."};
      if(a<=300)return{i:"",w:"Everyone",a:"Avoid all outdoor exertion. Close windows. Run air purifiers."};
      return{i:"",w:"Everyone",a:"Health emergency. Remain indoors. Seal windows. N95 essential."};
    }
    var windEl=document.getElementById("wind");var gustEl=document.getElementById("gusts");
    var cWind=windEl?windEl.textContent:'--';var cGust=gustEl?gustEl.textContent:'--';
    var wDir='--';
    if(window._wxHourly&&window._wxHourly.wind_direction_10m&&window._wxNearestIdx!=null){
      var wd=window._wxHourly.wind_direction_10m[window._wxNearestIdx];
      if(wd!=null)wDir=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round(wd/22.5)%16];
    }
    var subs=[
      {n:'PM2.5',v:c.pm2_5,u:'g/m',a:c.us_aqi_pm2_5,k:'pm2_5',who:5,d:'Ultrafine  smoke, exhaust  lungs & blood'},
      {n:'PM10',v:c.pm10,u:'g/m',a:c.us_aqi_pm10,k:'pm10',who:15,d:'Coarse  dust, pollen  airways'},
      {n:'O',v:c.ozone,u:'g/m',a:c.us_aqi_ozone,k:'ozone',who:100,d:'Gas  smog  inflames lungs'},
      {n:'NO',v:c.nitrogen_dioxide,u:'g/m',a:c.us_aqi_nitrogen_dioxide,k:'nitrogen_dioxide',who:25,d:'Gas  diesel  damages airways'},
      {n:'SO',v:c.sulphur_dioxide,u:'g/m',a:c.us_aqi_sulphur_dioxide,k:'sulphur_dioxide',who:40,d:'Gas  coal  constricts airways'},
      {n:'CO',v:c.carbon_monoxide,u:'g/m',a:c.us_aqi_carbon_monoxide,k:'carbon_monoxide',who:4000,d:'Gas  engines  starves O'}
    ];
    var dom=subs.reduce(function(a,b){return(b.a||0)>(a.a||0)?b:a;});
    var ov=c.us_aqi!=null?Math.round(c.us_aqi):'--';
    var oc=ac(c.us_aqi),ol=al(c.us_aqi),g=hg(c.us_aqi);
    var pm25=c.pm2_5||0;

    var h='';
    // === TOP: Hero + Health + Trend + Smoke + Wind  all in one grid ===
    h+='<div style="display:grid;grid-template-columns:90px 1fr 100px;gap:8px;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,255,255,.06);">';
    // Col 1: AQI number
    h+='<div style="text-align:center;display:flex;flex-direction:column;justify-content:center;">';
    h+='<div style="font-size:2.8rem;font-weight:900;color:'+oc+';line-height:1;">'+ov+'</div>';
    h+='<div style="font-size:.8rem;font-weight:800;color:'+oc+';">'+ol+'</div>';
    h+='<div style="font-size:.48rem;color:#888;margin-top:2px;font-weight:700;">'+dom.n+' dominant</div>';
    h+='</div>';
    // Col 2: Health + Trend stacked
    h+='<div>';
    h+='<div style="font-size:.68rem;color:#ddd;line-height:1.35;margin-bottom:4px;">'+g.i+' '+g.a+'</div>';
    if(g.w) h+='<div style="font-size:.52rem;color:#f97316;font-weight:700;margin-bottom:4px;">At risk: <span style="font-weight:500;color:#aaa;">'+g.w+'</span></div>';
    // Trend inline
    if(hr&&hr.us_aqi&&hr.time){
      var vals=hr.us_aqi,maxV=Math.max.apply(null,vals.filter(function(v){return v!=null;}).concat([50]));
      var pts=[];for(var i=0;i<vals.length;i++){if(vals[i]==null)continue;pts.push(((i/(vals.length-1))*180)+','+(18-(vals[i]/maxV)*18));}
      if(pts.length>1){
        var fV=vals[0]||0,lV=vals[vals.length-1]||0;
        var tr=lV<fV-5?'Improving':lV>fV+5?'Worsening':'Stable';
        var tc=lV<fV-5?'#22c55e':lV>fV+5?'#ef4444':'#eab308';
        h+='<div style="display:flex;align-items:center;gap:6px;">';
        h+='<svg viewBox="0 0 180 18" style="flex:1;height:18px;" preserveAspectRatio="none">';
        h+='<polygon points="0,18 '+pts.join(' ')+' 180,18" fill="'+oc+'" opacity="0.15"/>';
        h+='<polyline points="'+pts.join(' ')+'" fill="none" stroke="'+oc+'" stroke-width="1.5"/>';
        h+='</svg>';
        h+='<span style="font-size:.48rem;font-weight:800;color:'+tc+';white-space:nowrap;">'+tr+'</span>';
        h+='</div>';
      }
    }
    h+='</div>';
    // Col 3: Wind
    h+='<div style="text-align:center;display:flex;flex-direction:column;justify-content:center;border-left:1px solid rgba(255,255,255,.06);padding-left:8px;">';
    h+='<div style="font-size:.42rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:.5px;"> WIND</div>';
    h+='<div style="font-size:.9rem;font-weight:900;color:#fff;">'+cWind+'</div>';
    h+='<div style="font-size:.5rem;color:#aaa;font-weight:700;">'+wDir+'</div>';
    h+='<div style="font-size:.48rem;color:#777;">Gusts '+cGust+'</div>';
    h+='</div></div>';

    // === SMOKE  compact single row ===
    var sL,sC,sP;
    if(pm25>=150){sL='HEAVY';sC='#ef4444';sP='Stay indoors. HEPA on. N95 outside.';}
    else if(pm25>=55.5){sL='THICK';sC='#f97316';sP='Limit outdoor time. Close windows. N95 helps.';}
    else if(pm25>=35.5){sL='MODERATE';sC='#eab308';sP='Sensitive groups limit outdoors. Close windows PM.';}
    else if(pm25>=12.1){sL='LIGHT HAZE';sC='#a3a3a3';sP='No precautions for most.';}
    else{sL='CLEAR';sC='#22c55e';sP='Clean air. No precautions.';}
    var sVis=pm25>=150?'<1mi':pm25>=55.5?'13mi':pm25>=35.5?'35mi':pm25>=12.1?'510mi':'10+mi';

    h+='<div style="display:grid;grid-template-columns:auto 1fr auto auto auto;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,.03);border-radius:8px;margin-bottom:10px;border:1px solid rgba(255,255,255,.04);">';
    h+='<div style="font-size:.48rem;color:#888;font-weight:800;"></div>';
    h+='<div>';
    h+='<div style="font-size:.65rem;font-weight:900;color:'+sC+';line-height:1;">'+sL+'</div>';
    h+='<div style="font-size:.45rem;color:#999;">'+sP+'</div>';
    h+='</div>';
    h+='<div style="text-align:center;"><div style="font-size:.38rem;color:#777;font-weight:700;">PM2.5</div><div style="font-size:.6rem;font-weight:900;color:'+ac(c.us_aqi_pm2_5)+';">'+Math.round(pm25)+'</div></div>';
    h+='<div style="text-align:center;"><div style="font-size:.38rem;color:#777;font-weight:700;">WHO</div><div style="font-size:.6rem;font-weight:900;color:#f97316;">'+(pm25/5).toFixed(1)+'</div></div>';
    h+='<div style="text-align:center;"><div style="font-size:.38rem;color:#777;font-weight:700;">VIS</div><div style="font-size:.55rem;font-weight:700;color:#ccc;">'+sVis+'</div></div>';
    h+='</div>';

    // Smoke source from active fires + wind direction
    if(window._activeFires&&window._activeFires.length>0&&pm25>=12){
      var lat=LOCATION.lat,lon=LOCATION.lon;
      var wDirsAll=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      var windFrom=wDir; // wind blows FROM this direction
      // Find fires that are upwind (in the direction wind comes from)
      var upwindFires=[];
      window._activeFires.forEach(function(fire){
        var coords=fire.geometry&&fire.geometry.coordinates;
        var props=fire.properties||{};
        if(!coords)return;
        var fLat=coords[1],fLon=coords[0];
        var dLat=fLat-lat,dLon=fLon-lon;
        var dist=Math.sqrt(dLat*dLat+dLon*dLon)*69;
        if(dist>500||dist<5)return; // skip fires >500mi or <5mi
        var angle=Math.atan2(dLon,dLat)*180/Math.PI;
        if(angle<0)angle+=360;
        var fireDir=wDirsAll[Math.round(angle/22.5)%16];
        // Check if fire direction roughly matches wind-from direction (within 45)
        var wIdx=wDirsAll.indexOf(windFrom);
        var fIdx=wDirsAll.indexOf(fireDir);
        if(wIdx<0)return;
        var diff=Math.abs(fIdx-wIdx);if(diff>8)diff=16-diff;
        var isUpwind=diff<=2; // within ~45
        var acres=props.DailyAcres||props.GISAcres||props.CalculatedAcres||0;
        var name=props.IncidentName||props.FireName||'Unknown';
        upwindFires.push({name:name,dist:Math.round(dist),acres:acres,dir:fireDir,upwind:isUpwind,contained:props.PercentContained||0});
      });
      // Sort by relevance: upwind first, then by size
      upwindFires.sort(function(a,b){
        if(a.upwind&&!b.upwind)return-1;if(!a.upwind&&b.upwind)return 1;
        return b.acres-a.acres;
      });
      var topFires=upwindFires.slice(0,3);
      if(topFires.length>0){
        h+='<div style="padding:6px 10px;background:rgba(239,68,68,.06);border-radius:8px;margin-top:6px;border:1px solid rgba(239,68,68,.1);">';
        h+='<div style="font-size:.48rem;color:#ef4444;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;"> LIKELY SMOKE SOURCES</div>';
        topFires.forEach(function(f){
          var acStr=f.acres>0?(f.acres>=1000?(Math.round(f.acres/1000)+'k'):f.acres)+' acres':'size unknown';
          var contStr=f.contained>0?'  '+f.contained+'% contained':'';
          h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;">';
          h+='<span style="font-size:.58rem;color:#eee;font-weight:700;">'+f.name+'</span>';
          h+='<span style="font-size:.48rem;color:#aaa;">'+f.dist+'mi '+f.dir+(f.upwind?' ':'')+'</span>';
          h+='</div>';
          h+='<div style="font-size:.45rem;color:#999;margin-bottom:4px;">'+acStr+contStr+'</div>';
        });
        if(topFires.some(function(f){return f.upwind;})){
          h+='<div style="font-size:.45rem;color:#f97316;margin-top:2px;"> = upwind of you (wind from '+windFrom+')</div>';
        }
        h+='</div>';
      }
    }

    // === POLLUTANTS  compact 2-col grid ===
    h+='<div style="font-size:.5rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px;">POLLUTANTS</div>';
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:10px;">';
    subs.forEach(function(p){
      var pc=ac(p.a),pl=al(p.a),isDom=p.n===dom.n;
      var barW=p.a!=null?Math.min((p.a/300)*100,100):0;
      var whoX='';if(p.v!=null&&p.who){var r=p.v/p.who;whoX=r<=1?'<span style="color:#22c55e;"></span>':'<span style="color:#f97316;">'+r.toFixed(1)+'</span>';}
      var ms='';
      if(hr&&hr[p.k]){var pV=hr[p.k],pM=Math.max.apply(null,pV.filter(function(v){return v!=null;}).concat([1]));var mP=[];for(var j=0;j<pV.length;j++){if(pV[j]==null)continue;mP.push(((j/(pV.length-1))*40)+','+(12-(pV[j]/pM)*12));}if(mP.length>1)ms='<svg viewBox="0 0 40 12" style="width:35px;height:12px;opacity:.5;" preserveAspectRatio="none"><polyline points="'+mP.join(' ')+'" fill="none" stroke="'+pc+'" stroke-width="1"/></svg>';}

      h+='<div style="padding:5px 7px;background:'+(isDom?'rgba(255,255,255,.06)':'rgba(255,255,255,.02)')+';border-radius:6px;border:1px solid '+(isDom?'rgba(255,255,255,.08)':'rgba(255,255,255,.03)')+';">';
      // Row 1: name + AQI
      h+='<div style="display:flex;justify-content:space-between;align-items:center;">';
      h+='<span style="font-size:.68rem;font-weight:800;color:#fff;">'+p.n+(isDom?' <span style="font-size:.32rem;background:'+pc+';color:#000;padding:1px 3px;border-radius:2px;vertical-align:middle;"></span>':'')+'</span>';
      h+='<div style="display:flex;align-items:center;gap:3px;">'+ms+'<span style="font-size:.72rem;font-weight:900;color:'+pc+';">'+(p.a!=null?Math.round(p.a):'--')+'</span></div>';
      h+='</div>';
      // Bar
      h+='<div style="height:3px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden;margin:3px 0;">';
      h+='<div style="height:100%;width:'+barW+'%;background:'+pc+';border-radius:2px;"></div></div>';
      // Row 2: value + WHO + desc
      h+='<div style="display:flex;justify-content:space-between;align-items:center;">';
      h+='<span style="font-size:.48rem;color:#aaa;">'+(p.v!=null?(Math.round(p.v*10)/10)+'g':'--')+' '+whoX+'</span>';
      h+='<span style="font-size:.42rem;color:#666;font-style:italic;">'+p.d+'</span>';
      h+='</div></div>';
    });
    h+='</div>';

    // === COMPARISON  nearby + reference ===
    var compId='aqi-cmp-'+Date.now();
    h+='<div id="'+compId+'">';
    h+='<div style="font-size:.5rem;color:#666;text-align:center;padding:8px;">Loading comparisons...</div>';
    h+='</div>';

    setTimeout(function(){
      var compEl=document.getElementById(compId);if(!compEl)return;
      var lat=LOCATION.lat,lon=LOCATION.lon;

      // Reference cities (always shown)
      var refs=[
        {lat:40.71,lon:-74.01,name:'New York City',t:'urban'},{lat:34.05,lon:-118.24,name:'Los Angeles',t:'urban'},
        {lat:41.88,lon:-87.63,name:'Chicago',t:'urban'},{lat:35.37,lon:-119.02,name:'Bakersfield',t:'urban'},
        {lat:40.76,lon:-111.89,name:'Salt Lake City',t:'urban'},{lat:29.76,lon:-95.37,name:'Houston',t:'urban'},
        {lat:46.87,lon:-110.36,name:'Rural Montana',t:'rural'},{lat:44.26,lon:-72.58,name:'Rural Vermont',t:'rural'},
        {lat:43.80,lon:-120.55,name:'Rural Oregon',t:'rural'}
      ];

      // Search for nearby cities using Open-Meteo geocoding  4 fast parallel searches
      var searchQueries=[
        'https://geocoding-api.open-meteo.com/v1/search?name=city&count=10&latitude='+lat+'&longitude='+lon+'&radius=160000',
      ];
      // Use directional searches at ~100mi offsets to find cities in each direction
      var off=1.45;
      var dirPts=[
        {lat:lat+off,lon:lon},{lat:lat-off,lon:lon},
        {lat:lat,lon:lon+off},{lat:lat,lon:lon-off},
        {lat:lat+off*.7,lon:lon+off*.7},{lat:lat-off*.7,lon:lon-off*.7},
        {lat:lat+off*.7,lon:lon-off*.7},{lat:lat-off*.7,lon:lon+off*.7},
        {lat:lat+off*.5,lon:lon},{lat:lat-off*.5,lon:lon},
        {lat:lat,lon:lon+off*.5},{lat:lat,lon:lon-off*.5}
      ];

      // Just directly fetch AQI for directional grid + refs in one call (instant)
      var allPts=dirPts.concat(refs);
      var lats=allPts.map(function(p){return p.lat.toFixed(4);}).join(',');
      var lons=allPts.map(function(p){return p.lon.toFixed(4);}).join(',');

      // Single fast AQI fetch
      fetch('https://air-quality-api.open-meteo.com/v1/air-quality?latitude='+lats+'&longitude='+lons+'&current=us_aqi,pm2_5')
      .then(function(r){return r.json();}).then(function(data){
        if(!compEl||!Array.isArray(data))return;

        var dirLabels=['N','S','E','W','NE','SW','NW','SE','N-mid','S-mid','E-mid','W-mid'];
        var near=[],ref=[];
        data.forEach(function(dd,i){
          if(!dd||!dd.current||dd.current.us_aqi==null)return;
          var a=Math.round(dd.current.us_aqi);
          if(i<dirPts.length){
            // Use latitude/longitude to generate approximate city via state lookup
            near.push({n:dirLabels[i]+' ~'+(i>=8?'50':'100')+'mi',aqi:a,lat:dirPts[i].lat,lon:dirPts[i].lon});
          } else {
            var rf=refs[i-dirPts.length];
            ref.push({n:rf.name,aqi:a,t:rf.t});
          }
        });
        var me={n:LOCATION.name||'You',aqi:Math.round(c.us_aqi),you:true};

        // Render immediately with compass directions
        renderComp(near,ref,me);

        // Background: batch reverse geocode via Nominatim for real names
        // Fire ALL at once (Nominatim may rate limit but results still come)
        var resolved=0;
        near.forEach(function(nr,idx){
          setTimeout(function(){
            fetch('https://nominatim.openstreetmap.org/reverse?lat='+nr.lat.toFixed(4)+'&lon='+nr.lon.toFixed(4)+'&format=json&zoom=10&addressdetails=1')
            .then(function(r){return r.json();}).then(function(d){
              if(d&&d.address){
                var nm=d.address.city||d.address.town||d.address.village||d.address.hamlet||d.address.county||'';
                var st=d.address.state||'';
                var ab={'New York':'NY','New Jersey':'NJ','Connecticut':'CT','Pennsylvania':'PA','Massachusetts':'MA','Vermont':'VT','New Hampshire':'NH','Maine':'ME','Maryland':'MD','Virginia':'VA','Delaware':'DE','California':'CA','Texas':'TX','Illinois':'IL','Ohio':'OH','Michigan':'MI','Georgia':'GA','Florida':'FL','North Carolina':'NC','Washington':'WA','Oregon':'OR','Colorado':'CO','Arizona':'AZ','Nevada':'NV','Utah':'UT','Montana':'MT','Idaho':'ID','Wyoming':'WY','Tennessee':'TN','Kentucky':'KY','Indiana':'IN','Wisconsin':'WI','Minnesota':'MN','Iowa':'IA','Missouri':'MO','Arkansas':'AR','Louisiana':'LA','Mississippi':'MS','Alabama':'AL','South Carolina':'SC','West Virginia':'WV','Rhode Island':'RI','Nebraska':'NE','Kansas':'KS','Oklahoma':'OK','New Mexico':'NM','South Dakota':'SD','North Dakota':'ND'};
                if(nm) nr.n=nm+', '+(ab[st]||st.substring(0,2).toUpperCase());
                nr.pop=d.address.city?'urban':'rural';
              }
              resolved++;
              if(resolved>=near.length) renderComp(near,ref,me);
            }).catch(function(){resolved++;if(resolved>=near.length)renderComp(near,ref,me);});
          },idx*120);
        });
      }).catch(function(){compEl.innerHTML='<div style="font-size:.5rem;color:#666;">Comparison unavailable</div>';});

      function renderComp(near,ref,me){
        // Dedup + filter unnamed
        var seen={},uniq=[];
        near.forEach(function(r){var k=r.n.split(',')[0].trim();if(!seen[k]&&r.n.indexOf('~')===-1){seen[k]=true;uniq.push(r);}});
        // If no named cities yet, show all compass entries
        if(uniq.length===0) uniq=near;

        uniq.sort(function(a,b){return a.aqi-b.aqi;});
        ref.sort(function(a,b){return a.aqi-b.aqi;});

        var avgN=uniq.length?Math.round(uniq.reduce(function(s,r){return s+r.aqi;},0)/uniq.length):0;
        var worst=uniq.length?uniq[uniq.length-1]:{n:'--',aqi:0};
        var best=uniq.length?uniq[0]:{n:'--',aqi:0};
        var uA=0,uC=0,rA=0,rC=0;
        ref.forEach(function(r){if(r.t==='urban'){uA+=r.aqi;uC++;}if(r.t==='rural'){rA+=r.aqi;rC++;}});
        if(uC)uA=Math.round(uA/uC);if(rC)rA=Math.round(rA/rC);

        function bars(list,max){
          var s='';list.forEach(function(r){
            var bp=Math.min((r.aqi/max)*100,100),bc=ac(r.aqi);
            var tag=r.pop==='rural'||r.t==='rural'?'':r.pop==='urban'||r.t==='urban'?'':'';
            s+='<div style="display:flex;align-items:center;gap:4px;margin-bottom:1px;'+(r.you?'background:rgba(255,255,255,.07);border-radius:3px;padding:2px 5px;margin-left:-5px;margin-right:-5px;':'')+'">';
            s+='<div style="width:105px;font-size:.48rem;color:'+(r.you?'#fff':'#999')+';font-weight:'+(r.you?'800':'500')+';text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+(r.you?' '+r.n:r.n+(tag?' '+tag:''))+'</div>';
            s+='<div style="flex:1;height:4px;background:rgba(255,255,255,.05);border-radius:2px;overflow:hidden;"><div style="height:100%;width:'+bp+'%;background:'+bc+';border-radius:2px;"></div></div>';
            s+='<div style="width:22px;font-size:.48rem;font-weight:800;color:'+bc+';">'+r.aqi+'</div></div>';
          });return s;
        }
        var ch='';
        ch+='<div style="font-size:.5rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:3px;"> NEARBY (~100 mi)</div>';
        ch+='<div style="font-size:.6rem;color:#ddd;margin-bottom:2px;">'+(c.us_aqi<=avgN?'<span style="color:#22c55e;font-weight:800;">Better</span>':'<span style="color:#f97316;font-weight:800;">Worse</span>')+' than nearby avg <span style="color:'+ac(avgN)+';font-weight:800;">'+avgN+'</span>';
        if(worst.aqi-best.aqi>10) ch+='  <span style="color:'+ac(worst.aqi)+';">'+worst.n.split(',')[0]+' '+worst.aqi+'</span>  <span style="color:'+ac(best.aqi)+';">'+best.n.split(',')[0]+' '+best.aqi+'</span>';
        ch+='</div>';
        var allN=uniq.slice();allN.push(me);allN.sort(function(a,b){return a.aqi-b.aqi;});
        ch+=bars(allN,Math.max.apply(null,allN.map(function(r){return r.aqi;}).concat([100])));

        ch+='<div style="font-size:.5rem;color:#888;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-top:8px;margin-bottom:3px;"> US REFERENCE</div>';
        var allR=ref.slice();allR.push(me);allR.sort(function(a,b){return a.aqi-b.aqi;});
        ch+=bars(allR,Math.max.apply(null,allR.map(function(r){return r.aqi;}).concat([100])));

        ch+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;margin-top:6px;">';
        ch+='<div style="text-align:center;padding:3px;background:rgba(255,255,255,.03);border-radius:4px;"><div style="font-size:.38rem;color:#888;font-weight:700;">NEARBY</div><div style="font-size:.72rem;font-weight:900;color:'+ac(avgN)+';">'+avgN+'</div></div>';
        ch+='<div style="text-align:center;padding:3px;background:rgba(255,255,255,.03);border-radius:4px;"><div style="font-size:.38rem;color:#888;font-weight:700;"> URBAN</div><div style="font-size:.72rem;font-weight:900;color:'+ac(uA)+';">'+uA+'</div></div>';
        ch+='<div style="text-align:center;padding:3px;background:rgba(255,255,255,.03);border-radius:4px;"><div style="font-size:.38rem;color:#888;font-weight:700;"> RURAL</div><div style="font-size:.72rem;font-weight:900;color:'+ac(rA)+';">'+rA+'</div></div>';
        ch+='<div style="text-align:center;padding:3px;background:rgba(255,255,255,.06);border-radius:4px;border:1px solid rgba(255,255,255,.08);"><div style="font-size:.38rem;color:#888;font-weight:700;"> YOU</div><div style="font-size:.72rem;font-weight:900;color:'+ac(c.us_aqi)+';">'+Math.round(c.us_aqi)+'</div></div>';
        ch+='</div>';
        compEl.innerHTML=ch;
      }
    },50);

    // EPA scale
    h+='<div style="display:flex;gap:1px;height:5px;border-radius:3px;overflow:hidden;margin-top:8px;">';
    ['#22c55e','#eab308','#f97316','#ef4444','#9333ea','#7f1d1d'].forEach(function(cc){h+='<div style="flex:1;background:'+cc+';"></div>';});
    h+='</div>';
    h+='<div style="display:flex;justify-content:space-between;margin-top:1px;margin-bottom:3px;">';
    ['Good','Moderate','USG','Unhealthy','V.Unhlthy','Hazardous'].forEach(function(l){h+='<span style="font-size:.38rem;color:#666;text-align:center;flex:1;font-weight:600;">'+l+'</span>';});
    h+='</div>';
    h+='<div style="text-align:center;font-size:.4rem;color:#555;">Open-Meteo  CAMS  EPA  Hourly</div>';

    if(widgetModal&&widgetModalBody){
      clearModalAnimations();
      updateModalHeader('AIR QUALITY','EPA  Open-Meteo','https://air-quality-api.open-meteo.com/');
      widgetModalBody.className='widget-modal-body content-card';
      widgetModalBody.innerHTML='<div style="max-width:560px;margin:0 auto;">'+h+'</div>';
      positionModalAtViewport(widgetModal);
    }
  }

  /* =========================================================
     WEATHER LOAD (Open-Meteo)
     ========================================================= */
  function loadWeatherForLocation(loc){
    if (!locNameEl) return;

    setText(locNameEl, loc.name);

    var url =
      "https://api.open-meteo.com/v1/forecast" +
      "?latitude=" + loc.lat +
      "&longitude=" + loc.lon +
      "&timezone=" + encodeURIComponent(TZ) +
      "&temperature_unit=fahrenheit" +
      "&windspeed_unit=mph" +
      "&precipitation_unit=inch" +
      "&hourly=temperature_2m,apparent_temperature,relativehumidity_2m,precipitation_probability,precipitation,cloudcover,windspeed_10m,windgusts_10m,wind_direction_10m,visibility,pressure_msl,uv_index,weathercode,snowfall,rain" +
      "&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,sunrise,sunset,uv_index_max,windspeed_10m_max,windgusts_10m_max,snowfall_sum,rain_sum,wind_direction_10m_dominant,showers_sum" +
      "&forecast_days=10";

    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try{
          var hourly = data && data.hourly;
          var daily  = data && data.daily;

          if (!hourly || !daily || !hourly.time || !daily.time){
            setText(condTextEl, "No data");
            return;
          }

          // Find nearest hour index
          var now = new Date();
          var nearestIndex = 0, minDiff = Infinity;
          for (var i=0;i<hourly.time.length;i++){
            var dt = new Date(hourly.time[i]);
            var diff = Math.abs(now - dt);
            if (diff < minDiff){ minDiff = diff; nearestIndex = i; }
          }

          // Current conditions
          var temp = Math.round(hourly.temperature_2m[nearestIndex]);
          setText(tempEl, temp + "");

          var feels = hourly.apparent_temperature && hourly.apparent_temperature[nearestIndex];
          var feelsVal = (typeof feels === "number" ? Math.round(feels) : temp);
          setText(feelsInlineEl, "Feels " + feelsVal + "");

          var rh = hourly.relativehumidity_2m && hourly.relativehumidity_2m[nearestIndex];
          setText(humidityEl, (typeof rh === "number" ? Math.round(rh) + "%" : "--"));

          var gust = hourly.windgusts_10m && hourly.windgusts_10m[nearestIndex];
          setText(gustsEl, (typeof gust === "number" ? Math.round(gust) + " mph" : "--"));

          var sp = hourly.pressure_msl && hourly.pressure_msl[nearestIndex];
          setText(pressureEl, (typeof sp === "number" ? (sp * 0.029529983).toFixed(2) + " inHg" : "--"));

          var uvNow = hourly.uv_index && hourly.uv_index[nearestIndex];
          setText(uvEl, (typeof uvNow === "number" ? uvNow.toFixed(1) : "--"));

          var windSpd = hourly.windspeed_10m && hourly.windspeed_10m[nearestIndex];
          setText(windEl, (typeof windSpd === "number" ? Math.round(windSpd) + " mph" : "--"));

          setText(locMetaEl, "Updated " + fmt12NoSuffixFromDate(now));
          if (tempEl) tempEl.style.opacity = "1";

          // Today hi/lo
          var hi = daily.temperature_2m_max[0];
          var lo = daily.temperature_2m_min[0];
          var hiLoTextEl = document.getElementById("hilo-text");
          if (hiLoTextEl) hiLoTextEl.textContent = "High " + Math.round(hi) + " | Low " + Math.round(lo) + "";

          // Precip
          var precipProb = daily.precipitation_probability_max[0];

          var precipSum = (daily.precipitation_sum && daily.precipitation_sum[0] != null) ? daily.precipitation_sum[0] : 0;
          setText(precipAmtEl, precipSum.toFixed(2) + " in");
          setText(forecastRowEl, (precipProb != null ? ("Max " + Math.round(precipProb) + "%") : "--"));

          // Weather icon/text (daily code)
          var c = iconForCode(daily.weathercode[0]);
          if (condIconEl) condIconEl.src = c.i;
          setText(condTextEl, c.t);

          // Sunrise/sunset
          var srIsoToday = daily.sunrise[0];
          var ssIsoToday = daily.sunset[0];

          // Render new combined timeline
          renderTimeline(hourly, daily, nearestIndex);

          // Render TODAY Timeline widget (v4/v5)
          // Fetch Kp data then render
          fetchKpDataForToday(function(kpData){
            renderTodayTimeline(hourly, daily, nearestIndex, kpData);
          });

          // 7-day chips
          if (forecast7El){
            function iconUrlForDaily(code){
              if (code === 0) return METEO_BASE + "clear-day.svg";
              if (code === 1 || code === 2) return METEO_BASE + "partly-cloudy-day.svg";
              if (code === 3) return METEO_BASE + "overcast.svg";
              if (code === 45 || code === 48) return METEO_BASE + "fog.svg";
              if (code === 51 || code === 53 || code === 55) return METEO_BASE + "drizzle.svg";
              if (code === 56 || code === 57) return METEO_BASE + "sleet.svg";
              if (code === 61 || code === 63 || code === 65) return METEO_BASE + "rain.svg";
              if (code === 66 || code === 67) return METEO_BASE + "sleet.svg";
              if (code === 71 || code === 73 || code === 75) return METEO_BASE + "snow.svg";
              if (code === 77) return METEO_BASE + "sleet.svg";
              if (code === 80 || code === 81 || code === 82) return METEO_BASE + "rain.svg";
              if (code === 85 || code === 86) return METEO_BASE + "snow.svg";
              if (code === 95 || code === 96 || code === 99) return METEO_BASE + "thunderstorms-rain.svg";
              return METEO_BASE + "not-available.svg";
            }
            var daysHtml = "";
            
            // Find today's index in the daily array
            var todayStr = new Date().toISOString().split('T')[0];
            var startIdx = 0;
            for (var i = 0; i < daily.time.length; i++) {
              if (daily.time[i] === todayStr) {
                startIdx = i;
                break;
              }
            }
            
            // Mobile: 3 days, Desktop: 7 days
            var isMobileForecast = window.innerWidth <= 768;
            var forecastDays = isMobileForecast ? 3 : 7;
            
            // Update title
            var forecastLabel = document.querySelector('.forecast7-label');
            if (forecastLabel) forecastLabel.textContent = forecastDays + ' DAY FORECAST';
            
            // Find week min/max for bar normalization
            var weekMin = Infinity, weekMax = -Infinity;
            for (var wi = startIdx; wi < startIdx + forecastDays && wi < daily.time.length; wi++){
              var wHi = daily.temperature_2m_max[wi];
              var wLo = daily.temperature_2m_min[wi];
              if (wLo < weekMin) weekMin = wLo;
              if (wHi > weekMax) weekMax = wHi;
            }
            var weekRange = weekMax - weekMin || 1;
            
            for (var dIdx = startIdx; dIdx < startIdx + forecastDays && dIdx < daily.time.length; dIdx++){
              var dayDate = new Date(daily.time[dIdx]);
var dayName = dayDate.toLocaleDateString([], { weekday:"short" }).toUpperCase() + " | " + dayDate.getDate();
              var maxT = Math.round(daily.temperature_2m_max[dIdx]);
              var minT = Math.round(daily.temperature_2m_min[dIdx]);
              // Compute daily feels-like high and low from hourly apparent_temperature
              var feelsLo = null, feelsHi = null;
              if (hourly && hourly.apparent_temperature && hourly.time) {
                var dayStr = daily.time[dIdx];
                var dayFeels = [];
                for (var hi = 0; hi < hourly.time.length; hi++) {
                  if (hourly.time[hi].substring(0,10) === dayStr) {
                    dayFeels.push(hourly.apparent_temperature[hi]);
                  }
                }
                if (dayFeels.length > 0) {
                  feelsLo = Math.round(Math.min.apply(null, dayFeels));
                  feelsHi = Math.round(Math.max.apply(null, dayFeels));
                }
              }
              var icUrl = iconUrlForDaily(daily.weathercode[dIdx]);
              
              // Bar position: left% = where lo sits in week range, width% = day's range
              var barLeft = ((daily.temperature_2m_min[dIdx] - weekMin) / weekRange * 100).toFixed(1);
              var barWidth = (((daily.temperature_2m_max[dIdx] - daily.temperature_2m_min[dIdx]) / weekRange) * 100).toFixed(1);
              if (parseFloat(barWidth) < 8) barWidth = "8"; // minimum visible width
              
              // Color: smooth continuous gradient blue  cyan  green  yellow  orange  red
              // Uses actual temperature mapped to color stops with linear interpolation
              function tempColor(t){
                // t: 0=coldest in week, 1=warmest in week
                // Color stops: 0=blue, 0.25=cyan, 0.5=green, 0.75=yellow, 1.0=red
                var stops = [
                  [0.00, 0,200,255],    // vivid cyan
                  [0.25, 0,255,130],    // vivid green
                  [0.50, 255,230,0],    // vivid yellow
                  [0.75, 255,120,0],    // vivid orange
                  [1.00, 255,30,60]     // vivid red
                ];
                t = Math.max(0, Math.min(1, t));
                var i = 0;
                for(var s = 0; s < stops.length - 1; s++){
                  if(t >= stops[s][0] && t <= stops[s+1][0]){ i = s; break; }
                }
                var range = stops[i+1][0] - stops[i][0];
                var frac = range > 0 ? (t - stops[i][0]) / range : 0;
                var r = Math.round(stops[i][1] + frac * (stops[i+1][1] - stops[i][1]));
                var g = Math.round(stops[i][2] + frac * (stops[i+1][2] - stops[i][2]));
                var b = Math.round(stops[i][3] + frac * (stops[i+1][3] - stops[i][3]));
                return 'rgb('+r+','+g+','+b+')';
              }
              var loWarmth = (daily.temperature_2m_min[dIdx] - weekMin) / weekRange;
              var hiWarmth = (daily.temperature_2m_max[dIdx] - weekMin) / weekRange;
              var barColor = tempColor(loWarmth) + ', ' + tempColor(hiWarmth);
              
              // Precipitation probability & type
              var precipProb = daily.precipitation_probability_max ? Math.round(daily.precipitation_probability_max[dIdx]) : 0;
              var precipSum = daily.precipitation_sum ? daily.precipitation_sum[dIdx] : 0;
              var snowSum = daily.snowfall_sum ? daily.snowfall_sum[dIdx] : 0;
              var rainSum = daily.rain_sum ? daily.rain_sum[dIdx] : 0;
              var showersSum = daily.showers_sum ? daily.showers_sum[dIdx] : 0;
              
              // Determine precip type and build string
              var precipStr = "";
              if (precipProb > 0) {
                var precipIcon = "";
                var precipType = "";
                var wcode = daily.weathercode[dIdx];
                var isThunder = (wcode === 95 || wcode === 96 || wcode === 99);
                if (isThunder) {
                  precipIcon = ""; precipType = "T-STORM";
                } else if (snowSum > 0 && snowSum >= rainSum) {
                  precipIcon = ""; precipType = "SNOW";
                } else if (showersSum > 0 && showersSum >= rainSum * 0.5) {
                  precipIcon = ""; precipType = "SHOWERS";
                } else if (rainSum > 0.01 || precipSum > 0.01) {
                  precipIcon = ""; precipType = "RAIN";
                } else if (snowSum > 0 && rainSum > 0) {
                  precipIcon = ""; precipType = "MIX";
                }
                precipStr = precipIcon + ' ' + precipProb + '%';
                if (precipType === "SNOW" && snowSum > 0) {
                  precipStr += '  ' + snowSum.toFixed(1) + '" SNOW';
                } else if (precipType === "MIX" && snowSum > 0) {
                  precipStr += '  ' + snowSum.toFixed(1) + '" + ' + rainSum.toFixed(2) + '"';
                } else if (precipSum > 0.01) {
                  precipStr += '  ' + precipSum.toFixed(2) + '"';
                  if (precipType) precipStr += ' ' + precipType;
                } else if (precipType) {
                  precipStr += ' ' + precipType;
                }
              }
              
              // Wind with dominant direction
              var windMax = daily.windspeed_10m_max ? Math.round(daily.windspeed_10m_max[dIdx]) : null;
              var gustMax = daily.windgusts_10m_max ? Math.round(daily.windgusts_10m_max[dIdx]) : null;
              var windDir = daily.wind_direction_10m_dominant ? daily.wind_direction_10m_dominant[dIdx] : null;
              var windStr = "";
              if (windMax != null) {
                // Convert degrees to compass
                var dirStr = "";
                if (windDir != null) {
                  var dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
                  dirStr = dirs[Math.round(windDir / 22.5) % 16] + " ";
                }
                windStr = dirStr + windMax;
                if (gustMax != null && gustMax > windMax) {
                  windStr += " | " + gustMax;
                }
                windStr += " MPH";
              }
              
              // UV Index
              var uvMax = daily.uv_index_max ? Math.round(daily.uv_index_max[dIdx]) : null;
              var uvStr = "";
              var uvClass = "uv-low";
              if (uvMax != null && uvMax >= 0) {
                var uvLabel, uvIcon;
                if (uvMax <= 2) { uvLabel = "LOW"; uvClass = "uv-low"; uvIcon = ""; }
                else if (uvMax <= 5) { uvLabel = "MOD"; uvClass = "uv-mod"; uvIcon = ""; }
                else if (uvMax <= 7) { uvLabel = "HIGH"; uvClass = "uv-high"; uvIcon = ""; }
                else if (uvMax <= 10) { uvLabel = "V.HIGH"; uvClass = "uv-vhigh"; uvIcon = ""; }
                else { uvLabel = "EXTREME"; uvClass = "uv-extreme"; uvIcon = ""; }
                uvStr = uvIcon + " UV " + uvMax + " " + uvLabel;
              }
              
              daysHtml +=
                '<div class="forecast7-chip">' +
                  '<div class="day">'+dayName+'</div>' +
                  '<img class="icon" src="'+icUrl+'" alt="weather" />' +
                  '<div class="forecast7-bar-block">' +
  '<div class="bar-hi" style="margin-left:'+barLeft+'%; margin-right:'+(100 - parseFloat(barLeft) - parseFloat(barWidth)).toFixed(1)+'%;">' +
    (feelsHi !== null && feelsHi !== maxT ? '<span class="feels-hi">'+feelsHi+'</span>' : '') +
    '<span class="temps">'+maxT+'<span style="display:inline-block;width:0;overflow:visible;"></span></span>' +
  '</div>' +
  '<div class="forecast7-bar-wrap"><div class="forecast7-bar" style="left:'+barLeft+'%;width:'+barWidth+'%;background:linear-gradient(90deg,'+barColor+');"></div></div>' +
  '<div class="bar-lo" style="margin-left:'+barLeft+'%; margin-right:'+(100 - parseFloat(barLeft) - parseFloat(barWidth)).toFixed(1)+'%;">' +
    '<span class="forecast7-lo">'+minT+'</span>' +
    (feelsLo !== null && feelsLo !== minT ? '<span class="feels-lo">'+feelsLo+'</span>' : '') +
  '</div>' +
'</div>' +
                  (windStr ? '<div class="forecast7-wind">'+windStr+'</div>' : '') +
                  (uvStr ? '<div class="forecast7-uv '+uvClass+'">'+uvStr+'</div>' : '') +
                  (precipStr ? '<div class="forecast7-precip">'+precipStr+'</div>' : '') +
                '</div>';
            }
            forecast7El.innerHTML = daysHtml;
          }

          // Moon mini with NASA image
          var phaseFrac = approximateMoonPhase(new Date());
          var mi = moonInfo(phaseFrac);
          
          var moonImgEl = document.getElementById("moon-mini-img");
          if (moonImgEl){
            // Direct illumination-to-frame mapping for NASA SVS 2024 Moon dataset
            // Uses the January 2024 lunar cycle as our reference frames:
            // - New Moon (0%): frame 252 (Jan 11, 2024)
            // - First Quarter (50%): frame 430 (Jan 18, 2024)  
            // - Full Moon (100%): frame 607 (Jan 25, 2024)
            // - Last Quarter (50%): frame 785 (Feb 2, 2024)
            // - Back to New (0%): frame 961 (Feb 9, 2024)
            //
            // One lunar cycle = ~709 frames (29.53 days * 24 hours)
            // Waxing: frames 252-607 (new to full) = 355 frames for 0-100%
            // Waning: frames 607-961 (full to new) = 354 frames for 100-0%
            
            var isWaxing = phaseFrac < 0.5;
            var illumPct = mi.illum; // Use the already-calculated illumination percentage
            
            // NASA SVS 2024 Moon dataset frame mapping
            // After testing, the actual key frames in January 2024 cycle:
            // New Moon: ~frame 258 (Jan 11, 2024) - completely dark
            // Full Moon: ~frame 612 (Jan 25, 2024) - fully lit
            // Next New Moon: ~frame 966 (Feb 9, 2024)
            //
            // Waxing (new->full): frames 258-612, RIGHT side illuminates first
            // Waning (full->new): frames 612-966, LEFT side stays lit
            
            // NASA SVS Moon Phase datasets are HOURLY for the YEAR
            // Frame 1 = Jan 1 00:00 UTC, Frame 8760 = Dec 31 23:00 UTC
            // The frame number IS the hour of the year, not a phase position
            //
            // Reference from 2024 dataset testing (a005048):
            // - Frame 500 = new moon (~0%)
            // - Frame 562 = ~2-3% waxing crescent  
            // - Frame 580 = ~10-12%
            // - Frame 600 = ~20-25%
            // - Frame 4380 = full moon (100%)
            //
            // Use 2025 dataset (a005187) - 2026 dataset has issues
// Calculate frame based on phase position
// In 2025 dataset: frame 946 = new moon, frame 1300 = full moon
// One lunar cycle = ~709 frames
var newMoonFrame = 946;
var fullMoonFrame = 1300;
var lunarCycleFrames = 709;

// phaseFrac: 0 = new, 0.5 = full, 1 = new again
var frameOffset = Math.round(phaseFrac * lunarCycleFrames);
var frameNum = newMoonFrame + frameOffset;
if (frameNum > 8760) frameNum -= 8760;

var frameStr = String(frameNum).padStart(4, '0');
var moonUrl = "https://svs.gsfc.nasa.gov/vis/a000000/a005100/a005187/frames/730x730_1x1_30p/moon." + frameStr + ".jpg";
            
            moonImgEl.src = moonUrl;
            moonImgEl.onerror = function(){
              // On error, don't change the image - keep whatever was showing
              // This prevents jumping to wrong phase on temporary server errors
              this.onerror = null; // Prevent infinite loop
            };
          }
          
          var moonIllumEl = document.getElementById("moon-mini-illum");
          var moonPhaseEl = document.getElementById("moon-mini-phase");
          if (moonIllumEl) moonIllumEl.textContent = mi.illum + "%";
          if (moonPhaseEl) moonPhaseEl.textContent = mi.name;

          // Night window: sunset today -> sunrise tomorrow
          var ssLocal = new Date(ssIsoToday);
          var srIsoTomorrow = (daily.sunrise && daily.sunrise[1]) ? daily.sunrise[1] : daily.sunrise[0];
          var srLocal = new Date(srIsoTomorrow);

          // Update night sky title and cloud coverage
          var nightSkyCloudEl = document.getElementById("night-sky-cloud");
          var nightSkyConditionEl = document.getElementById("night-sky-condition");
          var moonPhaseDisplayEl = document.getElementById("moon-phase-display");
          var moonIllumDisplayEl = document.getElementById("moon-illum-display");
          var cloudLine = nightCloudLine(hourly, ssLocal, srLocal);
          
          if (cloudLine && cloudLine !== "--"){
            var cloudParts = cloudLine.split("  ");
            var condition = cloudParts[0] || "--";
            var coverage = cloudParts[1] || "--";
            
            if (nightSkyConditionEl) nightSkyConditionEl.textContent = condition;
            if (nightSkyCloudEl) nightSkyCloudEl.textContent = coverage;
          } else {
            if (nightSkyConditionEl) nightSkyConditionEl.textContent = "--";
            if (nightSkyCloudEl) nightSkyCloudEl.textContent = "--";
          }
          
          // Update moon info in night sky header
          if (moonPhaseDisplayEl) moonPhaseDisplayEl.textContent = mi.name;
          if (moonIllumDisplayEl) moonIllumDisplayEl.textContent = mi.illum + "%";

          // Space events bullets
          var now2 = new Date();
          var met = nextMeteorPeak(now2);
          var eclipse = nextEclipse(now2);
          var conj = nextConjunction(now2);
          var opp = nextOpposition(now2);

          // Hide/blank the big headline (your current intent)
          if (spaceEventsEl) spaceEventsEl.textContent = "";

          if (spaceEventsBulletsEl){
            var bullets = "";

            var nextFull = findNextMoonEvent(now2, 0.50, 40);
            var nextNew  = findNextMoonEvent(now2, 0.00, 40);

            // 1. NEXT NEW MOON (dark sky window)
            if (nextNew){
              var duN = daysUntil(now2, nextNew);
              bullets += bulletHtml(
                "NEXT NEW MOON",
                fmtMonthDay(nextNew),
                "In " + duN + "d  Darkest skies for deep-sky objects, galaxies, nebulae  Prime Milky Way window: " + dayRangeAround(nextNew, 4)
              );
            }

          

            // 2. NEXT CONJUNCTION
            if (conj){
              var duC = daysUntil(now2, conj.d);
              bullets += bulletHtml(
                "NEXT CONJUNCTION",
                fmtMonthDay(conj.d),
                conj.bodies + "  " + conj.separation + " apart  Look " + conj.direction + " at " + conj.time.toLowerCase() + "  In " + duC + "d  " + conj.note
              );
            }

            // 4. METEOR SHOWER PEAK
            if (met){
              var when = (met.days === 0 ? "Tonight" : (met.days === 1 ? "Tomorrow" : ("In " + met.days + "d")));
              var showerData = METEOR_SHOWERS.find(function(s){ return s.name === met.name; });
              var zhr = showerData ? showerData.zhr : "?";
              var speed = showerData ? Math.round(showerData.speed).toLocaleString() : "?";
              var direction = showerData ? showerData.direction : "?";
              var radiantRise = showerData ? showerData.radiantRise : "?";
              var bestView = showerData ? showerData.bestView : "After midnight";
              bullets += bulletHtml(
                "METEOR SHOWER PEAK",
                when,
                met.name + "  " + fmtMonthDay(met.start) + "  Up to " + zhr + "/hr  " + speed + " mph  Look " + direction + "  Radiant rises " + radiantRise + "  Best viewing: " + bestView
              );
            }

            // 5. NEXT ECLIPSE
            if (eclipse){
              bullets += bulletHtml(
                "NEXT ECLIPSE",
                fmtMonthDay(eclipse.d),
                eclipse.type + "  " + eclipse.note
              );
            }

            // 5.5 RECENT FIREBALL (fetched async, injected later)
            
            // 6. NEXT FULL MOON
            if (nextFull){
              var duF = daysUntil(now2, nextFull);
              bullets += bulletHtml(
                "NEXT FULL MOON",
                fmtMonthDay(nextFull),
                "In " + duF + "d  Rises at sunset, sets at sunrise  Peak illumination for lunar photography  Avoid deep-sky imaging " + dayRangeAround(nextFull, 3)
              );
            }

            // VOYAGER 1 TRACKER (bottom)
            (function(){
              // Voyager 1 reference: 163.7 AU on Jan 1, 2025 00:00 UTC
              var refDate = new Date(Date.UTC(2025, 0, 1, 0, 0, 0));
              var refDistanceMiles = 15215899826.1; // miles on Jan 1, 2025
              var speedMph = 38210.55; // precise speed in mph
              var launchDate = new Date(Date.UTC(1977, 8, 5, 12, 56, 0)); // Sept 5, 1977 12:56 UTC
              
              // Calculate current distance in miles (updated every second conceptually)
              var msSinceRef = now2.getTime() - refDate.getTime();
              var hoursSinceRef = msSinceRef / (1000 * 60 * 60);
              var currentMiles = refDistanceMiles + (hoursSinceRef * speedMph);
              
              // Format with commas
              var milesFormatted = Math.floor(currentMiles).toLocaleString();
              
              // AU conversion
              var currentAU = currentMiles / 92955807.3;
              
              // Light time delay
              var lightSeconds = currentAU * 499.004784;
              var lightHours = Math.floor(lightSeconds / 3600);
              var lightMins = Math.floor((lightSeconds % 3600) / 60);
              var lightTimeStr = lightHours + "h " + lightMins + "m";
              
              // Mission duration
              var missionMs = now2.getTime() - launchDate.getTime();
              var missionYears = Math.floor(missionMs / (1000 * 60 * 60 * 24 * 365.25));
              var missionMonths = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 365.25)) / (1000 * 60 * 60 * 24 * 30.44));
              var missionDays = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 30.44)) / (1000 * 60 * 60 * 24));
              var missionStr = missionYears + "y " + missionMonths + "m " + missionDays + "d";
              
              bullets += bulletHtml(
                "VOYAGER 1",
                missionStr + " in flight",
                "Interstellar space  Local Interstellar Cloud  " + milesFormatted + " mi  Light delay " + lightTimeStr + "  " + speedMph.toLocaleString() + " mph"
              );
            })();

            spaceEventsBulletsEl.innerHTML = bullets;
            
            // ISS LIVE TRACKER with next pass estimation
            (function(){
              var issApiUrl = "https://api.wheretheiss.at/v1/satellites/25544";
              
              function haversineMi(lat1, lon1, lat2, lon2){
                var R = 3959;
                var dLat = (lat2-lat1)*Math.PI/180;
                var dLon = (lon2-lon1)*Math.PI/180;
                var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
                        Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
                        Math.sin(dLon/2)*Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              }
              
              function bearingDir(lat1, lon1, lat2, lon2){
                var y = Math.sin((lon2-lon1)*Math.PI/180)*Math.cos(lat2*Math.PI/180);
                var x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) -
                        Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos((lon2-lon1)*Math.PI/180);
                var b = Math.atan2(y,x)*180/Math.PI;
                if(b<0)b+=360;
                var dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
                return dirs[Math.round(b/22.5)%16];
              }
              
              var ORBIT_PERIOD_MIN = 92.68;
              var ISS_INCL = 51.6;
              
              fetch(issApiUrl)
                .then(function(r){ return r.json(); })
                .then(function(data){
                  var issLat = data.latitude;
                  var issLon = data.longitude;
                  var issAlt = Math.round(data.altitude * 0.621371); // km to miles
                  var issSpeed = Math.round(data.velocity * 0.621371); // km/h to mph
                  var visibility = data.visibility; // "daylight", "eclipsed", "penumbra"
                  
                  var groundDist = Math.round(haversineMi(LOCATION.lat, LOCATION.lon, issLat, issLon));
                  var totalDist = Math.round(Math.sqrt(groundDist*groundDist + issAlt*issAlt));
                  var dirStr = bearingDir(LOCATION.lat, LOCATION.lon, issLat, issLon);
                  
                  // Estimate next close pass using orbital mechanics
                  var userLat = LOCATION.lat;
                  var userLon = LOCATION.lon;
                  var bestPassMin = null;
                  var bestPassDist = Infinity;
                  
                  for(var orbit = 0; orbit < 48; orbit++){
                    var tMin = orbit * ORBIT_PERIOD_MIN;
                    var lonShiftPerOrbit = -22.5;
                    var currentPhase = Math.asin(Math.max(-1, Math.min(1, issLat / ISS_INCL)));
                    
                    for(var frac = 0; frac < 1; frac += 0.05){
                      var tCheck = tMin + frac * ORBIT_PERIOD_MIN;
                      var futLat = ISS_INCL * Math.sin(currentPhase + 2 * Math.PI * tCheck / ORBIT_PERIOD_MIN);
                      var futLon = issLon + (lonShiftPerOrbit * tCheck / ORBIT_PERIOD_MIN);
                      while(futLon > 180) futLon -= 360;
                      while(futLon < -180) futLon += 360;
                      
                      var dist = haversineMi(userLat, userLon, futLat, futLon);
                      if(dist < bestPassDist && tCheck > 5){
                        bestPassDist = dist;
                        bestPassMin = tCheck;
                      }
                    }
                  }
                  
                  // Format next pass estimate
                  var passStr = "";
                  if(bestPassMin !== null && bestPassDist < 800){
                    var passTime = new Date(Date.now() + bestPassMin * 60000);
                    var h = passTime.getHours();
                    var m = passTime.getMinutes();
                    var ampm = h >= 12 ? "PM" : "AM";
                    var hh = h % 12; if(hh === 0) hh = 12;
                    var timeStr = hh + ":" + (m < 10 ? "0"+m : m) + " " + ampm;
                    
                    var hoursUntil = Math.floor(bestPassMin / 60);
                    var minsUntil = Math.round(bestPassMin % 60);
                    var untilStr = hoursUntil > 0 ? (hoursUntil + "h " + minsUntil + "m") : (minsUntil + "m");
                    
                    passStr = "  NEXT PASS ~" + timeStr + " (in ~" + untilStr + ")";
                  } else if(bestPassMin !== null){
                    var hoursUntil2 = Math.floor(bestPassMin / 60);
                    var minsUntil2 = Math.round(bestPassMin % 60);
                    var untilStr2 = hoursUntil2 > 0 ? (hoursUntil2 + "h " + minsUntil2 + "m") : (minsUntil2 + "m");
                    passStr = "  NEXT PASS in ~" + untilStr2;
                  }
                  
                  var isNearby = groundDist < 500;
                  var statusStr = isNearby ? " NEARBY  LOOK UP!" : (totalDist.toLocaleString() + " mi " + dirStr);
                  
                  var issBullet = bulletHtml(
                    "ISS TRACKER",
                    statusStr,
                    "Alt " + issAlt + " mi  " + issSpeed.toLocaleString() + " mph  " + visibility + passStr
                  );
                  
                  if(spaceEventsBulletsEl){
                    spaceEventsBulletsEl.innerHTML += issBullet;
                  }
                })
                .catch(function(err){
                  console.log("ISS tracker error:", err);
                });
            })();
          }

          // Night sky SVG (windows + cloud series)
          if (nightSkySvg){
            var bodies = ["moon","mercury","venus","mars","jupiter","saturn","uranus","neptune"];
            var startObs2 = new Date(ssLocal.getTime());
            var endObs2 = new Date(srLocal.getTime());
            if (endObs2 <= startObs2) endObs2 = new Date(startObs2.getTime() + 10*60*60*1000);

            var windows = computeVisibilityWindows(startObs2, endObs2, bodies, LOCATION.lat, LOCATION.lon);

            var nameMap = {
              moon:"Moon", mercury:"Mercury", venus:"Venus", mars:"Mars",
              jupiter:"Jupiter", saturn:"Saturn", uranus:"Uranus", neptune:"Neptune"
            };

            var show = {};
            for (var p in windows){
              if (!windows[p]) continue;
              var label = nameMap[p] || p;
              var w = windows[p];
              show[label] = {
                any: !!w.any,
                first: w.first || null,
                last: w.last || null,
                segments: w.segments || []
              };
            }

            var cloudSeries = [];
            if (hourly && hourly.time && hourly.cloudcover){
              for (var ci=0; ci<hourly.time.length; ci++){
                var dtc = new Date(hourly.time[ci]);
                if (dtc >= startObs2 && dtc <= endObs2){
                  var cc = hourly.cloudcover[ci];
                  if (typeof cc === "number" && isFinite(cc)){
                    cloudSeries.push({ t: dtc, cc: clamp(cc, 0, 100) });
                  }
                }
              }
            }

            // Fetch Kp data for aurora bar
            fetchKpDataForNight(startObs2, endObs2, function(kpSeries){
              drawNightSkyBar(nightSkySvg, nightSkyLegend, startObs2, endObs2, show, cloudSeries, kpSeries);
            });
          }

        } catch(e){
          console.error("Weather parse error", e);
          setText(condTextEl, "Data error");
        }
      })
      .catch(function(err){
        console.error("Weather load error", err);
        setText(condTextEl, "Network error");
      });
  }

  /* =========================================================
     RADAR autoplay (NWS RIDGE loop GIF)
     ========================================================= */
  var radarRefreshTimer = null;
  function startRadarNwsLoop(){
    if (!radarLiveEl || !radarImg) return;

    var STATION = LOCATION.radar || "KENX";
    var region = LOCATION.radarRegion || "NORTHEAST";
    var base = "https://radar.weather.gov/ridge/standard/" + region + "_loop.gif";

    // Update radar subtitle
    var radarSubEl = document.querySelector(".widget:has(#radar-img) .widget-sub");
    if (radarSubEl) radarSubEl.textContent = LOCATION.radarName || "NWS";

    function refresh(){
      radarImg.src = base + "?cb=" + Date.now();
      radarImg.style.filter = "invert(1) hue-rotate(180deg) contrast(1.4) saturate(1.8)";
      radarLiveEl.textContent = " LIVE";
      
      // Update timestamp
      var tsEl = document.getElementById("local-radar-timestamp");
      if (tsEl) {
        var d = new Date();
        var h = d.getHours();
        var m = d.getMinutes();
        var ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12; if (h === 0) h = 12;
        tsEl.textContent = h + ':' + (m < 10 ? '0' + m : m) + ' ' + ampm;
      }
    }

    refresh();
    if (radarRefreshTimer) clearInterval(radarRefreshTimer);
    radarRefreshTimer = setInterval(refresh, 2 * 60 * 1000);
  }

  /* Radar mode switching (reflectivity vs hydrometeor classification) */
  var currentRadarMode = "reflectivity";
  var hydroRefreshTimer = null;
  
  function loadHydrometeorImage(){
    var container = document.getElementById("radar-hydro-container");
    if (!container) return;
    
    var STATION = (LOCATION.radar || "KOKX").toLowerCase();
    var region = LOCATION.radarRegion || "NORTHEAST";
    var W = container.clientWidth || 800;
    var H = container.clientHeight || 500;
    
    /* Use the RIDGE regional static frame as base map (same as reflectivity view) */
    var ridgeBase = "https://radar.weather.gov/ridge/standard/" + region + "_0.gif?cb=" + Date.now();
    
    /* RIDGE region extents (approx lat/lon bounding boxes for WMS alignment) */
    var regionExtents = {
      "NORTHEAST":     { minLon: -82.0, minLat: 37.0, maxLon: -66.5, maxLat: 48.0 },
      "UPPERMISSVLY":  { minLon: -98.0, minLat: 38.0, maxLon: -82.0, maxLat: 50.0 },
      "SOUTHEAST":     { minLon: -92.0, minLat: 24.0, maxLon: -74.0, maxLat: 38.0 },
      "SOUTHMISSVLY":  { minLon: -100.0, minLat: 26.0, maxLon: -86.0, maxLat: 38.0 },
      "SOUTHPLAINS":   { minLon: -107.0, minLat: 26.0, maxLon: -93.0, maxLat: 38.0 },
      "CENTGRLAKES":   { minLon: -92.0, minLat: 38.0, maxLon: -76.0, maxLat: 48.0 },
      "NORTHROCKIES":  { minLon: -117.0, minLat: 40.0, maxLon: -101.0, maxLat: 50.0 },
      "SOUTHROCKIES":  { minLon: -115.0, minLat: 30.0, maxLon: -99.0, maxLat: 42.0 },
      "PACNORTHWEST":  { minLon: -128.0, minLat: 40.0, maxLon: -114.0, maxLat: 50.0 },
      "PACSOUTHWEST":  { minLon: -124.0, minLat: 30.0, maxLon: -112.0, maxLat: 42.0 },
      "NORTHPLAINS":   { minLon: -108.0, minLat: 38.0, maxLon: -94.0, maxLat: 50.0 }
    };
    
    var ext = regionExtents[region] || { minLon: LOCATION.lon - 8, minLat: LOCATION.lat - 5.5, maxLon: LOCATION.lon + 8, maxLat: LOCATION.lat + 5.5 };
    var bbox = ext.minLon + "," + ext.minLat + "," + ext.maxLon + "," + ext.maxLat;
    
    var wmsUrl = "https://opengeo.ncep.noaa.gov/geoserver/" + STATION + "/ows?" +
      "service=WMS&version=1.1.0&request=GetMap" +
      "&layers=" + STATION + "_bdhc" +
      "&styles=&bbox=" + bbox +
      "&width=" + Math.round(W) + "&height=" + Math.round(H) +
      "&srs=EPSG:4326" +
      "&format=image/png" +
      "&transparent=true" +
      "&cb=" + Date.now();
    
    var html = "";
    html += '<img src="' + ridgeBase + '" style="position:absolute;top:0;left:0;width:100%;height:100%;filter:invert(1) hue-rotate(180deg) brightness(0.4) contrast(1.2) saturate(0);z-index:1;" onerror="this.style.display=\'none\'" />';
    html += '<img src="' + wmsUrl + '" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;" onerror="this.style.display=\'none\'" />';
    
    container.innerHTML = html;
  }
  
  function switchRadarMode(mode){
    currentRadarMode = mode;
    var reflImg = document.getElementById("radar-img");
    var hydroContainer = document.getElementById("radar-hydro-container");
    var reflBtn = document.getElementById("radar-mode-refl");
    var hydroBtn = document.getElementById("radar-mode-hydro");
    var reflLegend = document.getElementById("radar-legend-refl");
    var hydroLegend = document.getElementById("radar-legend-hydro");
    var badge = document.getElementById("radar-badge");
    
    if (mode === "hydrometeor"){
      // Show hydrometeor, hide reflectivity
      if (reflImg) reflImg.style.display = "none";
      if (hydroContainer) hydroContainer.style.display = "block";
      if (reflBtn){ reflBtn.style.background = "transparent"; reflBtn.style.color = "rgba(255,255,255,.5)"; }
      if (hydroBtn){ hydroBtn.style.background = "rgba(255,255,255,.2)"; hydroBtn.style.color = "#fff"; }
      if (reflLegend) reflLegend.style.display = "none";
      if (hydroLegend) hydroLegend.style.display = "block";
      if (badge) badge.textContent = "NWS DUAL-POL";
      
      loadHydrometeorImage();
      
      // Refresh hydrometeor every 5 min
      if (hydroRefreshTimer) clearInterval(hydroRefreshTimer);
      hydroRefreshTimer = setInterval(loadHydrometeorImage, 5 * 60 * 1000);
    } else {
      // Show reflectivity, hide hydrometeor
      if (reflImg) reflImg.style.display = "block";
      if (hydroContainer) hydroContainer.style.display = "none";
      if (reflBtn){ reflBtn.style.background = "rgba(255,255,255,.2)"; reflBtn.style.color = "#fff"; }
      if (hydroBtn){ hydroBtn.style.background = "transparent"; hydroBtn.style.color = "rgba(255,255,255,.5)"; }
      if (reflLegend) reflLegend.style.display = "block";
      if (hydroLegend) hydroLegend.style.display = "none";
      if (badge) badge.textContent = "NWS RIDGE";
      
      if (hydroRefreshTimer){ clearInterval(hydroRefreshTimer); hydroRefreshTimer = null; }
    }
  }

  /* =========================================================
     AURORA (Animated from OVATION JSON)
     ========================================================= */
  var auroraAnim = {
    frames: [],
    idx: 0,
    playing: true,
    timer: null,
    refreshTimer: null,
    ctx: null
  };
  
  function startAuroraBlackBackground(){
    if (!auroraCanvas || !auroraLiveEl) return;

    auroraAnim.ctx = auroraCanvas.getContext("2d");
    var JSON_URL = "https://services.swpc.noaa.gov/products/animations/ovation_north_24h.json";
    var FALLBACK_URL = "https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg";

    function resizeToDisplaySize(){
      var parent = auroraCanvas.parentElement;
      if (!parent) return;
      var w = Math.max(1, parent.clientWidth);
      var h = Math.max(1, parent.clientHeight);
      if (auroraCanvas.width !== w || auroraCanvas.height !== h){
        auroraCanvas.width = w;
        auroraCanvas.height = h;
      }
    }

    function drawCover(img){
      var ctx = auroraAnim.ctx;
      var cw = auroraCanvas.width, ch = auroraCanvas.height;
      var iw = img.naturalWidth, ih = img.naturalHeight;
      var scale = Math.max(cw / iw, ch / ih);
      var dw = iw * scale, dh = ih * scale;
      var dx = (cw - dw) / 2;
      var dy = (ch - dh) / 2;

      ctx.clearRect(0,0,cw,ch);
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,cw,ch);
      ctx.drawImage(img, dx, dy, dw, dh);
    }

    function showFallback(){
      if (auroraFallbackImg){
        auroraFallbackImg.style.display = "block";
        auroraFallbackImg.src = FALLBACK_URL + "?cb=" + Date.now();
      }
      auroraCanvas.style.display = "none";
      auroraLiveEl.textContent = " LIVE";
    }

    function loadFrames(){
      auroraLiveEl.textContent = " LOADING";
      resizeToDisplaySize();
      
      fetchWithTimeout(JSON_URL, null, 15000)
        .then(function(r){ return r.json(); })
        .then(function(data){
          if (data && data.length > 0){
            auroraAnim.frames = data.map(function(f){
              return "https://services.swpc.noaa.gov" + f.url;
            });
            auroraAnim.idx = 0;
            auroraLiveEl.textContent = " LIVE";
            auroraCanvas.style.display = "block";
            if (auroraFallbackImg) auroraFallbackImg.style.display = "none";
            startAuroraAnimation();
          } else {
            throw new Error("No frames");
          }
        })
        .catch(function(){
          showFallback();
        });
    }
    
    function startAuroraAnimation(){
      if (auroraAnim.timer) clearTimeout(auroraAnim.timer);
      
      function step(){
        if (auroraAnim.playing && auroraAnim.frames.length > 0){
          var img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = function(){
            try {
              resizeToDisplaySize();
              drawCover(img);
            } catch(e){}
          };
          img.src = auroraAnim.frames[auroraAnim.idx];
          auroraAnim.idx = (auroraAnim.idx + 1) % auroraAnim.frames.length;
        }
        auroraAnim.timer = setTimeout(step, 200);
      }
      step();
    }

    loadFrames();
    
    if (auroraAnim.refreshTimer) clearInterval(auroraAnim.refreshTimer);
    auroraAnim.refreshTimer = setInterval(loadFrames, 5 * 60 * 1000);
    
    var resizeDebounceTimer = null;
    window.addEventListener("resize", function(){ 
      if (resizeDebounceTimer) clearTimeout(resizeDebounceTimer);
      resizeDebounceTimer = setTimeout(resizeToDisplaySize, 150);
    });
  }

    /* =========================================================
     KP DATA FOR TODAY TIMELINE (full 24 hours)
     ========================================================= */
  function fetchKpDataForToday(callback){
    var url = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json";
    
    var now = new Date();
    var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
    var todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
    
    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(rows){
        var kpSeries = [];
        
        if (!rows || rows.length < 2){
          callback(kpSeries);
          return;
        }
        
        // Find column indices
        var header = rows[0];
        var timeIdx = header.indexOf("time_tag");
        var kpIdx = header.indexOf("kp");
        
        if (timeIdx < 0 || kpIdx < 0){
          callback(kpSeries);
          return;
        }
        
        // Parse data rows
        for (var i = 1; i < rows.length; i++){
          var row = rows[i];
          if (!row || row.length <= Math.max(timeIdx, kpIdx)) continue;
          
          var timeStr = row[timeIdx];
          var kpVal = parseFloat(row[kpIdx]);
          
          if (!timeStr || isNaN(kpVal)) continue;
          
          // Parse UTC time (format: "2026-01-12 18:00:00")
          var dt = new Date(timeStr.replace(" ", "T") + "Z");
          if (!isFinite(dt.getTime())) continue;
          
          // Check if this falls within today (with buffer)
          var bufferMs = 6 * 60 * 60 * 1000;
          if (dt >= new Date(todayStart.getTime() - bufferMs) && 
              dt <= new Date(todayEnd.getTime() + bufferMs)){
            kpSeries.push({ t: dt, kp: kpVal });
          }
        }
        
        callback(kpSeries);
      })
      .catch(function(err){
        console.log("Kp data fetch error:", err);
        callback([]);
      });
  }

  /* =========================================================
     KP DATA FOR NIGHT SKY BAR
     ========================================================= */
  function fetchKpDataForNight(sunsetLocal, sunriseLocal, callback){
    var url = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json";
    
    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(rows){
        var kpSeries = [];
        
        if (!rows || rows.length < 2){
          callback(kpSeries);
          return;
        }
        
        // Find column indices
        var header = rows[0];
        var timeIdx = header.indexOf("time_tag");
        var kpIdx = header.indexOf("kp");
        
        if (timeIdx < 0 || kpIdx < 0){
          callback(kpSeries);
          return;
        }
        
        // Parse data rows
        for (var i = 1; i < rows.length; i++){
          var row = rows[i];
          if (!row || row.length <= Math.max(timeIdx, kpIdx)) continue;
          
          var timeStr = row[timeIdx];
          var kpVal = parseFloat(row[kpIdx]);
          
          if (!timeStr || isNaN(kpVal)) continue;
          
          // Parse UTC time (format: "2026-01-12 18:00:00")
          var dt = new Date(timeStr.replace(" ", "T") + "Z");
          if (!isFinite(dt.getTime())) continue;
          
          // Check if this falls within our night window (with some buffer)
          var bufferMs = 6 * 60 * 60 * 1000; // 6 hour buffer
          if (dt >= new Date(sunsetLocal.getTime() - bufferMs) && 
              dt <= new Date(sunriseLocal.getTime() + bufferMs)){
            kpSeries.push({ t: dt, kp: kpVal });
          }
        }
        
        callback(kpSeries);
      })
      .catch(function(err){
        console.log("Kp data fetch error:", err);
        callback([]);
      });
  }
  // Approximate geomagnetic latitude from geographic latitude (simplified)
  // US locations are roughly 10-12 lower geomagnetically than geographically
  function geomagLat(lat){
    return lat - 11;
  }

  // Minimum Kp needed to potentially see aurora at a given geomagnetic latitude
  // Based on SWPC guidelines: aurora oval reaches ~66 at Kp0, moves 2 equatorward per Kp level
  // But aurora can be VISIBLE on horizon ~600 miles (10) beyond the oval edge
  function minKpForLat(geomagLat){
    // For overhead aurora (oval edge)
    // Kp 0 = 66, Kp 1 = 64, ... Kp 9 = 48
    
    // For horizon visibility, subtract ~8-10 (can see ~600mi north)
    // So effective visibility: Kp 5 reaches ~56 overhead but visible from ~46
    
    if (geomagLat >= 66) return 0;  // Under the oval
    if (geomagLat >= 62) return 2;
    if (geomagLat >= 58) return 4;
    if (geomagLat >= 54) return 5;  // Northern US - Kp 5-6
    if (geomagLat >= 50) return 6;
    if (geomagLat >= 45) return 7;  // Central US - Kp 7+
    if (geomagLat >= 40) return 7;  // Mid-latitudes - strong storm
    if (geomagLat >= 35) return 8;  // Southern US - severe storm
    if (geomagLat >= 30) return 8;  // Deep south - G4+ storm
    return 9; // Below 30 geomagnetic - extreme G5 storm only
  }

  function auroraVisibilityPctFromKp(kp, lat){
    if (kp == null || isNaN(kp)) return null;
    if (lat == null) lat = 41.7; // Default to Pleasant Valley
    
    var gLat = geomagLat(lat);
    var minKp = minKpForLat(gLat);
    
    // How far above minimum Kp are we?
    var margin = kp - minKp;
    
    if (margin < 0) return 0;        // Below threshold - no chance
    if (margin < 0.5) return 5;      // Just at threshold - slim chance
    if (margin < 1) return 15;       // Slightly above - possible
    if (margin < 2) return 35;       // Good margin - likely visible
    if (margin < 3) return 60;       // Well above - very likely
    return 80;                        // Strong storm - excellent chance
  }

  function visLabel(pct){
    if (pct == null) return "--";
    if (pct <= 0) return "No";
    if (pct <= 5) return "Slim";
    return pct + "%";
  }

  function updateSolarMini(){
    if (!swKp || !swG || !swBz || !swWind || !swVis) return;

    swKp.textContent="--"; swG.textContent="--"; swBz.textContent="--"; swWind.textContent="--"; swVis.textContent="--";

    fetchWithTimeout("https://services.swpc.noaa.gov/products/wing-kp.json", null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try{
          if (!data || data.length < 2) throw new Error("No Wing Kp data");
          
          // Wing Kp format: array of arrays [time_tag, kp, kp_1hr, kp_4hr]
          // Skip header row if present
          var startIdx = (data[0] && typeof data[0][0] === 'string' && data[0][0].toLowerCase().indexOf('time') > -1) ? 1 : 0;
          
          // Get the most recent row
          var latestRow = data[data.length - 1];
          var kpVal = parseFloat(latestRow[1]); // Current Kp estimate
          
          if (isNaN(kpVal)) throw new Error("Invalid Kp value");
          
          swKp.textContent = kpVal.toFixed(1);
          
          // Determine G-scale from Kp
          var gScale = "G0";
          if (kpVal >= 9) gScale = "G5";
          else if (kpVal >= 8) gScale = "G4";
          else if (kpVal >= 7) gScale = "G3";
          else if (kpVal >= 6) gScale = "G2";
          else if (kpVal >= 5) gScale = "G1";
          
          swG.textContent = gScale;
          swVis.textContent = visLabel(auroraVisibilityPctFromKp(kpVal, LOCATION.lat));
        } catch(e){
          console.log("Wing Kp error, falling back to forecast:", e);
          // Fallback to regular Kp forecast
          fetchWithTimeout("https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json", null, 12000)
            .then(function(r){ return r.json(); })
            .then(function(rows){
              try{
                var header = rows && rows[0];
                if (!header) return;
                var kpIdx = header.indexOf("kp");
                var obsIdx = header.indexOf("observed");
                var scaleIdx = header.indexOf("noaa_scale");
                var latestRow = null;
                for (var i=rows.length-1;i>0;i--){
                  var row = rows[i];
                  if (!row || row.length <= kpIdx) continue;
                  var obsType = row[obsIdx];
                  if (obsType === "observed" || obsType === "estimated"){ latestRow = row; break; }
                }
                if (!latestRow) latestRow = rows[rows.length-1];
                var kpVal = parseFloat(latestRow[kpIdx]);
                var gScale = (scaleIdx >= 0 ? latestRow[scaleIdx] : "") || "";
                if (!isNaN(kpVal)){
                  swKp.textContent = kpVal.toFixed(1);
                  swG.textContent = gScale ? String(gScale) : "G0";
                  swVis.textContent = visLabel(auroraVisibilityPctFromKp(kpVal, LOCATION.lat));
                }
              } catch(e2){}
            })
            .catch(function(){});
        }
      })
      .catch(function(){
        console.log("Wing Kp fetch failed, trying fallback");
        // Fallback to regular Kp forecast
        fetchWithTimeout("https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json", null, 12000)
          .then(function(r){ return r.json(); })
          .then(function(rows){
            try{
              var header = rows && rows[0];
              if (!header) return;
              var kpIdx = header.indexOf("kp");
              var obsIdx = header.indexOf("observed");
              var scaleIdx = header.indexOf("noaa_scale");
              var latestRow = null;
              for (var i=rows.length-1;i>0;i--){
                var row = rows[i];
                if (!row || row.length <= kpIdx) continue;
                var obsType = row[obsIdx];
                if (obsType === "observed" || obsType === "estimated"){ latestRow = row; break; }
              }
              if (!latestRow) latestRow = rows[rows.length-1];
              var kpVal = parseFloat(latestRow[kpIdx]);
              var gScale = (scaleIdx >= 0 ? latestRow[scaleIdx] : "") || "";
              if (!isNaN(kpVal)){
                swKp.textContent = kpVal.toFixed(1);
                swG.textContent = gScale ? String(gScale) : "G0";
                swVis.textContent = visLabel(auroraVisibilityPctFromKp(kpVal, LOCATION.lat));
              }
            } catch(e2){}
          })
          .catch(function(){});
      });

    Promise.all([
      fetchWithTimeout("https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json", null, 12000).then(function(r){return r.json();}).catch(function(){return null;}),
      fetchWithTimeout("https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json", null, 12000).then(function(r){return r.json();}).catch(function(){return null;})
    ]).then(function(all){
      try{
        var plasma = all[0], mag = all[1];

        if (plasma && plasma.length > 1){
          var ph = plasma[0];
          var speedIdx = ph.indexOf("speed");
          var last = plasma[plasma.length-1];
          var spd = speedIdx >= 0 ? parseFloat(last[speedIdx]) : NaN;
          if (!isNaN(spd)) swWind.textContent = Math.round(spd) + " km/s";
        }

        if (mag && mag.length > 1){
          var mh = mag[0];
          var bzIdx = mh.indexOf("bz_gsm");
          var lastm = mag[mag.length-1];
          var bz = bzIdx >= 0 ? parseFloat(lastm[bzIdx]) : NaN;
          if (!isNaN(bz)) swBz.textContent = (bz >= 0 ? "+" : "") + bz.toFixed(1) + " nT";
        }
      } catch(e){}
    });
  }

  /* =========================================================
     GOES autoplay (NE sector)
     ========================================================= */
  var goesTimer = null;
  var goesRefreshTimer = null;
  var goesFrames = [];
  var goesImages = []; // preloaded Image objects
  var goesIdx = 0;
  var goesLength = 36; // default 6h (~6 frames/hr)
  var goesLengthLabel = '6h';
  var goesAnimId = null; // requestAnimationFrame id
  var goesAnimState = {
    currentFrame: 0,
    nextFrame: 1,
    blendProgress: 0,
    lastTime: 0,
    frameDuration: 1200, // ms per frame crossfade - long smooth blend
    pauseAtFrame: 100,   // minimal pause - nearly continuous flow
    phase: 'blend', // 'blend' or 'pause'
    pauseElapsed: 0,
    playing: true
  };

  var goesLengthMap = { '1h': 6, '6h': 36, '12h': 72, '24h': 144, '48h': 288 };

  function switchGoesLength(len){
    goesLength = goesLengthMap[len] || 36;
    goesLengthLabel = len;
    var opts = ['1h','6h','12h','24h','48h'];
    opts.forEach(function(o){
      var btn = document.getElementById('goes-len-' + o);
      if (!btn) return;
      if (o === len){
        btn.style.background = 'rgba(0,0,0,.5)'; btn.style.borderColor = 'rgba(255,255,255,.25)'; btn.style.color = '#fff';
      } else {
        btn.style.background = 'rgba(0,0,0,.3)'; btn.style.borderColor = 'rgba(255,255,255,.15)'; btn.style.color = 'rgba(255,255,255,.5)';
      }
    });
    var loopEl = document.getElementById('goes-loop');
    if (loopEl) loopEl.textContent = len;
    // Stop current playback, refetch, restart
    if (goesAnimId) { cancelAnimationFrame(goesAnimId); goesAnimId = null; }
    var overlay = document.getElementById('goes-loading-overlay');
    if (overlay) { overlay.style.display = 'flex'; overlay.style.opacity = '1'; }
    goesFrames = [];
    goesImages = [];
    goesIdx = 0;
    fetchGoesFrames().then(function(){ preloadGoesImages(); });
  }
  window.switchGoesLength = switchGoesLength;

  function fetchGoesFrames(){
    if (!goesLiveEl) return Promise.resolve();

    var goesSat = (LOCATION.goes && LOCATION.goes.sat) || "G19";
    var goesSector = (LOCATION.goes && LOCATION.goes.sector) || "ne";
    var indexUrl = "https://www.star.nesdis.noaa.gov/GOES/sector_band.php?band=GEOCOLOR&sat=" + goesSat + "&sector=" + goesSector + "&length=" + goesLength;
    goesLiveEl.textContent = " LOADING";

    return fetchWithTimeout(indexUrl, null, 12000)
      .then(function(r){ return r.text(); })
      .then(function(html){
        var goesNum = goesSat === "G18" ? "GOES18" : "GOES19";
        var re = new RegExp("https://cdn\\.star\\.nesdis\\.noaa\\.gov/" + goesNum + "/ABI/SECTOR/" + goesSector + "/GEOCOLOR/[^\"' ]+\\.jpg", "gi");
    
        var goesSubEl = document.getElementById("goes-sub");
        var sectorNames = { ne: "NORTHEAST", se: "SOUTHEAST", wus: "WEST US", umv: "UPPER MISSISSIPPI VALLEY" };
        var satName = goesSat === "G18" ? "GOES-18" : "GOES-19";
        if (goesSubEl) goesSubEl.textContent = "NESDIS/STAR " + satName + " | " + (sectorNames[goesSector] || goesSector.toUpperCase()) + "  GEOCOLOR";

        var matches = html.match(re) || [];
        var seen = Object.create(null);
        var uniq = [];

        for (var i=0;i<matches.length;i++){
          var u = matches[i];
          if (seen[u]) continue;
          seen[u] = true;
          uniq.push(u);
        }

        if (uniq.length){
          goesFrames = uniq.slice(-goesLength);
          goesIdx = 0;
          goesLiveEl.textContent = " LIVE";
          if (goesFrameEl) goesFrameEl.textContent = "--/--";
        } else {
          goesLiveEl.textContent = " OFFLINE";
        }
      })
      .catch(function(){
        goesLiveEl.textContent = " OFFLINE";
      });
  }

  function preloadGoesImages(){
    if (!goesFrames.length) return;
    goesImages = [];
    var loaded = 0;
    var total = goesFrames.length;
    var overlay = document.getElementById('goes-loading-overlay');
    var loadText = document.getElementById('goes-loading-text');
    if (overlay) { overlay.style.opacity = '1'; overlay.style.display = 'flex'; }
    if (loadText) loadText.textContent = 'CHASING CLOUDS 0/' + total;
    if (goesLiveEl) goesLiveEl.textContent = " LOADING 0%";

    goesFrames.forEach(function(url, i){
      var img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = function(){
        loaded++;
        var pct = Math.round(loaded/total*100);
        if (goesLiveEl) goesLiveEl.textContent = " LOADING " + pct + "%";
        if (loadText) loadText.textContent = 'CHASING CLOUDS ' + loaded + '/' + total;
        if (loaded === total){
          if (goesLiveEl) goesLiveEl.textContent = " LIVE";
          if (overlay) { overlay.style.opacity = '0'; setTimeout(function(){ overlay.style.display = 'none'; }, 600); }
          startGoesCanvasAnim();
        }
      };
      img.onerror = function(){
        loaded++;
        if (loaded === total){
          if (goesLiveEl) goesLiveEl.textContent = " LIVE";
          if (overlay) { overlay.style.opacity = '0'; setTimeout(function(){ overlay.style.display = 'none'; }, 600); }
          startGoesCanvasAnim();
        }
      };
      img.src = url;
      goesImages[i] = img;
    });
  }

  function drawGoesFrame(ctx, img, w, h){
    if (!img || !img.complete || !img.naturalWidth) return;
    // Cover the canvas (like object-fit:cover)
    var iw = img.naturalWidth, ih = img.naturalHeight;
    var scale = Math.max(w/iw, h/ih);
    var dw = iw * scale, dh = ih * scale;
    var dx = (w - dw) / 2, dy = (h - dh) / 2;
    ctx.drawImage(img, dx, dy, dw, dh);
  }

  function startGoesCanvasAnim(){
    if (!goesCanvas || goesImages.length < 2) {
      // If only 1 frame, just draw it
      if (goesCanvas && goesImages.length === 1){
        var ctx = goesCanvas.getContext('2d');
        var rect = goesCanvas.getBoundingClientRect();
        goesCanvas.width = rect.width * (window.devicePixelRatio || 1);
        goesCanvas.height = rect.height * (window.devicePixelRatio || 1);
        ctx.setTransform(window.devicePixelRatio || 1, 0, 0, window.devicePixelRatio || 1, 0, 0);
        drawGoesFrame(ctx, goesImages[0], rect.width, rect.height);
      }
      return;
    }

    if (goesAnimId) cancelAnimationFrame(goesAnimId);

    var s = goesAnimState;
    s.currentFrame = 0;
    s.nextFrame = 1;
    s.blendProgress = 0;
    s.lastTime = 0;
    s.phase = 'pause';
    s.pauseElapsed = 0;
    s.playing = true;

    var ctx = goesCanvas.getContext('2d');

    function animate(timestamp){
      if (!s.playing) { goesAnimId = requestAnimationFrame(animate); return; }

      var rect = goesCanvas.getBoundingClientRect();
      var dpr = window.devicePixelRatio || 1;
      if (goesCanvas.width !== Math.round(rect.width * dpr) || goesCanvas.height !== Math.round(rect.height * dpr)){
        goesCanvas.width = Math.round(rect.width * dpr);
        goesCanvas.height = Math.round(rect.height * dpr);
      }
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      var w = rect.width, h = rect.height;

      if (!s.lastTime) s.lastTime = timestamp;
      var dt = timestamp - s.lastTime;
      s.lastTime = timestamp;
      // Cap dt to avoid jumps when tab is hidden
      if (dt > 200) dt = 16;

      var n = goesImages.length;

      if (s.phase === 'pause'){
        s.pauseElapsed += dt;
        // Draw current frame fully
        ctx.globalAlpha = 1;
        drawGoesFrame(ctx, goesImages[s.currentFrame], w, h);

        if (s.pauseElapsed >= s.pauseAtFrame){
          s.phase = 'blend';
          s.blendProgress = 0;
        }
      } else {
        // Crossfade blend
        s.blendProgress += dt / s.frameDuration;
        if (s.blendProgress >= 1) s.blendProgress = 1;

        // Linear blend for continuous smooth flow
        var t = s.blendProgress;
        var ease = t;

        // Draw current frame
        ctx.globalAlpha = 1;
        drawGoesFrame(ctx, goesImages[s.currentFrame], w, h);
        // Blend next frame on top
        ctx.globalAlpha = ease;
        drawGoesFrame(ctx, goesImages[s.nextFrame], w, h);
        ctx.globalAlpha = 1;

        // Update frame counter
        if (goesFrameEl) goesFrameEl.textContent = (s.currentFrame+1) + "/" + n;

        if (s.blendProgress >= 1){
          s.currentFrame = s.nextFrame;
          s.nextFrame = (s.nextFrame + 1) % n;
          s.phase = 'pause';
          s.pauseElapsed = 0;
        }
      }

      goesAnimId = requestAnimationFrame(animate);
    }

    goesAnimId = requestAnimationFrame(animate);

    // Refresh frames periodically
    if (goesRefreshTimer) clearInterval(goesRefreshTimer);
    goesRefreshTimer = setInterval(function(){
      fetchGoesFrames().then(function(){ preloadGoesImages(); });
    }, 5 * 60 * 1000);
  }

  function startGoesAutoplay(){
    fetchGoesFrames().then(function(){ preloadGoesImages(); });
  }

  /* =========================================================
     SPACE WEATHER ANIMATIONS
     (Geospace Velocity/Density/Pressure, WSA-Enlil, LASCO C2/C3)
     ========================================================= */
  
  // Animation state for each widget
  var animations = {
    geoVel:  { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    geoDen:  { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    geoPre:  { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    enlil:   { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    lascoC3: { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    lascoC2: { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null }
  };
  

  
  // Generic animation runner
  function runAnimation(key, fps){
    var anim = animations[key];
    if (!anim || !anim.imgEl) return;
    
    function step(){
      if (anim.playing && anim.frames.length > 0){
        anim.imgEl.src = anim.frames[anim.idx];
        anim.idx = (anim.idx + 1) % anim.frames.length;
      }
      anim.timer = setTimeout(step, 1000 / fps);
    }
    step();
  }
  
  // Load animation frames from SWPC JSON
  function loadAnimationFrames(jsonUrl, key, fps, fallbackUrl){
    var anim = animations[key];
    if (!anim || !anim.imgEl) return;
    
    if (anim.liveEl) anim.liveEl.textContent = " LOADING";
    
    fetchWithTimeout(jsonUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.length > 0){
          anim.frames = data.map(function(f){
            return "https://services.swpc.noaa.gov" + f.url;
          });
          if (anim.liveEl) anim.liveEl.textContent = " LIVE";
          runAnimation(key, fps);
        } else {
          throw new Error("No frames");
        }
      })
      .catch(function(){
        // Fallback to static image
        if (fallbackUrl){
          anim.imgEl.src = fallbackUrl + "?cb=" + Date.now();
        }
        if (anim.liveEl) anim.liveEl.textContent = " LIVE";
        if (anim.btnEl) anim.btnEl.style.display = "none";
      });
  }
  
  // Load static/GIF images with periodic refresh (for sources without JSON)
  
    function initSpaceWeatherAnimations(){
    // Bind DOM elements
    animations.enlil.imgEl = document.getElementById("enlil-img");
    animations.enlil.liveEl = document.getElementById("enlil-live");
    animations.enlil.btnEl = document.getElementById("enlil-btn");
    
    animations.lascoC3.imgEl = document.getElementById("lasco-c3-img");
    animations.lascoC3.liveEl = document.getElementById("lasco-c3-live");
    animations.lascoC3.btnEl = document.getElementById("lasco-c3-btn");
    
    animations.lascoC2.imgEl = document.getElementById("lasco-c2-img");
    animations.lascoC2.liveEl = document.getElementById("lasco-c2-live");
    animations.lascoC2.btnEl = document.getElementById("lasco-c2-btn");
    
    // Load WSA-Enlil animation (8 fps - faster for solar wind)
    loadAnimationFrames(
      "https://services.swpc.noaa.gov/products/animations/enlil.json",
      "enlil", 8,
      "https://services.swpc.noaa.gov/images/animations/enlil/latest.jpg"
    );
    
    // Load LASCO animations (6 fps)
    loadAnimationFrames(
      "https://services.swpc.noaa.gov/products/animations/lasco-c3.json",
      "lascoC3", 6,
      "https://soho.nascom.nasa.gov/data/realtime/c3/512/latest.jpg"
    );
    
    loadAnimationFrames(
      "https://services.swpc.noaa.gov/products/animations/lasco-c2.json",
      "lascoC2", 6,
      "https://soho.nascom.nasa.gov/data/realtime/c2/512/latest.jpg"
    );
    
    // Load Geospace animated images
    loadGeospaceAnimations();
  }
  
  function loadGeospaceAnimations(){
    var geoWidgets = [
      { id: "geo-vel-img", liveId: "geo-vel-live", jsonUrl: "https://services.swpc.noaa.gov/products/animations/geospace/velocity.json" },
      { id: "geo-den-img", liveId: "geo-den-live", jsonUrl: "https://services.swpc.noaa.gov/products/animations/geospace/density.json" },
      { id: "geo-pre-img", liveId: "geo-pre-live", jsonUrl: "https://services.swpc.noaa.gov/products/animations/geospace/pressure.json" }
    ];
    
    geoWidgets.forEach(function(w){
      var imgEl = document.getElementById(w.id);
      var liveEl = document.getElementById(w.liveId);
      if (!imgEl) return;
      
      var frames = [];
      var frameIndex = 0;
      var animInterval = null;
      var frameDelay = 150; // 150ms = ~6.6 fps, smooth animation
      
      function fetchFrames(){
        if (liveEl) liveEl.textContent = " LOADING";
        
        fetch(w.jsonUrl + "?cb=" + Date.now())
          .then(function(r){ 
            if (!r.ok) throw new Error("Fetch failed");
            return r.json(); 
          })
          .then(function(data){
            if (!Array.isArray(data) || data.length === 0) throw new Error("No frames");
            frames = data.map(function(f){ return "https://services.swpc.noaa.gov" + f.url; });
            preloadFrames();
          })
          .catch(function(err){
            console.error("Geospace animation error:", err);
            if (liveEl) liveEl.textContent = " OFFLINE";
            imgEl.style.opacity = "0.3";
          });
      }
      
      function preloadFrames(){
        var loaded = 0;
        var total = Math.min(frames.length, 50); // Preload first 50 frames max
        
        for (var i = 0; i < total; i++){
          var img = new Image();
          img.onload = img.onerror = function(){
            loaded++;
            if (loaded >= total) startAnimation();
          };
          img.src = frames[i];
        }
      }
      
      function startAnimation(){
        if (liveEl) liveEl.textContent = " LIVE";
        imgEl.style.opacity = "1";
        frameIndex = 0;
        
        if (animInterval) clearInterval(animInterval);
        animInterval = setInterval(function(){
          imgEl.src = frames[frameIndex];
          frameIndex = (frameIndex + 1) % frames.length;
        }, frameDelay);
      }
      
      // Initial load
      fetchFrames();
      
      // Refresh frame list every 5 min (will pick up new model runs)
      setInterval(fetchFrames, 5 * 60 * 1000);
    });
  }

  /* =========================================================
     SUVI (static with refresh - not animated)
     ========================================================= */
  var suviTimer = null;

  /* =========================================================
     GFS UPPER AIR / POLAR VORTEX WIDGET
     ========================================================= */
  var gfsState = {
    activeTab: '500mb',
    fhrIndex: 0,
    playing: false,
    playTimer: null,
    cycle: '00',
    fhrs500: (function(){
      var arr = [];
      for(var i=0; i<=384; i+=6) arr.push(i.toString().padStart(3,'0'));
      return arr;
    })(),
    fhrs10: ['f00','f24','f48','f72','f96','f120','f144','f168','f192','f216','f240','f264','f288','f312','f336','f360','f384']
  };

  function getGfsCycle(){
    var now = new Date();
    var utcH = now.getUTCHours();
    var cycles = [0, 6, 12, 18];
    var bestCycle = '00';
    for(var i = cycles.length - 1; i >= 0; i--){
      if(utcH >= cycles[i] + 5 || (utcH < cycles[0] + 5 && i === cycles.length - 1)){
        bestCycle = cycles[i].toString().padStart(2,'0');
        break;
      }
    }
    if(utcH < 5) bestCycle = '18';
    return bestCycle;
  }

  function buildGfsUrl(tab, fhrIndex){
    if(tab === '500mb'){
      var fhr = gfsState.fhrs500[fhrIndex] || '000';
      return 'https://mag.ncep.noaa.gov/data/gfs/' + gfsState.cycle + '/namer/500_vort_ht/gfs_namer_' + fhr + '_500_vort_ht.gif';
    } else {
      var code = gfsState.fhrs10[fhrIndex] || 'f00';
      return 'https://www.cpc.ncep.noaa.gov/products/stratosphere/strat_a_f/gif_files/gfs_t10_nh_' + code + '.png';
    }
  }

  function getFhrLabel(tab, fhrIndex){
    if(tab === '500mb'){
      var h = parseInt(gfsState.fhrs500[fhrIndex], 10);
      if(h === 0) return 'F000  Analysis';
      var d = Math.floor(h / 24);
      var rem = h % 24;
      if(d === 0) return 'F' + gfsState.fhrs500[fhrIndex] + '  +' + h + 'h';
      return 'F' + gfsState.fhrs500[fhrIndex] + '  Day ' + d + (rem ? '+' + rem + 'h' : '');
    } else {
      var code = gfsState.fhrs10[fhrIndex];
      var hrs = parseInt(code.replace('f',''), 10);
      if(hrs === 0) return 'Analysis';
      var days = hrs / 24;
      return '+' + hrs + 'h  Day ' + days;
    }
  }

  function loadGfsFrame(){
    var tab = gfsState.activeTab;
    var imgId = tab === '500mb' ? 'gfs-500mb-img' : 'gfs-10mb-img';
    var img = document.getElementById(imgId);
    var liveEl = document.getElementById('gfs-live');
    if(!img) return;
    var url = buildGfsUrl(tab, gfsState.fhrIndex);
    img.onload = function(){ if(liveEl) liveEl.textContent = ' LIVE'; };
    img.onerror = function(){ if(liveEl) liveEl.textContent = ' OFFLINE'; };
    img.src = url;
    if(tab === '500mb'){
      img.style.filter = "invert(1) hue-rotate(180deg) contrast(1.3) saturate(1.2)";
    } else {
      img.style.filter = "invert(1) hue-rotate(180deg) contrast(1.3) saturate(1.2)";
    }
    var label = document.getElementById('gfs-fhr-label');
    if(label) label.textContent = getFhrLabel(tab, gfsState.fhrIndex);
    // Preload next frame for smoother animation
    var maxIdx = tab === '500mb' ? gfsState.fhrs500.length - 1 : gfsState.fhrs10.length - 1;
    var nextIdx = gfsState.fhrIndex + 1;
    if(nextIdx > maxIdx) nextIdx = 0;
    var preload = new Image();
    preload.src = buildGfsUrl(tab, nextIdx);
  }

  function switchGfsTab(tab){
    gfsState.activeTab = tab;
    gfsState.fhrIndex = 0;
    gfsStopPlay();
    var img500 = document.getElementById('gfs-500mb-img');
    var img10 = document.getElementById('gfs-10mb-img');
    if(img500) img500.style.display = tab === '500mb' ? '' : 'none';
    if(img10) img10.style.display = tab === '10mb' ? '' : 'none';
    var btn500 = document.getElementById('gfs-tab-500mb');
    var btn10 = document.getElementById('gfs-tab-10mb');
    if(btn500){
      btn500.style.background = tab === '500mb' ? 'rgba(255,255,255,.15)' : 'rgba(255,255,255,.06)';
      btn500.style.color = tab === '500mb' ? '#fff' : 'rgba(255,255,255,.5)';
      btn500.style.borderColor = tab === '500mb' ? 'rgba(255,255,255,.25)' : 'rgba(255,255,255,.15)';
    }
    if(btn10){
      btn10.style.background = tab === '10mb' ? 'rgba(255,255,255,.15)' : 'rgba(255,255,255,.06)';
      btn10.style.color = tab === '10mb' ? '#fff' : 'rgba(255,255,255,.5)';
      btn10.style.borderColor = tab === '10mb' ? 'rgba(255,255,255,.25)' : 'rgba(255,255,255,.15)';
    }
    loadGfsFrame();
  }

  function gfsStepFhr(dir){
    var maxIdx = gfsState.activeTab === '500mb' ? gfsState.fhrs500.length - 1 : gfsState.fhrs10.length - 1;
    gfsState.fhrIndex = Math.max(0, Math.min(maxIdx, gfsState.fhrIndex + dir));
    loadGfsFrame();
  }

  function gfsStopPlay(){
    gfsState.playing = false;
    if(gfsState.playTimer){ clearInterval(gfsState.playTimer); gfsState.playTimer = null; }
    var btn = document.getElementById('gfs-play-btn');
    if(btn) btn.textContent = '';
  }

  function gfsTogglePlay(){
    if(gfsState.playing){ gfsStopPlay(); return; }
    gfsState.playing = true;
    var btn = document.getElementById('gfs-play-btn');
    if(btn) btn.textContent = '';
    var speed = gfsState.activeTab === '500mb' ? 900 : 1200;
    gfsState.playTimer = setInterval(function(){
      var maxIdx = gfsState.activeTab === '500mb' ? gfsState.fhrs500.length - 1 : gfsState.fhrs10.length - 1;
      gfsState.fhrIndex++;
      if(gfsState.fhrIndex > maxIdx) gfsState.fhrIndex = 0;
      loadGfsFrame();
    }, speed);
  }

  function initGfsWidget(){
    gfsState.cycle = getGfsCycle();
    var cycleLabel = document.getElementById('gfs-cycle-label');
    if(cycleLabel) cycleLabel.textContent = 'Cycle: ' + gfsState.cycle + 'Z';
    loadGfsFrame();
    // Auto-start animation
    setTimeout(function(){ gfsTogglePlay(); }, 1500);
    setInterval(function(){
      var newCycle = getGfsCycle();
      if(newCycle !== gfsState.cycle){
        gfsState.cycle = newCycle;
        if(cycleLabel) cycleLabel.textContent = 'Cycle: ' + gfsState.cycle + 'Z';
        loadGfsFrame();
      }
    }, 30 * 60 * 1000);
  }

  // Expose GFS controls to global scope for inline onclick handlers
  window.switchGfsTab = switchGfsTab;
  window.gfsStepFhr = gfsStepFhr;
  window.gfsTogglePlay = gfsTogglePlay;

  /* =========================================================
     FORECAST RADAR & PRECIP TYPE (GFS/NAM-HIRES/HRRR)
     ========================================================= */
  var RIDGE_AREA_MAP = {
    'conus':'CONUS', 'namer':'CONUS-LARGE',
    'us-ne':'NORTHEAST', 'us-se':'SOUTHEAST', 'us-nc':'CENTGRLAKES', 'us-sc':'SOUTHMISSVLY',
    'us-nw':'PACNORTHWEST', 'us-sw':'PACSOUTHWEST',
    'upper-ms':'UPPERMISSVLY', 'south-ms':'SOUTHMISSVLY',
    'n-rockies':'NORTHROCKIES', 's-rockies':'SOUTHROCKIES', 's-plains':'SOUTHPLAINS',
    'alaska':'ALASKA', 'hawaii':'HAWAII', 'pr':'CARIB', 'guam':'GUAM'
  };

  var fcastState = {
    cycle: getGfsCycle(),
    idx: 0,
    playing: false,
    timer: null,
    product: 'precip_total',
    range: 'live',
    model: 'gfs',
    area: 'conus',
    allFhrs: (function(){
      var arr = [];
      for(var i = 3; i <= 84; i += 3) arr.push(i.toString().padStart(3, '0'));
      for(var i = 90; i <= 240; i += 6) arr.push(i.toString().padStart(3, '0'));
      for(var i = 252; i <= 384; i += 12) arr.push(i.toString().padStart(3, '0'));
      return arr;
    })(),
  };

  // Model area configs: which areas each model supports
  var modelAreaConfig = {
    'gfs':       {areas:['conus','namer','alaska','hawaii','north-pac','west-atl','atlantic','east-pac'], default:'conus'},
    'nam':       {areas:['conus','namer','alaska','hawaii','north-pac','west-atl','east-pac'], default:'conus'},
    'nam_hires': {areas:['conus','us-ne','us-se','us-nw','us-sw','us-nc','us-sc','alaska','hawaii','pr'], default:'us-ne'},
    'hrrr':      {areas:['conus','us-ne','us-se','us-nw','us-sw','us-nc','us-sc','alaska','hawaii','pr','guam'], default:'us-ne'},
    'href':      {areas:['conus','us-ne','us-se','us-nw','us-sw','us-nc','us-sc','alaska','hawaii','pr'], default:'us-ne'},
    'nbm':       {areas:['conus','namer','alaska','hawaii','pr'], default:'conus'},
    'gefs':      {areas:['conus','namer','north-pac','west-atl','atlantic','east-pac','alaska','arctic','europe','asia','africa'], default:'conus'}
  };

  // NAM-HIRES: 3-hourly out to 60h, cycles 00/06/12/18
  function getNamHiresFhrs(){
    var arr = [];
    for(var i = 3; i <= 60; i += 3) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // HRRR: hourly out to 48h
  function getHrrrFhrs(){
    var arr = [];
    for(var i = 1; i <= 48; i++) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // NAM (regular): hourly to 36h, 3-hourly to 84h
  function getNamFhrs(){
    var arr = [];
    for(var i = 1; i <= 36; i++) arr.push(i.toString().padStart(3, '0'));
    for(var i = 39; i <= 84; i += 3) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // HREF: hourly out to 48h
  function getHrefFhrs(){
    var arr = [];
    for(var i = 1; i <= 48; i++) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // NBM: 3-hourly out to 192h (8 days)
  function getNbmFhrs(){
    var arr = [];
    for(var i = 3; i <= 192; i += 3) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }
  // GEFS: 6-hourly out to 384h (16 days)
  function getGefsFhrs(){
    var arr = [];
    for(var i = 6; i <= 384; i += 6) arr.push(i.toString().padStart(3, '0'));
    return arr;
  }

  function getHrrrCycle(){
    var now = new Date();
    var utcH = now.getUTCHours();
    var cycles = [0, 6, 12, 18];
    var bestCycle = '00';
    for(var i = cycles.length - 1; i >= 0; i--){
      if(utcH >= cycles[i] + 4 || (utcH < cycles[0] + 4 && i === cycles.length - 1)){
        bestCycle = cycles[i].toString().padStart(2,'0');
        break;
      }
    }
    if(utcH < 4) bestCycle = '18';
    return bestCycle;
  }
  function getNamHiresCycle(){
    var now = new Date();
    var utcH = now.getUTCHours();
    var cycles = [0, 6, 12, 18];
    var bestCycle = '00';
    for(var i = cycles.length - 1; i >= 0; i--){
      if(utcH >= cycles[i] + 5 || (utcH < cycles[0] + 5 && i === cycles.length - 1)){
        bestCycle = cycles[i].toString().padStart(2,'0');
        break;
      }
    }
    if(utcH < 5) bestCycle = '18';
    return bestCycle;
  }
  // Generic 6-hourly cycle with configurable lag
  function get6hCycle(lag){
    var now = new Date();
    var utcH = now.getUTCHours();
    var cycles = [0, 6, 12, 18];
    var bestCycle = '00';
    for(var i = cycles.length - 1; i >= 0; i--){
      if(utcH >= cycles[i] + lag || (utcH < cycles[0] + lag && i === cycles.length - 1)){
        bestCycle = cycles[i].toString().padStart(2,'0');
        break;
      }
    }
    if(utcH < lag) bestCycle = '18';
    return bestCycle;
  }
  function getCycleForModel(model){
    if(model === 'gfs') return getGfsCycle();
    if(model === 'hrrr') return getHrrrCycle();
    if(model === 'nam_hires') return getNamHiresCycle();
    if(model === 'nam') return get6hCycle(5);
    if(model === 'href') return get6hCycle(5);
    if(model === 'nbm') return get6hCycle(4);
    if(model === 'gefs') return get6hCycle(7);
    return getGfsCycle();
  }

  function getActiveFhrs(){
    // LIVE mode: 10 frames from Ridge radar (9=oldest, 0=newest)
    if (fcastState.range === 'live') return ['9','8','7','6','5','4','3','2','1','0'];
    
    // Short-range models use their own FHR arrays, ignore range filters
    if (fcastState.model === 'nam_hires') return getNamHiresFhrs();
    if (fcastState.model === 'hrrr') return getHrrrFhrs();
    if (fcastState.model === 'nam') return getNamFhrs();
    if (fcastState.model === 'href') return getHrefFhrs();
    if (fcastState.model === 'nbm') return getNbmFhrs();
    if (fcastState.model === 'gefs') return getGefsFhrs();

    // GFS: 500mb uses same 6-hourly intervals as allFhrs
    // 10mb uses 24-hourly intervals
    if (fcastState.product === '10mb'){
      var arr10 = [];
      for (var i = 0; i <= 384; i += 24) arr10.push(i.toString().padStart(3,'0'));
      return arr10;
    }
    if (fcastState.product === '500mb'){
      var arr500 = [];
      for (var i = 0; i <= 384; i += 6) arr500.push(i.toString().padStart(3,'0'));
      return arr500;
    }
    if (fcastState.range === 'tomorrow'){
      var cycleHour = parseInt(fcastState.cycle, 10);
      var now = new Date();
      var cycleDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), cycleHour));
      if (cycleDate > now) cycleDate.setUTCDate(cycleDate.getUTCDate() - 1);
      var tomorrowStart = new Date(now); tomorrowStart.setDate(tomorrowStart.getDate() + 1); tomorrowStart.setHours(0,0,0,0);
      var tomorrowEnd = new Date(tomorrowStart); tomorrowEnd.setDate(tomorrowEnd.getDate() + 1);
      var minH = Math.max(3, Math.ceil((tomorrowStart.getTime() - cycleDate.getTime()) / 3600000));
      var maxH = Math.ceil((tomorrowEnd.getTime() - cycleDate.getTime()) / 3600000);
      var result = fcastState.allFhrs.filter(function(f){ var h = parseInt(f,10); return h >= minH && h <= maxH; });
      // Fallback: if empty, show first 24h worth
      if (result.length === 0) {
        result = fcastState.allFhrs.filter(function(f){ return parseInt(f,10) <= 48; });
      }
      return result;
    }
    var maxH = fcastState.range === '48h' ? 48 : fcastState.range === '72h' ? 72 : (fcastState.range === '7d' ? 168 : 9999);
    return fcastState.allFhrs.filter(function(f){ return parseInt(f,10) <= maxH; });
  }

  function buildFcastUrl(fhrIdx){
    var fhrs = getActiveFhrs();
    var fhr = fhrs[fhrIdx] || '0';
    
    // LIVE mode: use NOAA Ridge radar
    if (fcastState.range === 'live'){
      var region = RIDGE_AREA_MAP[fcastState.area] || 'CONUS';
      return 'https://radar.weather.gov/ridge/standard/' + region + '_' + fhr + '.gif?cb=' + Math.floor(Date.now()/60000);
    }

    var area = fcastState.area;
    var cycle = fcastState.cycle;
    var base = 'https://mag.ncep.noaa.gov/data/';

    // Shared product map for high-res models (HRRR, NAM-HIRES, HREF, NAM)
    var hiresProductMap = {
      'sim_radar':'sim_radar_comp', 'precip_type':'precip_rate_type', 'precip_total':'precip_ptot',
      'snow_accum':'snow_total', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
      'humidity':'700_rh_ht', 'cape':'sfc_cape_cin',
      'max_ref':'sim_radar_max', 'radar_1km':'sim_radar_1km', 'precip_1hr':'precip_p01',
      'best_cape':'best_cape_cin', 'helicity':'helicity_3km', 'updraft':'max_updraft_hlcy',
      'echo_top':'echo_top', 'lightning':'lightning', 'max_wind':'10m_maxwnd',
      'visibility':'vis', 'ceiling':'ceiling', '850temp':'850_temp_mslp_precip',
      '500vort':'500_vort_ht', '250wind':'250_wnd'
    };

    // NAM-HIRES  flat: /data/nam-hires/{HH}/nam-hires_{area}_{FHR}_{product}.gif
    if (fcastState.model === 'nam_hires'){
      var prod = hiresProductMap[fcastState.product] || 'sim_radar_comp';
      return base + 'nam-hires/' + cycle + '/nam-hires_' + area + '_' + fhr + '_' + prod + '.gif';
    }

    // HRRR  flat with 00 suffix: /data/hrrr/{HH}/hrrr_{area}_{FHR}00_{product}.gif
    if (fcastState.model === 'hrrr'){
      var hrrrOverrides = {'wind':'10m_wnd_sfc_gust'};
      var prod = hrrrOverrides[fcastState.product] || hiresProductMap[fcastState.product] || 'sim_radar_comp';
      return base + 'hrrr/' + cycle + '/hrrr_' + area + '_' + fhr + '00_' + prod + '.gif';
    }

    // NAM (regular)  flat: /data/nam/{HH}/nam_{area}_{FHR}_{product}.gif
    if (fcastState.model === 'nam'){
      var namProdMap = {
        'sim_radar':'sim_radar_comp', 'precip_type':'precip_rate_type', 'precip_total':'precip_ptot',
        'snow_accum':'snodpth_chng', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
        'humidity':'700_rh_ht', 'cape':'850_pw_ht', 'precip_6hr':'precip_p06', 'precip_24hr':'precip_p24',
        'low_thick':'1000_850_thick', 'mid_thick':'850_700_thick', 'wnd_temp':'10m_wnd_2m_temp',
        'gfs_850temp':'850_temp_ht', 'gfs_850vort':'850_vort_ht', 'gfs_500wind':'500_wnd_ht',
        'gfs_500rh':'500_rh_ht', 'jet_stream':'250_wnd_ht', 'gfs_fourpanel':'850vor_500ht_200wd',
        '850temp':'850_temp_mslp_precip', '500vort':'500_vort_ht', '250wind':'250_wnd_ht'
      };
      var prod = namProdMap[fcastState.product] || 'sim_radar_comp';
      return base + 'nam/' + cycle + '/nam_' + area + '_' + fhr + '_' + prod + '.gif';
    }

    // HREF  flat with mean_ prefix: /data/href/{HH}/href_{area}_{FHR}_mean_{product}.gif
    if (fcastState.model === 'href'){
      var prod = hiresProductMap[fcastState.product] || 'sim_radar_comp';
      return base + 'href/' + cycle + '/href_' + area + '_' + fhr + '_mean_' + prod + '.gif';
    }

    // NBM  flat: /data/nbm/{HH}/nbm_{area}_{FHR}_{product}.gif
    if (fcastState.model === 'nbm'){
      var nbmProdMap = {
        'sim_radar':'sim_radar_comp', 'precip_type':'precip_rate_type', 'precip_total':'precip_ptot',
        'snow_accum':'snodpth_chng', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
        'humidity':'700_rh_ht', 'cape':'850_pw_ht', 'precip_1hr':'precip_p01',
        'precip_6hr':'precip_p06', 'precip_24hr':'precip_p24'
      };
      var prod = nbmProdMap[fcastState.product] || 'sim_radar_comp';
      return base + 'nbm/' + cycle + '/nbm_' + area + '_' + fhr + '_' + prod + '.gif';
    }

    // GEFS  flat: /data/gefs-mean-sprd/{HH}/gefs-mean-sprd_{area}_{FHR}_{product}.gif
    if (fcastState.model === 'gefs'){
      var gefsProdMap = {
        'sim_radar':'sim_radar_comp', 'precip_total':'precip_ptot', 'precip_type':'precip_rate_type',
        'snow_accum':'snodpth_chng', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
        'humidity':'700_rh_ht', 'cape':'850_pw_ht', 'precip_6hr':'precip_p06', 'precip_24hr':'precip_p24',
        'jet_stream':'250_wnd_ht', '500vort':'500_vort_ht', 'gfs_850temp':'850_temp_ht',
        'gfs_500wind':'500_wnd_ht', 'gfs_500rh':'500_rh_ht'
      };
      var prod = gefsProdMap[fcastState.product] || 'precip_p06';
      return base + 'gefs-mean-sprd/' + cycle + '/gefs-mean-sprd_' + area + '_' + fhr + '_' + prod + '.gif';
    }

    // GFS model  subfolder pattern: /data/gfs/{HH}/{area}/{product}/gfs_{area}_{FHR}_{product}.gif
    var gfsProdMap = {
      'sim_radar':'sim_radar_comp', 'precip_type':'precip_rate_type', 'precip_total':'precip_ptot',
      'snow_accum':'snodpth_chng', 'temperature':'1000_500_thick', 'wind':'10m_wnd_precip',
      'humidity':'700_rh_ht', 'cape':'850_pw_ht', 'jet_stream':'250_wnd_ht',
      'precip_6hr':'precip_p06', 'precip_24hr':'precip_p24',
      'low_thick':'1000_850_thick', 'mid_thick':'850_700_thick', 'wnd_temp':'10m_wnd_2m_temp',
      'gfs_850temp':'850_temp_ht', 'gfs_850vort':'850_vort_ht', 'gfs_500wind':'500_wnd_ht',
      'gfs_500rh':'500_rh_ht', 'gfs_fourpanel':'850vor_500ht_200wd'
    };
    // Special cases
    if (fcastState.product === '500mb'){
      return base + 'gfs/' + cycle + '/namer/500_vort_ht/gfs_namer_' + fhr + '_500_vort_ht.gif';
    }
    if (fcastState.product === '10mb'){
      var h = parseInt(fhr, 10);
      var code = 'f' + h.toString().padStart(2,'0');
      return 'https://www.cpc.ncep.noaa.gov/products/stratosphere/strat_a_f/gif_files/gfs_t10_nh_' + code + '.png';
    }
    var gfsProd = gfsProdMap[fcastState.product] || 'sim_radar_comp';
    return base + 'gfs/' + cycle + '/' + area + '/' + gfsProd + '/gfs_' + area + '_' + fhr + '_' + gfsProd + '.gif';
  }

  function getFcastLabel(fhrIdx){
    var fhrs = getActiveFhrs();
    
    // LIVE mode: show relative time
    if (fcastState.range === 'live'){
      var frameNum = parseInt(fhrs[fhrIdx], 10);
      if (frameNum === 0) return 'NOW';
      var minsAgo = frameNum * 2; // ~2 min per frame
      return '~' + minsAgo + ' MIN AGO';
    }
    
    var h = parseInt(fhrs[fhrIdx], 10);
    var cycleHour = parseInt(fcastState.cycle, 10);
    var now = new Date();
    var cycleDate = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), cycleHour));
    if (cycleDate > now) cycleDate.setUTCDate(cycleDate.getUTCDate() - 1);
    var targetUTC = new Date(cycleDate.getTime() + h * 3600000);
    var fullDays = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
    var dayName = fullDays[targetUTC.getDay()];
    var mon = targetUTC.getMonth() + 1;
    var date = targetUTC.getDate();
    var hr = targetUTC.getHours();
    var ampm = hr >= 12 ? 'PM' : 'AM';
    hr = hr % 12; if (hr === 0) hr = 12;
    var today = new Date();
    var isToday = targetUTC.toDateString() === today.toDateString();
    var tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
    var isTomorrow = targetUTC.toDateString() === tomorrow.toDateString();
    var prefix = isToday ? 'TODAY' : (isTomorrow ? 'TOMORROW' : dayName);
    return prefix + ' ' + mon + '/' + date + ' ' + hr + ampm + '  (+' + h + 'H)';
  }

  function loadFcastRadar(){
    var fhrs = getActiveFhrs();
    var img = document.getElementById('fcast-radar-img');
    var label = document.getElementById('fcast-radar-label');
    if (!fhrs || fhrs.length === 0){
      if (label) label.textContent = 'No data for range';
      return;
    }
    
    // LIVE mode: use Ridge individual frames
    if (fcastState.range === 'live'){
      var region = RIDGE_AREA_MAP[fcastState.area] || 'CONUS';
      var frameNum = fhrs[fcastState.idx] || '0';
      var url = 'https://radar.weather.gov/ridge/standard/' + region + '_' + frameNum + '.gif?cb=' + Math.floor(Date.now()/60000);
      if (img) {
        img.onerror = function(){ img.style.opacity = '0.3'; };
        img.onload = function(){ img.style.opacity = '1'; };
        img.src = url;
        // Custom sizing per region to better match forecast framing
        var liveSize = {
          'CONUS':       {w:'90%',h:'90%',top:'48%',left:'54%'},
          'NORTHEAST':   {w:'105%',h:'105%',top:'47%',left:'52%'},
          'SOUTHEAST':   {w:'105%',h:'105%',top:'47%',left:'52%'},
          'CENTGRLAKES': {w:'105%',h:'105%',top:'47%',left:'52%'},
          'PACNORTHWEST':{w:'105%',h:'105%',top:'47%',left:'52%'},
          'PACSOUTHWEST':{w:'105%',h:'105%',top:'47%',left:'52%'},
          'UPPERMISSVLY':{w:'105%',h:'105%',top:'47%',left:'52%'},
          'SOUTHMISSVLY':{w:'105%',h:'105%',top:'47%',left:'52%'},
          'NORTHROCKIES':{w:'105%',h:'105%',top:'47%',left:'52%'},
          'SOUTHROCKIES':{w:'105%',h:'105%',top:'47%',left:'52%'},
          'SOUTHPLAINS': {w:'105%',h:'105%',top:'47%',left:'52%'},
          'ALASKA':      {w:'100%',h:'100%',top:'48%',left:'50%'},
          'HAWAII':      {w:'100%',h:'100%',top:'48%',left:'50%'},
          'CARIB':       {w:'100%',h:'100%',top:'48%',left:'50%'},
          'GUAM':        {w:'100%',h:'100%',top:'48%',left:'50%'}
        };
        var sz = liveSize[region] || {w:'106%',h:'106%',top:'47%',left:'50%'};
        img.style.width = sz.w; img.style.height = sz.h;
        img.style.top = sz.top; img.style.left = sz.left;
      }
      if (label){
        var n = parseInt(frameNum, 10);
        label.textContent = n === 0 ? 'NOW' : '~' + (n * 2) + ' MIN AGO';
      }
      return;
    }
    
    var url = buildFcastUrl(fcastState.idx);
    if (img) {
      img.onerror = function(){ img.style.opacity = '0.3'; };
      img.onload = function(){ img.style.opacity = '1'; };
      img.src = url;
    }
    if (label) label.textContent = getFcastLabel(fcastState.idx);
  }

  function fcastRadarStep(dir){
    var fhrs = getActiveFhrs();
    fcastState.idx = Math.max(0, Math.min(fhrs.length - 1, fcastState.idx + dir));
    loadFcastRadar();
  }

  function fcastRadarTogglePlay(){
    var btn = document.getElementById('fcast-radar-play-btn');
    if (fcastState.playing){
      clearInterval(fcastState.timer);
      fcastState.playing = false;
      if (btn) btn.textContent = '';
    } else {
      fcastState.playing = true;
      if (btn) btn.textContent = '';
      var interval = fcastState.range === 'live' ? 1200 : 500;
      fcastState.timer = setInterval(function(){
        var fhrs = getActiveFhrs();
        fcastState.idx++;
        if (fcastState.idx >= fhrs.length) fcastState.idx = 0;
        loadFcastRadar();
      }, interval);
    }
  }

  function updateFcastBadge(){
    var badge = document.getElementById('fcast-badge');
    if (!badge) return;
    var prodLabels = {'precip_type':'PRECIP TYPE','snow_accum':'SNOW ACCUMULATION','precip_total':'PRECIP TOTALS','wind':'WIND & MSLP','cape': (fcastState.model === 'gfs' ? 'PRECIP WATER 850MB' : 'CAPE & CIN'),'temperature':'THICKNESS & PRECIP','jet_stream':'JET STREAM 250MB','humidity':'700MB HUMIDITY','500mb':'500MB VORTICITY','10mb':'10MB STRATOSPHERE','max_ref':'MAX REFLECTIVITY','radar_1km':'1KM REFLECTIVITY','precip_1hr':'1HR PRECIP','best_cape':'BEST CAPE','helicity':'3KM HELICITY','updraft':'UPDRAFT HELICITY','echo_top':'ECHO TOPS','lightning':'LIGHTNING','max_wind':'MAX WIND','visibility':'VISIBILITY','ceiling':'CEILING','850temp':'850MB TEMP','500vort':'500MB VORTICITY','250wind':'250MB JETS','precip_6hr':'6HR PRECIP','precip_24hr':'24HR PRECIP','low_thick':'1000-850 THICKNESS','mid_thick':'850-700 THICKNESS','wnd_temp':'WIND & 2M TEMP','gfs_850temp':'850MB TEMP','gfs_850vort':'850MB VORTICITY','gfs_500wind':'500MB WIND','gfs_500rh':'500MB HUMIDITY','gfs_fourpanel':'4-PANEL COMPOSITE'};
    var prod = prodLabels[fcastState.product] || 'SIM RADAR';
    var modelLabels = {'gfs':'GFS','nam':'NAM','nam_hires':'NAM 3KM','hrrr':'HRRR 3KM','href':'HREF','nbm':'NBM','gefs':'GEFS'};
    var areaLabels = {'conus':'CONUS','namer':'NAMER','us-ne':'NE','us-se':'SE','us-nc':'NC','us-sc':'SC','us-nw':'NW','us-sw':'SW','alaska':'AK','hawaii':'HI','pr':'PR','guam':'GU','north-pac':'N PAC','east-pac':'E PAC','west-atl':'W ATL','atlantic':'ATL','arctic':'ARC','europe':'EUR','asia':'ASIA','africa':'AFR'};
    var modelName = (modelLabels[fcastState.model] || 'GFS') + ' ' + (areaLabels[fcastState.area] || '');
    if (fcastState.range === 'live'){
      var ridgeAreaLabels = {'conus':'CONUS','namer':'CONUS','us-ne':'NORTHEAST','us-se':'SOUTHEAST','us-nc':'CENT GL','us-sc':'S MISS VLY','us-nw':'PAC NW','us-sw':'PAC SW','upper-ms':'UP MISS VLY','south-ms':'S MISS VLY','n-rockies':'N ROCKIES','s-rockies':'S ROCKIES','s-plains':'S PLAINS','alaska':'ALASKA','hawaii':'HAWAII','pr':'CARIBBEAN','guam':'GUAM'};
      badge.textContent = 'LIVE RADAR ' + (ridgeAreaLabels[fcastState.area] || 'CONUS');
    } else {
      badge.textContent = modelName + ' ' + prod;
    }
  }

  function switchFcastRange(range){
    if (fcastState.playing) fcastRadarTogglePlay();
    fcastState.range = range;
    fcastState.idx = 0;
    
    // Style range buttons
    var ranges = ['live','tomorrow','48h','72h','7d','16d'];
    ranges.forEach(function(r){
      var btn = document.getElementById('fcast-range-' + r);
      if (!btn) return;
      if (r === range){
        if (r === 'live'){
          btn.style.background = 'rgba(34,197,94,.3)';
          btn.style.borderColor = 'rgba(34,197,94,.5)';
          btn.style.color = '#22c55e';
        } else {
          btn.style.background = 'rgba(0,0,0,.5)';
          btn.style.borderColor = 'rgba(255,255,255,.25)';
          btn.style.color = '#fff';
        }
      } else {
        if (r === 'live'){
          btn.style.background = 'rgba(34,197,94,.2)';
          btn.style.borderColor = 'rgba(34,197,94,.5)';
          btn.style.color = '#22c55e';
        } else {
          btn.style.background = 'rgba(0,0,0,.3)';
          btn.style.borderColor = 'rgba(255,255,255,.15)';
          btn.style.color = 'rgba(255,255,255,.5)';
        }
      }
    });
    
    // Image filter
    var img = document.getElementById('fcast-radar-img');
    if (img){
      if (range === 'live'){
        img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.1) saturate(1.4) brightness(0.95)';
      } else {
        img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.2) saturate(1.5)';
        img.style.width = '106%';
        img.style.height = '106%';
        img.style.top = '47%';
        img.style.left = '50%';
      }
    }
    
    // Hide/show model buttons and product panel based on LIVE vs forecast
    var isLive = (range === 'live');
    // Model buttons - always visible
    ['gfs','nam','nam_hires','hrrr','href','nbm','gefs'].forEach(function(m){
      var btn = document.getElementById('fcast-model-' + m);
      if (btn) btn.style.display = '';
    });
    // MODELS sub-label - always visible
    var modelsLabel = document.getElementById('fcast-models-label');
    if (modelsLabel) modelsLabel.style.display = '';
    // FORECAST label
    var fcLabel = document.getElementById('fcast-forecast-label');
    if (fcLabel) fcLabel.style.display = '';
    // Forecast range buttons - always visible so user can switch back
    var rangeArea = document.getElementById('fcast-range-area');
    if (rangeArea) rangeArea.style.display = 'flex';
    // Right-side product panel
    var rightPanel = document.getElementById('fcast-tab-sim');
    if (rightPanel && rightPanel.parentElement) {
      rightPanel.parentElement.style.display = isLive ? 'none' : 'flex';
    }
    // Source link
    var srcLink = document.getElementById('fcast-source-link');
    if (srcLink) srcLink.style.display = isLive ? 'none' : '';
    
    // Area buttons: show Ridge regions for LIVE, model regions for forecast
    if (isLive) {
      var liveAreas = ['conus','us-ne','us-se','us-nw','us-sw','upper-ms','south-ms','n-rockies','s-rockies','s-plains','us-nc','alaska','hawaii','pr','guam'];
      allAreaIds.forEach(function(a){
        var btn = document.getElementById('fcast-area-' + a);
        if (btn) {
          btn.style.display = liveAreas.indexOf(a) !== -1 ? '' : 'none';
          if (a === fcastState.area){
            btn.style.background = 'rgba(74,158,255,.3)'; btn.style.borderColor = 'rgba(74,158,255,.5)'; btn.style.color = '#4a9eff';
          } else {
            btn.style.background = 'rgba(0,0,0,.3)'; btn.style.borderColor = 'rgba(255,255,255,.15)'; btn.style.color = 'rgba(255,255,255,.5)';
          }
        }
      });
      // If current area isn't in live areas, default to conus
      if (liveAreas.indexOf(fcastState.area) === -1) {
        fcastState.area = 'conus';
        var cb = document.getElementById('fcast-area-conus');
        if (cb) { cb.style.background = 'rgba(74,158,255,.3)'; cb.style.borderColor = 'rgba(74,158,255,.5)'; cb.style.color = '#4a9eff'; }
      }
    } else {
      // Fallback area if current area isn't valid for current model
      var cfg = modelAreaConfig[fcastState.model] || {areas:['conus'], default:'conus'};
      if (cfg.areas.indexOf(fcastState.area) === -1) {
        fcastState.area = cfg.default;
      }
      updateAreaButtons(fcastState.model);
    }
    
    updateFcastBadge();
    loadFcastRadar();
    fcastRadarTogglePlay();
  }

  function switchFcastProduct(prod){
    if (fcastState.playing) fcastRadarTogglePlay();
    fcastState.product = prod;
    fcastState.idx = 0;
    
    // If in LIVE mode and user clicks a product, switch to default forecast range
    if (fcastState.range === 'live'){
      deactivateFcastLive();
      var modelMaxH = {'gfs':384,'gefs':384,'nam':84,'nam_hires':60,'hrrr':48,'href':48,'nbm':264};
      var maxH = modelMaxH[fcastState.model] || 384;
      fcastState.range = maxH >= 384 ? '16d' : (maxH >= 168 ? '7d' : (maxH >= 72 ? '72h' : '48h'));
      // Re-style range buttons
      switchFcastRange(fcastState.range);
      return;
    }
    var allBtns = ['fcast-tab-sim','fcast-tab-ptype','fcast-tab-snow','fcast-tab-ptot','fcast-tab-wind','fcast-tab-cape','fcast-tab-temp','fcast-tab-jet','fcast-tab-rh','fcast-tab-500mb','fcast-tab-10mb','fcast-tab-maxref','fcast-tab-radar1km','fcast-tab-precip1hr','fcast-tab-bestcape','fcast-tab-helicity','fcast-tab-updraft','fcast-tab-echotop','fcast-tab-lightning','fcast-tab-maxwind','fcast-tab-vis','fcast-tab-ceiling','fcast-tab-850temp','fcast-tab-500vort','fcast-tab-250wind','fcast-tab-precip6hr','fcast-tab-precip24hr','fcast-tab-lowthick','fcast-tab-midthick','fcast-tab-wndtemp','fcast-tab-gfs850temp','fcast-tab-gfs850vort','fcast-tab-gfs500wind','fcast-tab-gfs500rh','fcast-tab-gfs4panel'];
    var activeMap = {'sim_radar':'fcast-tab-sim','precip_type':'fcast-tab-ptype','snow_accum':'fcast-tab-snow','precip_total':'fcast-tab-ptot','wind':'fcast-tab-wind','cape':'fcast-tab-cape','temperature':'fcast-tab-temp','jet_stream':'fcast-tab-jet','humidity':'fcast-tab-rh','500mb':'fcast-tab-500mb','10mb':'fcast-tab-10mb','max_ref':'fcast-tab-maxref','radar_1km':'fcast-tab-radar1km','precip_1hr':'fcast-tab-precip1hr','best_cape':'fcast-tab-bestcape','helicity':'fcast-tab-helicity','updraft':'fcast-tab-updraft','echo_top':'fcast-tab-echotop','lightning':'fcast-tab-lightning','max_wind':'fcast-tab-maxwind','visibility':'fcast-tab-vis','ceiling':'fcast-tab-ceiling','850temp':'fcast-tab-850temp','500vort':'fcast-tab-500vort','250wind':'fcast-tab-250wind','precip_6hr':'fcast-tab-precip6hr','precip_24hr':'fcast-tab-precip24hr','low_thick':'fcast-tab-lowthick','mid_thick':'fcast-tab-midthick','wnd_temp':'fcast-tab-wndtemp','gfs_850temp':'fcast-tab-gfs850temp','gfs_850vort':'fcast-tab-gfs850vort','gfs_500wind':'fcast-tab-gfs500wind','gfs_500rh':'fcast-tab-gfs500rh','gfs_fourpanel':'fcast-tab-gfs4panel'};
    allBtns.forEach(function(id){
      var btn = document.getElementById(id);
      if (!btn) return;
      if (id === activeMap[prod]){
        btn.style.background = 'rgba(0,0,0,.5)'; btn.style.borderColor = 'rgba(255,255,255,.25)'; btn.style.color = '#fff';
      } else {
        btn.style.background = 'rgba(0,0,0,.3)'; btn.style.borderColor = 'rgba(255,255,255,.15)'; btn.style.color = 'rgba(255,255,255,.5)';
      }
    });
    // Adjust image sizing for different products
    var img = document.getElementById('fcast-radar-img');
    if (img){
      if (prod === '500mb' || prod === '10mb'){
        img.style.width = '100%'; img.style.height = '100%';
        img.style.top = '46%'; img.style.left = '50%';
        img.style.objectFit = 'contain';
        img.style.objectPosition = 'center top';
      } else {
        img.style.width = '106%'; img.style.height = '106%';
        img.style.top = '47%'; img.style.left = '50%';
        img.style.objectFit = 'contain';
        img.style.objectPosition = 'center center';
      }
      img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.2) saturate(1.5)';
    }
    updateFcastBadge();
    // If in LIVE mode, just reload live radar and skip forecast play
    if (fcastState.range === 'live'){
      loadFcastRadar();
      if (!fcastState.playing) fcastRadarTogglePlay();
      return;
    }
    loadFcastRadar();
    fcastRadarTogglePlay();
  }

  function initFcastWidgets(){
    fcastState.cycle = getGfsCycle();
    fcastState.idx = 0;
    
    // Map user's radarRegion to LIVE area ID
    var regionToArea = {
      'NORTHEAST':'us-ne', 'SOUTHEAST':'us-se', 'CENTGRLAKES':'us-nc',
      'PACNORTHWEST':'us-nw', 'PACSOUTHWEST':'us-sw',
      'UPPERMISSVLY':'upper-ms', 'SOUTHMISSVLY':'south-ms',
      'NORTHROCKIES':'n-rockies', 'SOUTHROCKIES':'s-rockies', 'SOUTHPLAINS':'s-plains',
      'ALASKA':'alaska', 'HAWAII':'hawaii', 'CARIB':'pr', 'GUAM':'guam'
    };
    var localArea = regionToArea[LOCATION.radarRegion] || 'conus';
    
    // Set state to LIVE + local area before any UI calls
    fcastState.range = 'live';
    fcastState.area = localArea;
    
    // Now trigger UI updates
    switchFcastRange('live');
    
    // Highlight correct area button after range switch has shown LIVE areas
    allAreaIds.forEach(function(a){
      var btn = document.getElementById('fcast-area-' + a);
      if (!btn) return;
      if (a === localArea){
        btn.style.background = 'rgba(74,158,255,.3)'; btn.style.borderColor = 'rgba(74,158,255,.5)'; btn.style.color = '#4a9eff';
      } else {
        btn.style.background = 'rgba(0,0,0,.3)'; btn.style.borderColor = 'rgba(255,255,255,.15)'; btn.style.color = 'rgba(255,255,255,.5)';
      }
    });
    
    updateFcastBadge();
  }

  // Define which product groups each model type supports
  var hiresModels = ['hrrr','nam_hires','href'];
  var gfsLikeModels = ['gfs','nam','nbm','gefs'];

  function switchFcastModel(model){
    if (fcastState.playing) fcastRadarTogglePlay();
    fcastState.model = model;
    fcastState.idx = 0;
    fcastState.cycle = getCycleForModel(model);

    // Set default area for this model
    var cfg = modelAreaConfig[model] || {areas:['conus'], default:'conus'};
    if (cfg.areas.indexOf(fcastState.area) === -1) {
      fcastState.area = cfg.default;
    }

    // Product fallback: if current product isn't available on new model
    var hrOnlyProducts = ['max_ref','radar_1km','precip_1hr','best_cape','helicity','updraft','echo_top','lightning','max_wind','visibility','ceiling','850temp','500vort','250wind'];
    var gfsExclusive = ['500mb','10mb','gfs_fourpanel']; // Only GFS has these
    var gfsOnlyProducts = gfsExclusive.concat(['precip_6hr','precip_24hr','low_thick','mid_thick','wnd_temp','gfs_850temp','gfs_850vort','gfs_500wind','gfs_500rh','jet_stream']);

    if (hiresModels.indexOf(model) !== -1) {
      if (gfsOnlyProducts.indexOf(fcastState.product) !== -1) fcastState.product = 'sim_radar';
    } else if (model === 'nbm') {
      // NBM has limited products
      var nbmValid = ['sim_radar','precip_type','precip_total','snow_accum','temperature','wind','humidity','cape'];
      if (nbmValid.indexOf(fcastState.product) === -1) fcastState.product = 'precip_total';
    } else if (model === 'gefs') {
      var gefsValid = ['sim_radar','precip_total','precip_type','snow_accum','temperature','wind','humidity','cape','precip_6hr','precip_24hr','jet_stream','gfs_850temp','gfs_500wind','gfs_500rh'];
      if (gefsValid.indexOf(fcastState.product) === -1) fcastState.product = 'precip_total';
    } else if (model === 'nam') {
      // NAM has most GFS products except 500mb/10mb/fourpanel
      if (hrOnlyProducts.indexOf(fcastState.product) !== -1 || gfsExclusive.indexOf(fcastState.product) !== -1) fcastState.product = 'sim_radar';
    } else {
      // GFS  fall back from hires-only
      if (hrOnlyProducts.indexOf(fcastState.product) !== -1) fcastState.product = 'sim_radar';
    }

    // Range buttons: only show for GFS and GEFS (long-range models)
    var rangeArea = document.getElementById('fcast-range-area');
    if (rangeArea) {
      rangeArea.style.display = 'flex';
      // Show range buttons appropriate for model's max forecast hours
      var modelMaxH = {'gfs':384,'gefs':384,'nam':84,'nam_hires':60,'hrrr':48,'href':48,'nbm':264};
      var maxH = modelMaxH[model] || 384;
      var rangeHours = {'tomorrow':48,'48h':48,'72h':72,'7d':168,'16d':384};
      ['tomorrow','48h','72h','7d','16d'].forEach(function(r){
        var btn = document.getElementById('fcast-range-' + r);
        if (btn) btn.style.display = rangeHours[r] <= maxH ? '' : 'none';
      });
    }

    // Show/hide hires-only product tabs
    var hrBtns = ['fcast-tab-maxref','fcast-tab-radar1km','fcast-tab-precip1hr','fcast-tab-bestcape','fcast-tab-helicity','fcast-tab-updraft','fcast-tab-echotop','fcast-tab-lightning','fcast-tab-maxwind','fcast-tab-vis','fcast-tab-ceiling','fcast-tab-850temp','fcast-tab-500vort','fcast-tab-250wind'];
    var isHires = hiresModels.indexOf(model) !== -1;
    hrBtns.forEach(function(id){
      var btn = document.getElementById(id);
      if (btn) btn.style.display = isHires ? '' : 'none';
    });
    var hrrrDiv = document.getElementById('fcast-hrrr-divider');
    if (hrrrDiv) hrrrDiv.style.display = isHires ? '' : 'none';
    var severeLabel = document.getElementById('fcast-severe-label');
    if (severeLabel) severeLabel.style.display = isHires ? '' : 'none';
    var aviationLabel = document.getElementById('fcast-aviation-label');
    if (aviationLabel) aviationLabel.style.display = isHires ? '' : 'none';

    // Show/hide GFS-like product tabs based on specific model capabilities
    var gfsBtns = ['fcast-tab-jet','fcast-tab-500mb','fcast-tab-10mb','fcast-tab-precip6hr','fcast-tab-precip24hr','fcast-tab-lowthick','fcast-tab-midthick','fcast-tab-wndtemp','fcast-tab-gfs850temp','fcast-tab-gfs850vort','fcast-tab-gfs500wind','fcast-tab-gfs500rh','fcast-tab-gfs4panel'];
    if (model === 'gfs') {
      gfsBtns.forEach(function(id){ var b = document.getElementById(id); if(b) b.style.display = ''; });
    } else if (model === 'nam') {
      // NAM has most but not 500mb/10mb/fourpanel
      gfsBtns.forEach(function(id){ var b = document.getElementById(id); if(b) b.style.display = ''; });
      ['fcast-tab-500mb','fcast-tab-10mb','fcast-tab-gfs4panel'].forEach(function(id){ var b = document.getElementById(id); if(b) b.style.display = 'none'; });
    } else if (model === 'gefs') {
      // GEFS has some upper air but not thickness/wind-temp/fourpanel
      gfsBtns.forEach(function(id){ var b = document.getElementById(id); if(b) b.style.display = ''; });
      ['fcast-tab-500mb','fcast-tab-10mb','fcast-tab-lowthick','fcast-tab-midthick','fcast-tab-wndtemp','fcast-tab-gfs850vort','fcast-tab-gfs4panel'].forEach(function(id){ var b = document.getElementById(id); if(b) b.style.display = 'none'; });
    } else if (model === 'nbm') {
      // NBM has very limited products  hide all GFS extras
      gfsBtns.forEach(function(id){ var b = document.getElementById(id); if(b) b.style.display = 'none'; });
    } else {
      // Hires models  hide all GFS products
      gfsBtns.forEach(function(id){ var b = document.getElementById(id); if(b) b.style.display = 'none'; });
    }

    // Update CAPE button label
    var capeBtn = document.getElementById('fcast-tab-cape');
    if (capeBtn) capeBtn.textContent = isHires ? 'CAPE' : 'Precip Water';

    // Update source link
    var srcLink = document.getElementById('fcast-source-link');
    if (srcLink){
      var srcMap = {
        'gfs':       {text:'GFS NCEP',        url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=gfs&area=conus'},
        'nam':       {text:'NAM NCEP',         url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=nam&area=conus'},
        'nam_hires': {text:'NAM HIRES NCEP',   url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=nam-hires&area=US-NE'},
        'hrrr':      {text:'HRRR NCEP',        url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=HRRR&area=US-NE'},
        'href':      {text:'HREF NCEP',        url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=HREF&area=US-NE'},
        'nbm':       {text:'NBM NCEP',         url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=NBM&area=conus'},
        'gefs':      {text:'GEFS NCEP',        url:'https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=gefs-mean-sprd&area=conus'}
      };
      var src = srcMap[model] || srcMap['gfs'];
      srcLink.textContent = src.text;
      srcLink.href = src.url;
    }

    // Update model button styles
    ['gfs','nam','nam_hires','hrrr','href','nbm','gefs'].forEach(function(m){
      var btn = document.getElementById('fcast-model-' + m);
      if (!btn) return;
      if (m === model){
        btn.style.background = 'rgba(74,158,255,.3)'; btn.style.borderColor = 'rgba(74,158,255,.5)'; btn.style.color = '#4a9eff';
      } else {
        btn.style.background = 'rgba(0,0,0,.3)'; btn.style.borderColor = 'rgba(255,255,255,.15)'; btn.style.color = 'rgba(255,255,255,.5)';
      }
    });

    // Update area buttons
    updateAreaButtons(model);
    updateFcastBadge();
    
    // If in LIVE mode, just reload the live radar (model doesn't matter for live)
    if (fcastState.range === 'live'){
      loadFcastRadar();
      if (!fcastState.playing) fcastRadarTogglePlay();
      return;
    }
    switchFcastProduct(fcastState.product);
  }

  var allAreaIds = ['conus','namer','us-ne','us-se','us-nc','us-sc','us-nw','us-sw','alaska','hawaii','pr','guam','upper-ms','south-ms','n-rockies','s-rockies','s-plains','north-pac','east-pac','west-atl','atlantic','arctic','europe','asia','africa'];

  function switchFcastArea(area){
    if (fcastState.playing) fcastRadarTogglePlay();
    fcastState.area = area;
    fcastState.idx = 0;
    allAreaIds.forEach(function(a){
      var btn = document.getElementById('fcast-area-' + a);
      if (!btn) return;
      if (a === area){
        btn.style.background = 'rgba(74,158,255,.3)'; btn.style.borderColor = 'rgba(74,158,255,.5)'; btn.style.color = '#4a9eff';
      } else {
        btn.style.background = 'rgba(0,0,0,.3)'; btn.style.borderColor = 'rgba(255,255,255,.15)'; btn.style.color = 'rgba(255,255,255,.5)';
      }
    });
    // Reload for area change in LIVE mode
    if (fcastState.range === 'live'){
      var img = document.getElementById('fcast-radar-img');
      if (img) img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.1) saturate(1.4) brightness(0.95)';
    }
    updateFcastBadge();
    loadFcastRadar();
    if (!fcastState.playing) fcastRadarTogglePlay();
  }

  function updateAreaButtons(model){
    var cfg = modelAreaConfig[model] || {areas:['conus'], default:'conus'};
    allAreaIds.forEach(function(a){
      var btn = document.getElementById('fcast-area-' + a);
      if (!btn) return;
      var show = cfg.areas.indexOf(a) !== -1;
      btn.style.display = show ? '' : 'none';
      if (a === fcastState.area){
        btn.style.background = 'rgba(74,158,255,.3)'; btn.style.borderColor = 'rgba(74,158,255,.5)'; btn.style.color = '#4a9eff';
      } else {
        btn.style.background = 'rgba(0,0,0,.3)'; btn.style.borderColor = 'rgba(255,255,255,.15)'; btn.style.color = 'rgba(255,255,255,.5)';
      }
    });
  }

  window.fcastRadarStep = fcastRadarStep;
  window.fcastRadarTogglePlay = fcastRadarTogglePlay;
  window.switchFcastProduct = switchFcastProduct;
  window.switchFcastRange = switchFcastRange;
  window.switchFcastModel = switchFcastModel;
  window.switchFcastArea = switchFcastArea;

  /* ---- LIVE RADAR MAP (RainViewer tiles in Leaflet) ---- */
  var fcastLiveMap = null;
  var fcastLiveFrames = [];
  var fcastLiveLayers = [];
  var fcastLiveIdx = 0;
  var fcastLiveHost = '';
  var fcastLiveTimer = null;
  var fcastLiveLabel = null;

  // Region view configs: [lat, lng, zoom]
  var LIVE_REGION_VIEWS = {
    'conus':[39,-96,4], 'us-ne':[42,-73,5], 'us-se':[33,-84,5],
    'us-nw':[46,-120,5], 'us-sw':[35,-117,5], 'us-nc':[44,-90,5],
    'upper-ms':[43,-92,5], 'south-ms':[33,-90,5],
    'n-rockies':[46,-110,5], 's-rockies':[37,-107,5], 's-plains':[33,-98,5],
    'alaska':[64,-153,4], 'hawaii':[20,-156,6], 'pr':[18,-66,7], 'guam':[13.4,144.8,8]
  };

  function initFcastLiveMap(){
    if (fcastLiveMap) return;
    var container = document.getElementById('fcast-live-map');
    if (!container) return;
    fcastLiveMap = L.map(container, {
      center:[39,-96], zoom:4, zoomControl:false, attributionControl:false,
      dragging:true, scrollWheelZoom:true, doubleClickZoom:true, touchZoom:true
    });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png',{
      maxZoom:10, opacity:0.6
    }).addTo(fcastLiveMap);
    // State/country borders
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png',{
      maxZoom:10, opacity:0.4
    }).addTo(fcastLiveMap);
    fcastLiveLabel = document.getElementById('fcast-radar-label');
  }

  function loadFcastLiveFrames(){
    fetch('https://api.rainviewer.com/public/weather-maps.json')
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (!data.radar || !data.radar.past) return;
        fcastLiveHost = data.host;
        var all = data.radar.past.slice();
        if (data.radar.nowcast) all = all.concat(data.radar.nowcast);
        
        // Remove old layers
        fcastLiveLayers.forEach(function(l){ if(l && fcastLiveMap.hasLayer(l)) fcastLiveMap.removeLayer(l); });
        fcastLiveLayers = [];
        fcastLiveFrames = all;
        
        // Pre-load all frames
        all.forEach(function(frame){
          var url = fcastLiveHost + frame.path + '/256/{z}/{x}/{y}/6/1_1.png';
          var layer = L.tileLayer(url,{opacity:0,maxZoom:10}).addTo(fcastLiveMap);
          fcastLiveLayers.push(layer);
        });
        
        fcastLiveIdx = data.radar.past.length - 1;
        showFcastLiveFrame(fcastLiveIdx);
        startFcastLiveLoop();
      })
      .catch(function(e){ console.log('LIVE radar error:', e); });
  }

  function showFcastLiveFrame(idx){
    if (!fcastLiveMap || fcastLiveLayers.length === 0) return;
    if (idx < 0 || idx >= fcastLiveLayers.length) return;
    fcastLiveLayers.forEach(function(l,i){ if(l) l.setOpacity(i === idx ? 0.7 : 0); });
    fcastLiveIdx = idx;
    // Update label
    if (fcastLiveLabel && fcastLiveFrames[idx]){
      var t = new Date(fcastLiveFrames[idx].time * 1000);
      var h = t.getHours(); var ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12; if(h===0) h=12;
      var m = ('0'+t.getMinutes()).slice(-2);
      var nowIdx = -1;
      for(var i=0;i<fcastLiveFrames.length;i++){ if(fcastLiveFrames[i].path && fcastLiveFrames[i].path.indexOf('nowcast')===-1) nowIdx=i; }
      var label = h+':'+m+' '+ampm;
      if (idx > nowIdx) label += ' (FORECAST)';
      fcastLiveLabel.textContent = label;
    }
  }

  function startFcastLiveLoop(){
    stopFcastLiveLoop();
    fcastLiveTimer = setInterval(function(){
      fcastLiveIdx++;
      if (fcastLiveIdx >= fcastLiveLayers.length) fcastLiveIdx = 0;
      showFcastLiveFrame(fcastLiveIdx);
    }, 600);
  }

  function stopFcastLiveLoop(){
    if (fcastLiveTimer){ clearInterval(fcastLiveTimer); fcastLiveTimer = null; }
  }

  function activateFcastLive(){
    var img = document.getElementById('fcast-radar-img');
    var mapDiv = document.getElementById('fcast-live-map');
    if (img) img.style.display = 'none';
    if (mapDiv) mapDiv.style.display = '';
    initFcastLiveMap();
    // Set view for current area
    var view = LIVE_REGION_VIEWS[fcastState.area] || LIVE_REGION_VIEWS['conus'];
    fcastLiveMap.setView([view[0],view[1]], view[2]);
    loadFcastLiveFrames();
    var playBtn = document.getElementById('fcast-radar-play-btn');
    if (playBtn) playBtn.textContent = '';
  }

  function deactivateFcastLive(){
    stopFcastLiveLoop();
    var img = document.getElementById('fcast-radar-img');
    var mapDiv = document.getElementById('fcast-live-map');
    if (img) img.style.display = '';
    if (mapDiv) mapDiv.style.display = 'none';
  }

  function updateFcastLiveView(){
    if (!fcastLiveMap) return;
    var view = LIVE_REGION_VIEWS[fcastState.area] || LIVE_REGION_VIEWS['conus'];
    fcastLiveMap.setView([view[0],view[1]], view[2], {animate:true});
  }


  /* =========================================================
     LOCATION SWITCHER
     ========================================================= */
  function initLocationSwitcher(){
    var locIndex = 0;
    var dotsEl = document.getElementById("loc-dots");
    var prevBtn = document.getElementById("loc-prev");
    var nextBtn = document.getElementById("loc-next");
    
    if (!dotsEl || !prevBtn || !nextBtn) return;
    
    // Find current location index
    for (var i = 0; i < LOCATIONS.length; i++){
      if (LOCATIONS[i].id === LOCATION.id){ locIndex = i; break; }
    }
    
    // Build dots
    function renderDots(){
      dotsEl.innerHTML = "";
      for (var i = 0; i < LOCATIONS.length; i++){
        var dot = document.createElement("div");
        dot.className = "loc-dot" + (i === locIndex ? " active" : "");
        dotsEl.appendChild(dot);
      }
    }
    renderDots();
    
    function cycleTo(newIndex){
      if (window.locationSwitching) return;
      locIndex = (newIndex + LOCATIONS.length) % LOCATIONS.length;
      var newLoc = LOCATIONS[locIndex];
      
      renderDots();
      switchLocation(newLoc.id);
    }
    
    prevBtn.addEventListener("click", function(){ cycleTo(locIndex - 1); });
    nextBtn.addEventListener("click", function(){ cycleTo(locIndex + 1); });

    // Search location button
    var searchToggle = document.getElementById("loc-search-toggle");
    var searchBox = document.getElementById("loc-search-box");
    var searchInput = document.getElementById("loc-search-input");
    var searchClose = document.getElementById("loc-search-close");

    function openSearchBox(){
      if(searchBox) searchBox.classList.add("open");
      if(searchToggle) searchToggle.classList.add("active");
      var dots = document.getElementById("loc-dots");
      var prev = document.getElementById("loc-prev");
      var next = document.getElementById("loc-next");
      if(dots) dots.style.opacity = "0";
      if(prev) prev.style.opacity = "0";
      if(next) next.style.opacity = "0";
      if(locNameEl) locNameEl.style.opacity = "0";
      setTimeout(function(){ if(searchInput) searchInput.focus(); }, 220);
    }
    function closeSearchBox(){
      if(searchBox) searchBox.classList.remove("open");
      if(searchToggle) searchToggle.classList.remove("active");
      if(searchInput){ searchInput.value = ""; searchInput.blur(); }
      var dots = document.getElementById("loc-dots");
      var prev = document.getElementById("loc-prev");
      var next = document.getElementById("loc-next");
      if(dots) dots.style.opacity = "1";
      if(prev) prev.style.opacity = "1";
      if(next) next.style.opacity = "1";
      if(locNameEl) locNameEl.style.opacity = "1";
    }

    if(searchToggle){
      searchToggle.addEventListener("click", function(){
        if(searchBox && searchBox.classList.contains("open")) closeSearchBox();
        else openSearchBox();
      });
    }
    if(searchClose){
      searchClose.addEventListener("click", function(){ closeSearchBox(); });
    }
    // Close on click outside
    document.addEventListener("click", function(e){
      if(searchBox && searchBox.classList.contains("open")){
        if(!searchBox.contains(e.target) && e.target !== searchToggle){
          closeSearchBox();
        }
      }
    });
    if (gpsBtn){
      gpsBtn.addEventListener("click", function(){
        if (!navigator.geolocation){
          alert("Geolocation is not supported by your browser.");
          return;
        }
        gpsBtn.classList.add("loading");
        navigator.geolocation.getCurrentPosition(function(pos){
          gpsBtn.classList.remove("loading");
          gpsBtn.classList.add("active");
          var lat = Math.round(pos.coords.latitude * 10000) / 10000;
          var lon = Math.round(pos.coords.longitude * 10000) / 10000;

          // Auto-detect nearest NWS radar
          var RADARS = [
            {id:"KENX",name:"NWS Albany",lat:42.59,lon:-73.99,region:"NORTHEAST"},
            {id:"KOKX",name:"NWS Upton",lat:40.87,lon:-72.86,region:"NORTHEAST"},
            {id:"KBOX",name:"NWS Taunton",lat:41.96,lon:-71.14,region:"NORTHEAST"},
            {id:"KDIX",name:"NWS Mt Holly",lat:39.95,lon:-74.41,region:"NORTHEAST"},
            {id:"KLWX",name:"NWS Sterling",lat:38.98,lon:-77.49,region:"NORTHEAST"},
            {id:"KBUF",name:"NWS Buffalo",lat:42.95,lon:-78.74,region:"NORTHEAST"},
            {id:"KCLX",name:"NWS Charleston",lat:32.66,lon:-81.04,region:"SOUTHEAST"},
            {id:"KFFC",name:"NWS Peachtree",lat:33.36,lon:-84.57,region:"SOUTHEAST"},
            {id:"KTBW",name:"NWS Tampa",lat:27.71,lon:-82.40,region:"SOUTHEAST"},
            {id:"KAMX",name:"NWS Miami",lat:25.61,lon:-80.41,region:"SOUTHEAST"},
            {id:"KJAX",name:"NWS Jacksonville",lat:30.48,lon:-81.70,region:"SOUTHEAST"},
            {id:"KBMX",name:"NWS Birmingham",lat:33.17,lon:-86.77,region:"SOUTHEAST"},
            {id:"KLOT",name:"NWS Chicago",lat:41.60,lon:-88.08,region:"UPPERMISSVLY"},
            {id:"KMKX",name:"NWS Milwaukee",lat:42.97,lon:-88.55,region:"UPPERMISSVLY"},
            {id:"KDTX",name:"NWS Detroit",lat:42.70,lon:-83.47,region:"UPPERMISSVLY"},
            {id:"KMPX",name:"NWS Minneapolis",lat:44.85,lon:-93.57,region:"UPPERMISSVLY"},
            {id:"KILX",name:"NWS Lincoln",lat:40.15,lon:-89.34,region:"UPPERMISSVLY"},
            {id:"KIND",name:"NWS Indianapolis",lat:39.71,lon:-86.28,region:"UPPERMISSVLY"},
            {id:"KLSX",name:"NWS St Louis",lat:38.70,lon:-90.68,region:"CENTGRTLAKES"},
            {id:"KEAX",name:"NWS Kansas City",lat:38.81,lon:-94.26,region:"CENTGRTLAKES"},
            {id:"KFWS",name:"NWS Dallas",lat:32.57,lon:-97.30,region:"SOUTHPLAINS"},
            {id:"KEWX",name:"NWS Austin",lat:29.70,lon:-98.03,region:"SOUTHPLAINS"},
            {id:"KHGX",name:"NWS Houston",lat:29.47,lon:-95.08,region:"SOUTHPLAINS"},
            {id:"KOUN",name:"NWS Norman",lat:35.24,lon:-97.46,region:"SOUTHPLAINS"},
            {id:"KUEX",name:"NWS Hastings",lat:40.32,lon:-98.44,region:"NORTHPLAINS"},
            {id:"KABR",name:"NWS Aberdeen",lat:45.46,lon:-98.41,region:"NORTHPLAINS"},
            {id:"KVTX",name:"NWS Los Angeles",lat:34.41,lon:-119.18,region:"PACSOUTHWEST"},
            {id:"KMUX",name:"NWS San Francisco",lat:37.16,lon:-121.90,region:"PACNORTHWEST"},
            {id:"KATX",name:"NWS Seattle",lat:48.19,lon:-122.50,region:"PACNORTHWEST"},
            {id:"KRTX",name:"NWS Portland",lat:45.72,lon:-122.97,region:"PACNORTHWEST"},
            {id:"KCBX",name:"NWS Boise",lat:43.49,lon:-116.24,region:"PACNORTHWEST"},
            {id:"KPUX",name:"NWS Pueblo",lat:38.46,lon:-104.18,region:"CENTGRTLAKES"},
            {id:"KSLC",name:"NWS Salt Lake",lat:40.97,lon:-111.93,region:"CENTGRTLAKES"},
            {id:"KFGZ",name:"NWS Flagstaff",lat:35.23,lon:-111.20,region:"PACSOUTHWEST"},
            {id:"KIWA",name:"NWS Phoenix",lat:33.29,lon:-111.67,region:"PACSOUTHWEST"},
            {id:"KLRX",name:"NWS Elko",lat:40.74,lon:-116.80,region:"PACNORTHWEST"},
            {id:"KREV",name:"NWS Reno",lat:39.51,lon:-119.46,region:"PACNORTHWEST"}
          ];

          var nearestRadar = RADARS[0];
          var minDist = 999999;
          for (var r = 0; r < RADARS.length; r++){
            var dlat = lat - RADARS[r].lat;
            var dlon = lon - RADARS[r].lon;
            var d = dlat*dlat + dlon*dlon;
            if (d < minDist){ minDist = d; nearestRadar = RADARS[r]; }
          }

          // Auto-detect GOES sector
          var goesSat = lon < -105 ? "G18" : "G19";
          var goesSector;
          if (lon < -105) goesSector = "wus";
          else if (lat > 38) goesSector = "ne";
          else goesSector = "se";

          // Auto-detect timezone
          var guessTz = "America/New_York";
          if (lon < -115) guessTz = "America/Los_Angeles";
          else if (lon < -105) guessTz = "America/Denver";
          else if (lon < -90) guessTz = "America/Chicago";

          // Reverse geocode for location name
          var locName = "My Location";
          fetch("https://api.open-meteo.com/v1/forecast?latitude=" + lat + "&longitude=" + lon + "&current=temperature_2m&timezone=auto")
            .then(function(r){ return r.json(); })
            .then(function(data){
              if (data && data.timezone) guessTz = data.timezone;

              // Build the GPS location object
              var gpsLoc = {
                id: "gps",
                name: locName,
                lat: lat,
                lon: lon,
                tz: guessTz,
                radar: nearestRadar.id,
                radarName: nearestRadar.name,
                radarRegion: nearestRadar.region,
                goes: { sat: goesSat, sector: goesSector }
              };

              // Add or replace GPS entry in LOCATIONS
              var gpsIdx = -1;
              for (var g = 0; g < LOCATIONS.length; g++){
                if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
              }
              if (gpsIdx >= 0){
                LOCATIONS[gpsIdx] = gpsLoc;
              } else {
                LOCATIONS.push(gpsLoc);
                gpsIdx = LOCATIONS.length - 1;
              }

              locIndex = gpsIdx;
              renderDots();
              switchLocation("gps");
            })
            .catch(function(){
              // Fallback without timezone detection
              var gpsLoc = {
                id: "gps",
                name: locName,
                lat: lat,
                lon: lon,
                tz: guessTz,
                radar: nearestRadar.id,
                radarName: nearestRadar.name,
                radarRegion: nearestRadar.region,
                goes: { sat: goesSat, sector: goesSector }
              };
              var gpsIdx = -1;
              for (var g = 0; g < LOCATIONS.length; g++){
                if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
              }
              if (gpsIdx >= 0){
                LOCATIONS[gpsIdx] = gpsLoc;
              } else {
                LOCATIONS.push(gpsLoc);
                gpsIdx = LOCATIONS.length - 1;
              }
              locIndex = gpsIdx;
              renderDots();
              switchLocation("gps");
            });
        }, function(err){
          gpsBtn.classList.remove("loading");
          if (err.code === 1) alert("Location access denied. Please enable location permissions.");
          else alert("Could not get your location. Please try again.");
        }, { enableHighAccuracy: true, timeout: 10000 });
      });
    }
    
    // Search location input
    var searchInput = document.getElementById("loc-search-input");
    if (searchInput){
      searchInput.addEventListener("keydown", function(e){
        if (e.key !== "Enter") return;
        var q = searchInput.value.trim();
        if (!q) return;
        searchInput.disabled = true;
        searchInput.placeholder = "Searching...";
        var url = "https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(q) + "&count=1&language=en&format=json";
        fetch(url).then(function(r){ return r.json(); }).then(function(data){
          searchInput.disabled = false;
          searchInput.placeholder = "City or zip...";
          if (!data.results || !data.results.length){
            alert("Location not found. Try a different search.");
            return;
          }
          var r = data.results[0];
          var lat = Math.round(r.latitude * 10000) / 10000;
          var lon = Math.round(r.longitude * 10000) / 10000;
          var name = r.name || "Custom";
          var RADARS = [
            {id:"KENX",name:"NWS Albany",lat:42.59,lon:-73.99,region:"NORTHEAST"},
            {id:"KOKX",name:"NWS Upton",lat:40.87,lon:-72.86,region:"NORTHEAST"},
            {id:"KBOX",name:"NWS Taunton",lat:41.96,lon:-71.14,region:"NORTHEAST"},
            {id:"KDIX",name:"NWS Mt Holly",lat:39.95,lon:-74.41,region:"NORTHEAST"},
            {id:"KLWX",name:"NWS Sterling",lat:38.98,lon:-77.49,region:"NORTHEAST"},
            {id:"KBUF",name:"NWS Buffalo",lat:42.95,lon:-78.74,region:"NORTHEAST"},
            {id:"KCLX",name:"NWS Charleston",lat:32.66,lon:-81.04,region:"SOUTHEAST"},
            {id:"KFFC",name:"NWS Peachtree",lat:33.36,lon:-84.57,region:"SOUTHEAST"},
            {id:"KTBW",name:"NWS Tampa",lat:27.71,lon:-82.40,region:"SOUTHEAST"},
            {id:"KAMX",name:"NWS Miami",lat:25.61,lon:-80.41,region:"SOUTHEAST"},
            {id:"KJAX",name:"NWS Jacksonville",lat:30.48,lon:-81.70,region:"SOUTHEAST"},
            {id:"KBMX",name:"NWS Birmingham",lat:33.17,lon:-86.77,region:"SOUTHEAST"},
            {id:"KLOT",name:"NWS Chicago",lat:41.60,lon:-88.08,region:"UPPERMISSVLY"},
            {id:"KMKX",name:"NWS Milwaukee",lat:42.97,lon:-88.55,region:"UPPERMISSVLY"},
            {id:"KDTX",name:"NWS Detroit",lat:42.70,lon:-83.47,region:"UPPERMISSVLY"},
            {id:"KMPX",name:"NWS Minneapolis",lat:44.85,lon:-93.57,region:"UPPERMISSVLY"},
            {id:"KILX",name:"NWS Lincoln",lat:40.15,lon:-89.34,region:"UPPERMISSVLY"},
            {id:"KIND",name:"NWS Indianapolis",lat:39.71,lon:-86.28,region:"UPPERMISSVLY"},
            {id:"KLSX",name:"NWS St Louis",lat:38.70,lon:-90.68,region:"CENTGRTLAKES"},
            {id:"KEAX",name:"NWS Kansas City",lat:38.81,lon:-94.26,region:"CENTGRTLAKES"},
            {id:"KFWS",name:"NWS Dallas",lat:32.57,lon:-97.30,region:"SOUTHPLAINS"},
            {id:"KEWX",name:"NWS Austin",lat:29.70,lon:-98.03,region:"SOUTHPLAINS"},
            {id:"KHGX",name:"NWS Houston",lat:29.47,lon:-95.08,region:"SOUTHPLAINS"},
            {id:"KOUN",name:"NWS Norman",lat:35.24,lon:-97.46,region:"SOUTHPLAINS"},
            {id:"KUEX",name:"NWS Hastings",lat:40.32,lon:-98.44,region:"NORTHPLAINS"},
            {id:"KABR",name:"NWS Aberdeen",lat:45.46,lon:-98.41,region:"NORTHPLAINS"},
            {id:"KVTX",name:"NWS Los Angeles",lat:34.41,lon:-119.18,region:"PACSOUTHWEST"},
            {id:"KMUX",name:"NWS San Francisco",lat:37.16,lon:-121.90,region:"PACNORTHWEST"},
            {id:"KATX",name:"NWS Seattle",lat:48.19,lon:-122.50,region:"PACNORTHWEST"},
            {id:"KRTX",name:"NWS Portland",lat:45.72,lon:-122.97,region:"PACNORTHWEST"},
            {id:"KCBX",name:"NWS Boise",lat:43.49,lon:-116.24,region:"PACNORTHWEST"},
            {id:"KPUX",name:"NWS Pueblo",lat:38.46,lon:-104.18,region:"CENTGRTLAKES"},
            {id:"KSLC",name:"NWS Salt Lake",lat:40.97,lon:-111.93,region:"CENTGRTLAKES"},
            {id:"KFGZ",name:"NWS Flagstaff",lat:35.23,lon:-111.20,region:"PACSOUTHWEST"},
            {id:"KIWA",name:"NWS Phoenix",lat:33.29,lon:-111.67,region:"PACSOUTHWEST"},
            {id:"KLRX",name:"NWS Elko",lat:40.74,lon:-116.80,region:"PACNORTHWEST"},
            {id:"KREV",name:"NWS Reno",lat:39.51,lon:-119.46,region:"PACNORTHWEST"}
          ];
          var nearestRadar = RADARS[0];
          var minDist = 999999;
          for (var ri = 0; ri < RADARS.length; ri++){
            var dlat = lat - RADARS[ri].lat;
            var dlon = lon - RADARS[ri].lon;
            var d = dlat*dlat + dlon*dlon;
            if (d < minDist){ minDist = d; nearestRadar = RADARS[ri]; }
          }
          var goesSat = lon < -105 ? "G18" : "G19";
          var goesSector = lon < -105 ? "wus" : (lat > 38 ? "ne" : "se");
          var guessTz = "America/New_York";
          if (lon < -115) guessTz = "America/Los_Angeles";
          else if (lon < -105) guessTz = "America/Denver";
          else if (lon < -90) guessTz = "America/Chicago";
          if (r.timezone) guessTz = r.timezone;

          var searchLoc = {
            id: "search",
            name: name,
            lat: lat,
            lon: lon,
            tz: guessTz,
            radar: nearestRadar.id,
            radarName: nearestRadar.name,
            radarRegion: nearestRadar.region,
            goes: { sat: goesSat, sector: goesSector }
          };
          var sIdx = -1;
          for (var g = 0; g < LOCATIONS.length; g++){
            if (LOCATIONS[g].id === "search"){ sIdx = g; break; }
          }
          if (sIdx >= 0) LOCATIONS[sIdx] = searchLoc;
          else { LOCATIONS.push(searchLoc); sIdx = LOCATIONS.length - 1; }

          locIndex = sIdx;
          renderDots();
          switchLocation("search");
          searchInput.value = "";
          closeSearchBox();
        }).catch(function(){
          searchInput.disabled = false;
          searchInput.placeholder = "City or zip...";
          alert("Search failed. Please try again.");
        });
      });
    }

    // GPS "Use My Location" button
    var gpsBtn = document.getElementById("loc-gps");
    if (gpsBtn){
      gpsBtn.addEventListener("click", function(){
        if (!navigator.geolocation){
          alert("Geolocation is not supported by your browser.");
          return;
        }
        gpsBtn.classList.add("loading");
        navigator.geolocation.getCurrentPosition(function(pos){
          gpsBtn.classList.remove("loading");
          gpsBtn.classList.add("active");
          var lat = Math.round(pos.coords.latitude * 10000) / 10000;
          var lon = Math.round(pos.coords.longitude * 10000) / 10000;
          resolveAndSwitch(lat, lon, "My Location");
        }, function(err){
          gpsBtn.classList.remove("loading");
          if (err.code === 1) alert("Location access denied. Please enable location permissions.");
          else alert("Could not get your location. Please try again.");
        }, { enableHighAccuracy: true, timeout: 10000 });
      });
    }

    // ======= LOCATION AUTOCOMPLETE =======
    var suggestionsEl = document.getElementById("loc-suggestions");
    var suggestDebounce = null;
    var suggestResults = [];
    var suggestIndex = -1;

    function showSuggestions(results){
      if (!suggestionsEl || !results || results.length === 0){ hideSuggestions(); return; }
      suggestResults = results.slice(0, 5);
      suggestIndex = -1;
      var html = '';
      suggestResults.forEach(function(r, i){
        var region = r.admin1 || '';
        var country = r.country_code || r.country || '';
        var sub = [region, country].filter(Boolean).join(', ');
        var fc = r.feature_code || '';
        var icon = '';
        if (fc.indexOf('PPL') === 0) icon = '';
        else if (fc.indexOf('PRK') >= 0 || fc === 'RESF' || fc === 'RESN') icon = '';
        else if (fc.indexOf('MT') >= 0 || fc === 'PK') icon = '';
        else if (fc.indexOf('LK') >= 0 || fc === 'RSV' || fc === 'STM') icon = '';
        else if (fc === 'AIRP' || fc === 'AIRF') icon = '';
        else if (fc.indexOf('SCH') >= 0 || fc === 'UNIV') icon = '';
        var isLast = i === suggestResults.length - 1;
        html += '<div class="loc-suggest-item" data-idx="' + i + '" style="padding:9px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;' + (isLast ? '' : 'border-bottom:1px solid rgba(255,255,255,.1);') + 'transition:background .15s ease;">';
        html += '<span style="font-size:.7rem;opacity:.7;flex-shrink:0;width:18px;text-align:center;">' + icon + '</span>';
        html += '<div style="min-width:0;flex:1;">';
        html += '<div style="font-size:.6rem;font-weight:700;color:rgba(255,255,255,.9);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.01em;">' + r.name + '</div>';
        if (sub) html += '<div style="font-size:.45rem;color:rgba(255,255,255,.45);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;letter-spacing:.02em;">' + sub + '</div>';
        html += '</div></div>';
      });
      suggestionsEl.innerHTML = html;
      suggestionsEl.style.display = 'block';
      suggestionsEl.querySelectorAll('.loc-suggest-item').forEach(function(el){
        el.addEventListener('mousedown', function(e){
          e.preventDefault();
          var idx = parseInt(this.getAttribute('data-idx'));
          if (suggestResults[idx]) pickSuggestion(suggestResults[idx]);
        });
        el.addEventListener('mouseenter', function(){ this.style.background = 'rgba(255,255,255,.15)'; });
        el.addEventListener('mouseleave', function(){ this.style.background = 'transparent'; });
      });
    }

    function hideSuggestions(){
      if (suggestionsEl){ suggestionsEl.style.display = 'none'; suggestionsEl.innerHTML = ''; }
      suggestResults = [];
      suggestIndex = -1;
    }

    function highlightSuggestion(idx){
      if (!suggestionsEl) return;
      suggestionsEl.querySelectorAll('.loc-suggest-item').forEach(function(el, i){
        el.style.background = i === idx ? 'rgba(255,255,255,.15)' : 'transparent';
      });
    }

    function pickSuggestion(r){
      hideSuggestions();
      searchInput.value = '';
      closeSearchBox();
      var tz = r.timezone || null;
      resolveAndSwitch(Math.round(r.latitude*10000)/10000, Math.round(r.longitude*10000)/10000, r.name || 'Custom', tz);
    }

    var searchInput = document.getElementById("loc-search-input");
    if (searchInput){
      searchInput.setAttribute('placeholder', 'City, zip, park, place...');
      searchInput.setAttribute('autocomplete', 'off');

      // Autocomplete on typing
      searchInput.addEventListener('input', function(){
        var q = searchInput.value.trim();
        clearTimeout(suggestDebounce);
        if (q.length < 2){ hideSuggestions(); return; }
        suggestDebounce = setTimeout(function(){
          fetch('https://geocoding-api.open-meteo.com/v1/search?name=' + encodeURIComponent(q) + '&count=4&language=en&format=json')
            .then(function(r){ return r.json(); })
            .then(function(data){
              if (data.results && data.results.length > 0) showSuggestions(data.results);
              else hideSuggestions();
            }).catch(function(){ hideSuggestions(); });
        }, 250);
      });

      // Keyboard nav + Enter
      searchInput.addEventListener("keydown", function(e){
        if (e.key === 'ArrowDown'){
          e.preventDefault();
          if (suggestResults.length > 0){
            suggestIndex = Math.min(suggestIndex + 1, suggestResults.length - 1);
            highlightSuggestion(suggestIndex);
          }
        } else if (e.key === 'ArrowUp'){
          e.preventDefault();
          if (suggestResults.length > 0){
            suggestIndex = Math.max(suggestIndex - 1, 0);
            highlightSuggestion(suggestIndex);
          }
        } else if (e.key === 'Escape'){
          hideSuggestions();
        } else if (e.key === 'Enter'){
          e.preventDefault();
          if (suggestIndex >= 0 && suggestResults[suggestIndex]){
            pickSuggestion(suggestResults[suggestIndex]);
          } else if (suggestResults.length > 0){
            pickSuggestion(suggestResults[0]);
          } else {
            var q = searchInput.value.trim();
            if (!q) return;
            searchInput.disabled = true;
            searchInput.placeholder = "Searching...";
            fetch("https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(q) + "&count=1&language=en&format=json")
              .then(function(r){ return r.json(); })
              .then(function(data){
                searchInput.disabled = false;
                searchInput.placeholder = "City, zip, park, place...";
                if (data.results && data.results.length > 0){
                  var r = data.results[0];
                  resolveAndSwitch(Math.round(r.latitude*10000)/10000, Math.round(r.longitude*10000)/10000, r.name || "Custom", r.timezone || null);
                  searchInput.value = "";
                } else {
                  alert("Location not found.");
                }
              }).catch(function(){
                searchInput.disabled = false;
                searchInput.placeholder = "City, zip, park, place...";
              });
          }
        }
      });

      // Hide suggestions on blur
      searchInput.addEventListener('blur', function(){
        setTimeout(hideSuggestions, 200);
      });
    }

    // Shared: resolve radar/GOES/tz and switch
    function resolveAndSwitch(lat, lon, name, tzOverride){
      var RADARS = [
        {id:"KENX",name:"NWS Albany",lat:42.59,lon:-73.99,region:"NORTHEAST"},
        {id:"KOKX",name:"NWS Upton",lat:40.87,lon:-72.86,region:"NORTHEAST"},
        {id:"KBOX",name:"NWS Taunton",lat:41.96,lon:-71.14,region:"NORTHEAST"},
        {id:"KDIX",name:"NWS Mt Holly",lat:39.95,lon:-74.41,region:"NORTHEAST"},
        {id:"KLWX",name:"NWS Sterling",lat:38.98,lon:-77.49,region:"NORTHEAST"},
        {id:"KBUF",name:"NWS Buffalo",lat:42.95,lon:-78.74,region:"NORTHEAST"},
        {id:"KCLX",name:"NWS Charleston",lat:32.66,lon:-81.04,region:"SOUTHEAST"},
        {id:"KFFC",name:"NWS Peachtree",lat:33.36,lon:-84.57,region:"SOUTHEAST"},
        {id:"KTBW",name:"NWS Tampa",lat:27.71,lon:-82.40,region:"SOUTHEAST"},
        {id:"KAMX",name:"NWS Miami",lat:25.61,lon:-80.41,region:"SOUTHEAST"},
        {id:"KJAX",name:"NWS Jacksonville",lat:30.48,lon:-81.70,region:"SOUTHEAST"},
        {id:"KBMX",name:"NWS Birmingham",lat:33.17,lon:-86.77,region:"SOUTHEAST"},
        {id:"KLOT",name:"NWS Chicago",lat:41.60,lon:-88.08,region:"UPPERMISSVLY"},
        {id:"KMKX",name:"NWS Milwaukee",lat:42.97,lon:-88.55,region:"UPPERMISSVLY"},
        {id:"KDTX",name:"NWS Detroit",lat:42.70,lon:-83.47,region:"UPPERMISSVLY"},
        {id:"KMPX",name:"NWS Minneapolis",lat:44.85,lon:-93.57,region:"UPPERMISSVLY"},
        {id:"KILX",name:"NWS Lincoln",lat:40.15,lon:-89.34,region:"UPPERMISSVLY"},
        {id:"KIND",name:"NWS Indianapolis",lat:39.71,lon:-86.28,region:"UPPERMISSVLY"},
        {id:"KLSX",name:"NWS St Louis",lat:38.70,lon:-90.68,region:"CENTGRTLAKES"},
        {id:"KEAX",name:"NWS Kansas City",lat:38.81,lon:-94.26,region:"CENTGRTLAKES"},
        {id:"KFWS",name:"NWS Dallas",lat:32.57,lon:-97.30,region:"SOUTHPLAINS"},
        {id:"KEWX",name:"NWS Austin",lat:29.70,lon:-98.03,region:"SOUTHPLAINS"},
        {id:"KHGX",name:"NWS Houston",lat:29.47,lon:-95.08,region:"SOUTHPLAINS"},
        {id:"KOUN",name:"NWS Norman",lat:35.24,lon:-97.46,region:"SOUTHPLAINS"},
        {id:"KUEX",name:"NWS Hastings",lat:40.32,lon:-98.44,region:"NORTHPLAINS"},
        {id:"KABR",name:"NWS Aberdeen",lat:45.46,lon:-98.41,region:"NORTHPLAINS"},
        {id:"KVTX",name:"NWS Los Angeles",lat:34.41,lon:-119.18,region:"PACSOUTHWEST"},
        {id:"KMUX",name:"NWS San Francisco",lat:37.16,lon:-121.90,region:"PACNORTHWEST"},
        {id:"KATX",name:"NWS Seattle",lat:48.19,lon:-122.50,region:"PACNORTHWEST"},
        {id:"KRTX",name:"NWS Portland",lat:45.72,lon:-122.97,region:"PACNORTHWEST"},
        {id:"KCBX",name:"NWS Boise",lat:43.49,lon:-116.24,region:"PACNORTHWEST"},
        {id:"KPUX",name:"NWS Pueblo",lat:38.46,lon:-104.18,region:"CENTGRTLAKES"},
        {id:"KSLC",name:"NWS Salt Lake",lat:40.97,lon:-111.93,region:"CENTGRTLAKES"},
        {id:"KFGZ",name:"NWS Flagstaff",lat:35.23,lon:-111.20,region:"PACSOUTHWEST"},
        {id:"KIWA",name:"NWS Phoenix",lat:33.29,lon:-111.67,region:"PACSOUTHWEST"},
        {id:"KLRX",name:"NWS Elko",lat:40.74,lon:-116.80,region:"PACNORTHWEST"},
        {id:"KREV",name:"NWS Reno",lat:39.51,lon:-119.46,region:"PACNORTHWEST"}
      ];
      var nearestRadar = RADARS[0];
      var minDist = 999999;
      for (var ri = 0; ri < RADARS.length; ri++){
        var dlat = lat - RADARS[ri].lat;
        var dlon = lon - RADARS[ri].lon;
        var d = dlat*dlat + dlon*dlon;
        if (d < minDist){ minDist = d; nearestRadar = RADARS[ri]; }
      }
      var goesSat = lon < -105 ? "G18" : "G19";
      var goesSector = lon < -105 ? "wus" : (lat > 38 ? "ne" : "se");
      var guessTz = tzOverride || "America/New_York";
      if (!tzOverride){
        if (lon < -115) guessTz = "America/Los_Angeles";
        else if (lon < -105) guessTz = "America/Denver";
        else if (lon < -90) guessTz = "America/Chicago";
      }
      var newLoc = {
        id: "custom",
        name: name,
        lat: lat,
        lon: lon,
        tz: guessTz,
        radar: nearestRadar.id,
        radarName: nearestRadar.name,
        radarRegion: nearestRadar.region,
        goes: { sat: goesSat, sector: goesSector }
      };
      var cIdx = -1;
      for (var g = 0; g < LOCATIONS.length; g++){
        if (LOCATIONS[g].id === "custom"){ cIdx = g; break; }
      }
      if (cIdx >= 0) LOCATIONS[cIdx] = newLoc;
      else { LOCATIONS.push(newLoc); cIdx = LOCATIONS.length - 1; }
      locIndex = cIdx;
      renderDots();
      switchLocation("custom");
    }

    // Swipe support
    var startX = null;
    var cyclerEl = document.getElementById("loc-cycler");
    if (cyclerEl){
      cyclerEl.addEventListener("touchstart", function(e){ startX = e.touches[0].clientX; }, {passive:true});
      cyclerEl.addEventListener("touchend", function(e){
        if (startX === null) return;
        var diff = e.changedTouches[0].clientX - startX;
        if (Math.abs(diff) > 40){
          cycleTo(locIndex + (diff < 0 ? 1 : -1));
        }
        startX = null;
      }, {passive:true});
    }
    
    function switchLocation(id){
      var newLoc = null;
      for (var i = 0; i < LOCATIONS.length; i++){
        if (LOCATIONS[i].id === id){
          newLoc = LOCATIONS[i];
          break;
        }
      }
      if (!newLoc) return;
      
      // Clear existing timers
      if (radarRefreshTimer) { clearInterval(radarRefreshTimer); radarRefreshTimer = null; }
      if (goesTimer) { clearInterval(goesTimer); goesTimer = null; }
      if (goesRefreshTimer) { clearInterval(goesRefreshTimer); goesRefreshTimer = null; }
      
      // Prevent rapid switching
      if (window.locationSwitching) return;
      window.locationSwitching = true;
      setTimeout(function(){ window.locationSwitching = false; }, 1000);
      
      LOCATION = newLoc;
      TZ = newLoc.tz;
      
      // Update location name display with loading state
      if (locNameEl) locNameEl.textContent = newLoc.name;
      if (locMetaEl) locMetaEl.textContent = "Loading...";
      if (tempEl) tempEl.style.opacity = "0.5";
      
      // Reload all data
      loadWeatherForLocation(LOCATION);
      loadAirQuality();
      loadWeatherAlerts();
      switchRadarMode("reflectivity");
      startRadarNwsLoop();
      startGoesAutoplay();
      updateSolarMini();
      
      // Re-center existing maps instead of destroying/recreating
      if (fireMap) {
        var fc = [45, -100], fz = 3;
        if (LOCATION.lon > -85 && LOCATION.lat > 38) { fc = [44, -74]; fz = 5; }
        else if (LOCATION.lon > -90 && LOCATION.lat <= 38 && LOCATION.lat > 25) { fc = [32, -82]; fz = 5; }
        else if (LOCATION.lon > -100 && LOCATION.lon <= -85 && LOCATION.lat > 36) { fc = [42, -90]; fz = 5; }
        else if (LOCATION.lon <= -110 && LOCATION.lat <= 42 && LOCATION.lat > 30) { fc = [36, -118]; fz = 5; }
        else if (LOCATION.lon <= -115 && LOCATION.lat > 42) { fc = [46, -122]; fz = 5; }
        else if (LOCATION.lon > -105 && LOCATION.lon <= -90 && LOCATION.lat <= 36) { fc = [31, -98]; fz = 5; }
        else if (LOCATION.lon <= -100 && LOCATION.lon > -115 && LOCATION.lat > 36) { fc = [42, -110]; fz = 5; }
        fireMap.setView(fc, fz);
      }
      if (quakeMap) quakeMap.setView([LOCATION.lat, LOCATION.lon], 6);
      if (lightningMap) lightningMap.setView([LOCATION.lat, LOCATION.lon], 3);
      
      // Update lightning iframe location
      var lIframe = document.getElementById('lightning-iframe');
      if (lIframe) {
        lIframe.src = 'https://map.blitzortung.org/index.php?interactive=1&NavigationControl=0&FullScreenControl=0&Ede=0&Menu=0&InfoStrike=0&InfoMuted=1&Cookies=0&CookieConsent=1#7/' + LOCATION.lat.toFixed(4) + '/' + LOCATION.lon.toFixed(4);
      }
      
      // Update location markers on maps
      if (fireMap) {
        fireMap.eachLayer(function(layer){ if (layer.options && layer.options.fillColor === '#2B22F4') fireMap.removeLayer(layer); });
        L.circleMarker([LOCATION.lat, LOCATION.lon], { radius: 8, fillColor: '#2B22F4', fillOpacity: 0.9, color: '#fff', weight: 2 }).addTo(fireMap).bindTooltip(" " + LOCATION.name, { permanent: false });
      }
      if (quakeMap) {
        quakeMap.eachLayer(function(layer){ if (layer.options && layer.options.fillColor === '#2B22F4') quakeMap.removeLayer(layer); });
        L.circleMarker([LOCATION.lat, LOCATION.lon], { radius: 8, fillColor: '#2B22F4', fillOpacity: 0.9, color: '#fff', weight: 2 }).addTo(quakeMap).bindTooltip(" " + LOCATION.name, { permanent: false });
      }
    }
  }

  /* =========================================================
     SUVI THEMATIC MAP (Animated)
     ========================================================= */
  var suviMapAnim = {
    frames: [],
    idx: 0,
    playing: true,
    timer: null,
    refreshTimer: null
  };
  
  function initPfss(){
    var img = document.getElementById("pfss-img");
    var live = document.getElementById("pfss-live");
    if (!img) return;
    
// Try AIA 171 first, fallback to SOHO, then PFSS
    var aiaUrl = "https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_0171.jpg";
    var sohoUrl = "https://soho.nascom.nasa.gov/data/realtime/eit_171/512/latest.jpg";
    var pfssUrl = "https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_PFSS_0171.jpg";
    var fallbackLevel = 1; // Start with AIA since PFSS is unreliable
    
    function loadImage(){
      var url = aiaUrl;
      if (fallbackLevel === 1) url = sohoUrl;
      if (fallbackLevel === 2) url = pfssUrl;
      
      img.src = url + "?cb=" + Date.now();
      if(live) live.textContent = " LIVE";
    }
    
    img.onerror = function(){
      fallbackLevel++;
      if (fallbackLevel <= 2) {
        loadImage();
      } else {
        if(live) live.textContent = " OFFLINE";
        img.style.opacity = "0.3";
      }
    };
    
    img.onload = function(){
      img.style.opacity = "1";
    };
    
    loadImage();
    setInterval(function(){
      fallbackLevel = 0; // Reset to try PFSS again each refresh
      loadImage();
    }, 300000);
  }

  function initSuviMap(){
    var suviMapImg = document.getElementById("suvi-map-img");
    var suviMapLive = document.getElementById("suvi-map-live");
    var suviMapBtn = document.getElementById("suvi-map-btn");
    
    if (!suviMapImg) return;
    
    var JSON_URL = "https://services.swpc.noaa.gov/products/animations/suvi-primary-map.json";
    var FALLBACK_URL = "https://services.swpc.noaa.gov/images/animations/suvi/primary/map/latest.png";
    
    function loadFrames(){
      if (suviMapLive) suviMapLive.textContent = " LOADING";
      
      fetchWithTimeout(JSON_URL, null, 15000)
        .then(function(r){ return r.json(); })
        .then(function(data){
          if (data && data.length > 0){
            suviMapAnim.frames = data.map(function(f){
              return "https://services.swpc.noaa.gov" + f.url;
            });
            suviMapAnim.idx = 0;
            if (suviMapLive) suviMapLive.textContent = " LIVE";
            if (suviMapBtn) suviMapBtn.style.display = "block";
            startSuviAnimation();
          } else {
            throw new Error("No frames");
          }
        })
        .catch(function(){
          // Fallback to static image
          suviMapImg.src = FALLBACK_URL + "?cb=" + Date.now();
          suviMapImg.onload = function(){ if (suviMapLive) suviMapLive.textContent = " LIVE"; };
          suviMapImg.onerror = function(){ if (suviMapLive) suviMapLive.textContent = " OFFLINE"; };
          if (suviMapBtn) suviMapBtn.style.display = "none";
        });
    }
    
    function startSuviAnimation(){
      if (suviMapAnim.timer) clearTimeout(suviMapAnim.timer);
      
      function step(){
        if (suviMapAnim.playing && suviMapAnim.frames.length > 0){
          suviMapImg.src = suviMapAnim.frames[suviMapAnim.idx];
          suviMapAnim.idx = (suviMapAnim.idx + 1) % suviMapAnim.frames.length;
        }
        suviMapAnim.timer = setTimeout(step, 150);
      }
      step();
    }
    
    
    loadFrames();
    
    if (suviMapAnim.refreshTimer) clearInterval(suviMapAnim.refreshTimer);
    suviMapAnim.refreshTimer = setInterval(loadFrames, 5 * 60 * 1000);
  }

  /* =========================================================
   MAIN WEATHER MICRO TABS (RESET TO SUMMARY ON REFRESH)
   ========================================================= */
function initNowMicroTabs(){
  var tabButtons = document.querySelectorAll(".now-tab[data-nowtab]");
  var panels = document.querySelectorAll(".now-tabpanel[data-nowtab-panel]");
  if (!tabButtons.length || !panels.length) return;

  function setActive(name){
    for (var i=0; i<tabButtons.length; i++){
      var b = tabButtons[i];
      var isOn = (b.getAttribute("data-nowtab") === name);
      if (isOn) b.classList.add("is-active");
      else b.classList.remove("is-active");
    }

    for (var p=0; p<panels.length; p++){
      var panel = panels[p];
      var isPanel = (panel.getAttribute("data-nowtab-panel") === name);
      panel.hidden = !isPanel;
    }
  }

  for (var j=0; j<tabButtons.length; j++){
    tabButtons[j].addEventListener("click", function(e){
      var name = this.getAttribute("data-nowtab");
      setActive(name);
    });
  }

  // Critical behavior: ALWAYS reset to Summary on refresh / load
  setActive("summary");
}



  /* =========================================================
     HAZARD MAPS (Lightning, Wildfires, Earthquakes) - Leaflet
     ========================================================= */
  var lightningMap = null;
  var fireMap = null;
  var quakeMap = null;
  var lightningMarkers = [];
  var fireMarkers = [];
  var quakeMarkers = [];

  // Light map tiles
  var DARK_TILES = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
  var TILE_ATTRIB = '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>';

  // ============ NATIONAL RADAR MAP (CONUS) ============
  var nationalRadarMap = null;
  var nationalRadarLayer = null;
  var nationalRadarFrames = [];
  var nationalRadarIndex = 0;
  var nationalRadarTimer = null;
  var nationalRadarHost = '';

  function initNationalRadarMap(){
    var container = document.getElementById("national-radar-map");
    var liveEl = document.getElementById("national-radar-live");
    
    if (!container || typeof L === "undefined") return;

    if (nationalRadarMap) nationalRadarMap.remove();
    nationalRadarMap = L.map(container, {
      center: [39.0, -98.0],
      zoom: 3,
      zoomControl: false,
      attributionControl: false,
      minZoom: 2,
      maxZoom: 10
    });

    // Pure black background
    nationalRadarMap.getContainer().style.background = '#000';
    
    // Dark base layer (no features, just black tiles)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(nationalRadarMap);

    // Add CSS for smooth radar transitions
    var style = document.createElement('style');
    style.textContent = '#national-radar-map .leaflet-layer { transition: opacity 0.25s ease-in-out; }';
    document.head.appendChild(style);

    // Add radar legend with precip types
    var radarLegend = L.control({ position: 'bottomright' });
    radarLegend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'radar-legend');
      div.style.background = 'rgba(0,0,0,.6)';
      div.style.backdropFilter = 'blur(8px)';
      div.style.padding = '6px 12px';
      div.style.borderRadius = '8px';
      div.style.fontSize = '.5rem';
      div.style.fontWeight = '700';
      div.style.fontFamily = 'system-ui,sans-serif';
      div.style.color = 'rgba(255,255,255,.85)';
      div.style.boxShadow = '0 2px 8px rgba(0,0,0,.3)';
      div.style.letterSpacing = '.04em';
      div.style.textTransform = 'uppercase';
      div.innerHTML = 
        '<div style="display:flex;align-items:center;gap:10px;">' +
          '<div style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;background:linear-gradient(135deg,#02fd02,#fdf802,#fd0000);border-radius:2px;display:inline-block;"></span><span>Rain</span></div>' +
          '<div style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;background:linear-gradient(135deg,#04e9e7,#019ff4,#ff80ff);border-radius:2px;display:inline-block;"></span><span>Snow</span></div>' +
          '<div style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;background:#f800fd;border-radius:2px;display:inline-block;"></span><span>Mix</span></div>' +
          '<div style="display:flex;gap:1px;align-items:center;margin-left:6px;">' +
            '<span style="width:10px;height:5px;background:#04e9e7;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#02fd02;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#fdf802;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#fd9500;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#fd0000;display:inline-block;"></span>' +
            '<span style="width:10px;height:5px;background:#f800fd;display:inline-block;"></span>' +
          '</div>' +
        '</div>';
      return div;
    };
    radarLegend.addTo(nationalRadarMap);

    // Setup scrubber interaction
    var slider = document.getElementById("national-radar-slider");
    if (slider){
      slider.addEventListener("input", function(){
        nationalRadarIndex = parseInt(this.value);
        showNationalRadarFrame(nationalRadarIndex);
      });
      slider.addEventListener("mousedown", function(){ stopNationalRadarLoop(); });
      slider.addEventListener("touchstart", function(){ stopNationalRadarLoop(); });
      slider.addEventListener("mouseup", function(){ startNationalRadarLoop(); });
      slider.addEventListener("touchend", function(){ startNationalRadarLoop(); });
    }

    loadNationalRadarFrames();
    setInterval(loadNationalRadarFrames, 5 * 60 * 1000);

    if (liveEl) liveEl.textContent = " LIVE";
  }

  function loadNationalRadarFrames(){
    if (!nationalRadarMap) return;

    fetch('https://api.rainviewer.com/public/weather-maps.json')
      .then(function(response){ return response.json(); })
      .then(function(apiData){
        if (!apiData.radar || !apiData.radar.past || apiData.radar.past.length === 0) return;
        
        nationalRadarHost = apiData.host;
        
        // Combine past + nowcast for max coverage (~2.5 hours)
        var allFrames = apiData.radar.past.slice();
        if (apiData.radar.nowcast && apiData.radar.nowcast.length > 0){
          allFrames = allFrames.concat(apiData.radar.nowcast);
        }
        nationalRadarFrames = allFrames;
        
        var slider = document.getElementById("national-radar-slider");
        if (slider){
          slider.max = nationalRadarFrames.length - 1;
          slider.value = apiData.radar.past.length - 1;
        }
        
        // Remove old layers
        nationalRadarLayers.forEach(function(layer){
          if (layer && nationalRadarMap.hasLayer(layer)) nationalRadarMap.removeLayer(layer);
        });
        nationalRadarLayers = [];
        
        // Pre-load all frame layers (hidden initially)
        nationalRadarFrames.forEach(function(frame, i){
          var radarUrl = nationalRadarHost + frame.path + '/256/{z}/{x}/{y}/4/1_1.png';
          var layer = L.tileLayer(radarUrl, {
            opacity: 0,
            maxZoom: 10
          }).addTo(nationalRadarMap);
          nationalRadarLayers.push(layer);
        });
        
        nationalRadarIndex = apiData.radar.past.length - 1;
        showNationalRadarFrame(nationalRadarIndex);
        startNationalRadarLoop();
      })
      .catch(function(err){
        console.log('RainViewer API error:', err);
      });
  }

  var nationalRadarLayers = []; // Pre-loaded layers for smooth animation

  function showNationalRadarFrame(index){
    if (!nationalRadarMap || nationalRadarFrames.length === 0) return;
    if (index < 0 || index >= nationalRadarFrames.length) return;
    
    // Crossfade: show current frame, hide others
    nationalRadarLayers.forEach(function(layer, i){
      if (layer) layer.setOpacity(i === index ? 0.85 : 0);
    });
    
    var frame = nationalRadarFrames[index];
    
    // Update timestamp (local time)
    var tsEl = document.getElementById("national-radar-timestamp");
    if (tsEl && frame.time){
      var d = new Date(frame.time * 1000);
      var h = d.getHours();
      var m = d.getMinutes();
      var ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12; if (h === 0) h = 12;
      var timeStr = h + ':' + (m < 10 ? '0' + m : m) + ' ' + ampm;
      tsEl.textContent = timeStr;
    }
    
    // Update slider
    var slider = document.getElementById("national-radar-slider");
    if (slider) slider.value = index;
  }

  function startNationalRadarLoop(){
    stopNationalRadarLoop();
    var loopDelay = 350; // ms between frames
    var endPause = 2000; // ms pause at most recent frame
    
    nationalRadarTimer = setInterval(function(){
      nationalRadarIndex = (nationalRadarIndex + 1) % nationalRadarFrames.length;
      showNationalRadarFrame(nationalRadarIndex);
      
      // Pause longer at the end (most recent frame)
      if (nationalRadarIndex === nationalRadarFrames.length - 1){
        stopNationalRadarLoop();
        setTimeout(startNationalRadarLoop, endPause);
      }
    }, loopDelay);
  }

  function stopNationalRadarLoop(){
    if (nationalRadarTimer){
      clearInterval(nationalRadarTimer);
      nationalRadarTimer = null;
    }
  }


  function initHazardMaps(){
    initLightningMap();
    initNationalRadarMap();
    initFireMap();
    initTornadoMap();
    initQuakeMap();
    initGeologyMaps();
  }

  function destroyHazardMaps(){
    if (lightningMap){ lightningMap.remove(); lightningMap = null; }
    if (fireMap){ fireMap.remove(); fireMap = null; }
    if (quakeMap){ quakeMap.remove(); quakeMap = null; }
    if (bedrockMap){ bedrockMap.remove(); bedrockMap = null; }
    if (lithologyMap){ lithologyMap.remove(); lithologyMap = null; }
    if (stratMap){ stratMap.remove(); stratMap = null; }
    lightningMarkers = [];
    fireMarkers = [];
    quakeMarkers = [];
    blitzortungStrikes = [];
    if (blitzortungWs){ try { blitzortungWs.close(); } catch(e){} blitzortungWs = null; }
    if (blitzortungReconnectTimer){ clearTimeout(blitzortungReconnectTimer); blitzortungReconnectTimer = null; }
  }
// ============ LIGHTNING MAP ============
  var blitzortungWs = null;
  var blitzortungReconnectTimer = null;
  var blitzortungStrikes = [];
  var lightningStrikeCount = 0;

  // Lightning now uses Blitzortung iframe - these are no-ops
  function initLightningMap(){
    var iframe = document.getElementById('lightning-iframe');
    if (iframe) {
      iframe.src = 'https://map.blitzortung.org/index.php?interactive=1&NavigationControl=0&FullScreenControl=0&Ede=0&Menu=0&InfoStrike=0&InfoMuted=1&Cookies=0&CookieConsent=1#7/' + LOCATION.lat.toFixed(4) + '/' + LOCATION.lon.toFixed(4);
    }
  }
  function connectBlitzortung(){ }
  function scheduleBlitzReconnect(){ }
  function addLightningStrike(){ }

  // Global toggle function called by buttons
  

  // ============ TORNADO MAP ============
  var tornadoMap = null;
  var tornadoMarkers = [];
  var tornadoReports = [];
  var tornadoCurrentRange = 'today';
  var tornadoSevereMarkers = [];
  var tornadoOutlookLayers = [];

  function clearTornadoMarkers(){
    tornadoMarkers.forEach(function(m){ try { tornadoMap.removeLayer(m); } catch(e){} });
    tornadoMarkers = [];
    tornadoSevereMarkers.forEach(function(m){ try { tornadoMap.removeLayer(m); } catch(e){} });
    tornadoSevereMarkers = [];
    tornadoOutlookLayers.forEach(function(l){ try { tornadoMap.removeLayer(l); } catch(e){} });
    tornadoOutlookLayers = [];
    tornadoReports = [];
  }

  function switchTornadoRange(range){
    tornadoCurrentRange = range;
    // Update tab styles
    var tabs = ['today','48h','7d','1m','6m','1y','forecast'];
    tabs.forEach(function(t){
      var el = document.getElementById('torn-tab-' + t);
      if (!el) return;
      if (t === range){
        if (t === 'forecast'){
          el.style.borderColor = 'rgba(255,165,0,.6)';
          el.style.background = 'rgba(255,100,0,.25)';
          el.style.color = 'rgba(255,200,100,1)';
        } else {
          el.style.borderColor = 'rgba(255,255,255,.4)';
          el.style.background = 'rgba(0,0,0,.5)';
          el.style.color = 'rgba(255,255,255,.9)';
        }
      } else {
        if (t === 'forecast'){
          el.style.borderColor = 'rgba(255,165,0,.4)';
          el.style.background = 'rgba(255,100,0,.15)';
          el.style.color = 'rgba(255,180,80,.9)';
        } else {
          el.style.borderColor = 'rgba(255,255,255,.15)';
          el.style.background = 'rgba(0,0,0,.3)';
          el.style.color = 'rgba(255,255,255,.5)';
        }
      }
    });
    // Clear and reload
    clearTornadoMarkers();
    if (range === 'forecast'){
      loadSPCForecast();
    } else {
      loadTornadoReports();
      if (range === 'today'){
        loadSPCTornadoOutlook();
        loadSevereReports();
      }
    }
  }
  window.switchTornadoRange = switchTornadoRange;

  function getDaysForRange(range){
    switch(range){
      case 'today': return 1;
      case '48h': return 2;
      case '7d': return 7;
      case '1m': return 30;
      case '6m': return 180;
      case '1y': return 365;
      default: return 1;
    }
  }

  function initTornadoMap(){
    var container = document.getElementById('tornado-map');
    if (!container || typeof L === 'undefined') return;

    if (tornadoMap) tornadoMap.remove();
    tornadoMap = L.map(container, {
      center: [38, -96],
      zoom: 3,
      zoomControl: false,
      attributionControl: false,
      dragging: true,
      scrollWheelZoom: true,
      touchZoom: true
    });

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 18
    }).addTo(tornadoMap);

    // Check if user is under tornado watch/warning  auto-zoom local if so
    checkTornadoLocalZoom();

    // Add SPC Day 1 Tornado Probability Outlook overlay
    loadSPCTornadoOutlook();

    // Also load hail and wind reports for context
    loadSevereReports();

    loadTornadoReports();
  }

  function checkTornadoLocalZoom(){
    if (!tornadoMap) return;
    var url = 'https://api.weather.gov/alerts/active?point=' + LOCATION.lat + ',' + LOCATION.lon;
    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features) return;
      var tornadoAlert = null;
      var severeAlert = null;
      for (var i = 0; i < data.features.length; i++){
        var ev = (data.features[i].properties.event || '').toLowerCase();
        if (ev.indexOf('tornado') >= 0 && ev.indexOf('warning') >= 0){
          tornadoAlert = data.features[i];
          break; // highest priority
        }
        if (ev.indexOf('tornado') >= 0 && ev.indexOf('watch') >= 0){
          tornadoAlert = data.features[i];
        }
        if (ev.indexOf('severe thunderstorm') >= 0 && !severeAlert){
          severeAlert = data.features[i];
        }
      }

      var alertToZoom = tornadoAlert || severeAlert;
      if (!alertToZoom) {
        // Also check SPC outlook for local risk
        checkSPCLocalZoom();
        return;
      }

      // Zoom level based on alert type
      var ev = (alertToZoom.properties.event || '').toLowerCase();
      var zoom = 8; // default for watches
      if (ev.indexOf('warning') >= 0) zoom = 10; // tighter for active warnings

      // If alert has geometry, fit to it
      if (alertToZoom.geometry && alertToZoom.geometry.coordinates){
        try {
          var geoLayer = L.geoJSON(alertToZoom.geometry);
          tornadoMap.fitBounds(geoLayer.getBounds().pad(0.3));
        } catch(e){
          tornadoMap.setView([LOCATION.lat, LOCATION.lon], zoom);
        }
      } else {
        tornadoMap.setView([LOCATION.lat, LOCATION.lon], zoom);
      }

      // Add a pulsing danger ring around user location
      var pulseRing = L.circleMarker([LOCATION.lat, LOCATION.lon], {
        radius: 20, fillColor: 'transparent', fillOpacity: 0, color: '#ff0000', weight: 2, opacity: 0.7, dashArray: '4 4'
      }).addTo(tornadoMap);
      var pulseGrow = true;
      setInterval(function(){
        var r = pulseRing.getRadius();
        if (pulseGrow){ r += 0.5; if (r >= 30) pulseGrow = false; }
        else { r -= 0.5; if (r <= 15) pulseGrow = true; }
        pulseRing.setRadius(r);
      }, 80);

    }).catch(function(){});
  }

  function checkSPCLocalZoom(){
    // If SPC has tornado risk >= 5% for user's area, zoom in moderately
    if (!tornadoMap) return;
    var url = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/3/query?where=1%3D1&outFields=*&f=geojson';
    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features) return;
      for (var i = 0; i < data.features.length; i++){
        var label = (data.features[i].properties.LABEL || '').toString();
        var pct = parseFloat(label) || 0;
        if (pct >= 5 && pointInGeoJSON(LOCATION.lat, LOCATION.lon, data.features[i].geometry)){
          tornadoMap.setView([LOCATION.lat, LOCATION.lon], 7);
          return;
        }
      }
    }).catch(function(){});
  }

  function loadSPCTornadoOutlook(){
    if (!tornadoMap) return;
    // Layer 3 = Day 1 Probabilistic Tornado Outlook
    var url = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/3/query?where=1%3D1&outFields=*&f=geojson';
    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features || data.features.length === 0) return;
      L.geoJSON(data, {
        style: function(feature){
          var label = (feature.properties.LABEL || feature.properties.label || '').toString();
          var color, fillOpacity;
          if (label.indexOf('SIGN') >= 0 || label.indexOf('10') >= 0){ color = '#ff1744'; fillOpacity = 0.25; }
          else if (label.indexOf('5') >= 0){ color = '#ff6d00'; fillOpacity = 0.2; }
          else if (label.indexOf('2') >= 0){ color = '#ffd600'; fillOpacity = 0.15; }
          else { color = '#66bb6a'; fillOpacity = 0.1; }
          return { color: color, weight: 2, fillColor: color, fillOpacity: fillOpacity, dashArray: '4 2' };
        },
        onEachFeature: function(feature, layer){
          var p = feature.properties;
          var label = p.LABEL || p.label || 'General';
          layer.bindTooltip('<span style="font-size:.55rem;"><b> SPC Tornado Outlook</b><br>' + label + '% probability</span>', {sticky: true});
        }
      }).addTo(tornadoMap);
      tornadoOutlookLayers.push(tornadoMap._layers[Object.keys(tornadoMap._layers).pop()]);
    }).catch(function(){});

    // Also load Day 1 Significant Tornado (layer 2)
    var sigUrl = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/2/query?where=1%3D1&outFields=*&f=geojson';
    fetch(sigUrl).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features || data.features.length === 0) return;
      L.geoJSON(data, {
        style: function(){
          return { color: '#d50000', weight: 3, fillColor: '#d50000', fillOpacity: 0.15, dashArray: '6 3' };
        },
        onEachFeature: function(feature, layer){
          layer.bindTooltip('<span style="font-size:.55rem;"><b> SIGNIFICANT TORNADO RISK</b><br>EF2+ potential</span>', {sticky: true});
        }
      }).addTo(tornadoMap);
    }).catch(function(){});
  }

  function loadSevereReports(){
    if (!tornadoMap) return;
    // Load today's hail reports
    fetch('https://www.spc.noaa.gov/climo/reports/today_hail.csv')
      .then(function(r){ return r.text(); })
      .then(function(csv){
        var lines = csv.trim().split('\n');
        for (var i = 1; i < lines.length; i++){
          var parts = lines[i].split(',');
          if (parts.length < 7) continue;
          var lat = parseFloat(parts[5]);
          var lon = parseFloat(parts[6]);
          var size = parts[1].trim(); // hail size in inches
          if (isNaN(lat) || isNaN(lon)) continue;
          var sizeNum = parseFloat(size) || 1;
          L.circleMarker([lat, lon], {
            radius: Math.min(3 + sizeNum * 1.5, 8),
            fillColor: '#00e5ff',
            fillOpacity: 0.6,
            color: '#fff',
            weight: 0.5
          }).addTo(tornadoMap).bindTooltip(
            '<span style="font-size:.5rem;"> Hail ' + size + '"  ' + parts[2].trim() + ', ' + parts[4].trim() + '</span>'
          );
        }
      }).catch(function(){});

    // Load today's wind reports
    fetch('https://www.spc.noaa.gov/climo/reports/today_wind.csv')
      .then(function(r){ return r.text(); })
      .then(function(csv){
        var lines = csv.trim().split('\n');
        for (var i = 1; i < lines.length; i++){
          var parts = lines[i].split(',');
          if (parts.length < 7) continue;
          var lat = parseFloat(parts[5]);
          var lon = parseFloat(parts[6]);
          var speed = parts[1].trim(); // knots
          if (isNaN(lat) || isNaN(lon)) continue;
          L.circleMarker([lat, lon], {
            radius: 3,
            fillColor: '#76ff03',
            fillOpacity: 0.5,
            color: '#fff',
            weight: 0.5
          }).addTo(tornadoMap).bindTooltip(
            '<span style="font-size:.5rem;"> Wind ' + speed + ' kt  ' + parts[2].trim() + ', ' + parts[4].trim() + '</span>'
          );
        }
      }).catch(function(){});
  }

  function parseTornadoCSV(csv){
    var lines = csv.trim().split('\n');
    var reports = [];
    // Skip header line
    for (var i = 1; i < lines.length; i++){
      var line = lines[i];
      if (!line.trim()) continue;
      // Format: Time,F_Scale,Location,County,State,Lat,Lon,Comments
      var parts = line.split(',');
      if (parts.length < 7) continue;
      var time = parts[0].trim();
      var scale = parts[1].trim();
      var location = parts[2].trim();
      var county = parts[3].trim();
      var state = parts[4].trim();
      var lat = parseFloat(parts[5]);
      var lon = parseFloat(parts[6]);
      var comment = parts.slice(7).join(',').trim();
      if (!isNaN(lat) && !isNaN(lon)){
        reports.push({
          time: time,
          scale: scale,
          location: location,
          county: county,
          state: state,
          lat: lat,
          lon: lon,
          comment: comment
        });
      }
    }
    return reports;
  }

  function efColor(scale){
    switch(scale){
      case 'EF0': return '#66bb6a';
      case 'EF1': return '#fdd835';
      case 'EF2': return '#ffa726';
      case 'EF3': return '#ef5350';
      case 'EF4': return '#ab47bc';
      case 'EF5': return '#ec407a';
      default: return '#90caf9'; // UNK
    }
  }

  function efRadius(scale){
    switch(scale){
      case 'EF0': return 5;
      case 'EF1': return 6;
      case 'EF2': return 8;
      case 'EF3': return 10;
      case 'EF4': return 12;
      case 'EF5': return 14;
      default: return 5;
    }
  }

  function plotTornadoes(reports, dateLabel){
    if (!tornadoMap) return;
    reports.forEach(function(r){
      var color = efColor(r.scale);
      var radius = efRadius(r.scale);
      var marker = L.circleMarker([r.lat, r.lon], {
        radius: radius,
        fillColor: color,
        fillOpacity: 0.95,
        color: '#000',
        weight: 2
      }).addTo(tornadoMap);
      marker.bindTooltip(
        '<b style="font-size:.6rem;color:' + color + ';"> ' + (r.scale === 'UNK' ? 'Tornado' : r.scale) + '</b>  ' +
        '<span style="font-size:.55rem;">' + r.location + ', ' + r.state + '  ' + r.county + ' Co.</span><br>' +
        '<span style="font-size:.5rem;opacity:.6;">' + dateLabel + ' ' + r.time + ' UTC</span>' +
        (r.comment ? '<br><span style="font-size:.48rem;opacity:.5;display:inline-block;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + r.comment.substring(0,100) + '</span>' : ''),
        {className: 'tornado-tooltip'}
      );
      tornadoMarkers.push(marker);
    });
  }

  function loadTornadoReports(){
    var statusEl = document.getElementById('tornado-status-pill');
    var liveEl = document.getElementById('tornado-live');
    var yearCountEl = document.getElementById('tornado-year-count');
    var listEl = document.getElementById('tornado-list');
    var totalCount = 0;
    var allReports = [];
    var numDays = getDaysForRange(tornadoCurrentRange);
    var rangeLabel = tornadoCurrentRange.toUpperCase();

    // Generate date strings
    var dates = [];
    var now = new Date();
    for (var d = 0; d < numDays; d++){
      var dt = new Date(now);
      dt.setDate(dt.getDate() - d);
      var yy = String(dt.getFullYear()).slice(-2);
      var mm = String(dt.getMonth()+1).padStart(2,'0');
      var dd = String(dt.getDate()).padStart(2,'0');
      dates.push({str: yy+mm+dd, label: (dt.getMonth()+1)+'/'+dt.getDate()+'/'+dt.getFullYear()});
    }

    var fetched = 0;
    dates.forEach(function(dateObj){
      var url = 'https://www.spc.noaa.gov/climo/reports/' + dateObj.str + '_rpts_torn.csv';
      // Today uses a different URL
      if (dateObj.str === dates[0].str){
        url = 'https://www.spc.noaa.gov/climo/reports/today_torn.csv';
      }
      fetch(url).then(function(r){ return r.text(); }).then(function(csv){
        var reports = parseTornadoCSV(csv);
        totalCount += reports.length;
        reports.forEach(function(r){ r.dateLabel = dateObj.label; });
        allReports = allReports.concat(reports);
        plotTornadoes(reports, dateObj.label);
        fetched++;
        if (fetched === dates.length){
          finalizeTornado(allReports, totalCount, statusEl, liveEl, yearCountEl, listEl, rangeLabel);
        }
      }).catch(function(){
        fetched++;
        if (fetched === dates.length){
          finalizeTornado(allReports, totalCount, statusEl, liveEl, yearCountEl, listEl, rangeLabel);
        }
      });
    });

    // Also fetch yearly total from SPC filtered reports (Jan 1 to now)
    loadTornadoYearCount(yearCountEl);
  }

  var tornadoTopReports = [];

  function efRank(scale){
    switch(scale){
      case 'EF5': return 6;
      case 'EF4': return 5;
      case 'EF3': return 4;
      case 'EF2': return 3;
      case 'EF1': return 2;
      case 'EF0': return 1;
      default: return 0;
    }
  }

  function loadTornadoYearCount(yearCountEl){
    var now = new Date();
    var totalYear = 0;
    tornadoTopReports = [];
    var totalMonths = now.getMonth() + 1;

    for (var m = 1; m <= totalMonths; m++){
      var daysInMonth = new Date(2026, m, 0).getDate();
      var endDay = (m === totalMonths) ? now.getDate() : daysInMonth;
      
      for (var d = 1; d <= endDay; d++){
        var yy = '26';
        var mm = String(m).padStart(2,'0');
        var dd = String(d).padStart(2,'0');
        var dateStr = yy + mm + dd;
        var dateLabel = m + '/' + d + '/2026';
        var today = String(now.getFullYear()).slice(-2) + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
        
        var url;
        if (dateStr === today){
          url = 'https://www.spc.noaa.gov/climo/reports/today_torn.csv';
        } else {
          url = 'https://www.spc.noaa.gov/climo/reports/' + dateStr + '_rpts_torn.csv';
        }
        
        (function(u, dl){
          fetch(u).then(function(r){ return r.text(); }).then(function(csv){
            var reports = parseTornadoCSV(csv);
            totalYear += reports.length;
            if (yearCountEl) yearCountEl.textContent = totalYear.toLocaleString();
            // Update status pill year portion
            var sp = document.getElementById('tornado-status-pill');
            if (sp && sp.innerHTML.indexOf('2026:') >= 0){
              sp.innerHTML = sp.innerHTML.replace(/2026: [^<]+/, '2026: ' + totalYear.toLocaleString());
            }
            // Track biggest
            reports.forEach(function(r){
              r.dateLabel = dl;
              var rank = efRank(r.scale);
              if (tornadoTopReports.length < 5){
                tornadoTopReports.push(r);
                tornadoTopReports.sort(function(a,b){ return efRank(b.scale) - efRank(a.scale); });
              } else if (rank > efRank(tornadoTopReports[4].scale)){
                tornadoTopReports[4] = r;
                tornadoTopReports.sort(function(a,b){ return efRank(b.scale) - efRank(a.scale); });
              }
            });
            updateTop5Dropdown();
          }).catch(function(){});
        })(url, dateLabel);
      }
    }
  }

  function updateTop5Dropdown(){
    var list = document.getElementById('tornado-top5-list');
    if (!list) return;
    if (tornadoTopReports.length === 0){
      list.innerHTML = '<div style="padding:6px;color:#888;font-size:.55rem;text-align:center;">No rated tornadoes yet</div>';
      return;
    }
    list.innerHTML = '<div style="padding:4px 6px;font-size:.5rem;font-weight:700;color:#ff6b6b;opacity:.7;text-transform:uppercase;letter-spacing:.05em;">Top 5 Strongest  2026</div>';
    tornadoTopReports.forEach(function(r, i){
      var color = efColor(r.scale);
      var item = document.createElement('div');
      item.style.cssText = 'padding:4px 6px;border-top:1px solid rgba(255,255,255,.06);cursor:pointer;font-size:.55rem;color:#eee;display:flex;align-items:center;gap:5px;';
      item.innerHTML = '<span style="font-weight:800;color:' + color + ';min-width:28px;">' + (r.scale === 'UNK' ? '?' : r.scale) + '</span>' +
        '<span style="flex:1;opacity:.85;">' + r.location + ', ' + r.state + '</span>' +
        '<span style="opacity:.4;font-size:.48rem;">' + r.dateLabel + '</span>';
      item.onclick = function(){ if (tornadoMap) tornadoMap.setView([r.lat, r.lon], 10); };
      list.appendChild(item);
    });
  }

  function finalizeTornado(reports, count, statusEl, liveEl, yearCountEl, listEl, rangeLabel){
    if (statusEl){
      var yearText = yearCountEl ? yearCountEl.textContent : '--';
      statusEl.innerHTML = ' ' + count + ' (' + rangeLabel + ')  <span style="color:#ff6b6b;">2026: ' + yearText + '</span>';
    }
    if (liveEl) liveEl.textContent = count > 0 ? ' LIVE' : ' QUIET';
    if (liveEl && count === 0) liveEl.style.color = '#888';

    // Populate list
    if (listEl){
      listEl.innerHTML = '';
      if (reports.length === 0){
        listEl.innerHTML = '<div style="padding:8px;color:#888;font-size:.55rem;text-align:center;">No tornado reports (' + rangeLabel + ')</div>';
      } else {
        listEl.innerHTML = '<div style="padding:4px 6px;font-size:.5rem;font-weight:700;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.05em;">Recent Reports  ' + rangeLabel + '</div>';
        // Sort by most recent first
        reports.sort(function(a,b){ return (b.dateLabel + b.time).localeCompare(a.dateLabel + a.time); });
        reports.slice(0, 30).forEach(function(r){
          var color = efColor(r.scale);
          var item = document.createElement('div');
          item.style.cssText = 'padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer;font-size:.62rem;color:#eee;display:flex;align-items:center;gap:6px;';
          item.innerHTML = '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + color + ';flex-shrink:0;"></span>' +
            '<span style="flex:1;"><b>' + (r.scale === 'UNK' ? 'Tornado' : r.scale) + '</b>  ' + r.location + ', ' + r.state + '<br><span style="opacity:.5">' + r.dateLabel + ' ' + r.time + ' UTC</span></span>';
          item.onclick = function(){
            if (tornadoMap) tornadoMap.setView([r.lat, r.lon], 10);
          };
          listEl.appendChild(item);
        });
      }
    }
  }

  // ============ SPC FORECAST MODE ============
  var spcBaseUrl = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/';

  function loadSPCForecast(){
    if (!tornadoMap) return;
    var statusEl = document.getElementById('tornado-status-pill');
    if (statusEl) statusEl.textContent = ' Loading forecast...';

    var catColors = {
      'TSTM': {color:'#76ff03', fill:0.08},
      'MRGL': {color:'#66bb6a', fill:0.12},
      'SLGT': {color:'#fdd835', fill:0.18},
      'ENH':  {color:'#ffa726', fill:0.22},
      'MDT':  {color:'#ef5350', fill:0.28},
      'HIGH': {color:'#ec407a', fill:0.35}
    };

    var tornProb = {
      '0.02': {color:'#66bb6a', fill:0.12},
      '0.05': {color:'#fdd835', fill:0.18},
      '0.10': {color:'#ffa726', fill:0.22},
      '0.15': {color:'#ef5350', fill:0.28},
      '0.30': {color:'#ab47bc', fill:0.32},
      '0.45': {color:'#ec407a', fill:0.38},
      '0.60': {color:'#d50000', fill:0.42}
    };

    // Day 1 Categorical (layer 1)
    fetchSPCLayer(1, function(data){
      var layer = L.geoJSON(data, {
        style: function(f){
          var cat = (f.properties.LABEL || f.properties.label || '').toUpperCase().trim();
          var s = catColors[cat] || {color:'#aaa', fill:0.1};
          return {color:s.color, weight:1.5, fillColor:s.color, fillOpacity:s.fill, dashArray:'6 3'};
        },
        onEachFeature: function(f,l){
          var cat = f.properties.LABEL || f.properties.label || '';
          l.bindTooltip('<span style="font-size:.5rem;"><b>Day 1 Categorical</b><br>' + cat + ' Risk</span>',{sticky:true});
        }
      }).addTo(tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 1 Tornado Probability (layer 3)
    fetchSPCLayer(3, function(data){
      var layer = L.geoJSON(data, {
        style: function(f){
          var label = (f.properties.LABEL || f.properties.label || '').toString();
          var pct = parseFloat(label) || 0;
          var key = (pct/100).toFixed(2);
          var s = tornProb[key] || {color:'#ffa726', fill:0.15};
          return {color:s.color, weight:2, fillColor:s.color, fillOpacity:s.fill};
        },
        onEachFeature: function(f,l){
          var label = f.properties.LABEL || f.properties.label || '';
          l.bindTooltip('<span style="font-size:.5rem;"><b> Day 1 Tornado</b><br>' + label + '% probability</span>',{sticky:true});
        }
      }).addTo(tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 1 Significant Tornado (layer 2)
    fetchSPCLayer(2, function(data){
      var layer = L.geoJSON(data, {
        style: function(){
          return {color:'#d50000', weight:3, fillColor:'#d50000', fillOpacity:0.15, dashArray:'4 2'};
        },
        onEachFeature: function(f,l){
          l.bindTooltip('<span style="font-size:.5rem;"><b> SIGNIFICANT TORNADO</b><br>EF2+ potential</span>',{sticky:true});
        }
      }).addTo(tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 2 Tornado Probability (layer 11)
    fetchSPCLayer(11, function(data){
      var layer = L.geoJSON(data, {
        style: function(f){
          var label = (f.properties.LABEL || f.properties.label || '').toString();
          return {color:'#ce93d8', weight:1.5, fillColor:'#ce93d8', fillOpacity:0.1, dashArray:'8 4'};
        },
        onEachFeature: function(f,l){
          var label = f.properties.LABEL || f.properties.label || '';
          l.bindTooltip('<span style="font-size:.5rem;"><b> Day 2 Tornado</b><br>' + label + '% probability</span>',{sticky:true});
        }
      }).addTo(tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 2 Significant Tornado (layer 10)
    fetchSPCLayer(10, function(data){
      var layer = L.geoJSON(data, {
        style: function(){
          return {color:'#9c27b0', weight:2.5, fillColor:'#9c27b0', fillOpacity:0.1, dashArray:'4 2'};
        },
        onEachFeature: function(f,l){
          l.bindTooltip('<span style="font-size:.5rem;"><b> Day 2 SIG TORNADO</b><br>EF2+ potential</span>',{sticky:true});
        }
      }).addTo(tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Day 3 Probabilistic (layer 19)
    fetchSPCLayer(19, function(data){
      var layer = L.geoJSON(data, {
        style: function(){
          return {color:'#4fc3f7', weight:1, fillColor:'#4fc3f7', fillOpacity:0.06, dashArray:'10 5'};
        },
        onEachFeature: function(f,l){
          var label = f.properties.LABEL || f.properties.label || '';
          l.bindTooltip('<span style="font-size:.5rem;"><b>Day 3 Severe</b><br>' + label + '% probability</span>',{sticky:true});
        }
      }).addTo(tornadoMap);
      tornadoOutlookLayers.push(layer);
    });

    // Days 4-8 Probabilistic (layers 21-25)
    for (var day = 4; day <= 8; day++){
      (function(d){
        fetchSPCLayer(17 + d, function(data){
          var layer = L.geoJSON(data, {
            style: function(){
              var op = Math.max(0.03, 0.08 - (d-4)*0.01);
              return {color:'#90a4ae', weight:1, fillColor:'#90a4ae', fillOpacity:op, dashArray:'12 6'};
            },
            onEachFeature: function(f,l){
              var label = f.properties.LABEL || f.properties.label || '';
              l.bindTooltip('<span style="font-size:.5rem;"><b>Day ' + d + ' Severe</b><br>' + label + '% probability</span>',{sticky:true});
            }
          }).addTo(tornadoMap);
          tornadoOutlookLayers.push(layer);
        });
      })(day);
    }

    // Update status when done
    setTimeout(function(){
      if (statusEl) statusEl.textContent = ' SPC Days 1-8 Forecast';
    }, 2000);
  }

  function fetchSPCLayer(layerId, callback){
    var url = spcBaseUrl + layerId + '/query?where=1%3D1&outFields=*&f=geojson';
    fetch(url).then(function(r){ return r.json(); }).then(function(data){
      if (data.features && data.features.length > 0) callback(data);
    }).catch(function(){});
  }

  // ============ FIRE MAP ============
  var smokeLayer = null;
  var smokeVisible = true;
  var fireLabelsLayer = null;
  var fireLabelsVisible = false;
  var aqiStations = [];
  var aqiPillVisible = false;
  
  function initFireMap(){
    var container = document.getElementById("fire-map");
    var liveEl = document.getElementById("fire-live");
    var statusPill = document.getElementById("fire-status-pill");
    
    if (!container || typeof L === "undefined") return;

    if (fireMap) fireMap.remove();
    
    // Determine regional view based on user location
    var mapCenter = [45, -100];
    var mapZoom = 3;
    
    if (LOCATION && LOCATION.lat && LOCATION.lon) {
      // Northeast (NY, New England, Eastern Canada)
      if (LOCATION.lon > -85 && LOCATION.lat > 38) {
        mapCenter = [44, -74];
        mapZoom = 5;
      }
      // Southeast (FL, GA, Carolinas)
      else if (LOCATION.lon > -90 && LOCATION.lat <= 38 && LOCATION.lat > 25) {
        mapCenter = [32, -82];
        mapZoom = 5;
      }
      // Midwest (IL, OH, MI, WI)
      else if (LOCATION.lon > -100 && LOCATION.lon <= -85 && LOCATION.lat > 36) {
        mapCenter = [42, -90];
        mapZoom = 5;
      }
      // Southwest (CA, AZ, NV, NM)
      else if (LOCATION.lon <= -110 && LOCATION.lat <= 42 && LOCATION.lat > 30) {
        mapCenter = [36, -118];
        mapZoom = 5;
      }
      // Pacific Northwest (WA, OR, BC)
      else if (LOCATION.lon <= -115 && LOCATION.lat > 42) {
        mapCenter = [46, -122];
        mapZoom = 5;
      }
      // Texas / South Central
      else if (LOCATION.lon > -105 && LOCATION.lon <= -90 && LOCATION.lat <= 36) {
        mapCenter = [31, -98];
        mapZoom = 5;
      }
      // Mountain West (CO, UT, WY, MT)
      else if (LOCATION.lon <= -100 && LOCATION.lon > -115 && LOCATION.lat > 36) {
        mapCenter = [42, -110];
        mapZoom = 5;
      }
    }
    
    fireMap = L.map(container, {
      center: mapCenter,
      zoom: mapZoom,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 12
    });

    // ESRI World Imagery (satellite) for land cover context - shows forests, fields, urban areas
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
      attribution: '&copy; Esri, Maxar, Earthstar Geographics'
    }).addTo(fireMap);

    // NWS Smoke Forecast Layer (48-hour surface smoke concentration)
    loadSmokeLayer();
    loadHRRRSmokeOverlay();

    // Add acre legend
    var fireLegend = L.control({ position: 'bottomright' });
    fireLegend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'fire-legend');
      div.style.cssText = 'background:rgba(255,255,255,.06); padding:4px 6px; border-radius:6px; font-size:9px; font-weight:600; font-family:system-ui,sans-serif; box-shadow:0 1px 4px rgba(0,0,0,.12);';
      div.innerHTML = 
        '<div style="display:flex; flex-direction:column; gap:2px;">' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">&lt;1K</span><span style="width:6px;height:6px;border-radius:50%;background:#fbbf24;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">1K</span><span style="width:7px;height:7px;border-radius:50%;background:#f97316;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">10K</span><span style="width:8px;height:8px;border-radius:50%;background:#dc2626;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">50K+</span><span style="width:9px;height:9px;border-radius:50%;background:#7f1d1d;"></span></div>' +
        '</div>';
      return div;
    };
    fireLegend.addTo(fireMap);

    // Load fire data
    loadFireData();
    
    // Refresh daily (every 24 hours)
    setInterval(loadFireData, 24 * 60 * 60 * 1000);

    if (liveEl) liveEl.textContent = " LIVE";
  }

  function loadFireData(){
    var statusPill = document.getElementById("fire-status-pill");
    
    // NASA FIRMS requires API key - using NIFC as primary source
    // To use FIRMS: get key from https://firms.modaps.eosdis.nasa.gov/api/area/
    // var firmsUrl = "https://firms.modaps.eosdis.nasa.gov/api/area/csv/YOUR_API_KEY/VIIRS_SNPP_NRT/" + bbox + "/1";
    
    // NIFC current wildland fire incidents - ALL US (InciWeb data)
    var nifcUrl = "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/USA_Wildfires_v1/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=geojson";

    // Clear old markers
    fireMarkers.forEach(function(m){ fireMap.removeLayer(m); });
    fireMarkers = [];

    fetchWithTimeout(nifcUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        var fires = data && data.features;
        
        if (!fires || fires.length === 0){
          if (statusPill) {
            statusPill.textContent = " 0 ACTIVE FIRES (7D)";
            statusPill.style.color = "#22c55e";
          }
          return;
        }

        var nearbyCount = 0;
        var totalCount = fires.length;
        var largeCount = 0;

        fires.forEach(function(fire){
          var coords = fire.geometry && fire.geometry.coordinates;
          var props = fire.properties || {};
          if (!coords) return;

          var lat = coords[1];
          var lon = coords[0];
          var name = props.IncidentName || props.FireName || "Unknown Fire";
          var acres = props.DailyAcres || props.GISAcres || 0;
          var contained = props.PercentContained || 0;

          // Calculate distance
          var dLat = lat - LOCATION.lat;
          var dLon = lon - LOCATION.lon;
          var dist = Math.sqrt(dLat*dLat + dLon*dLon) * 69;

          if (dist < 200) nearbyCount++;
          if (acres > 1000) largeCount++;

          // Size/color by acres (smaller to reduce crowding, proportional to thresholds)
          var radius;
          var color;
          if (acres >= 50000) {
            radius = 7;
            color = "#7f1d1d";
          } else if (acres >= 10000) {
            radius = 5.5;
            color = "#dc2626";
          } else if (acres >= 1000) {
            radius = 4;
            color = "#f97316";
          } else {
            radius = 2.5;
            color = "#fbbf24";
          }

          var marker = L.circleMarker([lat, lon], {
            radius: radius,
            fillColor: color,
            fillOpacity: 0.85,
            color: '#fff',
            weight: 1
          }).addTo(fireMap);

          var acresStr = acres > 0 ? acres.toLocaleString() + " acres" : "Size unknown";
          var containStr = contained > 0 ? "  " + contained + "% contained" : "";
          marker.bindPopup("<div class='fire-name'> " + name + "</div><div class='fire-stat'>" + acresStr + containStr + "</div>", { closeButton: false, className: 'fire-popup', maxWidth: 180 });

          fireMarkers.push(marker);
        });

        if (statusPill){
          statusPill.textContent = " " + totalCount + " ACTIVE FIRE" + (totalCount !== 1 ? "S" : "") + " (7D)";
          statusPill.style.color = largeCount > 0 ? "#dc2626" : (nearbyCount > 0 ? "#f97316" : "#22c55e");
        }
        // Store fires globally for AQI smoke source analysis
        window._activeFires = fires;

        // Now create smoke heatmap from fire locations
        createSmokeHeatmap();

        // Build dropdown list of top 5 largest fires
        var fireListEl = document.getElementById("fire-list");
        if (fireListEl && fires.length > 0){
          var sorted = fires.slice().sort(function(a,b){
            var aAcres = (a.properties.DailyAcres || a.properties.GISAcres || a.properties.CalculatedAcres || 0);
            var bAcres = (b.properties.DailyAcres || b.properties.GISAcres || b.properties.CalculatedAcres || 0);
            return bAcres - aAcres;
          }).slice(0, 5);
          
          var listHtml = "";
          for (var fi = 0; fi < sorted.length; fi++){
            var f = sorted[fi];
            var props = f.properties || {};
            var coords = f.geometry && f.geometry.coordinates;
            var fName = props.IncidentName || props.FireName || props.poly_IncidentName || "Unknown Fire";
            var fAcres = props.DailyAcres || props.GISAcres || props.CalculatedAcres || 0;
            var fContained = props.PercentContained || props.poly_PercentContained || 0;
            var lat = coords ? coords[1] : 0;
            var lon = coords ? coords[0] : 0;
            
            // Format acres
            var acresStr = "";
            if (fAcres >= 1000){
              acresStr = (fAcres / 1000).toFixed(1) + "K";
            } else {
              acresStr = Math.round(fAcres).toLocaleString();
            }
            
            var acreColor;
            if (fAcres >= 50000) acreColor = "#7f1d1d";
            else if (fAcres >= 10000) acreColor = "#dc2626";
            else if (fAcres >= 1000) acreColor = "#f97316";
            else acreColor = "#fbbf24";
            
            listHtml += '<div class="fire-item" onclick="window.flyToFire('+lat+','+lon+')" style="padding:5px 8px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:6px;">' +
              '<span style="color:'+acreColor+';font-weight:800;font-size:.72rem;min-width:36px;">'+acresStr+'</span>' +
              '<span style="color:#fff;font-size:.66rem;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+fName+'</span>' +
              (fContained > 0 ? '<span style="color:rgba(255,255,255,.5);font-size:.56rem;font-weight:600;">'+fContained+'%</span>' : '') +
            '</div>';
          }
          
          fireListEl.innerHTML = listHtml;
        }
        
        // Global function for fire click
        window.flyToFire = function(lat, lon){
          if (fireMap && !isNaN(lat) && !isNaN(lon)){
            fireMap.flyTo([lat, lon], 8, { duration: 1 });
          }
        };
      })
      .catch(function(err){
        console.log("Fire data error:", err);
        if (statusPill){
          statusPill.textContent = " DATA UNAVAILABLE";
          statusPill.style.color = "#888";
        }
      });
  }

  // ============ SMOKE FORECAST LAYER ============
  var smokeGeoJsonLayer = null;
  var goesOverlay = null;
  var aqiHeatLayer = null;
  var aqiBlobMarkers = [];
  
  function loadSmokeLayer(){
    if (!fireMap) return;
    
    // Remove existing layers
    if (smokeGeoJsonLayer && fireMap.hasLayer(smokeGeoJsonLayer)){
      fireMap.removeLayer(smokeGeoJsonLayer);
    }
    
    // Fetch real HMS smoke polygons from NOAA via ArcGIS Feature Service
    var hmsUrl = "https://services9.arcgis.com/RGao6tMQSJKyNRvN/arcgis/rest/services/NOAA_HMS_Smoke_Detection/FeatureServer/0/query?where=1%3D1&outFields=Density&returnGeometry=true&outSR=4326&resultType=tile&f=geojson";
    
    fetchWithTimeout(hmsUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (!data || !data.features || data.features.length === 0){
          console.log("HMS Smoke: No smoke polygons found");
          updateSmokePill("clear");
          return;
        }
        
        var densityStyles = {
          "Light":  { color: "#fbbf24", fillColor: "#fbbf24", fillOpacity: 0.15, weight: 1, opacity: 0.4 },
          "Medium": { color: "#f97316", fillColor: "#f97316", fillOpacity: 0.25, weight: 1, opacity: 0.5 },
          "Heavy":  { color: "#dc2626", fillColor: "#dc2626", fillOpacity: 0.40, weight: 1.5, opacity: 0.6 }
        };
        
        smokeGeoJsonLayer = L.geoJSON(data, {
          style: function(feature){
            var density = feature.properties.Density || "Light";
            return densityStyles[density] || densityStyles["Light"];
          },
          onEachFeature: function(feature, layer){
            var d = feature.properties.Density || "Unknown";
            layer.bindPopup("<b>HMS Smoke</b><br>Density: " + d + "<br><span style='font-size:10px;color:#888;'>Source: NOAA Satellite Analysis Branch</span>");
          }
        }).addTo(fireMap);
        
        console.log("HMS Smoke: Loaded " + data.features.length + " real smoke polygons");
        updateSmokePill("hms");
      })
      .catch(function(err){
        console.log("HMS Smoke fetch error:", err);
      });
  }
  
  function createSmokeHeatmap(){
    // Deprecated  using real NOAA HRRR smoke forecast overlay
  }
  
  var hrrrSmokeLayer = null;
  var smokePill = null;
  
  function loadHRRRSmokeOverlay(){
    if (!fireMap) return;
    if (hrrrSmokeLayer && fireMap.hasLayer(hrrrSmokeLayer)){
      fireMap.removeLayer(hrrrSmokeLayer);
    }
    
    // Check if HRRR smoke service has current data before adding WMS
    var now = new Date();
    var checkUrl = "https://mapservices.weather.noaa.gov/raster/rest/services/air_quality/ndgd_smoke_vert_1hr_avg_time/ImageServer?f=json";
    
    fetchWithTimeout(checkUrl, null, 10000)
      .then(function(r){ return r.json(); })
      .then(function(info){
        var hasData = false;
        var timeInfo = info && info.timeInfo;
        if (timeInfo && timeInfo.timeExtent && timeInfo.timeExtent.length === 2){
          var endTime = new Date(timeInfo.timeExtent[1]);
          var ageMins = (now - endTime) / 60000;
          // Data is current if end time is recent or in the future (forecast)
          if (ageMins < 1440 || ageMins < 0) hasData = true;
          console.log("HRRR Smoke: data ends " + endTime.toISOString() + " (" + Math.round(ageMins/60) + "h ago)");
        }
        
        if (hasData){
          hrrrSmokeLayer = L.tileLayer.wms("https://mapservices.weather.noaa.gov/raster/services/air_quality/ndgd_smoke_vert_1hr_avg_time/ImageServer/WMSServer?", {
            layers: "0",
            format: "image/png",
            transparent: true,
            opacity: 0.5,
            attribution: "NOAA/NWS HRRR-Smoke"
          }).addTo(fireMap);
        }
        // Pill status based on whether actual smoke polygons exist
        if (!smokePill) updateSmokePill(smokeGeoJsonLayer ? "hms" : "clear");
      })
      .catch(function(err){
        console.log("HRRR Smoke check error:", err);
        updateSmokePill(smokeGeoJsonLayer ? "hms" : "clear");
      });
  }
  
  function updateSmokePill(status){
    if (!fireMap) return;
    
    if (!smokePill){
      smokePill = L.control({ position: 'bottomleft' });
      smokePill.onAdd = function(){
        var div = L.DomUtil.create('div', 'smoke-status-pill');
        div.style.cssText = 'background:rgba(0,0,0,.55);padding:3px 8px;border-radius:10px;font-size:10px;font-weight:600;font-family:system-ui,sans-serif;letter-spacing:.3px;margin-top:4px;';
        return div;
      };
      smokePill.addTo(fireMap);
    }
    
    var el = smokePill.getContainer();
    if (!el) return;
    
    if (status === "active"){
      el.innerHTML = ' <span style="color:#f97316;">SMOKE DETECTED</span>';
    } else if (status === "hms"){
      el.innerHTML = ' <span style="color:#fbbf24;">HMS SMOKE</span>';
    } else {
      el.innerHTML = ' <span style="color:#4ade80;">CLEAR</span>';
    }
  }
  
  // ============ CITY/STATE LABELS TOGGLE ============
  function toggleFireLabels(){
    var btn = document.getElementById("fire-labels-toggle");
    fireLabelsVisible = !fireLabelsVisible;
    
    if (fireLabelsVisible){
      if (!fireLabelsLayer){
        fireLabelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap, &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 12
        }).addTo(fireMap);
      } else {
        fireMap.addLayer(fireLabelsLayer);
      }
      if (btn) {
        btn.innerHTML = ' ON';
        btn.style.color = '#22c55e';
        btn.style.borderColor = 'rgba(34,197,94,.4)';
      }
    } else {
      if (fireLabelsLayer && fireMap.hasLayer(fireLabelsLayer)){
        fireMap.removeLayer(fireLabelsLayer);
      }
      if (btn) {
        btn.innerHTML = ' OFF';
        btn.style.color = 'rgba(255,255,255,.4)';
        btn.style.borderColor = 'rgba(255,255,255,.15)';
      }
    }
  }
  
  window.toggleFireLabels = toggleFireLabels;
  
  // ============ AQI CURSOR TRACKING ============
  
  
  
  
  

  // ============ MACROSTRAT GEOLOGY MAPS ============
  var bedrockMap = null;
  var lithologyMap = null;
  var stratMap = null;
  
  // Macrostrat tile and API endpoints
  var MACROSTRAT_TILES = 'https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png';
  var MACROSTRAT_API = 'https://macrostrat.org/api/v2/geologic_units/map';
  
  // Cache for geology data to avoid repeated API calls
  var geologyCache = {};
  
  function initGeologyMaps(){
    initBedrockMap();
    initLithologyMap();
    initStratMap();
  }
  
  // ============ BEDROCK GEOLOGY MAP ============
  function initBedrockMap(){
    var container = document.getElementById("bedrock-map");
    var infoPill = document.getElementById("bedrock-info-pill");
    
    if (!container || typeof L === "undefined") return;

    if (bedrockMap) bedrockMap.remove();
    bedrockMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 8,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 14
    });

    // Base layer - light map
    L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(bedrockMap);
    
    // Macrostrat geology overlay
    L.tileLayer(MACROSTRAT_TILES, {
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
      opacity: 0.75
    }).addTo(bedrockMap);
    
    // Add location marker
    L.circleMarker([LOCATION.lat, LOCATION.lon], {
      radius: 8,
      fillColor: '#2B22F4',
      fillOpacity: 0.9,
      color: '#fff',
      weight: 2
    }).addTo(bedrockMap).bindTooltip(" " + LOCATION.name, { permanent: false });

    // Click handler for geology info
    bedrockMap.on('click', function(e){
      fetchGeologyAtPoint(e.latlng.lat, e.latlng.lng, 'bedrock', infoPill);
    });
    
    // Load initial geology for current location
    fetchGeologyAtPoint(LOCATION.lat, LOCATION.lon, 'bedrock', infoPill);
  }
  
  // ============ LITHOLOGY MAP ============
  function initLithologyMap(){
    var container = document.getElementById("lithology-map");
    var infoPill = document.getElementById("lithology-info-pill");
    
    if (!container || typeof L === "undefined") return;

    if (lithologyMap) lithologyMap.remove();
    lithologyMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 9,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 14
    });

    // Base layer
    L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(lithologyMap);
    
    // Macrostrat geology overlay with higher opacity for lithology focus
    L.tileLayer(MACROSTRAT_TILES, {
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
      opacity: 0.85
    }).addTo(lithologyMap);
    
    // Add location marker
    L.circleMarker([LOCATION.lat, LOCATION.lon], {
      radius: 8,
      fillColor: '#2B22F4',
      fillOpacity: 0.9,
      color: '#fff',
      weight: 2
    }).addTo(lithologyMap).bindTooltip(" " + LOCATION.name, { permanent: false });

    // Click handler
    lithologyMap.on('click', function(e){
      fetchGeologyAtPoint(e.latlng.lat, e.latlng.lng, 'lithology', infoPill);
    });
    
    // Load initial
    fetchGeologyAtPoint(LOCATION.lat, LOCATION.lon, 'lithology', infoPill);
  }
  
  // ============ STRATIGRAPHY MAP ============
  function initStratMap(){
    var container = document.getElementById("strat-map");
    var infoPill = document.getElementById("strat-info-pill");
    
    if (!container || typeof L === "undefined") return;

    if (stratMap) stratMap.remove();
    stratMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 7,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 14
    });

    // Base layer
    L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(stratMap);
    
    // Macrostrat geology overlay
    L.tileLayer(MACROSTRAT_TILES, {
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
      opacity: 0.70
    }).addTo(stratMap);
    
    // Add location marker
    L.circleMarker([LOCATION.lat, LOCATION.lon], {
      radius: 8,
      fillColor: '#2B22F4',
      fillOpacity: 0.9,
      color: '#fff',
      weight: 2
    }).addTo(stratMap).bindTooltip(" " + LOCATION.name, { permanent: false });

    // Click handler
    stratMap.on('click', function(e){
      fetchGeologyAtPoint(e.latlng.lat, e.latlng.lng, 'strat', infoPill);
    });
    
    // Load initial
    fetchGeologyAtPoint(LOCATION.lat, LOCATION.lon, 'strat', infoPill);
  }
  
  // ============ FETCH GEOLOGY DATA FROM MACROSTRAT ============
  function fetchGeologyAtPoint(lat, lng, mapType, infoPill){
    var cacheKey = lat.toFixed(4) + ',' + lng.toFixed(4);
    
    // Check cache first
    if (geologyCache[cacheKey]){
      displayGeologyInfo(geologyCache[cacheKey], mapType, infoPill);
      return;
    }
    
    var url = MACROSTRAT_API + '?lat=' + lat + '&lng=' + lng;
    
    fetchWithTimeout(url, null, 10000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.success && data.success.data && data.success.data.length > 0){
          geologyCache[cacheKey] = data.success.data;
          displayGeologyInfo(data.success.data, mapType, infoPill);
        } else {
          hideGeologyInfo(mapType, infoPill);
        }
      })
      .catch(function(err){
        console.log("Macrostrat API error:", err);
        hideGeologyInfo(mapType, infoPill);
      });
  }
  
  function displayGeologyInfo(units, mapType, infoPill){
    if (!infoPill || !units || units.length === 0) return;
    
    var unit = units[0]; // Primary unit at surface
    
    if (mapType === 'bedrock'){
      var nameEl = document.getElementById("bedrock-unit-name");
      var ageEl = document.getElementById("bedrock-age");
      var lithEl = document.getElementById("bedrock-lith");
      
      if (nameEl) nameEl.textContent = unit.strat_name || unit.name || "Unknown Unit";
      if (ageEl){
        var ageStr = "";
        if (unit.b_int_name && unit.t_int_name){
          if (unit.b_int_name === unit.t_int_name){
            ageStr = unit.b_int_name;
          } else {
            ageStr = unit.t_int_name + "  " + unit.b_int_name;
          }
        } else if (unit.b_age && unit.t_age){
          ageStr = unit.t_age.toFixed(1) + "  " + unit.b_age.toFixed(1) + " Ma";
        }
        ageEl.textContent = ageStr ? " " + ageStr : "";
      }
      if (lithEl){
        var liths = unit.lith ? unit.lith.map(function(l){ return l.name || l; }).join(", ") : "";
        lithEl.textContent = liths ? " " + liths : "";
      }
    } else if (mapType === 'lithology'){
      var primaryEl = document.getElementById("lithology-primary");
      var descEl = document.getElementById("lithology-desc");
      
      var primaryLith = "";
      var lithDesc = "";
      
      if (unit.lith && unit.lith.length > 0){
        // Sort by proportion if available
        var sorted = unit.lith.slice().sort(function(a,b){
          return (b.prop || 0) - (a.prop || 0);
        });
        primaryLith = sorted[0].name || sorted[0];
        
        // Build description with proportions
        lithDesc = sorted.map(function(l){
          var pct = l.prop ? Math.round(l.prop * 100) + "%" : "";
          return (l.name || l) + (pct ? " (" + pct + ")" : "");
        }).join(", ");
      }
      
      if (primaryEl) primaryEl.textContent = primaryLith ? " " + primaryLith : "Unknown Lithology";
      if (descEl) descEl.textContent = lithDesc || (unit.descrip || "");
    } else if (mapType === 'strat'){
      var columnEl = document.getElementById("strat-column");
      var unitsEl = document.getElementById("strat-units");
      var thickEl = document.getElementById("strat-thickness");
      
      if (columnEl) columnEl.textContent = unit.col_name || unit.strat_name || "Stratigraphic Column";
      
      // Show all units at this location
      var unitNames = units.map(function(u){ return u.strat_name || u.name || "Unnamed"; });
      if (unitsEl) unitsEl.textContent = " " + unitNames.slice(0, 5).join("  ") + (units.length > 5 ? " +" + (units.length - 5) + " more" : "");
      
      // Total thickness
      var totalThick = 0;
      units.forEach(function(u){
        if (u.max_thick) totalThick += u.max_thick;
      });
      if (thickEl) thickEl.textContent = totalThick > 0 ? " ~" + Math.round(totalThick) + " m total thickness" : "";
    }
    
    infoPill.style.display = "block";
  }
  
  function hideGeologyInfo(mapType, infoPill){
    if (infoPill){
      infoPill.style.display = "none";
    }
  }

  // ============ EARTHQUAKE MAP ============
  function initQuakeMap(){
    var container = document.getElementById("quake-map");
    var liveEl = document.getElementById("quake-live");
    
    if (!container || typeof L === "undefined") return;

    // Create map - centered on location but allow global exploration
    if (quakeMap) quakeMap.remove();
    quakeMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 6,
      zoomControl: false,
      attributionControl: false,
      minZoom: 1,
      maxZoom: 10,
      worldCopyJump: true
    });

    // Light base map for when geology is off (countries/states visible)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { 
      attribution: TILE_ATTRIB
    }).addTo(quakeMap);
    
    // Macrostrat geology overlay (can be toggled)
    quakeGeoLayer = L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png', { 
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>'
    }).addTo(quakeMap);
    
    // City/state labels on top
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { 
      attribution: TILE_ATTRIB,
      pane: 'shadowPane'
    }).addTo(quakeMap);

    // Click handler for geology popup - uses shared fetchGeologyForQuakeMap function
    quakeMap.on('click', function(e){
      fetchGeologyForQuakeMap(e.latlng.lat, e.latlng.lng, e.latlng);
    });

    // Add magnitude legend
    var legend = L.control({ position: 'bottomright' });
    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'quake-legend');
      div.style.cssText = 'background:rgba(255,255,255,.06); box-shadow:0 0 30px rgba(255,255,255,.10), inset 0 0 20px rgba(255,255,255,.18); padding:4px 6px; border-radius:6px; font-size:9px; font-weight:600; font-family:system-ui,sans-serif;';
      div.innerHTML = 
        '<div style="display:flex; flex-direction:column; gap:2px;">' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">&lt;1.5</span><span style="width:4px;height:4px;border-radius:50%;background:#7dd3fc;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">1.5</span><span style="width:5px;height:5px;border-radius:50%;background:#4ade80;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">2.5</span><span style="width:6px;height:6px;border-radius:50%;background:#84cc16;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">3.5</span><span style="width:7px;height:7px;border-radius:50%;background:#eab308;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">4.5</span><span style="width:8px;height:8px;border-radius:50%;background:#f97316;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">5.5</span><span style="width:9px;height:9px;border-radius:50%;background:#ef4444;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">6.5</span><span style="width:10px;height:10px;border-radius:50%;background:#dc2626;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">7+</span><span style="width:11px;height:11px;border-radius:50%;background:#7f1d1d;"></span></div>' +
        '</div>';
      return div;
    };
    legend.addTo(quakeMap);

    // USGS earthquakes - GLOBAL, past 24 hours, ALL magnitudes (M0.5+)
    var url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson";

    fetchWithTimeout(url, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        var quakes = data && data.features;
        
        if (!quakes || quakes.length === 0){
          if (liveEl) liveEl.textContent = " LIVE";
          var statusPill = document.getElementById("quake-status-pill");
          if (statusPill){
            statusPill.textContent = " 0 QUAKES (24H)";
            statusPill.style.color = "#4ade80";
          }
          return;
        }

        var nearbyCount = 0;
        var significantCount = 0;
        var totalCount = 0;

        // Plot ALL global quakes M0.5+
        for (var i = 0; i < quakes.length; i++){
          var q = quakes[i];
          var coords = q.geometry && q.geometry.coordinates;
          var props = q.properties || {};
          
          if (!coords) continue;

          var mag = props.mag || 0;
          var lat = coords[1];
          var lon = coords[0];

          // Only show M0.5+
          if (mag < 0.5) continue;

          totalCount++;

          // Calculate distance
          var dLat = lat - LOCATION.lat;
          var dLon = lon - LOCATION.lon;
          var dist = Math.sqrt(dLat*dLat + dLon*dLon) * 69;

          if (dist < 500) nearbyCount++;
          if (mag >= 5.5) significantCount++;

          // Color by magnitude
          var color;
          if (mag >= 7) color = "#7f1d1d";
          else if (mag >= 6.5) color = "#dc2626";
          else if (mag >= 5.5) color = "#ef4444";
          else if (mag >= 4.5) color = "#f97316";
          else if (mag >= 3.5) color = "#eab308";
          else if (mag >= 2.5) color = "#84cc16";
          else if (mag >= 1.5) color = "#4ade80";
          else color = "#7dd3fc";

          // Size by magnitude - more consistent scaling
          var radius;
          if (mag >= 6) radius = 10;
          else if (mag >= 5) radius = 8;
          else if (mag >= 4) radius = 6;
          else if (mag >= 3) radius = 5;
          else if (mag >= 2) radius = 4;
          else radius = 3;

          var marker = L.circleMarker([lat, lon], {
            radius: radius,
            fillColor: color,
            fillOpacity: 0.85,
            color: '#fff',
            weight: 1
          }).addTo(quakeMap);

          var place = props.place || "Unknown";
          var time = props.time ? timeAgo(new Date(props.time)) : "";
          var distStr = dist < 10000 ? (Math.round(dist) + " mi away  ") : "";
          marker.bindTooltip("M" + mag.toFixed(1) + " - " + place + "<br>" + distStr + time, { 
            permanent: false 
          });

          quakeMarkers.push(marker);
        }

        // Update status pill
        var statusPill = document.getElementById("quake-status-pill");
        if (statusPill){
          statusPill.textContent = " " + totalCount.toLocaleString() + " QUAKES (24H)";
          statusPill.style.color = significantCount > 0 ? "#f97316" : "#4ade80";
        }

        // Build dropdown list of top 10 recent quakes sorted by magnitude
        var quakeListEl = document.getElementById("quake-list");
        if (quakeListEl && quakes.length > 0){
          var sorted = quakes.slice().sort(function(a,b){
            return (b.properties.mag || 0) - (a.properties.mag || 0);
          }).slice(0, 5);
          
          var listHtml = "";
          for (var qi = 0; qi < sorted.length; qi++){
            var q = sorted[qi];
            var props = q.properties || {};
            var coords = q.geometry && q.geometry.coordinates;
            var mag = props.mag || 0;
            var place = props.place || "Unknown";
            var lat = coords ? coords[1] : 0;
            var lon = coords ? coords[0] : 0;
            
            // Parse place to get city, state format
            var shortPlace = place;
            if (place.indexOf(" of ") > -1){
              shortPlace = place.split(" of ")[1] || place;
            }
            var parts = shortPlace.split(", ");
            if (parts.length >= 2){
              shortPlace = parts[0] + ", " + parts[1].substring(0,2).toUpperCase();
            }
            
            // Time ago condensed
            var timeStr = "";
            if (props.time){
              var mins = Math.floor((Date.now() - props.time) / 60000);
              if (mins < 60) timeStr = mins + "m";
              else if (mins < 1440) timeStr = Math.floor(mins/60) + "h";
              else timeStr = Math.floor(mins/1440) + "d";
            }
            
            var magColor;
            if (mag >= 6) magColor = "#dc2626";
            else if (mag >= 5) magColor = "#ef4444";
            else if (mag >= 4) magColor = "#f97316";
            else if (mag >= 3) magColor = "#eab308";
            else magColor = "#4ade80";
            
            listHtml += '<div class="quake-item" onclick="window.flyToQuake('+lat+','+lon+','+mag+')" style="padding:5px 8px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:6px;">' +
              '<span style="color:'+magColor+';font-weight:800;font-size:.75rem;min-width:26px;">'+mag.toFixed(1)+'</span>' +
              '<span style="color:#fff;font-size:.68rem;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+shortPlace+'</span>' +
              '<span style="color:rgba(255,255,255,.5);font-size:.58rem;font-weight:600;">'+timeStr+'</span>' +
            '</div>';
          }
          
          quakeListEl.innerHTML = listHtml;
        }
        
        // Global function for quake click
        window.flyToQuake = function(lat, lon, mag){
          if (quakeMap && !isNaN(lat) && !isNaN(lon)){
            var zoom = mag >= 6 ? 6 : (mag >= 4 ? 7 : 8);
            quakeMap.flyTo([lat, lon], zoom, { duration: 1 });
          }
        };

        if (liveEl) liveEl.textContent = " LIVE";
      })
      .catch(function(){
        if (liveEl) liveEl.textContent = " OFFLINE";
      });
  }

  // Fetch geology for earthquake map clicks - shows popup at click location
  function fetchGeologyForQuakeMap(lat, lng, latlng){
    var cacheKey = lat.toFixed(4) + ',' + lng.toFixed(4);
    
    // Check cache first
    if (geologyCache[cacheKey]){
      showQuakeGeologyPopup(geologyCache[cacheKey], latlng || L.latLng(lat, lng));
      return;
    }
    
    var url = MACROSTRAT_API + '?lat=' + lat + '&lng=' + lng;
    
    fetchWithTimeout(url, null, 10000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.success && data.success.data && data.success.data.length > 0){
          geologyCache[cacheKey] = data.success.data;
          if (latlng) showQuakeGeologyPopup(data.success.data, latlng);
        }
      })
      .catch(function(err){});
  }
  
  var quakeGeoLayer = null;
  var quakeGeoVisible = true;
  
  window.toggleQuakeGeology = function(){
    var toggleEl = document.getElementById('quake-geo-toggle');
    if (!quakeMap) return;
    
    quakeGeoVisible = !quakeGeoVisible;
    
    if (quakeGeoVisible){
      // Add geology layer back
      quakeGeoLayer = L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png', { 
        attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
        zIndex: 100
      }).addTo(quakeMap);
      
      // Force it below markers but above base map
      quakeGeoLayer.setZIndex(100);
      
      if (toggleEl) {
        toggleEl.style.color = '#22c55e';
        toggleEl.style.borderColor = 'rgba(34,197,94,.4)';
        toggleEl.innerHTML = ' ON';
      }
    } else {
      // Remove geology layer
      if (quakeGeoLayer) {
        quakeMap.removeLayer(quakeGeoLayer);
        quakeGeoLayer = null;
      }
      if (toggleEl) {
        toggleEl.style.color = 'rgba(255,255,255,.4)';
        toggleEl.style.borderColor = 'rgba(255,255,255,.15)';
        toggleEl.innerHTML = ' OFF';
      }
    }
  };

  function showQuakeGeologyPopup(units, latlng){
    if (!quakeMap || !units || units.length === 0) return;
    
    var unit = units[0];
    var name = unit.strat_name || unit.name || "Unknown";
    
    // Build compact content
    var unitNames = units.slice(0, 3).map(function(u){ return u.strat_name || u.name || "Unnamed"; });
    var moreText = units.length > 3 ? " +" + (units.length - 3) : "";
    
    // Age info
    var ageStr = "";
    if (unit.b_int_name && unit.t_int_name){
      if (unit.b_int_name === unit.t_int_name){
        ageStr = unit.b_int_name;
      } else {
        ageStr = unit.t_int_name + " - " + unit.b_int_name;
      }
    }
    var numericAge = "";
    if (unit.t_age != null && unit.b_age != null){
      numericAge = Math.round(unit.t_age) + " - " + Math.round(unit.b_age) + " Ma";
    }
    
    var content = '<div style="font-size:11px; max-width:180px;">' +
      '<div style="color:#2563eb; font-weight:700; margin-bottom:2px;">' + name + '</div>' +
      (ageStr ? '<div style="color:#059669; font-size:10px; font-weight:600;">' + ageStr + '</div>' : '') +
      (numericAge ? '<div style="color:#888; font-size:9px;">' + numericAge + '</div>' : '') +
      '<div style="color:#555; font-size:10px; margin-top:2px;">' + unitNames.join(" > ") + moreText + '</div>' +
    '</div>';
    
    L.popup({ closeButton: false, offset: [0, -5], className: 'quake-geo-popup' })
      .setLatLng(latlng)
      .setContent(content)
      .openOn(quakeMap);
  }

  // Helper: time ago
  function timeAgo(date){
    var now = new Date();
    var diff = now - date;
    var mins = Math.floor(diff / 60000);
    var hours = Math.floor(diff / 3600000);
    var days = Math.floor(diff / 86400000);

    if (mins < 60) return mins + "m ago";
    if (hours < 24) return hours + "h ago";
    return days + "d ago";
  }

  initHazardMaps();

  /* =========================================================
     WEATHER ALERTS (NWS API)
     ========================================================= */
  var DEMO_ALERTS = false; // Set to true to see sample alerts
  
  var alertGeometries = [];
  
  // Check if user location is within SPC tornado outlook polygons
  function checkSPCTornadoRisk(callback){
    var spcUrl = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/3/query?where=1%3D1&outFields=*&f=geojson';
    fetch(spcUrl).then(function(r){ return r.json(); }).then(function(data){
      if (!data.features || data.features.length === 0){ callback(null); return; }
      
      var userLat = LOCATION.lat;
      var userLon = LOCATION.lon;
      var highestRisk = null;
      var highestPct = 0;
      
      data.features.forEach(function(f){
        var label = (f.properties.LABEL || f.properties.label || '').toString();
        var pct = parseFloat(label) || 0;
        if (pointInGeoJSON(userLat, userLon, f.geometry) && pct > highestPct){
          highestPct = pct;
          highestRisk = f;
        }
      });
      
      if (highestRisk && highestPct >= 2){
        // Also check categorical outlook
        var catUrl = 'https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/1/query?where=1%3D1&outFields=*&f=geojson';
        fetch(catUrl).then(function(r2){ return r2.json(); }).then(function(catData){
          var catLevel = '';
          if (catData.features){
            catData.features.forEach(function(f){
              if (pointInGeoJSON(userLat, userLon, f.geometry)){
                catLevel = (f.properties.LABEL || f.properties.label || '').toUpperCase().trim();
              }
            });
          }
          
          var riskDesc = highestPct + '% tornado probability';
          if (catLevel && catLevel !== 'TSTM') riskDesc += ' (' + catLevel + ' risk)';
          
          var syntheticAlert = {
            _synthetic: true,
            properties: {
              event: 'SPC Tornado Outlook',
              headline: 'SPC Day 1 Tornado Outlook  ' + riskDesc,
              severity: highestPct >= 10 ? 'Extreme' : (highestPct >= 5 ? 'Severe' : 'Moderate'),
              description: 'The Storm Prediction Center has issued a Day 1 outlook indicating a ' + highestPct + '% probability of a tornado within 25 miles of your location.' + (catLevel ? ' Overall convective risk level: ' + catLevel + '.' : '') + ' Monitor local conditions and have a safety plan ready.',
              instruction: 'Stay weather-aware today. Monitor NOAA Weather Radio or local media for watches and warnings. Know your shelter location.',
              areaDesc: 'Your area',
              senderName: 'NOAA Storm Prediction Center',
              expires: new Date(new Date().setHours(23,59,59)).toISOString(),
              effective: new Date().toISOString(),
              onset: new Date().toISOString()
            }
          };
          callback(syntheticAlert);
        }).catch(function(){ callback(null); });
      } else {
        callback(null);
      }
    }).catch(function(){ callback(null); });
  }
  
  // Ray-casting point-in-polygon for GeoJSON
  function pointInGeoJSON(lat, lon, geometry){
    if (!geometry) return false;
    var polys = [];
    if (geometry.type === 'Polygon'){
      polys = [geometry.coordinates];
    } else if (geometry.type === 'MultiPolygon'){
      polys = geometry.coordinates;
    } else { return false; }
    
    for (var p = 0; p < polys.length; p++){
      var ring = polys[p][0]; // outer ring
      if (pointInRing(lat, lon, ring)) return true;
    }
    return false;
  }
  
  function pointInRing(lat, lon, ring){
    var inside = false;
    for (var i = 0, j = ring.length - 1; i < ring.length; j = i++){
      var xi = ring[i][0], yi = ring[i][1];
      var xj = ring[j][0], yj = ring[j][1];
      if ((yi > lat) !== (yj > lat) && lon < (xj - xi) * (lat - yi) / (yj - yi) + xi){
        inside = !inside;
      }
    }
    return inside;
  }

  function loadWeatherAlerts(){
    var alertsEl = document.getElementById("weather-alerts");
    if (!alertsEl) return;
    
    alertGeometries = []; // Reset
    
    // Demo mode to preview alert styles
    if (DEMO_ALERTS){
      var demoHtml = 
        '<div class="weather-alert warning">' +
          '<span class="weather-alert-icon"></span>' +
          '<span class="weather-alert-text">' +
            '<span class="weather-alert-title">Winter Storm Warning</span>' +
            '<span class="weather-alert-expires"> Expires in 8h</span>' +
          '</span>' +
        '</div>' +
        '<div class="weather-alert watch">' +
          '<span class="weather-alert-icon"></span>' +
          '<span class="weather-alert-text">' +
            '<span class="weather-alert-title">Flood Watch</span>' +
            '<span class="weather-alert-expires"> Expires in 24h</span>' +
          '</span>' +
        '</div>' +
        '<div class="weather-alert advisory">' +
          '<span class="weather-alert-icon"></span>' +
          '<span class="weather-alert-text">' +
            '<span class="weather-alert-title">Wind Advisory</span>' +
            '<span class="weather-alert-expires"> Expires in 6h</span>' +
          '</span>' +
        '</div>';
      alertsEl.innerHTML = demoHtml;
      return;
    }
    
    var url = "https://api.weather.gov/alerts/active?point=" + LOCATION.lat + "," + LOCATION.lon;
    
    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        var features = data && data.features;
        if (!features) features = [];
        
        // Sort: life-threatening alerts first, then by severity
        function alertPriority(f){
          var ev = (f.properties.event || '').toLowerCase();
          var sev = (f.properties.severity || '').toLowerCase();
          // TIER 1: Immediate life threat
          if (ev.indexOf('tornado') >= 0 && ev.indexOf('warning') >= 0) return 0;
          if (ev.indexOf('hurricane') >= 0 && ev.indexOf('warning') >= 0) return 1;
          if (ev.indexOf('flash flood') >= 0 && ev.indexOf('warning') >= 0) return 2;
          if (ev.indexOf('tsunami') >= 0 && ev.indexOf('warning') >= 0) return 3;
          if (ev.indexOf('earthquake') >= 0) return 4;
          if (ev.indexOf('fire') >= 0 && ev.indexOf('warning') >= 0) return 5;
          if (ev.indexOf('extreme wind') >= 0) return 6;
          if (ev.indexOf('storm surge') >= 0 && ev.indexOf('warning') >= 0) return 7;
          // TIER 2: Watches for life-threatening events
          if (ev.indexOf('tornado') >= 0 && ev.indexOf('watch') >= 0) return 10;
          if (ev.indexOf('hurricane') >= 0 && ev.indexOf('watch') >= 0) return 11;
          if (ev.indexOf('flash flood') >= 0 && ev.indexOf('watch') >= 0) return 12;
          if (ev.indexOf('tsunami') >= 0 && ev.indexOf('watch') >= 0) return 13;
          if (ev.indexOf('fire') >= 0 && ev.indexOf('watch') >= 0) return 14;
          if (ev.indexOf('storm surge') >= 0 && ev.indexOf('watch') >= 0) return 15;
          // TIER 3: Severe weather warnings
          if (ev.indexOf('severe thunderstorm') >= 0 && ev.indexOf('warning') >= 0) return 20;
          if (ev.indexOf('blizzard') >= 0 && ev.indexOf('warning') >= 0) return 21;
          if (ev.indexOf('ice storm') >= 0) return 22;
          if (ev.indexOf('flood') >= 0 && ev.indexOf('warning') >= 0) return 23;
          if (ev.indexOf('winter storm') >= 0 && ev.indexOf('warning') >= 0) return 24;
          if (ev.indexOf('high wind') >= 0 && ev.indexOf('warning') >= 0) return 25;
          // TIER 4: Watches
          if (ev.indexOf('severe thunderstorm') >= 0 && ev.indexOf('watch') >= 0) return 30;
          if (ev.indexOf('flood') >= 0 && ev.indexOf('watch') >= 0) return 31;
          if (ev.indexOf('winter storm') >= 0 && ev.indexOf('watch') >= 0) return 32;
          if (ev.indexOf('watch') >= 0) return 35;
          // TIER 5: By severity
          if (sev === 'extreme') return 40;
          if (sev === 'severe') return 45;
          // TIER 6: Advisories and statements
          if (ev.indexOf('warning') >= 0) return 50;
          if (sev === 'moderate') return 55;
          if (ev.indexOf('advisory') >= 0) return 60;
          if (ev.indexOf('statement') >= 0) return 70;
          return 80;
        }
        features.sort(function(a, b){ return alertPriority(a) - alertPriority(b); });
        
        // Also check SPC tornado outlook for user's location
        checkSPCTornadoRisk(function(spcAlert){
          if (!features.length && !spcAlert){
            alertsEl.innerHTML = '';
            return;
          }
          
          // Build combined list: SPC outlook first if exists and no active tornado warning
          var hasTornadoWarning = features.some(function(f){
            var ev = (f.properties.event || '').toLowerCase();
            return ev.indexOf('tornado') >= 0 && ev.indexOf('warning') >= 0;
          });
          
          var allAlerts = [];
          if (spcAlert && !hasTornadoWarning){
            allAlerts.push(spcAlert);
          }
          features.forEach(function(f){ allAlerts.push(f); });
          
          var html = "";
          var shown = allAlerts.length;
        
          for (var i = 0; i < shown; i++){
            var isSynthetic = allAlerts[i]._synthetic;
            var alert = isSynthetic ? allAlerts[i].properties : allAlerts[i].properties;
          var event = alert.event || "Alert";
          var headline = alert.headline || event;
          var severity = (alert.severity || "").toLowerCase();
          var urgency = alert.urgency || "";
          var expires = alert.expires ? new Date(alert.expires) : null;
          var effective = alert.effective ? new Date(alert.effective) : null;
          var onset = alert.onset ? new Date(alert.onset) : effective;
          
          // Sanity check: if onset is after expires, swap them or use effective
          if (onset && expires && onset > expires) {
            onset = effective || expires;
          }
        
          var description = alert.description || "";
          var instruction = alert.instruction || "";
          var areaDesc = alert.areaDesc || "";
          var senderName = alert.senderName || "";
          
          // Get first sentence of description for summary
          var summary = "";
          if (description){
            // Extract snow/rain amounts from description
            var precipAmount = "";
            
            // Look for snow amounts (e.g., "6 to 10 inches", "4-8 inches of snow")
            var snowMatch = description.match(/(\d+\.?\d*)\s*to\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?(?:snow|accumulation)/i) ||
                           description.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?(?:snow|accumulation)/i) ||
                           description.match(/(?:snow|accumulation)[^\d]*(\d+\.?\d*)\s*to\s*(\d+\.?\d*)\s*inch/i);
            
            if (snowMatch){
              precipAmount = " " + snowMatch[1] + "-" + snowMatch[2] + '"';
            } else {
              // Try single amount
              var singleSnow = description.match(/(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?snow/i) ||
                              description.match(/snow[^\d]*(\d+\.?\d*)\s*inch/i);
              if (singleSnow){
                precipAmount = " " + singleSnow[1] + '"';
              }
            }
            
            // Look for rain amounts if no snow found
            if (!precipAmount){
              var rainMatch = description.match(/(\d+\.?\d*)\s*to\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?rain/i) ||
                             description.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?rain/i);
              if (rainMatch){
                precipAmount = " " + rainMatch[1] + "-" + rainMatch[2] + '"';
              } else {
                var singleRain = description.match(/(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?rain/i);
                if (singleRain){
                  precipAmount = " " + singleRain[1] + '"';
                }
              }
            }
            
            // Look for wind speeds
            var windAmount = "";
            var windMatch = description.match(/wind[^\d]*(\d+)\s*to\s*(\d+)\s*mph/i) ||
                           description.match(/(\d+)\s*to\s*(\d+)\s*mph\s*wind/i);
            if (windMatch){
              windAmount = " " + windMatch[1] + "-" + windMatch[2] + " mph";
            }
            
            // Clean up NWS formatting (remove * WHAT..., * WHERE..., etc)
            var cleanDesc = description
              .replace(/\*\s*WHAT\.\.\./gi, '')
              .replace(/\*\s*WHERE\.\.\./gi, '')
              .replace(/\*\s*WHEN\.\.\./gi, '')
              .replace(/\*\s*IMPACTS\.\.\./gi, '')
              .replace(/\*\s*ADDITIONAL DETAILS\.\.\./gi, '')
              .replace(/^\s*[\*\-]\s*/gm, '')
              .trim();
            
            var firstSentence = cleanDesc.split(/\.(?:\s|$)/)[0];
            if (firstSentence && firstSentence.length > 10){
              summary = firstSentence.length > 120 ? firstSentence.substring(0, 117) + "..." : firstSentence + ".";
            }
            
            // Add precip/wind amounts to summary
            var amounts = [precipAmount, windAmount].filter(function(a){ return a; }).join("  ");
            if (amounts){
              summary = amounts + (summary ? "    " + summary : "");
            }
          }
          
          // Format areas (truncate if too long)
          var areasStr = "";
          if (areaDesc){
            areasStr = areaDesc.length > 80 ? areaDesc.substring(0, 77) + "..." : areaDesc;
          }
          
          // Determine alert class
          var alertClass = "statement";
          var icon = "";
          var evLower = event.toLowerCase();
          var isTornado = evLower.indexOf("tornado") >= 0;
          var isSevereTS = evLower.indexOf("severe thunderstorm") >= 0;
          var isHurricane = evLower.indexOf("hurricane") >= 0 || evLower.indexOf("typhoon") >= 0 || evLower.indexOf("tropical") >= 0;
          var isFlashFlood = evLower.indexOf("flash flood") >= 0;
          var isFlood = evLower.indexOf("flood") >= 0;
          var isFire = evLower.indexOf("fire") >= 0 || evLower.indexOf("red flag") >= 0;
          var isEarthquake = evLower.indexOf("earthquake") >= 0;
          var isTsunami = evLower.indexOf("tsunami") >= 0;
          
          if (isTornado){
            alertClass = "tornado";
            icon = "";
          } else if (isHurricane){
            alertClass = "warning";
            icon = "";
          } else if (isTsunami){
            alertClass = "warning";
            icon = "";
          } else if (isEarthquake){
            alertClass = "warning";
            icon = "";
          } else if (isFire){
            alertClass = "warning";
            icon = "";
          } else if (isFlashFlood){
            alertClass = "warning";
            icon = "";
          } else if (evLower.indexOf("warning") >= 0 || severity === "extreme" || severity === "severe"){
            alertClass = "warning";
            icon = "";
          } else if (evLower.indexOf("watch") >= 0 || severity === "moderate"){
            alertClass = "watch";
            icon = "";
          } else if (evLower.indexOf("advisory") >= 0){
            alertClass = "advisory";
            icon = "";
          }
          
          // Helper for 12-hour time with AM/PM
          function fmt12WithAMPM(d){
            if (!d || !isFinite(d.getTime())) return "--:--";
            var h = d.getHours();
            var m = d.getMinutes();
            var ampm = h >= 12 ? "PM" : "AM";
            var hh = h % 12; if (hh === 0) hh = 12;
            return String(hh) + ":" + (m < 10 ? "0"+m : m) + " " + ampm;
          }
          
          // Format time window
          var timeWindow = "";
          var now = new Date();
          
          if (onset && expires){
            var onsetTime = fmt12WithAMPM(onset);
            var expiresTime = fmt12WithAMPM(expires);
            var onsetDay = fmtMonthDay(onset);
            var expiresDay = fmtMonthDay(expires);
            var todayStr = fmtMonthDay(now);
            var tomorrowDate = new Date(now);
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            var tomorrowStr = fmtMonthDay(tomorrowDate);
            
            // Check if already in effect
            var hasStarted = onset <= now;
            
            if (hasStarted){
              // Already in effect - show when it ends
              if (expiresDay === todayStr){
                timeWindow = "In effect until " + expiresTime + " today";
              } else if (expiresDay === tomorrowStr){
                timeWindow = "In effect until " + expiresTime + " tomorrow";
              } else {
                timeWindow = "In effect until " + expiresDay + " at " + expiresTime;
              }
            } else {
              // Not started yet - show full window
              if (onsetDay === todayStr && expiresDay === todayStr){
                timeWindow = "Today " + onsetTime + " to " + expiresTime;
              } else if (onsetDay === todayStr && expiresDay === tomorrowStr){
                timeWindow = "Today " + onsetTime + " to tomorrow " + expiresTime;
              } else if (onsetDay === tomorrowStr && expiresDay === tomorrowStr){
                timeWindow = "Tomorrow " + onsetTime + " to " + expiresTime;
              } else if (onsetDay === tomorrowStr){
                timeWindow = "Tomorrow " + onsetTime + " to " + expiresDay + " " + expiresTime;
              } else {
                timeWindow = onsetDay + " at " + onsetTime + " to " + expiresDay + " at " + expiresTime;
              }
            }
          } else if (expires){
            var expiresTime = fmt12WithAMPM(expires);
            var expiresDay = fmtMonthDay(expires);
            var todayStr = fmtMonthDay(now);
            var tomorrowStr = fmtMonthDay(new Date(now.getTime() + 86400000));
            
            if (expiresDay === todayStr){
              timeWindow = "Until " + expiresTime + " today";
            } else if (expiresDay === tomorrowStr){
              timeWindow = "Until " + expiresTime + " tomorrow";
            } else {
              timeWindow = "Until " + expiresDay + " at " + expiresTime;
            }
          }
          
          // Severity badge
          var severityBadge = "";
          if (severity === "extreme"){
            severityBadge = '<span class="weather-alert-severity extreme">Extreme</span>';
          } else if (severity === "severe"){
            severityBadge = '<span class="weather-alert-severity severe">Severe</span>';
          } else if (severity === "moderate"){
            severityBadge = '<span class="weather-alert-severity moderate">Moderate</span>';
          }
          
          html += '<div class="weather-alert ' + alertClass + '" data-alert-index="' + i + '" style="cursor:pointer;" title="Click for full details">' +
            '<span class="weather-alert-icon">' + icon + '</span>' +
            '<span class="weather-alert-text">' +
              '<span class="weather-alert-title">' + event + '</span>' +
              (timeWindow ? '<span class="weather-alert-time"> ' + timeWindow + '</span>' : '') +
              (summary ? '<span class="weather-alert-summary">' + summary + '</span>' : '') +
            '</span>' +
            severityBadge +
          '</div>';
          
          // Store alert geometry for radar overlay
          if (features[i].geometry){
            alertGeometries.push({
              geometry: features[i].geometry,
              event: event,
              severity: severity,
              alertClass: alertClass
            });
          }
        }
        
        alertsEl.innerHTML = html;
        
        // Scroll indicator: hide red glow when scrolled to bottom
        alertsEl.removeEventListener('scroll', alertsEl._scrollHandler);
        alertsEl._scrollHandler = function(){
          var atBottom = alertsEl.scrollHeight - alertsEl.scrollTop - alertsEl.clientHeight < 8;
          alertsEl.classList.toggle('scrolled-bottom', atBottom);
        };
        alertsEl.addEventListener('scroll', alertsEl._scrollHandler);
        // Initial check
        setTimeout(function(){ alertsEl._scrollHandler(); }, 100);
        
        // Toggle classes based on alert count
        alertsEl.classList.remove("single-alert", "many-alerts");
        if (shown === 1){
          alertsEl.classList.add("single-alert");
        } else if (shown >= 3){
          alertsEl.classList.add("many-alerts");
        }
        
        // Store features globally for modal access
        window.alertFeatures = allAlerts;
        
        // Add click handlers to open alert detail modal
        var alertDivs = alertsEl.querySelectorAll('.weather-alert[data-alert-index]');
        alertDivs.forEach(function(div){
          div.addEventListener('click', function(){
            var idx = parseInt(this.getAttribute('data-alert-index'));
            if (!isNaN(idx) && window.alertFeatures && window.alertFeatures[idx]) {
              openAlertModal(window.alertFeatures[idx]);
            }
          });
        });
        
        // Draw alert zones on radar if map exists
        setTimeout(drawAlertPolygonsOnRadar, 1000);
        }); // end checkSPCTornadoRisk callback
      })
      .catch(function(err){
        console.log("Weather alerts error:", err);
        alertsEl.innerHTML = '';
      });
  }

  // Draw alert polygons on radar map
  function drawAlertPolygonsOnRadar(){
    if (typeof L === 'undefined' || !window.radarMap) return;
    
    // Remove existing alert layers
    if (window.radarAlertLayers){
      window.radarAlertLayers.forEach(function(layer){
        window.radarMap.removeLayer(layer);
      });
    }
    window.radarAlertLayers = [];
    
    if (alertGeometries.length === 0) return;
    
    alertGeometries.forEach(function(alert){
      var color = '#3b82f6'; // default blue
      var fillOpacity = 0.15;
      
      if (alert.alertClass === 'warning'){
        color = '#ef4444'; // red
        fillOpacity = 0.2;
      } else if (alert.alertClass === 'watch'){
        color = '#f97316'; // orange
        fillOpacity = 0.18;
      } else if (alert.alertClass === 'advisory'){
        color = '#eab308'; // yellow
        fillOpacity = 0.15;
      }
      
      try {
        var geoJsonLayer = L.geoJSON(alert.geometry, {
          style: {
            color: color,
            weight: 2,
            opacity: 0.8,
            fillColor: color,
            fillOpacity: fillOpacity
          }
        }).addTo(window.radarMap);
        
        geoJsonLayer.bindTooltip(alert.event, { sticky: true });
        window.radarAlertLayers.push(geoJsonLayer);
      } catch(e){
        console.log("Error drawing alert polygon:", e);
      }
    });
  }
  
  // Update TODAY Timeline NOW marker every minute
  setInterval(function(){
    var tlNowMarker = document.getElementById("today-tl-now-marker");
    var tlNowTime = document.getElementById("today-tl-now-time");
    
    if (tlNowMarker && tlNowMarker.style.display !== "none"){
      var now = new Date();
      var dayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
      var timelineStart = dayLocal.getTime();
      var timelineEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999).getTime();
      var timelineSpan = timelineEnd - timelineStart;
      
      var nowPct = ((now.getTime() - timelineStart) / timelineSpan) * 100;
      
      if (nowPct >= 0 && nowPct <= 100){
        tlNowMarker.style.left = nowPct + "%";
        if (tlNowTime) tlNowTime.textContent = fmt12NoSuffixFromDate(now);
      }
    }
  }, 60 * 1000);

  /* =========================================================
     UNIFIED WIDGET POPUP MODAL SYSTEM
     ========================================================= */
  var widgetModal = document.getElementById("widget-modal");
  var widgetModalBody = document.getElementById("widget-modal-body");
  var widgetModalClose = document.getElementById("widget-modal-close");
  var modalAnimationTimers = [];

  var MODAL_CONTENT_TYPES = { IMAGE: 'image', CARD: 'card', MAP: 'map' };

  var WIDGET_CONFIG = {
    'radar-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'LOCAL RADAR',
      subtitle: function(){ return LOCATION.radarName || 'NWS'; },
      getFrames: function(){ 
        var STATION = LOCATION.radar || "KENX";
        return ["https://radar.weather.gov/ridge/standard/" + STATION + "_loop.gif?cb=" + Date.now()];
      }
    },
    'goes-canvas': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GOES SATELLITE',
      subtitle: 'GEOCOLOR',
      getFrames: function(){ return goesFrames; },
      fps: 3.3
    },
    'aurora-canvas': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'AURORA FORECAST',
      subtitle: 'SWPC OVATION',
      getFrames: function(){ return auroraAnim.frames; },
      fps: 5
    },
    'enlil-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'SOLAR WIND',
      subtitle: 'WSA-ENLIL',
      getFrames: function(){ return animations.enlil.frames; },
      fps: 8
    },
    'lasco-c3-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'LASCO C3 CORONAGRAPH',
      subtitle: 'NASA/ESA SOHO',
      getFrames: function(){ return animations.lascoC3.frames; },
      fps: 6
    },
    'lasco-c2-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'LASCO C2 CORONAGRAPH',
      subtitle: 'NASA/ESA SOHO',
      getFrames: function(){ return animations.lascoC2.frames; },
      fps: 6
    },
    'suvi-map-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'SUVI THEMATIC MAP',
      subtitle: 'NOAA GOES',
      getFrames: function(){ return suviMapAnim.frames; },
      fps: 6.7
    },
    'pfss-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'SOLAR MAGNETIC FIELD',
      subtitle: 'NASA SDO PFSS',
      getFrames: function(){ var el = document.getElementById('pfss-img'); return el ? [el.src] : []; }
    },
    'geo-vel-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GEOSPACE VELOCITY',
      subtitle: 'SWPC',
      getFrames: function(){ var el = document.getElementById('geo-vel-img'); return el ? [el.src] : []; }
    },
    'geo-den-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GEOSPACE DENSITY',
      subtitle: 'SWPC',
      getFrames: function(){ var el = document.getElementById('geo-den-img'); return el ? [el.src] : []; }
    },
    'geo-pre-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GEOSPACE PRESSURE',
      subtitle: 'SWPC',
      getFrames: function(){ var el = document.getElementById('geo-pre-img'); return el ? [el.src] : []; }
    },
    'fcast-radar-img': {
      type: MODAL_CONTENT_TYPES.IMAGE,
      get title(){ 
        var p = fcastState.product;
        var titleMap = {'500mb':'GFS 500MB VORTICITY & HEIGHTS','10mb':'10MB STRATOSPHERIC TEMPERATURE','precip_type':'GFS PRECIP TYPE','snow_accum':'GFS SNOW ACCUMULATION','temperature':'GFS 1000-500MB THICKNESS & PRECIP','precip_total':'GFS TOTAL PRECIPITATION','wind':'GFS WIND & MSLP','cape':'GFS CAPE & CIN','jet_stream':'GFS JET STREAM 250MB','humidity':'GFS 700MB HUMIDITY'};
        return titleMap[p] || 'GFS SIM RADAR';
      },
      get subtitle(){ 
        var p = fcastState.product;
        if (p === '500mb') return 'NCEP MAG  North America';
        if (p === '10mb') return 'CPC  Northern Hemisphere';
        return 'NCEP MAG  CONUS';
      },
      getFrames: function(){
        var fhrs = getActiveFhrs();
        var frames = [];
        for (var i = 0; i < fhrs.length; i++){
          frames.push(buildFcastUrl(i));
        }
        return frames;
      },
      fps: 3
    },
    'gfs-500mb-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      get title(){ return gfsState.activeTab === '10mb' ? '10mb STRATOSPHERIC TEMPERATURE' : 'GFS 500mb VORTICITY & HEIGHTS'; },
      get subtitle(){ return gfsState.activeTab === '10mb' ? 'CPC  Northern Hemisphere' : 'NCEP MAG  North America'; },
      getFrames: function(){ 
        var frames = [];
        if(gfsState.activeTab === '10mb'){
          for(var i = 0; i < gfsState.fhrs10.length; i++){
            frames.push(buildGfsUrl('10mb', i));
          }
        } else {
          for(var i = 0; i < gfsState.fhrs500.length; i += 2){
            frames.push(buildGfsUrl('500mb', i));
          }
        }
        return frames;
      },
      get fps(){ return gfsState.activeTab === '10mb' ? 2 : 4; }
    }
  };

  var CARD_CONFIG = {
    'nightsky': { title: 'NIGHT SKY', subtitle: 'Planet Visibility' }
  };

  var MAP_CONFIG = {
    'lightning-map': { title: 'LIGHTNING', subtitle: 'Blitzortung + Macrostrat', sourceUrl: 'https://www.blitzortung.org/en/live_lightning_maps.php', sourceMap: function(){ return lightningMap; }, markers: function(){ return lightningMarkers; } },
    'fire-map': { title: 'WILDFIRES', subtitle: 'NIFC + ESRI', sourceUrl: 'https://www.nifc.gov/fire-information', sourceMap: function(){ return fireMap; }, markers: function(){ return fireMarkers; } },
    'tornado-map': { title: 'TORNADOES & SEVERE', subtitle: 'NOAA SPC Reports', sourceUrl: 'https://www.spc.noaa.gov/climo/reports/today.html', sourceMap: function(){ return tornadoMap; }, markers: function(){ return tornadoMarkers; } },
    'quake-map': { title: 'EARTHQUAKES', subtitle: 'USGS + Macrostrat', sourceUrl: 'https://earthquake.usgs.gov/earthquakes/map/', sourceMap: function(){ return quakeMap; }, markers: function(){ return quakeMarkers; } },
    'national-radar-map': { title: 'NATIONAL RADAR', subtitle: 'IEM NEXRAD', sourceUrl: 'https://mesonet.agron.iastate.edu/GIS/ridge.phtml', sourceMap: function(){ return nationalRadarMap; }, markers: function(){ return []; } }
  };

  function clearModalAnimations(){
    modalAnimationTimers.forEach(function(t){ clearInterval(t); clearTimeout(t); });
    modalAnimationTimers = [];
    if (window.modalMap) { window.modalMap.remove(); window.modalMap = null; }
  }

  function updateModalHeader(title, subtitle, sourceUrl){
    var titleEl = document.getElementById("modal-title");
    var subtitleEl = document.getElementById("modal-subtitle");
    if (titleEl) titleEl.textContent = title || '--';
    if (subtitleEl) subtitleEl.textContent = typeof subtitle === 'function' ? subtitle() : (subtitle || '');
    // Make header clickable to source
    var headerEl = document.querySelector(".widget-modal-header");
    if (headerEl){
      headerEl.style.cursor = sourceUrl ? 'pointer' : 'default';
      headerEl.onclick = sourceUrl ? function(e){
        if(e.target.classList.contains('widget-modal-close'))return;
        window.open(sourceUrl,'_blank');
      } : null;
      if(subtitleEl && sourceUrl) subtitleEl.style.textDecoration = 'underline';
      else if(subtitleEl) subtitleEl.style.textDecoration = 'none';
    }
  }

  function positionModalAtViewport(el){
    el.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.88);z-index:99999;padding:24px;box-sizing:border-box;overflow:auto;';
    if (el.parentNode !== document.body) document.body.appendChild(el);
    el.classList.add("active");
    el.scrollIntoView({behavior:'smooth', block:'center'});
  }

  function openImageModal(config, imgId){
    if (!widgetModal || !widgetModalBody) return;
    clearModalAnimations();
    
    updateModalHeader(config.title, config.subtitle, config.sourceUrl);
    widgetModalBody.className = 'widget-modal-body content-image is-loading';
    widgetModalBody.innerHTML = '';
    
    positionModalAtViewport(widgetModal);
    
    var frames = config.getFrames ? config.getFrames() : [];
    if (!frames || frames.length === 0) {
      var srcEl = document.getElementById(imgId);
      if (srcEl && srcEl.src) frames = [srcEl.src];
    }
    
    if (frames && frames.length > 0) {
      var img = document.createElement('img');
      img.onload = function(){ widgetModalBody.classList.remove('is-loading'); };
      img.onerror = function(){ 
        widgetModalBody.classList.remove('is-loading'); 
        widgetModalBody.innerHTML = '<div style="color:#888;font-size:14px;">Image unavailable</div>'; 
      };
      img.src = frames[0] + (frames[0].indexOf('?') >= 0 ? '&' : '?') + 'modal=1&cb=' + Date.now();
      img.alt = config.title || 'Enlarged view';
      if (imgId === 'radar-img' || imgId === 'fcast-radar-img') {
        img.style.filter = 'invert(1) hue-rotate(180deg) contrast(1.4) saturate(1.8)';
        widgetModalBody.style.background = '#000';
      }
      widgetModalBody.appendChild(img);
      
      if (frames.length > 1 && config.fps) {
        var idx = 0;
        var interval = 1000 / config.fps;
        var timer = setInterval(function(){
          idx = (idx + 1) % frames.length;
          img.src = frames[idx];
        }, interval);
        modalAnimationTimers.push(timer);
      }
    } else {
      widgetModalBody.classList.remove('is-loading');
      widgetModalBody.innerHTML = '<div style="color:#888;font-size:14px;">Content unavailable</div>';
    }
  }

  function openCardModalUnified(cardEl, config){
    if (!widgetModal || !widgetModalBody) return;
    clearModalAnimations();
    
    updateModalHeader(config.title, config.subtitle, config.sourceUrl);
    widgetModalBody.className = 'widget-modal-body content-card';
    widgetModalBody.innerHTML = '';
    
    var clone = cardEl.cloneNode(true);
    clone.classList.remove('clickable-card');
    clone.style.cursor = 'default';
    clone.style.margin = '0';
    clone.style.padding = '0';
    
    var btns = clone.querySelectorAll('button');
    btns.forEach(function(btn){ if (btn.textContent === '' || btn.textContent === '') btn.style.display = 'none'; });
    
    widgetModalBody.appendChild(clone);
    positionModalAtViewport(widgetModal);
  }

  function openMapModal(config, containerId){
    if (!widgetModal || !widgetModalBody) return;
    clearModalAnimations();
    
    updateModalHeader(config.title, config.subtitle, config.sourceUrl);
    widgetModalBody.className = 'widget-modal-body content-map';
    widgetModalBody.innerHTML = '<div class="modal-map-container" id="modal-map-container" style="position:relative;"></div>';
    
    positionModalAtViewport(widgetModal);
    
    setTimeout(function(){
      var mapContainer = document.getElementById('modal-map-container');
      if (!mapContainer || typeof L === 'undefined') return;
      
      var sourceMap = config.sourceMap ? config.sourceMap() : null;
      var markers = config.markers ? config.markers() : [];
      if (!sourceMap) return;
      
      var center = sourceMap.getCenter();
      var zoom = sourceMap.getZoom();
      
      window.modalMap = L.map(mapContainer, { center: center, zoom: zoom, zoomControl: true, attributionControl: false });
      
      // Add base layers based on map type
      if (containerId === 'fire-map') {
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' }).addTo(window.modalMap);
        // Add smoke heatmap if available
        if (typeof L.heatLayer === 'function' && fireMarkers.length > 0) {
          var smokePoints = [];
          fireMarkers.forEach(function(marker) {
            var latlng = marker.getLatLng();
            var radius = marker.options.radius || 3;
            var intensity = (radius <= 2.5) ? 0.05 : Math.min(radius / 10, 0.7);
            smokePoints.push([latlng.lat, latlng.lng, intensity]);
          });
          L.heatLayer(smokePoints, {
            radius: 6, blur: 3, maxZoom: 4, max: 1.0, minOpacity: 0.25,
            gradient: { 0.0: 'rgba(255,255,200,0)', 0.15: 'rgba(255,240,150,0.55)', 0.3: 'rgba(255,200,80,0.7)', 0.5: 'rgba(255,140,40,0.8)', 0.7: 'rgba(240,80,20,0.88)', 0.85: 'rgba(200,30,30,0.92)', 1.0: 'rgba(140,20,60,0.97)' }
          }).addTo(window.modalMap);
        }
      } else if (containerId === 'national-radar-map') {
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { opacity: 0.7 }).addTo(window.modalMap);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.5 }).addTo(window.modalMap);
        L.tileLayer('https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png?_=' + Date.now(), { opacity: 0.75 }).addTo(window.modalMap);
      } else if (containerId === 'lightning-map') {
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { attribution: TILE_ATTRIB }).addTo(window.modalMap);
      } else {
        L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(window.modalMap);
        L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png', { opacity: containerId === 'quake-map' ? 0.70 : 0.35 }).addTo(window.modalMap);
      }
      
      // Add location marker (except for national radar which shows whole country)
      if (containerId !== 'national-radar-map') {
        L.circleMarker([LOCATION.lat, LOCATION.lon], { radius: 8, fillColor: '#2B22F4', fillOpacity: 0.9, color: '#fff', weight: 2 }).addTo(window.modalMap).bindTooltip(" " + LOCATION.name, { permanent: false });
      }
      
      // Clone markers with popups
      markers.forEach(function(marker){
        var latlng = marker.getLatLng();
        var options = marker.options;
        var newMarker = L.circleMarker(latlng, { radius: options.radius || 5, fillColor: options.fillColor || '#f00', fillOpacity: options.fillOpacity || 0.8, color: options.color || '#fff', weight: options.weight || 1 }).addTo(window.modalMap);
        var tooltip = marker.getTooltip();
        var popup = marker.getPopup();
        if (tooltip) newMarker.bindTooltip(tooltip.getContent(), { permanent: false });
        if (popup) newMarker.bindPopup(popup.getContent(), { closeButton: false });
      });
      
      // Move UI overlays (pills, toggles, legends) into modal map  preserves event handlers
      var sourceWidget = document.getElementById(containerId);
      window._modalOverlaySources = [];
      if (sourceWidget) {
        var parent = sourceWidget.closest('.widget-body');
        if (parent) {
          var overlays = parent.querySelectorAll('[id$="-pill"], [id$="-status-pill"], [id$="-toggle"], .fire-status-wrap, .quake-status-wrap, .smoke-status-pill, .fire-legend, .radar-legend, [id$="-aqi-pill"], [id$="-labels-toggle"]');
          overlays.forEach(function(overlay) {
            window._modalOverlaySources.push({ el: overlay, parent: parent, next: overlay.nextSibling });
            overlay.style.zIndex = '1000';
            overlay.style.pointerEvents = 'auto';
            mapContainer.appendChild(overlay);
          });
        }
      }
      
      setTimeout(function(){ if (window.modalMap) window.modalMap.invalidateSize(); }, 100);
      setTimeout(function(){ if (window.modalMap) window.modalMap.invalidateSize(); }, 300);
    }, 50);
  }

  function restoreModalOverlays(){
    if (window._modalOverlaySources) {
      window._modalOverlaySources.forEach(function(item) {
        if (item.next) {
          item.parent.insertBefore(item.el, item.next);
        } else {
          item.parent.appendChild(item.el);
        }
      });
      window._modalOverlaySources = [];
    }
  }
  function closeWidgetModal(){
    if (!widgetModal) return;
    restoreModalOverlays();
    clearModalAnimations();
    widgetModal.classList.remove("active");
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
    setTimeout(function(){ if (widgetModalBody) { widgetModalBody.innerHTML = ""; widgetModalBody.className = "widget-modal-body"; } }, 300);
  }

  if (widgetModalClose) widgetModalClose.addEventListener("click", closeWidgetModal);
  if (widgetModal) widgetModal.addEventListener("click", function(e){ if (e.target === widgetModal) closeWidgetModal(); });
  document.addEventListener("keydown", function(e){ if (e.key === "Escape" && widgetModal && widgetModal.classList.contains("active")) closeWidgetModal(); });

  function initWidgetPopups(){
    var widgets = document.querySelectorAll(".widget");
    
    widgets.forEach(function(widget){
      // Skip solo/full-width row widgets
      var parentRow = widget.closest('.widgets-row, .widgets-row-two');
      if (parentRow) {
        var widgetChildren = parentRow.querySelectorAll(':scope > .widget');
        if (widgetChildren.length <= 1) return; // Skip popup for solo widgets
      }
      var img = widget.querySelector(".widget-body img");
      var canvas = widget.querySelector(".widget-body canvas");
      var isMapWidget = widget.classList.contains("map-widget");
      var imgId = img ? img.id : (canvas ? canvas.id : null);
      var config = imgId ? WIDGET_CONFIG[imgId] : null;
      
      if (isMapWidget) {
        widget.classList.add("clickable-widget");
        var header = widget.querySelector(".widget-head");
        if (header) {
          header.style.cursor = "pointer";
          var mapContainer = widget.querySelector("[id$='-map']");
          if (!mapContainer) mapContainer = widget.querySelector("iframe[id$='-iframe']");
          var mapId = mapContainer ? mapContainer.id.replace('-iframe', '-map') : null;
          var mapConfig = mapId ? MAP_CONFIG[mapId] : null;
          if (mapConfig) {
            header.addEventListener("click", function(e){
              if (e.target.closest("a")) return;
              openMapModal(mapConfig, mapId);
            });
          }
        }
        return;
      }
      
      if (config) {
        widget.classList.add("clickable-widget");
        widget.addEventListener("click", function(e){
          if (e.target.closest("button") || e.target.closest("a") || e.target.closest("input")) return;
          openImageModal(config, imgId);
        });
      } else if (img || canvas) {
        widget.classList.add("clickable-widget");
        widget.addEventListener("click", function(e){
          if (e.target.closest("button") || e.target.closest("a") || e.target.closest("input")) return;
          var genericConfig = {
            type: MODAL_CONTENT_TYPES.IMAGE,
            title: widget.querySelector(".widget-title") ? widget.querySelector(".widget-title").textContent.replace(' LIVE', '').trim() : 'Image',
            subtitle: '',
            getFrames: function(){
              var el = img || canvas;
              if (el && el.src) return [el.src];
              if (canvas && auroraAnim.frames && auroraAnim.frames.length > 0) return auroraAnim.frames;
              return [];
            }
          };
          openImageModal(genericConfig, imgId);
        });
      }
    });
    
    Object.keys(CARD_CONFIG).forEach(function(cardId){
      var card = document.getElementById(cardId) || document.querySelector("." + cardId);
      if (card) {
        card.classList.add("clickable-card");
        card.addEventListener("click", function(e){
          if (e.target.closest("button") || e.target.closest("a")) return;
          openCardModalUnified(card, CARD_CONFIG[cardId]);
        });
      }
    });
  }

  initWidgetPopups();


  // Voyager 1 live distance updater (every 5 seconds)
  setInterval(function(){
    var voyagerBullet = document.querySelector('.bullet:last-child .bsub');
    if (voyagerBullet && voyagerBullet.textContent.indexOf('mi  Light delay') > -1){
      var now = new Date();
      var refDate = new Date(Date.UTC(2025, 0, 1, 0, 0, 0));
      var refDistanceMiles = 15215899826.1;
      var speedMph = 38210.55;
      var msSinceRef = now.getTime() - refDate.getTime();
      var hoursSinceRef = msSinceRef / (1000 * 60 * 60);
      var currentMiles = refDistanceMiles + (hoursSinceRef * speedMph);
      var milesFormatted = Math.floor(currentMiles).toLocaleString();
      var currentAU = currentMiles / 92955807.3;
      var lightSeconds = currentAU * 499.004784;
      var lightHours = Math.floor(lightSeconds / 3600);
      var lightMins = Math.floor((lightSeconds % 3600) / 60);
      var lightTimeStr = lightHours + "h " + lightMins + "m";
      var launchDate = new Date(Date.UTC(1977, 8, 5, 12, 56, 0));
      var missionMs = now.getTime() - launchDate.getTime();
      var missionYears = Math.floor(missionMs / (1000 * 60 * 60 * 24 * 365.25));
      var missionMonths = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 365.25)) / (1000 * 60 * 60 * 24 * 30.44));
      var missionDays = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 30.44)) / (1000 * 60 * 60 * 24));
      var missionStr = missionYears + "y " + missionMonths + "m " + missionDays + "d";
      voyagerBullet.textContent = "Interstellar space  Local Interstellar Cloud  " + milesFormatted + " mi  Light delay " + lightTimeStr + "  " + speedMph.toLocaleString() + " mph";
      
      // Update mission time in btime
      var voyagerTime = document.querySelector('.bullet:last-child .btime');
      if (voyagerTime) voyagerTime.textContent = missionStr + " in flight";
    }
  }, 5000);

  // refresh cadences
  setInterval(function(){ loadWeatherForLocation(LOCATION); }, 10 * 60 * 1000);
  setInterval(updateSolarMini, 5 * 60 * 1000);
  setInterval(loadAirQuality, 15 * 60 * 1000);
  setInterval(loadWeatherAlerts, 5 * 60 * 1000);
  setInterval(function(){ if (tornadoMap) loadTornadoReports(); }, 10 * 60 * 1000);
  loadWeatherForLocation(LOCATION);
  loadWeatherAlerts();
  loadAirQuality();

  // ============ INTRO SCREEN ============
  (function initIntroScreen(){
    var ls = document.getElementById('site-loading-screen');
    if (!ls) return;

    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
    window.scrollTo(0, 0);

    var bluishEl = document.getElementById('intro-bluish');
    var voidContainer = document.getElementById('intro-void-container');
    var voidCount = 0;
    var dataReady = false;
    var introStartTime = Date.now();

    // Video crossfade
    // VOID cascades below BLUISH, centered. 7 VOIDs, dismiss when last one appears.
    var maxVoids = 7;
    var voidSpeed = 430;
    var voidFilled = false;

    function addVoid(){
      if (!voidContainer || voidCount >= maxVoids) { voidFilled = true; return false; }
      voidCount++;
      var d = document.createElement('div');
      var op = Math.max(0.35, 0.8 - (voidCount * 0.008));
      d.style.cssText = 'font-family:QelliaRegular,Bodoni Moda,Georgia,serif;font-size:clamp(1.8rem, 6vw, 3.5rem);font-weight:700;letter-spacing:clamp(0.2em, 1.5vw, 0.5em);padding-right:clamp(0.2em, 1.5vw, 0.5em);line-height:2.9;color:rgba(74,158,255,' + op + ');white-space:nowrap';
      d.textContent = 'VOID';
      voidContainer.appendChild(d);
      if (voidCount >= maxVoids) { voidFilled = true; return false; }
      return true;
    }

    var voidTimer = setInterval(function(){
      if (!addVoid()) clearInterval(voidTimer);
    }, voidSpeed);

    // Watch for data ready
    var checkInterval = setInterval(function(){
      var ct = document.querySelector('.cond-text');
      if (ct && ct.textContent && ct.textContent !== '--' && ct.textContent !== ''){
        dataReady = true;
      }
    }, 200);

    function dismissLoading(){
      var dash = document.getElementById('dashboard-content');
      if (dash) dash.style.opacity = '1';
      ls.style.transition = 'opacity 0.3s ease-out';
      ls.style.opacity = '0';
      ls.style.pointerEvents = 'none';
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      setTimeout(function(){
        if (ls && ls.parentNode) ls.parentNode.removeChild(ls);
      }, 400);
    }

    // When VOIDs have filled the viewport, dismiss immediately
    (function waitToDismiss(){
      var recheck = setInterval(function(){
        if (voidFilled){
          clearInterval(recheck);
          clearInterval(checkInterval);
          clearInterval(voidTimer);
          dismissLoading();
        }
      }, 100);
    })();
  })();
  
  // Alert modal close handlers (after DOM ready)
  var alertModalClose = document.getElementById('alert-modal-close');
  var alertModal = document.getElementById('alert-modal');
  if (alertModalClose) alertModalClose.addEventListener('click', closeAlertModal);
  if (alertModal) alertModal.addEventListener('click', function(e){ if (e.target === alertModal) closeAlertModal(); });
  document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && document.getElementById('alert-modal') && document.getElementById('alert-modal').classList.contains('active')) closeAlertModal(); });
  startRadarNwsLoop();
  startAuroraBlackBackground();
  startGoesAutoplay();
  updateSolarMini();
  initSpaceWeatherAnimations();
  initSuviMap();
  initPfss();
  initNowMicroTabs();
  initLocationSwitcher();
  initGfsWidget();
  initFcastWidgets();

  // Auto-detect user location on page load
  (function autoLocate(){
    if (!navigator.geolocation) return; // Fall back to default (NYC)
    navigator.geolocation.getCurrentPosition(function(pos){
      var lat = Math.round(pos.coords.latitude * 10000) / 10000;
      var lon = Math.round(pos.coords.longitude * 10000) / 10000;

      // Find nearest radar
      var nearestRadar = { id: "KOKX", name: "NWS Upton", region: "NORTHEAST" };
      if (typeof RADAR_SITES !== "undefined"){
        var bestDist = Infinity;
        for (var r = 0; r < RADAR_SITES.length; r++){
          var rlat = RADAR_SITES[r].lat, rlon = RADAR_SITES[r].lon;
          var d = Math.sqrt(Math.pow(lat - rlat, 2) + Math.pow(lon - rlon, 2));
          if (d < bestDist){ bestDist = d; nearestRadar = RADAR_SITES[r]; }
        }
      }

      var goesSat = lon < -105 ? "G18" : "G19";
      var goesSector;
      if (lon < -105) goesSector = "wus";
      else if (lat > 38) goesSector = "ne";
      else goesSector = "se";

      var guessTz = "America/New_York";
      if (lon < -115) guessTz = "America/Los_Angeles";
      else if (lon < -105) guessTz = "America/Denver";
      else if (lon < -90) guessTz = "America/Chicago";

      fetch("https://api.open-meteo.com/v1/forecast?latitude=" + lat + "&longitude=" + lon + "&current=temperature_2m&timezone=auto")
        .then(function(r){ return r.json(); })
        .then(function(data){
          if (data && data.timezone) guessTz = data.timezone;

          var gpsLoc = {
            id: "gps",
            name: "My Location",
            lat: lat,
            lon: lon,
            tz: guessTz,
            radar: nearestRadar.id,
            radarName: nearestRadar.name,
            radarRegion: nearestRadar.region,
            goes: { sat: goesSat, sector: goesSector }
          };

          var gpsIdx = -1;
          for (var g = 0; g < LOCATIONS.length; g++){
            if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
          }
          if (gpsIdx >= 0) LOCATIONS[gpsIdx] = gpsLoc;
          else LOCATIONS.push(gpsLoc);

          switchLocation("gps");

          // Mark GPS button as active
          var gpsBtn = document.getElementById("loc-gps");
          if (gpsBtn) gpsBtn.classList.add("active");
        })
        .catch(function(){
          // Timezone detection failed, use guess
          var gpsLoc = {
            id: "gps",
            name: "My Location",
            lat: lat,
            lon: lon,
            tz: guessTz,
            radar: nearestRadar.id,
            radarName: nearestRadar.name,
            radarRegion: nearestRadar.region,
            goes: { sat: goesSat, sector: goesSector }
          };

          var gpsIdx = -1;
          for (var g = 0; g < LOCATIONS.length; g++){
            if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
          }
          if (gpsIdx >= 0) LOCATIONS[gpsIdx] = gpsLoc;
          else LOCATIONS.push(gpsLoc);

          switchLocation("gps");
        });
    }, function(){
      // Geolocation denied or failed  stay on default location (NYC)
      // User can still use search or GPS button manually
    }, { enableHighAccuracy: false, timeout: 8000 });
  })();

  // Expose radar mode switcher globally for onclick handlers
  window.switchRadarMode = switchRadarMode;

  // Ensure modals are direct children of body, after all other content
  var alertM = document.getElementById('alert-modal');
  var widgetM = document.getElementById('widget-modal');
  if (alertM) document.body.appendChild(alertM);
  if (widgetM) document.body.appendChild(widgetM);

})();

// Global alert modal functions (outside IIFE for click handler access)
function openAlertModal(feature){
  var existingModal = document.getElementById('dynamic-alert-modal');
  if (existingModal) existingModal.remove();
  
  var alert = feature.properties;
  var event = alert.event || "Weather Alert";
  var severity = (alert.severity || "").toLowerCase();
  var headline = alert.headline || "";
  var description = alert.description || "";
  var instruction = alert.instruction || "";
  var areaDesc = alert.areaDesc || "";
  var senderName = alert.senderName || "";
  var effective = alert.effective ? new Date(alert.effective) : null;
  var onset = alert.onset ? new Date(alert.onset) : null;
  var expires = alert.expires ? new Date(alert.expires) : null;
  
  var icon = "";
  var alertColor = "#3b82f6";
  if (event.toLowerCase().indexOf("tornado") >= 0){
    icon = ""; alertColor = "#ef4444";
  } else if (event.toLowerCase().indexOf("warning") >= 0 || severity === "extreme" || severity === "severe"){
    icon = ""; alertColor = "#ef4444";
  } else if (event.toLowerCase().indexOf("watch") >= 0 || severity === "moderate"){
    icon = ""; alertColor = "#f97316";
  } else if (event.toLowerCase().indexOf("advisory") >= 0){
    icon = ""; alertColor = "#eab308";
  }
  
  function fmtDateTime(d){
    if (!d || !isFinite(d.getTime())) return "--";
    var days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    var h = d.getHours(); var m = d.getMinutes();
    var ampm = h >= 12 ? "PM" : "AM";
    var hh = h % 12; if (hh === 0) hh = 12;
    return days[d.getDay()] + " " + months[d.getMonth()] + " " + d.getDate() + ", " + hh + ":" + (m < 10 ? "0"+m : m) + " " + ampm;
  }
  
  var severityBadge = "";
  if (severity === "extreme") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(220,38,38,0.3);color:#fca5a5;">Extreme</span>';
  else if (severity === "severe") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(239,68,68,0.25);color:#fca5a5;">Severe</span>';
  else if (severity === "moderate") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(249,115,22,0.25);color:#fdba74;">Moderate</span>';
  else if (severity === "minor") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(234,179,8,0.25);color:#fde047;">Minor</span>';
  
  var bodyContent = '';
  if (headline) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:15px;color:' + alertColor + ';">' + headline + severityBadge + '</div></div>';
  bodyContent += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:20px;"><div style="text-align:center;"><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:4px;">Effective</div><div style="font-size:14px;color:#fff;font-weight:500;">' + fmtDateTime(effective || onset) + '</div></div><div style="text-align:center;"><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:4px;">Expires</div><div style="font-size:14px;color:#fff;font-weight:500;">' + fmtDateTime(expires) + '</div></div></div>';
  if (description) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Description</div><div style="white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;border-left:3px solid rgba(255,255,255,0.1);">' + description.replace(/\n/g, '<br>') + '</div></div>';
  if (instruction) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Instructions</div><div style="white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;border-left:3px solid rgba(255,255,255,0.1);">' + instruction.replace(/\n/g, '<br>') + '</div></div>';
  if (areaDesc) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Affected Areas</div><div style="font-size:13px;color:#aaa;line-height:1.5;">' + areaDesc + '</div></div>';
  if (senderName) bodyContent += '<div><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Issued By</div><div style="color:#aaa;">' + senderName + '</div></div>';
  
  var modal = document.createElement('div');
  modal.id = 'dynamic-alert-modal';
  modal.innerHTML = '<div style="margin:auto;background:linear-gradient(145deg,rgba(30,30,35,0.98),rgba(20,20,25,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:16px;max-width:600px;width:90vw;max-height:85vh;overflow:auto;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.7);">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.2);">' +
      '<div style="display:flex;align-items:center;gap:12px;">' +
        '<span style="font-size:24px;">' + icon + '</span>' +
        '<span style="font-size:18px;font-weight:600;color:#fff;">' + event + '</span>' +
      '</div>' +
      '<button onclick="closeAlertModal()" style="background:none;border:none;color:#888;font-size:28px;cursor:pointer;padding:0 8px;line-height:1;">&times;</button>' +
    '</div>' +
    '<div style="padding:24px;overflow-y:auto;flex:1;color:#e0e0e0;font-size:14px;line-height:1.6;">' + bodyContent + '</div>' +
  '</div>';
  
  modal.setAttribute('style', 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:999999;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;overflow:auto;');
  modal.onclick = function(e){ if(e.target === modal) closeAlertModal(); };
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  modal.scrollIntoView({behavior:'smooth', block:'center'});
}

function closeAlertModal(){
  var modal = document.getElementById('dynamic-alert-modal');
  if (modal){ modal.remove(); document.documentElement.style.overflow = ''; document.body.style.overflow = ''; }
}

document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeAlertModal(); });

// ============ UNIFIED DROPDOWN SYSTEM ============
(function(){
  var allDropdowns = ['fire-dropdown', 'tornado-dropdown', 'quake-dropdown'];
  var pillMap = {
    'fire-status-pill': 'fire-dropdown',
    'tornado-status-pill': 'tornado-dropdown',
    'quake-status-pill': 'quake-dropdown'
  };

  function closeAllDropdowns(except){
    allDropdowns.forEach(function(id){
      if (id === except) return;
      var dd = document.getElementById(id);
      if (dd){
        dd.style.opacity = '0';
        dd.style.visibility = 'hidden';
        dd.style.pointerEvents = 'none';
      }
    });
  }

  function toggleDropdown(ddId){
    var dd = document.getElementById(ddId);
    if (!dd) return;
    var isOpen = dd.style.opacity === '1';
    closeAllDropdowns(isOpen ? null : ddId);
    dd.style.opacity = isOpen ? '0' : '1';
    dd.style.visibility = isOpen ? 'hidden' : 'visible';
    dd.style.pointerEvents = isOpen ? 'none' : 'auto';
  }

  // Attach click handlers to all pills
  Object.keys(pillMap).forEach(function(pillId){
    var pill = document.getElementById(pillId);
    if (pill){
      pill.style.cursor = 'pointer';
      pill.addEventListener('click', function(e){
        e.stopPropagation();
        toggleDropdown(pillMap[pillId]);
      });
    }
  });

  // Close all dropdowns when clicking outside
  document.addEventListener('click', function(e){
    var insideDropdown = allDropdowns.some(function(id){
      var dd = document.getElementById(id);
      return dd && dd.contains(e.target);
    });
    var insidePill = Object.keys(pillMap).some(function(id){
      var pill = document.getElementById(id);
      return pill && pill.contains(e.target);
    });
    if (!insideDropdown && !insidePill){
      closeAllDropdowns();
    }
  });

  // Close on Escape
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') closeAllDropdowns();
  });
})();
</script>
</div><!-- /dashboard-content -->
</body>
</html>
