\<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BLUISH</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
</body>
</html>

<style>
  @import url('https://api.fontshare.com/v2/css?f[]=neue-montreal@200,300,400,500,600,700&display=swap');

  :root{
  /* Core brand blue */
  --panel-blue:#2B22F4;

  /* Text */
  --ink:#2B22F4;
  --ink-dim:rgba(43,34,244,.68);

  /* MORE transparent heavenly whites */
  --paper-strong:rgba(255,255,255,.62);
  --paper:rgba(255,255,255,.48);
  --paper-soft:rgba(255,255,255,.38);

  /* Barely-there structure */
  --stroke:transparent;
  --stroke-2:transparent;


  /* Heavenly glow system */
  --glow-main:
  0 0 160px rgba(43,34,244,.05),
  0 0 300px rgba(43,34,244,.03),
  0 20px 80px rgba(15,23,42,.22);

--glow-mid:
  0 0 100px rgba(43,34,244,.04),
  0 14px 60px rgba(15,23,42,.20);

--glow-soft:
  0 0 70px rgba(43,34,244,.035),
  0 10px 40px rgba(15,23,42,.18);



  --radius-xl:30px;
  --radius-lg:22px;
  --radius-md:16px;
  --radius-sm:12px;

  /* Mobile-first spacing scale */
  --space-xs:4px;
  --space-sm:8px;
  --space-md:12px;
  --space-lg:16px;
  --space-xl:24px;
    
      /* ========= Fog / Haze tuning ========= */
  --fog-white-1: rgba(255,255,255,.18);
  --fog-white-2: rgba(255,255,255,.10);
  --fog-white-3: rgba(255,255,255,.06);

  --fog-blue-1: rgba(43,34,244,.10);
  --fog-blue-2: rgba(43,34,244,.06);
  --fog-blue-3: rgba(43,34,244,.03);

  --fog-blur-strong: blur(34px) saturate(125%);
  --fog-blur-mid:    blur(26px) saturate(120%);
  --fog-blur-soft:   blur(20px) saturate(115%);

}

  *{box-sizing:border-box}
  
  *::before,
  *::after{
    backdrop-filter:none !important;
    -webkit-backdrop-filter:none !important;
  }

  html,
  body{
    margin:0;
    padding:0;
    border:none;
    outline:none;
    box-shadow:none;
    background:transparent;
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
    overflow-x:hidden;
    transform:none !important;
    filter:none !important;
    perspective:none !important;
    contain:none !important;
    will-change:auto !important;
  }

  html{
    height:100%;
  }

  body{
    min-height:100%;
    font-family:'Neue Montreal',system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    color:var(--ink);
  }


  #cloud-soundscape-root{position:relative;min-height:100%;width:100%;transform:none !important;filter:none !important;will-change:auto !important;perspective:none !important;isolation:isolate;contain:layout style;}

  /* =========================
     Layout shell
     ========================= */
  #cloud-soundscape-root main{
    position:relative;
    min-height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:18px;
    z-index:1;
    background:transparent;
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
  }

  #cloud-soundscape-root main::before,
  #cloud-soundscape-root main::after{
    display:none !important;
    content:none !important;
  }

  .panel{
    width:100%;
    max-width:1160px;
    background:none;
    border:none;
    box-shadow:none;
    outline:none;
    display:flex;
    flex-direction:column;
    gap:10px;
    -webkit-backdrop-filter:none;
    backdrop-filter:none;
  }

  .panel::before,
  .panel::after{
    display:none !important;
    content:none !important;
  }

  .content-stack{
    display:flex;
    flex-direction:column;
    gap:10px;
    width:100%;
    background:none;
    box-shadow:none;
  }

  /* =========================
     WEATHER CARD (primary)
     ========================= */
  .weather-card{
  position:relative;
  width:100%;
  background:transparent;
  border:none;
  box-shadow:none;
  overflow:visible;
}

.weather-card > *{ position:relative; z-index:1; }


  /* =========================
     Top grid
     ========================= */
  .top-grid{
    display:block;
    width:100%;
    background:none;
    box-shadow:none;
  }

  /* =========================
     Main Weather Card (Compact)
     ========================= */
  .left-now{
    position:relative;
    padding:14px;
    border-radius:20px;
    background: rgba(255,255,255,.06);
    border:none;
    box-shadow:none;
    backdrop-filter:blur(18px);
    -webkit-backdrop-filter:blur(18px);
  }

  .weather-top-row{
    position:relative;
    display:flex;
    justify-content:flex-start;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    padding-right:100px;
    min-height:120px;
  }

  .weather-main{
    display:flex;
    align-items:center;
    gap:16px;
    flex-wrap:wrap;
  }

  .weather-temp-block{
    display:flex;
    flex-direction:column;
  }

  .weather-temp-block .temp{
    font-size:3.2rem;
    font-weight:740;
    letter-spacing:-.04em;
    line-height:1;
    transition: opacity 0.3s ease;
  }

  .weather-temp-block .feels{
    font-size:.95rem;
    color:var(--ink-dim);
    margin-top:4px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.06em;
  }

  .weather-cond-block{
    display:flex;
    align-items:center;
    gap:8px;
  }

  .weather-cond-block .cond-icon-img{
    width:100px;
    height:100px;
    object-fit:contain;
  }

  .weather-cond-block .cond-text{
    font-size:1rem;
    font-weight:700;
    color:var(--ink);
  }

  .weather-moon-block{
    position:absolute;
    top:-5px;
    right:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:0;
    padding:0;
    background:transparent;
    box-shadow:none;
    z-index:10;
  }

  .weather-moon-block .moon-img{
  width:250px;
  height:250px;
  border-radius:50%;
  object-fit:cover;
  transform:scale(1.15);
  clip-path:circle(42%) !important;
  -webkit-clip-path:circle(42%) !important;
  filter: drop-shadow(0 0 15px rgba(255,255,255,.45)) drop-shadow(0 0 35px rgba(200,210,255,.25));
}

  .weather-moon-block .moon-text{
    font-size:.82rem;
    font-weight:500;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:var(--ink-dim);
    text-align:center;
    margin-top:6px;
    position:relative;
    z-index:2;
    transform:scaleY(1.2);
  }

  .weather-moon-block .moon-illum{
    font-weight:700;
  }

  .weather-moon-block .moon-phase{
    font-weight:400;
  }

  .weather-details-row{
    margin-top:14px;
    padding-top:14px;
    border-top:1px solid rgba(43,34,244,.12);
    border-image:linear-gradient(to right, rgba(43,34,244,.12) 0%, rgba(43,34,244,.12) 70%, transparent 85%) 1;
  }

  .weather-details-row:last-child{
    padding-bottom:4px;
  }

  .weather-hilo{
    font-size:.82rem;
    font-weight:700;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:var(--ink);
    margin-bottom:12px;
  }

  .feels-inline{
    color:var(--ink);
    opacity:.7;
  }

  .hilo-sep{
    opacity:.3;
    margin:0 2px;
  }

  .weather-stats-grid{
    display:flex;
    flex-wrap:wrap;
    gap:6px 14px;
  }

  .weather-stat{
    display:flex;
    align-items:baseline;
    gap:5px;
  }

  .weather-stat .k{
    font-size:.64rem;
    color:var(--ink-dim);
    font-weight:600;
    letter-spacing:.06em;
    text-transform:uppercase;
  }

  .weather-stat .v{
    font-size:.68rem;
    color:var(--ink);
    font-weight:700;
    letter-spacing:.06em;
    text-transform:uppercase;
  }

  .weather-stat .pollen-val{
    font-size:.72rem;
    font-weight:800;
    padding:2px 8px;
    border-radius:6px;
  }

  .weather-stat .pollen-val.none{
    background:rgba(150,150,150,.20);
    color:rgba(100,100,100,1);
  }

  .weather-stat .pollen-val.low{
    background:rgba(34,197,94,.18);
    color:rgba(22,163,74,1);
  }

  .weather-stat .pollen-val.moderate{
    background:rgba(234,179,8,.18);
    color:rgba(180,130,8,1);
  }

  .weather-stat .pollen-val.high{
    background:rgba(249,115,22,.18);
    color:rgba(220,90,15,1);
  }

  .weather-stat .pollen-val.very-high{
    background:rgba(239,68,68,.18);
    color:rgba(220,50,50,1);
  }

  .weather-stat .ap-val{
    font-size:.78rem;
    font-weight:850;
  }

  .weather-left-stack{
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .loc-cycler{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    z-index:100;
    position:relative;
  }

  .loc-arrow{
    width:20px;
    height:20px;
    border-radius:50%;
    border:none;
    background:none;
    color:var(--ink);
    font-size:.85rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .15s ease;
    padding:0;
    line-height:1;
    flex-shrink:0;
    font-family:system-ui,sans-serif;
    opacity:.35;
  }

  .loc-arrow:hover{
    opacity:.8;
  }

  .loc-arrow:active{
    transform:scale(0.85);
  }

  .loc-cycler-center{
    text-align:left;
    width:280px;
    display:flex;
    flex-direction:column;
    align-items:flex-start;
  }

  .loc-dots-row{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    margin-top:3px;
    position:relative;
  }

  .loc-name{
    font-weight:820;
    font-size:1.2rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    transition:opacity .15s ease;
  }

  .loc-dots{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:4px;
  }

  .loc-dot{
    width:4px;
    height:4px;
    border-radius:50%;
    background:rgba(43,34,244,.15);
    transition:all .25s ease;
  }

  .loc-dot.active{
    background:rgba(43,34,244,.5);
    width:14px;
    border-radius:2px;
  }

  .loc-gps-btn{
    width:16px;
    height:16px;
    border-radius:50%;
    border:1px solid rgba(43,34,244,.3);
    background:rgba(43,34,244,.06);
    font-size:.55rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    margin-left:4px;
    opacity:.5;
    transition:all .2s ease;
    flex-shrink:0;
    color:var(--ink);
  }

  .loc-gps-btn:hover{
    opacity:.9;
  }

  .loc-gps-btn.active{
    opacity:1;
    background:rgba(43,34,244,.12);
  }

  .loc-gps-btn.loading{
    animation:gps-pulse 1s ease infinite;
  }

  @keyframes gps-pulse{
    0%,100%{ opacity:.4; }
    50%{ opacity:1; }
  }

  /* Search toggle button - matches GPS button style */
  .loc-search-toggle{
    position:relative;
    width:22px;
    height:22px;
    border-radius:50%;
    border:1px solid rgba(43,34,244,.3);
    background:rgba(43,34,244,.06);
    font-size:.7rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    opacity:.5;
    transition:all .2s ease;
    flex-shrink:0;
    color:var(--ink);
    line-height:1;
  }
  .loc-search-toggle:hover{
    opacity:.9;
  }
  .loc-search-toggle.active{
    opacity:1;
    background:rgba(43,34,244,.15);
    border-color:rgba(43,34,244,.5);
  }

  /* Search dropdown - hidden by default, overlays dots row */
  .loc-search-box{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%) scale(.92);
    display:flex;
    align-items:center;
    gap:4px;
    background:rgba(255,255,255,.15);
    backdrop-filter:blur(20px) saturate(120%);
    -webkit-backdrop-filter:blur(20px) saturate(120%);
    border-radius:12px;
    padding:5px 8px 5px 12px;
    box-shadow:0 0 30px rgba(255,255,255,.12), inset 0 0 20px rgba(255,255,255,.22);
    z-index:200;
    opacity:0;
    pointer-events:none;
    transition:all .18s cubic-bezier(.4,0,.2,1);
    white-space:nowrap;
  }
  .loc-search-box.open{
    opacity:1;
    pointer-events:auto;
    transform:translate(-50%,-50%) scale(1);
  }
  .loc-search-box.open ~ .loc-dots,
  .loc-search-box.open ~ .loc-arrow{
    opacity:0;
    pointer-events:none;
  }

  .loc-search-input{
    border:none;
    background:none;
    outline:none;
    font-size:.72rem;
    font-weight:600;
   color:rgba(255,255,255,.9);
    width:130px;
    font-family:inherit;
  }

  .loc-search-input::placeholder{
    color:rgba(255,255,255,.5);
    font-weight:500;
  }

  .loc-search-close{
    border:none;
    background:none;
    cursor:pointer;
    font-size:.65rem;
    color:rgba(255,255,255,.5);
    padding:2px 5px;
    line-height:1;
    border-radius:50%;
    transition:all .15s ease;
  }

  .loc-search-close:hover{
    color:rgba(255,255,255,.9);
    background:rgba(255,255,255,.15);
  }

  /* Earthquake geology popup */
  .quake-geo-popup .leaflet-popup-content-wrapper {
    background: rgba(255,255,255,.95);
    backdrop-filter: blur(8px);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
    padding: 0;
  }
  .quake-geo-popup .leaflet-popup-content {
    margin: 8px 10px;
  }
  .quake-geo-popup .leaflet-popup-tip {
    background: rgba(255,255,255,.95);
  }

  /* Earthquake dropdown */
  .quake-status-wrap:hover #quake-dropdown,
  .quake-status-wrap #quake-dropdown:hover{
    opacity:1 !important;
    visibility:visible !important;
    pointer-events:auto !important;
  }

  /* Wildfire dropdown */
  .fire-status-wrap:hover #fire-dropdown,
  .fire-status-wrap #fire-dropdown:hover{
    opacity:1 !important;
    visibility:visible !important;
    pointer-events:auto !important;
  }

  .fire-item:hover{
    background:rgba(255,255,255,.15);
  }

  .quake-option{
    padding:8px 10px;
    border-radius:8px;
    font-size:.72rem;
    font-weight:600;
    color:var(--ink);
    cursor:pointer;
    transition:background .15s ease;
    display:flex;
    flex-direction:column;
    gap:2px;
  }

  .quake-option:hover,
  .quake-item:hover{
    background:rgba(255,255,255,.15);
  }

  .quake-mag{
    font-weight:800;
    font-size:.78rem;
  }

  .quake-place{
    font-size:.68rem;
    color:var(--ink-dim);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .quake-time{
    font-size:.58rem;
    color:rgba(43,34,244,.5);
    text-transform:uppercase;
    letter-spacing:.04em;
  }

  .loc-meta{font-size:.82rem;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.06em}

  .weather-alerts-block{
    position:absolute;
    top:10px;
    left:280px;
    right:360px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    z-index:5;
    pointer-events:none;
  }
  
  .weather-alert{
    pointer-events:auto;
    position:relative;
    max-width:420px;
    width:100%;
    display:flex;
    align-items:flex-start;
    gap:8px;
    padding:8px 12px;
    padding-right:85px;
    border-radius:10px;
    font-size:.68rem;
    font-weight:600;
    letter-spacing:.04em;
    text-transform:uppercase;
    backdrop-filter:blur(12px);
    -webkit-backdrop-filter:blur(12px);
  }
  
  .weather-alert.warning{
    background:rgba(220,38,38,1);
    color:#fff;
    border-left:3px solid rgba(180,20,20,1);
  }
  
  .weather-alert.watch{
    background:rgba(234,88,12,1);
    color:#fff;
    border-left:3px solid rgba(194,65,12,1);
  }
  
  .weather-alert.advisory{
    background:rgba(202,138,4,1);
    color:#fff;
    border-left:3px solid rgba(161,98,7,1);
  }
  
  .weather-alert.statement{
    background:rgba(59,130,246,1);
    color:#fff;
    border-left:3px solid rgba(37,99,235,1);
  }
  
  .weather-alert-icon{
    flex-shrink:0;
    font-size:.9rem;
  }
  
  .weather-alert-text{
    flex:1;
    line-height:1.4;
  }
  
  .weather-alert-title{
    font-weight:800;
  }
  
  .weather-alert-expires{
    font-weight:500;
    opacity:.7;
    margin-left:6px;
  }
  
  .weather-alert-time{
    display:block;
    font-size:.6rem;
    font-weight:500;
    text-transform:none;
    opacity:.9;
    margin-top:3px;
    letter-spacing:0;
  }
  
  .weather-alert-severity{
    position:absolute;
    top:6px;
    right:8px;
    padding:2px 8px;
    border-radius:4px;
    font-size:.55rem;
    font-weight:700;
    text-transform:uppercase;
    background:rgba(255,255,255,.25);
    color:#fff;
  }
  
  .weather-alert-summary{
    display:block;
    font-size:.62rem;
    font-weight:500;
    text-transform:none;
    opacity:.9;
    margin-top:4px;
    line-height:1.3;
    letter-spacing:0;
    color:#fff;
  }
  
  .weather-alert-areas{
    display:block;
    font-size:.55rem;
    font-weight:500;
    text-transform:none;
    opacity:.6;
    margin-top:2px;
    letter-spacing:0;
  }

  .big-temp-row{
    margin-top:10px;
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:10px;
    padding-right:92px; /* reserves for moon mini */
  }

  .temp{font-size:4rem;font-weight:740;letter-spacing:-.04em;line-height:1;text-transform:uppercase}

  .cond{display:flex;gap:10px;align-items:center}
  .cond-icon{
    width:30px;height:30px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:rgba(43,34,244,.10);
    border:1px solid rgba(43,34,244,.18);
  }
  .cond-text{font-size:.92rem;color:var(--ink);font-weight:650}

  /* Moon mini */
  #moon-mini{
    position:absolute;
    top:12px;right:12px;
    width:92px;height:92px;
    border-radius:26px;
    background:rgba(255,255,255,.52);
  	border:none;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:4px;
  }
  #moon-mini-icon{font-size:3.1rem;line-height:1}
  #moon-mini-text{font-size:.68rem;font-weight:850;color:var(--ink);text-align:center;padding:0 8px}

  /* Today mini block */
  .today-mini{
    margin-top:12px;
    background:var(--paper-soft);
  	border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
  }
  /* =========================
   Main Weather micro tabs (Summary / Metrics)
   ========================= */
.now-tabs{
  margin-top:12px;
  display:flex;
  gap:8px;
}

.now-tab{
  appearance:none;
  border:none;
  cursor:pointer;

  padding:8px 12px;
  border-radius:999px;

  background: rgba(255,255,255,.06);
  box-shadow: var(--glow-soft);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);

  font-size:.60rem;
  letter-spacing:.16em;
  text-transform:uppercase;
  font-weight:900;
  color:rgba(43,34,244,.72);

  transition: transform .12s ease, box-shadow .18s ease, background .18s ease;
}

.now-tab:hover{
  transform: translateY(-1px);
  box-shadow: 0 0 70px rgba(255,255,255,.18), inset 0 0 34px rgba(255,255,255,.26);
}

.now-tab.is-active{
  background: rgba(255,255,255,.48);
  color: rgba(43,34,244,.92);
  box-shadow: var(--glow-mid);
}

.now-tabpanel{
  margin-top:10px;
}


  .today-mini-top{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
    padding-bottom:6px;
    border-bottom:1px solid rgba(43,34,244,.10);
  }
  .tlabel{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:750;
  }
  .tvalue{font-size:.86rem;font-weight:750;color:var(--ink)}
  .today-mini-sub{margin-top:8px;display:flex;flex-direction:column;gap:6px}
  .row{display:flex;justify-content:space-between;gap:10px}
  .row .k{font-size:.74rem;color:var(--ink-dim);font-weight:700}
  .row .v{font-size:.74rem;color:var(--ink);font-weight:750}

  /* =========================
     Middle stack / metrics
     ========================= */
    /* =========================
     Move metrics into LEFT card (compact grid)
     ========================= */
  .now-stats{
    margin-top:12px;
    display:grid;
    grid-template-columns:repeat(4, minmax(0,1fr));
    gap:10px;
  }
  @media (max-width:1100px){
    .now-stats{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  }

  .now-stat{
    background: rgba(255,255,255,.06);
    border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
    min-width:0;
  }
  .now-stat .k{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:800;
  }
  .now-stat .v{
    margin-top:6px;
    font-size:1.05rem;
    font-weight:820;
    color:var(--ink);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

    .mid-stack{
    display:flex;
    flex-direction:column;
    gap:12px;
    min-width:0;
    height:100%;
  }


  .metric-grid{
    display:grid;
    grid-template-columns:repeat(4, minmax(0,1fr));
    gap:10px;
  }
  @media (max-width:1100px){
    .metric-grid{grid-template-columns:repeat(2, minmax(0,1fr))}
  }

  .mcard{
  	background: rgba(255,255,255,.06);
  	border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
    min-width:0;
  }
  .mk{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:800;
  }
  .mv{
    margin-top:6px;
    font-size:1.05rem;
    font-weight:820;
    color:var(--ink);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
/* =========================
     Air & Pollen Section
     ========================= */
  .air-pollen-section{
    margin-top:12px;
    background:var(--paper-soft);
    border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
  }

  .air-pollen-top{
    padding-bottom:6px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:8px;
  }

  .ap-label{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:850;
  }

  .air-pollen-grid{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:10px;
  }

  .ap-item{
    display:flex;
    align-items:baseline;
    gap:6px;
  }

  .ap-key{
    font-size:.68rem;
    color:var(--ink-dim);
    font-weight:700;
  }

  .ap-val{
    font-size:.82rem;
    font-weight:850;
    color:var(--ink);
  }

  .ap-val.good{ color:rgba(34,197,94,1); }
  .ap-val.moderate{ color:rgba(234,179,8,1); }
  .ap-val.unhealthy-sensitive{ color:rgba(249,115,22,1); }
  .ap-val.unhealthy{ color:rgba(239,68,68,1); }
  .ap-val.very-unhealthy{ color:rgba(168,85,247,1); }
  .ap-val.hazardous{ color:rgba(127,29,29,1); }

  .pollen-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  .pollen-item{
    display:flex;
    align-items:center;
    gap:4px;
    padding:4px 8px;
    border-radius:10px;
    background:rgba(255,255,255,.06);
    box-shadow:0 0 20px rgba(255,255,255,.08), inset 0 0 12px rgba(255,255,255,.12);
  }

  .pollen-icon{
    font-size:.9rem;
  }

  .pollen-type{
    font-size:.64rem;
    font-weight:700;
    color:var(--ink-dim);
  }

  .pollen-val{
    font-size:.72rem;
    font-weight:850;
    padding:2px 6px;
    border-radius:6px;
  }

  .pollen-val.none{
    background:rgba(150,150,150,.20);
    color:rgba(100,100,100,1);
    padding:2px 8px;
    border-radius:6px;
  }

  .pollen-val.low{
    background:rgba(34,197,94,.15);
    color:rgba(22,163,74,1);
  }

  .pollen-val.moderate{
    background:rgba(234,179,8,.15);
    color:rgba(180,130,8,1);
  }

  .pollen-val.high{
    background:rgba(249,115,22,.15);
    color:rgba(220,90,15,1);
  }

  .pollen-val.very-high{
    background:rgba(239,68,68,.15);
    color:rgba(220,50,50,1);
  }
/* =========================
     TODAY Timeline Widget (v4/v5 integrated)
     ========================= */
  .today-timeline-card{
    position:relative;
    width:100%;
    background: rgba(255,255,255,.06);
    border:none;
    border-radius:20px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px) saturate(125%);
    -webkit-backdrop-filter:blur(18px) saturate(125%);
    padding:14px;
    margin-top:10px;
  }

  /* TODAY Timeline Header */
  .today-tl-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:16px;
    padding-bottom:10px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:8px;
  }

  .today-tl-title{
    font-size:.62rem;
    font-weight:900;
    letter-spacing:.16em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
  }

  .today-tl-meta{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:18px;
  }

  .today-tl-meta .meta-item{
    display:flex;
    align-items:center;
    gap:4px;
  }

  .today-tl-meta .meta-key{
    font-size:.50rem;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:rgba(43,34,244,.55);
    font-weight:700;
  }

  .today-tl-meta .meta-val{
    font-size:.70rem;
    font-weight:750;
    color:var(--ink);
  }

  .today-tl-meta .meta-val.orange{ color:#f97316; }
  .today-tl-meta .meta-val.green{ color:#22c55e; }

  .today-tl-stats{
    display:flex;
    gap:20px;
    align-items:center;
  }

  .today-tl-stat{
    text-align:center;
  }

  .today-tl-stat .stat-label{
    font-size:.48rem;
    font-weight:700;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:rgba(43,34,244,.50);
  }

  .today-tl-stat .stat-value{
    font-size:.68rem;
    font-weight:800;
    color:var(--ink);
  }

  /* TODAY Timeline Body */
  .today-tl-body{
    position:relative;
    padding-bottom:12px;
  }

  /* Top Bars: Kp and Cloud */
  .today-tl-top-bars{
    display:flex;
    flex-direction:column;
    gap:0;
    margin-bottom:0;
    margin-left:0;
  }

  .today-tl-bar-row{
    display:flex;
    align-items:center;
    gap:0;
    height:12px;
    margin-left:0;
    position:relative;
  }

  .today-tl-bar-label{
    position:absolute;
    left:6px;
    font-size:.42rem;
    font-weight:700;
    letter-spacing:.02em;
    text-transform:uppercase;
    color:rgba(255,255,255,.60);
    text-shadow:0 1px 2px rgba(0,0,0,.40);
    z-index:2;
  }

  .today-tl-bar-track{
    width:100%;
    height:12px;
    background:rgba(43,34,244,.06);
    border-radius:14px 14px 0 0;
    display:flex;
    overflow:hidden;
  }

  .today-tl-bar-track.cloud{
    border-radius:0;
  }

  .today-tl-bar-segment{
    height:100%;
  }

  /* Sky Bar Container */
  .today-tl-sky-bar{
    position:relative;
    border-radius:0 0 14px 14px;
    overflow:hidden;
    min-height:180px;
    margin-left:0;
    margin-right:0;
  }

  /* Sky gradient bands */
  .today-tl-sky-bands{
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
    display:flex;
    z-index:0;
  }

  .today-tl-sky-band{
    height:100%;
  }

  .today-tl-sky-band.night{
    background:linear-gradient(180deg, 
      rgba(15,20,45,.88) 0%, 
      rgba(22,30,65,.80) 40%,
      rgba(30,45,85,.70) 100%);
  }

  .today-tl-sky-band.astro-twilight{
    background:linear-gradient(180deg, 
      rgba(25,35,75,.75) 0%, 
      rgba(40,55,110,.65) 50%,
      rgba(55,75,140,.55) 100%);
  }

  .today-tl-sky-band.blue-hour{
    background:linear-gradient(180deg, 
      rgba(55,80,150,.55) 0%, 
      rgba(75,110,175,.45) 50%,
      rgba(100,140,195,.35) 100%);
  }

  .today-tl-sky-band.golden{
    background:linear-gradient(180deg, 
      rgba(255,160,80,.65) 0%, 
      rgba(255,190,110,.45) 50%,
      rgba(255,220,150,.30) 100%);
  }

  .today-tl-sky-band.golden-am{
    background:linear-gradient(90deg, 
      rgba(200,140,100,.50) 0%,
      rgba(240,160,80,.58) 20%,
      rgba(255,170,70,.65) 40%,
      rgba(255,195,110,.48) 60%,
      rgba(255,215,150,.30) 80%,
      rgba(255,230,185,.15) 100%);
  }

  .today-tl-sky-band.golden-pm{
    background:linear-gradient(90deg, 
      rgba(255,230,185,.15) 0%,
      rgba(255,215,150,.30) 20%,
      rgba(255,195,110,.48) 40%,
      rgba(255,170,70,.65) 60%,
      rgba(240,160,80,.58) 80%,
      rgba(200,140,100,.50) 100%);
  }

  .today-tl-sky-band.golden-peak{
    background:linear-gradient(180deg, 
      rgba(255,100,30,.90) 0%, 
      rgba(255,130,50,.75) 50%,
      rgba(255,160,80,.60) 100%);
  }

  .today-tl-sky-band.day{
    background:linear-gradient(180deg, 
      rgba(135,195,250,.40) 0%, 
      rgba(175,215,255,.25) 50%,
      rgba(210,235,255,.15) 100%);
  }

  /* Planet Tracks */
  .today-tl-planet-tracks{
    position:relative;
    z-index:2;
    padding:10px 0 8px 0;
    margin-left:0;
  }

  .today-tl-planet-row{
    display:flex;
    align-items:center;
    height:10px;
    margin-bottom:3px;
    padding-left:6px;
  }

  .today-tl-planet-row:last-child{
    margin-bottom:0;
  }

  .today-tl-planet-indicator{
    width:8px;
    height:8px;
    border-radius:50%;
    flex-shrink:0;
    margin-right:6px;
    margin-left:2px;
  }

  .today-tl-planet-dir{
    width:18px;
    font-size:.48rem;
    font-weight:700;
    letter-spacing:.02em;
    color:rgba(255,255,255,.55);
    text-align:center;
    flex-shrink:0;
    text-shadow:0 1px 2px rgba(0,0,0,.40);
  }

  .today-tl-planet-bar{
    flex:1;
    height:5px;
    position:relative;
  }

  .today-tl-planet-vis{
    position:absolute;
    height:100%;
    border-radius:2px;
    box-shadow:0 0 6px currentColor;
  }

  .today-tl-planet-vis.solid{
    opacity:0.90;
  }

  .today-tl-planet-vis.dashed{
    opacity:0.40;
  }

  /* Weather Row */
  .today-tl-weather-row{
    position:relative;
    z-index:2;
    display:flex;
    padding:12px 0 16px 0;
    margin-left:0;
    border-top:1px solid rgba(255,255,255,.10);
  }

  .today-tl-weather-hour{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    min-width:0;
  }

  .today-tl-weather-time{
    font-size:.64rem;
    font-weight:700;
    color:rgba(255,255,255,.55);
    text-shadow:0 1px 2px rgba(0,0,0,.50);
    margin-bottom:2px;
  }

  .today-tl-weather-icon{
    font-size:26px;
    line-height:1;
    filter:drop-shadow(0 1px 2px rgba(0,0,0,.30));
    display:inline-block;
    margin:3px 0;
  }

  .today-tl-weather-temp{
    font-size:.82rem;
    font-weight:800;
    color:#fff;
    text-shadow:0 1px 3px rgba(0,0,0,.50);
    margin-top:2px;
  }

  .today-tl-weather-precip{
    font-size:.62rem;
    font-weight:700;
    color:rgba(255,255,255,.5);
    text-shadow:0 1px 2px rgba(0,0,0,.30);
    margin-top:1px;
  }

  .today-tl-weather-precip.active{
    color:rgba(100,180,255,.95);
  }

  /* Day hours - dark text */
  .today-tl-weather-hour.day-hour .today-tl-weather-time{
    color:rgba(43,34,244,.50);
    text-shadow:none;
  }

  .today-tl-weather-hour.day-hour .today-tl-weather-temp{
    color:#2B22F4;
    text-shadow:none;
  }

  .today-tl-weather-hour.day-hour .today-tl-weather-precip{
    color:rgba(43,34,244,.40);
    text-shadow:none;
  }

  /* =============================================
     WEATHER ICON ANIMATIONS (Complete v5 set)
     ============================================= */

  /* SUN - gentle pulse/glow (code 0 day) */
  @keyframes today-sun-pulse {
    0%, 100% { 
      transform: scale(1); 
      filter: drop-shadow(0 0 3px rgba(255,200,0,0.6));
    }
    50% { 
      transform: scale(1.06); 
      filter: drop-shadow(0 0 8px rgba(255,200,0,0.90));
    }
  }

  .today-tl-weather-icon.sun {
    animation: today-sun-pulse 3s ease-in-out infinite;
  }

  /* MOON / CLEAR NIGHT - twinkle (code 0 night) */
  @keyframes today-night-twinkle {
    0%, 100% { 
      filter: drop-shadow(0 0 2px rgba(200,220,255,0.5)); 
    }
    50% { 
      filter: drop-shadow(0 0 6px rgba(200,220,255,0.90)); 
    }
  }

  .today-tl-weather-icon.night {
    animation: today-night-twinkle 2.5s ease-in-out infinite;
  }

  /* PARTLY CLOUDY - subtle wobble (codes 1, 2) */
  @keyframes today-partly-wobble {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    25% { transform: translateX(1px) rotate(1deg); }
    75% { transform: translateX(-1px) rotate(-1deg); }
  }

  .today-tl-weather-icon.partly {
    animation: today-partly-wobble 5s ease-in-out infinite;
  }

  /* OVERCAST / CLOUDY - gentle drift (code 3) */
  @keyframes today-cloud-drift {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(2px); }
  }

  .today-tl-weather-icon.cloud {
    animation: today-cloud-drift 4s ease-in-out infinite;
  }

  /* FOG / MIST - slow fade pulse (codes 45, 48) */
  @keyframes today-fog-fade {
    0%, 100% { opacity: 1; transform: scaleX(1); }
    50% { opacity: 0.65; transform: scaleX(1.02); }
  }

  .today-tl-weather-icon.fog {
    animation: today-fog-fade 4s ease-in-out infinite;
  }

  /* DRIZZLE - light bounce (codes 51, 53, 55) */
  @keyframes today-drizzle-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(1px); }
  }

  .today-tl-weather-icon.drizzle {
    animation: today-drizzle-bounce 2s ease-in-out infinite;
  }

  /* FREEZING DRIZZLE - bounce + shimmer (codes 56, 57) */
  @keyframes today-freezing-drizzle {
    0%, 100% { 
      transform: translateY(0); 
      filter: drop-shadow(0 0 2px rgba(150,200,255,0.4));
    }
    50% { 
      transform: translateY(1px); 
      filter: drop-shadow(0 0 5px rgba(150,200,255,0.75));
    }
  }

  .today-tl-weather-icon.freezing-drizzle {
    animation: today-freezing-drizzle 2s ease-in-out infinite;
  }

  /* RAIN - bounce like drops (codes 61, 63, 65, 80, 81, 82) */
  @keyframes today-rain-bounce {
    0%, 100% { transform: translateY(0); }
    25% { transform: translateY(-1px); }
    50% { transform: translateY(1px); }
    75% { transform: translateY(-0.5px); }
  }

  .today-tl-weather-icon.rain {
    animation: today-rain-bounce 1.5s ease-in-out infinite;
  }

  /* FREEZING RAIN - bounce + icy shimmer (codes 66, 67) */
  @keyframes today-freezing-rain {
    0%, 100% { 
      transform: translateY(0); 
      filter: drop-shadow(0 0 2px rgba(100,180,255,0.5));
    }
    25% { transform: translateY(-1px); }
    50% { 
      transform: translateY(1px); 
      filter: drop-shadow(0 0 6px rgba(100,180,255,0.85));
    }
    75% { transform: translateY(-0.5px); }
  }

  .today-tl-weather-icon.freezing-rain {
    animation: today-freezing-rain 1.8s ease-in-out infinite;
  }

  /* SNOW - gentle float (codes 71, 73, 75, 85, 86) */
  @keyframes today-snow-float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-1px) rotate(2deg); }
    50% { transform: translateY(1px) rotate(0deg); }
    75% { transform: translateY(-0.5px) rotate(-2deg); }
  }

  .today-tl-weather-icon.snow {
    animation: today-snow-float 3s ease-in-out infinite;
  }

  /* SLEET / ICE PELLETS - sharp bounce (code 77) */
  @keyframes today-sleet-bounce {
    0%, 100% { transform: translateY(0) scale(1); }
    15% { transform: translateY(-2px) scale(1); }
    30% { transform: translateY(2px) scale(0.96); }
    45% { transform: translateY(-1px) scale(1); }
    60% { transform: translateY(1px) scale(0.98); }
  }

  .today-tl-weather-icon.sleet {
    animation: today-sleet-bounce 1.2s ease-in-out infinite;
  }

  /* HAIL - aggressive bounce with shake (codes 96, 99 without thunder) */
  @keyframes today-hail-bounce {
    0%, 100% { transform: translateY(0) translateX(0); }
    10% { transform: translateY(-2px) translateX(1px); }
    20% { transform: translateY(2px) translateX(-1px); }
    30% { transform: translateY(-1px) translateX(0); }
    40% { transform: translateY(1px) translateX(1px); }
    50% { transform: translateY(-1px) translateX(-1px); }
  }

  .today-tl-weather-icon.hail {
    animation: today-hail-bounce 0.8s ease-in-out infinite;
  }

  /* THUNDERSTORM - flash effect (code 95) */
  @keyframes today-storm-flash {
    0%, 88%, 100% { 
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); 
    }
    90%, 94% { 
      filter: drop-shadow(0 0 12px rgba(255,255,150,1)) brightness(1.35); 
    }
  }

  .today-tl-weather-icon.storm {
    animation: today-storm-flash 3.5s ease-in-out infinite;
  }

  /* THUNDERSTORM WITH HAIL - flash + shake (codes 96, 99 with thunder) */
  @keyframes today-storm-hail {
    0%, 85%, 100% { 
      transform: translateY(0) translateX(0);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); 
    }
    88%, 92% { 
      transform: translateY(0) translateX(0);
      filter: drop-shadow(0 0 12px rgba(255,255,150,1)) brightness(1.35); 
    }
    10% { transform: translateY(-2px) translateX(1px); }
    20% { transform: translateY(2px) translateX(-1px); }
    30% { transform: translateY(-1px) translateX(0); }
  }

  .today-tl-weather-icon.storm-hail {
    animation: today-storm-hail 2s ease-in-out infinite;
  }

  /* WIND - sway motion */
  @keyframes today-wind-sway {
    0%, 100% { transform: rotate(-4deg) translateX(0); }
    50% { transform: rotate(4deg) translateX(2px); }
  }

  .today-tl-weather-icon.wind {
    animation: today-wind-sway 2s ease-in-out infinite;
  }

  /* MIXED RAIN/SNOW - alternating bounce (winter mix) */
  @keyframes today-mix-bounce {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    20% { transform: translateY(-1px) rotate(2deg); }
    40% { transform: translateY(1px) rotate(-1deg); }
    60% { transform: translateY(-0.5px) rotate(1deg); }
    80% { transform: translateY(1px) rotate(-2deg); }
  }

  .today-tl-weather-icon.mix {
    animation: today-mix-bounce 2s ease-in-out infinite;
  }

  /* Stagger animations */
  .today-tl-weather-hour:nth-child(2n) .today-tl-weather-icon { animation-delay: 0.3s; }
  .today-tl-weather-hour:nth-child(3n) .today-tl-weather-icon { animation-delay: 0.6s; }
  .today-tl-weather-hour:nth-child(4n) .today-tl-weather-icon { animation-delay: 0.9s; }
  .today-tl-weather-hour:nth-child(5n) .today-tl-weather-icon { animation-delay: 1.2s; }
  .today-tl-weather-hour:nth-child(6n) .today-tl-weather-icon { animation-delay: 0.15s; }
  .today-tl-weather-hour:nth-child(7n) .today-tl-weather-icon { animation-delay: 0.45s; }

  /* NOW Marker */
  .today-tl-now-marker{
    position:absolute;
    top:0;
    bottom:-40px;
    width:3px;
    background:rgba(255,140,0,.9);
    border-radius:2px;
    z-index:100;
    box-shadow:0 0 10px rgba(255,140,0,.6), 0 0 20px rgba(255,100,0,.3);
  }

  .today-tl-now-label{
    display:none;
  }

  .today-tl-now-bubble{
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,140,0,.95);
    color:#fff;
    padding:5px 8px;
    border-radius:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:1px;
    box-shadow:0 3px 10px rgba(255,100,0,.4);
  }

  .today-tl-now-temp{
    font-size:.80rem;
    font-weight:900;
  }

  .today-tl-now-time{
    font-size:.46rem;
    font-weight:700;
    opacity:0.70;
    letter-spacing:.06em;
  }

  /* TODAY Timeline Legend */
  .today-tl-legend{
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    align-items:center;
    gap:10px;
    padding-top:6px;
    margin-top:2px;
    border-top:1px solid rgba(43,34,244,.08);
  }

  .today-tl-legend-item{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:2px;
    padding:6px 10px;
    background:rgba(255,255,255,.06);
    border-radius:12px;
    font-size:.62rem;
    font-weight:700;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:rgba(43,34,244,.65);
    box-shadow:0 0 16px rgba(255,255,255,.08), inset 0 0 10px rgba(255,255,255,.12);
  }

  .today-tl-legend-top{
    display:flex;
    align-items:center;
    gap:6px;
  }

  .today-tl-legend-dir{
    font-size:.42rem;
    font-weight:700;
    color:rgba(43,34,244,.40);
    letter-spacing:.08em;
  }

  .today-tl-legend-dot{
    width:10px;
    height:10px;
    border-radius:50%;
  }

  .today-tl-legend-moon{
    width:14px;
    height:14px;
    border-radius:50%;
    background:linear-gradient(135deg, #f5f5f5 0%, #ccc 100%);
    box-shadow:inset -1px -1px 3px rgba(0,0,0,.12);
  }

  .today-tl-kp-scale{
    display:flex;
    align-items:center;
    gap:2px;
  }

  .today-tl-kp-scale span{
    font-size:.56rem;
    font-weight:700;
    color:rgba(43,34,244,.50);
    margin:0 3px;
  }

  .today-tl-kp-box{
    width:10px;
    height:10px;
    border-radius:2px;
  }

  /* Mobile responsive for TODAY Timeline */
  @media (max-width: 768px) {
    .today-timeline-card {
      padding: 10px;
      border-radius: 16px;
    }
    
    .today-tl-header {
      flex-direction: column;
      gap: 8px;
      padding-bottom: 8px;
      margin-bottom: 8px;
    }
    
    .today-tl-meta {
      gap: 8px 12px;
    }
    
    .today-tl-meta .meta-key {
      font-size: .44rem;
    }
    
    .today-tl-meta .meta-val {
      font-size: .62rem;
    }
    
    .today-tl-stats {
      gap: 12px;
    }
    
    .today-tl-stat .stat-label {
      font-size: .42rem;
    }
    
    .today-tl-stat .stat-value {
      font-size: .58rem;
    }
    
    .today-tl-sky-bar {
      min-height: 110px;
    }
    
    .today-tl-weather-time {
      font-size: .48rem;
    }
    
    .today-tl-weather-icon {
      font-size: 14px;
    }
    
    .today-tl-weather-temp {
      font-size: .58rem;
    }
    
    .today-tl-weather-precip {
      font-size: .38rem;
    }
    
    .today-tl-planet-tracks {
      margin-left: 20px;
    }
    
    .today-tl-weather-row {
      margin-left: 20px;
    }
    
    .today-tl-legend {
      gap: 5px;
    }
    
    .today-tl-legend-item {
      padding: 2px 5px;
      font-size: .46rem;
    }
  }

  @media (max-width: 480px) {
    .today-tl-sky-bar {
      min-height: 95px;
    }
  }

  /* =========================
     Sun Timeline (Combined hourly + sun events)
     ========================= */
  .sun-timeline{
    position:relative;
    margin-top:10px;
    background:var(--paper);
    border:none;
    border-radius:18px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px) saturate(125%);
    -webkit-backdrop-filter:blur(18px) saturate(125%);
    padding:14px;
    min-height:180px;
  }

  .sun-timeline-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    flex-wrap:wrap;
    gap:8px;
    padding-bottom:8px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:10px;
  }

  .sun-timeline-title{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .sun-timeline-title .sun-label-text{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.74);
    font-weight:900;
  }

  .sun-timeline-meta{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }

  .meta-item{
    display:flex;
    align-items:baseline;
    gap:6px;
  }

  .meta-key{
    font-size:.52rem;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:rgba(43,34,244,.60);
    font-weight:700;
  }

  .meta-val{
    font-size:.72rem;
    font-weight:750;
    color:var(--ink);
  }

  /* Main timeline bar container */
  .sun-timeline-bar{
    position:relative;
    height:90px;
    background:rgba(43,34,244,.04);
    border-radius:14px;
  }

  /* Colored bands (golden/blue hour) */
  .tl-bands{
    position:absolute;
    inset:0;
    border-radius:14px;
    overflow:hidden;
    pointer-events:none;
  }

  .tl-band{
    position:absolute;
    top:0;
    bottom:0;
    pointer-events:none;
  }

  .tl-band.night{
    background:linear-gradient(180deg, 
      rgba(10,10,35,.85) 0%, 
      rgba(15,20,50,.75) 50%,
      rgba(20,25,60,.65) 100%);
  }

  .tl-band.astro{
    background:linear-gradient(180deg, 
      rgba(25,30,80,.70) 0%, 
      rgba(40,50,120,.55) 50%,
      rgba(60,70,140,.40) 100%);
  }

  .tl-band.blue{
    background:linear-gradient(180deg, 
      rgba(80,100,180,.65) 0%, 
      rgba(100,130,200,.50) 50%,
      rgba(140,170,220,.35) 100%);
  }

  .tl-band.golden{
    background:linear-gradient(180deg, 
      rgba(255,140,50,.75) 0%, 
      rgba(255,170,80,.60) 50%,
      rgba(255,200,120,.45) 100%);
  }

  .tl-band.golden-peak{
    background:linear-gradient(180deg, 
      rgba(255,100,30,.85) 0%, 
      rgba(255,130,50,.75) 50%,
      rgba(255,160,80,.60) 100%);
  }

  .tl-band.day{
    background:linear-gradient(180deg, 
      rgba(135,206,250,.30) 0%, 
      rgba(176,224,255,.20) 50%,
      rgba(200,235,255,.15) 100%);
  }

  /* Hour markers */
  .tl-hours{
    position:absolute;
    inset:0;
    display:flex;
    pointer-events:none;
    overflow:hidden;
  }

  .tl-hour{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-end;
    padding-bottom:6px;
    border-left:1px solid rgba(43,34,244,.08);
    min-width:0;
  }

  .tl-hour:first-child{
    border-left:none;
  }

  .tl-hour-time{
    font-size:.58rem;
    font-weight:800;
    color:rgba(43,34,244,.50);
    letter-spacing:.02em;
    margin-bottom:2px;
    transition:color .2s ease;
  }

  .tl-hour-icon{
    width:32px;
    height:32px;
    object-fit:contain;
    margin-bottom:1px;
  }

  .tl-hour-temp{
    font-size:.82rem;
    font-weight:850;
    color:var(--ink);
    transition:color .2s ease, text-shadow .2s ease;
  }

  .tl-hour-precip{
    font-size:.62rem;
    font-weight:700;
    margin-top:1px;
    transition:color .2s ease;
  }

  .tl-hour-precip.low{
    color:rgba(255,255,255,.5);
  }

  .tl-hour-precip.med{
    color:rgba(70,130,220,1);
    font-weight:800;
  }

  .tl-hour-precip.high{
    color:rgba(30,100,220,1);
    font-weight:900;
    text-shadow:0 0 6px rgba(50,120,240,.40);
  }

  /* Light text for dark backgrounds (night hours) */
  .tl-hour.night-hour .tl-hour-time{
    color:rgba(180,190,220,.70);
  }

  .tl-hour.night-hour .tl-hour-temp{
    color:rgba(230,235,255,.95);
    text-shadow:0 0 8px rgba(0,0,0,.50);
  }

  .tl-hour.night-hour .tl-hour-precip.low{
    color:rgba(150,170,210,.60);
  }

  .tl-hour.night-hour .tl-hour-precip.med{
    color:rgba(130,180,255,.90);
  }

  .tl-hour.night-hour .tl-hour-precip.high{
    color:rgba(100,170,255,1);
    text-shadow:0 0 6px rgba(80,150,255,.50);
  }

  /* Sun event ticks */
  .tl-events{
    position:absolute;
    inset:0;
    pointer-events:none;
  }

  .tl-event-tick{
    position:absolute;
    top:0;
    bottom:0;
    width:2px;
    transform:translateX(-50%);
    border-radius:2px;
  }

  .tl-event-tick.sunrise,
  .tl-event-tick.sunset{
    background:linear-gradient(180deg, rgba(255,120,30,1), rgba(255,180,60,1));
    box-shadow:0 0 16px rgba(255,140,40,.70), 0 0 30px rgba(255,100,20,.40);
  }

  .tl-event-tick.noon{
    background:linear-gradient(180deg, rgba(255,220,80,1), rgba(255,240,150,1));
    box-shadow:0 0 14px rgba(255,220,100,.60), 0 0 25px rgba(255,200,50,.35);
  }

  .tl-event-tick.golden{
    background:linear-gradient(180deg, rgba(255,140,30,1), rgba(255,180,70,1));
    box-shadow:0 0 12px rgba(255,150,50,.55), 0 0 20px rgba(255,120,30,.30);
  }

  .tl-event-tick.blue{
    background:linear-gradient(180deg, rgba(80,100,200,1), rgba(130,150,230,1));
    box-shadow:0 0 12px rgba(100,120,220,.55), 0 0 20px rgba(80,100,200,.30);
  }

  .tl-event-tick.astro{
    background:linear-gradient(180deg, rgba(40,50,100,1), rgba(70,80,140,1));
    box-shadow:0 0 10px rgba(50,60,120,.50), 0 0 18px rgba(30,40,90,.30);
  }

  /* NOW marker */
  .tl-now{
    position:absolute;
    top:-6px;
    bottom:-6px;
    width:3px;
    transform:translateX(-50%);
    z-index:10;
    pointer-events:none;
  }

  .tl-now-line{
    position:absolute;
    inset:0;
    background:var(--ink);
    border-radius:3px;
    box-shadow:0 0 14px rgba(43,34,244,.40);
  }

  .tl-now-bubble{
    position:absolute;
    bottom:-32px;
    left:50%;
    transform:translateX(-50%);
    background:var(--ink);
    color:#fff;
    padding:5px 9px;
    border-radius:10px;
    display:flex;
    flex-direction:column-reverse;
    align-items:center;
    gap:1px;
    box-shadow:0 -4px 16px rgba(43,34,244,.35);
  }

  .tl-now-temp{
    font-size:.78rem;
    font-weight:900;
  }

  .tl-now-label{
    font-size:.44rem;
    font-weight:800;
    letter-spacing:.12em;
    opacity:.75;
  }

  /* Event labels below bar */
  .tl-event-labels{
    display:none;
  }

  .tl-event-label{
    position:absolute;
    transform:translateX(-50%);
    font-size:.54rem;
    font-weight:500;
    letter-spacing:.08em;
    text-transform:uppercase;
    white-space:nowrap;
    color:var(--ink-dim);
  }

  .tl-event-label.level-1{ top:16px; }
  .tl-event-label.level-2{ top:12px; }
  .tl-event-label.level-3{ top:8px; }
  .tl-event-label.level-4{ top:4px; }
  .tl-event-label.level-5{ top:0px; }

  .tl-event-label.sunrise,
  .tl-event-label.sunset{
    color:rgba(230,100,20,1);
    text-shadow:0 0 8px rgba(255,140,50,.35);
  }

  .tl-event-label.golden{
    color:rgba(220,120,20,1);
    text-shadow:0 0 6px rgba(255,150,50,.30);
  }

  .tl-event-label.blue{
    color:rgba(70,90,180,1);
    text-shadow:0 0 6px rgba(100,130,220,.25);
  }

  .tl-event-label.astro{
    color:rgba(50,60,120,1);
    text-shadow:0 0 5px rgba(60,70,140,.20);
  }

  .tl-event-label.noon{
    color:rgba(210,160,30,1);
    text-shadow:0 0 8px rgba(255,200,50,.30);
  }

  /* Responsive */
  @media (max-width:900px){
    .sun-timeline-bar{
      height:80px;
    }
    .tl-hour-time{
      font-size:.44rem;
    }
    .tl-hour-icon{
      width:20px;
      height:20px;
    }
    .tl-hour-temp{
      font-size:.60rem;
    }
    .tl-hour-precip{
      font-size:.48rem;
    }
  }

  @media (max-width:600px){
    .sun-timeline-header{
      flex-direction:column;
      align-items:flex-start;
    }
    .tl-hour:nth-child(odd) .tl-hour-time{
      visibility:hidden;
    }
  }

  /* =========================
     7-day (horizontal chips inside main card)
     ========================= */
  .forecast7-section{
    margin-top:12px;
    background:var(--paper-soft);
    border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    padding:10px;
  }

  .forecast7-top{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:10px;
    padding-bottom:6px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:10px;
  }

  .forecast7-label{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:850;
  }

  .forecast7-chips{
    display:flex;
    gap:8px;
    padding-bottom:4px;
    overflow-x:auto;
    overflow-y:hidden;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  .forecast7-chips::-webkit-scrollbar{
    display:none;
  }

  .forecast7-chip{
    flex:1 0 0%;
    min-width:80px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:2px;
    padding:4px 8px 8px 8px;
    border-radius:14px;
    background:rgba(255,255,255,.06);
    box-shadow:0 0 30px rgba(255,255,255,.10), inset 0 0 20px rgba(255,255,255,.18);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
  }

  .forecast7-chip .day{
    font-size:.74rem;
    font-weight:850;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:var(--ink-dim);
  }

  .forecast7-chip .forecast7-date{
    font-size:.64rem;
    font-weight:600;
    color:rgba(100,100,140,.8);
    margin-top:-2px;
  }

  .forecast7-chip .icon{
    width:52px;
    height:52px;
    object-fit:contain;
  }

  .forecast7-chip .temps{
    font-size:.85rem;
    font-weight:800;
    color:var(--ink);
    text-transform:uppercase;
  }

  .forecast7-bar-wrap{
    width:100%;
    height:7px;
    background:rgba(43,34,244,.08);
    border-radius:3px;
    position:relative;
    margin:2px 0;
  }

  .forecast7-bar{
    position:absolute;
    top:0;
    height:100%;
    border-radius:3px;
    transition:width .3s ease, left .3s ease;
    box-shadow:0 0 6px rgba(255,255,255,.15);
  }

  .forecast7-chip .forecast7-bar-block{
    width:100%;
    display:flex;
    flex-direction:column;
    overflow:visible;
  }
  .forecast7-chip .bar-hi{
    display:flex;
    align-items:baseline;
    justify-content:flex-end;
    gap:3px;
    white-space:nowrap;
    overflow:visible;
  }
  .forecast7-chip .bar-lo{
    display:flex;
    align-items:baseline;
    justify-content:flex-start;
    gap:3px;
    white-space:nowrap;
    overflow:visible;
  }
  .forecast7-chip .bar-lo .forecast7-lo{
    font-size:.85rem;
    font-weight:700;
    color:var(--ink);
  }
  .forecast7-chip .feels-hi,
  .forecast7-chip .feels-lo{
    font-size:.5rem;
    font-weight:400;
    color:var(--ink-dim);
    letter-spacing:.02em;
    white-space:nowrap;
  }
  .forecast7-chip .forecast7-lo{
    font-size:.68rem;
    font-weight:600;
    color:var(--ink-dim);
  }

  .forecast7-chip .precip{
    font-size:.65rem;
    font-weight:700;
    color:rgba(70,130,220,.90);
    text-transform:uppercase;
    text-align:center;
  }

  .forecast7-chip .forecast7-wind{
    font-size:.60rem;
    font-weight:600;
    color:var(--ink-dim);
    margin-top:2px;
    text-align:center;
  }

  .forecast7-chip .forecast7-accum{
    font-size:.60rem;
    font-weight:700;
    color:var(--ink);
    margin-top:2px;
    text-align:center;
  }
  .forecast7-chip .forecast7-precip{
    font-size:.60rem;
    font-weight:700;
    color:rgba(70,150,255,.95);
    margin-top:4px;
    text-align:center;
    letter-spacing:.02em;
  }
  .forecast7-chip .forecast7-uv{
    font-size:.55rem;
    font-weight:600;
    margin-top:2px;
    text-align:center;
  }
  .forecast7-chip .forecast7-uv.uv-low{ color:rgba(120,180,120,.95); }
  .forecast7-chip .forecast7-uv.uv-mod{ color:rgba(200,170,60,.95); }
  .forecast7-chip .forecast7-uv.uv-high{ color:rgba(240,130,40,.95); }
  .forecast7-chip .forecast7-uv.uv-vhigh{ color:rgba(230,60,60,.95); }
  .forecast7-chip .forecast7-uv.uv-extreme{ color:rgba(180,50,200,.95); }

  @media (max-width:600px){
    .forecast7-chips{
      gap:6px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      scroll-snap-type:x mandatory;
      padding-bottom:6px;
    }
    .forecast7-chip{
      min-width:72px;
      flex:0 0 auto;
      padding:8px 6px;
      scroll-snap-align:start;
    }
    .forecast7-chip .icon{
    width:90px;
    height:90px;
    margin:-10px 0 -10px 0;
    margin:0;
    padding:0;
    }
    .forecast7-chip .temps{
      font-size:.78rem;
    }
    .forecast7-chip .feels-hi{
    font-size:.55rem;
    font-weight:600;
    color:var(--ink-dim);
  }
  .forecast7-chip .forecast7-lo{
      font-size:.62rem;
    }
    .forecast7-chip .forecast7-wind{
      font-size:.55rem;
    }
    .forecast7-chip .forecast7-accum{
      font-size:.55rem;
    }
  }

  /* =========================
     Astro / Space events / Night sky
     ========================= */
  .astro-row{margin-top:12px}
  .astro-pill{
    background:var(--paper);
  	border:none;
    border-radius:18px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px);
    -webkit-backdrop-filter:blur(18px);
    padding:10px;
  }

  .moon-sky{display:block}
  .moon-sky-main{display:flex;flex-direction:column;gap:10px}

  .skygrid{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }

  .skcard{
  	background: rgba(255,255,255,.06);
  	border:none;
    border-radius:16px;
    box-shadow:var(--glow-soft);
    padding:10px;
  }
  .skk{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:850;
  }
  .skv{
    margin-top:8px;
    font-size:1.0rem;
    font-weight:900;
    color:var(--ink);
  }

  .bullets{margin-top:6px;display:flex;flex-direction:column;gap:5px}
  .bullet{
  background: rgba(255,255,255,.06);
  border: none;
  border-radius:12px;
  padding:6px 10px;

  box-shadow:
    0 0 56px rgba(255,255,255,.14),
    inset 0 0 34px rgba(255,255,255,.28);

  backdrop-filter: blur(26px) saturate(118%);
  -webkit-backdrop-filter: blur(26px) saturate(118%);
}

  .btop{
  display:flex;
  align-items:baseline;
  gap:10px;
}
.bname{
  flex:1 1 auto;
  min-width:0;

  font-size:.56rem;          /* smaller category titles */
  font-weight:520;           /* explicitly NOT bold */
  letter-spacing:.18em;
  text-transform:uppercase;

  color:var(--ink);
}



.btime{
  flex:0 0 auto;
  min-width:72px;
  text-align:right;
  font-weight:650;
  color:var(--ink-dim);
  white-space:nowrap;
  font-size:.74rem;
  text-transform:uppercase;
  letter-spacing:.06em;
}

  .bsub{margin-top:2px;color:var(--ink-dim);font-size:.74rem;font-weight:650;text-transform:uppercase;letter-spacing:.04em}

  .nightsky{
    margin-top:10px;
    background:var(--paper);
  	border:none;
    border-radius:18px;
    box-shadow:var(--glow-mid);
    backdrop-filter:blur(18px) saturate(125%);
    -webkit-backdrop-filter:blur(18px) saturate(125%);
    padding:14px;
  }
  .nightsky-top{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:10px;
    padding-bottom:8px;
    border-bottom:1px solid rgba(43,34,244,.10);
    margin-bottom:10px;
  }
  .nightsky-top .k{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:850;
  }
  .nightsky-top .v{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.70);
    font-weight:850;
  }
  .nightsky-svgwrap{
    width:100%;
    height:170px;
    border-radius:14px;
    background:rgba(43,34,244,.06);
    border:none;
  }
  #night-sky-svg{width:100%;height:100%}

  .nightsky-legend{
    margin-top:10px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  .nightsky-item{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;

  background: rgba(255,255,255,.06);
  border: none;
  box-shadow:
    0 0 46px rgba(255,255,255,.12),
    inset 0 0 26px rgba(255,255,255,.24);

  backdrop-filter: blur(22px) saturate(118%);
  -webkit-backdrop-filter: blur(22px) saturate(118%);

  color:var(--ink);
  font-weight:500;
  font-size:.68rem;
  letter-spacing:.12em;
  text-transform:uppercase;
}

  .nightsky-dot{
    width:10px;height:10px;border-radius:50%;
    box-shadow:0 0 14px rgba(255,255,255,.35);
  }

  /* =========================
     Widgets (cards)
     ========================= */
  .widgets-row,
  .widgets-row-two{
    margin-top:10px;
    display:grid;
    gap:10px;
  }
  .widgets-row{grid-template-columns:repeat(3,1fr)}
  .widgets-row-two{grid-template-columns:repeat(2,1fr)}

  @media (max-width:980px){
    .widgets-row,
    .widgets-row-two{grid-template-columns:1fr}
  }

  .widget{
  	background: rgba(255,255,255,.06);
  	border:none;
    border-radius:18px;
    box-shadow:var(--glow-soft);
    backdrop-filter:blur(16px);
    -webkit-backdrop-filter:blur(16px);
    min-width:0;
  }

  .widget-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 12px;
  	background: rgba(255,255,255,.06);
    border-bottom:1px solid rgba(43,34,244,.12);
  }

  .widget-title{
    font-size:.60rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.74);
    font-weight:850;
  }
  /* Small LIVE tag inside widget title */
.widget-title .live-tag{
  font-size:.56rem;
  letter-spacing:.16em;
  font-weight:850;
  color:rgba(43,34,244,.64);
  margin-left:6px;
  white-space:nowrap;
}


  .widget-sub{
    font-size:.72rem;
    color:var(--ink-dim);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:60%;
    text-align:right;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.06em;
    transition: opacity .15s ease;
  }
  
  a.widget-sub:hover{
    opacity: 0.6;
  }

  .widget-body{
    position:relative;
    aspect-ratio:16/10;
  	background: rgba(255,255,255,.06);
  }

  /* Allow popups to overflow map widget containers */
  .map-widget .widget-body {
    overflow: visible !important;
  }
  
  .map-widget {
    overflow: visible !important;
  }
  
  /* Ensure Leaflet popups appear on top and escape clipping */
  .leaflet-popup-pane {
    z-index: 9999 !important;
  }
  
  .leaflet-pane {
    z-index: 400 !important;
  }
  
  .leaflet-top,
  .leaflet-bottom {
    z-index: 1000 !important;
  }
  
  .quake-geo-popup {
    z-index: 9999 !important;
  }
  
  .quake-geo-popup .leaflet-popup-content-wrapper {
    z-index: 9999 !important;
  }
  
  /* Status pill should not block popup */
  .quake-status-wrap {
    z-index: 800 !important;
  }

  /* Clean earthquake markers */
  .quake-marker-pulse {
    filter: none;
  }

  .widget-body img,
  .widget-body iframe{
    width:100%;
    height:100%;
    object-fit:cover;
    border:none;
    display:block;
  }

  /* Fix Leaflet tile seams */
  .leaflet-tile-container img {
    outline: none !important;
    border: none !important;
  }
  .leaflet-container {
    background: #f5f5f5 !important;
  }
  .leaflet-tile {
    filter: none !important;
    image-rendering: auto !important;
  }

  .badge{
    display:none;
  }

  /* Mini solar pills (Aurora + GOES overlays) */
  .mini-solar{
    position:absolute;
    top:10px;left:10px;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    z-index:3;
    pointer-events:none;
  }
  .mini-pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.46);
  	border:none;
    box-shadow:0 0 18px rgba(43,34,244,.10), inset 0 0 16px rgba(255,255,255,.28);
    backdrop-filter:blur(12px);
    -webkit-backdrop-filter:blur(12px);
    color:var(--ink);
    font-weight:900;
    font-size:.74rem;
  }
  .mini-key{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:950;
  }
  .mini-val{color:var(--ink);font-weight:950}

  /* Preserve true-black widget bodies */
  #aurora-body,
  #aurora-canvas,
  #aurora-img-fallback{
    background:#000 !important;
  }
  .widget-body[style*="background:#000"]{
    background:#000 !important;
  }

  /* Canvas + fallback sizing */
  #aurora-canvas,
  #aurora-img-fallback{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }

  /* =========================
     Audio section
     ========================= */
  .audio-section{
    background:var(--paper-strong);
  	border:none;
    border-radius:22px;
    padding:14px;
    box-shadow:var(--glow-main);
    backdrop-filter:blur(22px) saturate(130%);
    -webkit-backdrop-filter:blur(22px) saturate(130%);
  }

  .audio-header-title{
    font-size:.78rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.74);
    font-weight:900;
  }
  .audio-sub{
    margin-top:6px;
    font-size:.86rem;
    color:var(--ink-dim);
    font-weight:650;
    text-transform:uppercase;
    letter-spacing:.06em;
  }

  .play-all{
    margin-top:10px;
    padding:8px 14px;
    border-radius:999px;
  	border:none;
    background:rgba(255,255,255,.46);
    color:var(--ink);
    cursor:pointer;
    font-size:.74rem;
    font-weight:950;
    letter-spacing:.16em;
    text-transform:uppercase;
    box-shadow:0 0 26px rgba(43,34,244,.14), inset 0 0 18px rgba(255,255,255,.26);
  }
  .play-all:hover{
    box-shadow:0 0 34px rgba(43,34,244,.18), inset 0 0 22px rgba(255,255,255,.30);
  }

  /* Spectrum bars (so your audio block doesn't look broken) */
  .spectrum{
    margin-top:12px;
    height:22px;
    display:flex;
    align-items:flex-end;
    gap:6px;
  }
  .spectrum-bar{
    width:10px;
    height:8px;
    border-radius:6px;
    background:rgba(43,34,244,.22);
  	border:none;
    box-shadow:0 0 16px rgba(43,34,244,.10), inset 0 0 12px rgba(255,255,255,.22);
    transition:height .18s ease;
  }
  .spectrum.playing .spectrum-bar:nth-child(1){height:18px}
  .spectrum.playing .spectrum-bar:nth-child(2){height:12px}
  .spectrum.playing .spectrum-bar:nth-child(3){height:20px}
  .spectrum.playing .spectrum-bar:nth-child(4){height:14px}
  .spectrum.playing .spectrum-bar:nth-child(5){height:17px}

  .channels{margin-top:12px;display:flex;flex-direction:column;gap:10px}
  .channel{
    background:var(--paper-soft);
  	border:none;
    border-radius:16px;
    padding:10px;
    box-shadow:var(--glow-soft);
  }
  .channel-name{
    font-size:.62rem;
    letter-spacing:.14em;
    text-transform:uppercase;
    color:rgba(43,34,244,.72);
    font-weight:900;
  }
  #a-status{margin-top:6px;color:var(--ink-dim);font-weight:700;font-size:.86rem;text-transform:uppercase;letter-spacing:.06em}
  .slider-row{margin-top:10px}
  input[type="range"]{width:100%}

  #cloud-soundscape-root,
  #cloud-soundscape-root main,
  .panel,
  .content-stack,
  .weather-card{
    background:none !important;
    box-shadow:none !important;
    border:none !important;
    outline:none !important;
  }

  /* Removed transform properties that break position:fixed on modals */

  .sun-timeline,
  .nightsky,
  .widget,
  .forecast7-section,
  .audio-section,
  .bullet,
  .nightsky-item,
  .forecast7-chip{
    -webkit-mask-image: -webkit-radial-gradient(white, black);
    mask-image: radial-gradient(white, black);
    isolation: isolate;
  }

  /* =========================
     MOBILE RESPONSIVE STYLES
     ========================= */
  
  /* Tablet breakpoint */
  @media (max-width: 1024px) {
    .widgets-row {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .weather-alerts-block {
      position: relative;
      top: auto;
      left: auto;
      right: auto;
      margin-top: 12px;
      padding-right: 0;
    }
    
    .weather-top-row {
      padding-right: 120px;
    }
    
    .weather-moon-block .moon-img {
      width: 200px;
      height: 200px;
    }
  }

  /* Mobile breakpoint */
  @media (max-width: 768px) {
    #cloud-soundscape-root main {
      padding: 10px;
      overflow-x: hidden;
    }
    
    .panel {
      gap: 8px;
      overflow: visible;
    }
    
    .content-stack {
      gap: 8px;
      overflow: visible;
    }

    /* Main weather card mobile */
    .left-now {
      padding: 12px;
      border-radius: 16px;
    }
    
    .weather-top-row {
      flex-direction: column;
      align-items: center;
      padding-right: 0;
      min-height: auto;
      gap: 8px;
    }
    
    .weather-left-stack {
      width: 100%;
      align-items: center;
    }
    
    .weather-main {
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 12px;
      width: 100%;
    }
    
    .weather-temp-block .temp {
      font-size: 2.6rem;
    }
    
    .weather-temp-block .feels {
      font-size: 0.82rem;
    }
    
    .weather-cond-block .cond-icon-img {
      width: 70px;
      height: 70px;
    }
    
    /* Moon repositioned for mobile */
    .weather-moon-block {
      position: relative;
      top: auto;
      right: auto;
      width: 100%;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      margin-top: 8px;
      border-top: 1px solid rgba(43,34,244,.10);
    }
    
    .weather-moon-block .moon-img {
      width: 80px;
      height: 80px;
      transform: scale(1.19);
    }
    
    .weather-moon-block .moon-text {
      margin-top: 0;
      text-align: left;
    }
    
    /* Alerts mobile */
    .weather-alerts-block {
      position: relative;
      top: auto;
      left: auto;
      right: auto;
      width: 100%;
      align-items: stretch;
      margin-top: 8px;
    }
    
    .weather-alert {
      max-width: 100%;
    }
    
    /* Details rows mobile */
    .weather-details-row {
      margin-top: 10px;
      padding-top: 10px;
    }
    
    .weather-hilo {
      font-size: 0.78rem;
      margin-bottom: 10px;
    }
    
    .weather-stats-grid {
      gap: 4px 10px;
    }
    
    .weather-stat .k {
      font-size: 0.58rem;
    }
    
    .weather-stat .v {
      font-size: 0.62rem;
    }
    
    /* 7-day forecast mobile */
    .forecast7-section {
      padding: 10px;
      border-radius: 14px;
    }
    
    .forecast7-chips {
      gap: 6px;
      padding-bottom: 6px;
      margin: 0;
      padding-left: 0;
      padding-right: 0;
      flex-wrap: nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
    }
    
    .forecast7-chip {
      min-width: 72px;
      flex: 0 0 auto;
      padding: 6px 4px;
      border-radius: 12px;
    }
    
    .forecast7-chip .day {
      font-size: 0.58rem;
    }
    
    .forecast7-chip .icon {
      width: 34px;
      height: 34px;
    }
    
    .forecast7-chip .temps {
      font-size: 0.66rem;
    }
    
    .forecast7-chip .precip {
      font-size: 0.54rem;
    }

    /* Timeline mobile */
    .sun-timeline {
      padding: 10px;
      border-radius: 14px;
      min-height: 140px;
    }
    
    .sun-timeline-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      padding-bottom: 6px;
      margin-bottom: 8px;
    }
    
    .sun-timeline-meta {
      flex-wrap: wrap;
      gap: 8px 12px;
    }
    
    .meta-item {
      gap: 4px;
    }
    
    .meta-key {
      font-size: 0.48rem;
    }
    
    .meta-val {
      font-size: 0.66rem;
    }
    
    .sun-timeline-bar {
      height: 75px;
      min-width: 0;
      width: 100%;
    }
    
    .tl-hour-time {
      font-size: 0.38rem;
    }
    
    .tl-hour-icon {
      width: 14px;
      height: 14px;
    }
    
    .tl-hour-temp {
      font-size: 0.48rem;
    }
    
    .tl-hour-precip {
      font-size: 0.38rem;
    }
    
    .tl-now-bubble {
      bottom: -28px;
      padding: 4px 7px;
      border-radius: 8px;
    }
    
    .tl-now-temp {
      font-size: 0.68rem;
    }
    
    .tl-now-label {
      font-size: 0.40rem;
    }

    /* Night sky mobile */
    .nightsky {
      padding: 10px;
      border-radius: 14px;
    }
    
    .nightsky-top {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      padding-bottom: 6px;
      margin-bottom: 8px;
    }
    
    .nightsky-top .k,
    .nightsky-top .v {
      font-size: 0.54rem;
    }
    
    .nightsky-svgwrap {
      height: 140px;
    }
    
    #night-sky-svg {
      min-width: 0;
      width: 100%;
    }
    
    .nightsky-legend {
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .nightsky-item {
      padding: 4px 8px;
      font-size: 0.60rem;
      gap: 6px;
    }
    
    .nightsky-dot {
      width: 8px;
      height: 8px;
    }
    
    /* Space events mobile */
    .skygrid {
      gap: 8px;
    }
    
    .skcard {
      padding: 8px;
      border-radius: 12px;
    }
    
    .skk {
      font-size: 0.54rem;
    }
    
    .skv {
      font-size: 0.88rem;
    }
    
    .bullets {
      gap: 4px;
    }
    
    .bullet {
      padding: 6px 8px;
      border-radius: 10px;
    }
    
    .bname {
      font-size: 0.52rem;
    }
    
    .btime {
      font-size: 0.66rem;
      min-width: 60px;
    }
    
    .bsub {
      font-size: 0.66rem;
      margin-top: 2px;
    }

    /* Widget grids mobile */
    .widgets-row,
    .widgets-row-two {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    .widget {
      border-radius: 14px;
    }
    
    .widget-head {
      padding: 8px 10px;
    }
    
    .widget-title {
      font-size: 0.54rem;
      letter-spacing: 0.10em;
    }
    
    .widget-title .live-tag {
      font-size: 0.50rem;
    }
    
    .widget-sub {
      font-size: 0.64rem;
      max-width: 50%;
    }
    
    .widget-body {
      aspect-ratio: 16/9;
      min-height: 200px;
      overflow: hidden;
    }
    
    /* Mini pills on widgets mobile */
    .mini-solar {
      top: 6px;
      left: 6px;
      gap: 4px;
    }
    
    .mini-pill {
      padding: 4px 8px;
      gap: 4px;
      font-size: 0.66rem;
    }
    
    .mini-key {
      font-size: 0.56rem;
    }

    /* Location dropdown mobile */
    .loc-name {
      font-size: 1.0rem;
    }
    
    .loc-meta {
      font-size: 0.74rem;
    }
    
    .loc-cycler {
      gap: 0;
    }

    .loc-arrow {
      width: 20px;
      height: 20px;
      opacity: .5;
      min-height: 32px;
    }

    .loc-cycler-center {
      width: 220px;
    }

    /* Hazard map status pills mobile */
    #lightning-status-pill,
    #fire-status-pill,
    #quake-status-pill {
      font-size: 0.60rem;
      padding: 5px 10px;
    }
    
    #glm-toggle-btn {
      font-size: 0.54rem;
      padding: 4px 8px;
    }

    /* Audio section mobile */
    .audio-section {
      padding: 12px;
      border-radius: 16px;
    }
    
    .audio-header-title {
      font-size: 0.70rem;
    }
    
    .audio-sub {
      font-size: 0.78rem;
    }
    
    .play-all {
      padding: 10px 16px;
      font-size: 0.68rem;
    }
    
    .channel {
      padding: 10px;
      border-radius: 12px;
    }
    
    .channel-name {
      font-size: 0.58rem;
    }
  }

  /* Small mobile breakpoint */
  @media (max-width: 480px) {
    #cloud-soundscape-root main {
      padding: 8px;
    }
    
    .left-now {
      padding: 10px;
    }
    
    .weather-temp-block .temp {
      font-size: 2.2rem;
    }
    
    .weather-cond-block .cond-icon-img {
      width: 56px;
      height: 56px;
    }
    
    .weather-moon-block .moon-img {
      width: 65px;
      height: 65px;
    }
    
    .weather-stats-grid {
      gap: 3px 8px;
    }
    
    .weather-stat .k {
      font-size: 0.52rem;
    }
    
    .weather-stat .v {
      font-size: 0.56rem;
    }
    
    .forecast7-chip {
      min-width: 0;
      flex: 1;
      padding: 4px 2px;
    }
    
    .forecast7-chip .icon {
      width: 28px;
      height: 28px;
    }
    
    .forecast7-chip .temps {
      font-size: 0.60rem;
    }
    
    .sun-timeline-bar {
      height: 68px;
    }
    
    .widget-body {
      aspect-ratio: 4/3;
      min-height: 180px;
      overflow: hidden;
    }
    
    .nightsky-svgwrap {
      height: 120px;
    }
    
    #night-sky-svg {
      min-width: 0;
      width: 100%;
    }
    
    .bsub {
      font-size: 0.60rem;
      line-height: 1.3;
    }
  }

  /* Touch-friendly tap targets */
  @media (hover: none) and (pointer: coarse) {
    .loc-arrow {
      min-height: 32px;
      min-width: 32px;
    }
    
    .forecast7-chip {
      min-width: 68px;
    }
    
    .nightsky-item {
      min-height: 36px;
    }
    
    .quake-item,
    .fire-item {
      min-height: 44px;
    }
    
    .play-all {
      min-height: 48px;
    }
    
    }

  /* Landscape mobile */
  @media (max-width: 900px) and (orientation: landscape) {
    .weather-top-row {
      flex-direction: row;
      flex-wrap: wrap;
      padding-right: 100px;
    }
    
    .weather-moon-block {
      position: absolute;
      top: 0;
      right: 10px;
      width: auto;
      flex-direction: column;
      border-top: none;
      padding: 0;
      margin-top: 0;
    }
    
    .weather-moon-block .moon-img {
      width: 90px;
      height: 90px;
    }
    
    .widgets-row,
    .widgets-row-two {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .widget-body {
      aspect-ratio: 16/10;
    }
  }

  /* Safe area insets for notched devices */
  @supports (padding: max(0px)) {
    #cloud-soundscape-root main {
      padding-left: max(10px, env(safe-area-inset-left));
      padding-right: max(10px, env(safe-area-inset-right));
      padding-bottom: max(18px, env(safe-area-inset-bottom));
    }
  }

  /* Fix mobile scroll */
  @media (max-width: 768px) {
    .left-now {
      overflow: hidden !important;
    }
    
    .forecast7-section {
      overflow: hidden !important;
    }
    
    .forecast7-chips {
      overflow: hidden !important;
    }
  }

/* =========================================================
     UNIFIED WIDGET POPUP MODAL SYSTEM
     ========================================================= */
  .alert-modal-overlay{position:absolute;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);z-index:99999;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;opacity:0;visibility:hidden;transition:opacity 0.3s ease,visibility 0.3s ease;overflow:auto;}
.alert-modal-overlay.active{opacity:1;visibility:visible;}
.alert-modal-content{position:relative;background:linear-gradient(145deg,rgba(30,30,35,0.98),rgba(20,20,25,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:16px;max-width:600px;width:90vw;max-height:85vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.7);transform:scale(0.92);transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1);}
.alert-modal-overlay.active .alert-modal-content{transform:scale(1);}
.alert-modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.2);}
.alert-modal-title-wrap{display:flex;align-items:center;gap:12px;}
.alert-modal-icon{font-size:24px;}
.alert-modal-title{font-size:18px;font-weight:600;color:#fff;letter-spacing:0.5px;}
.alert-modal-close{background:none;border:none;color:#888;font-size:28px;cursor:pointer;padding:0 8px;line-height:1;transition:color 0.2s;}
.alert-modal-close:hover{color:#fff;}
.alert-modal-body{padding:24px;overflow-y:auto;flex:1;color:#e0e0e0;font-size:14px;line-height:1.6;}
.alert-detail-section{margin-bottom:20px;}
.alert-detail-section:last-child{margin-bottom:0;}
.alert-detail-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;font-weight:500;}
.alert-detail-value{color:#fff;}
.alert-detail-value.warning{color:#f87171;}
.alert-detail-value.watch{color:#fb923c;}
.alert-detail-value.advisory{color:#facc15;}
.alert-timing{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:20px;}
.alert-timing-item{text-align:center;}
.alert-timing-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:4px;}
.alert-timing-value{font-size:14px;color:#fff;font-weight:500;}
.alert-description{white-space:pre-wrap;font-family:inherit;background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;border-left:3px solid rgba(255,255,255,0.1);}
.alert-areas{font-size:13px;color:#aaa;line-height:1.5;}
.alert-severity-badge{display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;margin-left:8px;}
.alert-severity-badge.extreme{background:rgba(220,38,38,0.3);color:#fca5a5;}
.alert-severity-badge.severe{background:rgba(239,68,68,0.25);color:#fca5a5;}
.alert-severity-badge.moderate{background:rgba(249,115,22,0.25);color:#fdba74;}
.alert-severity-badge.minor{background:rgba(234,179,8,0.25);color:#fde047;}

.widget-modal-overlay{
    position: absolute;
    inset: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.94);
    z-index: 99999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    box-sizing: border-box;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    overflow: auto;
  }

  .widget-modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .widget-modal-content {
    position: relative;
    background: rgba(255,255,255,0.98);
    border-radius: 20px;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255,255,255,0.1);
    overflow: hidden;
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    width: 90vw;
    max-width: 900px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    transform: scale(0.92);
  }

  .widget-modal-overlay.active .widget-modal-content {
    transform: scale(1);
  }

  .widget-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: rgba(43, 34, 244, 0.04);
    border-bottom: 1px solid rgba(43, 34, 244, 0.08);
    flex-shrink: 0;
  }

  .widget-modal-title {
    font-size: 0.72rem;
    font-weight: 850;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: rgba(43, 34, 244, 0.75);
  }

  .widget-modal-subtitle {
    font-size: 0.65rem;
    font-weight: 600;
    color: rgba(43, 34, 244, 0.5);
    margin-left: 12px;
  }

  .widget-modal-close {
    width: 32px;
    height: 32px;
    background: rgba(43, 34, 244, 0.08);
    border: none;
    border-radius: 50%;
    color: rgba(43, 34, 244, 0.6);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .widget-modal-close:hover {
    background: rgba(220, 50, 50, 0.12);
    color: rgba(220, 50, 50, 0.9);
    transform: rotate(90deg);
  }

  .widget-modal-body {
    flex: 1;
    overflow: auto;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
  }

  .widget-modal-body.content-image {
    padding: 16px;
    background: #000;
  }

  .widget-modal-body.content-image img {
    display: block;
    max-width: 100%;
    max-height: calc(85vh - 120px);
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 8px;
    margin: 0 auto;
  }

  .widget-modal-body.content-card {
    padding: 24px;
    background: rgba(255, 255, 255, 1);
    align-items: flex-start;
    justify-content: flex-start;
  }

  .widget-modal-body.content-card > * {
    width: 100%;
    max-width: 100%;
    background: transparent !important;
    box-shadow: none !important;
    border: none !important;
  }

  .widget-modal-body .forecast7-chips {
    gap: 12px;
  }

  .widget-modal-body .forecast7-chip {
    padding: 14px 12px;
    min-width: 85px;
  }

  .widget-modal-body .forecast7-chip .icon {
    width: 52px;
    height: 52px;
  }

  .widget-modal-body .forecast7-chip .day {
    font-size: 0.68rem;
  }

  .widget-modal-body .forecast7-chip .temps {
    font-size: 0.82rem;
  }

  .widget-modal-body .today-tl-sky-bar {
    min-height: 220px;
  }

  .widget-modal-body .today-tl-weather-icon {
    font-size: 30px;
  }

  .widget-modal-body .today-tl-weather-temp {
    font-size: 0.92rem;
  }

  .widget-modal-body .nightsky-svgwrap {
    height: 220px;
  }

  .widget-modal-body .nightsky-legend {
    gap: 10px;
  }

  .widget-modal-body .nightsky-item {
    padding: 6px 10px;
    font-size: 0.66rem;
  }

  .widget-modal-body.content-map {
    padding: 0;
    background: #f5f5f5;
  }

  .widget-modal-body.content-map .modal-map-container {
    width: 100%;
    height: calc(85vh - 80px);
    min-height: 400px;
  }

  .widget-modal-body.is-loading {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .widget-modal-body.is-loading::after {
    content: "";
    width: 40px;
    height: 40px;
    border: 3px solid rgba(43, 34, 244, 0.15);
    border-top-color: rgba(43, 34, 244, 0.7);
    border-radius: 50%;
    animation: modal-spin 0.8s linear infinite;
  }

  @keyframes modal-spin {
    to { transform: rotate(360deg); }
  }

  .widget.clickable-widget {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--glow-mid);
  }

  .clickable-card {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .clickable-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--glow-mid);
  }

  .widget.clickable-widget .widget-head {
    position: relative;
  }

  .widget.clickable-widget .widget-head::after {
    content: "";
    position: absolute;
    top: 50%;
    right: 40px;
    transform: translateY(-50%);
    font-size: 14px;
    color: rgba(43, 34, 244, 0.25);
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none;
  }

  .widget.clickable-widget:hover .widget-head::after {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .widget-modal-overlay {
      padding: 12px;
    }
    
    .widget-modal-content {
      width: 100%;
      max-width: 100%;
      max-height: 92vh;
      border-radius: 16px;
    }
    
    .widget-modal-header {
      padding: 12px 16px;
    }
    
    .widget-modal-title {
      font-size: 0.64rem;
    }
    
    .widget-modal-body {
      padding: 12px;
      min-height: 200px;
    }
    
    .widget-modal-body.content-image img {
      max-height: calc(92vh - 100px);
    }
    
    .widget-modal-body.content-map .modal-map-container {
      height: calc(92vh - 70px);
    }

    .widget.clickable-widget .widget-head::after {
      display: none;
    }
  }

  #widget-modal,
  #alert-modal,
  #dynamic-alert-modal {
    transform: none !important;
    contain: none !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    overflow: auto !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .tl-now-line,
    .spectrum-bar,
    * {
      transition: none !important;
      animation: none !important;
    }
  }

  /* Hide all scrollbars on mobile */
  @media (max-width: 768px) {
    * {
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }
    
    *::-webkit-scrollbar {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
      background: transparent !important;
    }
  }

  /* Force modals to viewport center */
  #alert-modal,
  #widget-modal {
    transform: none !important;
    contain: none !important;
    filter: none !important;
    perspective: none !important;
    will-change: auto !important;
    isolation: auto !important;
  }

  /* Ensure body doesn't create containing block */
  body.modal-open {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
body > #dynamic-alert-modal {
  transform: none !important;
  contain: none !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  overflow: auto !important;
}
</style>
</head>
<body>

<!-- Alert Detail Modal -->
<div class="alert-modal-overlay" id="alert-modal">
  <div class="alert-modal-content">
    <div class="alert-modal-header">
      <div class="alert-modal-title-wrap">
        <span class="alert-modal-icon" id="alert-modal-icon"></span>
        <span class="alert-modal-title" id="alert-modal-title">Alert</span>
      </div>
      <button class="alert-modal-close" id="alert-modal-close">&times;</button>
    </div>
    <div class="alert-modal-body" id="alert-modal-body"></div>
  </div>
</div>

<!-- Widget Popup Modal (outside root to avoid backdrop-filter issues) -->
<div class="widget-modal-overlay" id="widget-modal">
  <div class="widget-modal-content">
    <div class="widget-modal-header">
      <div style="display:flex;align-items:baseline;">
        <span class="widget-modal-title" id="modal-title">--</span>
        <span class="widget-modal-subtitle" id="modal-subtitle"></span>
      </div>
      <button class="widget-modal-close" id="widget-modal-close">&times;</button>
    </div>
    <div class="widget-modal-body" id="widget-modal-body"></div>
  </div>
</div>

<div id="cloud-soundscape-root">

  <!-- Screen reader announcements -->
  <div id="sr-announcements" aria-live="polite" aria-atomic="true" style="position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden;"></div>

  <main>
    <section class="panel">
      <div class="content-stack">

        <div class="weather-card">
          <div class="top-grid">

            <!-- Main Weather Section -->
<div class="left-now">
  
  <!-- Top Row: Location, Temp, Condition, Moon -->
  <div class="weather-top-row">
    <div class="weather-left-stack">
      <div class="loc-cycler" id="loc-cycler">
        <div class="loc-cycler-center">
          <div class="loc-name" id="loc-name">NYC</div>
          <div class="loc-dots-row">
            <button class="loc-search-toggle" id="loc-search-toggle" aria-label="Search location" title="Search for a location"></button>
            <button class="loc-arrow" id="loc-prev" aria-label="Previous location"></button>
            <div class="loc-dots" id="loc-dots"></div>
            <button class="loc-arrow" id="loc-next" aria-label="Next location"></button>
            <div class="loc-search-box" id="loc-search-box">
              <input type="text" class="loc-search-input" id="loc-search-input" placeholder="City or zip..." maxlength="60" />
              <button class="loc-search-close" id="loc-search-close" aria-label="Close search"></button>
            </div>
          </div>
        </div>
      </div>
    
      <div class="weather-main">
        <div class="weather-temp-block">
          <div class="temp" id="temp">--</div>
        </div>
        <div class="weather-cond-block">
          <img class="cond-icon-img" id="cond-icon" src="https://basmilius.github.io/weather-icons/production/fill/all/clear-day.svg" alt="Weather condition" />
        </div>
      </div>
    </div>
    
    <!-- Weather Alerts Area (center-right) -->
    <div class="weather-alerts-block" id="weather-alerts"></div>
    
    <div class="weather-moon-block">
      <img class="moon-img" id="moon-mini-img" src="" alt="Current moon phase" />
    </div>
  </div>

  <!-- Details Row -->
  <div class="weather-details-row">
    <div class="weather-hilo" id="today-hi-lo"><span class="feels-inline" id="feels-inline">Feels --</span> <span class="hilo-sep"></span> <span id="hilo-text">High -- | Low --</span></div>
    <div class="weather-stats-grid">
      <div class="weather-stat"><span class="k">Rain</span><span class="v" id="precip-amt">--</span></div>
      <div class="weather-stat"><span class="k">Next hrs</span><span class="v" id="forecast-row">--</span></div>
      <div class="weather-stat"><span class="k">Wind</span><span class="v" id="wind">--</span></div>
      <div class="weather-stat"><span class="k">Gusts</span><span class="v" id="gusts">--</span></div>
      <div class="weather-stat"><span class="k">Humidity</span><span class="v" id="humidity">--</span></div>
      <div class="weather-stat"><span class="k">Pressure</span><span class="v" id="pressure">--</span></div>
      <div class="weather-stat"><span class="k">UV</span><span class="v" id="uv">--</span></div>
      <div class="weather-stat loc-meta-stat"><span class="v" id="loc-meta" style="opacity:.45;font-size:.58rem;">---</span></div>
    </div>
  </div>

  <!-- Air & Pollen Row -->
  <div class="weather-details-row">
    <div class="weather-stats-grid">
      <div class="weather-stat"><span class="k">AQI</span><span class="ap-val" id="aqi-val">--</span></div>
      <div class="weather-stat"><span class="k"> AIR</span><span class="pollen-val" id="smoke-risk">--</span></div>
      <div class="weather-stat"><span class="k">PM2.5</span><span class="v" id="pm25-val">--</span></div>
      <div class="weather-stat"><span class="k">PM10</span><span class="v" id="pm10-val">--</span></div>
      <div class="weather-stat"><span class="k"> Tree</span><span class="pollen-val" id="pollen-tree">--</span></div>
      <div class="weather-stat"><span class="k"> Grass</span><span class="pollen-val" id="pollen-grass">--</span></div>
      <div class="weather-stat"><span class="k"> Weed</span><span class="pollen-val" id="pollen-weed">--</span></div>
      <div class="weather-stat"><span class="k"> Ragweed</span><span class="pollen-val" id="pollen-ragweed">--</span></div>
    </div>
  </div>
<!-- 7-Day Forecast -->
  <div class="forecast7-section">
    <div class="forecast7-top">
      <div class="forecast7-label" id="forecast-label">7 DAY FORECAST</div>
    </div>
    <div class="forecast7-chips" id="forecast7"></div>
  </div>
</div>
            
<!-- /Left -->

          </div>

          <!-- TODAY Timeline Widget (v4/v5 integrated) -->
          <div class="today-timeline-card" id="today-timeline-card">
            
            <!-- Header with metadata -->
            <div class="today-tl-header">
              <div>
                <div class="today-tl-title">TODAY</div><!-- v8feb -->
              </div>
              
              <div class="today-tl-meta">
                <div class="meta-item">
                  <span class="meta-key">Sunrise</span>
                  <span class="meta-val orange" id="today-tl-sunrise">--:--</span>
                </div>
                <div class="meta-item">
                  <span class="meta-key">Sunset</span>
                  <span class="meta-val orange" id="today-tl-sunset">--:--</span>
                </div>
                <div class="meta-item">
                  <span class="meta-key">Golden AM</span>
                  <span class="meta-val" id="today-tl-golden-am">--</span>
                </div>
                <div class="meta-item">
                  <span class="meta-key">Golden PM</span>
                  <span class="meta-val" id="today-tl-golden-pm">--</span>
                </div>
                <div class="meta-item">
                  <span class="meta-key">Daylight</span>
                  <span class="meta-val" id="today-tl-daylight">--</span>
                </div>
                <div class="meta-item">
                  <span class="meta-val green" id="today-tl-daylight-change">--</span>
                </div>
              </div>
              
              <div class="today-tl-stats">
                <div class="today-tl-stat">
                  <div class="stat-label">Sky</div>
                  <div class="stat-value" id="today-tl-sky">--</div>
                </div>
                <div class="today-tl-stat">
                  <div class="stat-label">Cloud</div>
                  <div class="stat-value" id="today-tl-cloud">--%</div>
                </div>
                <div class="today-tl-stat">
                  <div class="stat-label">Moon</div>
                  <div class="stat-value" id="today-tl-moon">--</div>
                </div>
              </div>
            </div>
            
            <!-- Main timeline body -->
            <div class="today-tl-body">
              
              <!-- Top bars: Kp and Cloud -->
              <div class="today-tl-top-bars">
                <div class="today-tl-bar-row">
                  <div class="today-tl-bar-label">Kp</div>
                  <div class="today-tl-bar-track" id="today-tl-kp-track"></div>
                </div>
                <div class="today-tl-bar-row">
                  <div class="today-tl-bar-label"></div>
                  <div class="today-tl-bar-track cloud" id="today-tl-cloud-track"></div>
                </div>
              </div>
              
              <!-- Sky bar with planets + weather -->
              <div class="today-tl-sky-bar" id="today-tl-sky-bar">
                
                <!-- Sky gradient bands -->
                <div class="today-tl-sky-bands" id="today-tl-sky-bands"></div>
                
                <!-- Planet visibility tracks -->
                <div class="today-tl-planet-tracks" id="today-tl-planet-tracks"></div>
                
                <!-- Weather row with animated icons -->
                <div class="today-tl-weather-row" id="today-tl-weather-row"></div>
                
                <!-- NOW marker -->
                <div class="today-tl-now-marker" id="today-tl-now-marker" style="display:none;">
                  <div class="today-tl-now-label">NOW</div>
                  <div class="today-tl-now-bubble">
                    <span class="today-tl-now-temp" id="today-tl-now-temp">--</span>
                    <span class="today-tl-now-time" id="today-tl-now-time">--:--</span>
                  </div>
                </div>
                
              </div>
            </div>
            
            <!-- Legend -->
            <div class="today-tl-legend" id="today-tl-legend">
              <div class="today-tl-legend-item">
                <div class="today-tl-kp-scale">
                  <span>Kp 0</span>
                  <div class="today-tl-kp-box" style="background:#009933;"></div>
                  <div class="today-tl-kp-box" style="background:#33cc33;"></div>
                  <div class="today-tl-kp-box" style="background:#66cc33;"></div>
                  <div class="today-tl-kp-box" style="background:#99cc33;"></div>
                  <div class="today-tl-kp-box" style="background:#cccc33;"></div>
                  <div class="today-tl-kp-box" style="background:#ffff00;"></div>
                  <div class="today-tl-kp-box" style="background:#ffcc00;"></div>
                  <div class="today-tl-kp-box" style="background:#ff9900;"></div>
                  <div class="today-tl-kp-box" style="background:#ff3333;"></div>
                  <div class="today-tl-kp-box" style="background:#cc0033;"></div>
                  <span>9</span>
                </div>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-kp-scale">
                  <span></span>
                  <div class="today-tl-kp-box" style="background:#ffffff;border:1px solid rgba(0,0,0,0.1);"></div>
                  <div class="today-tl-kp-box" style="background:#c8c8c8;"></div>
                  <div class="today-tl-kp-box" style="background:#8c8c8c;"></div>
                  <div class="today-tl-kp-box" style="background:#5a5a5a;"></div>
                  <span></span>
                </div>
              </div>
              <div class="today-tl-legend-item" id="today-tl-legend-moon-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-moon" id="today-tl-legend-moon"></div>Moon</div>
                <span class="today-tl-legend-dir" id="legend-dir-moon"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#9A9A9A;"></div>Mercury</div>
                <span class="today-tl-legend-dir" id="legend-dir-mercury"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#FFE5B4;"></div>Venus</div>
                <span class="today-tl-legend-dir" id="legend-dir-venus"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#C44D2A;"></div>Mars</div>
                <span class="today-tl-legend-dir" id="legend-dir-mars"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#E8A954;"></div>Jupiter</div>
                <span class="today-tl-legend-dir" id="legend-dir-jupiter"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#F0C75E;"></div>Saturn</div>
                <span class="today-tl-legend-dir" id="legend-dir-saturn"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#8ECAE6;"></div>Uranus</div>
                <span class="today-tl-legend-dir" id="legend-dir-uranus"></span>
              </div>
              <div class="today-tl-legend-item">
                <div class="today-tl-legend-top"><div class="today-tl-legend-dot" style="background:#4AA3DF;"></div>Neptune</div>
                <span class="today-tl-legend-dir" id="legend-dir-neptune"></span>
              </div>
            </div>
            
            <!-- Space Events -->
            <div class="skygrid" style="margin-top:12px;">
              <div class="skcard" style="min-height:auto;background:transparent;box-shadow:none;padding:10px 0 0 0;">
                <div class="skk">Space events</div>
                <div class="skv" id="space-events">--</div>
                <div class="bullets" id="space-events-bullets"></div>
              </div>
            </div>
            
          </div>

          <!-- Full-width Timeline (existing - kept for compatibility) -->
          <div class="sun-timeline" id="sun-timeline" aria-label="daily sun and weather timeline" style="display:none;">
            
            <!-- Header row -->
            <div class="sun-timeline-header">
              <div class="sun-timeline-title">
                <span class="sun-label-text">TODAY'S TIMELINE</span>
              </div>
              <div class="sun-timeline-meta">
                <span class="meta-item"><span class="meta-key">Sunrise</span> <span class="meta-val" id="tl-sunrise">--:--</span></span>
                <span class="meta-item"><span class="meta-key">Sunset</span> <span class="meta-val" id="tl-sunset">--:--</span></span>
                <span class="meta-item"><span class="meta-key">Golden AM</span> <span class="meta-val" id="tl-golden-am">--</span></span>
                <span class="meta-item"><span class="meta-key">Golden PM</span> <span class="meta-val" id="tl-golden-pm">--</span></span>
                <span class="meta-item"><span class="meta-key">Daylight</span> <span class="meta-val" id="tl-daylight">--</span></span>
                <span class="meta-item"><span class="meta-val" id="tl-daylight-change">--</span></span>
              </div>
            </div>

            <!-- Main timeline bar -->
            <div class="sun-timeline-bar" id="sun-timeline-bar">
              
              <!-- Background bands (golden hour, blue hour shading) -->
              <div class="tl-bands" id="tl-bands"></div>
              
              <!-- Hour markers and weather data -->
              <div class="tl-hours" id="tl-hours"></div>
              
              <!-- Sun event ticks -->
              <div class="tl-events" id="tl-events"></div>
              
              <!-- NOW marker -->
              <div class="tl-now" id="tl-now">
                <div class="tl-now-line"></div>
                <div class="tl-now-bubble">
                  <span class="tl-now-temp" id="tl-now-temp">--</span>
                  <span class="tl-now-label">NOW</span>
                </div>
              </div>

            </div>

            <!-- Event labels below bar -->
            <div class="tl-event-labels" id="tl-event-labels"></div>

          </div>

          <!-- WIDGETS -->
          
          <!-- ROW 1: LOCAL RADAR / CLOUDS -->
          <div class="widgets-row-two">

            <!-- RADAR -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">LOCAL RADAR <span class="live-tag" id="radar-live"> LIVE</span></div>
                <a href="https://radar.weather.gov/" target="_blank" rel="noopener" class="widget-sub" id="radar-sub" style="text-decoration:none;color:inherit;">NWS</a>
              </div>
              <div class="widget-body" style="background:#000; position:relative;">
                <img id="radar-img" alt="Radar loop" />
                <div style="position:absolute; top:10px; left:10px; z-index:10;">
                  <div id="local-radar-timestamp" style="padding:4px 10px; border-radius:6px; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); font-size:.65rem; font-weight:600; color:#fff; font-family:system-ui,sans-serif; white-space:nowrap;">--:-- --</div>
                </div>
                <div style="position:absolute; bottom:10px; right:10px; z-index:10; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); padding:6px 10px; border-radius:6px;">
                  <div style="display:flex; align-items:center; gap:6px; font-size:.55rem; font-weight:600; color:#fff; font-family:system-ui,sans-serif;">
                    <span style="display:flex; align-items:center; gap:2px;"><span style="width:8px;height:8px;background:#04e9e7;border-radius:1px;"></span>Light</span>
                    <span style="display:flex; align-items:center; gap:2px;"><span style="width:8px;height:8px;background:#02fd02;border-radius:1px;"></span>Mod</span>
                    <span style="display:flex; align-items:center; gap:2px;"><span style="width:8px;height:8px;background:#fdf802;border-radius:1px;"></span>Heavy</span>
                    <span style="display:flex; align-items:center; gap:2px;"><span style="width:8px;height:8px;background:#fd0000;border-radius:1px;"></span>Severe</span>
                  </div>
                </div>
                <div class="badge">NWS RIDGE</div>
              </div>
            </div>

            <!-- GOES CLOUDS -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">CLOUDS <span class="live-tag" id="goes-live"> LIVE</span></div>
                <a href="https://www.star.nesdis.noaa.gov/goes/index.php" target="_blank" rel="noopener" class="widget-sub" id="goes-sub" style="text-decoration:none;color:inherit;">NESDIS/STAR GOES</a>
              </div>
              <div class="widget-body">
                <div class="mini-solar" style="top:10px">
                  <span class="mini-pill"><span class="mini-key">Loop</span><span class="mini-val" id="goes-loop">6h</span></span>
                  <span class="mini-pill"><span class="mini-key">Frame</span><span class="mini-val" id="goes-frame">--/--</span></span>
                </div>
                <img id="goes-img" alt="GOES-19 Northeast GeoColor loop" />
                <div class="badge">NESDIS/STAR</div>
              </div>
            </div>

          </div>

          <!-- ROW 2: NATIONAL RADAR / GFS UPPER AIR -->
          <div class="widgets-row-two">

            <!-- NATIONAL RADAR -->
            <div class="widget map-widget">
              <div class="widget-head">
                <div class="widget-title">NATIONAL RADAR <span class="live-tag" id="national-radar-live"> LIVE</span></div>
                <a href="https://radar.weather.gov/" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">IEM NEXRAD</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <div id="national-radar-map" style="width:100%; height:100%; background:#1a1a2e;"></div>
                <div style="position:absolute; top:10px; left:10px; z-index:1000;">
                  <div id="national-radar-timestamp" style="padding:4px 10px; border-radius:6px; background:rgba(0,0,0,.7); backdrop-filter:blur(8px); font-size:.65rem; font-weight:600; color:#fff; font-family:system-ui,sans-serif; white-space:nowrap;">--:-- --</div>
                </div>
                <div class="badge">IEM NEXRAD</div>
              </div>
            </div>

            <!-- GFS UPPER AIR / POLAR VORTEX -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">GFS UPPER AIR <span class="live-tag" id="gfs-live"> LIVE</span></div>
                <a href="https://mag.ncep.noaa.gov/model-guidance-model-parameter.php?group=Model+Guidance&model=gfs&area=namer" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NOAA NCEP MAG</a>
              </div>
              <div class="widget-body" style="background:#0a0a1a;position:relative;overflow:hidden;">
                <!-- Tab bar -->
                <div id="gfs-tabs" style="position:absolute;top:10px;left:10px;z-index:10;display:flex;gap:4px;">
                  <button onclick="switchGfsTab('500mb')" id="gfs-tab-500mb" class="gfs-tab-btn gfs-tab-active" style="padding:3px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.15);backdrop-filter:blur(8px);color:#fff;font-size:.6rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">500mb N.America</button>
                  <button onclick="switchGfsTab('10mb')" id="gfs-tab-10mb" class="gfs-tab-btn" style="padding:3px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);backdrop-filter:blur(8px);color:rgba(255,255,255,.5);font-size:.6rem;font-weight:700;cursor:pointer;font-family:system-ui,sans-serif;text-transform:uppercase;letter-spacing:.5px;">10mb Stratosphere</button>
                </div>
                <!-- Forecast hour stepper -->
                <div id="gfs-fhr-controls" style="position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:10;display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:16px;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);">
                  <button onclick="gfsStepFhr(-1)" style="background:none;border:none;color:#fff;font-size:.8rem;cursor:pointer;padding:2px 6px;font-family:system-ui;"></button>
                  <span id="gfs-fhr-label" style="font-size:.6rem;font-weight:700;color:#fff;font-family:system-ui,sans-serif;min-width:60px;text-align:center;">F000  Analysis</span>
                  <button onclick="gfsStepFhr(1)" style="background:none;border:none;color:#fff;font-size:.8rem;cursor:pointer;padding:2px 6px;font-family:system-ui;"></button>
                  <button onclick="gfsTogglePlay()" id="gfs-play-btn" style="background:none;border:none;color:#fff;font-size:.65rem;cursor:pointer;padding:2px 6px;font-family:system-ui;"></button>
                </div>
                <!-- Cycle info -->
                <div id="gfs-cycle-label" style="position:absolute;top:10px;right:10px;z-index:10;padding:3px 8px;border-radius:8px;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);font-size:.55rem;font-weight:600;color:rgba(255,255,255,.6);font-family:system-ui,sans-serif;">Cycle: --Z</div>
                <!-- Images -->
                <img id="gfs-500mb-img" alt="GFS 500mb Vorticity & Heights - North America" style="width:100%;height:100%;object-fit:contain;" />
                <img id="gfs-10mb-img" alt="CPC 10mb Stratospheric Analysis" style="width:100%;height:100%;object-fit:contain;display:none;" />
                <div class="badge">NCEP MAG / CPC</div>
              </div>
            </div>

          </div>

          <!-- ROW 3: HAZARD MAPS - Lightning / Wildfires / Earthquakes -->
          <div class="widgets-row">

            <!-- LIGHTNING -->
<div class="widget map-widget">
  <div class="widget-head">
    <div class="widget-title">LIGHTNING <span class="live-tag" id="lightning-live"> LIVE</span></div>
    <a href="https://www.blitzortung.org/en/live_lightning_maps.php" target="_blank" rel="noopener" class="widget-sub" id="lightning-sub" style="text-decoration:none;color:inherit;">Blitzortung</a>
  </div>
  <div class="widget-body" style="position:relative;">
    <iframe id="lightning-iframe" src="" style="width:100%; height:100%; border:none; filter:saturate(0.8) brightness(0.9);"></iframe>
  </div>
</div>

            <!-- WILDFIRES -->
            <div class="widget map-widget">
              <div class="widget-head">
                <div class="widget-title">WILDFIRES <span class="live-tag" id="fire-live"> LIVE</span></div>
                <a href="https://livingatlas.arcgis.com/en/home/" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">ESRI + NOAA HMS</a>
              </div>
              <div class="widget-body" style="position:relative;">
                <div id="fire-map" style="width:100%; height:100%; background:#f5f5f5;"></div>
                <div id="fire-labels-toggle" onclick="toggleFireLabels()" style="position:absolute; top:10px; right:10px; z-index:1000; padding:5px 10px; border-radius:20px; background:rgba(255,255,255,.90); backdrop-filter:blur(8px); font-size:.62rem; font-weight:700; color:#888; box-shadow:0 2px 8px rgba(0,0,0,.15); cursor:pointer; user-select:none; border:2px solid #888;"> OFF</div>
                <div id="fire-aqi-pill" style="position:absolute; bottom:10px; left:10px; z-index:1000; padding:6px 12px; border-radius:16px; background:rgba(0,0,0,.75); backdrop-filter:blur(8px); font-size:.7rem; font-weight:700; color:#fff; box-shadow:0 2px 8px rgba(0,0,0,.2); display:none; pointer-events:none;"><span id="fire-aqi-value">--</span> AQI</div>
                <div class="fire-status-wrap" style="position:absolute; top:10px; left:10px; z-index:1000;">
                  <div id="fire-status-pill" style="padding:5px 10px; border-radius:20px; background:rgba(255,255,255,.06);
    box-shadow:0 0 30px rgba(255,255,255,.10), inset 0 0 20px rgba(255,255,255,.18); backdrop-filter:blur(8px); font-size:.68rem; font-weight:700; color:#333; box-shadow:0 2px 8px rgba(0,0,0,.12); cursor:pointer;"> Loading...</div>
                  <div id="fire-dropdown" style="position:absolute; top:100%; left:0; padding-top:6px; opacity:0; visibility:hidden; transition: opacity .2s ease, visibility .2s ease; pointer-events:none;">
                    <div id="fire-list" style="background:rgba(0,0,0,.85); backdrop-filter:blur(12px); border-radius:10px; padding:6px; min-width:220px; max-height:220px; overflow-y:auto;"></div>
                  </div>
                </div>
                <!-- Smoke layer always on -->
              </div>
            </div>

            <!-- EARTHQUAKES -->
            <div class="widget map-widget">
              <div class="widget-head">
                <div class="widget-title">EARTHQUAKES <span class="live-tag" id="quake-live"> LIVE</span></div>
                <a href="https://earthquake.usgs.gov/earthquakes/map/" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">USGS + Macrostrat</a>
              </div>
              <div class="widget-body" style="position:relative;">
                <div id="quake-map" style="width:100%; height:100%; background:#f5f5f5;"></div>
                <div class="quake-status-wrap" style="position:absolute; top:10px; left:10px; z-index:400;">
                  <div id="quake-status-pill" style="padding:5px 10px; border-radius:20px; background:rgba(255,255,255,.06);
    box-shadow:0 0 30px rgba(255,255,255,.10), inset 0 0 20px rgba(255,255,255,.18); backdrop-filter:blur(8px); font-size:.68rem; font-weight:700; color:#333; box-shadow:0 2px 8px rgba(0,0,0,.12); cursor:pointer;"> Loading...</div>
                  <div id="quake-dropdown" style="position:absolute; top:100%; left:0; padding-top:6px; opacity:0; visibility:hidden; transition: opacity .2s ease, visibility .2s ease; pointer-events:none;">
                    <div id="quake-list" style="background:rgba(0,0,0,.85); backdrop-filter:blur(12px); border-radius:10px; padding:6px; min-width:200px; max-height:220px; overflow-y:auto;"></div>
                  </div>
                </div>
                <div id="quake-geo-toggle" onclick="toggleQuakeGeology()" style="position:absolute; top:10px; right:10px; z-index:1000; padding:5px 10px; border-radius:20px; background:rgba(255,255,255,.90); backdrop-filter:blur(8px); font-size:.62rem; font-weight:700; color:#22c55e; box-shadow:0 2px 8px rgba(0,0,0,.15); cursor:pointer; user-select:none; border:2px solid #22c55e;"> ON</div>
              </div>
            </div>

          </div>
          <!-- ROW 3: LASCO C3 / LASCO C2 / SOLAR WIND ENLIL -->
          <div class="widgets-row">

            <!-- LASCO C3 -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">LASCO C3 <span style="font-weight:500;opacity:0.7;">OUTER</span> <span class="live-tag" id="lasco-c3-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/lasco-coronagraph" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NASA/ESA SOHO</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;overflow:hidden;">
                <img id="lasco-c3-img" alt="LASCO C3 Coronagraph" style="width:115%;height:115%;object-fit:cover;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);" />
                <div class="badge">SOHO LASCO</div>
                
              </div>
            </div>

            <!-- LASCO C2 -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">LASCO C2 <span style="font-weight:500;opacity:0.7;">INNER</span> <span class="live-tag" id="lasco-c2-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/lasco-coronagraph" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NASA/ESA SOHO</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="lasco-c2-img" alt="LASCO C2 Coronagraph" style="width:100%;height:100%;object-fit:cover;" />
                <div class="badge">SOHO LASCO</div>
                
              </div>
            </div>

            <!-- SDO PFSS MAGNETIC FIELD -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">SOLAR MAGNETIC FIELD <span class="live-tag" id="pfss-live"> LIVE</span></div>
                <a href="https://sdo.gsfc.nasa.gov/data/" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NASA SDO PFSS</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="pfss-img" alt="SDO AIA 171 with PFSS magnetic field lines" style="width:100%;height:100%;object-fit:contain;background:#000;" />
                <div class="badge">NASA SDO</div>
              </div>
            </div>

          </div>

          <!-- ROW 3: AURORA / SUVI / ENLIL -->
          <div class="widgets-row">

            <!-- AURORA -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">AURORA FORECAST <span class="live-tag" id="aurora-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/aurora-30-minute-forecast" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC OVATION</a>
              </div>
              <div class="widget-body" id="aurora-body">
                <div class="mini-solar" aria-label="solar weather summary">
                  <span class="mini-pill"><span class="mini-key">Kp</span><span class="mini-val" id="sw-kp">--</span></span>
                  <span class="mini-pill"><span class="mini-key">G</span><span class="mini-val" id="sw-g">--</span></span>
                  <span class="mini-pill"><span class="mini-key">Bz</span><span class="mini-val" id="sw-bz">--</span></span>
                  <span class="mini-pill"><span class="mini-key">Wind</span><span class="mini-val" id="sw-wind">--</span></span>
                  <span class="mini-pill"><span class="mini-key">Vis</span><span class="mini-val" id="sw-vis">--</span></span>
                </div>

                <canvas id="aurora-canvas"></canvas>
                <img id="aurora-img-fallback" alt="Aurora 30-minute outlook fallback" />
                <div class="badge">SWPC Ovation</div>
              </div>
            </div>

            <!-- SUVI THEMATIC MAP -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">SUVI THEMATIC MAP <span class="live-tag" id="suvi-map-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/goes-solar-ultraviolet-imager-suvi" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">NOAA GOES</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="suvi-map-img" alt="SUVI Thematic Map" style="width:100%;height:100%;object-fit:cover;" />
                <div class="badge">GOES SUVI</div>
                
              </div>
            </div>

            <!-- ENLIL -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">SOLAR WIND <span class="live-tag" id="enlil-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/wsa-enlil-solar-wind-prediction" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC WSA-ENLIL</a>
              </div>
              <div class="widget-body" style="background:#000;position:relative;">
                <img id="enlil-img" alt="WSA-ENLIL solar wind prediction" style="width:100%;height:100%;object-fit:cover;" />
                <div class="badge">SWPC WSA-ENLIL</div>
                
              </div>
            </div>

          </div>

          <!-- ROW 4: GEOSPACE MAGNETOSPHERE -->
          <div class="widgets-row">

            <!-- GEOSPACE VELOCITY -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">GEOSPACE MAGNETOSPHERE | VELOCITY <span class="live-tag" id="geo-vel-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/geospace-magnetosphere-movies" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC</a>
              </div>
              <div class="widget-body" style="background:#000;">
                <img id="geo-vel-img" alt="Geospace Magnetosphere - Velocity" style="width:100%;height:100%;object-fit:cover;" />
              </div>
            </div>

            <!-- GEOSPACE DENSITY -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">GEOSPACE MAGNETOSPHERE | DENSITY <span class="live-tag" id="geo-den-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/geospace-magnetosphere-movies" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC</a>
              </div>
              <div class="widget-body" style="background:#000;">
                <img id="geo-den-img" alt="Geospace Magnetosphere - Density" style="width:100%;height:100%;object-fit:cover;" />
              </div>
            </div>

            <!-- GEOSPACE PRESSURE -->
            <div class="widget">
              <div class="widget-head">
                <div class="widget-title">GEOSPACE MAGNETOSPHERE | PRESSURE <span class="live-tag" id="geo-pre-live"> LIVE</span></div>
                <a href="https://www.swpc.noaa.gov/products/geospace-magnetosphere-movies" target="_blank" rel="noopener" class="widget-sub" style="text-decoration:none;color:inherit;">SWPC</a>
              </div>
              <div class="widget-body" style="background:#000;">
                <img id="geo-pre-img" alt="Geospace Magnetosphere - Pressure" style="width:100%;height:100%;object-fit:cover;" />
              </div>
            </div>

          </div>

          </div>

        <!-- AUDIO -->
        <div class="audio-section">
          <div class="audio-header-title">Ambient</div>
          <div class="audio-sub">Single channel  add your stream URL to play.</div>

          <button id="play-all" class="play-all"> Play</button>

          <div id="spectrum" class="spectrum">
            <div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div><div class="spectrum-bar"></div>
          </div>

          <div class="channels">
            <div class="channel">
              <div class="channel-name">Stream</div>
              <div id="a-status">No source set</div>
              <div class="slider-row">
                <input id="vol-a" type="range" min="0" max="1" step="0.01" value="0.8" />
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <audio id="audio-a" loop crossorigin="anonymous"></audio>
</div>

<script>
(function () {
  "use strict";

  /* =========================================================
     CONFIG
     ========================================================= */
  var LOCATIONS = [
    { id: "nyc", name: "NYC", lat: 40.7411, lon: -73.9897, tz: "America/New_York", radar: "KOKX", radarName: "NWS Upton", radarRegion: "NORTHEAST", goes: { sat: "G19", sector: "ne" } },
    { id: "la", name: "LA", lat: 34.0195, lon: -118.4912, tz: "America/Los_Angeles", radar: "KVTX", radarName: "NWS Los Angeles", radarRegion: "PACSOUTHWEST", goes: { sat: "G18", sector: "wus" } },
    { id: "chicago", name: "Chicago", lat: 42.3175, lon: -89.0937, tz: "America/Chicago", radar: "KLOT", radarName: "NWS Chicago", radarRegion: "UPPERMISSVLY", goes: { sat: "G19", sector: "umv" } },
    { id: "sf", name: "SF", lat: 37.7559, lon: -122.5108, tz: "America/Los_Angeles", radar: "KMUX", radarName: "NWS San Francisco", radarRegion: "PACNORTHWEST", goes: { sat: "G18", sector: "wus" } },
    { id: "charleston", name: "Charleston", lat: 32.8141, lon: -79.9295, tz: "America/New_York", radar: "KCLX", radarName: "NWS Charleston", radarRegion: "SOUTHEAST", goes: { sat: "G19", sector: "se" } },
    { id: "pv", name: "Pleasant Valley", lat: 41.7340, lon: -73.8212, tz: "America/New_York", radar: "KENX", radarName: "NWS Albany", radarRegion: "NORTHEAST", goes: { sat: "G19", sector: "ne" } },
    { id: "stephenson", name: "Stephenson", lat: 39.2148, lon: -78.0594, tz: "America/New_York", radar: "KLWX", radarName: "NWS Sterling", radarRegion: "NORTHEAST", goes: { sat: "G19", sector: "ne" } }
  ];
  
  var LOCATION = LOCATIONS[0];
  var TZ = LOCATION.tz;

  /* =========================================================
     UTILITIES
     ========================================================= */
  function fetchWithTimeout(url, opts, ms){
    ms = ms || 12000;
    opts = opts || {};
    var ctrl = null;
    try{ ctrl = new AbortController(); opts.signal = ctrl.signal; } catch(e){}
    var t = null;
    if (ctrl){
      t = setTimeout(function(){ try{ ctrl.abort(); }catch(e){} }, ms);
    }
    return fetch(url, opts).then(function(r){
      if (t) clearTimeout(t);
      return r;
    }, function(err){
      if (t) clearTimeout(t);
      throw err;
    });
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function setText(el, txt){ if (el) el.textContent = (txt == null ? "" : String(txt)); }

  /* =========================================================
     TIME HELPERS (12-hour, no AM/PM)
     ========================================================= */
  function fmt12NoSuffixFromDate(d){
    if (!d || !isFinite(d.getTime())) return "--:--";
    var h = d.getHours();
    var m = d.getMinutes();
    var hh = h % 12; if (hh === 0) hh = 12;
    return String(hh) + ":" + (m < 10 ? "0"+m : m);
  }
  function fmt12NoSuffix(iso){ return fmt12NoSuffixFromDate(new Date(iso)); }
  
  function fmtMonthDay(d){
    if (!d || !isFinite(d.getTime())) return "--";
    var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return months[d.getMonth()] + " " + d.getDate();
  }

  /* =========================================================
     AUDIO
     ========================================================= */
  var CHANNEL_A_URL = ""; // Put your stream URL here (optional)
  var audioA   = document.getElementById("audio-a");
  var volA     = document.getElementById("vol-a");
  var aStatus  = document.getElementById("a-status");
  var playBtn  = document.getElementById("play-all");
  var spectrum = document.getElementById("spectrum");

  (function initAudio(){
    if (!audioA || !volA || !aStatus || !playBtn || !spectrum) return;

    if (CHANNEL_A_URL){
      audioA.src = CHANNEL_A_URL;
      aStatus.textContent = "Ready";
    } else {
      aStatus.textContent = "No source set";
    }

    audioA.volume = parseFloat(volA.value || "0.8");
    volA.addEventListener("input", function(){
      audioA.volume = parseFloat(volA.value || "0.8");
    });

    var playing = false;
    playBtn.onclick = function(){
      if (!playing){
        if (audioA.src){
          audioA.play().catch(function(){});
        }
        playBtn.textContent = " Pause";
        spectrum.classList.add("playing");
        playing = true;
      } else {
        audioA.pause();
        playBtn.textContent = " Play";
        spectrum.classList.remove("playing");
        playing = false;
      }
    };
  })();

  /* =========================================================
     DOM REFS
     ========================================================= */
  var tempEl        = document.getElementById("temp");
  var feelsInlineEl = document.getElementById("feels-inline");
  var condTextEl    = document.getElementById("cond-text");
  var condIconEl    = document.getElementById("cond-icon");
  var locNameEl     = document.getElementById("loc-name");
  var locMetaEl     = document.getElementById("loc-meta");

  var windEl      = document.getElementById("wind");
  var gustsEl     = document.getElementById("gusts");
  var humidityEl  = document.getElementById("humidity");
  var pressureEl  = document.getElementById("pressure");
  var uvEl        = document.getElementById("uv");

  var hiLoEl        = document.getElementById("today-hi-lo");
  var precipAmtEl   = document.getElementById("precip-amt");
  var forecastRowEl = document.getElementById("forecast-row");

  var forecast7El    = document.getElementById("forecast7");

  var moonMiniIconEl = document.getElementById("moon-mini-icon");
  var moonMiniTextEl = document.getElementById("moon-mini-text");

  var nightSkyTitleEl = document.getElementById("night-sky-title");

  var spaceEventsEl        = document.getElementById("space-events");
  var spaceEventsBulletsEl = document.getElementById("space-events-bullets");

  var nightSkySvg    = document.getElementById("night-sky-svg");
  var nightSkyLegend = document.getElementById("night-sky-legend");

  var radarImg    = document.getElementById("radar-img");
  var radarLiveEl = document.getElementById("radar-live");

  var auroraCanvas      = document.getElementById("aurora-canvas");
  var auroraLiveEl      = document.getElementById("aurora-live");
  var auroraFallbackImg = document.getElementById("aurora-img-fallback");
  var auroraBtn         = document.getElementById("aurora-btn");

  var goesImg      = document.getElementById("goes-img");
  var goesLiveEl   = document.getElementById("goes-live");
  var goesFrameEl  = document.getElementById("goes-frame");

  var enlilImg    = document.getElementById("enlil-img");
  var enlilLiveEl = document.getElementById("enlil-live");

  // sunliveImg removed - replaced by SUVI Thematic Map

  // SWPC Geospace images (animated)
  var swpcGeoVelImg = document.getElementById("swpc-geo-vel-img");
  var swpcGeoDenImg = document.getElementById("swpc-geo-den-img");
  var swpcGeoPreImg = document.getElementById("swpc-geo-pre-img");

  var geoVelLiveEl = document.getElementById("geo-vel-live");
  var geoDenLiveEl = document.getElementById("geo-den-live");
  var geoPreLiveEl = document.getElementById("geo-pre-live");

  // Solar mini pills
  var swKp   = document.getElementById("sw-kp");
  var swG    = document.getElementById("sw-g");
  var swBz   = document.getElementById("sw-bz");
  var swWind = document.getElementById("sw-wind");
  var swVis  = document.getElementById("sw-vis");

  /* =========================================================
     ICONS (Open-Meteo weathercode) - COMPLETE MAPPING
     ========================================================= */
  var METEO_BASE = "https://basmilius.github.io/weather-icons/production/fill/all/";

  var ICONS_URL = {
    clearDay: METEO_BASE + "clear-day.svg",
    clearNight: METEO_BASE + "clear-night.svg",
    partlyDay: METEO_BASE + "partly-cloudy-day.svg",
    partlyNight: METEO_BASE + "partly-cloudy-night.svg",
    overcast: METEO_BASE + "overcast.svg",
    fogDay: METEO_BASE + "fog-day.svg",
    fogNight: METEO_BASE + "fog-night.svg",
    fog: METEO_BASE + "fog.svg",
    drizzle: METEO_BASE + "drizzle.svg",
    rain: METEO_BASE + "rain.svg",
    partlyRainDay: METEO_BASE + "partly-cloudy-day-rain.svg",
    partlyRainNight: METEO_BASE + "partly-cloudy-night-rain.svg",
    sleet: METEO_BASE + "sleet.svg",
    snow: METEO_BASE + "snow.svg",
    partlySnowDay: METEO_BASE + "partly-cloudy-day-snow.svg",
    partlySnowNight: METEO_BASE + "partly-cloudy-night-snow.svg",
    thunderstormsDay: METEO_BASE + "thunderstorms-day.svg",
    thunderstormsNight: METEO_BASE + "thunderstorms-night.svg",
    thunderstormsRain: METEO_BASE + "thunderstorms-rain.svg",
    unknown: METEO_BASE + "not-available.svg"
  };

  function isNightTime(){
    var hour = new Date().getHours();
    return hour < 6 || hour >= 20;
  }

  /* =========================================================
     WEATHER CODE TO ANIMATION CLASS MAPPING (v5 complete)
     ========================================================= */
  function getWeatherAnimClass(code, isNight){
    // Returns: { emoji, animClass, label }
    if (code === 0) return { emoji: isNight ? "" : "", animClass: isNight ? "night" : "sun", label: "Clear" };
    if (code === 1) return { emoji: isNight ? "" : "", animClass: "partly", label: "Mainly Clear" };
    if (code === 2) return { emoji: "", animClass: "partly", label: "Partly Cloudy" };
    if (code === 3) return { emoji: "", animClass: "cloud", label: "Overcast" };
    if (code === 45) return { emoji: "", animClass: "fog", label: "Fog" };
    if (code === 48) return { emoji: "", animClass: "fog", label: "Rime Fog" };
    if (code === 51) return { emoji: "", animClass: "drizzle", label: "Light Drizzle" };
    if (code === 53) return { emoji: "", animClass: "drizzle", label: "Drizzle" };
    if (code === 55) return { emoji: "", animClass: "drizzle", label: "Dense Drizzle" };
    if (code === 56) return { emoji: "", animClass: "freezing-drizzle", label: "Freezing Drizzle" };
    if (code === 57) return { emoji: "", animClass: "freezing-drizzle", label: "Dense Freezing Drizzle" };
    if (code === 61) return { emoji: "", animClass: "rain", label: "Light Rain" };
    if (code === 63) return { emoji: "", animClass: "rain", label: "Rain" };
    if (code === 65) return { emoji: "", animClass: "rain", label: "Heavy Rain" };
    if (code === 66) return { emoji: "", animClass: "freezing-rain", label: "Light Freezing Rain" };
    if (code === 67) return { emoji: "", animClass: "freezing-rain", label: "Heavy Freezing Rain" };
    if (code === 71) return { emoji: "", animClass: "snow", label: "Light Snow" };
    if (code === 73) return { emoji: "", animClass: "snow", label: "Snow" };
    if (code === 75) return { emoji: "", animClass: "snow", label: "Heavy Snow" };
    if (code === 77) return { emoji: "", animClass: "sleet", label: "Sleet" };
    if (code === 80) return { emoji: "", animClass: "rain", label: "Rain Showers" };
    if (code === 81) return { emoji: "", animClass: "rain", label: "Moderate Showers" };
    if (code === 82) return { emoji: "", animClass: "rain", label: "Violent Showers" };
    if (code === 85) return { emoji: "", animClass: "snow", label: "Snow Showers" };
    if (code === 86) return { emoji: "", animClass: "snow", label: "Heavy Snow Showers" };
    if (code === 95) return { emoji: "", animClass: "storm", label: "Thunderstorm" };
    if (code === 96) return { emoji: "", animClass: "storm-hail", label: "T-Storm + Hail" };
    if (code === 99) return { emoji: "", animClass: "storm-hail", label: "T-Storm + Heavy Hail" };
    return { emoji: "", animClass: "", label: "Weather" };
  }

  function iconForCode(code){
  var night = isNightTime();
  if (code === 0) return {t:"Clear", i: night ? ICONS_URL.clearNight : ICONS_URL.clearDay};
  if (code === 1) return {t:"Mainly Clear", i: night ? ICONS_URL.partlyNight : ICONS_URL.partlyDay};
  if (code === 2) return {t:"Partly Cloudy", i: night ? ICONS_URL.partlyNight : ICONS_URL.partlyDay};
  if (code === 3) return {t:"Overcast", i: ICONS_URL.overcast};
  if (code === 45) return {t:"Fog", i: night ? ICONS_URL.fogNight : ICONS_URL.fogDay};
  if (code === 48) return {t:"Rime Fog", i: ICONS_URL.fog};
  if (code === 51) return {t:"Light Drizzle", i: ICONS_URL.drizzle};
  if (code === 53) return {t:"Drizzle", i: ICONS_URL.drizzle};
  if (code === 55) return {t:"Dense Drizzle", i: ICONS_URL.drizzle};
  if (code === 56) return {t:"Light Freezing Drizzle", i: ICONS_URL.sleet};
  if (code === 57) return {t:"Freezing Drizzle", i: ICONS_URL.sleet};
  if (code === 61) return {t:"Light Rain", i: ICONS_URL.rain};
  if (code === 63) return {t:"Rain", i: ICONS_URL.rain};
  if (code === 65) return {t:"Heavy Rain", i: ICONS_URL.rain};
  if (code === 66) return {t:"Light Freezing Rain", i: ICONS_URL.sleet};
  if (code === 67) return {t:"Freezing Rain", i: ICONS_URL.sleet};
  if (code === 71) return {t:"Light Snow", i: ICONS_URL.snow};
  if (code === 73) return {t:"Snow", i: ICONS_URL.snow};
  if (code === 75) return {t:"Heavy Snow", i: ICONS_URL.snow};
  if (code === 77) return {t:"Snow Grains", i: ICONS_URL.sleet};
  if (code === 80) return {t:"Light Showers", i: night ? ICONS_URL.partlyRainNight : ICONS_URL.partlyRainDay};
  if (code === 81) return {t:"Showers", i: night ? ICONS_URL.partlyRainNight : ICONS_URL.partlyRainDay};
  if (code === 82) return {t:"Heavy Showers", i: ICONS_URL.rain};
  if (code === 85) return {t:"Light Snow Showers", i: night ? ICONS_URL.partlySnowNight : ICONS_URL.partlySnowDay};
  if (code === 86) return {t:"Snow Showers", i: ICONS_URL.snow};
  if (code === 95) return {t:"Thunderstorm", i: night ? ICONS_URL.thunderstormsNight : ICONS_URL.thunderstormsDay};
  if (code === 96) return {t:"T-Storm + Hail", i: ICONS_URL.thunderstormsRain};
  if (code === 99) return {t:"T-Storm + Heavy Hail", i: ICONS_URL.thunderstormsRain};
  return {t:"Weather", i: ICONS_URL.unknown};
}

  /* =========================================================
     MOON (approx)
     ========================================================= */
  function moonInfo(phase){
    var icon, name;
    if (phase < 0.03 || phase > 0.97){ icon=""; name="New Moon"; }
    else if (phase < 0.22)          { icon=""; name="Waxing Crescent"; }
    else if (phase < 0.28)          { icon=""; name="First Quarter"; }
    else if (phase < 0.45)          { icon=""; name="Waxing Gibbous"; }
    else if (phase < 0.55)          { icon=""; name="Full Moon"; }
    else if (phase < 0.72)          { icon=""; name="Waning Gibbous"; }
    else if (phase < 0.78)          { icon=""; name="Last Quarter"; }
    else                            { icon=""; name="Waning Crescent"; }

    var illum = Math.round((1 - Math.cos(2 * Math.PI * phase)) / 2 * 100);
if (illum >= 98) illum = 100;
if (illum <= 2) illum = 0;
    return { icon:icon, name:name, illum:illum };
  }

  function approximateMoonPhase(date){
  var lp = 2551442.8; // lunar period in seconds (29.53059 days)
  var newMoon = new Date(Date.UTC(2026,0,18,19,52,0)); // Jan 18, 2026 new moon
  var phaseSec = ((date.getTime() - newMoon.getTime())/1000) % lp;
  if (phaseSec < 0) phaseSec += lp;
  return phaseSec / lp;
}

  function findNextMoonEvent(now, targetPhase, daysAhead){
    var best = null;
    var bestErr = Infinity;
    var start = now.getTime();
    var end = start + (daysAhead*86400000);
    for (var t=start; t<=end; t+=3600000){
      var d = new Date(t);
      var ph = approximateMoonPhase(d);
      var err = Math.abs(ph - targetPhase);
      err = Math.min(err, 1-err);
      if (err < bestErr){
        bestErr = err;
        best = d;
      }
    }
    return best;
  }

  /* =========================================================
     NIGHT CLOUD SUMMARY (used for #night-sky-title)
     ========================================================= */
  function classifyCloud(avg){
    if (avg >= 85) return "Cloudy";
    if (avg >= 60) return "Mostly Cloudy";
    if (avg >= 35) return "Partly Cloudy";
    return "Clear";
  }

  function nightCloudLine(hourly, sunsetLocal, sunriseLocal){
    if (!hourly || !hourly.time || !hourly.cloudcover) return "--";
    var sum = 0, n = 0;

    for (var i=0; i<hourly.time.length; i++){
      var dt = new Date(hourly.time[i]);
      if (!isFinite(dt.getTime())) continue;
      if (dt >= sunsetLocal && dt <= sunriseLocal){
        var cc = hourly.cloudcover[i];
        if (typeof cc === "number" && isFinite(cc)){
          sum += cc; n++;
        }
      }
    }
    if (!n) return "--";
    var avg = Math.round(sum / n);
    var label = classifyCloud(avg);
    return label + "  Cloud Coverage : " + avg + "%";
  }

  /* =========================================================
     SPACE EVENTS (simple built-ins)
     ========================================================= */
  var METEOR_SHOWERS = [
    { name:"Quadrantids", peakStart:{m:1,d:3}, peakEnd:{m:1,d:4}, zhr:120, speed:91700, radiant:"Botes", direction:"NE", radiantRise:"1am", bestView:"Pre-dawn 4-6am", ra:230, dec:49 },
    { name:"Lyrids", peakStart:{m:4,d:22}, peakEnd:{m:4,d:22}, zhr:18, speed:109600, radiant:"Lyra", direction:"E", radiantRise:"9pm", bestView:"After midnight", ra:271, dec:34 },
    { name:"Eta Aquariids", peakStart:{m:5,d:5}, peakEnd:{m:5,d:6}, zhr:50, speed:147600, radiant:"Aquarius", direction:"SE", radiantRise:"2am", bestView:"Pre-dawn 3-5am", ra:338, dec:-1 },
    { name:"Delta Aquariids", peakStart:{m:7,d:29}, peakEnd:{m:7,d:30}, zhr:25, speed:91700, radiant:"Aquarius", direction:"S", radiantRise:"10pm", bestView:"After midnight 1-3am", ra:340, dec:-16 },
    { name:"Perseids", peakStart:{m:8,d:12}, peakEnd:{m:8,d:13}, zhr:100, speed:132000, radiant:"Perseus", direction:"NE", radiantRise:"10pm", bestView:"After midnight 2-4am", ra:48, dec:58 },
    { name:"Draconids", peakStart:{m:10,d:8}, peakEnd:{m:10,d:9}, zhr:10, speed:44700, radiant:"Draco", direction:"NW", radiantRise:"Circumpolar", bestView:"Evening 9pm-midnight", ra:262, dec:54 },
    { name:"Orionids", peakStart:{m:10,d:21}, peakEnd:{m:10,d:21}, zhr:20, speed:147600, radiant:"Orion", direction:"SE", radiantRise:"11pm", bestView:"After midnight 2-4am", ra:95, dec:16 },
    { name:"Leonids", peakStart:{m:11,d:17}, peakEnd:{m:11,d:18}, zhr:15, speed:158800, radiant:"Leo", direction:"E", radiantRise:"midnight", bestView:"Pre-dawn 4-6am", ra:152, dec:22 },
    { name:"Geminids", peakStart:{m:12,d:13}, peakEnd:{m:12,d:14}, zhr:150, speed:78300, radiant:"Gemini", direction:"E", radiantRise:"7pm", bestView:"All night, peak 2am", ra:112, dec:33 },
    { name:"Ursids", peakStart:{m:12,d:22}, peakEnd:{m:12,d:23}, zhr:10, speed:73800, radiant:"Ursa Minor", direction:"N", radiantRise:"Circumpolar", bestView:"After midnight", ra:217, dec:76 }
  ];

  function dateInYear(y, m, d){ return new Date(y, m-1, d, 12, 0, 0, 0); }
  function inDays(from, to){ return Math.round((to - from)/86400000); }

  function nextMeteorPeak(now){
    var y = now.getFullYear();
    var best = null;
    for (var i=0;i<METEOR_SHOWERS.length;i++){
      var s = METEOR_SHOWERS[i];
      var ps = dateInYear(y, s.peakStart.m, s.peakStart.d);
      var pe = dateInYear(y, s.peakEnd.m, s.peakEnd.d);
      if (pe < now){
        ps = dateInYear(y+1, s.peakStart.m, s.peakStart.d);
        pe = dateInYear(y+1, s.peakEnd.m, s.peakEnd.d);
      }
      var days = inDays(now, ps);
      if (!best || days < best.days){
        best = { name:s.name, start:ps, end:pe, days:days };
      }
    }
    return best;
  }

  // Lightweight static list (your original behavior)
  var ECLIPSES = [
    { date:"2026-02-17", type:"Solar (Annular)", note:"Path crosses Antarctica. Not visible from North America.", visible:false },
    { date:"2026-03-03", type:"Lunar (Total)", note:"Visible from Americas, Europe, Africa. Totality 00:58 UTC, duration 58 min.", visible:true },
    { date:"2026-08-12", type:"Solar (Total)", note:"Path crosses Arctic, Greenland, Iceland, Spain. Partial visible from NE USA at sunrise.", visible:"partial" },
    { date:"2026-08-28", type:"Lunar (Partial)", note:"Visible from Pacific, Americas, Europe, Africa. Max eclipse 04:13 UTC, 93% coverage.", visible:true }
  ];

  function nextEclipse(now){
    for (var i=0;i<ECLIPSES.length;i++){
      var d = new Date(ECLIPSES[i].date + "T00:00:00");
      if (isFinite(d.getTime()) && d >= now){
        return { d:d, type:ECLIPSES[i].type, note:ECLIPSES[i].note };
      }
    }
    return null;
  }

  // Planetary conjunctions 2026 (within 1 or notable)
  var CONJUNCTIONS = [
    { date:"2026-01-25", bodies:"Saturn + Mercury", separation:"0.5", direction:"SW", time:"Dusk", note:"Very low on horizon, challenging" },
    { date:"2026-02-13", bodies:"Venus + Saturn", separation:"0.8", direction:"SW", time:"Dusk", note:"Bright pair after sunset" },
    { date:"2026-02-28", bodies:"Venus + Mercury", separation:"1.2", direction:"W", time:"Dusk", note:"Mercury at max elongation" },
    { date:"2026-03-16", bodies:"Mars + Moon", separation:"0.5", direction:"E", time:"Evening", note:"Close pass, Mars bright at magnitude +0.8" },
    { date:"2026-06-04", bodies:"Jupiter + Mercury", separation:"0.9", direction:"E", time:"Dawn", note:"Low in morning twilight" },
    { date:"2026-07-12", bodies:"Venus + Mars", separation:"1.0", direction:"W", time:"Dusk", note:"Striking color contrast" },
    { date:"2026-08-20", bodies:"Moon + Saturn", separation:"0.3", direction:"SE", time:"Night", note:"Very close, possible occultation" },
    { date:"2026-10-26", bodies:"Venus + Saturn", separation:"0.6", direction:"SW", time:"Dusk", note:"Brilliant pair" },
    { date:"2026-11-17", bodies:"Jupiter + Moon", separation:"0.8", direction:"E", time:"Night", note:"Bright pair all night" },
    { date:"2026-12-08", bodies:"Mars + Jupiter", separation:"0.9", direction:"E", time:"Night", note:"Two bright planets, easy target" }
  ];

  function nextConjunction(now){
    for (var i=0;i<CONJUNCTIONS.length;i++){
      var d = new Date(CONJUNCTIONS[i].date + "T00:00:00");
      if (isFinite(d.getTime()) && d >= now){
        var c = CONJUNCTIONS[i];
        return { d:d, bodies:c.bodies, separation:c.separation, direction:c.direction, time:c.time, note:c.note };
      }
    }
    return null;
  }

  // Planetary oppositions 2026 (outer planets closest/brightest)
  var OPPOSITIONS = [
    { date:"2026-02-19", planet:"Mars", magnitude:"-1.2", constellation:"Leo", note:"Closest approach, 63 million mi (0.68 AU), visible all night" },
    { date:"2026-09-21", planet:"Saturn", magnitude:"+0.4", constellation:"Pisces", note:"Rings visible in small telescope, 8.9 AU (827 million mi)" },
    { date:"2026-10-03", planet:"Neptune", magnitude:"+7.8", constellation:"Pisces", note:"Requires binoculars or telescope, 28.9 AU" },
    { date:"2026-11-09", planet:"Uranus", magnitude:"+5.6", constellation:"Taurus", note:"Barely naked-eye from dark sites, 17.2 AU" },
    { date:"2026-12-12", planet:"Jupiter", magnitude:"-2.8", constellation:"Taurus", note:"Brightest object after Moon, 4.0 AU (372 million mi)" }
  ];

  function nextOpposition(now){
    for (var i=0;i<OPPOSITIONS.length;i++){
      var d = new Date(OPPOSITIONS[i].date + "T00:00:00");
      if (isFinite(d.getTime()) && d >= now){
        var o = OPPOSITIONS[i];
        return { d:d, planet:o.planet, magnitude:o.magnitude, constellation:o.constellation, note:o.note };
      }
    }
    return null;
  }

  function bulletHtml(title, time, sub){
    return (
      '<div class="bullet">' +
        '<div class="btop"><span class="bname">'+title+'</span><span class="btime">'+time+'</span></div>' +
        (sub ? ('<div class="bsub">'+sub+'</div>') : '') +
      '</div>'
    );
  }

function daysUntil(from, to){
  if (!from || !to || !isFinite(from.getTime()) || !isFinite(to.getTime())) return 0;
  return Math.max(0, Math.round((to.getTime() - from.getTime()) / 86400000));
}

function dayRangeAround(d, days){
  if (!d || !isFinite(d.getTime())) return days + " days";
  var now = new Date();
  var diff = Math.round((d.getTime() - now.getTime()) / 86400000);
  var start = diff - days;
  var end = diff + days;
  if (start < 0) start = 0;
  return start + "-" + end + " days";
}

  /* =========================================================
     SVG HELPERS (Night sky bar)
     ========================================================= */
  /* Planet colors for TODAY Timeline */
  var TODAY_TL_PLANET_COLORS = {
    Moon:    "rgba(255,255,255,0.90)",
    Mercury: "#9A9A9A",
    Venus:   "#FFE5B4",
    Mars:    "#C44D2A",
    Jupiter: "#E8A954",
    Saturn:  "#F0C75E",
    Uranus:  "#8ECAE6",
    Neptune: "#4AA3DF"
  };

  var SKY_COLORS = {
    Moon:    "rgba(255,255,255,0.95)",
    Mercury: "#9A9A9A",
    Venus:   "#FFE5B4",
    Mars:    "#C44D2A",
    Jupiter: "#E8A954",
    Saturn:  "#F0C75E",
    Uranus:  "#8ECAE6",
    Neptune: "#4AA3DF"
  };

  function svgEl(tag){
    return document.createElementNS("http://www.w3.org/2000/svg", tag);
  }
  function clearSvg(svg){
    while (svg && svg.firstChild) svg.removeChild(svg.firstChild);
  }

  // Kp index color scale (matches SWPC official colors exactly)
  function getKpColor(kp){
    // Round to nearest level for color selection
    var level = Math.round(kp);
    
    switch(level){
      case 0:  return "rgba(0,153,51,0.90)";
      case 1:  return "rgba(51,204,51,0.90)";
      case 2:  return "rgba(102,204,51,0.90)";
      case 3:  return "rgba(153,204,51,0.90)";
      case 4:  return "rgba(204,204,51,0.90)";
      case 5:  return "rgba(255,255,0,0.90)";
      case 6:  return "rgba(255,204,0,0.90)";
      case 7:  return "rgba(255,153,0,0.90)";
      case 8:  return "rgba(255,51,51,0.90)";
      case 9:  return "rgba(204,0,51,0.90)";
      default: return "rgba(102,204,51,0.90)";
    }
  }

  function drawNightSkyBar(svg, legendEl, sunsetLocal, sunriseLocal, windowsByBody, cloudSeries, kpSeries){
    if (!svg) return;

    clearSvg(svg);

    var W = 1000, H = 170;
    var padL = 22, padR = 22, padT = 28, padB = 38;
    var x0 = padL, x1 = W - padR;
    var y0 = padT, y1 = H - padB;

    var total = Math.max(1, sunriseLocal.getTime() - sunsetLocal.getTime());
    function xForTime(dt){
      var t = clamp(dt.getTime() - sunsetLocal.getTime(), 0, total);
      return x0 + (t / total) * (x1 - x0);
    }

    // Aurora/Kp bar (top bar)
    var kpBarH = 12;
    var kpBarY = 4;
    var kpBarX = x0;
    var kpBarW = (x1 - x0);

    function makeKpBarFrame(){
      var r = svgEl("rect");
      r.setAttribute("x", String(kpBarX));
      r.setAttribute("y", String(kpBarY));
      r.setAttribute("width", String(kpBarW));
      r.setAttribute("height", String(kpBarH));
      r.setAttribute("fill", "rgba(43,34,244,0.06)");
      r.setAttribute("fill-opacity", "1");
      r.setAttribute("stroke", "rgba(43,34,244,0.12)");
      r.setAttribute("stroke-opacity", "1");
      r.setAttribute("stroke-width", "1");
      r.setAttribute("rx", "5");
      return r;
    }

    svg.appendChild(makeKpBarFrame());

    // Draw Kp data segments
    if (kpSeries && kpSeries.length){
      kpSeries.sort(function(a,b){ return a.t - b.t; });

      for (var k=0; k<kpSeries.length; k++){
        var a = kpSeries[k];
        var b = (k < kpSeries.length-1) ? kpSeries[k+1] : null;

        var xa = xForTime(a.t);
        var xb = b ? xForTime(b.t) : x1;
        if (xa < x0) xa = x0;
        if (xb > x1) xb = x1;
        if (xb - xa < 1) continue;

        var kp = clamp(a.kp, 0, 9);

        var seg = svgEl("rect");
        seg.setAttribute("x", String(xa));
        seg.setAttribute("y", String(kpBarY));
        seg.setAttribute("width", String(xb - xa));
        seg.setAttribute("height", String(kpBarH));
        seg.setAttribute("fill", getKpColor(kp));
        seg.setAttribute("fill-opacity", "1");
        seg.setAttribute("shape-rendering", "crispEdges");
        svg.appendChild(seg);
      }

      // Re-draw frame on top
      svg.appendChild(makeKpBarFrame());
    }

    // Add Kp label
    var kpLabel = svgEl("text");
    kpLabel.textContent = "Kp";
    kpLabel.setAttribute("x", String(x0 - 6));
    kpLabel.setAttribute("y", String(kpBarY + kpBarH/2 + 3));
    kpLabel.setAttribute("fill", "rgba(43,34,244,0.50)");
    kpLabel.setAttribute("font-size", "9");
    kpLabel.setAttribute("font-weight", "700");
    kpLabel.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
    kpLabel.setAttribute("text-anchor", "end");
    svg.appendChild(kpLabel);

    // cloud bar frame (shifted down)
    var barH = 12;
    var barY = kpBarY + kpBarH + 4;
    var barX = x0;
    var barW = (x1 - x0);

    function makeBarFrame(){
      var r = svgEl("rect");
      r.setAttribute("x", String(barX));
      r.setAttribute("y", String(barY));
      r.setAttribute("width", String(barW));
      r.setAttribute("height", String(barH));
      r.setAttribute("fill", "rgba(43,34,244,0.06)");
      r.setAttribute("fill-opacity", "1");
      r.setAttribute("stroke", "rgba(43,34,244,0.12)");
      r.setAttribute("stroke-opacity", "1");
      r.setAttribute("stroke-width", "1");
      r.setAttribute("rx", "5");
      return r;
    }

    svg.appendChild(makeBarFrame());

    // Add Cloud label
    var cloudLabel = svgEl("text");
    cloudLabel.textContent = "";
    cloudLabel.setAttribute("x", String(x0 - 6));
    cloudLabel.setAttribute("y", String(barY + barH/2 + 4));
    cloudLabel.setAttribute("fill", "rgba(43,34,244,0.50)");
    cloudLabel.setAttribute("font-size", "10");
    cloudLabel.setAttribute("font-weight", "400");
    cloudLabel.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
    cloudLabel.setAttribute("text-anchor", "end");
    svg.appendChild(cloudLabel);

    if (cloudSeries && cloudSeries.length){
      cloudSeries.sort(function(a,b){ return a.t - b.t; });

      function cloudColor(cc){
        if (cc < 10) return "rgba(255,255,255,0.90)";   // White - clear skies
        if (cc < 30) return "rgba(200,200,200,0.70)";   // Light grey
        if (cc < 55) return "rgba(140,140,140,0.65)";   // Grey
        if (cc < 80) return "rgba(90,90,90,0.60)";      // Dark grey
        return "rgba(45,45,45,0.55)";                    // Dark dark grey
      }
    

      for (var c=0; c<cloudSeries.length; c++){
        var a = cloudSeries[c];
        var b = (c < cloudSeries.length-1) ? cloudSeries[c+1] : null;

        var xa = xForTime(a.t);
        var xb = b ? xForTime(b.t) : x1;
        if (xb - xa < 1) xb = xa + 1;

        var cc = clamp(a.cc, 0, 100);

        var seg = svgEl("rect");
        seg.setAttribute("x", String(xa));
        seg.setAttribute("y", String(barY));
        seg.setAttribute("width", String(xb - xa));
        seg.setAttribute("height", String(barH));
        seg.setAttribute("fill", cloudColor(cc));
        seg.setAttribute("shape-rendering", "crispEdges");
        svg.appendChild(seg);
      }

      svg.appendChild(makeBarFrame());
    }

    // Adjust body area to account for bars
    y0 = barY + barH + 8;

    // grid
    var steps = 8;
    for (var i=0;i<=steps;i++){
      var gx = x0 + (i/steps)*(x1-x0);
      var line = svgEl("line");
      line.setAttribute("x1", gx); line.setAttribute("x2", gx);
      line.setAttribute("y1", y0); line.setAttribute("y2", y1);
      line.setAttribute("stroke", "rgba(43,34,244,0.12)");
      line.setAttribute("stroke-opacity", "1");
      line.setAttribute("stroke-width", "1");
      svg.appendChild(line);
    }

    function addLabel(txt, x, anchor){
      var t = svgEl("text");
      t.textContent = txt;
      t.setAttribute("x", String(x));
      t.setAttribute("y", String(H-10));
      t.setAttribute("fill", "rgba(43,34,244,0.50)");
      t.setAttribute("fill-opacity", "1");
      t.setAttribute("font-size", "13");
      t.setAttribute("font-weight", "500");
      t.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
      t.setAttribute("text-anchor", anchor || "middle");
      svg.appendChild(t);
    }

    // Hourly labels
    var startHour = new Date(sunsetLocal);
    startHour.setMinutes(0, 0, 0);
    if (startHour < sunsetLocal) startHour.setHours(startHour.getHours() + 1);
    
    for (var labelTime = startHour.getTime(); labelTime <= sunriseLocal.getTime(); labelTime += 3600000) {
      var labelDate = new Date(labelTime);
      var labelX = xForTime(labelDate);
      if (labelX >= x0 && labelX <= x1) {
        var anchor = "middle";
        if (labelX < x0 + 30) anchor = "start";
        if (labelX > x1 - 30) anchor = "end";
        addLabel(fmt12NoSuffixFromDate(labelDate), labelX, anchor);
      }
    }

    // Bodies in fixed order
    var ORDER = ["Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune"];
    var bodies = [];
    for (var oi=0; oi<ORDER.length; oi++){
      var k = ORDER[oi];
      if (windowsByBody && windowsByBody[k]) bodies.push(k);
    }

    var rows = bodies.length;
    var rowH = (y1 - y0) / Math.max(1, rows);
    var arcAmp = Math.min(46, rowH * 0.85);

    for (var r=0;r<bodies.length;r++){
      var body = bodies[r];
      var w = windowsByBody[body];

      var baseY = y0 + (r + 0.5)*rowH;
      var color = SKY_COLORS[body] || "#d8dee9";

      if (!w || !w.any || !w.first || !w.last){
        // Not visible - thin dashed line
        var off = svgEl("line");
        off.setAttribute("x1", String(x0));
        off.setAttribute("x2", String(x1));
        off.setAttribute("y1", String(baseY));
        off.setAttribute("y2", String(baseY));
        off.setAttribute("stroke", color);
        off.setAttribute("stroke-width", "2");
        off.setAttribute("stroke-dasharray", "4 6");
        off.setAttribute("opacity", "0.15");
        svg.appendChild(off);
        continue;
      }

      // Draw segmented bar based on altitude thresholds
      var segments = w.segments || [];
      
      for (var s = 0; s < segments.length; s++){
        var seg = segments[s];
        var sx1 = xForTime(seg.start);
        var sx2 = xForTime(seg.end);
        if (sx2 - sx1 < 2) sx2 = sx1 + 2;
        
        var segLine = svgEl("line");
        segLine.setAttribute("x1", String(sx1));
        segLine.setAttribute("x2", String(sx2));
        segLine.setAttribute("y1", String(baseY));
        segLine.setAttribute("y2", String(baseY));
        segLine.setAttribute("stroke", color);
        segLine.setAttribute("stroke-width", "6");
        segLine.setAttribute("stroke-linecap", "round");
        
        if (seg.belowTreeline){
          // Below 15 - dashed/textured
          segLine.setAttribute("stroke-dasharray", "3 4");
          segLine.setAttribute("opacity", "0.45");
        } else {
          // Above 15 - solid
          segLine.setAttribute("opacity", "0.85");
        }
        
        svg.appendChild(segLine);
      }
    }

    // NOW marker
    var now = new Date();
    if (now >= sunsetLocal && now <= sunriseLocal){
      var nowX = xForTime(now);
      var nowLine = svgEl("line");
      nowLine.setAttribute("x1", String(nowX));
      nowLine.setAttribute("x2", String(nowX));
      nowLine.setAttribute("y1", String(kpBarY));
      nowLine.setAttribute("y2", String(y1));
      nowLine.setAttribute("stroke", "rgba(43,34,244,0.7)");
      nowLine.setAttribute("stroke-width", "2");
      nowLine.setAttribute("stroke-dasharray", "4 3");
      svg.appendChild(nowLine);
      
      // Small "NOW" label at top
      var nowLabel = svgEl("text");
      nowLabel.textContent = "NOW";
      nowLabel.setAttribute("x", String(nowX));
      nowLabel.setAttribute("y", String(barY - 2));
      nowLabel.setAttribute("fill", "rgba(43,34,244,0.7)");
      nowLabel.setAttribute("font-size", "9");
      nowLabel.setAttribute("font-weight", "700");
      nowLabel.setAttribute("font-family", "system-ui, -apple-system, Segoe UI, sans-serif");
      nowLabel.setAttribute("text-anchor", "middle");
      svg.appendChild(nowLabel);
    }

    // Legend
    if (legendEl){
      var legHtml = "";
      
      // Kp scale legend (all 10 levels with SWPC colors)
      legHtml += '<span class="nightsky-item" style="gap:2px;padding:4px 8px;">' +
        '<span style="font-size:.58rem;font-weight:800;color:rgba(43,34,244,.65);margin-right:3px;">Kp</span>' +
        '<span style="font-size:.5rem;font-weight:700;color:rgba(43,34,244,.45);margin-right:2px;">0</span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(0,153,51,0.90);" title="Kp 0"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(51,204,51,0.90);" title="Kp 1"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(102,204,51,0.90);" title="Kp 2"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(153,204,51,0.90);" title="Kp 3"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(204,204,51,0.90);" title="Kp 4"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,255,0,0.90);" title="Kp 5 (G1)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,204,0,0.90);" title="Kp 6 (G2)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,153,0,0.90);" title="Kp 7 (G3)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(255,51,51,0.90);" title="Kp 8 (G4)"></span>' +
        '<span style="width:10px;height:10px;border-radius:2px;background:rgba(204,0,51,0.90);" title="Kp 9 (G5)"></span>' +
        '<span style="font-size:.5rem;font-weight:700;color:rgba(43,34,244,.45);margin-left:2px;">9</span>' +
        '</span>';
      
      // Get moon image URL for legend
      var now = new Date();
      var year = now.getFullYear();
      var startOfYear = new Date(year, 0, 1);
      var hourOfYear = Math.floor((now - startOfYear) / (1000 * 60 * 60)) + 1;
      var yearDiff = year - 2024;
      var offsetHours = Math.round(yearDiff * 264);
      var adjustedHour = ((hourOfYear - offsetHours) % 8760);
      if (adjustedHour <= 0) adjustedHour += 8760;
      var frameNum = String(Math.max(1, Math.min(8760, adjustedHour))).padStart(4, '0');
      var moonLegendUrl = "https://svs.gsfc.nasa.gov/vis/a000000/a005000/a005048/frames/730x730_1x1_30p/moon." + frameNum + ".jpg";
      
      for (var li=0; li<bodies.length; li++){
        var b2 = bodies[li];
        var c2 = SKY_COLORS[b2] || "#d8dee9";
        var w2 = windowsByBody[b2];
        var offClass = (!w2 || !w2.any) ? " is-off" : "";
        
        if (b2 === "Moon"){
          // Use moon image instead of dot with clip-path to remove black border
          // Wrap in container to prevent pill from growing
          legHtml +=
            '<span class="nightsky-item'+offClass+'">' +
              '<span style="width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;border-radius:50%;">' +
                '<img src="'+moonLegendUrl+'" style="width:34px;height:34px;border-radius:50%;object-fit:cover;transform:scale(1.19);clip-path:circle(42%);" alt="Moon" />' +
              '</span>' +
              '<span>'+b2+'</span>' +
            '</span>';
        } else {
          legHtml +=
            '<span class="nightsky-item'+offClass+'">' +
              '<span class="nightsky-dot" style="background:'+c2+'"></span>' +
              '<span>'+b2+'</span>' +
            '</span>';
        }
      }
      legendEl.innerHTML = legHtml;
    }
  }

  /* =========================================================
     PLANET / MOON ALT-AZ (minimal)
     ========================================================= */
  function rad(d){ return d*Math.PI/180; }
  function deg(r){ return r*180/Math.PI; }
  function fixAngle(a){ a = a % 360; if (a<0) a+=360; return a; }

  function julianDay(date){
    var y = date.getUTCFullYear();
    var m = date.getUTCMonth()+1;
    var D = date.getUTCDate() + (date.getUTCHours() + date.getUTCMinutes()/60 + date.getUTCSeconds()/3600)/24;
    if (m <= 2){ y -= 1; m += 12; }
    var A = Math.floor(y/100);
    var B = 2 - A + Math.floor(A/4);
    return Math.floor(365.25*(y+4716)) + Math.floor(30.6001*(m+1)) + D + B - 1524.5;
  }
  function daysSinceJ2000(date){ return julianDay(date) - 2451545.0; }

  var ORB = {
    sun:     { w:[282.9404,4.70935E-5], a:[1,0],        e:[0.016709,-1.151E-9], M:[356.0470,0.9856002585] },
    mercury: { N:[48.3313,3.24587E-5], i:[7.0047,5.00E-8], w:[29.1241,1.01444E-5], a:[0.387098,0], e:[0.205635,5.59E-10], M:[168.6562,4.0923344368] },
    venus:   { N:[76.6799,2.46590E-5], i:[3.3946,2.75E-8], w:[54.8910,1.38374E-5], a:[0.723330,0], e:[0.006773,-1.302E-9], M:[48.0052,1.6021302244] },
    mars:    { N:[49.5574,2.11081E-5], i:[1.8497,-1.78E-8], w:[286.5016,2.92961E-5], a:[1.523688,0], e:[0.093405,2.516E-9], M:[18.6021,0.5240207766] },
    jupiter: { N:[100.4542,2.76854E-5], i:[1.3030,-1.557E-7], w:[273.8777,1.64505E-5], a:[5.20256,0],  e:[0.048498,4.469E-9], M:[19.8950,0.0830853001] },
    saturn:  { N:[113.6634,2.38980E-5], i:[2.4886,-1.081E-7], w:[339.3939,2.97661E-5], a:[9.55475,0],  e:[0.055546,-9.499E-9], M:[316.9670,0.0334442282] },
    uranus:  { N:[74.0005,1.3978E-5],  i:[0.7733,1.9E-8],    w:[96.6612,3.0565E-5],   a:[19.18171,-1.55E-8], e:[0.047318,7.45E-9],  M:[142.5905,0.011725806] },
    neptune: { N:[131.7806,3.0173E-5], i:[1.7700,-2.55E-7], w:[272.8461,-6.027E-6],  a:[30.05826,3.313E-8], e:[0.008606,2.15E-9],  M:[260.2471,0.005995147] }
  };

  function kepler(M, e){
    var E = M;
    for (var i=0;i<10;i++){
      var dE = (E - e*Math.sin(E) - M) / (1 - e*Math.cos(E));
      E -= dE;
      if (Math.abs(dE) < 1e-6) break;
    }
    return E;
  }

  function heliocentricEcliptic(body, d){
    var el = ORB[body];
    var N = rad(fixAngle(el.N[0] + el.N[1]*d));
    var i = rad(el.i[0] + el.i[1]*d);
    var w = rad(fixAngle(el.w[0] + el.w[1]*d));
    var a = el.a[0] + el.a[1]*d;
    var e = el.e[0] + el.e[1]*d;
    var M = rad(fixAngle(el.M[0] + el.M[1]*d));
    var E = kepler(M, e);

    var xv = a*(Math.cos(E) - e);
    var yv = a*(Math.sqrt(1 - e*e) * Math.sin(E));
    var v = Math.atan2(yv, xv);
    var r = Math.sqrt(xv*xv + yv*yv);

    var xh = r*(Math.cos(N)*Math.cos(v+w) - Math.sin(N)*Math.sin(v+w)*Math.cos(i));
    var yh = r*(Math.sin(N)*Math.cos(v+w) + Math.cos(N)*Math.sin(v+w)*Math.cos(i));
    var zh = r*(Math.sin(v+w)*Math.sin(i));
    return { x:xh, y:yh, z:zh, r:r };
  }

  function sunEcliptic(d){
    var el = ORB.sun;
    var w = rad(fixAngle(el.w[0] + el.w[1]*d));
    var e = el.e[0] + el.e[1]*d;
    var M = rad(fixAngle(el.M[0] + el.M[1]*d));
    var E = kepler(M, e);
    var xv = (Math.cos(E) - e);
    var yv = (Math.sqrt(1 - e*e) * Math.sin(E));
    var v = Math.atan2(yv, xv);
    var r = Math.sqrt(xv*xv + yv*yv);
    var lon = v + w;
    return { x:r*Math.cos(lon), y:r*Math.sin(lon), z:0, r:r, lon:lon };
  }

  function eclToEqu(x, y, z, d){
    var eps = rad(23.4393 - 3.563E-7*d);
    return {
      x:x,
      y:y*Math.cos(eps) - z*Math.sin(eps),
      z:y*Math.sin(eps) + z*Math.cos(eps)
    };
  }

  function raDecFromEqu(eq){
    var ra = Math.atan2(eq.y, eq.x);
    if (ra < 0) ra += 2*Math.PI;
    var dec = Math.atan2(eq.z, Math.sqrt(eq.x*eq.x + eq.y*eq.y));
    return { ra:ra, dec:dec };
  }

  function localSiderealTime(date, lonDeg){
    var JD = julianDay(date);
    var T = (JD - 2451545.0)/36525.0;
    var GMST = 280.46061837 + 360.98564736629*(JD - 2451545.0) + 0.000387933*T*T - (T*T*T)/38710000.0;
    GMST = fixAngle(GMST);
    return rad(fixAngle(GMST + lonDeg));
  }

  function altAz(ra, dec, date, latDeg, lonDeg){
    var lst = localSiderealTime(date, lonDeg);
    var H = lst - ra;
    while (H < -Math.PI) H += 2*Math.PI;
    while (H >  Math.PI) H -= 2*Math.PI;

    var lat = rad(latDeg);
    var sinAlt = Math.sin(dec)*Math.sin(lat) + Math.cos(dec)*Math.cos(lat)*Math.cos(H);
    var alt = Math.asin(sinAlt);

    var cosAz = (Math.sin(dec) - Math.sin(alt)*Math.sin(lat)) / (Math.cos(alt)*Math.cos(lat));
    cosAz = Math.max(-1, Math.min(1, cosAz));
    var az = Math.acos(cosAz);
    if (Math.sin(H) > 0) az = 2*Math.PI - az;

    return { alt:alt, az:az };
  }

  function planetRaDec(body, date){
    var d = daysSinceJ2000(date);
    var sun = sunEcliptic(d);
    var xe = -sun.x, ye = -sun.y, ze = -sun.z;
    var p = heliocentricEcliptic(body, d);
    var xg = p.x - xe;
    var yg = p.y - ye;
    var zg = p.z - ze;
    return raDecFromEqu(eclToEqu(xg, yg, zg, d));
  }

  function moonRaDec(date){
    var d = daysSinceJ2000(date);
    var N = rad(fixAngle(125.1228 - 0.0529538083 * d));
    var i = rad(5.1454);
    var w = rad(fixAngle(318.0634 + 0.1643573223 * d));
    var a = 60.2666, e = 0.054900;
    var M = rad(fixAngle(115.3654 + 13.0649929509 * d));
    var E = kepler(M, e);

    var xv = a * (Math.cos(E) - e);
    var yv = a * (Math.sqrt(1 - e*e) * Math.sin(E));
    var v  = Math.atan2(yv, xv);
    var r  = Math.sqrt(xv*xv + yv*yv);

    var xh = r * (Math.cos(N)*Math.cos(v+w) - Math.sin(N)*Math.sin(v+w)*Math.cos(i));
    var yh = r * (Math.sin(N)*Math.cos(v+w) + Math.cos(N)*Math.sin(v+w)*Math.cos(i));
    var zh = r * (Math.sin(v+w) * Math.sin(i));

    return raDecFromEqu(eclToEqu(xh, yh, zh, d));
  }

  function computeVisibilityWindows(dateStartLocal, dateEndLocal, bodies, lat, lon){
    var stepMs = 15*60*1000; // 15 min steps for smoother segments
    var minAltDeg = 5;
    var treelineAlt = 15;
    var windows = {};
    
    for (var b=0;b<bodies.length;b++){
      windows[bodies[b]] = { any:false, maxAlt:-999, first:null, last:null, segments:[], altData:[] };
    }

    // First pass: collect altitude data
    for (var t=dateStartLocal.getTime(); t<=dateEndLocal.getTime(); t+=stepMs){
      var dtLocal = new Date(t);
      for (var i=0;i<bodies.length;i++){
        var body = bodies[i];
        var rd = (body === "moon") ? moonRaDec(dtLocal) : planetRaDec(body, dtLocal);
        var aa = altAz(rd.ra, rd.dec, dtLocal, lat, lon);
        var altD = deg(aa.alt);
        var w = windows[body];
        
        if (altD > w.maxAlt) w.maxAlt = altD;
        
        if (altD >= minAltDeg){
          if (!w.any){ w.any = true; w.first = new Date(t); }
          w.last = new Date(t);
          w.altData.push({ time: new Date(t), alt: altD, belowTreeline: altD < treelineAlt });
        }
      }
    }

    // Second pass: build segments from altitude data
    for (var b=0;b<bodies.length;b++){
      var body = bodies[b];
      var w = windows[body];
      
      if (!w.altData.length) continue;
      
      var currentSeg = null;
      
      for (var d=0; d<w.altData.length; d++){
        var pt = w.altData[d];
        
        if (!currentSeg){
          currentSeg = { start: pt.time, end: pt.time, belowTreeline: pt.belowTreeline };
        } else if (pt.belowTreeline === currentSeg.belowTreeline){
          currentSeg.end = pt.time;
        } else {
          w.segments.push(currentSeg);
          currentSeg = { start: pt.time, end: pt.time, belowTreeline: pt.belowTreeline };
        }
      }
      
      if (currentSeg){
        w.segments.push(currentSeg);
      }
    }
    
    return windows;
  }

  /* =========================================================
     SOLAR MATH (NOAA-style approx) for sunbar
     ========================================================= */
  

  function _dayOfYearLocal(d){
    var start = new Date(d.getFullYear(), 0, 1);
    return Math.floor((d - start) / 86400000) + 1;
  }

  function _solarTerms(dLocal){
    var doy = _dayOfYearLocal(dLocal);
    var hr  = dLocal.getHours() + dLocal.getMinutes()/60 + dLocal.getSeconds()/3600;
    var gamma = 2 * Math.PI / 365 * (doy - 1 + (hr - 12) / 24);

    var eqtime =
      229.18 * (
        0.000075 +
        0.001868 * Math.cos(gamma) -
        0.032077 * Math.sin(gamma) -
        0.014615 * Math.cos(2 * gamma) -
        0.040849 * Math.sin(2 * gamma)
      );

    var decl =
      0.006918 -
      0.399912 * Math.cos(gamma) +
      0.070257 * Math.sin(gamma) -
      0.006758 * Math.cos(2 * gamma) +
      0.000907 * Math.sin(2 * gamma) -
      0.002697 * Math.cos(3 * gamma) +
      0.00148  * Math.sin(3 * gamma);

    return { eqtime:eqtime, decl:decl };
  }

  function _minsLocal(d){ return d.getHours()*60 + d.getMinutes() + d.getSeconds()/60; }
  function _tzOffsetMinutes(dLocal){ return dLocal.getTimezoneOffset(); }

  function solarNoonLocal(dayLocal, latDeg, lonDeg){
    var terms = _solarTerms(dayLocal);
    var tzMin = _tzOffsetMinutes(dayLocal);
    var tzHr  = -tzMin / 60;

    var timeOffset = terms.eqtime + 4*lonDeg - 60*tzHr;
    var solarNoonMin = 720 - timeOffset;

    var base = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0,0,0,0);
    return new Date(base.getTime() + solarNoonMin * 60000);
  }

  function solarEventTimeLocal(dayLocal, latDeg, lonDeg, altitudeDeg, isDawn){
    var terms = _solarTerms(dayLocal);
    var decl = terms.decl;

    var lat = rad(latDeg);
    var alt = rad(altitudeDeg);

    var cosH =
      (Math.sin(alt) - Math.sin(lat)*Math.sin(decl)) /
      (Math.cos(lat)*Math.cos(decl));

    if (!isFinite(cosH) || cosH < -1 || cosH > 1) return null;

    cosH = clamp(cosH, -1, 1);
    var H = Math.acos(cosH);

    var Hdeg = deg(H);
    var deltaMin = 4 * Hdeg;

    var noon = solarNoonLocal(dayLocal, latDeg, lonDeg);
    var noonMin = _minsLocal(noon);

    var eventMin = isDawn ? (noonMin - deltaMin) : (noonMin + deltaMin);

    var base = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0,0,0,0);
    return new Date(base.getTime() + eventMin * 60000);
  }

  /* =========================================================
     TODAY TIMELINE RENDER (v4/v5 integrated widget)
     ========================================================= */
  function renderTodayTimeline(hourly, daily, nearestIndex, kpData){
    // DOM refs
    var tlSunrise = document.getElementById("today-tl-sunrise");
    var tlSunset = document.getElementById("today-tl-sunset");
    var tlGoldenAm = document.getElementById("today-tl-golden-am");
    var tlGoldenPm = document.getElementById("today-tl-golden-pm");
    var tlDaylight = document.getElementById("today-tl-daylight");
    var tlDaylightChange = document.getElementById("today-tl-daylight-change");
    var tlSky = document.getElementById("today-tl-sky");
    var tlCloud = document.getElementById("today-tl-cloud");
    var tlMoon = document.getElementById("today-tl-moon");
    var tlKpTrack = document.getElementById("today-tl-kp-track");
    var tlCloudTrack = document.getElementById("today-tl-cloud-track");
    var tlSkyBands = document.getElementById("today-tl-sky-bands");
    var tlPlanetTracks = document.getElementById("today-tl-planet-tracks");
    var tlWeatherRow = document.getElementById("today-tl-weather-row");
    var tlNowMarker = document.getElementById("today-tl-now-marker");
    var tlNowTemp = document.getElementById("today-tl-now-temp");
    var tlNowTime = document.getElementById("today-tl-now-time");

    if (!daily || !daily.sunrise || !daily.sunset) return;

    var srIso = daily.sunrise[0];
    var ssIso = daily.sunset[0];
    var srDate = new Date(srIso);
    var ssDate = new Date(ssIso);

    // Calculate solar events
    var dayLocal = new Date(srDate.getFullYear(), srDate.getMonth(), srDate.getDate(), 12, 0, 0, 0);
    
    var astroDawn = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, true);
    var astroDusk = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, false);
    var blueAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, true);
    var blueAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var bluePmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var bluePmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, false);
    var goldenAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var goldenAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, true);
    var goldenPmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, false);
    var goldenPmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var noon = solarNoonLocal(dayLocal, LOCATION.lat, LOCATION.lon);

    // Update header metadata
    if (tlSunrise) tlSunrise.textContent = fmt12NoSuffix(srIso);
    if (tlSunset) tlSunset.textContent = fmt12NoSuffix(ssIso);
    if (tlGoldenAm) {
      if (goldenAmStart && goldenAmEnd) {
        tlGoldenAm.textContent = fmt12NoSuffixFromDate(goldenAmStart) + "  " + fmt12NoSuffixFromDate(goldenAmEnd);
      } else {
        tlGoldenAm.textContent = "--";
      }
    }
    if (tlGoldenPm) {
      if (goldenPmStart && goldenPmEnd) {
        tlGoldenPm.textContent = fmt12NoSuffixFromDate(goldenPmStart) + "  " + fmt12NoSuffixFromDate(goldenPmEnd);
      } else {
        tlGoldenPm.textContent = "--";
      }
    }

    // Calculate daylight duration
    var daylightMs = ssDate.getTime() - srDate.getTime();
    var daylightHours = Math.floor(daylightMs / (1000 * 60 * 60));
    var daylightMins = Math.floor((daylightMs % (1000 * 60 * 60)) / (1000 * 60));
    if (tlDaylight) tlDaylight.textContent = daylightHours + "h " + daylightMins + "m";

    // Calculate daylight change from yesterday
    if (tlDaylightChange){
      var yesterdayLocal = new Date(dayLocal.getTime() - 86400000);
      var srYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, true);
      var ssYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, false);
      
      if (srYesterday && ssYesterday){
        var yesterdayMs = ssYesterday.getTime() - srYesterday.getTime();
        var diffMs = daylightMs - yesterdayMs;
        var diffSecs = Math.round(diffMs / 1000);
        var diffMins = Math.floor(Math.abs(diffSecs) / 60);
        var remainSecs = Math.abs(diffSecs) % 60;
        
        var sign = diffSecs >= 0 ? "+" : "-";
        var timeStr = diffMins > 0 ? (sign + diffMins + "m " + remainSecs + "s") : (sign + remainSecs + "s");
        
        if (diffSecs > 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(80,180,80,1)";
        } else if (diffSecs < 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(200,100,80,1)";
        } else {
          tlDaylightChange.textContent = "(+0s)";
          tlDaylightChange.style.color = "rgba(43,34,244,.60)";
        }
      }
    }

    // Sky condition and cloud %
    var weatherInfo = getWeatherAnimClass(daily.weathercode[0], false);
    if (tlSky) tlSky.textContent = weatherInfo.label;
    
    // Calculate average cloud cover for today
    if (tlCloud && hourly && hourly.cloudcover){
      var todayStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0, 0);
      var todayEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59, 999);
      var cloudSum = 0, cloudCount = 0;
      for (var ci = 0; ci < hourly.time.length; ci++){
        var dt = new Date(hourly.time[ci]);
        if (dt >= todayStart && dt <= todayEnd && typeof hourly.cloudcover[ci] === "number"){
          cloudSum += hourly.cloudcover[ci];
          cloudCount++;
        }
      }
      var avgCloud = cloudCount > 0 ? Math.round(cloudSum / cloudCount) : 0;
      tlCloud.textContent = avgCloud + "%";
    }

    // Moon info
    var phaseFrac = approximateMoonPhase(new Date());
    var mi = moonInfo(phaseFrac);
    if (tlMoon) tlMoon.textContent = mi.name + "  " + mi.illum + "%";

    // Timeline range: midnight to midnight
    var timelineStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0, 0).getTime();
    var timelineEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59, 999).getTime();
    var timelineSpan = timelineEnd - timelineStart;

    function pctForTime(d){
      if (!d || !d.getTime) return -1;
      var t = d.getTime();
      if (t < timelineStart || t > timelineEnd) return -1;
      return ((t - timelineStart) / timelineSpan) * 100;
    }

    // Render Kp track
    if (tlKpTrack){
      var kpHtml = "";
      if (kpData && kpData.length > 0){
        // Sort by time
        kpData.sort(function(a, b){ return a.t - b.t; });
        
        for (var ki = 0; ki < kpData.length; ki++){
          var kpPoint = kpData[ki];
          var nextPoint = kpData[ki + 1];
          
          var startPct = pctForTime(kpPoint.t);
          var endPct = nextPoint ? pctForTime(nextPoint.t) : 100;
          
          if (startPct < 0) startPct = 0;
          if (endPct < 0 || endPct > 100) endPct = 100;
          
          var widthPct = endPct - startPct;
          if (widthPct <= 0) continue;
          
          var kpColorVal = getKpColor(kpPoint.kp);
          kpHtml += '<div class="today-tl-bar-segment" style="width:' + widthPct + '%;background:' + kpColorVal + ';"></div>';
        }
      } else {
        // Default quiet Kp
        kpHtml = '<div class="today-tl-bar-segment" style="width:100%;background:#33cc33;"></div>';
      }
      tlKpTrack.innerHTML = kpHtml;
    }

    // Render cloud track
    if (tlCloudTrack && hourly && hourly.cloudcover){
      var cloudHtml = "";
      var hoursPerSegment = 3;
      
      for (var h = 0; h < 24; h += hoursPerSegment){
        var segStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h, 0, 0, 0);
        var segEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h + hoursPerSegment, 0, 0, 0);
        
        // Average cloud cover for this segment
        var segSum = 0, segCount = 0;
        for (var chi = 0; chi < hourly.time.length; chi++){
          var dt = new Date(hourly.time[chi]);
          if (dt >= segStart && dt < segEnd && typeof hourly.cloudcover[chi] === "number"){
            segSum += hourly.cloudcover[chi];
            segCount++;
          }
        }
        
        var segCloud = segCount > 0 ? Math.round(segSum / segCount) : 0;
        var widthPct = (hoursPerSegment / 24) * 100;
        
        // Cloud color: white (clear) to dark grey (overcast)
        var cloudColor;
        if (segCloud < 10) cloudColor = "rgba(255,255,255,0.90)";
        else if (segCloud < 30) cloudColor = "rgba(220,220,220,0.85)";
        else if (segCloud < 50) cloudColor = "rgba(180,180,180,0.80)";
        else if (segCloud < 70) cloudColor = "rgba(140,140,140,0.75)";
        else if (segCloud < 85) cloudColor = "rgba(100,100,100,0.70)";
        else cloudColor = "rgba(70,70,70,0.65)";
        
        cloudHtml += '<div class="today-tl-bar-segment" style="width:' + widthPct + '%;background:' + cloudColor + ';"></div>';
      }
      tlCloudTrack.innerHTML = cloudHtml;
    }

    // Render sky gradient bands
    if (tlSkyBands){
      var bandsHtml = "";
      
      // Night before dawn
      if (astroDawn){
        var p = pctForTime(astroDawn);
        if (p > 0) bandsHtml += '<div class="today-tl-sky-band night" style="width:' + p + '%;"></div>';
      }
      
      // Astro twilight AM
      if (astroDawn && blueAmStart){
        var p1 = pctForTime(astroDawn);
        var p2 = pctForTime(blueAmStart);
        if (p1 >= 0 && p2 > p1) bandsHtml += '<div class="today-tl-sky-band astro-twilight" style="width:' + (p2 - p1) + '%;"></div>';
      }
      
      // Blue hour AM
      if (blueAmStart && blueAmEnd){
        var p1 = pctForTime(blueAmStart);
        var p2 = pctForTime(blueAmEnd);
        if (p1 >= 0 && p2 > p1) bandsHtml += '<div class="today-tl-sky-band blue-hour" style="width:' + (p2 - p1) + '%;"></div>';
      }
      
      // Golden hour AM - smooth gradient with peak line
      if (goldenAmStart && goldenAmEnd){
        var p1 = pctForTime(goldenAmStart);
        var p2 = pctForTime(goldenAmEnd);
        // Peak moment: sun at 0 (sunrise exact moment)
        var peakAm = pctForTime(srDate);
        
        if (p1 >= 0 && p2 > p1){
          // Full golden hour as one gradient band
          bandsHtml += '<div class="today-tl-sky-band golden-am" style="width:' + (p2 - p1) + '%;"></div>';
        }
      }
      
      // Day
      if (goldenAmEnd && goldenPmStart){
        var p1 = pctForTime(goldenAmEnd);
        var p2 = pctForTime(goldenPmStart);
        if (p1 >= 0 && p2 > p1) bandsHtml += '<div class="today-tl-sky-band day" style="width:' + (p2 - p1) + '%;"></div>';
      }
      
      // Golden hour PM - smooth gradient with peak line
      if (goldenPmStart && goldenPmEnd){
        var p1 = pctForTime(goldenPmStart);
        var p2 = pctForTime(goldenPmEnd);
        
        if (p1 >= 0 && p2 > p1){
          // Full golden hour as one gradient band
          bandsHtml += '<div class="today-tl-sky-band golden-pm" style="width:' + (p2 - p1) + '%;"></div>';
        }
      }
      
      // Blue hour PM
      if (bluePmStart && bluePmEnd){
        var p1 = pctForTime(bluePmStart);
        var p2 = pctForTime(bluePmEnd);
        if (p1 >= 0 && p2 > p1) bandsHtml += '<div class="today-tl-sky-band blue-hour" style="width:' + (p2 - p1) + '%;"></div>';
      }
      
      // Astro twilight PM
      if (bluePmEnd && astroDusk){
        var p1 = pctForTime(bluePmEnd);
        var p2 = pctForTime(astroDusk);
        if (p1 >= 0 && p2 > p1) bandsHtml += '<div class="today-tl-sky-band astro-twilight" style="width:' + (p2 - p1) + '%;"></div>';
      }
      
      // Night after dusk
      if (astroDusk){
        var p = pctForTime(astroDusk);
        if (p >= 0 && p < 100) bandsHtml += '<div class="today-tl-sky-band night" style="width:' + (100 - p) + '%;"></div>';
      }
      
      tlSkyBands.innerHTML = bandsHtml;
    }

    // Render planet tracks
    if (tlPlanetTracks){
      // Compute visibility windows for today
      var bodies = ["moon", "mercury", "venus", "mars", "jupiter", "saturn", "uranus", "neptune"];
      var todayStartDate = new Date(timelineStart);
      var todayEndDate = new Date(timelineEnd);
      
      var windows = computeVisibilityWindows(todayStartDate, todayEndDate, bodies, LOCATION.lat, LOCATION.lon);
      
      var planetOrder = ["Moon", "Mercury", "Venus", "Mars", "Jupiter", "Saturn", "Uranus", "Neptune"];
      var nameMap = { moon: "Moon", mercury: "Mercury", venus: "Venus", mars: "Mars", jupiter: "Jupiter", saturn: "Saturn", uranus: "Uranus", neptune: "Neptune" };
      
      var planetsHtml = "";
      
      // Calculate average azimuth for each body to determine direction
      function getDirectionAbbrev(azDeg){
        if (azDeg >= 337.5 || azDeg < 22.5) return "NORTH";
        if (azDeg >= 22.5 && azDeg < 67.5) return "NORTHEAST";
        if (azDeg >= 67.5 && azDeg < 112.5) return "EAST";
        if (azDeg >= 112.5 && azDeg < 157.5) return "SOUTHEAST";
        if (azDeg >= 157.5 && azDeg < 202.5) return "SOUTH";
        if (azDeg >= 202.5 && azDeg < 247.5) return "SOUTHWEST";
        if (azDeg >= 247.5 && azDeg < 292.5) return "WEST";
        if (azDeg >= 292.5 && azDeg < 337.5) return "NORTHWEST";
        return "";
      }
      
      function getPlanetDirection(body, windows){
        // Calculate azimuth for RIGHT NOW (real-time position)
        var now = new Date();
        var rd = (body === "moon") ? moonRaDec(now) : planetRaDec(body, now);
        var aa = altAz(rd.ra, rd.dec, now, LOCATION.lat, LOCATION.lon);
        var altD = deg(aa.alt);
        var azDeg = deg(aa.az);
        
        // If below horizon, show "Below" instead of direction
        if (altD < 0) return "Below";
        
        return getDirectionAbbrev(azDeg);
      }
      
      // Store directions for legend
      window.planetDirections = {};
      
      for (var pi = 0; pi < bodies.length; pi++){
        var body = bodies[pi];
        var w = windows[body];
        var displayName = nameMap[body];
        var color = TODAY_TL_PLANET_COLORS[displayName] || "rgba(200,200,200,0.8)";
        var direction = getPlanetDirection(body, windows);
        
        // Store for legend
        window.planetDirections[displayName] = direction;
        
        planetsHtml += '<div class="today-tl-planet-row">';
        planetsHtml += '<div class="today-tl-planet-indicator" style="background:' + color + ';box-shadow:0 0 6px ' + color + ';"></div>';
        planetsHtml += '<div class="today-tl-planet-bar">';
        
        if (w && w.segments && w.segments.length > 0){
          for (var si = 0; si < w.segments.length; si++){
            var seg = w.segments[si];
            var startPct = pctForTime(seg.start);
            var endPct = pctForTime(seg.end);
            
            if (startPct < 0) startPct = 0;
            if (endPct < 0) endPct = 0;
            if (endPct > 100) endPct = 100;
            
            var widthPct = endPct - startPct;
            if (widthPct < 0.5) widthPct = 0.5;
            
            var visClass = seg.belowTreeline ? "dashed" : "solid";
            planetsHtml += '<div class="today-tl-planet-vis ' + visClass + '" style="left:' + startPct + '%;width:' + widthPct + '%;background:' + color + ';color:' + color + ';"></div>';
          }
        }
        
        planetsHtml += '</div></div>';
      }
      
      tlPlanetTracks.innerHTML = planetsHtml;
    }

    // Render weather row with animated icons (every 3 hours)
    if (tlWeatherRow && hourly && hourly.time){
      var weatherHtml = "";
      
      var isMobile = window.innerWidth <= 768;
      var hStep = isMobile ? 3 : 1;
      for (var h = 0; h < 24; h += hStep){
        var targetHour = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h, 0, 0, 0);
        
        // Find matching index in hourly data
        var matchIdx = -1;
        for (var hi = 0; hi < hourly.time.length; hi++){
          var dt = new Date(hourly.time[hi]);
          if (dt.getFullYear() === targetHour.getFullYear() &&
              dt.getMonth() === targetHour.getMonth() &&
              dt.getDate() === targetHour.getDate() &&
              dt.getHours() === targetHour.getHours()){
            matchIdx = hi;
            break;
          }
        }
        
        var timeLabel = h === 0 ? "12a" : (h < 12 ? h + "a" : (h === 12 ? "12p" : (h - 12) + "p"));
        var temp = "--";
        var precip = 0;
        var weatherCode = 0;
        
        // Determine if night hour
        var isNightHour = (targetHour < srDate || targetHour > ssDate);
        var isDayHour = !isNightHour;
        
        if (matchIdx >= 0){
          temp = Math.round(hourly.temperature_2m[matchIdx]) + "";
          precip = hourly.precipitation_probability ? (hourly.precipitation_probability[matchIdx] || 0) : 0;
          weatherCode = hourly.weathercode ? (hourly.weathercode[matchIdx] || 0) : 0;
        }
        
        var weatherInfo = getWeatherAnimClass(weatherCode, isNightHour);
        var precipClass = precip >= 50 ? "active" : "";
        var hourClass = "today-tl-weather-hour" + (isDayHour ? " day-hour" : "");
        
        var feelsLike = (matchIdx >= 0 && hourly.apparent_temperature) ? Math.round(hourly.apparent_temperature[matchIdx]) + "" : "";
        var windSpd = (matchIdx >= 0 && hourly.windspeed_10m) ? Math.round(hourly.windspeed_10m[matchIdx]) : "";
        var gustSpd = (matchIdx >= 0 && hourly.windgusts_10m) ? Math.round(hourly.windgusts_10m[matchIdx]) : "";
        var windStr = windSpd !== "" ? windSpd + (gustSpd && gustSpd > windSpd ? "/" + gustSpd : "") + "m" : "";
        weatherHtml += '<div class="' + hourClass + '">' +
          '<span class="today-tl-weather-time">' + timeLabel + '</span>' +
          '<span class="today-tl-weather-icon ' + weatherInfo.animClass + '">' + weatherInfo.emoji + '</span>' +
          '<span class="today-tl-weather-temp">' + temp + '</span>' +
          '<span style="font-size:.7rem;font-weight:400;color:rgba(255,255,255,.45);display:block;text-align:center;width:100%;">' + feelsLike + '</span>' +
          '<span style="font-size:.55rem;font-weight:600;color:rgba(255,255,255,.35);display:block;text-align:center;width:100%;text-transform:uppercase;letter-spacing:.3px;">' + windStr + '</span>' +
          '<span class="today-tl-weather-precip ' + precipClass + '">' + precip + '%</span>' +
        '</div>';
      }
      
      tlWeatherRow.innerHTML = weatherHtml;
    }

    // Position NOW marker
    if (tlNowMarker){
      var now = new Date();
      var nowPct = pctForTime(now);
      
      if (nowPct >= 0 && nowPct <= 100){
        tlNowMarker.style.left = nowPct + "%";
        tlNowMarker.style.display = "block";
        
        // Update NOW temp and time
        if (tlNowTemp && hourly && hourly.temperature_2m){
          var nowTemp = Math.round(hourly.temperature_2m[nearestIndex]);
          tlNowTemp.textContent = nowTemp + "";
        }
        if (tlNowTime){
          tlNowTime.textContent = fmt12NoSuffixFromDate(now);
        }
      } else {
        tlNowMarker.style.display = "none";
      }
    }

    // Update planet directions in legend
    if (window.planetDirections){
      var dirIds = ['moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune'];
      var dirNames = ['Moon', 'Mercury', 'Venus', 'Mars', 'Jupiter', 'Saturn', 'Uranus', 'Neptune'];
      for (var di = 0; di < dirIds.length; di++){
        var dirEl = document.getElementById('legend-dir-' + dirIds[di]);
        if (dirEl && window.planetDirections[dirNames[di]]){
          dirEl.textContent = window.planetDirections[dirNames[di]];
        }
      }
    }

    // Update moon image in legend (same logic as large moon)
    var legendMoonEl = document.getElementById("today-tl-legend-moon");
    if (legendMoonEl){
      var legendPhaseFrac = approximateMoonPhase(new Date());
      var legendMi = moonInfo(legendPhaseFrac);
      var legendNewMoonFrame = 946;
      var legendLunarCycleFrames = 709;
      var legendFrameOffset = Math.round(legendPhaseFrac * legendLunarCycleFrames);
      var legendFrame = legendNewMoonFrame + legendFrameOffset;
      if (legendFrame > 8760) legendFrame -= 8760;
      var legendFrameStr = String(legendFrame).padStart(4, '0');
      var legendMoonUrl = "https://svs.gsfc.nasa.gov/vis/a000000/a005100/a005187/frames/730x730_1x1_30p/moon." + legendFrameStr + ".jpg";
      
      legendMoonEl.style.background = "url('" + legendMoonUrl + "') center/cover";
      legendMoonEl.style.boxShadow = "inset -1px -1px 3px rgba(0,0,0,.15)";
    }
  }

  /* =========================================================
     TIMELINE RENDER (Combined sun events + hourly weather)
     ========================================================= */
  function renderTimeline(hourly, daily, nearestIndex){
    var tlSunrise = document.getElementById("tl-sunrise");
    var tlSunset = document.getElementById("tl-sunset");
    var tlGolden = document.getElementById("tl-golden");
    var tlBands = document.getElementById("tl-bands");
    var tlHours = document.getElementById("tl-hours");
    var tlEvents = document.getElementById("tl-events");
    var tlNow = document.getElementById("tl-now");
    var tlNowTemp = document.getElementById("tl-now-temp");
    var tlEventLabels = document.getElementById("tl-event-labels");

    if (!tlHours || !daily || !daily.sunrise || !daily.sunset) return;

    var srIso = daily.sunrise[0];
    var ssIso = daily.sunset[0];
    var srDate = new Date(srIso);
    var ssDate = new Date(ssIso);

    // Detect mobile
    var isMobile = window.innerWidth <= 768;

    // Calculate solar events (must be before golden hour calculations)
    var dayLocal = new Date(srDate.getFullYear(), srDate.getMonth(), srDate.getDate(), 12, 0, 0, 0);

    // Update header
    if (tlSunrise) tlSunrise.textContent = fmt12NoSuffix(srIso);
    if (tlSunset) tlSunset.textContent = fmt12NoSuffix(ssIso);
    
    var tlGoldenAm = document.getElementById("tl-golden-am");
    var tlGoldenPm = document.getElementById("tl-golden-pm");
    
    var goldenAmStartTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var goldenAmEndTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, true);
    var goldenPmStartTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, false);
    var goldenPmEndTime = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    
    if (tlGoldenAm) {
      if (goldenAmStartTime && goldenAmEndTime) {
        tlGoldenAm.textContent = fmt12NoSuffixFromDate(goldenAmStartTime) + "  " + fmt12NoSuffixFromDate(goldenAmEndTime);
      } else {
        tlGoldenAm.textContent = "--";
      }
    }
    if (tlGoldenPm) {
      if (goldenPmStartTime && goldenPmEndTime) {
        tlGoldenPm.textContent = fmt12NoSuffixFromDate(goldenPmStartTime) + "  " + fmt12NoSuffixFromDate(goldenPmEndTime);
      } else {
        tlGoldenPm.textContent = "--";
      }
    }

    // Calculate daylight length
    var tlDaylight = document.getElementById("tl-daylight");
    var tlDaylightChange = document.getElementById("tl-daylight-change");
    
    var daylightMs = ssDate.getTime() - srDate.getTime();
    var daylightHours = Math.floor(daylightMs / (1000 * 60 * 60));
    var daylightMins = Math.floor((daylightMs % (1000 * 60 * 60)) / (1000 * 60));
    
    if (tlDaylight) tlDaylight.textContent = daylightHours + "h " + daylightMins + "m";
    
    // Calculate yesterday's daylight for comparison
    if (tlDaylightChange){
      var yesterdayLocal = new Date(dayLocal.getTime() - 86400000);
      var srYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, true);
      var ssYesterday = solarEventTimeLocal(yesterdayLocal, LOCATION.lat, LOCATION.lon, -0.833, false);
      
      if (srYesterday && ssYesterday){
        var yesterdayMs = ssYesterday.getTime() - srYesterday.getTime();
        var diffMs = daylightMs - yesterdayMs;
        var diffSecs = Math.round(diffMs / 1000);
        var diffMins = Math.floor(Math.abs(diffSecs) / 60);
        var remainSecs = Math.abs(diffSecs) % 60;
        
        var sign = diffSecs >= 0 ? "+" : "-";
        var timeStr;
        if (diffMins > 0){
          timeStr = sign + diffMins + "m " + remainSecs + "s";
        } else {
          timeStr = sign + remainSecs + "s";
        }
        
        if (diffSecs > 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(80,180,80,1)";
        } else if (diffSecs < 0){
          tlDaylightChange.textContent = "(" + timeStr + " )";
          tlDaylightChange.style.color = "rgba(200,100,80,1)";
        } else {
          tlDaylightChange.textContent = "(+0s)";
          tlDaylightChange.style.color = "rgba(43,34,244,.60)";
        }
      }
    }
    
    var astroDawn = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, true);
    var astroDusk = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -18, false);
    var blueAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, true);
    var blueAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var bluePmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var bluePmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -6, false);
    var goldenAmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, true);
    var goldenAmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, true);
    var goldenPmStart = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, 6, false);
    var goldenPmEnd = solarEventTimeLocal(dayLocal, LOCATION.lat, LOCATION.lon, -4, false);
    var noon = solarNoonLocal(dayLocal, LOCATION.lat, LOCATION.lon);

    // Timeline range: full 24 hours on desktop, golden hour to golden hour on mobile
    var todayStart, todayEnd;
    
    // Always use full 24 hours  hourStep handles density
    todayStart = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 0, 0, 0, 0);
    todayEnd = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), 23, 59, 59, 999);
    
    var timelineStart = todayStart.getTime();
    var timelineEnd = todayEnd.getTime();
    var timelineSpan = timelineEnd - timelineStart;

    function pctForTime(d){
      if (!d || !d.getTime) return -1;
      var t = d.getTime();
      if (t < timelineStart || t > timelineEnd) return -1;
      return ((t - timelineStart) / timelineSpan) * 100;
    }

    // Render bands
    if (tlBands){
      var bandsHtml = "";
      
      // Night bands (before astro dawn, after astro dusk) - stars visible
      if (astroDawn){
        var p = pctForTime(astroDawn);
        if (p > 0) bandsHtml += '<div class="tl-band night" style="left:0;width:'+p+'%"></div>';
      }
      if (astroDusk){
        var p2 = pctForTime(astroDusk);
        if (p2 > 0 && p2 < 100) bandsHtml += '<div class="tl-band night" style="left:'+p2+'%;width:'+(100-p2)+'%"></div>';
      }
      
      // Astronomical twilight (stars starting to appear/disappear)
      if (astroDawn && blueAmStart){
        var p1 = pctForTime(astroDawn);
        var p2 = pctForTime(blueAmStart);
        if (p1 >= 0 && p2 >= 0) bandsHtml += '<div class="tl-band astro" style="left:'+p1+'%;width:'+(p2-p1)+'%"></div>';
      }
      if (bluePmEnd && astroDusk){
        var p1 = pctForTime(bluePmEnd);
        var p2 = pctForTime(astroDusk);
        if (p1 >= 0 && p2 >= 0) bandsHtml += '<div class="tl-band astro" style="left:'+p1+'%;width:'+(p2-p1)+'%"></div>';
      }
      
      // Blue hour AM
      if (blueAmStart && blueAmEnd){
        var p1 = pctForTime(blueAmStart);
        var p2 = pctForTime(blueAmEnd);
        if (p1 >= 0 && p2 >= 0) bandsHtml += '<div class="tl-band blue" style="left:'+p1+'%;width:'+(p2-p1)+'%"></div>';
      }
      
      // Golden hour AM - with peak near sunrise
      if (goldenAmStart && goldenAmEnd){
        var p1 = pctForTime(goldenAmStart);
        var p2 = pctForTime(goldenAmEnd);
        var pSunrise = pctForTime(srDate);
        if (p1 >= 0 && p2 >= 0){
          // Peak golden (most orange) - 15 mins before to 20 mins after sunrise
          var peakStart = pctForTime(new Date(srDate.getTime() - 15*60000));
          var peakEnd = pctForTime(new Date(srDate.getTime() + 20*60000));
          
          // Before peak
          if (p1 < peakStart) bandsHtml += '<div class="tl-band golden" style="left:'+p1+'%;width:'+(peakStart-p1)+'%"></div>';
          
          // Peak
          if (peakStart >= 0 && peakEnd >= 0) bandsHtml += '<div class="tl-band golden-peak" style="left:'+peakStart+'%;width:'+(peakEnd-peakStart)+'%"></div>';
          
          // After peak
          if (peakEnd < p2) bandsHtml += '<div class="tl-band golden" style="left:'+peakEnd+'%;width:'+(p2-peakEnd)+'%"></div>';
        }
      }
      
      // Day band
      if (goldenAmEnd && goldenPmStart){
        var p1 = pctForTime(goldenAmEnd);
        var p2 = pctForTime(goldenPmStart);
        if (p1 >= 0 && p2 >= 0) bandsHtml += '<div class="tl-band day" style="left:'+p1+'%;width:'+(p2-p1)+'%"></div>';
      }
      
      // Golden hour PM - with peak near sunset
      if (goldenPmStart && goldenPmEnd){
        var p1 = pctForTime(goldenPmStart);
        var p2 = pctForTime(goldenPmEnd);
        var pSunset = pctForTime(ssDate);
        if (p1 >= 0 && p2 >= 0){
          // Peak golden (most orange) - 20 mins before to 15 mins after sunset
          var peakStart = pctForTime(new Date(ssDate.getTime() - 20*60000));
          var peakEnd = pctForTime(new Date(ssDate.getTime() + 15*60000));
          
          // Before peak
          if (p1 < peakStart) bandsHtml += '<div class="tl-band golden" style="left:'+p1+'%;width:'+(peakStart-p1)+'%"></div>';
          
          // Peak
          if (peakStart >= 0 && peakEnd >= 0) bandsHtml += '<div class="tl-band golden-peak" style="left:'+peakStart+'%;width:'+(peakEnd-peakStart)+'%"></div>';
          
          // After peak
          if (peakEnd < p2) bandsHtml += '<div class="tl-band golden" style="left:'+peakEnd+'%;width:'+(p2-peakEnd)+'%"></div>';
        }
      }
      
      // Blue hour PM
      if (bluePmStart && bluePmEnd){
        var p1 = pctForTime(bluePmStart);
        var p2 = pctForTime(bluePmEnd);
        if (p1 >= 0 && p2 >= 0) bandsHtml += '<div class="tl-band blue" style="left:'+p1+'%;width:'+(p2-p1)+'%"></div>';
      }
      
      tlBands.innerHTML = bandsHtml;
    }

    // Render hourly weather
    if (tlHours && hourly && hourly.time){
      var hoursHtml = "";
      
      // Find hours within timeline range
      var startHour = todayStart.getHours();
      var endHour = todayEnd.getHours();
      
      // Show every 3 hours for cleaner display
      var hourStep = 3;
      console.log('[TL] hourStep=' + hourStep + ', startHour=' + startHour + ', endHour=' + endHour + ', items=' + Math.floor((endHour - startHour) / hourStep + 1));
      
      for (var h = startHour; h <= endHour; h += hourStep){
        var targetHour = new Date(dayLocal.getFullYear(), dayLocal.getMonth(), dayLocal.getDate(), h, 0, 0, 0);
        
        // Find matching index in hourly data
        var matchIdx = -1;
        for (var i = 0; i < hourly.time.length; i++){
          var dt = new Date(hourly.time[i]);
          if (dt.getFullYear() === targetHour.getFullYear() &&
              dt.getMonth() === targetHour.getMonth() &&
              dt.getDate() === targetHour.getDate() &&
              dt.getHours() === targetHour.getHours()){
            matchIdx = i;
            break;
          }
        }
        
        var timeLabel = h === 0 ? "12a" : (h < 12 ? h + "a" : (h === 12 ? "12p" : (h - 12) + "p"));
        var temp = "--";
        var precip = 0;
        var icon = "";
        
        // Determine if this hour is during night/twilight
        var isNight = (targetHour < srDate || targetHour > ssDate);
        var isDeepNight = (astroDawn && targetHour < astroDawn) || (astroDusk && targetHour > astroDusk);
        var isTwilight = isNight && !isDeepNight;
        
        if (matchIdx >= 0){
          temp = Math.round(hourly.temperature_2m[matchIdx]) + "";
          precip = hourly.precipitation_probability[matchIdx] || 0;
          
          // Determine icon based on conditions
          var cc = hourly.cloudcover ? hourly.cloudcover[matchIdx] : 0;
          
          if (precip >= 60){
            icon = METEO_BASE + "rain.svg";
          } else if (precip >= 30){
            icon = METEO_BASE + "drizzle.svg";
          } else if (cc >= 70){
            icon = METEO_BASE + "overcast.svg";
          } else if (cc >= 30){
            icon = isNight ? METEO_BASE + "partly-cloudy-night.svg" : METEO_BASE + "partly-cloudy-day.svg";
          } else if (isDeepNight){
            icon = METEO_BASE + "clear-night.svg";
          } else if (isTwilight){
            icon = METEO_BASE + "clear-night.svg";
          } else {
            icon = METEO_BASE + "clear-day.svg";
          }
        }
        
        var precipClass = "low";
        if (precip >= 60) precipClass = "high";
        else if (precip >= 30) precipClass = "med";
        
        // Add night-hour class for dark background styling
        var hourClass = "tl-hour";
        if (isDeepNight || isTwilight) hourClass += " night-hour";
        
        hoursHtml += '<div class="' + hourClass + '">' +
          '<span class="tl-hour-time">' + timeLabel + '</span>' +
          '<img class="tl-hour-icon" src="' + icon + '" alt="" />' +
          '<span class="tl-hour-temp">' + temp + '</span>' +
          (precip > 0 ? '<span class="tl-hour-precip ' + precipClass + '">' + precip + '%</span>' : '') +
        '</div>';;
      }
      
      tlHours.innerHTML = hoursHtml;
    }

    // Render sun event ticks
    if (tlEvents){
      var eventsHtml = "";
      
      var events = [
        { time: astroDawn, cls: "astro" },
        { time: blueAmStart, cls: "blue" },
        { time: srDate, cls: "sunrise" },
        { time: goldenAmEnd, cls: "golden" },
        { time: noon, cls: "noon" },
        { time: goldenPmStart, cls: "golden" },
        { time: ssDate, cls: "sunset" },
        { time: bluePmEnd, cls: "blue" },
        { time: astroDusk, cls: "astro" }
      ];
      
      for (var e = 0; e < events.length; e++){
        var ev = events[e];
        var p = pctForTime(ev.time);
        if (p >= 0 && p <= 100){
          eventsHtml += '<div class="tl-event-tick ' + ev.cls + '" style="left:' + p + '%"></div>';
        }
      }
      
      tlEvents.innerHTML = eventsHtml;
    }

    // Render event labels with hill pattern
    if (tlEventLabels){
      var labelsHtml = "";
      
      // Labels with assigned levels (1=lowest, 5=highest like a hill)
      var labels = [
        { time: astroDawn, text: "AST DAWN", cls: "astro", level: 1 },
        { time: blueAmStart, text: "BLUE", cls: "blue", level: 2 },
        { time: srDate, text: "SUNRISE", cls: "sunrise", level: 3 },
        { time: goldenAmEnd, text: "GOLDEN", cls: "golden", level: 4 },
        { time: noon, text: "NOON", cls: "noon", level: 5 },
        { time: goldenPmStart, text: "GOLDEN", cls: "golden", level: 4 },
        { time: ssDate, text: "SUNSET", cls: "sunset", level: 3 },
        { time: bluePmEnd, text: "BLUE", cls: "blue", level: 2 },
        { time: astroDusk, text: "AST DARK", cls: "astro", level: 1 }
      ];
      
      for (var j = 0; j < labels.length; j++){
        var lb = labels[j];
        var p = pctForTime(lb.time);
        if (p >= 0 && p <= 100){
          labelsHtml += '<span class="tl-event-label ' + lb.cls + ' level-' + lb.level + '" style="left:' + p + '%">' + lb.text + '</span>';
        }
      }
      
      tlEventLabels.innerHTML = labelsHtml;
    }

    // Position NOW marker
    if (tlNow){
      var now = new Date();
      var nowPct = pctForTime(now);
      
      if (nowPct >= 0 && nowPct <= 100){
        tlNow.style.left = nowPct + "%";
        tlNow.style.display = "block";
        
        // Update NOW temp
        if (tlNowTemp && hourly && hourly.temperature_2m){
          var nowTemp = Math.round(hourly.temperature_2m[nearestIndex]);
          tlNowTemp.textContent = nowTemp + "";
        }
      } else {
        tlNow.style.display = "none";
      }
    }
  }
/* =========================================================
     AIR QUALITY & POLLEN (Open-Meteo)
     ========================================================= */
  function classifyAqi(aqi){
    if (aqi == null || isNaN(aqi)) return { label: "--", cls: "" };
    if (aqi <= 50) return { label: "Good (" + Math.round(aqi) + ")", cls: "good" };
    if (aqi <= 100) return { label: "Moderate (" + Math.round(aqi) + ")", cls: "moderate" };
    if (aqi <= 150) return { label: "Sensitive (" + Math.round(aqi) + ")", cls: "unhealthy-sensitive" };
    if (aqi <= 200) return { label: "Unhealthy (" + Math.round(aqi) + ")", cls: "unhealthy" };
    if (aqi <= 300) return { label: "Very Unhealthy (" + Math.round(aqi) + ")", cls: "very-unhealthy" };
    return { label: "Hazardous (" + Math.round(aqi) + ")", cls: "hazardous" };
  }

  function classifyPollen(val){
    if (val == null || isNaN(val) || val <= 0) return { label: "None", cls: "none" };
    if (val <= 20) return { label: "Low", cls: "low" };
    if (val <= 80) return { label: "Moderate", cls: "moderate" };
    if (val <= 200) return { label: "High", cls: "high" };
    return { label: "Very High", cls: "very-high" };
  }

  function loadAirQuality(){
    var aqiEl = document.getElementById("aqi-val");
    var pm25El = document.getElementById("pm25-val");
    var pm10El = document.getElementById("pm10-val");
    var pollenTreeEl = document.getElementById("pollen-tree");
    var pollenGrassEl = document.getElementById("pollen-grass");
    var pollenWeedEl = document.getElementById("pollen-weed");
    var pollenRagweedEl = document.getElementById("pollen-ragweed");

    var url = 
      "https://air-quality-api.open-meteo.com/v1/air-quality" +
      "?latitude=" + LOCATION.lat +
      "&longitude=" + LOCATION.lon +
      "&current=us_aqi,pm10,pm2_5,carbon_monoxide" +
      "&current=alder_pollen,birch_pollen,grass_pollen,mugwort_pollen,olive_pollen,ragweed_pollen";

    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try{
          var current = data && data.current;
          if (!current) return;

          // AQI
          if (aqiEl){
            var aqiInfo = classifyAqi(current.us_aqi);
            aqiEl.textContent = aqiInfo.label;
            aqiEl.className = "ap-val " + aqiInfo.cls;
          }

          // Smoke risk (based on PM2.5 + CO levels)
          var smokeEl = document.getElementById("smoke-risk");
          var pm25 = current.pm2_5 || 0;
          var co = current.carbon_monoxide || 0;
          
          if (smokeEl){
            var smokeRisk;
            if (pm25 >= 55.5) {
              smokeRisk = { label: "Unhealthy", cls: "very-high" };
            } else if (pm25 >= 35.5) {
              smokeRisk = { label: "USG", cls: "moderate" };
            } else if (pm25 >= 12.1) {
              smokeRisk = { label: "Moderate", cls: "low" };
            } else {
              smokeRisk = { label: "Good", cls: "none" };
            }
            smokeEl.textContent = smokeRisk.label;
            smokeEl.className = "pollen-val " + smokeRisk.cls;
          }

          // PM2.5
          if (pm25El){
            pm25El.textContent = (pm25 != null ? Math.round(pm25) + " g/m" : "--");
          }

          // PM10
          if (pm10El){
            var pm10 = current.pm10;
            pm10El.textContent = (pm10 != null ? Math.round(pm10) + " g/m" : "--");
          }

          // Tree pollen (combine alder + birch)
          if (pollenTreeEl){
            var treePollen = Math.max(current.alder_pollen || 0, current.birch_pollen || 0);
            var treeInfo = classifyPollen(treePollen);
            pollenTreeEl.textContent = treeInfo.label;
            pollenTreeEl.className = "pollen-val " + treeInfo.cls;
          }

          // Grass pollen
          if (pollenGrassEl){
            var grassInfo = classifyPollen(current.grass_pollen);
            pollenGrassEl.textContent = grassInfo.label;
            pollenGrassEl.className = "pollen-val " + grassInfo.cls;
          }

          // Weed pollen (mugwort + olive)
          if (pollenWeedEl){
            var weedPollen = Math.max(current.mugwort_pollen || 0, current.olive_pollen || 0);
            var weedInfo = classifyPollen(weedPollen);
            pollenWeedEl.textContent = weedInfo.label;
            pollenWeedEl.className = "pollen-val " + weedInfo.cls;
          }

          // Ragweed
          if (pollenRagweedEl){
            var ragweedInfo = classifyPollen(current.ragweed_pollen);
            pollenRagweedEl.textContent = ragweedInfo.label;
            pollenRagweedEl.className = "pollen-val " + ragweedInfo.cls;
          }

        } catch(e){
          console.error("Air quality parse error", e);
        }
      })
      .catch(function(err){
        console.error("Air quality load error", err);
      });
  }
  /* =========================================================
     WEATHER LOAD (Open-Meteo)
     ========================================================= */
  function loadWeatherForLocation(loc){
    if (!locNameEl) return;

    setText(locNameEl, loc.name);

    var url =
      "https://api.open-meteo.com/v1/forecast" +
      "?latitude=" + loc.lat +
      "&longitude=" + loc.lon +
      "&timezone=" + encodeURIComponent(TZ) +
      "&temperature_unit=fahrenheit" +
      "&windspeed_unit=mph" +
      "&precipitation_unit=inch" +
      "&hourly=temperature_2m,apparent_temperature,relativehumidity_2m,precipitation_probability,precipitation,cloudcover,windspeed_10m,windgusts_10m,visibility,pressure_msl,uv_index,weathercode,snowfall,rain" +
      "&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,precipitation_sum,sunrise,sunset,uv_index_max,windspeed_10m_max,windgusts_10m_max,snowfall_sum,rain_sum,wind_direction_10m_dominant,showers_sum" +
      "&forecast_days=10";

    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try{
          var hourly = data && data.hourly;
          var daily  = data && data.daily;

          if (!hourly || !daily || !hourly.time || !daily.time){
            setText(condTextEl, "No data");
            return;
          }

          // Find nearest hour index
          var now = new Date();
          var nearestIndex = 0, minDiff = Infinity;
          for (var i=0;i<hourly.time.length;i++){
            var dt = new Date(hourly.time[i]);
            var diff = Math.abs(now - dt);
            if (diff < minDiff){ minDiff = diff; nearestIndex = i; }
          }

          // Current conditions
          var temp = Math.round(hourly.temperature_2m[nearestIndex]);
          setText(tempEl, temp + "");

          var feels = hourly.apparent_temperature && hourly.apparent_temperature[nearestIndex];
          var feelsVal = (typeof feels === "number" ? Math.round(feels) : temp);
          setText(feelsInlineEl, "Feels " + feelsVal + "");

          var rh = hourly.relativehumidity_2m && hourly.relativehumidity_2m[nearestIndex];
          setText(humidityEl, (typeof rh === "number" ? Math.round(rh) + "%" : "--"));

          var gust = hourly.windgusts_10m && hourly.windgusts_10m[nearestIndex];
          setText(gustsEl, (typeof gust === "number" ? Math.round(gust) + " mph" : "--"));

          var sp = hourly.pressure_msl && hourly.pressure_msl[nearestIndex];
          setText(pressureEl, (typeof sp === "number" ? (sp * 0.029529983).toFixed(2) + " inHg" : "--"));

          var uvNow = hourly.uv_index && hourly.uv_index[nearestIndex];
          setText(uvEl, (typeof uvNow === "number" ? uvNow.toFixed(1) : "--"));

          var windSpd = hourly.windspeed_10m && hourly.windspeed_10m[nearestIndex];
          setText(windEl, (typeof windSpd === "number" ? Math.round(windSpd) + " mph" : "--"));

          setText(locMetaEl, "Updated " + fmt12NoSuffixFromDate(now));
          if (tempEl) tempEl.style.opacity = "1";

          // Today hi/lo
          var hi = daily.temperature_2m_max[0];
          var lo = daily.temperature_2m_min[0];
          var hiLoTextEl = document.getElementById("hilo-text");
          if (hiLoTextEl) hiLoTextEl.textContent = "High " + Math.round(hi) + " | Low " + Math.round(lo) + "";

          // Precip
          var precipProb = daily.precipitation_probability_max[0];

          var precipSum = (daily.precipitation_sum && daily.precipitation_sum[0] != null) ? daily.precipitation_sum[0] : 0;
          setText(precipAmtEl, precipSum.toFixed(2) + " in");
          setText(forecastRowEl, (precipProb != null ? ("Max " + Math.round(precipProb) + "%") : "--"));

          // Weather icon/text (daily code)
          var c = iconForCode(daily.weathercode[0]);
          if (condIconEl) condIconEl.src = c.i;
          setText(condTextEl, c.t);

          // Sunrise/sunset
          var srIsoToday = daily.sunrise[0];
          var ssIsoToday = daily.sunset[0];

          // Render new combined timeline
          renderTimeline(hourly, daily, nearestIndex);

          // Render TODAY Timeline widget (v4/v5)
          // Fetch Kp data then render
          fetchKpDataForToday(function(kpData){
            renderTodayTimeline(hourly, daily, nearestIndex, kpData);
          });

          // 7-day chips
          if (forecast7El){
            function iconUrlForDaily(code){
              if (code === 0) return METEO_BASE + "clear-day.svg";
              if (code === 1 || code === 2) return METEO_BASE + "partly-cloudy-day.svg";
              if (code === 3) return METEO_BASE + "overcast.svg";
              if (code === 45 || code === 48) return METEO_BASE + "fog.svg";
              if (code === 51 || code === 53 || code === 55) return METEO_BASE + "drizzle.svg";
              if (code === 56 || code === 57) return METEO_BASE + "sleet.svg";
              if (code === 61 || code === 63 || code === 65) return METEO_BASE + "rain.svg";
              if (code === 66 || code === 67) return METEO_BASE + "sleet.svg";
              if (code === 71 || code === 73 || code === 75) return METEO_BASE + "snow.svg";
              if (code === 77) return METEO_BASE + "sleet.svg";
              if (code === 80 || code === 81 || code === 82) return METEO_BASE + "rain.svg";
              if (code === 85 || code === 86) return METEO_BASE + "snow.svg";
              if (code === 95 || code === 96 || code === 99) return METEO_BASE + "thunderstorms-rain.svg";
              return METEO_BASE + "not-available.svg";
            }
            var daysHtml = "";
            
            // Find today's index in the daily array
            var todayStr = new Date().toISOString().split('T')[0];
            var startIdx = 0;
            for (var i = 0; i < daily.time.length; i++) {
              if (daily.time[i] === todayStr) {
                startIdx = i;
                break;
              }
            }
            
            // Mobile: 3 days, Desktop: 7 days
            var isMobileForecast = window.innerWidth <= 768;
            var forecastDays = isMobileForecast ? 3 : 7;
            
            // Update title
            var forecastLabel = document.querySelector('.forecast7-label');
            if (forecastLabel) forecastLabel.textContent = forecastDays + ' DAY FORECAST';
            
            // Find week min/max for bar normalization
            var weekMin = Infinity, weekMax = -Infinity;
            for (var wi = startIdx; wi < startIdx + forecastDays && wi < daily.time.length; wi++){
              var wHi = daily.temperature_2m_max[wi];
              var wLo = daily.temperature_2m_min[wi];
              if (wLo < weekMin) weekMin = wLo;
              if (wHi > weekMax) weekMax = wHi;
            }
            var weekRange = weekMax - weekMin || 1;
            
            for (var dIdx = startIdx; dIdx < startIdx + forecastDays && dIdx < daily.time.length; dIdx++){
              var dayDate = new Date(daily.time[dIdx]);
var dayName = dayDate.toLocaleDateString([], { weekday:"short" }).toUpperCase() + " | " + dayDate.getDate();
              var maxT = Math.round(daily.temperature_2m_max[dIdx]);
              var minT = Math.round(daily.temperature_2m_min[dIdx]);
              // Compute daily feels-like high and low from hourly apparent_temperature
              var feelsLo = null, feelsHi = null;
              if (hourly && hourly.apparent_temperature && hourly.time) {
                var dayStr = daily.time[dIdx];
                var dayFeels = [];
                for (var hi = 0; hi < hourly.time.length; hi++) {
                  if (hourly.time[hi].substring(0,10) === dayStr) {
                    dayFeels.push(hourly.apparent_temperature[hi]);
                  }
                }
                if (dayFeels.length > 0) {
                  feelsLo = Math.round(Math.min.apply(null, dayFeels));
                  feelsHi = Math.round(Math.max.apply(null, dayFeels));
                }
              }
              var icUrl = iconUrlForDaily(daily.weathercode[dIdx]);
              
              // Bar position: left% = where lo sits in week range, width% = day's range
              var barLeft = ((daily.temperature_2m_min[dIdx] - weekMin) / weekRange * 100).toFixed(1);
              var barWidth = (((daily.temperature_2m_max[dIdx] - daily.temperature_2m_min[dIdx]) / weekRange) * 100).toFixed(1);
              if (parseFloat(barWidth) < 8) barWidth = "8"; // minimum visible width
              
              // Color: smooth continuous gradient blue  cyan  green  yellow  orange  red
              // Uses actual temperature mapped to color stops with linear interpolation
              function tempColor(t){
                // t: 0=coldest in week, 1=warmest in week
                // Color stops: 0=blue, 0.25=cyan, 0.5=green, 0.75=yellow, 1.0=red
                var stops = [
                  [0.00, 0,200,255],    // vivid cyan
                  [0.25, 0,255,130],    // vivid green
                  [0.50, 255,230,0],    // vivid yellow
                  [0.75, 255,120,0],    // vivid orange
                  [1.00, 255,30,60]     // vivid red
                ];
                t = Math.max(0, Math.min(1, t));
                var i = 0;
                for(var s = 0; s < stops.length - 1; s++){
                  if(t >= stops[s][0] && t <= stops[s+1][0]){ i = s; break; }
                }
                var range = stops[i+1][0] - stops[i][0];
                var frac = range > 0 ? (t - stops[i][0]) / range : 0;
                var r = Math.round(stops[i][1] + frac * (stops[i+1][1] - stops[i][1]));
                var g = Math.round(stops[i][2] + frac * (stops[i+1][2] - stops[i][2]));
                var b = Math.round(stops[i][3] + frac * (stops[i+1][3] - stops[i][3]));
                return 'rgb('+r+','+g+','+b+')';
              }
              var loWarmth = (daily.temperature_2m_min[dIdx] - weekMin) / weekRange;
              var hiWarmth = (daily.temperature_2m_max[dIdx] - weekMin) / weekRange;
              var barColor = tempColor(loWarmth) + ', ' + tempColor(hiWarmth);
              
              // Precipitation probability & type
              var precipProb = daily.precipitation_probability_max ? Math.round(daily.precipitation_probability_max[dIdx]) : 0;
              var precipSum = daily.precipitation_sum ? daily.precipitation_sum[dIdx] : 0;
              var snowSum = daily.snowfall_sum ? daily.snowfall_sum[dIdx] : 0;
              var rainSum = daily.rain_sum ? daily.rain_sum[dIdx] : 0;
              var showersSum = daily.showers_sum ? daily.showers_sum[dIdx] : 0;
              
              // Determine precip type and build string
              var precipStr = "";
              if (precipProb > 0) {
                var precipIcon = "";
                var precipType = "";
                var wcode = daily.weathercode[dIdx];
                var isThunder = (wcode === 95 || wcode === 96 || wcode === 99);
                if (isThunder) {
                  precipIcon = ""; precipType = "T-STORM";
                } else if (snowSum > 0 && snowSum >= rainSum) {
                  precipIcon = ""; precipType = "SNOW";
                } else if (showersSum > 0 && showersSum >= rainSum * 0.5) {
                  precipIcon = ""; precipType = "SHOWERS";
                } else if (rainSum > 0.01 || precipSum > 0.01) {
                  precipIcon = ""; precipType = "RAIN";
                } else if (snowSum > 0 && rainSum > 0) {
                  precipIcon = ""; precipType = "MIX";
                }
                precipStr = precipIcon + ' ' + precipProb + '%';
                if (precipType === "SNOW" && snowSum > 0) {
                  precipStr += '  ' + snowSum.toFixed(1) + '" SNOW';
                } else if (precipType === "MIX" && snowSum > 0) {
                  precipStr += '  ' + snowSum.toFixed(1) + '" + ' + rainSum.toFixed(2) + '"';
                } else if (precipSum > 0.01) {
                  precipStr += '  ' + precipSum.toFixed(2) + '"';
                  if (precipType) precipStr += ' ' + precipType;
                } else if (precipType) {
                  precipStr += ' ' + precipType;
                }
              }
              
              // Wind with dominant direction
              var windMax = daily.windspeed_10m_max ? Math.round(daily.windspeed_10m_max[dIdx]) : null;
              var gustMax = daily.windgusts_10m_max ? Math.round(daily.windgusts_10m_max[dIdx]) : null;
              var windDir = daily.wind_direction_10m_dominant ? daily.wind_direction_10m_dominant[dIdx] : null;
              var windStr = "";
              if (windMax != null) {
                // Convert degrees to compass
                var dirStr = "";
                if (windDir != null) {
                  var dirs = ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
                  dirStr = dirs[Math.round(windDir / 22.5) % 16] + " ";
                }
                windStr = dirStr + windMax;
                if (gustMax != null && gustMax > windMax) {
                  windStr += " | " + gustMax;
                }
                windStr += " MPH";
              }
              
              // UV Index
              var uvMax = daily.uv_index_max ? Math.round(daily.uv_index_max[dIdx]) : null;
              var uvStr = "";
              var uvClass = "uv-low";
              if (uvMax != null && uvMax >= 0) {
                var uvLabel, uvIcon;
                if (uvMax <= 2) { uvLabel = "LOW"; uvClass = "uv-low"; uvIcon = ""; }
                else if (uvMax <= 5) { uvLabel = "MOD"; uvClass = "uv-mod"; uvIcon = ""; }
                else if (uvMax <= 7) { uvLabel = "HIGH"; uvClass = "uv-high"; uvIcon = ""; }
                else if (uvMax <= 10) { uvLabel = "V.HIGH"; uvClass = "uv-vhigh"; uvIcon = ""; }
                else { uvLabel = "EXTREME"; uvClass = "uv-extreme"; uvIcon = ""; }
                uvStr = uvIcon + " UV " + uvMax + " " + uvLabel;
              }
              
              daysHtml +=
                '<div class="forecast7-chip">' +
                  '<div class="day">'+dayName+'</div>' +
                  '<img class="icon" src="'+icUrl+'" alt="weather" />' +
                  '<div class="forecast7-bar-block">' +
  '<div class="bar-hi" style="margin-left:'+barLeft+'%; margin-right:'+(100 - parseFloat(barLeft) - parseFloat(barWidth)).toFixed(1)+'%;">' +
    (feelsHi !== null && feelsHi !== maxT ? '<span class="feels-hi">'+feelsHi+'</span>' : '') +
    '<span class="temps">'+maxT+'<span style="display:inline-block;width:0;overflow:visible;"></span></span>' +
  '</div>' +
  '<div class="forecast7-bar-wrap"><div class="forecast7-bar" style="left:'+barLeft+'%;width:'+barWidth+'%;background:linear-gradient(90deg,'+barColor+');"></div></div>' +
  '<div class="bar-lo" style="margin-left:'+barLeft+'%; margin-right:'+(100 - parseFloat(barLeft) - parseFloat(barWidth)).toFixed(1)+'%;">' +
    '<span class="forecast7-lo">'+minT+'</span>' +
    (feelsLo !== null && feelsLo !== minT ? '<span class="feels-lo">'+feelsLo+'</span>' : '') +
  '</div>' +
'</div>' +
                  (windStr ? '<div class="forecast7-wind">'+windStr+'</div>' : '') +
                  (uvStr ? '<div class="forecast7-uv '+uvClass+'">'+uvStr+'</div>' : '') +
                  (precipStr ? '<div class="forecast7-precip">'+precipStr+'</div>' : '') +
                '</div>';
            }
            forecast7El.innerHTML = daysHtml;
          }

          // Moon mini with NASA image
          var phaseFrac = approximateMoonPhase(new Date());
          var mi = moonInfo(phaseFrac);
          
          var moonImgEl = document.getElementById("moon-mini-img");
          if (moonImgEl){
            // Direct illumination-to-frame mapping for NASA SVS 2024 Moon dataset
            // Uses the January 2024 lunar cycle as our reference frames:
            // - New Moon (0%): frame 252 (Jan 11, 2024)
            // - First Quarter (50%): frame 430 (Jan 18, 2024)  
            // - Full Moon (100%): frame 607 (Jan 25, 2024)
            // - Last Quarter (50%): frame 785 (Feb 2, 2024)
            // - Back to New (0%): frame 961 (Feb 9, 2024)
            //
            // One lunar cycle = ~709 frames (29.53 days * 24 hours)
            // Waxing: frames 252-607 (new to full) = 355 frames for 0-100%
            // Waning: frames 607-961 (full to new) = 354 frames for 100-0%
            
            var isWaxing = phaseFrac < 0.5;
            var illumPct = mi.illum; // Use the already-calculated illumination percentage
            
            // NASA SVS 2024 Moon dataset frame mapping
            // After testing, the actual key frames in January 2024 cycle:
            // New Moon: ~frame 258 (Jan 11, 2024) - completely dark
            // Full Moon: ~frame 612 (Jan 25, 2024) - fully lit
            // Next New Moon: ~frame 966 (Feb 9, 2024)
            //
            // Waxing (new->full): frames 258-612, RIGHT side illuminates first
            // Waning (full->new): frames 612-966, LEFT side stays lit
            
            // NASA SVS Moon Phase datasets are HOURLY for the YEAR
            // Frame 1 = Jan 1 00:00 UTC, Frame 8760 = Dec 31 23:00 UTC
            // The frame number IS the hour of the year, not a phase position
            //
            // Reference from 2024 dataset testing (a005048):
            // - Frame 500 = new moon (~0%)
            // - Frame 562 = ~2-3% waxing crescent  
            // - Frame 580 = ~10-12%
            // - Frame 600 = ~20-25%
            // - Frame 4380 = full moon (100%)
            //
            // Use 2025 dataset (a005187) - 2026 dataset has issues
// Calculate frame based on phase position
// In 2025 dataset: frame 946 = new moon, frame 1300 = full moon
// One lunar cycle = ~709 frames
var newMoonFrame = 946;
var fullMoonFrame = 1300;
var lunarCycleFrames = 709;

// phaseFrac: 0 = new, 0.5 = full, 1 = new again
var frameOffset = Math.round(phaseFrac * lunarCycleFrames);
var frameNum = newMoonFrame + frameOffset;
if (frameNum > 8760) frameNum -= 8760;

var frameStr = String(frameNum).padStart(4, '0');
var moonUrl = "https://svs.gsfc.nasa.gov/vis/a000000/a005100/a005187/frames/730x730_1x1_30p/moon." + frameStr + ".jpg";
            
            moonImgEl.src = moonUrl;
            moonImgEl.onerror = function(){
              // On error, don't change the image - keep whatever was showing
              // This prevents jumping to wrong phase on temporary server errors
              this.onerror = null; // Prevent infinite loop
            };
          }
          
          var moonIllumEl = document.getElementById("moon-mini-illum");
          var moonPhaseEl = document.getElementById("moon-mini-phase");
          if (moonIllumEl) moonIllumEl.textContent = mi.illum + "%";
          if (moonPhaseEl) moonPhaseEl.textContent = mi.name;

          // Night window: sunset today -> sunrise tomorrow
          var ssLocal = new Date(ssIsoToday);
          var srIsoTomorrow = (daily.sunrise && daily.sunrise[1]) ? daily.sunrise[1] : daily.sunrise[0];
          var srLocal = new Date(srIsoTomorrow);

          // Update night sky title and cloud coverage
          var nightSkyCloudEl = document.getElementById("night-sky-cloud");
          var nightSkyConditionEl = document.getElementById("night-sky-condition");
          var moonPhaseDisplayEl = document.getElementById("moon-phase-display");
          var moonIllumDisplayEl = document.getElementById("moon-illum-display");
          var cloudLine = nightCloudLine(hourly, ssLocal, srLocal);
          
          if (cloudLine && cloudLine !== "--"){
            var cloudParts = cloudLine.split("  ");
            var condition = cloudParts[0] || "--";
            var coverage = cloudParts[1] || "--";
            
            if (nightSkyConditionEl) nightSkyConditionEl.textContent = condition;
            if (nightSkyCloudEl) nightSkyCloudEl.textContent = coverage;
          } else {
            if (nightSkyConditionEl) nightSkyConditionEl.textContent = "--";
            if (nightSkyCloudEl) nightSkyCloudEl.textContent = "--";
          }
          
          // Update moon info in night sky header
          if (moonPhaseDisplayEl) moonPhaseDisplayEl.textContent = mi.name;
          if (moonIllumDisplayEl) moonIllumDisplayEl.textContent = mi.illum + "%";

          // Space events bullets
          var now2 = new Date();
          var met = nextMeteorPeak(now2);
          var eclipse = nextEclipse(now2);
          var conj = nextConjunction(now2);
          var opp = nextOpposition(now2);

          // Hide/blank the big headline (your current intent)
          if (spaceEventsEl) spaceEventsEl.textContent = "";

          if (spaceEventsBulletsEl){
            var bullets = "";

            var nextFull = findNextMoonEvent(now2, 0.50, 40);
            var nextNew  = findNextMoonEvent(now2, 0.00, 40);

            // 1. NEXT NEW MOON (dark sky window)
            if (nextNew){
              var duN = daysUntil(now2, nextNew);
              bullets += bulletHtml(
                "NEXT NEW MOON",
                fmtMonthDay(nextNew),
                "In " + duN + "d  Darkest skies for deep-sky objects, galaxies, nebulae  Prime Milky Way window: " + dayRangeAround(nextNew, 4)
              );
            }

          

            // 2. NEXT CONJUNCTION
            if (conj){
              var duC = daysUntil(now2, conj.d);
              bullets += bulletHtml(
                "NEXT CONJUNCTION",
                fmtMonthDay(conj.d),
                conj.bodies + "  " + conj.separation + " apart  Look " + conj.direction + " at " + conj.time.toLowerCase() + "  In " + duC + "d  " + conj.note
              );
            }

            // 3. NEXT OPPOSITION
            if (opp){
              var duO = daysUntil(now2, opp.d);
              bullets += bulletHtml(
                "NEXT OPPOSITION",
                fmtMonthDay(opp.d),
                opp.planet + " at magnitude " + opp.magnitude + " in " + opp.constellation + "  In " + duO + "d  " + opp.note
              );
            }

            // 4. METEOR SHOWER PEAK
            if (met){
              var when = (met.days === 0 ? "Tonight" : (met.days === 1 ? "Tomorrow" : ("In " + met.days + "d")));
              var showerData = METEOR_SHOWERS.find(function(s){ return s.name === met.name; });
              var zhr = showerData ? showerData.zhr : "?";
              var speed = showerData ? Math.round(showerData.speed).toLocaleString() : "?";
              var direction = showerData ? showerData.direction : "?";
              var radiantRise = showerData ? showerData.radiantRise : "?";
              var bestView = showerData ? showerData.bestView : "After midnight";
              bullets += bulletHtml(
                "METEOR SHOWER PEAK",
                when,
                met.name + "  " + fmtMonthDay(met.start) + "  Up to " + zhr + "/hr  " + speed + " mph  Look " + direction + "  Radiant rises " + radiantRise + "  Best viewing: " + bestView
              );
            }

            // 5. NEXT ECLIPSE
            if (eclipse){
              bullets += bulletHtml(
                "NEXT ECLIPSE",
                fmtMonthDay(eclipse.d),
                eclipse.type + "  " + eclipse.note
              );
            }

            // 5.5 RECENT FIREBALL (fetched async, injected later)
            
            // 6. NEXT FULL MOON
            if (nextFull){
              var duF = daysUntil(now2, nextFull);
              bullets += bulletHtml(
                "NEXT FULL MOON",
                fmtMonthDay(nextFull),
                "In " + duF + "d  Rises at sunset, sets at sunrise  Peak illumination for lunar photography  Avoid deep-sky imaging " + dayRangeAround(nextFull, 3)
              );
            }

            // VOYAGER 1 TRACKER (bottom)
            (function(){
              // Voyager 1 reference: 163.7 AU on Jan 1, 2025 00:00 UTC
              var refDate = new Date(Date.UTC(2025, 0, 1, 0, 0, 0));
              var refDistanceMiles = 15215899826.1; // miles on Jan 1, 2025
              var speedMph = 38210.55; // precise speed in mph
              var launchDate = new Date(Date.UTC(1977, 8, 5, 12, 56, 0)); // Sept 5, 1977 12:56 UTC
              
              // Calculate current distance in miles (updated every second conceptually)
              var msSinceRef = now2.getTime() - refDate.getTime();
              var hoursSinceRef = msSinceRef / (1000 * 60 * 60);
              var currentMiles = refDistanceMiles + (hoursSinceRef * speedMph);
              
              // Format with commas
              var milesFormatted = Math.floor(currentMiles).toLocaleString();
              
              // AU conversion
              var currentAU = currentMiles / 92955807.3;
              
              // Light time delay
              var lightSeconds = currentAU * 499.004784;
              var lightHours = Math.floor(lightSeconds / 3600);
              var lightMins = Math.floor((lightSeconds % 3600) / 60);
              var lightTimeStr = lightHours + "h " + lightMins + "m";
              
              // Mission duration
              var missionMs = now2.getTime() - launchDate.getTime();
              var missionYears = Math.floor(missionMs / (1000 * 60 * 60 * 24 * 365.25));
              var missionMonths = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 365.25)) / (1000 * 60 * 60 * 24 * 30.44));
              var missionDays = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 30.44)) / (1000 * 60 * 60 * 24));
              var missionStr = missionYears + "y " + missionMonths + "m " + missionDays + "d";
              
              bullets += bulletHtml(
                "VOYAGER 1",
                missionStr + " in flight",
                "Interstellar space  Local Interstellar Cloud  " + milesFormatted + " mi  Light delay " + lightTimeStr + "  " + speedMph.toLocaleString() + " mph"
              );
            })();

            spaceEventsBulletsEl.innerHTML = bullets;
            
            // ISS LIVE TRACKER with next pass estimation
            (function(){
              var issApiUrl = "https://api.wheretheiss.at/v1/satellites/25544";
              
              function haversineMi(lat1, lon1, lat2, lon2){
                var R = 3959;
                var dLat = (lat2-lat1)*Math.PI/180;
                var dLon = (lon2-lon1)*Math.PI/180;
                var a = Math.sin(dLat/2)*Math.sin(dLat/2) +
                        Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
                        Math.sin(dLon/2)*Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
              }
              
              function bearingDir(lat1, lon1, lat2, lon2){
                var y = Math.sin((lon2-lon1)*Math.PI/180)*Math.cos(lat2*Math.PI/180);
                var x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) -
                        Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos((lon2-lon1)*Math.PI/180);
                var b = Math.atan2(y,x)*180/Math.PI;
                if(b<0)b+=360;
                var dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
                return dirs[Math.round(b/22.5)%16];
              }
              
              var ORBIT_PERIOD_MIN = 92.68;
              var ISS_INCL = 51.6;
              
              fetch(issApiUrl)
                .then(function(r){ return r.json(); })
                .then(function(data){
                  var issLat = data.latitude;
                  var issLon = data.longitude;
                  var issAlt = Math.round(data.altitude * 0.621371); // km to miles
                  var issSpeed = Math.round(data.velocity * 0.621371); // km/h to mph
                  var visibility = data.visibility; // "daylight", "eclipsed", "penumbra"
                  
                  var groundDist = Math.round(haversineMi(LOCATION.lat, LOCATION.lon, issLat, issLon));
                  var totalDist = Math.round(Math.sqrt(groundDist*groundDist + issAlt*issAlt));
                  var dirStr = bearingDir(LOCATION.lat, LOCATION.lon, issLat, issLon);
                  
                  // Estimate next close pass using orbital mechanics
                  var userLat = LOCATION.lat;
                  var userLon = LOCATION.lon;
                  var bestPassMin = null;
                  var bestPassDist = Infinity;
                  
                  for(var orbit = 0; orbit < 48; orbit++){
                    var tMin = orbit * ORBIT_PERIOD_MIN;
                    var lonShiftPerOrbit = -22.5;
                    var currentPhase = Math.asin(Math.max(-1, Math.min(1, issLat / ISS_INCL)));
                    
                    for(var frac = 0; frac < 1; frac += 0.05){
                      var tCheck = tMin + frac * ORBIT_PERIOD_MIN;
                      var futLat = ISS_INCL * Math.sin(currentPhase + 2 * Math.PI * tCheck / ORBIT_PERIOD_MIN);
                      var futLon = issLon + (lonShiftPerOrbit * tCheck / ORBIT_PERIOD_MIN);
                      while(futLon > 180) futLon -= 360;
                      while(futLon < -180) futLon += 360;
                      
                      var dist = haversineMi(userLat, userLon, futLat, futLon);
                      if(dist < bestPassDist && tCheck > 5){
                        bestPassDist = dist;
                        bestPassMin = tCheck;
                      }
                    }
                  }
                  
                  // Format next pass estimate
                  var passStr = "";
                  if(bestPassMin !== null && bestPassDist < 800){
                    var passTime = new Date(Date.now() + bestPassMin * 60000);
                    var h = passTime.getHours();
                    var m = passTime.getMinutes();
                    var ampm = h >= 12 ? "PM" : "AM";
                    var hh = h % 12; if(hh === 0) hh = 12;
                    var timeStr = hh + ":" + (m < 10 ? "0"+m : m) + " " + ampm;
                    
                    var hoursUntil = Math.floor(bestPassMin / 60);
                    var minsUntil = Math.round(bestPassMin % 60);
                    var untilStr = hoursUntil > 0 ? (hoursUntil + "h " + minsUntil + "m") : (minsUntil + "m");
                    
                    passStr = "  NEXT PASS ~" + timeStr + " (in ~" + untilStr + ")";
                  } else if(bestPassMin !== null){
                    var hoursUntil2 = Math.floor(bestPassMin / 60);
                    var minsUntil2 = Math.round(bestPassMin % 60);
                    var untilStr2 = hoursUntil2 > 0 ? (hoursUntil2 + "h " + minsUntil2 + "m") : (minsUntil2 + "m");
                    passStr = "  NEXT PASS in ~" + untilStr2;
                  }
                  
                  var isNearby = groundDist < 500;
                  var statusStr = isNearby ? " NEARBY  LOOK UP!" : (totalDist.toLocaleString() + " mi " + dirStr);
                  
                  var issBullet = bulletHtml(
                    "ISS TRACKER",
                    statusStr,
                    "Alt " + issAlt + " mi  " + issSpeed.toLocaleString() + " mph  " + visibility + passStr
                  );
                  
                  if(spaceEventsBulletsEl){
                    spaceEventsBulletsEl.innerHTML += issBullet;
                  }
                })
                .catch(function(err){
                  console.log("ISS tracker error:", err);
                });
            })();
          }

          // Night sky SVG (windows + cloud series)
          if (nightSkySvg){
            var bodies = ["moon","mercury","venus","mars","jupiter","saturn","uranus","neptune"];
            var startObs2 = new Date(ssLocal.getTime());
            var endObs2 = new Date(srLocal.getTime());
            if (endObs2 <= startObs2) endObs2 = new Date(startObs2.getTime() + 10*60*60*1000);

            var windows = computeVisibilityWindows(startObs2, endObs2, bodies, LOCATION.lat, LOCATION.lon);

            var nameMap = {
              moon:"Moon", mercury:"Mercury", venus:"Venus", mars:"Mars",
              jupiter:"Jupiter", saturn:"Saturn", uranus:"Uranus", neptune:"Neptune"
            };

            var show = {};
            for (var p in windows){
              if (!windows[p]) continue;
              var label = nameMap[p] || p;
              var w = windows[p];
              show[label] = {
                any: !!w.any,
                first: w.first || null,
                last: w.last || null,
                segments: w.segments || []
              };
            }

            var cloudSeries = [];
            if (hourly && hourly.time && hourly.cloudcover){
              for (var ci=0; ci<hourly.time.length; ci++){
                var dtc = new Date(hourly.time[ci]);
                if (dtc >= startObs2 && dtc <= endObs2){
                  var cc = hourly.cloudcover[ci];
                  if (typeof cc === "number" && isFinite(cc)){
                    cloudSeries.push({ t: dtc, cc: clamp(cc, 0, 100) });
                  }
                }
              }
            }

            // Fetch Kp data for aurora bar
            fetchKpDataForNight(startObs2, endObs2, function(kpSeries){
              drawNightSkyBar(nightSkySvg, nightSkyLegend, startObs2, endObs2, show, cloudSeries, kpSeries);
            });
          }

        } catch(e){
          console.error("Weather parse error", e);
          setText(condTextEl, "Data error");
        }
      })
      .catch(function(err){
        console.error("Weather load error", err);
        setText(condTextEl, "Network error");
      });
  }

  /* =========================================================
     RADAR autoplay (NWS RIDGE loop GIF)
     ========================================================= */
  var radarRefreshTimer = null;
  function startRadarNwsLoop(){
    if (!radarLiveEl || !radarImg) return;

    var STATION = LOCATION.radar || "KENX";
    var region = LOCATION.radarRegion || "NORTHEAST";
    var base = "https://radar.weather.gov/ridge/standard/" + region + "_loop.gif";

    // Update radar subtitle
    var radarSubEl = document.querySelector(".widget:has(#radar-img) .widget-sub");
    if (radarSubEl) radarSubEl.textContent = LOCATION.radarName || "NWS";

    function refresh(){
      radarImg.src = base + "?cb=" + Date.now();
      radarImg.style.filter = "invert(1) hue-rotate(180deg) contrast(1.4) saturate(1.8)";
      radarLiveEl.textContent = " LIVE";
      
      // Update timestamp
      var tsEl = document.getElementById("local-radar-timestamp");
      if (tsEl) {
        var d = new Date();
        var h = d.getHours();
        var m = d.getMinutes();
        var ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12; if (h === 0) h = 12;
        tsEl.textContent = h + ':' + (m < 10 ? '0' + m : m) + ' ' + ampm;
      }
    }

    refresh();
    if (radarRefreshTimer) clearInterval(radarRefreshTimer);
    radarRefreshTimer = setInterval(refresh, 2 * 60 * 1000);
  }

  /* =========================================================
     AURORA (Animated from OVATION JSON)
     ========================================================= */
  var auroraAnim = {
    frames: [],
    idx: 0,
    playing: true,
    timer: null,
    refreshTimer: null,
    ctx: null
  };
  
  function startAuroraBlackBackground(){
    if (!auroraCanvas || !auroraLiveEl) return;

    auroraAnim.ctx = auroraCanvas.getContext("2d");
    var JSON_URL = "https://services.swpc.noaa.gov/products/animations/ovation_north_24h.json";
    var FALLBACK_URL = "https://services.swpc.noaa.gov/images/animations/ovation/north/latest.jpg";

    function resizeToDisplaySize(){
      var parent = auroraCanvas.parentElement;
      if (!parent) return;
      var w = Math.max(1, parent.clientWidth);
      var h = Math.max(1, parent.clientHeight);
      if (auroraCanvas.width !== w || auroraCanvas.height !== h){
        auroraCanvas.width = w;
        auroraCanvas.height = h;
      }
    }

    function drawCover(img){
      var ctx = auroraAnim.ctx;
      var cw = auroraCanvas.width, ch = auroraCanvas.height;
      var iw = img.naturalWidth, ih = img.naturalHeight;
      var scale = Math.max(cw / iw, ch / ih);
      var dw = iw * scale, dh = ih * scale;
      var dx = (cw - dw) / 2;
      var dy = (ch - dh) / 2;

      ctx.clearRect(0,0,cw,ch);
      ctx.fillStyle = "#000";
      ctx.fillRect(0,0,cw,ch);
      ctx.drawImage(img, dx, dy, dw, dh);
    }

    function showFallback(){
      if (auroraFallbackImg){
        auroraFallbackImg.style.display = "block";
        auroraFallbackImg.src = FALLBACK_URL + "?cb=" + Date.now();
      }
      auroraCanvas.style.display = "none";
      auroraLiveEl.textContent = " LIVE";
    }

    function loadFrames(){
      auroraLiveEl.textContent = " LOADING";
      resizeToDisplaySize();
      
      fetchWithTimeout(JSON_URL, null, 15000)
        .then(function(r){ return r.json(); })
        .then(function(data){
          if (data && data.length > 0){
            auroraAnim.frames = data.map(function(f){
              return "https://services.swpc.noaa.gov" + f.url;
            });
            auroraAnim.idx = 0;
            auroraLiveEl.textContent = " LIVE";
            auroraCanvas.style.display = "block";
            if (auroraFallbackImg) auroraFallbackImg.style.display = "none";
            startAuroraAnimation();
          } else {
            throw new Error("No frames");
          }
        })
        .catch(function(){
          showFallback();
        });
    }
    
    function startAuroraAnimation(){
      if (auroraAnim.timer) clearTimeout(auroraAnim.timer);
      
      function step(){
        if (auroraAnim.playing && auroraAnim.frames.length > 0){
          var img = new Image();
          img.crossOrigin = "anonymous";
          img.onload = function(){
            try {
              resizeToDisplaySize();
              drawCover(img);
            } catch(e){}
          };
          img.src = auroraAnim.frames[auroraAnim.idx];
          auroraAnim.idx = (auroraAnim.idx + 1) % auroraAnim.frames.length;
        }
        auroraAnim.timer = setTimeout(step, 200);
      }
      step();
    }

    loadFrames();
    
    if (auroraAnim.refreshTimer) clearInterval(auroraAnim.refreshTimer);
    auroraAnim.refreshTimer = setInterval(loadFrames, 5 * 60 * 1000);
    
    var resizeDebounceTimer = null;
    window.addEventListener("resize", function(){ 
      if (resizeDebounceTimer) clearTimeout(resizeDebounceTimer);
      resizeDebounceTimer = setTimeout(resizeToDisplaySize, 150);
    });
  }

    /* =========================================================
     KP DATA FOR TODAY TIMELINE (full 24 hours)
     ========================================================= */
  function fetchKpDataForToday(callback){
    var url = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json";
    
    var now = new Date();
    var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
    var todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
    
    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(rows){
        var kpSeries = [];
        
        if (!rows || rows.length < 2){
          callback(kpSeries);
          return;
        }
        
        // Find column indices
        var header = rows[0];
        var timeIdx = header.indexOf("time_tag");
        var kpIdx = header.indexOf("kp");
        
        if (timeIdx < 0 || kpIdx < 0){
          callback(kpSeries);
          return;
        }
        
        // Parse data rows
        for (var i = 1; i < rows.length; i++){
          var row = rows[i];
          if (!row || row.length <= Math.max(timeIdx, kpIdx)) continue;
          
          var timeStr = row[timeIdx];
          var kpVal = parseFloat(row[kpIdx]);
          
          if (!timeStr || isNaN(kpVal)) continue;
          
          // Parse UTC time (format: "2026-01-12 18:00:00")
          var dt = new Date(timeStr.replace(" ", "T") + "Z");
          if (!isFinite(dt.getTime())) continue;
          
          // Check if this falls within today (with buffer)
          var bufferMs = 6 * 60 * 60 * 1000;
          if (dt >= new Date(todayStart.getTime() - bufferMs) && 
              dt <= new Date(todayEnd.getTime() + bufferMs)){
            kpSeries.push({ t: dt, kp: kpVal });
          }
        }
        
        callback(kpSeries);
      })
      .catch(function(err){
        console.log("Kp data fetch error:", err);
        callback([]);
      });
  }

  /* =========================================================
     KP DATA FOR NIGHT SKY BAR
     ========================================================= */
  function fetchKpDataForNight(sunsetLocal, sunriseLocal, callback){
    var url = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json";
    
    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(rows){
        var kpSeries = [];
        
        if (!rows || rows.length < 2){
          callback(kpSeries);
          return;
        }
        
        // Find column indices
        var header = rows[0];
        var timeIdx = header.indexOf("time_tag");
        var kpIdx = header.indexOf("kp");
        
        if (timeIdx < 0 || kpIdx < 0){
          callback(kpSeries);
          return;
        }
        
        // Parse data rows
        for (var i = 1; i < rows.length; i++){
          var row = rows[i];
          if (!row || row.length <= Math.max(timeIdx, kpIdx)) continue;
          
          var timeStr = row[timeIdx];
          var kpVal = parseFloat(row[kpIdx]);
          
          if (!timeStr || isNaN(kpVal)) continue;
          
          // Parse UTC time (format: "2026-01-12 18:00:00")
          var dt = new Date(timeStr.replace(" ", "T") + "Z");
          if (!isFinite(dt.getTime())) continue;
          
          // Check if this falls within our night window (with some buffer)
          var bufferMs = 6 * 60 * 60 * 1000; // 6 hour buffer
          if (dt >= new Date(sunsetLocal.getTime() - bufferMs) && 
              dt <= new Date(sunriseLocal.getTime() + bufferMs)){
            kpSeries.push({ t: dt, kp: kpVal });
          }
        }
        
        callback(kpSeries);
      })
      .catch(function(err){
        console.log("Kp data fetch error:", err);
        callback([]);
      });
  }
  // Approximate geomagnetic latitude from geographic latitude (simplified)
  // US locations are roughly 10-12 lower geomagnetically than geographically
  function geomagLat(lat){
    return lat - 11;
  }

  // Minimum Kp needed to potentially see aurora at a given geomagnetic latitude
  // Based on SWPC guidelines: aurora oval reaches ~66 at Kp0, moves 2 equatorward per Kp level
  // But aurora can be VISIBLE on horizon ~600 miles (10) beyond the oval edge
  function minKpForLat(geomagLat){
    // For overhead aurora (oval edge)
    // Kp 0 = 66, Kp 1 = 64, ... Kp 9 = 48
    
    // For horizon visibility, subtract ~8-10 (can see ~600mi north)
    // So effective visibility: Kp 5 reaches ~56 overhead but visible from ~46
    
    if (geomagLat >= 66) return 0;  // Under the oval
    if (geomagLat >= 62) return 2;
    if (geomagLat >= 58) return 4;
    if (geomagLat >= 54) return 5;  // Northern US - Kp 5-6
    if (geomagLat >= 50) return 6;
    if (geomagLat >= 45) return 7;  // Central US - Kp 7+
    if (geomagLat >= 40) return 7;  // Mid-latitudes - strong storm
    if (geomagLat >= 35) return 8;  // Southern US - severe storm
    if (geomagLat >= 30) return 8;  // Deep south - G4+ storm
    return 9; // Below 30 geomagnetic - extreme G5 storm only
  }

  function auroraVisibilityPctFromKp(kp, lat){
    if (kp == null || isNaN(kp)) return null;
    if (lat == null) lat = 41.7; // Default to Pleasant Valley
    
    var gLat = geomagLat(lat);
    var minKp = minKpForLat(gLat);
    
    // How far above minimum Kp are we?
    var margin = kp - minKp;
    
    if (margin < 0) return 0;        // Below threshold - no chance
    if (margin < 0.5) return 5;      // Just at threshold - slim chance
    if (margin < 1) return 15;       // Slightly above - possible
    if (margin < 2) return 35;       // Good margin - likely visible
    if (margin < 3) return 60;       // Well above - very likely
    return 80;                        // Strong storm - excellent chance
  }

  function visLabel(pct){
    if (pct == null) return "--";
    if (pct <= 0) return "No";
    if (pct <= 5) return "Slim";
    return pct + "%";
  }

  function updateSolarMini(){
    if (!swKp || !swG || !swBz || !swWind || !swVis) return;

    swKp.textContent="--"; swG.textContent="--"; swBz.textContent="--"; swWind.textContent="--"; swVis.textContent="--";

    fetchWithTimeout("https://services.swpc.noaa.gov/products/wing-kp.json", null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        try{
          if (!data || data.length < 2) throw new Error("No Wing Kp data");
          
          // Wing Kp format: array of arrays [time_tag, kp, kp_1hr, kp_4hr]
          // Skip header row if present
          var startIdx = (data[0] && typeof data[0][0] === 'string' && data[0][0].toLowerCase().indexOf('time') > -1) ? 1 : 0;
          
          // Get the most recent row
          var latestRow = data[data.length - 1];
          var kpVal = parseFloat(latestRow[1]); // Current Kp estimate
          
          if (isNaN(kpVal)) throw new Error("Invalid Kp value");
          
          swKp.textContent = kpVal.toFixed(1);
          
          // Determine G-scale from Kp
          var gScale = "G0";
          if (kpVal >= 9) gScale = "G5";
          else if (kpVal >= 8) gScale = "G4";
          else if (kpVal >= 7) gScale = "G3";
          else if (kpVal >= 6) gScale = "G2";
          else if (kpVal >= 5) gScale = "G1";
          
          swG.textContent = gScale;
          swVis.textContent = visLabel(auroraVisibilityPctFromKp(kpVal, LOCATION.lat));
        } catch(e){
          console.log("Wing Kp error, falling back to forecast:", e);
          // Fallback to regular Kp forecast
          fetchWithTimeout("https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json", null, 12000)
            .then(function(r){ return r.json(); })
            .then(function(rows){
              try{
                var header = rows && rows[0];
                if (!header) return;
                var kpIdx = header.indexOf("kp");
                var obsIdx = header.indexOf("observed");
                var scaleIdx = header.indexOf("noaa_scale");
                var latestRow = null;
                for (var i=rows.length-1;i>0;i--){
                  var row = rows[i];
                  if (!row || row.length <= kpIdx) continue;
                  var obsType = row[obsIdx];
                  if (obsType === "observed" || obsType === "estimated"){ latestRow = row; break; }
                }
                if (!latestRow) latestRow = rows[rows.length-1];
                var kpVal = parseFloat(latestRow[kpIdx]);
                var gScale = (scaleIdx >= 0 ? latestRow[scaleIdx] : "") || "";
                if (!isNaN(kpVal)){
                  swKp.textContent = kpVal.toFixed(1);
                  swG.textContent = gScale ? String(gScale) : "G0";
                  swVis.textContent = visLabel(auroraVisibilityPctFromKp(kpVal, LOCATION.lat));
                }
              } catch(e2){}
            })
            .catch(function(){});
        }
      })
      .catch(function(){
        console.log("Wing Kp fetch failed, trying fallback");
        // Fallback to regular Kp forecast
        fetchWithTimeout("https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json", null, 12000)
          .then(function(r){ return r.json(); })
          .then(function(rows){
            try{
              var header = rows && rows[0];
              if (!header) return;
              var kpIdx = header.indexOf("kp");
              var obsIdx = header.indexOf("observed");
              var scaleIdx = header.indexOf("noaa_scale");
              var latestRow = null;
              for (var i=rows.length-1;i>0;i--){
                var row = rows[i];
                if (!row || row.length <= kpIdx) continue;
                var obsType = row[obsIdx];
                if (obsType === "observed" || obsType === "estimated"){ latestRow = row; break; }
              }
              if (!latestRow) latestRow = rows[rows.length-1];
              var kpVal = parseFloat(latestRow[kpIdx]);
              var gScale = (scaleIdx >= 0 ? latestRow[scaleIdx] : "") || "";
              if (!isNaN(kpVal)){
                swKp.textContent = kpVal.toFixed(1);
                swG.textContent = gScale ? String(gScale) : "G0";
                swVis.textContent = visLabel(auroraVisibilityPctFromKp(kpVal, LOCATION.lat));
              }
            } catch(e2){}
          })
          .catch(function(){});
      });

    Promise.all([
      fetchWithTimeout("https://services.swpc.noaa.gov/products/solar-wind/plasma-5-minute.json", null, 12000).then(function(r){return r.json();}).catch(function(){return null;}),
      fetchWithTimeout("https://services.swpc.noaa.gov/products/solar-wind/mag-5-minute.json", null, 12000).then(function(r){return r.json();}).catch(function(){return null;})
    ]).then(function(all){
      try{
        var plasma = all[0], mag = all[1];

        if (plasma && plasma.length > 1){
          var ph = plasma[0];
          var speedIdx = ph.indexOf("speed");
          var last = plasma[plasma.length-1];
          var spd = speedIdx >= 0 ? parseFloat(last[speedIdx]) : NaN;
          if (!isNaN(spd)) swWind.textContent = Math.round(spd) + " km/s";
        }

        if (mag && mag.length > 1){
          var mh = mag[0];
          var bzIdx = mh.indexOf("bz_gsm");
          var lastm = mag[mag.length-1];
          var bz = bzIdx >= 0 ? parseFloat(lastm[bzIdx]) : NaN;
          if (!isNaN(bz)) swBz.textContent = (bz >= 0 ? "+" : "") + bz.toFixed(1) + " nT";
        }
      } catch(e){}
    });
  }

  /* =========================================================
     GOES autoplay (NE sector)
     ========================================================= */
  var goesTimer = null;
  var goesRefreshTimer = null;
  var goesFrames = [];
  var goesIdx = 0;

  function fetchGoesFrames(){
    if (!goesLiveEl) return Promise.resolve();

    var goesSat = (LOCATION.goes && LOCATION.goes.sat) || "G19";
    var goesSector = (LOCATION.goes && LOCATION.goes.sector) || "ne";
    var indexUrl = "https://www.star.nesdis.noaa.gov/GOES/sector_band.php?band=GEOCOLOR&sat=" + goesSat + "&sector=" + goesSector + "&length=72";
    goesLiveEl.textContent = " LOADING";

    return fetchWithTimeout(indexUrl, null, 12000)
      .then(function(r){ return r.text(); })
      .then(function(html){
        var goesNum = goesSat === "G18" ? "GOES18" : "GOES19";
        var re = new RegExp("https://cdn\\.star\\.nesdis\\.noaa\\.gov/" + goesNum + "/ABI/SECTOR/" + goesSector + "/GEOCOLOR/[^\"' ]+\\.jpg", "gi");
    
        // Update subtitle
        var goesSubEl = document.getElementById("goes-sub");
        var sectorNames = { ne: "NORTHEAST", se: "SOUTHEAST", wus: "WEST US", umv: "UPPER MISSISSIPPI VALLEY" };
        var satName = goesSat === "G18" ? "GOES-18" : "GOES-19";
        if (goesSubEl) goesSubEl.textContent = "NESDIS/STAR " + satName + " | " + (sectorNames[goesSector] || goesSector.toUpperCase()) + "  GEOCOLOR";

        var matches = html.match(re) || [];
        var seen = Object.create(null);
        var uniq = [];

        for (var i=0;i<matches.length;i++){
          var u = matches[i];
          if (seen[u]) continue;
          seen[u] = true;
          uniq.push(u);
        }

        if (uniq.length){
          goesFrames = uniq.slice(-72);
          goesIdx = 0;
          goesLiveEl.textContent = " LIVE";
          if (goesFrameEl) goesFrameEl.textContent = "--/--";
        } else {
          goesLiveEl.textContent = " OFFLINE";
        }
      })
      .catch(function(){
        goesLiveEl.textContent = " OFFLINE";
      });
  }

  function startGoesAutoplay(){
    if (!goesImg) return;

    function step(){
      if (!goesFrames || !goesFrames.length) return;

      var u0 = goesFrames[goesIdx];
      goesImg.src = u0 + (u0.indexOf("?") >= 0 ? "&" : "?") + "cb=" + Date.now();

      var n = goesFrames.length;
      if (goesFrameEl) goesFrameEl.textContent = (goesIdx+1) + "/" + n;

      goesIdx = (goesIdx + 1) % n;
    }

    fetchGoesFrames().then(function(){
      step();
      if (goesTimer) clearInterval(goesTimer);
      goesTimer = setInterval(step, 300);

      if (goesRefreshTimer) clearInterval(goesRefreshTimer);
      goesRefreshTimer = setInterval(fetchGoesFrames, 5 * 60 * 1000);
    });
  }

  /* =========================================================
     SPACE WEATHER ANIMATIONS
     (Geospace Velocity/Density/Pressure, WSA-Enlil, LASCO C2/C3)
     ========================================================= */
  
  // Animation state for each widget
  var animations = {
    geoVel:  { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    geoDen:  { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    geoPre:  { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    enlil:   { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    lascoC3: { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null },
    lascoC2: { frames: [], idx: 0, playing: true, timer: null, imgEl: null, liveEl: null, btnEl: null }
  };
  

  
  // Generic animation runner
  function runAnimation(key, fps){
    var anim = animations[key];
    if (!anim || !anim.imgEl) return;
    
    function step(){
      if (anim.playing && anim.frames.length > 0){
        anim.imgEl.src = anim.frames[anim.idx];
        anim.idx = (anim.idx + 1) % anim.frames.length;
      }
      anim.timer = setTimeout(step, 1000 / fps);
    }
    step();
  }
  
  // Load animation frames from SWPC JSON
  function loadAnimationFrames(jsonUrl, key, fps, fallbackUrl){
    var anim = animations[key];
    if (!anim || !anim.imgEl) return;
    
    if (anim.liveEl) anim.liveEl.textContent = " LOADING";
    
    fetchWithTimeout(jsonUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.length > 0){
          anim.frames = data.map(function(f){
            return "https://services.swpc.noaa.gov" + f.url;
          });
          if (anim.liveEl) anim.liveEl.textContent = " LIVE";
          runAnimation(key, fps);
        } else {
          throw new Error("No frames");
        }
      })
      .catch(function(){
        // Fallback to static image
        if (fallbackUrl){
          anim.imgEl.src = fallbackUrl + "?cb=" + Date.now();
        }
        if (anim.liveEl) anim.liveEl.textContent = " LIVE";
        if (anim.btnEl) anim.btnEl.style.display = "none";
      });
  }
  
  // Load static/GIF images with periodic refresh (for sources without JSON)
  
    function initSpaceWeatherAnimations(){
    // Bind DOM elements
    animations.enlil.imgEl = document.getElementById("enlil-img");
    animations.enlil.liveEl = document.getElementById("enlil-live");
    animations.enlil.btnEl = document.getElementById("enlil-btn");
    
    animations.lascoC3.imgEl = document.getElementById("lasco-c3-img");
    animations.lascoC3.liveEl = document.getElementById("lasco-c3-live");
    animations.lascoC3.btnEl = document.getElementById("lasco-c3-btn");
    
    animations.lascoC2.imgEl = document.getElementById("lasco-c2-img");
    animations.lascoC2.liveEl = document.getElementById("lasco-c2-live");
    animations.lascoC2.btnEl = document.getElementById("lasco-c2-btn");
    
    // Load WSA-Enlil animation (8 fps - faster for solar wind)
    loadAnimationFrames(
      "https://services.swpc.noaa.gov/products/animations/enlil.json",
      "enlil", 8,
      "https://services.swpc.noaa.gov/images/animations/enlil/latest.jpg"
    );
    
    // Load LASCO animations (6 fps)
    loadAnimationFrames(
      "https://services.swpc.noaa.gov/products/animations/lasco-c3.json",
      "lascoC3", 6,
      "https://soho.nascom.nasa.gov/data/realtime/c3/512/latest.jpg"
    );
    
    loadAnimationFrames(
      "https://services.swpc.noaa.gov/products/animations/lasco-c2.json",
      "lascoC2", 6,
      "https://soho.nascom.nasa.gov/data/realtime/c2/512/latest.jpg"
    );
    
    // Load Geospace animated images
    loadGeospaceAnimations();
  }
  
  function loadGeospaceAnimations(){
    var geoWidgets = [
      { id: "geo-vel-img", liveId: "geo-vel-live", jsonUrl: "https://services.swpc.noaa.gov/products/animations/geospace/velocity.json" },
      { id: "geo-den-img", liveId: "geo-den-live", jsonUrl: "https://services.swpc.noaa.gov/products/animations/geospace/density.json" },
      { id: "geo-pre-img", liveId: "geo-pre-live", jsonUrl: "https://services.swpc.noaa.gov/products/animations/geospace/pressure.json" }
    ];
    
    geoWidgets.forEach(function(w){
      var imgEl = document.getElementById(w.id);
      var liveEl = document.getElementById(w.liveId);
      if (!imgEl) return;
      
      var frames = [];
      var frameIndex = 0;
      var animInterval = null;
      var frameDelay = 150; // 150ms = ~6.6 fps, smooth animation
      
      function fetchFrames(){
        if (liveEl) liveEl.textContent = " LOADING";
        
        fetch(w.jsonUrl + "?cb=" + Date.now())
          .then(function(r){ 
            if (!r.ok) throw new Error("Fetch failed");
            return r.json(); 
          })
          .then(function(data){
            if (!Array.isArray(data) || data.length === 0) throw new Error("No frames");
            frames = data.map(function(f){ return "https://services.swpc.noaa.gov" + f.url; });
            preloadFrames();
          })
          .catch(function(err){
            console.error("Geospace animation error:", err);
            if (liveEl) liveEl.textContent = " OFFLINE";
            imgEl.style.opacity = "0.3";
          });
      }
      
      function preloadFrames(){
        var loaded = 0;
        var total = Math.min(frames.length, 50); // Preload first 50 frames max
        
        for (var i = 0; i < total; i++){
          var img = new Image();
          img.onload = img.onerror = function(){
            loaded++;
            if (loaded >= total) startAnimation();
          };
          img.src = frames[i];
        }
      }
      
      function startAnimation(){
        if (liveEl) liveEl.textContent = " LIVE";
        imgEl.style.opacity = "1";
        frameIndex = 0;
        
        if (animInterval) clearInterval(animInterval);
        animInterval = setInterval(function(){
          imgEl.src = frames[frameIndex];
          frameIndex = (frameIndex + 1) % frames.length;
        }, frameDelay);
      }
      
      // Initial load
      fetchFrames();
      
      // Refresh frame list every 5 min (will pick up new model runs)
      setInterval(fetchFrames, 5 * 60 * 1000);
    });
  }

  /* =========================================================
     SUVI (static with refresh - not animated)
     ========================================================= */
  var suviTimer = null;

  /* =========================================================
     GFS UPPER AIR / POLAR VORTEX WIDGET
     ========================================================= */
  var gfsState = {
    activeTab: '500mb',
    fhrIndex: 0,
    playing: false,
    playTimer: null,
    cycle: '00',
    fhrs500: (function(){
      var arr = [];
      for(var i=0; i<=384; i+=6) arr.push(i.toString().padStart(3,'0'));
      return arr;
    })(),
    fhrs10: ['f00','f24','f48','f72','f96','f120','f144','f168','f192','f216','f240','f264','f288','f312','f336','f360','f384']
  };

  function getGfsCycle(){
    var now = new Date();
    var utcH = now.getUTCHours();
    var cycles = [0, 6, 12, 18];
    var bestCycle = '00';
    for(var i = cycles.length - 1; i >= 0; i--){
      if(utcH >= cycles[i] + 5 || (utcH < cycles[0] + 5 && i === cycles.length - 1)){
        bestCycle = cycles[i].toString().padStart(2,'0');
        break;
      }
    }
    if(utcH < 5) bestCycle = '18';
    return bestCycle;
  }

  function buildGfsUrl(tab, fhrIndex){
    if(tab === '500mb'){
      var fhr = gfsState.fhrs500[fhrIndex] || '000';
      return 'https://mag.ncep.noaa.gov/data/gfs/' + gfsState.cycle + '/namer/500_vort_ht/gfs_namer_' + fhr + '_500_vort_ht.gif';
    } else {
      var code = gfsState.fhrs10[fhrIndex] || 'f00';
      return 'https://www.cpc.ncep.noaa.gov/products/stratosphere/strat_a_f/gif_files/gfs_t10_nh_' + code + '.png';
    }
  }

  function getFhrLabel(tab, fhrIndex){
    if(tab === '500mb'){
      var h = parseInt(gfsState.fhrs500[fhrIndex], 10);
      if(h === 0) return 'F000  Analysis';
      var d = Math.floor(h / 24);
      var rem = h % 24;
      if(d === 0) return 'F' + gfsState.fhrs500[fhrIndex] + '  +' + h + 'h';
      return 'F' + gfsState.fhrs500[fhrIndex] + '  Day ' + d + (rem ? '+' + rem + 'h' : '');
    } else {
      var code = gfsState.fhrs10[fhrIndex];
      var hrs = parseInt(code.replace('f',''), 10);
      if(hrs === 0) return 'Analysis';
      var days = hrs / 24;
      return '+' + hrs + 'h  Day ' + days;
    }
  }

  function loadGfsFrame(){
    var tab = gfsState.activeTab;
    var imgId = tab === '500mb' ? 'gfs-500mb-img' : 'gfs-10mb-img';
    var img = document.getElementById(imgId);
    var liveEl = document.getElementById('gfs-live');
    if(!img) return;
    var url = buildGfsUrl(tab, gfsState.fhrIndex);
    img.onload = function(){ if(liveEl) liveEl.textContent = ' LIVE'; };
    img.onerror = function(){ if(liveEl) liveEl.textContent = ' OFFLINE'; };
    img.src = url;
    if(tab === '500mb'){
      img.style.filter = "invert(1) hue-rotate(180deg) contrast(1.3) saturate(1.2)";
    } else {
      img.style.filter = "invert(1) hue-rotate(180deg) contrast(1.3) saturate(1.2)";
    }
    var label = document.getElementById('gfs-fhr-label');
    if(label) label.textContent = getFhrLabel(tab, gfsState.fhrIndex);
    // Preload next frame for smoother animation
    var maxIdx = tab === '500mb' ? gfsState.fhrs500.length - 1 : gfsState.fhrs10.length - 1;
    var nextIdx = gfsState.fhrIndex + 1;
    if(nextIdx > maxIdx) nextIdx = 0;
    var preload = new Image();
    preload.src = buildGfsUrl(tab, nextIdx);
  }

  function switchGfsTab(tab){
    gfsState.activeTab = tab;
    gfsState.fhrIndex = 0;
    gfsStopPlay();
    var img500 = document.getElementById('gfs-500mb-img');
    var img10 = document.getElementById('gfs-10mb-img');
    if(img500) img500.style.display = tab === '500mb' ? '' : 'none';
    if(img10) img10.style.display = tab === '10mb' ? '' : 'none';
    var btn500 = document.getElementById('gfs-tab-500mb');
    var btn10 = document.getElementById('gfs-tab-10mb');
    if(btn500){
      btn500.style.background = tab === '500mb' ? 'rgba(255,255,255,.15)' : 'rgba(255,255,255,.06)';
      btn500.style.color = tab === '500mb' ? '#fff' : 'rgba(255,255,255,.5)';
      btn500.style.borderColor = tab === '500mb' ? 'rgba(255,255,255,.25)' : 'rgba(255,255,255,.15)';
    }
    if(btn10){
      btn10.style.background = tab === '10mb' ? 'rgba(255,255,255,.15)' : 'rgba(255,255,255,.06)';
      btn10.style.color = tab === '10mb' ? '#fff' : 'rgba(255,255,255,.5)';
      btn10.style.borderColor = tab === '10mb' ? 'rgba(255,255,255,.25)' : 'rgba(255,255,255,.15)';
    }
    loadGfsFrame();
  }

  function gfsStepFhr(dir){
    var maxIdx = gfsState.activeTab === '500mb' ? gfsState.fhrs500.length - 1 : gfsState.fhrs10.length - 1;
    gfsState.fhrIndex = Math.max(0, Math.min(maxIdx, gfsState.fhrIndex + dir));
    loadGfsFrame();
  }

  function gfsStopPlay(){
    gfsState.playing = false;
    if(gfsState.playTimer){ clearInterval(gfsState.playTimer); gfsState.playTimer = null; }
    var btn = document.getElementById('gfs-play-btn');
    if(btn) btn.textContent = '';
  }

  function gfsTogglePlay(){
    if(gfsState.playing){ gfsStopPlay(); return; }
    gfsState.playing = true;
    var btn = document.getElementById('gfs-play-btn');
    if(btn) btn.textContent = '';
    var speed = gfsState.activeTab === '500mb' ? 900 : 1200;
    gfsState.playTimer = setInterval(function(){
      var maxIdx = gfsState.activeTab === '500mb' ? gfsState.fhrs500.length - 1 : gfsState.fhrs10.length - 1;
      gfsState.fhrIndex++;
      if(gfsState.fhrIndex > maxIdx) gfsState.fhrIndex = 0;
      loadGfsFrame();
    }, speed);
  }

  function initGfsWidget(){
    gfsState.cycle = getGfsCycle();
    var cycleLabel = document.getElementById('gfs-cycle-label');
    if(cycleLabel) cycleLabel.textContent = 'Cycle: ' + gfsState.cycle + 'Z';
    loadGfsFrame();
    // Auto-start animation
    setTimeout(function(){ gfsTogglePlay(); }, 1500);
    setInterval(function(){
      var newCycle = getGfsCycle();
      if(newCycle !== gfsState.cycle){
        gfsState.cycle = newCycle;
        if(cycleLabel) cycleLabel.textContent = 'Cycle: ' + gfsState.cycle + 'Z';
        loadGfsFrame();
      }
    }, 30 * 60 * 1000);
  }

  // Expose GFS controls to global scope for inline onclick handlers
  window.switchGfsTab = switchGfsTab;
  window.gfsStepFhr = gfsStepFhr;
  window.gfsTogglePlay = gfsTogglePlay;


  /* =========================================================
     LOCATION SWITCHER
     ========================================================= */
  function initLocationSwitcher(){
    var locIndex = 0;
    var dotsEl = document.getElementById("loc-dots");
    var prevBtn = document.getElementById("loc-prev");
    var nextBtn = document.getElementById("loc-next");
    
    if (!dotsEl || !prevBtn || !nextBtn) return;
    
    // Find current location index
    for (var i = 0; i < LOCATIONS.length; i++){
      if (LOCATIONS[i].id === LOCATION.id){ locIndex = i; break; }
    }
    
    // Build dots
    function renderDots(){
      dotsEl.innerHTML = "";
      for (var i = 0; i < LOCATIONS.length; i++){
        var dot = document.createElement("div");
        dot.className = "loc-dot" + (i === locIndex ? " active" : "");
        dotsEl.appendChild(dot);
      }
    }
    renderDots();
    
    function cycleTo(newIndex){
      if (window.locationSwitching) return;
      locIndex = (newIndex + LOCATIONS.length) % LOCATIONS.length;
      var newLoc = LOCATIONS[locIndex];
      
      renderDots();
      switchLocation(newLoc.id);
    }
    
    prevBtn.addEventListener("click", function(){ cycleTo(locIndex - 1); });
    nextBtn.addEventListener("click", function(){ cycleTo(locIndex + 1); });

    // Search location button
    var searchToggle = document.getElementById("loc-search-toggle");
    var searchBox = document.getElementById("loc-search-box");
    var searchInput = document.getElementById("loc-search-input");
    var searchClose = document.getElementById("loc-search-close");

    function openSearchBox(){
      if(searchBox) searchBox.classList.add("open");
      if(searchToggle) searchToggle.classList.add("active");
      var dots = document.getElementById("loc-dots");
      var prev = document.getElementById("loc-prev");
      var next = document.getElementById("loc-next");
      if(dots) dots.style.opacity = "0";
      if(prev) prev.style.opacity = "0";
      if(next) next.style.opacity = "0";
      if(searchToggle) searchToggle.style.opacity = "0";
      setTimeout(function(){ if(searchInput) searchInput.focus(); }, 220);
    }
    function closeSearchBox(){
      if(searchBox) searchBox.classList.remove("open");
      if(searchToggle) searchToggle.classList.remove("active");
      if(searchInput){ searchInput.value = ""; searchInput.blur(); }
      var dots = document.getElementById("loc-dots");
      var prev = document.getElementById("loc-prev");
      var next = document.getElementById("loc-next");
      if(dots) dots.style.opacity = "1";
      if(prev) prev.style.opacity = "1";
      if(next) next.style.opacity = "1";
      if(searchToggle) searchToggle.style.opacity = "";
    }

    if(searchToggle){
      searchToggle.addEventListener("click", function(){
        if(searchBox && searchBox.classList.contains("open")) closeSearchBox();
        else openSearchBox();
      });
    }
    if(searchClose){
      searchClose.addEventListener("click", function(){ closeSearchBox(); });
    }
    // Close on click outside
    document.addEventListener("click", function(e){
      if(searchBox && searchBox.classList.contains("open")){
        if(!searchBox.contains(e.target) && e.target !== searchToggle){
          closeSearchBox();
        }
      }
    });
    if (gpsBtn){
      gpsBtn.addEventListener("click", function(){
        if (!navigator.geolocation){
          alert("Geolocation is not supported by your browser.");
          return;
        }
        gpsBtn.classList.add("loading");
        navigator.geolocation.getCurrentPosition(function(pos){
          gpsBtn.classList.remove("loading");
          gpsBtn.classList.add("active");
          var lat = Math.round(pos.coords.latitude * 10000) / 10000;
          var lon = Math.round(pos.coords.longitude * 10000) / 10000;

          // Auto-detect nearest NWS radar
          var RADARS = [
            {id:"KENX",name:"NWS Albany",lat:42.59,lon:-73.99,region:"NORTHEAST"},
            {id:"KOKX",name:"NWS Upton",lat:40.87,lon:-72.86,region:"NORTHEAST"},
            {id:"KBOX",name:"NWS Taunton",lat:41.96,lon:-71.14,region:"NORTHEAST"},
            {id:"KDIX",name:"NWS Mt Holly",lat:39.95,lon:-74.41,region:"NORTHEAST"},
            {id:"KLWX",name:"NWS Sterling",lat:38.98,lon:-77.49,region:"NORTHEAST"},
            {id:"KBUF",name:"NWS Buffalo",lat:42.95,lon:-78.74,region:"NORTHEAST"},
            {id:"KCLX",name:"NWS Charleston",lat:32.66,lon:-81.04,region:"SOUTHEAST"},
            {id:"KFFC",name:"NWS Peachtree",lat:33.36,lon:-84.57,region:"SOUTHEAST"},
            {id:"KTBW",name:"NWS Tampa",lat:27.71,lon:-82.40,region:"SOUTHEAST"},
            {id:"KAMX",name:"NWS Miami",lat:25.61,lon:-80.41,region:"SOUTHEAST"},
            {id:"KJAX",name:"NWS Jacksonville",lat:30.48,lon:-81.70,region:"SOUTHEAST"},
            {id:"KBMX",name:"NWS Birmingham",lat:33.17,lon:-86.77,region:"SOUTHEAST"},
            {id:"KLOT",name:"NWS Chicago",lat:41.60,lon:-88.08,region:"UPPERMISSVLY"},
            {id:"KMKX",name:"NWS Milwaukee",lat:42.97,lon:-88.55,region:"UPPERMISSVLY"},
            {id:"KDTX",name:"NWS Detroit",lat:42.70,lon:-83.47,region:"UPPERMISSVLY"},
            {id:"KMPX",name:"NWS Minneapolis",lat:44.85,lon:-93.57,region:"UPPERMISSVLY"},
            {id:"KILX",name:"NWS Lincoln",lat:40.15,lon:-89.34,region:"UPPERMISSVLY"},
            {id:"KIND",name:"NWS Indianapolis",lat:39.71,lon:-86.28,region:"UPPERMISSVLY"},
            {id:"KLSX",name:"NWS St Louis",lat:38.70,lon:-90.68,region:"CENTGRTLAKES"},
            {id:"KEAX",name:"NWS Kansas City",lat:38.81,lon:-94.26,region:"CENTGRTLAKES"},
            {id:"KFWS",name:"NWS Dallas",lat:32.57,lon:-97.30,region:"SOUTHPLAINS"},
            {id:"KEWX",name:"NWS Austin",lat:29.70,lon:-98.03,region:"SOUTHPLAINS"},
            {id:"KHGX",name:"NWS Houston",lat:29.47,lon:-95.08,region:"SOUTHPLAINS"},
            {id:"KOUN",name:"NWS Norman",lat:35.24,lon:-97.46,region:"SOUTHPLAINS"},
            {id:"KUEX",name:"NWS Hastings",lat:40.32,lon:-98.44,region:"NORTHPLAINS"},
            {id:"KABR",name:"NWS Aberdeen",lat:45.46,lon:-98.41,region:"NORTHPLAINS"},
            {id:"KVTX",name:"NWS Los Angeles",lat:34.41,lon:-119.18,region:"PACSOUTHWEST"},
            {id:"KMUX",name:"NWS San Francisco",lat:37.16,lon:-121.90,region:"PACNORTHWEST"},
            {id:"KATX",name:"NWS Seattle",lat:48.19,lon:-122.50,region:"PACNORTHWEST"},
            {id:"KRTX",name:"NWS Portland",lat:45.72,lon:-122.97,region:"PACNORTHWEST"},
            {id:"KCBX",name:"NWS Boise",lat:43.49,lon:-116.24,region:"PACNORTHWEST"},
            {id:"KPUX",name:"NWS Pueblo",lat:38.46,lon:-104.18,region:"CENTGRTLAKES"},
            {id:"KSLC",name:"NWS Salt Lake",lat:40.97,lon:-111.93,region:"CENTGRTLAKES"},
            {id:"KFGZ",name:"NWS Flagstaff",lat:35.23,lon:-111.20,region:"PACSOUTHWEST"},
            {id:"KIWA",name:"NWS Phoenix",lat:33.29,lon:-111.67,region:"PACSOUTHWEST"},
            {id:"KLRX",name:"NWS Elko",lat:40.74,lon:-116.80,region:"PACNORTHWEST"},
            {id:"KREV",name:"NWS Reno",lat:39.51,lon:-119.46,region:"PACNORTHWEST"}
          ];

          var nearestRadar = RADARS[0];
          var minDist = 999999;
          for (var r = 0; r < RADARS.length; r++){
            var dlat = lat - RADARS[r].lat;
            var dlon = lon - RADARS[r].lon;
            var d = dlat*dlat + dlon*dlon;
            if (d < minDist){ minDist = d; nearestRadar = RADARS[r]; }
          }

          // Auto-detect GOES sector
          var goesSat = lon < -105 ? "G18" : "G19";
          var goesSector;
          if (lon < -105) goesSector = "wus";
          else if (lat > 38) goesSector = "ne";
          else goesSector = "se";

          // Auto-detect timezone
          var guessTz = "America/New_York";
          if (lon < -115) guessTz = "America/Los_Angeles";
          else if (lon < -105) guessTz = "America/Denver";
          else if (lon < -90) guessTz = "America/Chicago";

          // Reverse geocode for location name
          var locName = "My Location";
          fetch("https://api.open-meteo.com/v1/forecast?latitude=" + lat + "&longitude=" + lon + "&current=temperature_2m&timezone=auto")
            .then(function(r){ return r.json(); })
            .then(function(data){
              if (data && data.timezone) guessTz = data.timezone;

              // Build the GPS location object
              var gpsLoc = {
                id: "gps",
                name: locName,
                lat: lat,
                lon: lon,
                tz: guessTz,
                radar: nearestRadar.id,
                radarName: nearestRadar.name,
                radarRegion: nearestRadar.region,
                goes: { sat: goesSat, sector: goesSector }
              };

              // Add or replace GPS entry in LOCATIONS
              var gpsIdx = -1;
              for (var g = 0; g < LOCATIONS.length; g++){
                if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
              }
              if (gpsIdx >= 0){
                LOCATIONS[gpsIdx] = gpsLoc;
              } else {
                LOCATIONS.push(gpsLoc);
                gpsIdx = LOCATIONS.length - 1;
              }

              locIndex = gpsIdx;
              renderDots();
              switchLocation("gps");
            })
            .catch(function(){
              // Fallback without timezone detection
              var gpsLoc = {
                id: "gps",
                name: locName,
                lat: lat,
                lon: lon,
                tz: guessTz,
                radar: nearestRadar.id,
                radarName: nearestRadar.name,
                radarRegion: nearestRadar.region,
                goes: { sat: goesSat, sector: goesSector }
              };
              var gpsIdx = -1;
              for (var g = 0; g < LOCATIONS.length; g++){
                if (LOCATIONS[g].id === "gps"){ gpsIdx = g; break; }
              }
              if (gpsIdx >= 0){
                LOCATIONS[gpsIdx] = gpsLoc;
              } else {
                LOCATIONS.push(gpsLoc);
                gpsIdx = LOCATIONS.length - 1;
              }
              locIndex = gpsIdx;
              renderDots();
              switchLocation("gps");
            });
        }, function(err){
          gpsBtn.classList.remove("loading");
          if (err.code === 1) alert("Location access denied. Please enable location permissions.");
          else alert("Could not get your location. Please try again.");
        }, { enableHighAccuracy: true, timeout: 10000 });
      });
    }
    
    // Search location input
    var searchInput = document.getElementById("loc-search-input");
    if (searchInput){
      searchInput.addEventListener("keydown", function(e){
        if (e.key !== "Enter") return;
        var q = searchInput.value.trim();
        if (!q) return;
        searchInput.disabled = true;
        searchInput.placeholder = "Searching...";
        var url = "https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(q) + "&count=1&language=en&format=json";
        fetch(url).then(function(r){ return r.json(); }).then(function(data){
          searchInput.disabled = false;
          searchInput.placeholder = "City or zip...";
          if (!data.results || !data.results.length){
            alert("Location not found. Try a different search.");
            return;
          }
          var r = data.results[0];
          var lat = Math.round(r.latitude * 10000) / 10000;
          var lon = Math.round(r.longitude * 10000) / 10000;
          var name = r.name || "Custom";
          var RADARS = [
            {id:"KENX",name:"NWS Albany",lat:42.59,lon:-73.99,region:"NORTHEAST"},
            {id:"KOKX",name:"NWS Upton",lat:40.87,lon:-72.86,region:"NORTHEAST"},
            {id:"KBOX",name:"NWS Taunton",lat:41.96,lon:-71.14,region:"NORTHEAST"},
            {id:"KDIX",name:"NWS Mt Holly",lat:39.95,lon:-74.41,region:"NORTHEAST"},
            {id:"KLWX",name:"NWS Sterling",lat:38.98,lon:-77.49,region:"NORTHEAST"},
            {id:"KBUF",name:"NWS Buffalo",lat:42.95,lon:-78.74,region:"NORTHEAST"},
            {id:"KCLX",name:"NWS Charleston",lat:32.66,lon:-81.04,region:"SOUTHEAST"},
            {id:"KFFC",name:"NWS Peachtree",lat:33.36,lon:-84.57,region:"SOUTHEAST"},
            {id:"KTBW",name:"NWS Tampa",lat:27.71,lon:-82.40,region:"SOUTHEAST"},
            {id:"KAMX",name:"NWS Miami",lat:25.61,lon:-80.41,region:"SOUTHEAST"},
            {id:"KJAX",name:"NWS Jacksonville",lat:30.48,lon:-81.70,region:"SOUTHEAST"},
            {id:"KBMX",name:"NWS Birmingham",lat:33.17,lon:-86.77,region:"SOUTHEAST"},
            {id:"KLOT",name:"NWS Chicago",lat:41.60,lon:-88.08,region:"UPPERMISSVLY"},
            {id:"KMKX",name:"NWS Milwaukee",lat:42.97,lon:-88.55,region:"UPPERMISSVLY"},
            {id:"KDTX",name:"NWS Detroit",lat:42.70,lon:-83.47,region:"UPPERMISSVLY"},
            {id:"KMPX",name:"NWS Minneapolis",lat:44.85,lon:-93.57,region:"UPPERMISSVLY"},
            {id:"KILX",name:"NWS Lincoln",lat:40.15,lon:-89.34,region:"UPPERMISSVLY"},
            {id:"KIND",name:"NWS Indianapolis",lat:39.71,lon:-86.28,region:"UPPERMISSVLY"},
            {id:"KLSX",name:"NWS St Louis",lat:38.70,lon:-90.68,region:"CENTGRTLAKES"},
            {id:"KEAX",name:"NWS Kansas City",lat:38.81,lon:-94.26,region:"CENTGRTLAKES"},
            {id:"KFWS",name:"NWS Dallas",lat:32.57,lon:-97.30,region:"SOUTHPLAINS"},
            {id:"KEWX",name:"NWS Austin",lat:29.70,lon:-98.03,region:"SOUTHPLAINS"},
            {id:"KHGX",name:"NWS Houston",lat:29.47,lon:-95.08,region:"SOUTHPLAINS"},
            {id:"KOUN",name:"NWS Norman",lat:35.24,lon:-97.46,region:"SOUTHPLAINS"},
            {id:"KUEX",name:"NWS Hastings",lat:40.32,lon:-98.44,region:"NORTHPLAINS"},
            {id:"KABR",name:"NWS Aberdeen",lat:45.46,lon:-98.41,region:"NORTHPLAINS"},
            {id:"KVTX",name:"NWS Los Angeles",lat:34.41,lon:-119.18,region:"PACSOUTHWEST"},
            {id:"KMUX",name:"NWS San Francisco",lat:37.16,lon:-121.90,region:"PACNORTHWEST"},
            {id:"KATX",name:"NWS Seattle",lat:48.19,lon:-122.50,region:"PACNORTHWEST"},
            {id:"KRTX",name:"NWS Portland",lat:45.72,lon:-122.97,region:"PACNORTHWEST"},
            {id:"KCBX",name:"NWS Boise",lat:43.49,lon:-116.24,region:"PACNORTHWEST"},
            {id:"KPUX",name:"NWS Pueblo",lat:38.46,lon:-104.18,region:"CENTGRTLAKES"},
            {id:"KSLC",name:"NWS Salt Lake",lat:40.97,lon:-111.93,region:"CENTGRTLAKES"},
            {id:"KFGZ",name:"NWS Flagstaff",lat:35.23,lon:-111.20,region:"PACSOUTHWEST"},
            {id:"KIWA",name:"NWS Phoenix",lat:33.29,lon:-111.67,region:"PACSOUTHWEST"},
            {id:"KLRX",name:"NWS Elko",lat:40.74,lon:-116.80,region:"PACNORTHWEST"},
            {id:"KREV",name:"NWS Reno",lat:39.51,lon:-119.46,region:"PACNORTHWEST"}
          ];
          var nearestRadar = RADARS[0];
          var minDist = 999999;
          for (var ri = 0; ri < RADARS.length; ri++){
            var dlat = lat - RADARS[ri].lat;
            var dlon = lon - RADARS[ri].lon;
            var d = dlat*dlat + dlon*dlon;
            if (d < minDist){ minDist = d; nearestRadar = RADARS[ri]; }
          }
          var goesSat = lon < -105 ? "G18" : "G19";
          var goesSector = lon < -105 ? "wus" : (lat > 38 ? "ne" : "se");
          var guessTz = "America/New_York";
          if (lon < -115) guessTz = "America/Los_Angeles";
          else if (lon < -105) guessTz = "America/Denver";
          else if (lon < -90) guessTz = "America/Chicago";
          if (r.timezone) guessTz = r.timezone;

          var searchLoc = {
            id: "search",
            name: name,
            lat: lat,
            lon: lon,
            tz: guessTz,
            radar: nearestRadar.id,
            radarName: nearestRadar.name,
            radarRegion: nearestRadar.region,
            goes: { sat: goesSat, sector: goesSector }
          };
          var sIdx = -1;
          for (var g = 0; g < LOCATIONS.length; g++){
            if (LOCATIONS[g].id === "search"){ sIdx = g; break; }
          }
          if (sIdx >= 0) LOCATIONS[sIdx] = searchLoc;
          else { LOCATIONS.push(searchLoc); sIdx = LOCATIONS.length - 1; }

          locIndex = sIdx;
          renderDots();
          switchLocation("search");
          searchInput.value = "";
          closeSearchBox();
        }).catch(function(){
          searchInput.disabled = false;
          searchInput.placeholder = "City or zip...";
          alert("Search failed. Please try again.");
        });
      });
    }

    // GPS "Use My Location" button
    var gpsBtn = document.getElementById("loc-gps");
    if (gpsBtn){
      gpsBtn.addEventListener("click", function(){
        if (!navigator.geolocation){
          alert("Geolocation is not supported by your browser.");
          return;
        }
        gpsBtn.classList.add("loading");
        navigator.geolocation.getCurrentPosition(function(pos){
          gpsBtn.classList.remove("loading");
          gpsBtn.classList.add("active");
          var lat = Math.round(pos.coords.latitude * 10000) / 10000;
          var lon = Math.round(pos.coords.longitude * 10000) / 10000;
          resolveAndSwitch(lat, lon, "My Location");
        }, function(err){
          gpsBtn.classList.remove("loading");
          if (err.code === 1) alert("Location access denied. Please enable location permissions.");
          else alert("Could not get your location. Please try again.");
        }, { enableHighAccuracy: true, timeout: 10000 });
      });
    }

    // Search location input
    var searchInput = document.getElementById("loc-search-input");
    if (searchInput){
      searchInput.addEventListener("keydown", function(e){
        if (e.key !== "Enter") return;
        var q = searchInput.value.trim();
        if (!q) return;
        searchInput.disabled = true;
        searchInput.placeholder = "Searching...";
        fetch("https://geocoding-api.open-meteo.com/v1/search?name=" + encodeURIComponent(q) + "&count=1&language=en&format=json")
          .then(function(r){ return r.json(); })
          .then(function(data){
            searchInput.disabled = false;
            searchInput.placeholder = "City or zip...";
            if (!data.results || !data.results.length){
              alert("Location not found. Try a different search.");
              return;
            }
            var r = data.results[0];
            var tz = r.timezone || null;
            resolveAndSwitch(Math.round(r.latitude*10000)/10000, Math.round(r.longitude*10000)/10000, r.name || "Custom", tz);
            searchInput.value = "";
          }).catch(function(){
            searchInput.disabled = false;
            searchInput.placeholder = "City or zip...";
            alert("Search failed. Please try again.");
          });
      });
    }

    // Shared: resolve radar/GOES/tz and switch
    function resolveAndSwitch(lat, lon, name, tzOverride){
      var RADARS = [
        {id:"KENX",name:"NWS Albany",lat:42.59,lon:-73.99,region:"NORTHEAST"},
        {id:"KOKX",name:"NWS Upton",lat:40.87,lon:-72.86,region:"NORTHEAST"},
        {id:"KBOX",name:"NWS Taunton",lat:41.96,lon:-71.14,region:"NORTHEAST"},
        {id:"KDIX",name:"NWS Mt Holly",lat:39.95,lon:-74.41,region:"NORTHEAST"},
        {id:"KLWX",name:"NWS Sterling",lat:38.98,lon:-77.49,region:"NORTHEAST"},
        {id:"KBUF",name:"NWS Buffalo",lat:42.95,lon:-78.74,region:"NORTHEAST"},
        {id:"KCLX",name:"NWS Charleston",lat:32.66,lon:-81.04,region:"SOUTHEAST"},
        {id:"KFFC",name:"NWS Peachtree",lat:33.36,lon:-84.57,region:"SOUTHEAST"},
        {id:"KTBW",name:"NWS Tampa",lat:27.71,lon:-82.40,region:"SOUTHEAST"},
        {id:"KAMX",name:"NWS Miami",lat:25.61,lon:-80.41,region:"SOUTHEAST"},
        {id:"KJAX",name:"NWS Jacksonville",lat:30.48,lon:-81.70,region:"SOUTHEAST"},
        {id:"KBMX",name:"NWS Birmingham",lat:33.17,lon:-86.77,region:"SOUTHEAST"},
        {id:"KLOT",name:"NWS Chicago",lat:41.60,lon:-88.08,region:"UPPERMISSVLY"},
        {id:"KMKX",name:"NWS Milwaukee",lat:42.97,lon:-88.55,region:"UPPERMISSVLY"},
        {id:"KDTX",name:"NWS Detroit",lat:42.70,lon:-83.47,region:"UPPERMISSVLY"},
        {id:"KMPX",name:"NWS Minneapolis",lat:44.85,lon:-93.57,region:"UPPERMISSVLY"},
        {id:"KILX",name:"NWS Lincoln",lat:40.15,lon:-89.34,region:"UPPERMISSVLY"},
        {id:"KIND",name:"NWS Indianapolis",lat:39.71,lon:-86.28,region:"UPPERMISSVLY"},
        {id:"KLSX",name:"NWS St Louis",lat:38.70,lon:-90.68,region:"CENTGRTLAKES"},
        {id:"KEAX",name:"NWS Kansas City",lat:38.81,lon:-94.26,region:"CENTGRTLAKES"},
        {id:"KFWS",name:"NWS Dallas",lat:32.57,lon:-97.30,region:"SOUTHPLAINS"},
        {id:"KEWX",name:"NWS Austin",lat:29.70,lon:-98.03,region:"SOUTHPLAINS"},
        {id:"KHGX",name:"NWS Houston",lat:29.47,lon:-95.08,region:"SOUTHPLAINS"},
        {id:"KOUN",name:"NWS Norman",lat:35.24,lon:-97.46,region:"SOUTHPLAINS"},
        {id:"KUEX",name:"NWS Hastings",lat:40.32,lon:-98.44,region:"NORTHPLAINS"},
        {id:"KABR",name:"NWS Aberdeen",lat:45.46,lon:-98.41,region:"NORTHPLAINS"},
        {id:"KVTX",name:"NWS Los Angeles",lat:34.41,lon:-119.18,region:"PACSOUTHWEST"},
        {id:"KMUX",name:"NWS San Francisco",lat:37.16,lon:-121.90,region:"PACNORTHWEST"},
        {id:"KATX",name:"NWS Seattle",lat:48.19,lon:-122.50,region:"PACNORTHWEST"},
        {id:"KRTX",name:"NWS Portland",lat:45.72,lon:-122.97,region:"PACNORTHWEST"},
        {id:"KCBX",name:"NWS Boise",lat:43.49,lon:-116.24,region:"PACNORTHWEST"},
        {id:"KPUX",name:"NWS Pueblo",lat:38.46,lon:-104.18,region:"CENTGRTLAKES"},
        {id:"KSLC",name:"NWS Salt Lake",lat:40.97,lon:-111.93,region:"CENTGRTLAKES"},
        {id:"KFGZ",name:"NWS Flagstaff",lat:35.23,lon:-111.20,region:"PACSOUTHWEST"},
        {id:"KIWA",name:"NWS Phoenix",lat:33.29,lon:-111.67,region:"PACSOUTHWEST"},
        {id:"KLRX",name:"NWS Elko",lat:40.74,lon:-116.80,region:"PACNORTHWEST"},
        {id:"KREV",name:"NWS Reno",lat:39.51,lon:-119.46,region:"PACNORTHWEST"}
      ];
      var nearestRadar = RADARS[0];
      var minDist = 999999;
      for (var ri = 0; ri < RADARS.length; ri++){
        var dlat = lat - RADARS[ri].lat;
        var dlon = lon - RADARS[ri].lon;
        var d = dlat*dlat + dlon*dlon;
        if (d < minDist){ minDist = d; nearestRadar = RADARS[ri]; }
      }
      var goesSat = lon < -105 ? "G18" : "G19";
      var goesSector = lon < -105 ? "wus" : (lat > 38 ? "ne" : "se");
      var guessTz = tzOverride || "America/New_York";
      if (!tzOverride){
        if (lon < -115) guessTz = "America/Los_Angeles";
        else if (lon < -105) guessTz = "America/Denver";
        else if (lon < -90) guessTz = "America/Chicago";
      }
      var newLoc = {
        id: "custom",
        name: name,
        lat: lat,
        lon: lon,
        tz: guessTz,
        radar: nearestRadar.id,
        radarName: nearestRadar.name,
        radarRegion: nearestRadar.region,
        goes: { sat: goesSat, sector: goesSector }
      };
      var cIdx = -1;
      for (var g = 0; g < LOCATIONS.length; g++){
        if (LOCATIONS[g].id === "custom"){ cIdx = g; break; }
      }
      if (cIdx >= 0) LOCATIONS[cIdx] = newLoc;
      else { LOCATIONS.push(newLoc); cIdx = LOCATIONS.length - 1; }
      locIndex = cIdx;
      renderDots();
      switchLocation("custom");
    }

    // Swipe support
    var startX = null;
    var cyclerEl = document.getElementById("loc-cycler");
    if (cyclerEl){
      cyclerEl.addEventListener("touchstart", function(e){ startX = e.touches[0].clientX; }, {passive:true});
      cyclerEl.addEventListener("touchend", function(e){
        if (startX === null) return;
        var diff = e.changedTouches[0].clientX - startX;
        if (Math.abs(diff) > 40){
          cycleTo(locIndex + (diff < 0 ? 1 : -1));
        }
        startX = null;
      }, {passive:true});
    }
    
    function switchLocation(id){
      var newLoc = null;
      for (var i = 0; i < LOCATIONS.length; i++){
        if (LOCATIONS[i].id === id){
          newLoc = LOCATIONS[i];
          break;
        }
      }
      if (!newLoc) return;
      
      // Clear existing timers
      if (radarRefreshTimer) { clearInterval(radarRefreshTimer); radarRefreshTimer = null; }
      if (goesTimer) { clearInterval(goesTimer); goesTimer = null; }
      if (goesRefreshTimer) { clearInterval(goesRefreshTimer); goesRefreshTimer = null; }
      
      // Prevent rapid switching
      if (window.locationSwitching) return;
      window.locationSwitching = true;
      setTimeout(function(){ window.locationSwitching = false; }, 1000);
      
      LOCATION = newLoc;
      TZ = newLoc.tz;
      
      // Update location name display with loading state
      if (locNameEl) locNameEl.textContent = newLoc.name;
      if (locMetaEl) locMetaEl.textContent = "Loading...";
      if (tempEl) tempEl.style.opacity = "0.5";
      
      // Reload all data
      loadWeatherForLocation(LOCATION);
      loadAirQuality();
      loadWeatherAlerts();
      startRadarNwsLoop();
      startGoesAutoplay();
      updateSolarMini();
      
      // Re-center existing maps instead of destroying/recreating
      if (fireMap) {
        var fc = [45, -100], fz = 3;
        if (LOCATION.lon > -85 && LOCATION.lat > 38) { fc = [44, -74]; fz = 5; }
        else if (LOCATION.lon > -90 && LOCATION.lat <= 38 && LOCATION.lat > 25) { fc = [32, -82]; fz = 5; }
        else if (LOCATION.lon > -100 && LOCATION.lon <= -85 && LOCATION.lat > 36) { fc = [42, -90]; fz = 5; }
        else if (LOCATION.lon <= -110 && LOCATION.lat <= 42 && LOCATION.lat > 30) { fc = [36, -118]; fz = 5; }
        else if (LOCATION.lon <= -115 && LOCATION.lat > 42) { fc = [46, -122]; fz = 5; }
        else if (LOCATION.lon > -105 && LOCATION.lon <= -90 && LOCATION.lat <= 36) { fc = [31, -98]; fz = 5; }
        else if (LOCATION.lon <= -100 && LOCATION.lon > -115 && LOCATION.lat > 36) { fc = [42, -110]; fz = 5; }
        fireMap.setView(fc, fz);
      }
      if (quakeMap) quakeMap.setView([LOCATION.lat, LOCATION.lon], 6);
      if (lightningMap) lightningMap.setView([LOCATION.lat, LOCATION.lon], 7);
      
      // Reload lightning iframe
      var lIframe = document.getElementById("lightning-iframe");
      if (lIframe) lIframe.src = "https://map.blitzortung.org/#7/" + LOCATION.lat + "/" + LOCATION.lon + "/2";
      
      // Update location markers on maps
      if (fireMap) {
        fireMap.eachLayer(function(layer){ if (layer.options && layer.options.fillColor === '#2B22F4') fireMap.removeLayer(layer); });
        L.circleMarker([LOCATION.lat, LOCATION.lon], { radius: 8, fillColor: '#2B22F4', fillOpacity: 0.9, color: '#fff', weight: 2 }).addTo(fireMap).bindTooltip(" " + LOCATION.name, { permanent: false });
      }
      if (quakeMap) {
        quakeMap.eachLayer(function(layer){ if (layer.options && layer.options.fillColor === '#2B22F4') quakeMap.removeLayer(layer); });
        L.circleMarker([LOCATION.lat, LOCATION.lon], { radius: 8, fillColor: '#2B22F4', fillOpacity: 0.9, color: '#fff', weight: 2 }).addTo(quakeMap).bindTooltip(" " + LOCATION.name, { permanent: false });
      }
    }
  }

  /* =========================================================
     SUVI THEMATIC MAP (Animated)
     ========================================================= */
  var suviMapAnim = {
    frames: [],
    idx: 0,
    playing: true,
    timer: null,
    refreshTimer: null
  };
  
  function initPfss(){
    var img = document.getElementById("pfss-img");
    var live = document.getElementById("pfss-live");
    if (!img) return;
    
// Try AIA 171 first, fallback to SOHO, then PFSS
    var aiaUrl = "https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_0171.jpg";
    var sohoUrl = "https://soho.nascom.nasa.gov/data/realtime/eit_171/512/latest.jpg";
    var pfssUrl = "https://sdo.gsfc.nasa.gov/assets/img/latest/latest_512_PFSS_0171.jpg";
    var fallbackLevel = 1; // Start with AIA since PFSS is unreliable
    
    function loadImage(){
      var url = aiaUrl;
      if (fallbackLevel === 1) url = sohoUrl;
      if (fallbackLevel === 2) url = pfssUrl;
      
      img.src = url + "?cb=" + Date.now();
      if(live) live.textContent = " LIVE";
    }
    
    img.onerror = function(){
      fallbackLevel++;
      if (fallbackLevel <= 2) {
        loadImage();
      } else {
        if(live) live.textContent = " OFFLINE";
        img.style.opacity = "0.3";
      }
    };
    
    img.onload = function(){
      img.style.opacity = "1";
    };
    
    loadImage();
    setInterval(function(){
      fallbackLevel = 0; // Reset to try PFSS again each refresh
      loadImage();
    }, 300000);
  }

  function initSuviMap(){
    var suviMapImg = document.getElementById("suvi-map-img");
    var suviMapLive = document.getElementById("suvi-map-live");
    var suviMapBtn = document.getElementById("suvi-map-btn");
    
    if (!suviMapImg) return;
    
    var JSON_URL = "https://services.swpc.noaa.gov/products/animations/suvi-primary-map.json";
    var FALLBACK_URL = "https://services.swpc.noaa.gov/images/animations/suvi/primary/map/latest.png";
    
    function loadFrames(){
      if (suviMapLive) suviMapLive.textContent = " LOADING";
      
      fetchWithTimeout(JSON_URL, null, 15000)
        .then(function(r){ return r.json(); })
        .then(function(data){
          if (data && data.length > 0){
            suviMapAnim.frames = data.map(function(f){
              return "https://services.swpc.noaa.gov" + f.url;
            });
            suviMapAnim.idx = 0;
            if (suviMapLive) suviMapLive.textContent = " LIVE";
            if (suviMapBtn) suviMapBtn.style.display = "block";
            startSuviAnimation();
          } else {
            throw new Error("No frames");
          }
        })
        .catch(function(){
          // Fallback to static image
          suviMapImg.src = FALLBACK_URL + "?cb=" + Date.now();
          suviMapImg.onload = function(){ if (suviMapLive) suviMapLive.textContent = " LIVE"; };
          suviMapImg.onerror = function(){ if (suviMapLive) suviMapLive.textContent = " OFFLINE"; };
          if (suviMapBtn) suviMapBtn.style.display = "none";
        });
    }
    
    function startSuviAnimation(){
      if (suviMapAnim.timer) clearTimeout(suviMapAnim.timer);
      
      function step(){
        if (suviMapAnim.playing && suviMapAnim.frames.length > 0){
          suviMapImg.src = suviMapAnim.frames[suviMapAnim.idx];
          suviMapAnim.idx = (suviMapAnim.idx + 1) % suviMapAnim.frames.length;
        }
        suviMapAnim.timer = setTimeout(step, 150);
      }
      step();
    }
    
    
    loadFrames();
    
    if (suviMapAnim.refreshTimer) clearInterval(suviMapAnim.refreshTimer);
    suviMapAnim.refreshTimer = setInterval(loadFrames, 5 * 60 * 1000);
  }

  /* =========================================================
   MAIN WEATHER MICRO TABS (RESET TO SUMMARY ON REFRESH)
   ========================================================= */
function initNowMicroTabs(){
  var tabButtons = document.querySelectorAll(".now-tab[data-nowtab]");
  var panels = document.querySelectorAll(".now-tabpanel[data-nowtab-panel]");
  if (!tabButtons.length || !panels.length) return;

  function setActive(name){
    for (var i=0; i<tabButtons.length; i++){
      var b = tabButtons[i];
      var isOn = (b.getAttribute("data-nowtab") === name);
      if (isOn) b.classList.add("is-active");
      else b.classList.remove("is-active");
    }

    for (var p=0; p<panels.length; p++){
      var panel = panels[p];
      var isPanel = (panel.getAttribute("data-nowtab-panel") === name);
      panel.hidden = !isPanel;
    }
  }

  for (var j=0; j<tabButtons.length; j++){
    tabButtons[j].addEventListener("click", function(e){
      var name = this.getAttribute("data-nowtab");
      setActive(name);
    });
  }

  // Critical behavior: ALWAYS reset to Summary on refresh / load
  setActive("summary");
}



  /* =========================================================
     HAZARD MAPS (Lightning, Wildfires, Earthquakes) - Leaflet
     ========================================================= */
  var lightningMap = null;
  var fireMap = null;
  var quakeMap = null;
  var lightningMarkers = [];
  var fireMarkers = [];
  var quakeMarkers = [];

  // Light map tiles
  var DARK_TILES = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
  var TILE_ATTRIB = '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>';

  // ============ NATIONAL RADAR MAP (CONUS) ============
  var nationalRadarMap = null;
  var nationalRadarLayer = null;
  var nationalRadarFrames = [];
  var nationalRadarIndex = 0;
  var nationalRadarTimer = null;
  var nationalRadarHost = '';

  function initNationalRadarMap(){
    var container = document.getElementById("national-radar-map");
    var liveEl = document.getElementById("national-radar-live");
    
    if (!container || typeof L === "undefined") return;

    if (nationalRadarMap) nationalRadarMap.remove();
    nationalRadarMap = L.map(container, {
      center: [39.0, -98.0],
      zoom: 3,
      zoomControl: false,
      attributionControl: false,
      minZoom: 2,
      maxZoom: 10
    });

    // Pure black background
    nationalRadarMap.getContainer().style.background = '#000';
    
    // Dark base layer (no features, just black tiles)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(nationalRadarMap);

    // Add CSS for smooth radar transitions
    var style = document.createElement('style');
    style.textContent = '#national-radar-map .leaflet-layer { transition: opacity 0.25s ease-in-out; }';
    document.head.appendChild(style);

    // Add radar legend with precip types
    var radarLegend = L.control({ position: 'bottomright' });
    radarLegend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'radar-legend');
      div.style.cssText = 'background:rgba(255,255,255,.92); padding:6px 10px; border-radius:6px; font-size:7px; font-weight:600; font-family:system-ui,sans-serif; color:#333; box-shadow:0 1px 4px rgba(0,0,0,.12);';
      div.innerHTML = 
        '<div style="display:flex;align-items:center;gap:10px;">' +
          '<div style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;background:linear-gradient(135deg,#02fd02,#fdf802,#fd0000);border-radius:1px;"></span><span>Rain</span></div>' +
          '<div style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;background:linear-gradient(135deg,#04e9e7,#019ff4,#ff80ff);border-radius:1px;"></span><span>Snow</span></div>' +
          '<div style="display:flex;align-items:center;gap:3px;"><span style="width:8px;height:8px;background:#f800fd;border-radius:1px;"></span><span>Mix</span></div>' +
          '<div style="display:flex;gap:1px;align-items:center;margin-left:6px;">' +
            '<span style="width:10px;height:5px;background:#04e9e7;"></span>' +
            '<span style="width:10px;height:5px;background:#02fd02;"></span>' +
            '<span style="width:10px;height:5px;background:#fdf802;"></span>' +
            '<span style="width:10px;height:5px;background:#fd9500;"></span>' +
            '<span style="width:10px;height:5px;background:#fd0000;"></span>' +
            '<span style="width:10px;height:5px;background:#f800fd;"></span>' +
          '</div>' +
        '</div>';
      return div;
    };
    radarLegend.addTo(nationalRadarMap);

    // Setup scrubber interaction
    var slider = document.getElementById("national-radar-slider");
    if (slider){
      slider.addEventListener("input", function(){
        nationalRadarIndex = parseInt(this.value);
        showNationalRadarFrame(nationalRadarIndex);
      });
      slider.addEventListener("mousedown", function(){ stopNationalRadarLoop(); });
      slider.addEventListener("touchstart", function(){ stopNationalRadarLoop(); });
      slider.addEventListener("mouseup", function(){ startNationalRadarLoop(); });
      slider.addEventListener("touchend", function(){ startNationalRadarLoop(); });
    }

    loadNationalRadarFrames();
    setInterval(loadNationalRadarFrames, 5 * 60 * 1000);

    if (liveEl) liveEl.textContent = " LIVE";
  }

  function loadNationalRadarFrames(){
    if (!nationalRadarMap) return;

    fetch('https://api.rainviewer.com/public/weather-maps.json')
      .then(function(response){ return response.json(); })
      .then(function(apiData){
        if (!apiData.radar || !apiData.radar.past || apiData.radar.past.length === 0) return;
        
        nationalRadarHost = apiData.host;
        
        // Combine past + nowcast for max coverage (~2.5 hours)
        var allFrames = apiData.radar.past.slice();
        if (apiData.radar.nowcast && apiData.radar.nowcast.length > 0){
          allFrames = allFrames.concat(apiData.radar.nowcast);
        }
        nationalRadarFrames = allFrames;
        
        var slider = document.getElementById("national-radar-slider");
        if (slider){
          slider.max = nationalRadarFrames.length - 1;
          slider.value = apiData.radar.past.length - 1;
        }
        
        // Remove old layers
        nationalRadarLayers.forEach(function(layer){
          if (layer && nationalRadarMap.hasLayer(layer)) nationalRadarMap.removeLayer(layer);
        });
        nationalRadarLayers = [];
        
        // Pre-load all frame layers (hidden initially)
        nationalRadarFrames.forEach(function(frame, i){
          var radarUrl = nationalRadarHost + frame.path + '/256/{z}/{x}/{y}/4/1_1.png';
          var layer = L.tileLayer(radarUrl, {
            opacity: 0,
            maxZoom: 10
          }).addTo(nationalRadarMap);
          nationalRadarLayers.push(layer);
        });
        
        nationalRadarIndex = apiData.radar.past.length - 1;
        showNationalRadarFrame(nationalRadarIndex);
        startNationalRadarLoop();
      })
      .catch(function(err){
        console.log('RainViewer API error:', err);
      });
  }

  var nationalRadarLayers = []; // Pre-loaded layers for smooth animation

  function showNationalRadarFrame(index){
    if (!nationalRadarMap || nationalRadarFrames.length === 0) return;
    if (index < 0 || index >= nationalRadarFrames.length) return;
    
    // Crossfade: show current frame, hide others
    nationalRadarLayers.forEach(function(layer, i){
      if (layer) layer.setOpacity(i === index ? 0.85 : 0);
    });
    
    var frame = nationalRadarFrames[index];
    
    // Update timestamp (local time)
    var tsEl = document.getElementById("national-radar-timestamp");
    if (tsEl && frame.time){
      var d = new Date(frame.time * 1000);
      var h = d.getHours();
      var m = d.getMinutes();
      var ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12; if (h === 0) h = 12;
      var timeStr = h + ':' + (m < 10 ? '0' + m : m) + ' ' + ampm;
      tsEl.textContent = timeStr;
    }
    
    // Update slider
    var slider = document.getElementById("national-radar-slider");
    if (slider) slider.value = index;
  }

  function startNationalRadarLoop(){
    stopNationalRadarLoop();
    var loopDelay = 350; // ms between frames
    var endPause = 2000; // ms pause at most recent frame
    
    nationalRadarTimer = setInterval(function(){
      nationalRadarIndex = (nationalRadarIndex + 1) % nationalRadarFrames.length;
      showNationalRadarFrame(nationalRadarIndex);
      
      // Pause longer at the end (most recent frame)
      if (nationalRadarIndex === nationalRadarFrames.length - 1){
        stopNationalRadarLoop();
        setTimeout(startNationalRadarLoop, endPause);
      }
    }, loopDelay);
  }

  function stopNationalRadarLoop(){
    if (nationalRadarTimer){
      clearInterval(nationalRadarTimer);
      nationalRadarTimer = null;
    }
  }


  function initHazardMaps(){
    initLightningMap();
    initNationalRadarMap();
    initFireMap();
    initQuakeMap();
    initGeologyMaps();
  }

  function destroyHazardMaps(){
    if (lightningMap){ lightningMap.remove(); lightningMap = null; }
    if (fireMap){ fireMap.remove(); fireMap = null; }
    if (quakeMap){ quakeMap.remove(); quakeMap = null; }
    if (bedrockMap){ bedrockMap.remove(); bedrockMap = null; }
    if (lithologyMap){ lithologyMap.remove(); lithologyMap = null; }
    if (stratMap){ stratMap.remove(); stratMap = null; }
    lightningMarkers = [];
    fireMarkers = [];
    quakeMarkers = [];
    blitzortungStrikes = [];
    if (blitzortungWs){ try { blitzortungWs.close(); } catch(e){} blitzortungWs = null; }
    if (blitzortungReconnectTimer){ clearTimeout(blitzortungReconnectTimer); blitzortungReconnectTimer = null; }
  }
// ============ LIGHTNING MAP ============
  function initLightningMap(){
    var iframe = document.getElementById("lightning-iframe");
    if (iframe) {
      iframe.src = "https://map.blitzortung.org/#7/" + LOCATION.lat + "/" + LOCATION.lon + "/2";
    }
  }

  // Global toggle function called by buttons
  

  // ============ FIRE MAP ============
  var smokeLayer = null;
  var smokeVisible = true;
  var fireLabelsLayer = null;
  var fireLabelsVisible = false;
  var aqiStations = [];
  var aqiPillVisible = false;
  
  function initFireMap(){
    var container = document.getElementById("fire-map");
    var liveEl = document.getElementById("fire-live");
    var statusPill = document.getElementById("fire-status-pill");
    
    if (!container || typeof L === "undefined") return;

    if (fireMap) fireMap.remove();
    
    // Determine regional view based on user location
    var mapCenter = [45, -100];
    var mapZoom = 3;
    
    if (LOCATION && LOCATION.lat && LOCATION.lon) {
      // Northeast (NY, New England, Eastern Canada)
      if (LOCATION.lon > -85 && LOCATION.lat > 38) {
        mapCenter = [44, -74];
        mapZoom = 5;
      }
      // Southeast (FL, GA, Carolinas)
      else if (LOCATION.lon > -90 && LOCATION.lat <= 38 && LOCATION.lat > 25) {
        mapCenter = [32, -82];
        mapZoom = 5;
      }
      // Midwest (IL, OH, MI, WI)
      else if (LOCATION.lon > -100 && LOCATION.lon <= -85 && LOCATION.lat > 36) {
        mapCenter = [42, -90];
        mapZoom = 5;
      }
      // Southwest (CA, AZ, NV, NM)
      else if (LOCATION.lon <= -110 && LOCATION.lat <= 42 && LOCATION.lat > 30) {
        mapCenter = [36, -118];
        mapZoom = 5;
      }
      // Pacific Northwest (WA, OR, BC)
      else if (LOCATION.lon <= -115 && LOCATION.lat > 42) {
        mapCenter = [46, -122];
        mapZoom = 5;
      }
      // Texas / South Central
      else if (LOCATION.lon > -105 && LOCATION.lon <= -90 && LOCATION.lat <= 36) {
        mapCenter = [31, -98];
        mapZoom = 5;
      }
      // Mountain West (CO, UT, WY, MT)
      else if (LOCATION.lon <= -100 && LOCATION.lon > -115 && LOCATION.lat > 36) {
        mapCenter = [42, -110];
        mapZoom = 5;
      }
    }
    
    fireMap = L.map(container, {
      center: mapCenter,
      zoom: mapZoom,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 12
    });

    // ESRI World Imagery (satellite) for land cover context - shows forests, fields, urban areas
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
      attribution: '&copy; Esri, Maxar, Earthstar Geographics'
    }).addTo(fireMap);

    // NWS Smoke Forecast Layer (48-hour surface smoke concentration)
    loadSmokeLayer();
    loadHRRRSmokeOverlay();

    // Add acre legend
    var fireLegend = L.control({ position: 'bottomright' });
    fireLegend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'fire-legend');
      div.style.cssText = 'background:rgba(255,255,255,.06); padding:4px 6px; border-radius:6px; font-size:9px; font-weight:600; font-family:system-ui,sans-serif; box-shadow:0 1px 4px rgba(0,0,0,.12);';
      div.innerHTML = 
        '<div style="display:flex; flex-direction:column; gap:2px;">' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">&lt;1K</span><span style="width:6px;height:6px;border-radius:50%;background:#fbbf24;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">1K</span><span style="width:7px;height:7px;border-radius:50%;background:#f97316;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">10K</span><span style="width:8px;height:8px;border-radius:50%;background:#dc2626;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">50K+</span><span style="width:9px;height:9px;border-radius:50%;background:#7f1d1d;"></span></div>' +
        '</div>';
      return div;
    };
    fireLegend.addTo(fireMap);

    // Load fire data
    loadFireData();
    
    // Refresh daily (every 24 hours)
    setInterval(loadFireData, 24 * 60 * 60 * 1000);

    if (liveEl) liveEl.textContent = " LIVE";
  }

  function loadFireData(){
    var statusPill = document.getElementById("fire-status-pill");
    
    // NASA FIRMS requires API key - using NIFC as primary source
    // To use FIRMS: get key from https://firms.modaps.eosdis.nasa.gov/api/area/
    // var firmsUrl = "https://firms.modaps.eosdis.nasa.gov/api/area/csv/YOUR_API_KEY/VIIRS_SNPP_NRT/" + bbox + "/1";
    
    // NIFC current wildland fire incidents - ALL US (InciWeb data)
    var nifcUrl = "https://services9.arcgis.com/RHVPKKiFTONKtxq3/arcgis/rest/services/USA_Wildfires_v1/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=geojson";

    // Clear old markers
    fireMarkers.forEach(function(m){ fireMap.removeLayer(m); });
    fireMarkers = [];

    fetchWithTimeout(nifcUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        var fires = data && data.features;
        
        if (!fires || fires.length === 0){
          if (statusPill) {
            statusPill.textContent = " 0 ACTIVE FIRES (7D)";
            statusPill.style.color = "#22c55e";
          }
          return;
        }

        var nearbyCount = 0;
        var totalCount = fires.length;
        var largeCount = 0;

        fires.forEach(function(fire){
          var coords = fire.geometry && fire.geometry.coordinates;
          var props = fire.properties || {};
          if (!coords) return;

          var lat = coords[1];
          var lon = coords[0];
          var name = props.IncidentName || props.FireName || "Unknown Fire";
          var acres = props.DailyAcres || props.GISAcres || 0;
          var contained = props.PercentContained || 0;

          // Calculate distance
          var dLat = lat - LOCATION.lat;
          var dLon = lon - LOCATION.lon;
          var dist = Math.sqrt(dLat*dLat + dLon*dLon) * 69;

          if (dist < 200) nearbyCount++;
          if (acres > 1000) largeCount++;

          // Size/color by acres (smaller to reduce crowding, proportional to thresholds)
          var radius;
          var color;
          if (acres >= 50000) {
            radius = 7;
            color = "#7f1d1d";
          } else if (acres >= 10000) {
            radius = 5.5;
            color = "#dc2626";
          } else if (acres >= 1000) {
            radius = 4;
            color = "#f97316";
          } else {
            radius = 2.5;
            color = "#fbbf24";
          }

          var marker = L.circleMarker([lat, lon], {
            radius: radius,
            fillColor: color,
            fillOpacity: 0.85,
            color: '#fff',
            weight: 1
          }).addTo(fireMap);

          var acresStr = acres > 0 ? acres.toLocaleString() + " acres" : "Size unknown";
          var containStr = contained > 0 ? "  " + contained + "% contained" : "";
          marker.bindPopup(" " + name + "<br>" + acresStr + containStr, { closeButton: false, className: 'fire-popup' });

          fireMarkers.push(marker);
        });

        if (statusPill){
          statusPill.textContent = " " + totalCount + " ACTIVE FIRE" + (totalCount !== 1 ? "S" : "") + " (7D)";
          statusPill.style.color = largeCount > 0 ? "#dc2626" : (nearbyCount > 0 ? "#f97316" : "#22c55e");
        }
        
        // Now create smoke heatmap from fire locations
        createSmokeHeatmap();

        // Build dropdown list of top 5 largest fires
        var fireListEl = document.getElementById("fire-list");
        if (fireListEl && fires.length > 0){
          var sorted = fires.slice().sort(function(a,b){
            var aAcres = (a.properties.DailyAcres || a.properties.GISAcres || a.properties.CalculatedAcres || 0);
            var bAcres = (b.properties.DailyAcres || b.properties.GISAcres || b.properties.CalculatedAcres || 0);
            return bAcres - aAcres;
          }).slice(0, 5);
          
          var listHtml = "";
          for (var fi = 0; fi < sorted.length; fi++){
            var f = sorted[fi];
            var props = f.properties || {};
            var coords = f.geometry && f.geometry.coordinates;
            var fName = props.IncidentName || props.FireName || props.poly_IncidentName || "Unknown Fire";
            var fAcres = props.DailyAcres || props.GISAcres || props.CalculatedAcres || 0;
            var fContained = props.PercentContained || props.poly_PercentContained || 0;
            var lat = coords ? coords[1] : 0;
            var lon = coords ? coords[0] : 0;
            
            // Format acres
            var acresStr = "";
            if (fAcres >= 1000){
              acresStr = (fAcres / 1000).toFixed(1) + "K";
            } else {
              acresStr = Math.round(fAcres).toLocaleString();
            }
            
            var acreColor;
            if (fAcres >= 50000) acreColor = "#7f1d1d";
            else if (fAcres >= 10000) acreColor = "#dc2626";
            else if (fAcres >= 1000) acreColor = "#f97316";
            else acreColor = "#fbbf24";
            
            listHtml += '<div class="fire-item" onclick="window.flyToFire('+lat+','+lon+')" style="padding:5px 8px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:6px;">' +
              '<span style="color:'+acreColor+';font-weight:800;font-size:.72rem;min-width:36px;">'+acresStr+'</span>' +
              '<span style="color:#fff;font-size:.66rem;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+fName+'</span>' +
              (fContained > 0 ? '<span style="color:rgba(255,255,255,.5);font-size:.56rem;font-weight:600;">'+fContained+'%</span>' : '') +
            '</div>';
          }
          
          fireListEl.innerHTML = listHtml;
        }
        
        // Global function for fire click
        window.flyToFire = function(lat, lon){
          if (fireMap && !isNaN(lat) && !isNaN(lon)){
            fireMap.flyTo([lat, lon], 8, { duration: 1 });
          }
        };
      })
      .catch(function(err){
        console.log("Fire data error:", err);
        if (statusPill){
          statusPill.textContent = " DATA UNAVAILABLE";
          statusPill.style.color = "#888";
        }
      });
  }

  // ============ SMOKE FORECAST LAYER ============
  var smokeGeoJsonLayer = null;
  var goesOverlay = null;
  var aqiHeatLayer = null;
  var aqiBlobMarkers = [];
  
  function loadSmokeLayer(){
    if (!fireMap) return;
    
    // Remove existing layers
    if (smokeGeoJsonLayer && fireMap.hasLayer(smokeGeoJsonLayer)){
      fireMap.removeLayer(smokeGeoJsonLayer);
    }
    
    // Fetch real HMS smoke polygons from NOAA via ArcGIS Feature Service
    var hmsUrl = "https://services9.arcgis.com/RGao6tMQSJKyNRvN/arcgis/rest/services/NOAA_HMS_Smoke_Detection/FeatureServer/0/query?where=1%3D1&outFields=Density&returnGeometry=true&outSR=4326&resultType=tile&f=geojson";
    
    fetchWithTimeout(hmsUrl, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (!data || !data.features || data.features.length === 0){
          console.log("HMS Smoke: No smoke polygons found");
          updateSmokePill("clear");
          return;
        }
        
        var densityStyles = {
          "Light":  { color: "#fbbf24", fillColor: "#fbbf24", fillOpacity: 0.15, weight: 1, opacity: 0.4 },
          "Medium": { color: "#f97316", fillColor: "#f97316", fillOpacity: 0.25, weight: 1, opacity: 0.5 },
          "Heavy":  { color: "#dc2626", fillColor: "#dc2626", fillOpacity: 0.40, weight: 1.5, opacity: 0.6 }
        };
        
        smokeGeoJsonLayer = L.geoJSON(data, {
          style: function(feature){
            var density = feature.properties.Density || "Light";
            return densityStyles[density] || densityStyles["Light"];
          },
          onEachFeature: function(feature, layer){
            var d = feature.properties.Density || "Unknown";
            layer.bindPopup("<b>HMS Smoke</b><br>Density: " + d + "<br><span style='font-size:10px;color:#888;'>Source: NOAA Satellite Analysis Branch</span>");
          }
        }).addTo(fireMap);
        
        console.log("HMS Smoke: Loaded " + data.features.length + " real smoke polygons");
        updateSmokePill("hms");
      })
      .catch(function(err){
        console.log("HMS Smoke fetch error:", err);
      });
  }
  
  function createSmokeHeatmap(){
    // Deprecated  using real NOAA HRRR smoke forecast overlay
  }
  
  var hrrrSmokeLayer = null;
  var smokePill = null;
  
  function loadHRRRSmokeOverlay(){
    if (!fireMap) return;
    if (hrrrSmokeLayer && fireMap.hasLayer(hrrrSmokeLayer)){
      fireMap.removeLayer(hrrrSmokeLayer);
    }
    
    // Check if HRRR smoke service has current data before adding WMS
    var now = new Date();
    var checkUrl = "https://mapservices.weather.noaa.gov/raster/rest/services/air_quality/ndgd_smoke_vert_1hr_avg_time/ImageServer?f=json";
    
    fetchWithTimeout(checkUrl, null, 10000)
      .then(function(r){ return r.json(); })
      .then(function(info){
        var hasData = false;
        var timeInfo = info && info.timeInfo;
        if (timeInfo && timeInfo.timeExtent && timeInfo.timeExtent.length === 2){
          var endTime = new Date(timeInfo.timeExtent[1]);
          var ageMins = (now - endTime) / 60000;
          // Data is current if end time is recent or in the future (forecast)
          if (ageMins < 1440 || ageMins < 0) hasData = true;
          console.log("HRRR Smoke: data ends " + endTime.toISOString() + " (" + Math.round(ageMins/60) + "h ago)");
        }
        
        if (hasData){
          hrrrSmokeLayer = L.tileLayer.wms("https://mapservices.weather.noaa.gov/raster/services/air_quality/ndgd_smoke_vert_1hr_avg_time/ImageServer/WMSServer?", {
            layers: "0",
            format: "image/png",
            transparent: true,
            opacity: 0.5,
            attribution: "NOAA/NWS HRRR-Smoke"
          }).addTo(fireMap);
        }
        // Pill status based on whether actual smoke polygons exist
        if (!smokePill) updateSmokePill(smokeGeoJsonLayer ? "hms" : "clear");
      })
      .catch(function(err){
        console.log("HRRR Smoke check error:", err);
        updateSmokePill(smokeGeoJsonLayer ? "hms" : "clear");
      });
  }
  
  function updateSmokePill(status){
    if (!fireMap) return;
    
    if (!smokePill){
      smokePill = L.control({ position: 'bottomleft' });
      smokePill.onAdd = function(){
        var div = L.DomUtil.create('div', 'smoke-status-pill');
        div.style.cssText = 'background:rgba(0,0,0,.55);padding:3px 8px;border-radius:10px;font-size:10px;font-weight:600;font-family:system-ui,sans-serif;letter-spacing:.3px;margin-top:4px;';
        return div;
      };
      smokePill.addTo(fireMap);
    }
    
    var el = smokePill.getContainer();
    if (!el) return;
    
    if (status === "active"){
      el.innerHTML = ' <span style="color:#f97316;">SMOKE DETECTED</span>';
    } else if (status === "hms"){
      el.innerHTML = ' <span style="color:#fbbf24;">HMS SMOKE</span>';
    } else {
      el.innerHTML = ' <span style="color:#4ade80;">CLEAR</span>';
    }
  }
  
  // ============ CITY/STATE LABELS TOGGLE ============
  function toggleFireLabels(){
    var btn = document.getElementById("fire-labels-toggle");
    fireLabelsVisible = !fireLabelsVisible;
    
    if (fireLabelsVisible){
      if (!fireLabelsLayer){
        fireLabelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap, &copy; CARTO',
          subdomains: 'abcd',
          maxZoom: 12
        }).addTo(fireMap);
      } else {
        fireMap.addLayer(fireLabelsLayer);
      }
      if (btn) {
        btn.innerHTML = ' ON';
        btn.style.color = '#22c55e';
        btn.style.borderColor = '#22c55e';
      }
    } else {
      if (fireLabelsLayer && fireMap.hasLayer(fireLabelsLayer)){
        fireMap.removeLayer(fireLabelsLayer);
      }
      if (btn) {
        btn.innerHTML = ' OFF';
        btn.style.color = '#888';
        btn.style.borderColor = '#888';
      }
    }
  }
  
  window.toggleFireLabels = toggleFireLabels;
  
  // ============ AQI CURSOR TRACKING ============
  
  
  
  
  

  // ============ MACROSTRAT GEOLOGY MAPS ============
  var bedrockMap = null;
  var lithologyMap = null;
  var stratMap = null;
  
  // Macrostrat tile and API endpoints
  var MACROSTRAT_TILES = 'https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png';
  var MACROSTRAT_API = 'https://macrostrat.org/api/v2/geologic_units/map';
  
  // Cache for geology data to avoid repeated API calls
  var geologyCache = {};
  
  function initGeologyMaps(){
    initBedrockMap();
    initLithologyMap();
    initStratMap();
  }
  
  // ============ BEDROCK GEOLOGY MAP ============
  function initBedrockMap(){
    var container = document.getElementById("bedrock-map");
    var infoPill = document.getElementById("bedrock-info-pill");
    
    if (!container || typeof L === "undefined") return;

    if (bedrockMap) bedrockMap.remove();
    bedrockMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 8,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 14
    });

    // Base layer - light map
    L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(bedrockMap);
    
    // Macrostrat geology overlay
    L.tileLayer(MACROSTRAT_TILES, {
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
      opacity: 0.75
    }).addTo(bedrockMap);
    
    // Add location marker
    L.circleMarker([LOCATION.lat, LOCATION.lon], {
      radius: 8,
      fillColor: '#2B22F4',
      fillOpacity: 0.9,
      color: '#fff',
      weight: 2
    }).addTo(bedrockMap).bindTooltip(" " + LOCATION.name, { permanent: false });

    // Click handler for geology info
    bedrockMap.on('click', function(e){
      fetchGeologyAtPoint(e.latlng.lat, e.latlng.lng, 'bedrock', infoPill);
    });
    
    // Load initial geology for current location
    fetchGeologyAtPoint(LOCATION.lat, LOCATION.lon, 'bedrock', infoPill);
  }
  
  // ============ LITHOLOGY MAP ============
  function initLithologyMap(){
    var container = document.getElementById("lithology-map");
    var infoPill = document.getElementById("lithology-info-pill");
    
    if (!container || typeof L === "undefined") return;

    if (lithologyMap) lithologyMap.remove();
    lithologyMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 9,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 14
    });

    // Base layer
    L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(lithologyMap);
    
    // Macrostrat geology overlay with higher opacity for lithology focus
    L.tileLayer(MACROSTRAT_TILES, {
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
      opacity: 0.85
    }).addTo(lithologyMap);
    
    // Add location marker
    L.circleMarker([LOCATION.lat, LOCATION.lon], {
      radius: 8,
      fillColor: '#2B22F4',
      fillOpacity: 0.9,
      color: '#fff',
      weight: 2
    }).addTo(lithologyMap).bindTooltip(" " + LOCATION.name, { permanent: false });

    // Click handler
    lithologyMap.on('click', function(e){
      fetchGeologyAtPoint(e.latlng.lat, e.latlng.lng, 'lithology', infoPill);
    });
    
    // Load initial
    fetchGeologyAtPoint(LOCATION.lat, LOCATION.lon, 'lithology', infoPill);
  }
  
  // ============ STRATIGRAPHY MAP ============
  function initStratMap(){
    var container = document.getElementById("strat-map");
    var infoPill = document.getElementById("strat-info-pill");
    
    if (!container || typeof L === "undefined") return;

    if (stratMap) stratMap.remove();
    stratMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 7,
      zoomControl: false,
      attributionControl: false,
      minZoom: 3,
      maxZoom: 14
    });

    // Base layer
    L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(stratMap);
    
    // Macrostrat geology overlay
    L.tileLayer(MACROSTRAT_TILES, {
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
      opacity: 0.70
    }).addTo(stratMap);
    
    // Add location marker
    L.circleMarker([LOCATION.lat, LOCATION.lon], {
      radius: 8,
      fillColor: '#2B22F4',
      fillOpacity: 0.9,
      color: '#fff',
      weight: 2
    }).addTo(stratMap).bindTooltip(" " + LOCATION.name, { permanent: false });

    // Click handler
    stratMap.on('click', function(e){
      fetchGeologyAtPoint(e.latlng.lat, e.latlng.lng, 'strat', infoPill);
    });
    
    // Load initial
    fetchGeologyAtPoint(LOCATION.lat, LOCATION.lon, 'strat', infoPill);
  }
  
  // ============ FETCH GEOLOGY DATA FROM MACROSTRAT ============
  function fetchGeologyAtPoint(lat, lng, mapType, infoPill){
    var cacheKey = lat.toFixed(4) + ',' + lng.toFixed(4);
    
    // Check cache first
    if (geologyCache[cacheKey]){
      displayGeologyInfo(geologyCache[cacheKey], mapType, infoPill);
      return;
    }
    
    var url = MACROSTRAT_API + '?lat=' + lat + '&lng=' + lng;
    
    fetchWithTimeout(url, null, 10000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.success && data.success.data && data.success.data.length > 0){
          geologyCache[cacheKey] = data.success.data;
          displayGeologyInfo(data.success.data, mapType, infoPill);
        } else {
          hideGeologyInfo(mapType, infoPill);
        }
      })
      .catch(function(err){
        console.log("Macrostrat API error:", err);
        hideGeologyInfo(mapType, infoPill);
      });
  }
  
  function displayGeologyInfo(units, mapType, infoPill){
    if (!infoPill || !units || units.length === 0) return;
    
    var unit = units[0]; // Primary unit at surface
    
    if (mapType === 'bedrock'){
      var nameEl = document.getElementById("bedrock-unit-name");
      var ageEl = document.getElementById("bedrock-age");
      var lithEl = document.getElementById("bedrock-lith");
      
      if (nameEl) nameEl.textContent = unit.strat_name || unit.name || "Unknown Unit";
      if (ageEl){
        var ageStr = "";
        if (unit.b_int_name && unit.t_int_name){
          if (unit.b_int_name === unit.t_int_name){
            ageStr = unit.b_int_name;
          } else {
            ageStr = unit.t_int_name + "  " + unit.b_int_name;
          }
        } else if (unit.b_age && unit.t_age){
          ageStr = unit.t_age.toFixed(1) + "  " + unit.b_age.toFixed(1) + " Ma";
        }
        ageEl.textContent = ageStr ? " " + ageStr : "";
      }
      if (lithEl){
        var liths = unit.lith ? unit.lith.map(function(l){ return l.name || l; }).join(", ") : "";
        lithEl.textContent = liths ? " " + liths : "";
      }
    } else if (mapType === 'lithology'){
      var primaryEl = document.getElementById("lithology-primary");
      var descEl = document.getElementById("lithology-desc");
      
      var primaryLith = "";
      var lithDesc = "";
      
      if (unit.lith && unit.lith.length > 0){
        // Sort by proportion if available
        var sorted = unit.lith.slice().sort(function(a,b){
          return (b.prop || 0) - (a.prop || 0);
        });
        primaryLith = sorted[0].name || sorted[0];
        
        // Build description with proportions
        lithDesc = sorted.map(function(l){
          var pct = l.prop ? Math.round(l.prop * 100) + "%" : "";
          return (l.name || l) + (pct ? " (" + pct + ")" : "");
        }).join(", ");
      }
      
      if (primaryEl) primaryEl.textContent = primaryLith ? " " + primaryLith : "Unknown Lithology";
      if (descEl) descEl.textContent = lithDesc || (unit.descrip || "");
    } else if (mapType === 'strat'){
      var columnEl = document.getElementById("strat-column");
      var unitsEl = document.getElementById("strat-units");
      var thickEl = document.getElementById("strat-thickness");
      
      if (columnEl) columnEl.textContent = unit.col_name || unit.strat_name || "Stratigraphic Column";
      
      // Show all units at this location
      var unitNames = units.map(function(u){ return u.strat_name || u.name || "Unnamed"; });
      if (unitsEl) unitsEl.textContent = " " + unitNames.slice(0, 5).join("  ") + (units.length > 5 ? " +" + (units.length - 5) + " more" : "");
      
      // Total thickness
      var totalThick = 0;
      units.forEach(function(u){
        if (u.max_thick) totalThick += u.max_thick;
      });
      if (thickEl) thickEl.textContent = totalThick > 0 ? " ~" + Math.round(totalThick) + " m total thickness" : "";
    }
    
    infoPill.style.display = "block";
  }
  
  function hideGeologyInfo(mapType, infoPill){
    if (infoPill){
      infoPill.style.display = "none";
    }
  }

  // ============ EARTHQUAKE MAP ============
  function initQuakeMap(){
    var container = document.getElementById("quake-map");
    var liveEl = document.getElementById("quake-live");
    
    if (!container || typeof L === "undefined") return;

    // Create map - centered on location but allow global exploration
    if (quakeMap) quakeMap.remove();
    quakeMap = L.map(container, {
      center: [LOCATION.lat, LOCATION.lon],
      zoom: 6,
      zoomControl: false,
      attributionControl: false,
      minZoom: 1,
      maxZoom: 10,
      worldCopyJump: true
    });

    // Light base map for when geology is off (countries/states visible)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { 
      attribution: TILE_ATTRIB
    }).addTo(quakeMap);
    
    // Macrostrat geology overlay (can be toggled)
    quakeGeoLayer = L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png', { 
      attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>'
    }).addTo(quakeMap);
    
    // City/state labels on top
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { 
      attribution: TILE_ATTRIB,
      pane: 'shadowPane'
    }).addTo(quakeMap);

    // Click handler for geology popup - uses shared fetchGeologyForQuakeMap function
    quakeMap.on('click', function(e){
      fetchGeologyForQuakeMap(e.latlng.lat, e.latlng.lng, e.latlng);
    });

    // Add magnitude legend
    var legend = L.control({ position: 'bottomright' });
    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'quake-legend');
      div.style.cssText = 'background:rgba(255,255,255,.06); box-shadow:0 0 30px rgba(255,255,255,.10), inset 0 0 20px rgba(255,255,255,.18); padding:4px 6px; border-radius:6px; font-size:9px; font-weight:600; font-family:system-ui,sans-serif;';
      div.innerHTML = 
        '<div style="display:flex; flex-direction:column; gap:2px;">' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">&lt;1.5</span><span style="width:4px;height:4px;border-radius:50%;background:#7dd3fc;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">1.5</span><span style="width:5px;height:5px;border-radius:50%;background:#4ade80;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">2.5</span><span style="width:6px;height:6px;border-radius:50%;background:#84cc16;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">3.5</span><span style="width:7px;height:7px;border-radius:50%;background:#eab308;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">4.5</span><span style="width:8px;height:8px;border-radius:50%;background:#f97316;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">5.5</span><span style="width:9px;height:9px;border-radius:50%;background:#ef4444;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">6.5</span><span style="width:10px;height:10px;border-radius:50%;background:#dc2626;"></span></div>' +
          '<div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;"><span style="color:#888;">7+</span><span style="width:11px;height:11px;border-radius:50%;background:#7f1d1d;"></span></div>' +
        '</div>';
      return div;
    };
    legend.addTo(quakeMap);

    // USGS earthquakes - GLOBAL, past 24 hours, ALL magnitudes (M0.5+)
    var url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson";

    fetchWithTimeout(url, null, 15000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        var quakes = data && data.features;
        
        if (!quakes || quakes.length === 0){
          if (liveEl) liveEl.textContent = " LIVE";
          var statusPill = document.getElementById("quake-status-pill");
          if (statusPill){
            statusPill.textContent = " 0 QUAKES (24H)";
            statusPill.style.color = "#4ade80";
          }
          return;
        }

        var nearbyCount = 0;
        var significantCount = 0;
        var totalCount = 0;

        // Plot ALL global quakes M0.5+
        for (var i = 0; i < quakes.length; i++){
          var q = quakes[i];
          var coords = q.geometry && q.geometry.coordinates;
          var props = q.properties || {};
          
          if (!coords) continue;

          var mag = props.mag || 0;
          var lat = coords[1];
          var lon = coords[0];

          // Only show M0.5+
          if (mag < 0.5) continue;

          totalCount++;

          // Calculate distance
          var dLat = lat - LOCATION.lat;
          var dLon = lon - LOCATION.lon;
          var dist = Math.sqrt(dLat*dLat + dLon*dLon) * 69;

          if (dist < 500) nearbyCount++;
          if (mag >= 5.5) significantCount++;

          // Color by magnitude
          var color;
          if (mag >= 7) color = "#7f1d1d";
          else if (mag >= 6.5) color = "#dc2626";
          else if (mag >= 5.5) color = "#ef4444";
          else if (mag >= 4.5) color = "#f97316";
          else if (mag >= 3.5) color = "#eab308";
          else if (mag >= 2.5) color = "#84cc16";
          else if (mag >= 1.5) color = "#4ade80";
          else color = "#7dd3fc";

          // Size by magnitude - more consistent scaling
          var radius;
          if (mag >= 6) radius = 10;
          else if (mag >= 5) radius = 8;
          else if (mag >= 4) radius = 6;
          else if (mag >= 3) radius = 5;
          else if (mag >= 2) radius = 4;
          else radius = 3;

          var marker = L.circleMarker([lat, lon], {
            radius: radius,
            fillColor: color,
            fillOpacity: 0.85,
            color: '#fff',
            weight: 1
          }).addTo(quakeMap);

          var place = props.place || "Unknown";
          var time = props.time ? timeAgo(new Date(props.time)) : "";
          var distStr = dist < 10000 ? (Math.round(dist) + " mi away  ") : "";
          marker.bindTooltip("M" + mag.toFixed(1) + " - " + place + "<br>" + distStr + time, { 
            permanent: false 
          });

          quakeMarkers.push(marker);
        }

        // Update status pill
        var statusPill = document.getElementById("quake-status-pill");
        if (statusPill){
          statusPill.textContent = " " + totalCount.toLocaleString() + " QUAKES (24H)";
          statusPill.style.color = significantCount > 0 ? "#f97316" : "#4ade80";
        }

        // Build dropdown list of top 10 recent quakes sorted by magnitude
        var quakeListEl = document.getElementById("quake-list");
        if (quakeListEl && quakes.length > 0){
          var sorted = quakes.slice().sort(function(a,b){
            return (b.properties.mag || 0) - (a.properties.mag || 0);
          }).slice(0, 5);
          
          var listHtml = "";
          for (var qi = 0; qi < sorted.length; qi++){
            var q = sorted[qi];
            var props = q.properties || {};
            var coords = q.geometry && q.geometry.coordinates;
            var mag = props.mag || 0;
            var place = props.place || "Unknown";
            var lat = coords ? coords[1] : 0;
            var lon = coords ? coords[0] : 0;
            
            // Parse place to get city, state format
            var shortPlace = place;
            if (place.indexOf(" of ") > -1){
              shortPlace = place.split(" of ")[1] || place;
            }
            var parts = shortPlace.split(", ");
            if (parts.length >= 2){
              shortPlace = parts[0] + ", " + parts[1].substring(0,2).toUpperCase();
            }
            
            // Time ago condensed
            var timeStr = "";
            if (props.time){
              var mins = Math.floor((Date.now() - props.time) / 60000);
              if (mins < 60) timeStr = mins + "m";
              else if (mins < 1440) timeStr = Math.floor(mins/60) + "h";
              else timeStr = Math.floor(mins/1440) + "d";
            }
            
            var magColor;
            if (mag >= 6) magColor = "#dc2626";
            else if (mag >= 5) magColor = "#ef4444";
            else if (mag >= 4) magColor = "#f97316";
            else if (mag >= 3) magColor = "#eab308";
            else magColor = "#4ade80";
            
            listHtml += '<div class="quake-item" onclick="window.flyToQuake('+lat+','+lon+','+mag+')" style="padding:5px 8px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:6px;">' +
              '<span style="color:'+magColor+';font-weight:800;font-size:.75rem;min-width:26px;">'+mag.toFixed(1)+'</span>' +
              '<span style="color:#fff;font-size:.68rem;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+shortPlace+'</span>' +
              '<span style="color:rgba(255,255,255,.5);font-size:.58rem;font-weight:600;">'+timeStr+'</span>' +
            '</div>';
          }
          
          quakeListEl.innerHTML = listHtml;
        }
        
        // Global function for quake click
        window.flyToQuake = function(lat, lon, mag){
          if (quakeMap && !isNaN(lat) && !isNaN(lon)){
            var zoom = mag >= 6 ? 6 : (mag >= 4 ? 7 : 8);
            quakeMap.flyTo([lat, lon], zoom, { duration: 1 });
          }
        };

        if (liveEl) liveEl.textContent = " LIVE";
      })
      .catch(function(){
        if (liveEl) liveEl.textContent = " OFFLINE";
      });
  }

  // Fetch geology for earthquake map clicks - shows popup at click location
  function fetchGeologyForQuakeMap(lat, lng, latlng){
    var cacheKey = lat.toFixed(4) + ',' + lng.toFixed(4);
    
    // Check cache first
    if (geologyCache[cacheKey]){
      showQuakeGeologyPopup(geologyCache[cacheKey], latlng || L.latLng(lat, lng));
      return;
    }
    
    var url = MACROSTRAT_API + '?lat=' + lat + '&lng=' + lng;
    
    fetchWithTimeout(url, null, 10000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data && data.success && data.success.data && data.success.data.length > 0){
          geologyCache[cacheKey] = data.success.data;
          if (latlng) showQuakeGeologyPopup(data.success.data, latlng);
        }
      })
      .catch(function(err){});
  }
  
  var quakeGeoLayer = null;
  var quakeGeoVisible = true;
  
  window.toggleQuakeGeology = function(){
    var toggleEl = document.getElementById('quake-geo-toggle');
    if (!quakeMap) return;
    
    quakeGeoVisible = !quakeGeoVisible;
    
    if (quakeGeoVisible){
      // Add geology layer back
      quakeGeoLayer = L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png', { 
        attribution: '&copy; <a href="https://macrostrat.org">Macrostrat</a>',
        zIndex: 100
      }).addTo(quakeMap);
      
      // Force it below markers but above base map
      quakeGeoLayer.setZIndex(100);
      
      if (toggleEl) {
        toggleEl.style.color = '#22c55e';
        toggleEl.style.borderColor = '#22c55e';
        toggleEl.innerHTML = ' ON';
      }
    } else {
      // Remove geology layer
      if (quakeGeoLayer) {
        quakeMap.removeLayer(quakeGeoLayer);
        quakeGeoLayer = null;
      }
      if (toggleEl) {
        toggleEl.style.color = '#888';
        toggleEl.style.borderColor = '#ccc';
        toggleEl.innerHTML = ' OFF';
      }
    }
  };

  function showQuakeGeologyPopup(units, latlng){
    if (!quakeMap || !units || units.length === 0) return;
    
    var unit = units[0];
    var name = unit.strat_name || unit.name || "Unknown";
    
    // Build compact content
    var unitNames = units.slice(0, 3).map(function(u){ return u.strat_name || u.name || "Unnamed"; });
    var moreText = units.length > 3 ? " +" + (units.length - 3) : "";
    
    // Age info
    var ageStr = "";
    if (unit.b_int_name && unit.t_int_name){
      if (unit.b_int_name === unit.t_int_name){
        ageStr = unit.b_int_name;
      } else {
        ageStr = unit.t_int_name + " - " + unit.b_int_name;
      }
    }
    var numericAge = "";
    if (unit.t_age != null && unit.b_age != null){
      numericAge = Math.round(unit.t_age) + " - " + Math.round(unit.b_age) + " Ma";
    }
    
    var content = '<div style="font-size:11px; max-width:180px;">' +
      '<div style="color:#2563eb; font-weight:700; margin-bottom:2px;">' + name + '</div>' +
      (ageStr ? '<div style="color:#059669; font-size:10px; font-weight:600;">' + ageStr + '</div>' : '') +
      (numericAge ? '<div style="color:#888; font-size:9px;">' + numericAge + '</div>' : '') +
      '<div style="color:#555; font-size:10px; margin-top:2px;">' + unitNames.join(" > ") + moreText + '</div>' +
    '</div>';
    
    L.popup({ closeButton: false, offset: [0, -5], className: 'quake-geo-popup' })
      .setLatLng(latlng)
      .setContent(content)
      .openOn(quakeMap);
  }

  // Helper: time ago
  function timeAgo(date){
    var now = new Date();
    var diff = now - date;
    var mins = Math.floor(diff / 60000);
    var hours = Math.floor(diff / 3600000);
    var days = Math.floor(diff / 86400000);

    if (mins < 60) return mins + "m ago";
    if (hours < 24) return hours + "h ago";
    return days + "d ago";
  }

  initHazardMaps();

  /* =========================================================
     WEATHER ALERTS (NWS API)
     ========================================================= */
  var DEMO_ALERTS = false; // Set to true to see sample alerts
  
  var alertGeometries = [];
  
  function loadWeatherAlerts(){
    var alertsEl = document.getElementById("weather-alerts");
    if (!alertsEl) return;
    
    alertGeometries = []; // Reset
    
    // Demo mode to preview alert styles
    if (DEMO_ALERTS){
      var demoHtml = 
        '<div class="weather-alert warning">' +
          '<span class="weather-alert-icon"></span>' +
          '<span class="weather-alert-text">' +
            '<span class="weather-alert-title">Winter Storm Warning</span>' +
            '<span class="weather-alert-expires"> Expires in 8h</span>' +
          '</span>' +
        '</div>' +
        '<div class="weather-alert watch">' +
          '<span class="weather-alert-icon"></span>' +
          '<span class="weather-alert-text">' +
            '<span class="weather-alert-title">Flood Watch</span>' +
            '<span class="weather-alert-expires"> Expires in 24h</span>' +
          '</span>' +
        '</div>' +
        '<div class="weather-alert advisory">' +
          '<span class="weather-alert-icon"></span>' +
          '<span class="weather-alert-text">' +
            '<span class="weather-alert-title">Wind Advisory</span>' +
            '<span class="weather-alert-expires"> Expires in 6h</span>' +
          '</span>' +
        '</div>';
      alertsEl.innerHTML = demoHtml;
      return;
    }
    
    var url = "https://api.weather.gov/alerts/active?point=" + LOCATION.lat + "," + LOCATION.lon;
    
    fetchWithTimeout(url, null, 12000)
      .then(function(r){ return r.json(); })
      .then(function(data){
        var features = data && data.features;
        
        if (!features || features.length === 0){
          alertsEl.innerHTML = '';
          return;
        }
        
        var html = "";
        var shown = Math.min(3, features.length); // Limit to 3 alerts
        
        for (var i = 0; i < shown; i++){
          var alert = features[i].properties;
          var event = alert.event || "Alert";
          var headline = alert.headline || event;
          var severity = (alert.severity || "").toLowerCase();
          var urgency = alert.urgency || "";
          var expires = alert.expires ? new Date(alert.expires) : null;
          var effective = alert.effective ? new Date(alert.effective) : null;
          var onset = alert.onset ? new Date(alert.onset) : effective;
          
          // Sanity check: if onset is after expires, swap them or use effective
          if (onset && expires && onset > expires) {
            onset = effective || expires;
          }
        
          var description = alert.description || "";
          var instruction = alert.instruction || "";
          var areaDesc = alert.areaDesc || "";
          var senderName = alert.senderName || "";
          
          // Get first sentence of description for summary
          var summary = "";
          if (description){
            // Extract snow/rain amounts from description
            var precipAmount = "";
            
            // Look for snow amounts (e.g., "6 to 10 inches", "4-8 inches of snow")
            var snowMatch = description.match(/(\d+\.?\d*)\s*to\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?(?:snow|accumulation)/i) ||
                           description.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?(?:snow|accumulation)/i) ||
                           description.match(/(?:snow|accumulation)[^\d]*(\d+\.?\d*)\s*to\s*(\d+\.?\d*)\s*inch/i);
            
            if (snowMatch){
              precipAmount = " " + snowMatch[1] + "-" + snowMatch[2] + '"';
            } else {
              // Try single amount
              var singleSnow = description.match(/(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?snow/i) ||
                              description.match(/snow[^\d]*(\d+\.?\d*)\s*inch/i);
              if (singleSnow){
                precipAmount = " " + singleSnow[1] + '"';
              }
            }
            
            // Look for rain amounts if no snow found
            if (!precipAmount){
              var rainMatch = description.match(/(\d+\.?\d*)\s*to\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?rain/i) ||
                             description.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?rain/i);
              if (rainMatch){
                precipAmount = " " + rainMatch[1] + "-" + rainMatch[2] + '"';
              } else {
                var singleRain = description.match(/(\d+\.?\d*)\s*inch(?:es)?\s*(?:of\s+)?rain/i);
                if (singleRain){
                  precipAmount = " " + singleRain[1] + '"';
                }
              }
            }
            
            // Look for wind speeds
            var windAmount = "";
            var windMatch = description.match(/wind[^\d]*(\d+)\s*to\s*(\d+)\s*mph/i) ||
                           description.match(/(\d+)\s*to\s*(\d+)\s*mph\s*wind/i);
            if (windMatch){
              windAmount = " " + windMatch[1] + "-" + windMatch[2] + " mph";
            }
            
            // Clean up NWS formatting (remove * WHAT..., * WHERE..., etc)
            var cleanDesc = description
              .replace(/\*\s*WHAT\.\.\./gi, '')
              .replace(/\*\s*WHERE\.\.\./gi, '')
              .replace(/\*\s*WHEN\.\.\./gi, '')
              .replace(/\*\s*IMPACTS\.\.\./gi, '')
              .replace(/\*\s*ADDITIONAL DETAILS\.\.\./gi, '')
              .replace(/^\s*[\*\-]\s*/gm, '')
              .trim();
            
            var firstSentence = cleanDesc.split(/\.(?:\s|$)/)[0];
            if (firstSentence && firstSentence.length > 10){
              summary = firstSentence.length > 120 ? firstSentence.substring(0, 117) + "..." : firstSentence + ".";
            }
            
            // Add precip/wind amounts to summary
            var amounts = [precipAmount, windAmount].filter(function(a){ return a; }).join("  ");
            if (amounts){
              summary = amounts + (summary ? "    " + summary : "");
            }
          }
          
          // Format areas (truncate if too long)
          var areasStr = "";
          if (areaDesc){
            areasStr = areaDesc.length > 80 ? areaDesc.substring(0, 77) + "..." : areaDesc;
          }
          
          // Determine alert class
          var alertClass = "statement";
          var icon = "";
          
          if (event.toLowerCase().indexOf("warning") >= 0 || severity === "extreme" || severity === "severe"){
            alertClass = "warning";
            icon = "";
          } else if (event.toLowerCase().indexOf("watch") >= 0 || severity === "moderate"){
            alertClass = "watch";
            icon = "";
          } else if (event.toLowerCase().indexOf("advisory") >= 0){
            alertClass = "advisory";
            icon = "";
          }
          
          // Helper for 12-hour time with AM/PM
          function fmt12WithAMPM(d){
            if (!d || !isFinite(d.getTime())) return "--:--";
            var h = d.getHours();
            var m = d.getMinutes();
            var ampm = h >= 12 ? "PM" : "AM";
            var hh = h % 12; if (hh === 0) hh = 12;
            return String(hh) + ":" + (m < 10 ? "0"+m : m) + " " + ampm;
          }
          
          // Format time window
          var timeWindow = "";
          var now = new Date();
          
          if (onset && expires){
            var onsetTime = fmt12WithAMPM(onset);
            var expiresTime = fmt12WithAMPM(expires);
            var onsetDay = fmtMonthDay(onset);
            var expiresDay = fmtMonthDay(expires);
            var todayStr = fmtMonthDay(now);
            var tomorrowDate = new Date(now);
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            var tomorrowStr = fmtMonthDay(tomorrowDate);
            
            // Check if already in effect
            var hasStarted = onset <= now;
            
            if (hasStarted){
              // Already in effect - show when it ends
              if (expiresDay === todayStr){
                timeWindow = "In effect until " + expiresTime + " today";
              } else if (expiresDay === tomorrowStr){
                timeWindow = "In effect until " + expiresTime + " tomorrow";
              } else {
                timeWindow = "In effect until " + expiresDay + " at " + expiresTime;
              }
            } else {
              // Not started yet - show full window
              if (onsetDay === todayStr && expiresDay === todayStr){
                timeWindow = "Today " + onsetTime + " to " + expiresTime;
              } else if (onsetDay === todayStr && expiresDay === tomorrowStr){
                timeWindow = "Today " + onsetTime + " to tomorrow " + expiresTime;
              } else if (onsetDay === tomorrowStr && expiresDay === tomorrowStr){
                timeWindow = "Tomorrow " + onsetTime + " to " + expiresTime;
              } else if (onsetDay === tomorrowStr){
                timeWindow = "Tomorrow " + onsetTime + " to " + expiresDay + " " + expiresTime;
              } else {
                timeWindow = onsetDay + " at " + onsetTime + " to " + expiresDay + " at " + expiresTime;
              }
            }
          } else if (expires){
            var expiresTime = fmt12WithAMPM(expires);
            var expiresDay = fmtMonthDay(expires);
            var todayStr = fmtMonthDay(now);
            var tomorrowStr = fmtMonthDay(new Date(now.getTime() + 86400000));
            
            if (expiresDay === todayStr){
              timeWindow = "Until " + expiresTime + " today";
            } else if (expiresDay === tomorrowStr){
              timeWindow = "Until " + expiresTime + " tomorrow";
            } else {
              timeWindow = "Until " + expiresDay + " at " + expiresTime;
            }
          }
          
          // Severity badge
          var severityBadge = "";
          if (severity === "extreme"){
            severityBadge = '<span class="weather-alert-severity extreme">Extreme</span>';
          } else if (severity === "severe"){
            severityBadge = '<span class="weather-alert-severity severe">Severe</span>';
          } else if (severity === "moderate"){
            severityBadge = '<span class="weather-alert-severity moderate">Moderate</span>';
          }
          
          html += '<div class="weather-alert ' + alertClass + '" data-alert-index="' + i + '" style="cursor:pointer;" title="Click for full details">' +
            '<span class="weather-alert-icon">' + icon + '</span>' +
            '<span class="weather-alert-text">' +
              '<span class="weather-alert-title">' + event + '</span>' +
              (timeWindow ? '<span class="weather-alert-time"> ' + timeWindow + '</span>' : '') +
              (summary ? '<span class="weather-alert-summary">' + summary + '</span>' : '') +
            '</span>' +
            severityBadge +
          '</div>';
          
          // Store alert geometry for radar overlay
          if (features[i].geometry){
            alertGeometries.push({
              geometry: features[i].geometry,
              event: event,
              severity: severity,
              alertClass: alertClass
            });
          }
        }
        
        alertsEl.innerHTML = html;
        
        // Store features globally for modal access
        window.alertFeatures = features;
        
        // Add click handlers to open alert detail modal
        var alertDivs = alertsEl.querySelectorAll('.weather-alert[data-alert-index]');
        alertDivs.forEach(function(div){
          div.addEventListener('click', function(){
            var idx = parseInt(this.getAttribute('data-alert-index'));
            if (!isNaN(idx) && window.alertFeatures && window.alertFeatures[idx]) {
              openAlertModal(window.alertFeatures[idx]);
            }
          });
        });
        
        // Draw alert zones on radar if map exists
        setTimeout(drawAlertPolygonsOnRadar, 1000);
      })
      .catch(function(err){
        console.log("Weather alerts error:", err);
        alertsEl.innerHTML = '';
      });
  }

  // Draw alert polygons on radar map
  function drawAlertPolygonsOnRadar(){
    if (typeof L === 'undefined' || !window.radarMap) return;
    
    // Remove existing alert layers
    if (window.radarAlertLayers){
      window.radarAlertLayers.forEach(function(layer){
        window.radarMap.removeLayer(layer);
      });
    }
    window.radarAlertLayers = [];
    
    if (alertGeometries.length === 0) return;
    
    alertGeometries.forEach(function(alert){
      var color = '#3b82f6'; // default blue
      var fillOpacity = 0.15;
      
      if (alert.alertClass === 'warning'){
        color = '#ef4444'; // red
        fillOpacity = 0.2;
      } else if (alert.alertClass === 'watch'){
        color = '#f97316'; // orange
        fillOpacity = 0.18;
      } else if (alert.alertClass === 'advisory'){
        color = '#eab308'; // yellow
        fillOpacity = 0.15;
      }
      
      try {
        var geoJsonLayer = L.geoJSON(alert.geometry, {
          style: {
            color: color,
            weight: 2,
            opacity: 0.8,
            fillColor: color,
            fillOpacity: fillOpacity
          }
        }).addTo(window.radarMap);
        
        geoJsonLayer.bindTooltip(alert.event, { sticky: true });
        window.radarAlertLayers.push(geoJsonLayer);
      } catch(e){
        console.log("Error drawing alert polygon:", e);
      }
    });
  }
  
  // Update TODAY Timeline NOW marker every minute
  setInterval(function(){
    var tlNowMarker = document.getElementById("today-tl-now-marker");
    var tlNowTime = document.getElementById("today-tl-now-time");
    
    if (tlNowMarker && tlNowMarker.style.display !== "none"){
      var now = new Date();
      var dayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
      var timelineStart = dayLocal.getTime();
      var timelineEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999).getTime();
      var timelineSpan = timelineEnd - timelineStart;
      
      var nowPct = ((now.getTime() - timelineStart) / timelineSpan) * 100;
      
      if (nowPct >= 0 && nowPct <= 100){
        tlNowMarker.style.left = nowPct + "%";
        if (tlNowTime) tlNowTime.textContent = fmt12NoSuffixFromDate(now);
      }
    }
  }, 60 * 1000);

  /* =========================================================
     UNIFIED WIDGET POPUP MODAL SYSTEM
     ========================================================= */
  var widgetModal = document.getElementById("widget-modal");
  var widgetModalBody = document.getElementById("widget-modal-body");
  var widgetModalClose = document.getElementById("widget-modal-close");
  var modalAnimationTimers = [];

  var MODAL_CONTENT_TYPES = { IMAGE: 'image', CARD: 'card', MAP: 'map' };

  var WIDGET_CONFIG = {
    'radar-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'LOCAL RADAR',
      subtitle: function(){ return LOCATION.radarName || 'NWS'; },
      getFrames: function(){ 
        var STATION = LOCATION.radar || "KENX";
        return ["https://radar.weather.gov/ridge/standard/" + STATION + "_loop.gif?cb=" + Date.now()];
      }
    },
    'goes-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GOES SATELLITE',
      subtitle: 'GEOCOLOR',
      getFrames: function(){ return goesFrames; },
      fps: 3.3
    },
    'aurora-canvas': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'AURORA FORECAST',
      subtitle: 'SWPC OVATION',
      getFrames: function(){ return auroraAnim.frames; },
      fps: 5
    },
    'enlil-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'SOLAR WIND',
      subtitle: 'WSA-ENLIL',
      getFrames: function(){ return animations.enlil.frames; },
      fps: 8
    },
    'lasco-c3-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'LASCO C3 CORONAGRAPH',
      subtitle: 'NASA/ESA SOHO',
      getFrames: function(){ return animations.lascoC3.frames; },
      fps: 6
    },
    'lasco-c2-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'LASCO C2 CORONAGRAPH',
      subtitle: 'NASA/ESA SOHO',
      getFrames: function(){ return animations.lascoC2.frames; },
      fps: 6
    },
    'suvi-map-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'SUVI THEMATIC MAP',
      subtitle: 'NOAA GOES',
      getFrames: function(){ return suviMapAnim.frames; },
      fps: 6.7
    },
    'pfss-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'SOLAR MAGNETIC FIELD',
      subtitle: 'NASA SDO PFSS',
      getFrames: function(){ var el = document.getElementById('pfss-img'); return el ? [el.src] : []; }
    },
    'geo-vel-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GEOSPACE VELOCITY',
      subtitle: 'SWPC',
      getFrames: function(){ var el = document.getElementById('geo-vel-img'); return el ? [el.src] : []; }
    },
    'geo-den-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GEOSPACE DENSITY',
      subtitle: 'SWPC',
      getFrames: function(){ var el = document.getElementById('geo-den-img'); return el ? [el.src] : []; }
    },
    'geo-pre-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      title: 'GEOSPACE PRESSURE',
      subtitle: 'SWPC',
      getFrames: function(){ var el = document.getElementById('geo-pre-img'); return el ? [el.src] : []; }
    },
    'gfs-500mb-img': { 
      type: MODAL_CONTENT_TYPES.IMAGE, 
      get title(){ return gfsState.activeTab === '10mb' ? '10mb STRATOSPHERIC TEMPERATURE' : 'GFS 500mb VORTICITY & HEIGHTS'; },
      get subtitle(){ return gfsState.activeTab === '10mb' ? 'CPC  Northern Hemisphere' : 'NCEP MAG  North America'; },
      getFrames: function(){ 
        var frames = [];
        if(gfsState.activeTab === '10mb'){
          for(var i = 0; i < gfsState.fhrs10.length; i++){
            frames.push(buildGfsUrl('10mb', i));
          }
        } else {
          for(var i = 0; i < gfsState.fhrs500.length; i += 2){
            frames.push(buildGfsUrl('500mb', i));
          }
        }
        return frames;
      },
      get fps(){ return gfsState.activeTab === '10mb' ? 2 : 4; }
    }
  };

  var CARD_CONFIG = {
    'nightsky': { title: 'NIGHT SKY', subtitle: 'Planet Visibility' }
  };

  var MAP_CONFIG = {
    'lightning-map': { title: 'LIGHTNING', subtitle: 'Blitzortung + Macrostrat', sourceMap: function(){ return lightningMap; }, markers: function(){ return lightningMarkers; } },
    'fire-map': { title: 'WILDFIRES', subtitle: 'NIFC + ESRI', sourceMap: function(){ return fireMap; }, markers: function(){ return fireMarkers; } },
    'quake-map': { title: 'EARTHQUAKES', subtitle: 'USGS + Macrostrat', sourceMap: function(){ return quakeMap; }, markers: function(){ return quakeMarkers; } },
    'national-radar-map': { title: 'NATIONAL RADAR', subtitle: 'IEM NEXRAD', sourceMap: function(){ return nationalRadarMap; }, markers: function(){ return []; } }
  };

  function clearModalAnimations(){
    modalAnimationTimers.forEach(function(t){ clearInterval(t); clearTimeout(t); });
    modalAnimationTimers = [];
    if (window.modalMap) { window.modalMap.remove(); window.modalMap = null; }
  }

  function updateModalHeader(title, subtitle){
    var titleEl = document.getElementById("modal-title");
    var subtitleEl = document.getElementById("modal-subtitle");
    if (titleEl) titleEl.textContent = title || '--';
    if (subtitleEl) subtitleEl.textContent = typeof subtitle === 'function' ? subtitle() : (subtitle || '');
  }

  function positionModalAtViewport(el){
    el.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.88);z-index:99999;padding:24px;box-sizing:border-box;overflow:auto;';
    if (el.parentNode !== document.body) document.body.appendChild(el);
    el.classList.add("active");
    el.scrollIntoView({behavior:'smooth', block:'center'});
  }

  function openImageModal(config, imgId){
    if (!widgetModal || !widgetModalBody) return;
    clearModalAnimations();
    
    updateModalHeader(config.title, config.subtitle);
    widgetModalBody.className = 'widget-modal-body content-image is-loading';
    widgetModalBody.innerHTML = '';
    
    positionModalAtViewport(widgetModal);
    
    var frames = config.getFrames ? config.getFrames() : [];
    if (!frames || frames.length === 0) {
      var srcEl = document.getElementById(imgId);
      if (srcEl && srcEl.src) frames = [srcEl.src];
    }
    
    if (frames && frames.length > 0) {
      var img = document.createElement('img');
      img.onload = function(){ widgetModalBody.classList.remove('is-loading'); };
      img.onerror = function(){ 
        widgetModalBody.classList.remove('is-loading'); 
        widgetModalBody.innerHTML = '<div style="color:#888;font-size:14px;">Image unavailable</div>'; 
      };
      img.src = frames[0] + (frames[0].indexOf('?') >= 0 ? '&' : '?') + 'modal=1&cb=' + Date.now();
      img.alt = config.title || 'Enlarged view';
      widgetModalBody.appendChild(img);
      
      if (frames.length > 1 && config.fps) {
        var idx = 0;
        var interval = 1000 / config.fps;
        var timer = setInterval(function(){
          idx = (idx + 1) % frames.length;
          img.src = frames[idx];
        }, interval);
        modalAnimationTimers.push(timer);
      }
    } else {
      widgetModalBody.classList.remove('is-loading');
      widgetModalBody.innerHTML = '<div style="color:#888;font-size:14px;">Content unavailable</div>';
    }
  }

  function openCardModalUnified(cardEl, config){
    if (!widgetModal || !widgetModalBody) return;
    clearModalAnimations();
    
    updateModalHeader(config.title, config.subtitle);
    widgetModalBody.className = 'widget-modal-body content-card';
    widgetModalBody.innerHTML = '';
    
    var clone = cardEl.cloneNode(true);
    clone.classList.remove('clickable-card');
    clone.style.cursor = 'default';
    clone.style.margin = '0';
    clone.style.padding = '0';
    
    var btns = clone.querySelectorAll('button');
    btns.forEach(function(btn){ if (btn.textContent === '' || btn.textContent === '') btn.style.display = 'none'; });
    
    widgetModalBody.appendChild(clone);
    positionModalAtViewport(widgetModal);
  }

  function openMapModal(config, containerId){
    if (!widgetModal || !widgetModalBody) return;
    clearModalAnimations();
    
    updateModalHeader(config.title, config.subtitle);
    widgetModalBody.className = 'widget-modal-body content-map';
    widgetModalBody.innerHTML = '<div class="modal-map-container" id="modal-map-container" style="position:relative;"></div>';
    
    positionModalAtViewport(widgetModal);
    
    setTimeout(function(){
      var mapContainer = document.getElementById('modal-map-container');
      if (!mapContainer || typeof L === 'undefined') return;
      
      var sourceMap = config.sourceMap ? config.sourceMap() : null;
      var markers = config.markers ? config.markers() : [];
      if (!sourceMap) return;
      
      var center = sourceMap.getCenter();
      var zoom = sourceMap.getZoom();
      
      window.modalMap = L.map(mapContainer, { center: center, zoom: zoom, zoomControl: true, attributionControl: false });
      
      // Add base layers based on map type
      if (containerId === 'fire-map') {
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' }).addTo(window.modalMap);
        // Add smoke heatmap if available
        if (typeof L.heatLayer === 'function' && fireMarkers.length > 0) {
          var smokePoints = [];
          fireMarkers.forEach(function(marker) {
            var latlng = marker.getLatLng();
            var radius = marker.options.radius || 3;
            var intensity = (radius <= 2.5) ? 0.05 : Math.min(radius / 10, 0.7);
            smokePoints.push([latlng.lat, latlng.lng, intensity]);
          });
          L.heatLayer(smokePoints, {
            radius: 6, blur: 3, maxZoom: 4, max: 1.0, minOpacity: 0.25,
            gradient: { 0.0: 'rgba(255,255,200,0)', 0.15: 'rgba(255,240,150,0.55)', 0.3: 'rgba(255,200,80,0.7)', 0.5: 'rgba(255,140,40,0.8)', 0.7: 'rgba(240,80,20,0.88)', 0.85: 'rgba(200,30,30,0.92)', 1.0: 'rgba(140,20,60,0.97)' }
          }).addTo(window.modalMap);
        }
      } else if (containerId === 'national-radar-map') {
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { opacity: 0.7 }).addTo(window.modalMap);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.5 }).addTo(window.modalMap);
        L.tileLayer('https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png?_=' + Date.now(), { opacity: 0.75 }).addTo(window.modalMap);
      } else if (containerId === 'lightning-map') {
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { attribution: TILE_ATTRIB }).addTo(window.modalMap);
      } else {
        L.tileLayer(DARK_TILES, { attribution: TILE_ATTRIB }).addTo(window.modalMap);
        L.tileLayer('https://tiles.macrostrat.org/carto/{z}/{x}/{y}.png', { opacity: containerId === 'quake-map' ? 0.70 : 0.35 }).addTo(window.modalMap);
      }
      
      // Add location marker (except for national radar which shows whole country)
      if (containerId !== 'national-radar-map') {
        L.circleMarker([LOCATION.lat, LOCATION.lon], { radius: 8, fillColor: '#2B22F4', fillOpacity: 0.9, color: '#fff', weight: 2 }).addTo(window.modalMap).bindTooltip(" " + LOCATION.name, { permanent: false });
      }
      
      // Clone markers with popups
      markers.forEach(function(marker){
        var latlng = marker.getLatLng();
        var options = marker.options;
        var newMarker = L.circleMarker(latlng, { radius: options.radius || 5, fillColor: options.fillColor || '#f00', fillOpacity: options.fillOpacity || 0.8, color: options.color || '#fff', weight: options.weight || 1 }).addTo(window.modalMap);
        var tooltip = marker.getTooltip();
        var popup = marker.getPopup();
        if (tooltip) newMarker.bindTooltip(tooltip.getContent(), { permanent: false });
        if (popup) newMarker.bindPopup(popup.getContent(), { closeButton: false });
      });
      
      // Clone UI overlays (pills, toggles, legends) from the source widget
      var sourceWidget = document.getElementById(containerId);
      if (sourceWidget) {
        var parent = sourceWidget.closest('.widget-body');
        if (parent) {
          var overlays = parent.querySelectorAll('[id$="-pill"], [id$="-status-pill"], [id$="-toggle"], .fire-legend, .radar-legend');
          overlays.forEach(function(overlay) {
            var clone = overlay.cloneNode(true);
            clone.id = clone.id ? 'modal-' + clone.id : '';
            clone.style.position = 'absolute';
            clone.style.zIndex = '1000';
            // Disable click handlers on cloned toggles (they won't work on the modal map)
            clone.style.pointerEvents = 'none';
            clone.style.opacity = '0.9';
            mapContainer.appendChild(clone);
          });
        }
      }
      
      setTimeout(function(){ if (window.modalMap) window.modalMap.invalidateSize(); }, 100);
      setTimeout(function(){ if (window.modalMap) window.modalMap.invalidateSize(); }, 300);
    }, 50);
  }

  function closeWidgetModal(){
    if (!widgetModal) return;
    clearModalAnimations();
    widgetModal.classList.remove("active");
    document.documentElement.style.overflow = '';
    document.body.style.overflow = '';
    setTimeout(function(){ if (widgetModalBody) { widgetModalBody.innerHTML = ""; widgetModalBody.className = "widget-modal-body"; } }, 300);
  }

  if (widgetModalClose) widgetModalClose.addEventListener("click", closeWidgetModal);
  if (widgetModal) widgetModal.addEventListener("click", function(e){ if (e.target === widgetModal) closeWidgetModal(); });
  document.addEventListener("keydown", function(e){ if (e.key === "Escape" && widgetModal && widgetModal.classList.contains("active")) closeWidgetModal(); });

  function initWidgetPopups(){
    var widgets = document.querySelectorAll(".widget");
    
    widgets.forEach(function(widget){
      var img = widget.querySelector(".widget-body img");
      var canvas = widget.querySelector(".widget-body canvas");
      var isMapWidget = widget.classList.contains("map-widget");
      var imgId = img ? img.id : (canvas ? canvas.id : null);
      var config = imgId ? WIDGET_CONFIG[imgId] : null;
      
      if (isMapWidget) {
        widget.classList.add("clickable-widget");
        var header = widget.querySelector(".widget-head");
        if (header) {
          header.style.cursor = "pointer";
          var mapContainer = widget.querySelector("[id$='-map']");
          var mapId = mapContainer ? mapContainer.id : null;
          var mapConfig = mapId ? MAP_CONFIG[mapId] : null;
          if (mapConfig) {
            header.addEventListener("click", function(e){
              if (e.target.closest("a")) return;
              openMapModal(mapConfig, mapId);
            });
          }
        }
        return;
      }
      
      if (config) {
        widget.classList.add("clickable-widget");
        widget.addEventListener("click", function(e){
          if (e.target.closest("button") || e.target.closest("a") || e.target.closest("input")) return;
          openImageModal(config, imgId);
        });
      } else if (img || canvas) {
        widget.classList.add("clickable-widget");
        widget.addEventListener("click", function(e){
          if (e.target.closest("button") || e.target.closest("a") || e.target.closest("input")) return;
          var genericConfig = {
            type: MODAL_CONTENT_TYPES.IMAGE,
            title: widget.querySelector(".widget-title") ? widget.querySelector(".widget-title").textContent.replace(' LIVE', '').trim() : 'Image',
            subtitle: '',
            getFrames: function(){
              var el = img || canvas;
              if (el && el.src) return [el.src];
              if (canvas && auroraAnim.frames && auroraAnim.frames.length > 0) return auroraAnim.frames;
              return [];
            }
          };
          openImageModal(genericConfig, imgId);
        });
      }
    });
    
    Object.keys(CARD_CONFIG).forEach(function(cardId){
      var card = document.getElementById(cardId) || document.querySelector("." + cardId);
      if (card) {
        card.classList.add("clickable-card");
        card.addEventListener("click", function(e){
          if (e.target.closest("button") || e.target.closest("a")) return;
          openCardModalUnified(card, CARD_CONFIG[cardId]);
        });
      }
    });
  }

  initWidgetPopups();


  // Voyager 1 live distance updater (every 5 seconds)
  setInterval(function(){
    var voyagerBullet = document.querySelector('.bullet:last-child .bsub');
    if (voyagerBullet && voyagerBullet.textContent.indexOf('mi  Light delay') > -1){
      var now = new Date();
      var refDate = new Date(Date.UTC(2025, 0, 1, 0, 0, 0));
      var refDistanceMiles = 15215899826.1;
      var speedMph = 38210.55;
      var msSinceRef = now.getTime() - refDate.getTime();
      var hoursSinceRef = msSinceRef / (1000 * 60 * 60);
      var currentMiles = refDistanceMiles + (hoursSinceRef * speedMph);
      var milesFormatted = Math.floor(currentMiles).toLocaleString();
      var currentAU = currentMiles / 92955807.3;
      var lightSeconds = currentAU * 499.004784;
      var lightHours = Math.floor(lightSeconds / 3600);
      var lightMins = Math.floor((lightSeconds % 3600) / 60);
      var lightTimeStr = lightHours + "h " + lightMins + "m";
      var launchDate = new Date(Date.UTC(1977, 8, 5, 12, 56, 0));
      var missionMs = now.getTime() - launchDate.getTime();
      var missionYears = Math.floor(missionMs / (1000 * 60 * 60 * 24 * 365.25));
      var missionMonths = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 365.25)) / (1000 * 60 * 60 * 24 * 30.44));
      var missionDays = Math.floor((missionMs % (1000 * 60 * 60 * 24 * 30.44)) / (1000 * 60 * 60 * 24));
      var missionStr = missionYears + "y " + missionMonths + "m " + missionDays + "d";
      voyagerBullet.textContent = "Interstellar space  Local Interstellar Cloud  " + milesFormatted + " mi  Light delay " + lightTimeStr + "  " + speedMph.toLocaleString() + " mph";
      
      // Update mission time in btime
      var voyagerTime = document.querySelector('.bullet:last-child .btime');
      if (voyagerTime) voyagerTime.textContent = missionStr + " in flight";
    }
  }, 5000);

  // refresh cadences
  setInterval(function(){ loadWeatherForLocation(LOCATION); }, 10 * 60 * 1000);
  setInterval(updateSolarMini, 5 * 60 * 1000);
  setInterval(loadAirQuality, 15 * 60 * 1000);
  setInterval(loadWeatherAlerts, 5 * 60 * 1000);
  loadWeatherForLocation(LOCATION);
  loadWeatherAlerts();
  loadAirQuality();
  
  // Alert modal close handlers (after DOM ready)
  var alertModalClose = document.getElementById('alert-modal-close');
  var alertModal = document.getElementById('alert-modal');
  if (alertModalClose) alertModalClose.addEventListener('click', closeAlertModal);
  if (alertModal) alertModal.addEventListener('click', function(e){ if (e.target === alertModal) closeAlertModal(); });
  document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && document.getElementById('alert-modal') && document.getElementById('alert-modal').classList.contains('active')) closeAlertModal(); });
  startRadarNwsLoop();
  startAuroraBlackBackground();
  startGoesAutoplay();
  updateSolarMini();
  initSpaceWeatherAnimations();
  initSuviMap();
  initPfss();
  initNowMicroTabs();
  initLocationSwitcher();
  initGfsWidget();

  // Ensure modals are direct children of body, after all other content
  var alertM = document.getElementById('alert-modal');
  var widgetM = document.getElementById('widget-modal');
  if (alertM) document.body.appendChild(alertM);
  if (widgetM) document.body.appendChild(widgetM);

})();

// Global alert modal functions (outside IIFE for click handler access)
function openAlertModal(feature){
  var existingModal = document.getElementById('dynamic-alert-modal');
  if (existingModal) existingModal.remove();
  
  var alert = feature.properties;
  var event = alert.event || "Weather Alert";
  var severity = (alert.severity || "").toLowerCase();
  var headline = alert.headline || "";
  var description = alert.description || "";
  var instruction = alert.instruction || "";
  var areaDesc = alert.areaDesc || "";
  var senderName = alert.senderName || "";
  var effective = alert.effective ? new Date(alert.effective) : null;
  var onset = alert.onset ? new Date(alert.onset) : null;
  var expires = alert.expires ? new Date(alert.expires) : null;
  
  var icon = "";
  var alertColor = "#3b82f6";
  if (event.toLowerCase().indexOf("warning") >= 0 || severity === "extreme" || severity === "severe"){
    icon = ""; alertColor = "#ef4444";
  } else if (event.toLowerCase().indexOf("watch") >= 0 || severity === "moderate"){
    icon = ""; alertColor = "#f97316";
  } else if (event.toLowerCase().indexOf("advisory") >= 0){
    icon = ""; alertColor = "#eab308";
  }
  
  function fmtDateTime(d){
    if (!d || !isFinite(d.getTime())) return "--";
    var days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    var months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    var h = d.getHours(); var m = d.getMinutes();
    var ampm = h >= 12 ? "PM" : "AM";
    var hh = h % 12; if (hh === 0) hh = 12;
    return days[d.getDay()] + " " + months[d.getMonth()] + " " + d.getDate() + ", " + hh + ":" + (m < 10 ? "0"+m : m) + " " + ampm;
  }
  
  var severityBadge = "";
  if (severity === "extreme") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(220,38,38,0.3);color:#fca5a5;">Extreme</span>';
  else if (severity === "severe") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(239,68,68,0.25);color:#fca5a5;">Severe</span>';
  else if (severity === "moderate") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(249,115,22,0.25);color:#fdba74;">Moderate</span>';
  else if (severity === "minor") severityBadge = '<span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px;background:rgba(234,179,8,0.25);color:#fde047;">Minor</span>';
  
  var bodyContent = '';
  if (headline) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:15px;color:' + alertColor + ';">' + headline + severityBadge + '</div></div>';
  bodyContent += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:20px;"><div style="text-align:center;"><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:4px;">Effective</div><div style="font-size:14px;color:#fff;font-weight:500;">' + fmtDateTime(effective || onset) + '</div></div><div style="text-align:center;"><div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#666;margin-bottom:4px;">Expires</div><div style="font-size:14px;color:#fff;font-weight:500;">' + fmtDateTime(expires) + '</div></div></div>';
  if (description) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Description</div><div style="white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;border-left:3px solid rgba(255,255,255,0.1);">' + description.replace(/\n/g, '<br>') + '</div></div>';
  if (instruction) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Instructions</div><div style="white-space:pre-wrap;background:rgba(0,0,0,0.2);padding:16px;border-radius:8px;border-left:3px solid rgba(255,255,255,0.1);">' + instruction.replace(/\n/g, '<br>') + '</div></div>';
  if (areaDesc) bodyContent += '<div style="margin-bottom:20px;"><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Affected Areas</div><div style="font-size:13px;color:#aaa;line-height:1.5;">' + areaDesc + '</div></div>';
  if (senderName) bodyContent += '<div><div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#888;margin-bottom:6px;">Issued By</div><div style="color:#aaa;">' + senderName + '</div></div>';
  
  var modal = document.createElement('div');
  modal.id = 'dynamic-alert-modal';
  modal.innerHTML = '<div style="margin:auto;background:linear-gradient(145deg,rgba(30,30,35,0.98),rgba(20,20,25,0.98));border:1px solid rgba(255,255,255,0.1);border-radius:16px;max-width:600px;width:90vw;max-height:85vh;overflow:auto;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.7);">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.2);">' +
      '<div style="display:flex;align-items:center;gap:12px;">' +
        '<span style="font-size:24px;">' + icon + '</span>' +
        '<span style="font-size:18px;font-weight:600;color:#fff;">' + event + '</span>' +
      '</div>' +
      '<button onclick="closeAlertModal()" style="background:none;border:none;color:#888;font-size:28px;cursor:pointer;padding:0 8px;line-height:1;">&times;</button>' +
    '</div>' +
    '<div style="padding:24px;overflow-y:auto;flex:1;color:#e0e0e0;font-size:14px;line-height:1.6;">' + bodyContent + '</div>' +
  '</div>';
  
  modal.setAttribute('style', 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:999999;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;overflow:auto;');
  modal.onclick = function(e){ if(e.target === modal) closeAlertModal(); };
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  modal.scrollIntoView({behavior:'smooth', block:'center'});
}

function closeAlertModal(){
  var modal = document.getElementById('dynamic-alert-modal');
  if (modal){ modal.remove(); document.documentElement.style.overflow = ''; document.body.style.overflow = ''; }
}

document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeAlertModal(); });
</script>
</body>
</html>
